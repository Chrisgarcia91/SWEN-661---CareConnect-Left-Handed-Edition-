<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="CareConnect Development Team" />
  <title>CareConnect Deployment and Operations Guide</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="pdf/pdf-styles.css" />
</head>
<body>
<header id="title-block-header">
<h1 class="title">CareConnect Deployment and Operations Guide</h1>
<p class="author">CareConnect Development Team</p>
<p class="date">October 2025</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#careconnect-2025-deployment-and-operations-guide"
id="toc-careconnect-2025-deployment-and-operations-guide">CareConnect
2025 Deployment and Operations Guide</a>
<ul>
<li><a href="#introduction" id="toc-introduction">Introduction</a>
<ul>
<li><a href="#purpose-and-scope" id="toc-purpose-and-scope">Purpose and
Scope</a></li>
<li><a href="#healthcare-specific-operational-considerations"
id="toc-healthcare-specific-operational-considerations">Healthcare-Specific
Operational Considerations</a></li>
</ul></li>
<li><a href="#infrastructure-overview"
id="toc-infrastructure-overview">Infrastructure Overview</a>
<ul>
<li><a href="#cloud-architecture-philosophy"
id="toc-cloud-architecture-philosophy">Cloud Architecture
Philosophy</a></li>
<li><a href="#architecture-diagram-and-traffic-flow"
id="toc-architecture-diagram-and-traffic-flow">Architecture Diagram and
Traffic Flow</a></li>
<li><a href="#technology-stack-and-selection-rationale"
id="toc-technology-stack-and-selection-rationale">Technology Stack and
Selection Rationale</a></li>
<li><a href="#technology-stack-summary"
id="toc-technology-stack-summary">Technology Stack Summary</a></li>
</ul></li>
<li><a href="#environment-setup-and-strategy"
id="toc-environment-setup-and-strategy">Environment Setup and
Strategy</a>
<ul>
<li><a href="#environment-structure-and-promotion-path"
id="toc-environment-structure-and-promotion-path">Environment Structure
and Promotion Path</a></li>
<li><a href="#environment-promotion-workflow"
id="toc-environment-promotion-workflow">Environment Promotion
Workflow</a></li>
<li><a href="#environment-configuration-details"
id="toc-environment-configuration-details">Environment Configuration
Details</a></li>
</ul></li>
<li><a href="#aws-infrastructure-deployment"
id="toc-aws-infrastructure-deployment">AWS Infrastructure Deployment</a>
<ul>
<li><a href="#terraform-configuration"
id="toc-terraform-configuration">Terraform Configuration</a></li>
<li><a href="#deployment-commands"
id="toc-deployment-commands">Deployment Commands</a></li>
</ul></li>
<li><a href="#application-deployment"
id="toc-application-deployment">Application Deployment</a>
<ul>
<li><a href="#backend-deployment" id="toc-backend-deployment">Backend
Deployment</a></li>
<li><a href="#frontend-deployment" id="toc-frontend-deployment">Frontend
Deployment</a></li>
<li><a href="#blue-green-deployment-strategy"
id="toc-blue-green-deployment-strategy">Blue-Green Deployment
Strategy</a></li>
</ul></li>
<li><a href="#database-management" id="toc-database-management">Database
Management</a>
<ul>
<li><a href="#database-initialization"
id="toc-database-initialization">Database Initialization</a></li>
<li><a href="#database-migration-strategy"
id="toc-database-migration-strategy">Database Migration
Strategy</a></li>
<li><a href="#database-backup-strategy"
id="toc-database-backup-strategy">Database Backup Strategy</a></li>
</ul></li>
<li><a href="#cicd-pipeline" id="toc-cicd-pipeline">CI/CD Pipeline</a>
<ul>
<li><a href="#github-actions-workflow"
id="toc-github-actions-workflow">GitHub Actions Workflow</a></li>
<li><a href="#rollback-strategy" id="toc-rollback-strategy">Rollback
Strategy</a></li>
</ul></li>
<li><a href="#monitoring-and-logging"
id="toc-monitoring-and-logging">Monitoring and Logging</a>
<ul>
<li><a href="#cloudwatch-dashboard"
id="toc-cloudwatch-dashboard">CloudWatch Dashboard</a></li>
<li><a href="#application-metrics"
id="toc-application-metrics">Application Metrics</a></li>
<li><a href="#alerting-configuration"
id="toc-alerting-configuration">Alerting Configuration</a></li>
<li><a href="#log-aggregation" id="toc-log-aggregation">Log
Aggregation</a></li>
</ul></li>
<li><a href="#security-and-compliance"
id="toc-security-and-compliance">Security and Compliance</a>
<ul>
<li><a href="#security-hardening" id="toc-security-hardening">Security
Hardening</a></li>
<li><a href="#secrets-management" id="toc-secrets-management">Secrets
Management</a></li>
<li><a href="#hipaa-compliance" id="toc-hipaa-compliance">HIPAA
Compliance</a></li>
</ul></li>
<li><a href="#backup-and-disaster-recovery"
id="toc-backup-and-disaster-recovery">Backup and Disaster Recovery</a>
<ul>
<li><a href="#backup-strategy" id="toc-backup-strategy">Backup
Strategy</a></li>
<li><a href="#disaster-recovery-plan"
id="toc-disaster-recovery-plan">Disaster Recovery Plan</a></li>
<li><a href="#recovery-testing" id="toc-recovery-testing">Recovery
Testing</a></li>
</ul></li>
<li><a href="#performance-optimization"
id="toc-performance-optimization">Performance Optimization</a>
<ul>
<li><a href="#database-optimization"
id="toc-database-optimization">Database Optimization</a></li>
<li><a href="#caching-strategy" id="toc-caching-strategy">Caching
Strategy</a></li>
<li><a href="#cdn-optimization" id="toc-cdn-optimization">CDN
Optimization</a></li>
</ul></li>
<li><a href="#scaling-strategies" id="toc-scaling-strategies">Scaling
Strategies</a>
<ul>
<li><a href="#horizontal-scaling" id="toc-horizontal-scaling">Horizontal
Scaling</a></li>
<li><a href="#database-scaling" id="toc-database-scaling">Database
Scaling</a></li>
</ul></li>
<li><a href="#maintenance-procedures"
id="toc-maintenance-procedures">Maintenance Procedures</a>
<ul>
<li><a href="#scheduled-maintenance"
id="toc-scheduled-maintenance">Scheduled Maintenance</a></li>
<li><a href="#system-updates" id="toc-system-updates">System
Updates</a></li>
</ul></li>
<li><a href="#troubleshooting-production-issues"
id="toc-troubleshooting-production-issues">Troubleshooting Production
Issues</a>
<ul>
<li><a href="#common-issues-and-systematic-solutions"
id="toc-common-issues-and-systematic-solutions">Common Issues and
Systematic Solutions</a></li>
<li><a href="#diagnostic-tools" id="toc-diagnostic-tools">Diagnostic
Tools</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
<h1 id="careconnect-2025-deployment-and-operations-guide">CareConnect
2025 Deployment and Operations Guide</h1>
<h2 id="introduction">Introduction</h2>
<h3 id="purpose-and-scope">Purpose and Scope</h3>
<p>This Deployment and Operations Guide serves as the authoritative
resource for deploying, configuring, monitoring, and maintaining the
CareConnect healthcare platform in production environments. Unlike
development-focused documentation, this guide addresses the unique
challenges of running a HIPAA-compliant healthcare application at scale,
where reliability, security, and data integrity are not optional—they
are regulatory requirements.</p>
<p><strong>Target Audience</strong>: This guide is designed for: -
<strong>DevOps Engineers</strong> responsible for infrastructure
provisioning and CI/CD pipelines - <strong>Site Reliability Engineers
(SREs)</strong> managing production systems and incident response -
<strong>System Administrators</strong> performing day-to-day operational
tasks - <strong>Security Engineers</strong> ensuring compliance with
healthcare regulations - <strong>Technical Leads</strong> making
architectural and scaling decisions</p>
<p><strong>What This Guide Covers</strong>: - <strong>Infrastructure
Architecture</strong>: Understanding the AWS-based multi-tier
architecture and why each component was selected - <strong>Deployment
Procedures</strong>: Step-by-step deployment workflows from code commit
to production release - <strong>Monitoring and Observability</strong>:
Comprehensive monitoring strategies, alerting, and incident response -
<strong>Security and Compliance</strong>: HIPAA compliance requirements,
security best practices, and audit procedures - <strong>Disaster
Recovery</strong>: Backup strategies, recovery procedures, and business
continuity planning - <strong>Troubleshooting</strong>: Systematic
approaches to diagnosing and resolving production issues</p>
<h3
id="healthcare-specific-operational-considerations">Healthcare-Specific
Operational Considerations</h3>
<p>Operating a healthcare platform differs significantly from standard
web applications:</p>
<p><strong>Regulatory Compliance</strong>: HIPAA and HITECH regulations
mandate specific security controls, audit logging, and data handling
procedures. Every deployment decision—from encryption methods to backup
retention—must consider these requirements.</p>
<p><strong>Zero Downtime Requirement</strong>: Healthcare providers rely
on CareConnect for patient care coordination. Scheduled maintenance
windows must be carefully planned, and deployments must use blue-green
or canary strategies to avoid service interruptions during critical care
hours.</p>
<p><strong>Data Integrity Above All</strong>: In healthcare, data
corruption or loss isn’t just inconvenient—it can endanger patient
safety. Our backup strategies, database configurations, and deployment
procedures prioritize data integrity over speed or convenience.</p>
<p><strong>Audit Trail Requirements</strong>: Every change to the
production system must be logged and traceable. This guide includes
procedures for maintaining audit trails that satisfy regulatory
scrutiny.</p>
<h2 id="infrastructure-overview">Infrastructure Overview</h2>
<h3 id="cloud-architecture-philosophy">Cloud Architecture
Philosophy</h3>
<p>CareConnect’s infrastructure follows a defense-in-depth approach,
where multiple layers of security, redundancy, and monitoring protect
patient data and ensure system availability. We’ve chosen AWS as our
cloud provider for its:</p>
<ul>
<li><strong>HIPAA Compliance</strong>: AWS offers Business Associate
Agreements (BAA) and maintains HITRUST certification</li>
<li><strong>Mature Services</strong>: Proven services like RDS, ECS, and
CloudFront reduce operational burden</li>
<li><strong>Global Presence</strong>: Multi-region capabilities support
disaster recovery and data residency requirements</li>
<li><strong>Comprehensive Monitoring</strong>: CloudWatch and related
services provide deep observability</li>
</ul>
<p>The architecture separates concerns across multiple tiers, allowing
independent scaling, security hardening, and failure isolation. If the
caching layer fails, the application continues serving requests (albeit
slower). If a container crashes, ECS automatically replaces it without
manual intervention.</p>
<h3 id="architecture-diagram-and-traffic-flow">Architecture Diagram and
Traffic Flow</h3>
<pre><code>┌─────────────────────────────────────────────────────────────────────┐
│                           Internet                                   │
└─────────────────────────┬───────────────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────────────┐
│                    Route 53 (DNS)                                   │
└─────────────────────────┬───────────────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────────────┐
│                   CloudFront CDN                                     │
└─────────────────────────┬───────────────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────────────┐
│                 Application Load Balancer                           │
└─────────────────────────┬───────────────────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
┌───────▼────┐    ┌──────▼──────┐    ┌─────▼──────┐
│   Web App  │    │   Backend   │    │   Admin    │
│   (S3 +    │    │   (ECS +    │    │   Portal   │
│ CloudFront)│    │  Fargate)   │    │   (EC2)    │
└────────────┘    └─────────────┘    └────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
┌───────▼────┐    ┌──────▼──────┐    ┌─────▼──────┐
│    RDS     │    │  ElastiCache│    │   Lambda   │
│ PostgreSQL │    │    Redis    │    │ Functions  │
└────────────┘    └─────────────┘    └────────────┘
        │
┌───────▼────┐
│     S3     │
│  File      │
│ Storage    │
└────────────┘</code></pre>
<p><strong>Understanding the Traffic Flow</strong>:</p>
<ol type="1">
<li><strong>User Request</strong>: A caregiver opens the CareConnect app
on their tablet</li>
<li><strong>DNS Resolution</strong>: Route 53 resolves
<code>careconnect.health</code> to CloudFront distribution</li>
<li><strong>CDN Layer</strong>: CloudFront serves cached static assets
(images, CSS, JavaScript) from edge locations closest to the user,
reducing latency</li>
<li><strong>Load Balancing</strong>: Dynamic API requests pass through
CloudFront to Application Load Balancer, which distributes traffic
across healthy backend containers</li>
<li><strong>Application Processing</strong>: ECS containers running
Spring Boot process business logic, enforcing authentication and
authorization</li>
<li><strong>Data Access</strong>: Application queries RDS PostgreSQL for
persistent data, checks ElastiCache Redis for cached data to avoid
expensive database queries</li>
<li><strong>File Operations</strong>: Large files (medical documents,
lab results) are stored in and retrieved from S3</li>
<li><strong>Serverless Functions</strong>: Lambda functions handle
asynchronous tasks like PDF generation, email sending, and scheduled
data exports</li>
</ol>
<p>This multi-tier architecture ensures that a failure in any single
component (except the database) doesn’t bring down the entire
system.</p>
<h3 id="technology-stack-and-selection-rationale">Technology Stack and
Selection Rationale</h3>
<p>Our technology choices balance operational maturity, healthcare
compliance requirements, and team expertise:</p>
<h4 id="infrastructure-layer">Infrastructure Layer</h4>
<p><strong>Cloud Provider: Amazon Web Services (AWS)</strong> -
<strong>Why AWS over Azure/GCP</strong>: AWS’s early entry into
healthcare compliance (HIPAA-eligible services since 2013) means more
mature tooling and extensive documentation for healthcare workloads. The
AWS BAA (Business Associate Agreement) covers a wide range of services,
giving us flexibility in architecture choices. - <strong>Compliance
Certifications</strong>: AWS maintains HITRUST, SOC 1/2/3, and ISO 27001
certifications required by many healthcare organizations.</p>
<p><strong>Infrastructure as Code: Terraform</strong> - <strong>Why
Terraform over CloudFormation</strong>: Terraform’s provider-agnostic
approach means we could migrate to multi-cloud if needed. Its
declarative syntax and state management make infrastructure changes
auditable and reversible—critical for regulated environments. -
<strong>State Management</strong>: We use remote state in S3 with
DynamoDB locking to prevent concurrent modifications that could corrupt
infrastructure state.</p>
<p><strong>Container Orchestration: ECS with Fargate</strong> -
<strong>Why ECS over Kubernetes</strong>: ECS offers deep AWS
integration with less operational overhead. For our team size and
application complexity, ECS’s managed control plane and native AWS
service integration (IAM, CloudWatch, ALB) provides the right balance of
power and simplicity. - <strong>Why Fargate over EC2</strong>: Fargate’s
serverless model eliminates patching and scaling of underlying VMs. In
healthcare, reducing the attack surface and operational burden of OS
management is valuable—we focus on application security, not server
hardening.</p>
<p><strong>Load Balancer: Application Load Balancer (ALB)</strong> -
<strong>Layer 7 Routing</strong>: ALB operates at HTTP/HTTPS level,
enabling path-based routing (<code>/api/*</code> → backend,
<code>/admin/*</code> → admin portal) and health checks that verify
application health, not just network connectivity. - <strong>WAF
Integration</strong>: Tight integration with AWS WAF allows us to
protect against OWASP Top 10 vulnerabilities at the perimeter.</p>
<p><strong>CDN: CloudFront</strong> - <strong>Global
Distribution</strong>: Medical facilities access CareConnect from
various geographic locations. CloudFront’s 200+ edge locations reduce
latency for users worldwide. - <strong>DDoS Protection</strong>:
CloudFront integrates with AWS Shield for DDoS mitigation—important for
maintaining availability during attacks.</p>
<p><strong>DNS: Route 53</strong> - <strong>Health Checks</strong>:
Route 53 monitors endpoint health and automatically fails over to DR
region if primary region becomes unhealthy. - <strong>DNSSEC</strong>:
Supports DNSSEC for preventing DNS spoofing attacks.</p>
<h4 id="compute-layer">Compute Layer</h4>
<p><strong>Backend: ECS Fargate Containers</strong> -
<strong>Isolation</strong>: Each container runs in its own micro-VM,
providing process-level isolation between requests—important when
handling sensitive patient data. - <strong>Auto-scaling</strong>: ECS
automatically scales containers based on CPU/memory metrics or custom
metrics like request count. - <strong>Blue-Green Deployments</strong>:
ECS native support for blue-green deployments enables zero-downtime
updates.</p>
<p><strong>Frontend: S3 + CloudFront Static Hosting</strong> -
<strong>Infinite Scalability</strong>: S3 automatically scales to handle
any request volume. No server capacity planning needed for web assets. -
<strong>Cost Efficiency</strong>: Static hosting is ~10x cheaper than
running web servers. For a Flutter web app that’s mostly static after
build, this is ideal.</p>
<p><strong>Functions: Lambda for Serverless Tasks</strong> -
<strong>Event-Driven</strong>: Lambda functions respond to S3 events
(new file uploaded), SQS messages (async job queue), or scheduled
CloudWatch Events (nightly reports). - <strong>No Idle Costs</strong>:
Unlike containers that run 24/7, Lambda charges only for execution time.
Perfect for sporadic tasks like PDF generation.</p>
<p><strong>Admin: EC2 Instances for Administrative Tasks</strong> -
<strong>Why EC2 for Admin</strong>: Admin tasks (database migrations,
bulk data imports) sometimes require long-running processes that exceed
Lambda’s 15-minute timeout. - <strong>Bastion Host</strong>: EC2
instances also serve as secure bastion hosts for accessing private
resources.</p>
<h4 id="storage-layer">Storage Layer</h4>
<p><strong>Database: RDS PostgreSQL (Multi-AZ)</strong> - <strong>Why
PostgreSQL</strong>: Advanced features like JSONB columns, row-level
security, and excellent ACID compliance make it ideal for healthcare
data. - <strong>Multi-AZ</strong>: Automatic synchronous replication to
standby in different Availability Zone provides ~99.95% availability and
protects against AZ failures. - <strong>Automated Backups</strong>: RDS
automatically takes daily snapshots and retains transaction logs,
enabling point-in-time recovery.</p>
<p><strong>Cache: ElastiCache Redis</strong> - <strong>Why Redis over
Memcached</strong>: Redis supports complex data structures (sorted sets
for leaderboards, pub/sub for real-time features) and persistence,
making it suitable for both caching and session storage. -
<strong>Performance</strong>: Caching frequent database queries (user
profiles, permissions) reduces database load and improves response times
from ~200ms to ~5ms.</p>
<p><strong>Files: S3 Buckets</strong> - <strong>Durability</strong>:
S3’s 99.999999999% durability means medical records are safe from data
loss. - <strong>Lifecycle Policies</strong>: Automatically transition
old medical records to Glacier for cost-effective long-term archival
while maintaining compliance with retention requirements. -
<strong>Versioning</strong>: S3 versioning protects against accidental
deletion and allows recovery of previous file versions.</p>
<p><strong>Backup: S3 with Lifecycle Policies</strong> -
<strong>Compliance</strong>: Healthcare regulations often require 7-10
year retention of medical records. S3 Glacier Deep Archive provides
cost-effective long-term storage. - <strong>Cross-Region
Replication</strong>: Critical backups are replicated to a different AWS
region for geographic redundancy.</p>
<h4 id="security-layer">Security Layer</h4>
<p><strong>WAF: AWS WAF for Application Protection</strong> -
<strong>OWASP Protection</strong>: Managed rule sets protect against SQL
injection, XSS, and other common attacks without manual rule tuning. -
<strong>Rate Limiting</strong>: Protects API endpoints from brute force
and DDoS attacks by limiting request rates per IP.</p>
<p><strong>Certificates: ACM (AWS Certificate Manager)</strong> -
<strong>Automatic Renewal</strong>: ACM automatically renews SSL/TLS
certificates before expiration, preventing the service outages caused by
expired certificates. - <strong>Wildcard Support</strong>: Single
wildcard certificate (<code>*.careconnect.health</code>) covers all
subdomains.</p>
<p><strong>Secrets: AWS Secrets Manager</strong> - <strong>Why Secrets
Manager over Parameter Store</strong>: Automatic rotation of database
passwords and API keys reduces the risk of compromised credentials. In
healthcare, regular credential rotation is often a compliance
requirement. - <strong>Encryption</strong>: All secrets are encrypted at
rest using AWS KMS with customer-managed keys.</p>
<p><strong>IAM: Role-Based Access Control</strong> - <strong>Principle
of Least Privilege</strong>: Each ECS task, Lambda function, and admin
user has only the permissions needed for their specific function. -
<strong>No Long-Lived Credentials</strong>: ECS tasks use IAM roles
(temporary credentials) instead of hardcoded access keys, reducing
credential leakage risk.</p>
<h3 id="technology-stack-summary">Technology Stack Summary</h3>
<p><strong>Infrastructure:</strong> - <strong>Cloud Provider</strong>:
Amazon Web Services (AWS) - <strong>Infrastructure as Code</strong>:
Terraform - <strong>Container Orchestration</strong>: ECS with Fargate -
<strong>Load Balancer</strong>: Application Load Balancer (ALB) -
<strong>CDN</strong>: CloudFront - <strong>DNS</strong>: Route 53</p>
<p><strong>Compute:</strong> - <strong>Backend</strong>: ECS Fargate
containers - <strong>Frontend</strong>: S3 + CloudFront static hosting -
<strong>Functions</strong>: Lambda for serverless tasks -
<strong>Admin</strong>: EC2 instances for administrative tasks</p>
<p><strong>Storage:</strong> - <strong>Database</strong>: RDS PostgreSQL
(Multi-AZ) - <strong>Cache</strong>: ElastiCache Redis -
<strong>Files</strong>: S3 buckets - <strong>Backup</strong>: S3 with
lifecycle policies</p>
<p><strong>Security:</strong> - <strong>WAF</strong>: AWS WAF for
application protection - <strong>Certificates</strong>: ACM (AWS
Certificate Manager) - <strong>Secrets</strong>: AWS Secrets Manager -
<strong>IAM</strong>: Role-based access control</p>
<h2 id="environment-setup-and-strategy">Environment Setup and
Strategy</h2>
<h3 id="environment-structure-and-promotion-path">Environment Structure
and Promotion Path</h3>
<p>CareConnect employs a four-environment strategy that balances
development agility with production safety. Each environment serves a
distinct purpose in the software delivery pipeline:</p>
<h4 id="development-environment-dev">1. Development Environment
(<code>dev</code>)</h4>
<p><strong>Purpose</strong>: Rapid iteration and feature development
without impacting other environments.</p>
<p><strong>Characteristics</strong>: - <strong>Local-First</strong>:
Developers run most components locally (database, Redis, backend) for
fast iteration - <strong>AWS Integration</strong>: Connects to
development S3 buckets and other AWS services for testing cloud
integration - <strong>Relaxed Security</strong>: Uses development
credentials and simplified authentication to reduce friction -
<strong>Data</strong>: Synthetic test data only—no real patient
information ever exists in dev</p>
<p><strong>When to Use</strong>: - Individual developer feature work -
Unit and integration testing during development - Debugging and
troubleshooting new features</p>
<p><strong>Infrastructure</strong>: Minimal AWS resources—primarily S3
buckets for file uploads and testing cloud integrations.</p>
<h4 id="staging-environment-staging">2. Staging Environment
(<code>staging</code>)</h4>
<p><strong>Purpose</strong>: Pre-production validation and integration
testing in an environment that mirrors production as closely as
possible.</p>
<p><strong>Characteristics</strong>: - <strong>Production
Mirror</strong>: Infrastructure, networking, and configurations match
production (except scale) - <strong>Integration Testing</strong>: Full
end-to-end testing of all components together - <strong>QA
Validation</strong>: Quality assurance team validates features before
production release - <strong>Performance Testing</strong>: Load testing
to identify bottlenecks before they impact production users -
<strong>Smaller Scale</strong>: Runs fewer containers and smaller
database instances to reduce costs while maintaining architectural
parity</p>
<p><strong>When to Use</strong>: - Testing feature branches before
merging to main - QA validation of release candidates - Integration
testing of multiple features together - Training and demo purposes</p>
<p><strong>Infrastructure</strong>: Full AWS stack but scaled down (1-2
ECS tasks vs 10+ in production, smaller RDS instance).</p>
<h4 id="production-environment-prod">3. Production Environment
(<code>prod</code>)</h4>
<p><strong>Purpose</strong>: Serve live traffic for real healthcare
providers and patients.</p>
<p><strong>Characteristics</strong>: - <strong>High
Availability</strong>: Multi-AZ deployment, auto-scaling, automated
failover - <strong>Full Monitoring</strong>: Comprehensive CloudWatch
dashboards, alarms, and log aggregation - <strong>Security
Hardening</strong>: All security controls enabled, minimal IAM
permissions, encryption everywhere - <strong>Real Data</strong>:
Contains actual patient health information—HIPAA compliance is mandatory
- <strong>Change Control</strong>: Strict deployment procedures with
approvals and rollback capabilities</p>
<p><strong>When to Use</strong>: Only after thorough testing in staging
and approval from technical leads.</p>
<p><strong>Infrastructure</strong>: Full-scale AWS infrastructure with
redundancy and auto-scaling.</p>
<h4 id="disaster-recovery-environment-dr">4. Disaster Recovery
Environment (<code>dr</code>)</h4>
<p><strong>Purpose</strong>: Geographic redundancy and business
continuity in case of regional AWS outage.</p>
<p><strong>Characteristics</strong>: - <strong>Passive Standby</strong>:
Normally inactive, activated only during DR scenarios -
<strong>Different Region</strong>: Deployed in a separate AWS region
(us-west-2 vs us-east-1 for production) - <strong>Data
Replication</strong>: Receives asynchronous replication from production
database and S3 - <strong>Lower Cost</strong>: Minimal compute resources
until failover is triggered</p>
<p><strong>When to Use</strong>: - Primary region experiences
significant outage (entire AZ down, networking issues) - Disaster
recovery drills (quarterly validation that DR actually works)</p>
<p><strong>Infrastructure</strong>: Full infrastructure defined in
Terraform but scaled to minimum (1 ECS task, smallest RDS instance)
until activated.</p>
<h3 id="environment-promotion-workflow">Environment Promotion
Workflow</h3>
<p>Code flows through environments in a controlled progression:</p>
<pre><code>Developer Workstation → dev → staging → production → dr (replicated)
                         ↓       ↓          ↓
                      Feature   QA      Release
                       Test     Test     to Users</code></pre>
<p><strong>Promotion Gates</strong>: Each promotion requires: -
Automated tests passing in current environment - Manual QA signoff (for
staging → production) - Technical lead approval (for production
deployments) - Deployment during approved change window (production
only)</p>
<h3 id="environment-configuration-details">Environment Configuration
Details</h3>
<h4 id="development-environment-configuration">Development Environment
Configuration</h4>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Local development configuration</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">ENVIRONMENT</span><span class="op">=</span>dev</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">DATABASE_URL</span><span class="op">=</span>jdbc:postgresql://localhost:5432/careconnect_dev</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">REDIS_URL</span><span class="op">=</span>redis://localhost:6379</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">JWT_SECRET</span><span class="op">=</span>dev_jwt_secret_key_32_characters</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">AWS_REGION</span><span class="op">=</span>us-east-1</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">S3_BUCKET</span><span class="op">=</span>careconnect-dev-files</span></code></pre></div>
<h4 id="staging-environment">Staging Environment</h4>
<div class="sourceCode" id="cb4"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Staging environment configuration</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">ENVIRONMENT</span><span class="op">=</span>staging</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">DATABASE_URL</span><span class="op">=</span>jdbc:postgresql://staging-db.region.rds.amazonaws.com:5432/careconnect</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">REDIS_URL</span><span class="op">=</span>staging-cache.region.cache.amazonaws.com:6379</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">JWT_SECRET</span><span class="op">=</span><span class="va">${JWT_SECRET_STAGING}</span>  <span class="co"># From AWS Secrets Manager</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">AWS_REGION</span><span class="op">=</span>us-east-1</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">S3_BUCKET</span><span class="op">=</span>careconnect-staging-files</span></code></pre></div>
<h4 id="production-environment">Production Environment</h4>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Production environment configuration</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">ENVIRONMENT</span><span class="op">=</span>prod</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">DATABASE_URL</span><span class="op">=</span>jdbc:postgresql://prod-db.region.rds.amazonaws.com:5432/careconnect</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">REDIS_URL</span><span class="op">=</span>prod-cache.region.cache.amazonaws.com:6379</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">JWT_SECRET</span><span class="op">=</span><span class="va">${JWT_SECRET_PROD}</span>  <span class="co"># From AWS Secrets Manager</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">AWS_REGION</span><span class="op">=</span>us-east-1</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">S3_BUCKET</span><span class="op">=</span>careconnect-prod-files</span></code></pre></div>
<h2 id="aws-infrastructure-deployment">AWS Infrastructure
Deployment</h2>
<h3 id="terraform-configuration">Terraform Configuration</h3>
<h4 id="main-infrastructure-configuration">Main Infrastructure
Configuration</h4>
<p>This main Terraform configuration file orchestrates all
infrastructure components for CareConnect. Rather than defining
resources directly, it uses a modular approach where each major
component (VPC, database, compute) is encapsulated in its own module.
This separation provides several benefits:</p>
<p><strong>Why Modular Architecture</strong>: -
<strong>Reusability</strong>: The same VPC module can be used for dev,
staging, and prod environments with different parameters -
<strong>Maintainability</strong>: Changes to database configuration
don’t require touching networking code - <strong>Testing</strong>: Each
module can be tested independently before integration - <strong>Team
Collaboration</strong>: Different team members can work on different
modules without conflicts</p>
<p><strong>State Management</strong>: The <code>backend "s3"</code>
configuration stores Terraform state remotely in S3, which is critical
for team collaboration. Without this, each developer would have their
own local state file, leading to infrastructure drift and conflicts.
DynamoDB locking prevents two people from running Terraform
simultaneously, which could corrupt the state.</p>
<p><strong>Why These Specific Module Parameters Matter</strong>: -
<code>multi_az = var.environment == "prod" ? true : false</code>:
Production databases span multiple availability zones for high
availability, but dev environments use single-AZ to reduce costs -
<code>backup_retention_period = var.environment == "prod" ? 30 : 7</code>:
Production keeps 30 days of backups for compliance, dev only needs 7 -
<code>deletion_protection = var.environment == "prod" ? true : false</code>:
Prevents accidental deletion of production database</p>
<pre class="hcl"><code># terraform_aws/main.tf
terraform {
  required_version = &quot;&gt;= 1.0&quot;
  required_providers {
    aws = {
      source  = &quot;hashicorp/aws&quot;
      version = &quot;~&gt; 5.0&quot;
    }
  }

  backend &quot;s3&quot; {
    bucket         = &quot;careconnect-terraform-state&quot;
    key            = &quot;infrastructure/terraform.tfstate&quot;
    region         = &quot;us-east-1&quot;
    dynamodb_table = &quot;terraform-locks&quot;
    encrypt        = true
  }
}

provider &quot;aws&quot; {
  region = var.aws_region

  default_tags {
    tags = {
      Project     = &quot;CareConnect&quot;
      Environment = var.environment
      ManagedBy   = &quot;Terraform&quot;
    }
  }
}

# Data sources
data &quot;aws_availability_zones&quot; &quot;available&quot; {
  state = &quot;available&quot;
}

# Modules
module &quot;vpc&quot; {
  source = &quot;./modules/vpc&quot;

  environment             = var.environment
  vpc_cidr               = var.vpc_cidr
  availability_zones     = data.aws_availability_zones.available.names
  enable_nat_gateway     = true
  enable_vpn_gateway     = false
  enable_dns_hostnames   = true
  enable_dns_support     = true
}

module &quot;security_groups&quot; {
  source = &quot;./modules/security_groups&quot;

  environment = var.environment
  vpc_id      = module.vpc.vpc_id
}

module &quot;rds&quot; {
  source = &quot;./modules/rds&quot;

  environment                = var.environment
  vpc_id                    = module.vpc.vpc_id
  subnet_ids                = module.vpc.database_subnet_ids
  security_group_ids        = [module.security_groups.rds_security_group_id]

  db_name                   = var.db_name
  db_username              = var.db_username
  db_password              = var.db_password
  db_instance_class        = var.db_instance_class
  allocated_storage        = var.db_allocated_storage
  max_allocated_storage    = var.db_max_allocated_storage

  backup_retention_period  = var.environment == &quot;prod&quot; ? 30 : 7
  backup_window           = &quot;03:00-04:00&quot;
  maintenance_window      = &quot;sun:04:00-sun:05:00&quot;

  multi_az               = var.environment == &quot;prod&quot; ? true : false
  deletion_protection    = var.environment == &quot;prod&quot; ? true : false
}

module &quot;elasticache&quot; {
  source = &quot;./modules/elasticache&quot;

  environment        = var.environment
  vpc_id            = module.vpc.vpc_id
  subnet_ids        = module.vpc.private_subnet_ids
  security_group_ids = [module.security_groups.cache_security_group_id]

  node_type         = var.cache_node_type
  num_cache_nodes   = var.cache_num_nodes
  parameter_group   = &quot;default.redis7&quot;
  port             = 6379
}

module &quot;ecs&quot; {
  source = &quot;./modules/ecs&quot;

  environment               = var.environment
  vpc_id                   = module.vpc.vpc_id
  subnet_ids               = module.vpc.private_subnet_ids
  security_group_ids       = [module.security_groups.ecs_security_group_id]

  cluster_name             = &quot;careconnect-${var.environment}&quot;
  task_definition_family   = &quot;careconnect-backend&quot;
  container_image          = var.backend_container_image
  container_port          = 8080

  cpu                     = var.ecs_cpu
  memory                  = var.ecs_memory
  desired_count           = var.ecs_desired_count

  database_url            = module.rds.database_url
  redis_url              = module.elasticache.redis_url

  log_group_name         = &quot;/ecs/careconnect-${var.environment}&quot;
  log_retention_days     = var.environment == &quot;prod&quot; ? 365 : 30
}

module &quot;alb&quot; {
  source = &quot;./modules/alb&quot;

  environment            = var.environment
  vpc_id                = module.vpc.vpc_id
  subnet_ids            = module.vpc.public_subnet_ids
  security_group_ids    = [module.security_groups.alb_security_group_id]

  certificate_arn       = module.acm.certificate_arn
  target_group_arn      = module.ecs.target_group_arn
}

module &quot;s3&quot; {
  source = &quot;./modules/s3&quot;

  environment           = var.environment
  frontend_bucket_name  = &quot;careconnect-${var.environment}-frontend&quot;
  files_bucket_name     = &quot;careconnect-${var.environment}-files&quot;
  logs_bucket_name      = &quot;careconnect-${var.environment}-logs&quot;

  enable_versioning     = var.environment == &quot;prod&quot; ? true : false
  enable_logging        = true
}

module &quot;cloudfront&quot; {
  source = &quot;./modules/cloudfront&quot;

  environment         = var.environment
  s3_bucket_domain   = module.s3.frontend_bucket_domain
  alb_domain         = module.alb.dns_name
  certificate_arn    = module.acm.certificate_arn

  web_acl_id         = module.waf.web_acl_id
}

module &quot;route53&quot; {
  source = &quot;./modules/route53&quot;

  domain_name          = var.domain_name
  cloudfront_domain   = module.cloudfront.domain_name
  cloudfront_zone_id  = module.cloudfront.hosted_zone_id

  create_health_check = var.environment == &quot;prod&quot; ? true : false
}

module &quot;acm&quot; {
  source = &quot;./modules/acm&quot;

  domain_name               = var.domain_name
  subject_alternative_names = [&quot;*.${var.domain_name}&quot;]
  route53_zone_id          = module.route53.zone_id
}

module &quot;waf&quot; {
  source = &quot;./modules/waf&quot;

  environment = var.environment

  rate_limit           = var.environment == &quot;prod&quot; ? 10000 : 2000
  enable_geo_blocking  = var.environment == &quot;prod&quot; ? true : false
  blocked_countries    = [&quot;CN&quot;, &quot;RU&quot;]  # Example blocked countries
}

module &quot;monitoring&quot; {
  source = &quot;./modules/monitoring&quot;

  environment = var.environment

  cluster_name = module.ecs.cluster_name
  service_name = module.ecs.service_name

  rds_instance_id = module.rds.instance_id
  cache_cluster_id = module.elasticache.cluster_id

  alb_arn = module.alb.arn
  cloudfront_distribution_id = module.cloudfront.distribution_id

  notification_email = var.notification_email
}</code></pre>
<p><strong>Understanding the Module Structure</strong>:</p>
<p>Each <code>module</code> block creates a set of related resources.
For example, <code>module "vpc"</code> creates the entire networking
infrastructure (VPC, subnets, NAT gateways, route tables). The module
receives inputs via parameters and returns outputs that other modules
can use.</p>
<p><strong>Critical Module Dependencies</strong>: 1.
<strong>VPC</strong> must be created first (provides <code>vpc_id</code>
needed by others) 2. <strong>Security Groups</strong> need the VPC ID to
define network rules 3. <strong>RDS</strong> needs both VPC and security
groups before it can launch 4. <strong>ECS</strong> needs VPC, security
groups, and connects to RDS/ElastiCache 5. <strong>ALB</strong> sits in
front of ECS, routing traffic to containers 6.
<strong>Monitoring</strong> observes all the above components</p>
<p>This dependency chain is why we use Terraform’s module system—it
automatically handles creation order based on resource dependencies.</p>
<h4 id="vpc-module">VPC Module</h4>
<p>The VPC (Virtual Private Cloud) module creates isolated networking
infrastructure for CareConnect. Think of it as creating a private data
center in AWS—complete with multiple network zones, internet gateways,
and routing rules.</p>
<p><strong>Network Architecture Philosophy</strong>:</p>
<p>CareConnect uses a <strong>three-tier network design</strong> to
balance security and accessibility: 1. <strong>Public Subnets</strong>:
Host load balancers that accept traffic from the internet 2.
<strong>Private Subnets</strong>: Host application containers (ECS
tasks) that should NOT be directly accessible from internet 3.
<strong>Database Subnets</strong>: Host RDS instances in the most
isolated layer, accessible only from application tier</p>
<p><strong>Why Three Tiers</strong>: This follows the principle of
defense-in-depth. Even if an attacker compromises the load balancer,
they can’t directly access the application layer. Even if they
compromise an application container, they can’t directly access the
database.</p>
<p><strong>Multi-AZ Design</strong>: Each subnet type is created in
multiple Availability Zones (us-east-1a, us-east-1b, etc.). If one AZ
fails (rare but happens), the other AZs continue serving traffic. This
is why <code>count = length(var.availability_zones)</code> appears
throughout—we’re creating resources in each AZ.</p>
<p><strong>NAT Gateway Strategy</strong>: Private subnets need internet
access for downloading packages and reaching external APIs, but
shouldn’t accept inbound connections. NAT gateways provide one-way
internet access: outbound traffic is allowed, inbound is blocked.</p>
<p><strong>CIDR Block Math</strong>: The
<code>cidrsubnet(var.vpc_cidr, 8, count.index + 1)</code> function
divides the VPC’s IP address space into smaller subnets. For a VPC with
CIDR <code>10.0.0.0/16</code>, this creates: - Public subnets:
<code>10.0.1.0/24</code>, <code>10.0.2.0/24</code>,
<code>10.0.3.0/24</code> - Private subnets: <code>10.0.11.0/24</code>,
<code>10.0.12.0/24</code>, <code>10.0.13.0/24</code> (note the +10
offset) - Database subnets: <code>10.0.21.0/24</code>,
<code>10.0.22.0/24</code>, <code>10.0.23.0/24</code> (note the +20
offset)</p>
<p>The offsets ensure no IP overlap between subnet types.</p>
<pre class="hcl"><code># terraform_aws/modules/vpc/main.tf
resource &quot;aws_vpc&quot; &quot;main&quot; {
  cidr_block           = var.vpc_cidr
  enable_dns_hostnames = var.enable_dns_hostnames
  enable_dns_support   = var.enable_dns_support

  tags = {
    Name = &quot;careconnect-${var.environment}-vpc&quot;
  }
}

resource &quot;aws_internet_gateway&quot; &quot;main&quot; {
  vpc_id = aws_vpc.main.id

  tags = {
    Name = &quot;careconnect-${var.environment}-igw&quot;
  }
}

resource &quot;aws_subnet&quot; &quot;public&quot; {
  count = length(var.availability_zones)

  vpc_id            = aws_vpc.main.id
  cidr_block        = cidrsubnet(var.vpc_cidr, 8, count.index + 1)
  availability_zone = var.availability_zones[count.index]

  map_public_ip_on_launch = true

  tags = {
    Name = &quot;careconnect-${var.environment}-public-${count.index + 1}&quot;
    Type = &quot;Public&quot;
  }
}

resource &quot;aws_subnet&quot; &quot;private&quot; {
  count = length(var.availability_zones)

  vpc_id            = aws_vpc.main.id
  cidr_block        = cidrsubnet(var.vpc_cidr, 8, count.index + 10)
  availability_zone = var.availability_zones[count.index]

  tags = {
    Name = &quot;careconnect-${var.environment}-private-${count.index + 1}&quot;
    Type = &quot;Private&quot;
  }
}

resource &quot;aws_subnet&quot; &quot;database&quot; {
  count = length(var.availability_zones)

  vpc_id            = aws_vpc.main.id
  cidr_block        = cidrsubnet(var.vpc_cidr, 8, count.index + 20)
  availability_zone = var.availability_zones[count.index]

  tags = {
    Name = &quot;careconnect-${var.environment}-database-${count.index + 1}&quot;
    Type = &quot;Database&quot;
  }
}

# NAT Gateways
resource &quot;aws_eip&quot; &quot;nat&quot; {
  count = var.enable_nat_gateway ? length(var.availability_zones) : 0
  domain = &quot;vpc&quot;

  tags = {
    Name = &quot;careconnect-${var.environment}-nat-eip-${count.index + 1}&quot;
  }

  depends_on = [aws_internet_gateway.main]
}

resource &quot;aws_nat_gateway&quot; &quot;main&quot; {
  count = var.enable_nat_gateway ? length(var.availability_zones) : 0

  allocation_id = aws_eip.nat[count.index].id
  subnet_id     = aws_subnet.public[count.index].id

  tags = {
    Name = &quot;careconnect-${var.environment}-nat-${count.index + 1}&quot;
  }

  depends_on = [aws_internet_gateway.main]
}

# Route Tables
resource &quot;aws_route_table&quot; &quot;public&quot; {
  vpc_id = aws_vpc.main.id

  route {
    cidr_block = &quot;0.0.0.0/0&quot;
    gateway_id = aws_internet_gateway.main.id
  }

  tags = {
    Name = &quot;careconnect-${var.environment}-public-rt&quot;
  }
}

resource &quot;aws_route_table&quot; &quot;private&quot; {
  count = length(var.availability_zones)
  vpc_id = aws_vpc.main.id

  dynamic &quot;route&quot; {
    for_each = var.enable_nat_gateway ? [1] : []
    content {
      cidr_block     = &quot;0.0.0.0/0&quot;
      nat_gateway_id = aws_nat_gateway.main[count.index].id
    }
  }

  tags = {
    Name = &quot;careconnect-${var.environment}-private-rt-${count.index + 1}&quot;
  }
}

# Route Table Associations
resource &quot;aws_route_table_association&quot; &quot;public&quot; {
  count = length(aws_subnet.public)

  subnet_id      = aws_subnet.public[count.index].id
  route_table_id = aws_route_table.public.id
}

resource &quot;aws_route_table_association&quot; &quot;private&quot; {
  count = length(aws_subnet.private)

  subnet_id      = aws_subnet.private[count.index].id
  route_table_id = aws_route_table.private[count.index].id
}

resource &quot;aws_route_table_association&quot; &quot;database&quot; {
  count = length(aws_subnet.database)

  subnet_id      = aws_subnet.database[count.index].id
  route_table_id = aws_route_table.private[count.index].id
}</code></pre>
<p><strong>Key VPC Module Concepts Explained</strong>:</p>
<p><strong>Internet Gateway</strong>: The bridge between our VPC and the
public internet. Without this, nothing in the VPC could reach the
internet, and the internet couldn’t reach our load balancers.</p>
<p><strong>Route Tables</strong>: Define how traffic flows within the
VPC. The public route table says “send <code>0.0.0.0/0</code> (all
traffic) to the internet gateway.” The private route table says “send
<code>0.0.0.0/0</code> to the NAT gateway” (for outbound-only
access).</p>
<p><strong>Route Table Associations</strong>: Connect subnets to route
tables. Public subnets use the public route table (bidirectional
internet), private and database subnets use private route tables
(outbound-only via NAT).</p>
<p><strong>Why <code>depends_on</code> Matters</strong>: NAT gateways
can’t be created until the internet gateway exists, because they need a
way to route traffic. Terraform’s <code>depends_on</code> ensures
resources are created in the correct order.</p>
<p><strong>Cost Optimization Note</strong>: NAT gateways are expensive
(~$0.045/hour each + $0.045/GB data). We create one per AZ for high
availability, but in development environments, you might create just one
to save costs (at the expense of AZ resilience).</p>
<h4 id="ecs-module">ECS Module</h4>
<p>The ECS (Elastic Container Service) module defines how CareConnect’s
Spring Boot backend runs in production. ECS is AWS’s container
orchestration service—think of it as the system that ensures your Docker
containers are always running, automatically replaces failed containers,
and scales up/down based on load.</p>
<p><strong>Why Fargate Over EC2</strong>: ECS can run containers on EC2
instances (you manage the VMs) or Fargate (AWS manages the
infrastructure). We chose Fargate because: - <strong>No Server
Management</strong>: AWS handles patching, scaling, and maintaining the
underlying VMs - <strong>Pay-Per-Container</strong>: You’re billed only
for container resources used, not idle VM capacity -
<strong>Security</strong>: Each Fargate task runs in its own isolated
micro-VM, stronger isolation than shared EC2 instances -
<strong>Healthcare Compliance</strong>: Less infrastructure to audit and
secure = easier HIPAA compliance</p>
<p><strong>Container Insights</strong>: The
<code>containerInsights = "enabled"</code> setting turns on detailed
CloudWatch metrics for every container. This visibility is critical for
diagnosing production issues—you can see exactly which container is
consuming CPU, making database calls, or experiencing errors.</p>
<p><strong>Capacity Providers</strong>: The <code>FARGATE</code> and
<code>FARGATE_SPOT</code> configuration allows ECS to use spot instances
(cheaper but can be interrupted) for non-critical workloads while using
standard Fargate for production traffic. The
<code>base = 1, weight = 100</code> means “always run at least 1 task on
standard Fargate, but prefer standard for all tasks.”</p>
<p><strong>Task Definition Breakdown</strong>:</p>
<p>A “task definition” is like a Docker Compose file—it defines which
containers to run, how much CPU/memory they need, environment variables,
and health checks. The task definition is versioned, so you can roll
back to previous versions if a deployment fails.</p>
<p><strong>Network Mode <code>awsvpc</code></strong>: Each container
gets its own elastic network interface (ENI) with a private IP address.
This provides stronger network isolation and allows security groups to
control traffic to individual containers (not just the host EC2
instance).</p>
<p><strong>IAM Roles Explained</strong>: - <strong>Execution
Role</strong> (<code>ecs_execution_role</code>): Permissions ECS needs
to launch the container (pull from ECR, write to CloudWatch logs, read
secrets from Secrets Manager) - <strong>Task Role</strong>
(<code>ecs_task_role</code>): Permissions the application code needs at
runtime (access S3 buckets, send SNS notifications, etc.)</p>
<p>Separating these roles follows the principle of least privilege—ECS
can start containers without giving the application excessive
permissions.</p>
<p><strong>Environment vs. Secrets</strong>: Environment variables are
for non-sensitive config (<code>ENVIRONMENT=prod</code>). Secrets are
pulled from AWS Secrets Manager at runtime and never logged. This
prevents accidentally exposing database passwords in CloudWatch
Logs.</p>
<p><strong>Health Check Strategy</strong>: The health check
<code>curl -f http://localhost:${var.container_port}/actuator/health</code>
calls Spring Boot’s health endpoint. If this fails 3 times
(<code>retries = 3</code>), ECS kills the container and starts a new
one. The <code>startPeriod = 60</code> gives the application 60 seconds
to start before health checks begin—important because Spring Boot takes
time to initialize.</p>
<p><strong>Deployment Circuit Breaker</strong>: The
<code>deployment_circuit_breaker</code> with
<code>rollback = true</code> is a safety mechanism. If a new deployment
causes containers to repeatedly fail health checks, ECS automatically
rolls back to the previous version. This prevents a bad deployment from
taking down the entire application.</p>
<p><strong>Auto Scaling Logic</strong>: The
<code>aws_appautoscaling_policy</code> monitors CPU utilization and
automatically scales containers. When average CPU exceeds 70%, ECS
launches more containers. When it drops below 70%, ECS terminates excess
containers. This balances cost (don’t run more containers than needed)
with performance (scale up before users notice slowness).</p>
<pre class="hcl"><code># terraform_aws/modules/ecs/main.tf
resource &quot;aws_ecs_cluster&quot; &quot;main&quot; {
  name = var.cluster_name

  setting {
    name  = &quot;containerInsights&quot;
    value = &quot;enabled&quot;
  }

  tags = {
    Name = var.cluster_name
  }
}

resource &quot;aws_ecs_cluster_capacity_providers&quot; &quot;main&quot; {
  cluster_name = aws_ecs_cluster.main.name

  capacity_providers = [&quot;FARGATE&quot;, &quot;FARGATE_SPOT&quot;]

  default_capacity_provider_strategy {
    base              = 1
    weight            = 100
    capacity_provider = &quot;FARGATE&quot;
  }
}

# Task Definition
resource &quot;aws_ecs_task_definition&quot; &quot;main&quot; {
  family                   = var.task_definition_family
  network_mode             = &quot;awsvpc&quot;
  requires_compatibilities = [&quot;FARGATE&quot;]
  cpu                      = var.cpu
  memory                   = var.memory
  execution_role_arn       = aws_iam_role.ecs_execution.arn
  task_role_arn           = aws_iam_role.ecs_task.arn

  container_definitions = jsonencode([
    {
      name  = &quot;careconnect-backend&quot;
      image = var.container_image

      essential = true

      portMappings = [
        {
          containerPort = var.container_port
          protocol      = &quot;tcp&quot;
        }
      ]

      environment = [
        {
          name  = &quot;ENVIRONMENT&quot;
          value = var.environment
        },
        {
          name  = &quot;SERVER_PORT&quot;
          value = tostring(var.container_port)
        },
        {
          name  = &quot;SPRING_DATASOURCE_URL&quot;
          value = var.database_url
        },
        {
          name  = &quot;SPRING_REDIS_HOST&quot;
          value = var.redis_url
        }
      ]

      secrets = [
        {
          name      = &quot;SPRING_DATASOURCE_PASSWORD&quot;
          valueFrom = var.db_password_secret_arn
        },
        {
          name      = &quot;JWT_SECRET&quot;
          valueFrom = var.jwt_secret_arn
        }
      ]

      logConfiguration = {
        logDriver = &quot;awslogs&quot;
        options = {
          awslogs-group         = var.log_group_name
          awslogs-region        = var.aws_region
          awslogs-stream-prefix = &quot;ecs&quot;
        }
      }

      healthCheck = {
        command     = [&quot;CMD-SHELL&quot;, &quot;curl -f http://localhost:${var.container_port}/actuator/health || exit 1&quot;]
        interval    = 30
        timeout     = 5
        retries     = 3
        startPeriod = 60
      }
    }
  ])

  tags = {
    Name = var.task_definition_family
  }
}

# ECS Service
resource &quot;aws_ecs_service&quot; &quot;main&quot; {
  name            = &quot;${var.cluster_name}-service&quot;
  cluster         = aws_ecs_cluster.main.id
  task_definition = aws_ecs_task_definition.main.arn
  desired_count   = var.desired_count

  launch_type = &quot;FARGATE&quot;

  network_configuration {
    subnets          = var.subnet_ids
    security_groups  = var.security_group_ids
    assign_public_ip = false
  }

  load_balancer {
    target_group_arn = aws_lb_target_group.main.arn
    container_name   = &quot;careconnect-backend&quot;
    container_port   = var.container_port
  }

  deployment_configuration {
    maximum_percent         = 200
    minimum_healthy_percent = 100

    deployment_circuit_breaker {
      enable   = true
      rollback = true
    }
  }

  service_registries {
    registry_arn = aws_service_discovery_service.main.arn
  }

  depends_on = [
    aws_lb_listener.main,
    aws_iam_role_policy_attachment.ecs_execution_role_policy
  ]

  tags = {
    Name = &quot;${var.cluster_name}-service&quot;
  }
}

# Auto Scaling
resource &quot;aws_appautoscaling_target&quot; &quot;ecs&quot; {
  max_capacity       = var.max_capacity
  min_capacity       = var.min_capacity
  resource_id        = &quot;service/${aws_ecs_cluster.main.name}/${aws_ecs_service.main.name}&quot;
  scalable_dimension = &quot;ecs:service:DesiredCount&quot;
  service_namespace  = &quot;ecs&quot;
}

resource &quot;aws_appautoscaling_policy&quot; &quot;ecs_cpu&quot; {
  name               = &quot;${var.cluster_name}-cpu-scaling&quot;
  policy_type        = &quot;TargetTrackingScaling&quot;
  resource_id        = aws_appautoscaling_target.ecs.resource_id
  scalable_dimension = aws_appautoscaling_target.ecs.scalable_dimension
  service_namespace  = aws_appautoscaling_target.ecs.service_namespace

  target_tracking_scaling_policy_configuration {
    predefined_metric_specification {
      predefined_metric_type = &quot;ECSServiceAverageCPUUtilization&quot;
    }
    target_value = 70.0
  }
}

# IAM Roles
resource &quot;aws_iam_role&quot; &quot;ecs_execution&quot; {
  name = &quot;${var.cluster_name}-ecs-execution-role&quot;

  assume_role_policy = jsonencode({
    Version = &quot;2012-10-17&quot;
    Statement = [
      {
        Action = &quot;sts:AssumeRole&quot;
        Effect = &quot;Allow&quot;
        Principal = {
          Service = &quot;ecs-tasks.amazonaws.com&quot;
        }
      }
    ]
  })

  tags = {
    Name = &quot;${var.cluster_name}-ecs-execution-role&quot;
  }
}

resource &quot;aws_iam_role_policy_attachment&quot; &quot;ecs_execution_role_policy&quot; {
  role       = aws_iam_role.ecs_execution.name
  policy_arn = &quot;arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy&quot;
}</code></pre>
<p><strong>ECS Module Key Concepts</strong>:</p>
<p><strong>Service Discovery</strong>: The
<code>service_registries</code> block registers each container in AWS
Cloud Map (service discovery). This allows containers to find each other
using DNS names rather than hard-coding IP addresses. When container IP
addresses change (due to scaling or failures), service discovery
automatically updates the DNS.</p>
<p><strong>Load Balancer Integration</strong>: The
<code>load_balancer</code> block connects ECS to the Application Load
Balancer. The ALB distributes incoming HTTP requests across all healthy
containers. If a container fails its health check, the ALB stops sending
traffic to it until it recovers or is replaced.</p>
<p><strong>Deployment Strategy</strong>: The
<code>maximum_percent = 200, minimum_healthy_percent = 100</code>
configuration enables <strong>blue-green deployments</strong>. When
deploying a new version: 1. ECS starts new containers (up to 200% of
desired count, e.g., 6 containers if you normally run 3) 2. Once new
containers pass health checks, ECS drains traffic from old containers 3.
After old containers finish existing requests, ECS terminates them 4.
You’re left with 100% new containers (the desired count of 3)</p>
<p>This ensures zero downtime during deployments—old containers keep
serving requests until new ones are ready.</p>
<p><strong>Why This Complexity Is Worth It</strong>: While this ECS
configuration is extensive, it provides enterprise-grade reliability
with automatic recovery, rolling deployments, and autoscaling. In a
healthcare application where downtime could impact patient care, these
safeguards justify the complexity.</p>
<h3 id="deployment-commands">Deployment Commands</h3>
<h4 id="initial-infrastructure-deployment">Initial Infrastructure
Deployment</h4>
<p>These commands provision the entire AWS infrastructure from scratch.
You’ll run this once when setting up a new environment (dev, staging,
prod) and rarely thereafter (infrastructure changes are typically done
through Terraform updates, not teardown/rebuild).</p>
<p><strong>Terraform Initialization</strong>:
<code>terraform init</code> downloads provider plugins (AWS) and sets up
the backend (S3 state storage). This must be run whenever you clone the
repo or change provider versions.</p>
<p><strong>Workspaces for Multi-Environment</strong>: Terraform
workspaces allow managing multiple environments (dev, staging, prod)
with the same configuration but separate state files.
<code>terraform workspace new prod</code> creates an isolated state for
production, preventing accidental changes to dev when you meant to
modify prod.</p>
<p><strong>The Plan-Apply Workflow</strong>: This two-step process is
critical for safety: 1. <strong>terraform plan</strong>: Shows what
Terraform WOULD do without actually doing it. Review this carefully—if
it says “destroy database,” something is wrong! 2. <strong>terraform
apply</strong>: Actually makes the changes. Only run this after
reviewing the plan.</p>
<p>The <code>-var-file</code> flag loads environment-specific variables
(prod.tfvars) so the same code can deploy different-sized resources for
each environment.</p>
<p><strong>Why Save Outputs</strong>:
<code>terraform output &gt; infrastructure-outputs.txt</code> captures
important values (database endpoint, load balancer DNS) needed by the
application. Without this, you’d have to manually look up these values
in the AWS console.</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Navigate to terraform directory</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> terraform_aws</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize Terraform</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="ex">terraform</span> init</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create workspace for environment</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="ex">terraform</span> workspace new prod</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="ex">terraform</span> workspace select prod</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Plan deployment</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="ex">terraform</span> plan <span class="at">-var-file</span><span class="op">=</span><span class="st">&quot;environments/prod.tfvars&quot;</span> <span class="at">-out</span><span class="op">=</span>tfplan</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Review and apply</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="ex">terraform</span> apply tfplan</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Save outputs</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="ex">terraform</span> output <span class="op">&gt;</span> ../infrastructure-outputs.txt</span></code></pre></div>
<h4 id="environment-specific-variables">Environment-Specific
Variables</h4>
<p>These variable files (<code>.tfvars</code>) allow the same Terraform
code to create different infrastructure for each environment. Production
uses larger, more resilient resources; development uses smaller, cheaper
resources.</p>
<p><strong>Critical Variable Choices Explained</strong>:</p>
<p><strong>Database Instance Class</strong>: <code>db.r6g.large</code>
for production is a memory-optimized instance (16 GB RAM) because
PostgreSQL performance is heavily memory-dependent. Dev environments
might use <code>db.t4g.micro</code> (1 GB RAM) to save costs—acceptable
for testing but would be too slow for production traffic.</p>
<p><strong>Storage Auto-Scaling</strong>:
<code>db_max_allocated_storage = 1000</code> allows PostgreSQL to
automatically grow from 100GB to 1TB as data accumulates. This prevents
“disk full” failures without pre-allocating expensive storage you don’t
need yet.</p>
<p><strong>ECS Auto-Scaling Limits</strong>:
<code>ecs_min_capacity = 2, ecs_max_capacity = 10</code> means: - Always
run at least 2 containers (for high availability—if one fails, the other
handles traffic) - Never run more than 10 containers (cost
control—prevents runaway scaling from attacks or bugs)</p>
<p>Production should always have <code>min_capacity &gt;= 2</code>
because running a single container means downtime during deployments or
failures.</p>
<p><strong>CPU/Memory Allocation</strong>:
<code>ecs_cpu = 1024, ecs_memory = 2048</code> allocates 1 vCPU and 2GB
RAM per container. Fargate charges based on these values, so
right-sizing is important. Too little = out-of-memory errors; too much =
wasted money.</p>
<p><strong>Why Separate Container Images</strong>:
<code>backend_container_image</code> uses the full ECR URL, not just a
tag. This ensures you’re pulling from your own private registry, not
Docker Hub (where malicious images could exist with similar names).</p>
<pre class="hcl"><code># terraform_aws/environments/prod.tfvars
environment = &quot;prod&quot;
aws_region  = &quot;us-east-1&quot;

# Networking
vpc_cidr = &quot;10.0.0.0/16&quot;

# Database
db_name               = &quot;careconnect&quot;
db_username          = &quot;careconnect_user&quot;
db_instance_class    = &quot;db.r6g.large&quot;
db_allocated_storage = 100
db_max_allocated_storage = 1000

# Cache
cache_node_type = &quot;cache.r6g.large&quot;
cache_num_nodes = 2

# ECS
ecs_cpu           = 1024
ecs_memory        = 2048
ecs_desired_count = 3
ecs_min_capacity  = 2
ecs_max_capacity  = 10

# Domain
domain_name = &quot;careconnect.example.com&quot;

# Notifications
notification_email = &quot;ops@example.com&quot;

# Container Images
backend_container_image = &quot;123456789012.dkr.ecr.us-east-1.amazonaws.com/careconnect-backend:latest&quot;</code></pre>
<h2 id="application-deployment">Application Deployment</h2>
<h3 id="backend-deployment">Backend Deployment</h3>
<p>Deploying the Spring Boot backend involves building a Docker
container image, pushing it to AWS’s Elastic Container Registry (ECR),
and updating the ECS service to use the new image.</p>
<p><strong>Why Containers for Backend</strong>: Containers ensure the
application runs identically in all environments. If it works on your
laptop, it works in production—eliminating “works on my machine”
problems. The container includes the exact JDK version, dependencies,
and configuration.</p>
<h4 id="docker-build-and-push">Docker Build and Push</h4>
<p><strong>The Build Process Explained</strong>:</p>
<ol type="1">
<li><p><strong>Maven Build</strong> (<code>./mvnw clean package</code>):
Compiles Java code, runs tests (skip with <code>-DskipTests</code> for
faster builds, but NOT recommended for production deployments), and
packages everything into a JAR file.</p></li>
<li><p><strong>Docker Build</strong>: Uses the Dockerfile in
<code>backend/core/</code> to create a container image. This typically
starts with a base image (e.g., <code>openjdk:17-jdk-slim</code>),
copies the JAR file, and defines how to run the application.</p></li>
<li><p><strong>Tagging</strong>: <code>docker tag</code> creates an
alias pointing to the same image. We tag as both <code>latest</code>
(for convenience) and with the ECR repository URL (required for pushing
to ECR).</p></li>
<li><p><strong>ECR Login</strong>: AWS ECR requires authentication.
<code>get-login-password</code> retrieves a temporary token valid for 12
hours. Docker uses this to authenticate push operations.</p></li>
<li><p><strong>Push to ECR</strong>: Uploads the container image layers
to ECR. Only changed layers are uploaded (not the entire image each
time), speeding up subsequent pushes.</p></li>
</ol>
<p><strong>Security Note</strong>: Never push <code>:latest</code> to
production without also tagging with a specific version (e.g.,
<code>:v1.2.3</code> or commit SHA). The <code>:latest</code> tag can
change, making rollbacks difficult. Always use immutable tags in
production.</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Build backend Docker image</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> backend/core</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the application</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="ex">./mvnw</span> clean package <span class="at">-DskipTests</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Build Docker image</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> build <span class="at">-t</span> careconnect-backend:latest .</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Tag for ECR</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> tag careconnect-backend:latest 123456789012.dkr.ecr.us-east-1.amazonaws.com/careconnect-backend:latest</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Login to ECR</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ecr get-login-password <span class="at">--region</span> us-east-1 <span class="kw">|</span> <span class="ex">docker</span> login <span class="at">--username</span> AWS <span class="at">--password-stdin</span> 123456789012.dkr.ecr.us-east-1.amazonaws.com</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Push to ECR</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> push 123456789012.dkr.ecr.us-east-1.amazonaws.com/careconnect-backend:latest</span></code></pre></div>
<h4 id="ecs-service-update">ECS Service Update</h4>
<p>After pushing a new container image to ECR, you must tell ECS to
deploy it.</p>
<p><strong>Force New Deployment</strong>: The
<code>--force-new-deployment</code> flag tells ECS to pull the latest
image and replace existing containers, even if the task definition
hasn’t changed. This is useful when you push a new image with the same
tag (e.g., <code>:latest</code>).</p>
<p><strong>How the Deployment Works</strong>: 1. ECS pulls the new
container image from ECR 2. Starts new tasks (containers) running the
new image 3. Waits for new tasks to pass health checks (the Spring Boot
<code>/actuator/health</code> endpoint) 4. Once healthy, updates the
load balancer to send traffic to new tasks 5. Drains connections from
old tasks (waits for in-flight requests to complete) 6. Terminates old
tasks</p>
<p>This entire process takes 2-5 minutes typically. The
<code>aws ecs wait services-stable</code> command monitors the
deployment and only returns when it’s complete (or fails).</p>
<p><strong>Monitoring During Deployment</strong>: Watch CloudWatch Logs
for errors from new tasks. If new tasks fail health checks repeatedly,
ECS’s circuit breaker will automatically roll back to the previous
version.</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Update ECS service with new image</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ecs update-service <span class="dt">\</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">--cluster</span> careconnect-prod <span class="dt">\</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">--service</span> careconnect-prod-service <span class="dt">\</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">--force-new-deployment</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Monitor deployment</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ecs wait services-stable <span class="dt">\</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">--cluster</span> careconnect-prod <span class="dt">\</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">--services</span> careconnect-prod-service</span></code></pre></div>
<h3 id="frontend-deployment">Frontend Deployment</h3>
<p>The Flutter web app is deployed as static files (HTML, JavaScript,
CSS) to S3 and distributed globally via CloudFront CDN. Mobile apps
follow platform-specific release processes through app stores.</p>
<h4 id="build-and-deploy-to-s3">Build and Deploy to S3</h4>
<p><strong>Flutter Web Build Process</strong>:</p>
<p><code>flutter build web --release</code> compiles Dart code to
optimized JavaScript, minifies assets, and generates a production-ready
web app in the <code>build/web/</code> directory. The
<code>--release</code> flag enables: - Code minification (smaller files
= faster load times) - Dead code elimination (removes unused functions)
- Optimization passes (faster JavaScript execution)</p>
<p>Never deploy a debug build to production—they’re 10x larger and
include debug symbols attackers could exploit.</p>
<p><strong>S3 Sync Strategy</strong>: <code>aws s3 sync</code> is
smarter than <code>aws s3 cp</code>. It only uploads files that changed
(based on content hash), making deployments faster. The
<code>--delete</code> flag removes files from S3 that no longer exist
locally (e.g., if you renamed a page).</p>
<p><strong>Why Invalidate CloudFront</strong>: CloudFront caches files
at edge locations worldwide (for fast delivery). After deploying new
files to S3, CloudFront doesn’t automatically know—it might serve old
cached versions for hours. The <code>create-invalidation</code> command
tells CloudFront “discard all cached copies, fetch fresh from S3.” The
<code>/*</code> path means “invalidate everything.”</p>
<p><strong>Cost Note</strong>: CloudFront invalidations cost $0.005 per
path invalidated. Invalidating <code>/*</code> counts as ~1000 paths.
Use specific paths in production to save costs:
<code>--paths "/index.html" "/main.js"</code>.</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> frontend</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Install dependencies</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="ex">flutter</span> pub get</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Build for web</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="ex">flutter</span> build web <span class="at">--release</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Deploy to S3</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> s3 sync build/web s3://careconnect-prod-frontend <span class="at">--delete</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Invalidate CloudFront cache</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> cloudfront create-invalidation <span class="dt">\</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">--distribution-id</span> E1234567890123 <span class="dt">\</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">--paths</span> <span class="st">&quot;/*&quot;</span></span></code></pre></div>
<h4 id="mobile-app-deployment">Mobile App Deployment</h4>
<p><strong>Android App Bundle</strong>:
<code>flutter build appbundle</code> creates an <code>.aab</code> file
optimized for Google Play. App bundles allow Google Play to generate
APKs customized for each device (different screen sizes, architectures)
rather than one giant APK containing everything.</p>
<p><strong>iOS Archive</strong>: <code>flutter build ios</code>
generates an Xcode archive (<code>.ipa</code> file). This must be signed
with your Apple Developer certificate before upload to App Store
Connect.</p>
<p><strong>Why Manual Upload</strong>: Unlike web deployments (fully
automated), mobile app stores require human review. You upload through
the platform’s console, fill out release notes, screenshots, and privacy
info, then submit for review. Google typically reviews in hours; Apple
in 1-3 days.</p>
<p><strong>Versioning Strategy</strong>: Always increment version
numbers in <code>pubspec.yaml</code> before building. App stores reject
uploads with duplicate version numbers. Use semantic versioning (e.g.,
1.2.3 → 1.2.4 for bug fix, → 1.3.0 for new feature).</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Android</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="ex">flutter</span> build appbundle <span class="at">--release</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Upload to Google Play Console</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># (Manual process through Google Play Console)</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co"># iOS</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="ex">flutter</span> build ios <span class="at">--release</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Archive and upload to App Store Connect</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co"># (Use Xcode or Application Loader)</span></span></code></pre></div>
<h3 id="blue-green-deployment-strategy">Blue-Green Deployment
Strategy</h3>
<p>Blue-green deployment is a technique for achieving zero-downtime
deployments by running two identical production environments (“blue” and
“green”) and switching traffic between them. For CareConnect, ECS
handles much of this automatically, but understanding the process helps
troubleshoot deployment issues.</p>
<p><strong>What “Blue-Green” Means</strong>: - <strong>Blue</strong> =
Current production version serving live traffic - <strong>Green</strong>
= New version being deployed - <strong>Switchover</strong>: Once green
is healthy, traffic switches from blue to green -
<strong>Rollback</strong>: If green has issues, immediately switch back
to blue</p>
<p>ECS’s deployment configuration
(<code>maximum_percent = 200, minimum_healthy_percent = 100</code>)
implements this automatically, but the script below gives you manual
control for complex deployments.</p>
<h4 id="automated-blue-green-deployment">Automated Blue-Green
Deployment</h4>
<p><strong>Script Workflow Explained</strong>:</p>
<ol type="1">
<li><p><strong>Fetch Current Task Definition</strong>: Gets the
currently running task definition (which includes container image,
environment variables, resource limits). This is the “blue”
version.</p></li>
<li><p><strong>Create New Task Definition</strong>: Uses <code>jq</code>
to modify the JSON, replacing the old container image with the new one.
All other settings (CPU, memory, environment variables) stay the same.
This creates the “green” version.</p></li>
<li><p><strong>Register New Task Definition</strong>: ECS assigns a new
revision number (e.g., <code>careconnect-backend:42</code> becomes
<code>:43</code>).</p></li>
<li><p><strong>Update Service</strong>: Tells ECS to use the new task
definition. ECS then:</p>
<ul>
<li>Starts new tasks (green)</li>
<li>Waits for them to pass health checks</li>
<li>Adds them to the load balancer</li>
<li>Drains blue tasks</li>
<li>Terminates blue tasks</li>
</ul></li>
<li><p><strong>Wait for Stability</strong>: The
<code>aws ecs wait services-stable</code> command monitors the
deployment. It returns when all desired tasks are running and
healthy.</p></li>
<li><p><strong>Post-Deployment Health Check</strong>: Even after ECS
says tasks are healthy, this script performs an additional health check
by calling the actual API. This catches issues ECS health checks might
miss (e.g., database connection errors that occur after
startup).</p></li>
</ol>
<p><strong>Rollback Logic</strong>: If health checks fail after 10
attempts (5 minutes), the script should roll back by updating the
service to use the old task definition. In practice, ECS’s circuit
breaker would have already rolled back by this point, but this provides
an additional safety net.</p>
<p><strong>Why This Manual Script</strong>: While ECS deployments are
usually automatic (via CI/CD), having this script allows manual control
for: - Debugging deployment issues - Testing deployment procedures -
Emergency rollbacks when automation fails</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># scripts/blue-green-deploy.sh</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="at">-e</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="va">CLUSTER_NAME</span><span class="op">=</span><span class="st">&quot;careconnect-prod&quot;</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="va">SERVICE_NAME</span><span class="op">=</span><span class="st">&quot;careconnect-prod-service&quot;</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="va">NEW_IMAGE</span><span class="op">=</span><span class="st">&quot;123456789012.dkr.ecr.us-east-1.amazonaws.com/careconnect-backend:</span><span class="va">$BUILD_NUMBER</span><span class="st">&quot;</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Starting blue-green deployment...&quot;</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Get current task definition</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="va">CURRENT_TASK_DEF</span><span class="op">=</span><span class="va">$(</span><span class="ex">aws</span> ecs describe-services <span class="dt">\</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">--cluster</span> <span class="va">$CLUSTER_NAME</span> <span class="dt">\</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">--services</span> <span class="va">$SERVICE_NAME</span> <span class="dt">\</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">--query</span> <span class="st">&#39;services[0].taskDefinition&#39;</span> <span class="dt">\</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">--output</span> text<span class="va">)</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Current task definition: </span><span class="va">$CURRENT_TASK_DEF</span><span class="st">&quot;</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Create new task definition with new image</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="va">NEW_TASK_DEF</span><span class="op">=</span><span class="va">$(</span><span class="ex">aws</span> ecs describe-task-definition <span class="dt">\</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">--task-definition</span> <span class="va">$CURRENT_TASK_DEF</span> <span class="dt">\</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">--query</span> <span class="st">&#39;taskDefinition&#39;</span> <span class="kw">|</span> <span class="dt">\</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    <span class="ex">jq</span> <span class="at">--arg</span> IMAGE <span class="st">&quot;</span><span class="va">$NEW_IMAGE</span><span class="st">&quot;</span> <span class="st">&#39;.containerDefinitions[0].image = $IMAGE&#39;</span> <span class="kw">|</span> <span class="dt">\</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    <span class="ex">jq</span> <span class="st">&#39;del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .placementConstraints, .compatibilities, .registeredAt, .registeredBy)&#39;</span><span class="va">)</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a><span class="va">NEW_TASK_DEF_ARN</span><span class="op">=</span><span class="va">$(</span><span class="bu">echo</span> <span class="va">$NEW_TASK_DEF</span> <span class="kw">|</span> <span class="ex">aws</span> ecs register-task-definition <span class="at">--cli-input-json</span> file:///dev/stdin <span class="at">--query</span> <span class="st">&#39;taskDefinition.taskDefinitionArn&#39;</span> <span class="at">--output</span> text<span class="va">)</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;New task definition: </span><span class="va">$NEW_TASK_DEF_ARN</span><span class="st">&quot;</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Update service with new task definition</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ecs update-service <span class="dt">\</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">--cluster</span> <span class="va">$CLUSTER_NAME</span> <span class="dt">\</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">--service</span> <span class="va">$SERVICE_NAME</span> <span class="dt">\</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">--task-definition</span> <span class="va">$NEW_TASK_DEF_ARN</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Wait for deployment to complete</span></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Waiting for deployment to complete...&quot;</span></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ecs wait services-stable <span class="dt">\</span></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">--cluster</span> <span class="va">$CLUSTER_NAME</span> <span class="dt">\</span></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">--services</span> <span class="va">$SERVICE_NAME</span></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Health check</span></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Performing health check...&quot;</span></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a><span class="va">HEALTH_CHECK_URL</span><span class="op">=</span><span class="st">&quot;https://api.careconnect.example.com/actuator/health&quot;</span></span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="dt">{</span><span class="dv">1</span><span class="dt">..</span><span class="dv">10</span><span class="dt">}</span><span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="ex">curl</span> <span class="at">-f</span> <span class="va">$HEALTH_CHECK_URL</span> <span class="op">&gt;</span> /dev/null <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>        <span class="bu">echo</span> <span class="st">&quot;Health check passed&quot;</span></span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>        <span class="bu">echo</span> <span class="st">&quot;Health check failed, attempt </span><span class="va">$i</span><span class="st">/10&quot;</span></span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">[</span> <span class="va">$i</span> <span class="ot">-eq</span> 10 <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>            <span class="bu">echo</span> <span class="st">&quot;Health check failed after 10 attempts, rolling back...&quot;</span></span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Rollback logic here</span></span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>            <span class="bu">exit</span> 1</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">fi</span></span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sleep</span> 30</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">fi</span></span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Blue-green deployment completed successfully!&quot;</span></span></code></pre></div>
<h2 id="database-management">Database Management</h2>
<p>Managing a PostgreSQL database in production requires careful
attention to user permissions, performance tuning, and migration
strategies. In healthcare applications, the database is the most
critical component—patient data integrity and availability directly
impact care quality.</p>
<h3 id="database-initialization">Database Initialization</h3>
<p>Initial database setup involves more than just creating a database.
We create multiple users with different permission levels, following the
principle of least privilege: each user gets only the permissions needed
for their role.</p>
<h4 id="production-database-setup">Production Database Setup</h4>
<p><strong>User Roles Strategy</strong>:</p>
<ol type="1">
<li><p><strong>careconnect_app</strong>: The application user. Has full
CRUD permissions on tables but CANNOT create/drop tables or modify
schema. This prevents a compromised application from destroying the
database structure.</p></li>
<li><p><strong>careconnect_readonly</strong>: For analytics and
reporting tools. Can only SELECT data, preventing accidental
modifications during report generation.</p></li>
<li><p><strong>careconnect_backup</strong>: For backup tools. Can SELECT
all data but cannot modify anything. Some backup tools need database
credentials, and this ensures they can’t accidentally corrupt
data.</p></li>
</ol>
<p><strong>Why Not Use <code>postgres</code> Superuser</strong>: The
default <code>postgres</code> user has unrestricted access, including
the ability to drop the entire database. If an attacker compromises the
application and finds database credentials, limiting permissions reduces
damage.</p>
<p><strong>Performance Parameters Explained</strong>:</p>
<ul>
<li><code>shared_buffers = '1GB'</code>: Memory PostgreSQL uses for
caching. More memory = fewer disk reads = faster queries. Rule of thumb:
25% of system RAM.</li>
<li><code>max_connections = 200</code>: Maximum concurrent database
connections. Each connection consumes memory, so this must balance
capacity with resource constraints.</li>
<li><code>log_min_duration_statement = 2000</code>: Logs any query
taking longer than 2 seconds. This helps identify slow queries without
logging every query (which would fill disk space quickly).</li>
</ul>
<p><strong>Character Encoding</strong>: <code>UTF8</code> encoding
supports international characters (accents, non-Latin scripts) which is
important for patient names and medical terminology from any
language.</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- scripts/init-prod-db.sql</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- Create database</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">DATABASE</span> careconnect</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WITH</span> ENCODING <span class="st">&#39;UTF8&#39;</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    LC_COLLATE <span class="st">&#39;en_US.UTF-8&#39;</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    LC_CTYPE <span class="st">&#39;en_US.UTF-8&#39;</span>;</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co">-- Create application user</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="fu">USER</span> careconnect_app <span class="kw">WITH</span> ENCRYPTED <span class="kw">PASSWORD</span> <span class="st">&#39;secure_password_here&#39;</span>;</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="kw">GRANT</span> <span class="kw">CONNECT</span> <span class="kw">ON</span> <span class="kw">DATABASE</span> careconnect <span class="kw">TO</span> careconnect_app;</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="kw">GRANT</span> <span class="kw">USAGE</span> <span class="kw">ON</span> <span class="kw">SCHEMA</span> <span class="kw">public</span> <span class="kw">TO</span> careconnect_app;</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="kw">GRANT</span> <span class="kw">SELECT</span>, <span class="kw">INSERT</span>, <span class="kw">UPDATE</span>, <span class="kw">DELETE</span> <span class="kw">ON</span> <span class="kw">ALL</span> <span class="kw">TABLES</span> <span class="kw">IN</span> <span class="kw">SCHEMA</span> <span class="kw">public</span> <span class="kw">TO</span> careconnect_app;</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="kw">GRANT</span> <span class="kw">USAGE</span>, <span class="kw">SELECT</span> <span class="kw">ON</span> <span class="kw">ALL</span> SEQUENCES <span class="kw">IN</span> <span class="kw">SCHEMA</span> <span class="kw">public</span> <span class="kw">TO</span> careconnect_app;</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="co">-- Create read-only user for reporting</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="fu">USER</span> careconnect_readonly <span class="kw">WITH</span> ENCRYPTED <span class="kw">PASSWORD</span> <span class="st">&#39;readonly_password_here&#39;</span>;</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="kw">GRANT</span> <span class="kw">CONNECT</span> <span class="kw">ON</span> <span class="kw">DATABASE</span> careconnect <span class="kw">TO</span> careconnect_readonly;</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="kw">GRANT</span> <span class="kw">USAGE</span> <span class="kw">ON</span> <span class="kw">SCHEMA</span> <span class="kw">public</span> <span class="kw">TO</span> careconnect_readonly;</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="kw">GRANT</span> <span class="kw">SELECT</span> <span class="kw">ON</span> <span class="kw">ALL</span> <span class="kw">TABLES</span> <span class="kw">IN</span> <span class="kw">SCHEMA</span> <span class="kw">public</span> <span class="kw">TO</span> careconnect_readonly;</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="co">-- Create backup user</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="fu">USER</span> careconnect_backup <span class="kw">WITH</span> ENCRYPTED <span class="kw">PASSWORD</span> <span class="st">&#39;backup_password_here&#39;</span>;</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="kw">GRANT</span> <span class="kw">CONNECT</span> <span class="kw">ON</span> <span class="kw">DATABASE</span> careconnect <span class="kw">TO</span> careconnect_backup;</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="kw">GRANT</span> <span class="kw">USAGE</span> <span class="kw">ON</span> <span class="kw">SCHEMA</span> <span class="kw">public</span> <span class="kw">TO</span> careconnect_backup;</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="kw">GRANT</span> <span class="kw">SELECT</span> <span class="kw">ON</span> <span class="kw">ALL</span> <span class="kw">TABLES</span> <span class="kw">IN</span> <span class="kw">SCHEMA</span> <span class="kw">public</span> <span class="kw">TO</span> careconnect_backup;</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="co">-- Connect to the database</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>\c careconnect;</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a><span class="co">-- Configure performance parameters</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">SYSTEM</span> <span class="kw">SET</span> shared_buffers <span class="op">=</span> <span class="st">&#39;1GB&#39;</span>;</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">SYSTEM</span> <span class="kw">SET</span> max_connections <span class="op">=</span> <span class="dv">200</span>;</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">SYSTEM</span> <span class="kw">SET</span> log_min_duration_statement <span class="op">=</span> <span class="dv">2000</span>; <span class="co">-- Log queries taking &gt; 2s</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> pg_reload_conf();</span></code></pre></div>
<h3 id="database-migration-strategy">Database Migration Strategy</h3>
<p>Database migrations allow you to evolve the database schema over time
while preserving data. Flyway is a migration tool that tracks which
schema changes have been applied, ensuring migrations run exactly once
in the correct order.</p>
<p><strong>Why Flyway Over Manual SQL</strong>: Without a migration
tool, you’d have to manually track which SQL scripts ran in each
environment (dev, staging, prod). Missed scripts lead to schema
drift—dev has columns prod doesn’t, causing deployment failures. Flyway
solves this by maintaining a <code>flyway_schema_history</code> table
that records every migration.</p>
<h4 id="flyway-migration-setup">Flyway Migration Setup</h4>
<p><strong>How Flyway Works</strong>: 1. <strong>Version-Named
Files</strong>: Migrations are SQL files named
<code>V001__description.sql</code>,
<code>V002__another_change.sql</code>. The version number determines
execution order. 2. <strong>Checksum Validation</strong>: Flyway
calculates a checksum of each migration file. If you modify a file after
it’s been applied, Flyway detects the change and fails—preventing
accidental modifications to historical migrations. 3. <strong>Automatic
Execution</strong>: On application startup (or via Maven command),
Flyway checks which migrations haven’t run yet and executes them in
order.</p>
<p><strong>Configuration Parameters</strong>: -
<code>baselineOnMigrate=true</code>: If the database already has tables
(e.g., you’re adding Flyway to an existing database), this treats the
current schema as “version 0” instead of failing. -
<code>validateOnMigrate=true</code>: Before running migrations, verifies
all previously applied migrations haven’t been modified. Prevents
database corruption from changing historical migrations.</p>
<p><strong>Common Pitfall</strong>: Never modify a migration file after
it’s been deployed. If you need to change something, create a NEW
migration file that reverses or corrects the previous one.</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode xml"><code class="sourceCode xml"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- backend/core/pom.xml - Flyway plugin --&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">plugin</span>&gt;</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">groupId</span>&gt;org.flywaydb&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">artifactId</span>&gt;flyway-maven-plugin&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">version</span>&gt;9.16.0&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">configuration</span>&gt;</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">url</span>&gt;jdbc:postgresql://${db.host}:${db.port}/${db.name}&lt;/<span class="kw">url</span>&gt;</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">user</span>&gt;${db.username}&lt;/<span class="kw">user</span>&gt;</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">password</span>&gt;${db.password}&lt;/<span class="kw">password</span>&gt;</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">locations</span>&gt;</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">location</span>&gt;filesystem:src/main/resources/db/migration&lt;/<span class="kw">location</span>&gt;</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">locations</span>&gt;</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">baselineOnMigrate</span>&gt;true&lt;/<span class="kw">baselineOnMigrate</span>&gt;</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">validateOnMigrate</span>&gt;true&lt;/<span class="kw">validateOnMigrate</span>&gt;</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">configuration</span>&gt;</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">plugin</span>&gt;</span></code></pre></div>
<h4 id="sample-migration-files">Sample Migration Files</h4>
<p>These migration files demonstrate best practices for database schema
evolution. Each file is versioned (V001, V002, V003) and runs exactly
once in order.</p>
<p><strong>Key Design Patterns in These Migrations</strong>:</p>
<p><strong>Primary Keys as BIGSERIAL</strong>: Using
<code>BIGSERIAL</code> instead of <code>SERIAL</code> provides 64-bit
integers (vs 32-bit), supporting up to 9 quintillion records. While
healthcare apps rarely need this, the performance cost is negligible and
it prevents “ran out of IDs” failures 10 years from now.</p>
<p><strong>Foreign Key Constraints</strong>:
<code>REFERENCES users(id) ON DELETE CASCADE</code> ensures referential
integrity. If a user is deleted, their vital signs and medications are
automatically deleted too, preventing orphaned records. Healthcare
compliance often requires retaining records even after account deletion,
so in production you might use <code>ON DELETE RESTRICT</code>
instead.</p>
<p><strong>Check Constraints</strong>:
<code>CHECK (role IN ('PATIENT', 'CAREGIVER', 'FAMILY_MEMBER'))</code>
enforces valid values at the database level. Even if application code
has a bug, invalid roles can’t be inserted. This is
defense-in-depth.</p>
<p><strong>Index Strategy</strong>: - <code>idx_users_email</code>:
Unique index on email enables fast lookup during login -
<code>idx_vital_signs_user_type_time</code>: Composite index optimized
for querying “all blood pressure readings for user X in the last
month”—a common healthcare query pattern -
<code>measurement_time DESC</code>: Descending order because we usually
want recent measurements first</p>
<p><strong>Auto-updating Timestamps</strong>: The trigger
<code>update_updated_at_column()</code> automatically sets
<code>updated_at</code> on every UPDATE. This audit trail is critical in
healthcare for compliance and debugging (“when did this medication
dosage change?”).</p>
<p><strong>DECIMAL for Medical Values</strong>: Vital signs use
<code>DECIMAL(10,2)</code> not <code>FLOAT</code> because floating-point
arithmetic has rounding errors. For blood pressure like “120.5 mmHg,”
exact precision matters for medical accuracy.</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- src/main/resources/db/migration/V001__Create_initial_schema.sql</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> users (</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> BIGSERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    email <span class="dt">VARCHAR</span>(<span class="dv">255</span>) <span class="kw">UNIQUE</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">password</span> <span class="dt">VARCHAR</span>(<span class="dv">255</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    first_name <span class="dt">VARCHAR</span>(<span class="dv">100</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    last_name <span class="dt">VARCHAR</span>(<span class="dv">100</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">role</span> <span class="dt">VARCHAR</span>(<span class="dv">20</span>) <span class="kw">CHECK</span> (<span class="kw">role</span> <span class="kw">IN</span> (<span class="st">&#39;PATIENT&#39;</span>, <span class="st">&#39;CAREGIVER&#39;</span>, <span class="st">&#39;FAMILY_MEMBER&#39;</span>)) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    active <span class="dt">BOOLEAN</span> <span class="kw">DEFAULT</span> <span class="kw">TRUE</span>,</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    created_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    updated_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_users_email <span class="kw">ON</span> users(email);</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_users_role <span class="kw">ON</span> users(<span class="kw">role</span>);</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_users_active <span class="kw">ON</span> users(active);</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="co">-- Create trigger for updated_at</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> update_updated_at_column()</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>RETURNS <span class="kw">TRIGGER</span> <span class="kw">AS</span> $$</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>   <span class="kw">NEW</span>.updated_at <span class="op">=</span> <span class="fu">CURRENT_TIMESTAMP</span>;</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>   <span class="kw">RETURN</span> <span class="kw">NEW</span>;</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>$$ language <span class="st">&#39;plpgsql&#39;</span>;</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TRIGGER</span> update_users_updated_at <span class="kw">BEFORE</span> <span class="kw">UPDATE</span> <span class="kw">ON</span> users</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">FOR</span> <span class="kw">EACH</span> <span class="kw">ROW</span> <span class="kw">EXECUTE</span> <span class="kw">FUNCTION</span> update_updated_at_column();</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a><span class="co">-- src/main/resources/db/migration/V002__Create_vital_signs_table.sql</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> vital_signs (</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> BIGSERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    user_id BIGINT <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">REFERENCES</span> users(<span class="kw">id</span>) <span class="kw">ON</span> <span class="kw">DELETE</span> <span class="kw">CASCADE</span>,</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">type</span> <span class="dt">VARCHAR</span>(<span class="dv">50</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">value</span> <span class="dt">DECIMAL</span>(<span class="dv">10</span>,<span class="dv">2</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    unit <span class="dt">VARCHAR</span>(<span class="dv">20</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    notes TEXT,</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>    measurement_time <span class="dt">TIMESTAMP</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>    created_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>    updated_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_vital_signs_user_id <span class="kw">ON</span> vital_signs(user_id);</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_vital_signs_type <span class="kw">ON</span> vital_signs(<span class="kw">type</span>);</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_vital_signs_measurement_time <span class="kw">ON</span> vital_signs(measurement_time);</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_vital_signs_user_type_time <span class="kw">ON</span> vital_signs(user_id, <span class="kw">type</span>, measurement_time <span class="kw">DESC</span>);</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TRIGGER</span> update_vital_signs_updated_at <span class="kw">BEFORE</span> <span class="kw">UPDATE</span> <span class="kw">ON</span> vital_signs</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">FOR</span> <span class="kw">EACH</span> <span class="kw">ROW</span> <span class="kw">EXECUTE</span> <span class="kw">FUNCTION</span> update_updated_at_column();</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a><span class="co">-- src/main/resources/db/migration/V003__Add_health_monitoring_tables.sql</span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> medications (</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> BIGSERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>    user_id BIGINT <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">REFERENCES</span> users(<span class="kw">id</span>) <span class="kw">ON</span> <span class="kw">DELETE</span> <span class="kw">CASCADE</span>,</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>    name <span class="dt">VARCHAR</span>(<span class="dv">255</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>    dosage <span class="dt">VARCHAR</span>(<span class="dv">100</span>),</span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>    frequency <span class="dt">VARCHAR</span>(<span class="dv">100</span>),</span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>    start_date <span class="dt">DATE</span>,</span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>    end_date <span class="dt">DATE</span>,</span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>    active <span class="dt">BOOLEAN</span> <span class="kw">DEFAULT</span> <span class="kw">TRUE</span>,</span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>    created_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>    updated_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span></span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_medications_user_id <span class="kw">ON</span> medications(user_id);</span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_medications_active <span class="kw">ON</span> medications(active);</span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TRIGGER</span> update_medications_updated_at <span class="kw">BEFORE</span> <span class="kw">UPDATE</span> <span class="kw">ON</span> medications</span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">FOR</span> <span class="kw">EACH</span> <span class="kw">ROW</span> <span class="kw">EXECUTE</span> <span class="kw">FUNCTION</span> update_updated_at_column();</span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> allergies (</span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> BIGSERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a>    user_id BIGINT <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">REFERENCES</span> users(<span class="kw">id</span>) <span class="kw">ON</span> <span class="kw">DELETE</span> <span class="kw">CASCADE</span>,</span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a>    allergen <span class="dt">VARCHAR</span>(<span class="dv">255</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a>    severity <span class="dt">VARCHAR</span>(<span class="dv">20</span>) <span class="kw">CHECK</span> (severity <span class="kw">IN</span> (<span class="st">&#39;MILD&#39;</span>, <span class="st">&#39;MODERATE&#39;</span>, <span class="st">&#39;SEVERE&#39;</span>)) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a>    reaction TEXT,</span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a>    created_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a>    updated_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span></span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_allergies_user_id <span class="kw">ON</span> allergies(user_id);</span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-83"><a href="#cb18-83" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TRIGGER</span> update_allergies_updated_at <span class="kw">BEFORE</span> <span class="kw">UPDATE</span> <span class="kw">ON</span> allergies</span>
<span id="cb18-84"><a href="#cb18-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">FOR</span> <span class="kw">EACH</span> <span class="kw">ROW</span> <span class="kw">EXECUTE</span> <span class="kw">FUNCTION</span> update_updated_at_column();</span></code></pre></div>
<h3 id="database-backup-strategy">Database Backup Strategy</h3>
<p>Database backups are critical for disaster recovery and compliance.
Healthcare regulations often require maintaining backups for 7-10 years.
Our strategy combines automated daily backups with AWS RDS’s built-in
continuous backup.</p>
<p><strong>Two-Tier Backup Approach</strong>: 1. <strong>RDS Automated
Backups</strong>: Continuous transaction log backups enabling
point-in-time recovery within the last 30 days 2. <strong>Manual pg_dump
Backups</strong>: Full logical backups stored in S3 with long-term
retention for compliance</p>
<h4 id="automated-backup-script">Automated Backup Script</h4>
<p><strong>Why Both RDS Snapshots AND pg_dump</strong>: - <strong>RDS
Snapshots</strong>: Fast to restore, perfect for recent disasters
(accidental deletion, bad deployment) - <strong>pg_dump
Backups</strong>: Platform-independent SQL dumps you can restore to any
PostgreSQL instance (not locked into AWS)</p>
<p><strong>Script Components Explained</strong>:</p>
<p><strong>Custom Format</strong>: <code>--format=custom</code> creates
a PostgreSQL-specific binary format that’s: - Smaller than plain SQL
(important for large databases) - Faster to restore than plain SQL -
Allows selective restoration (restore just one table if needed)</p>
<p><strong>Compression Level 9</strong>: <code>--compress=9</code>
provides maximum compression at the cost of CPU time. For nightly
backups, we have time; for emergency backups, you might use lower
compression for speed.</p>
<p><strong>Clean and Create</strong>: <code>--clean --create</code>
means the restore script will: - Drop the database if it exists
(<code>--clean</code>) - Recreate the database (<code>--create</code>)
This makes restores idempotent—running twice gives same result.</p>
<p><strong>Retention Policy</strong>: The script deletes backups older
than <code>RETENTION_DAYS</code> (30). Adjust this based on compliance
requirements. Healthcare apps might need 2555 days (7 years).</p>
<p><strong>Backup Verification</strong>: The script checks if the backup
file is at least 1MB. A tiny backup likely indicates a failure (empty
database or pg_dump error). In production, you’d also test-restore
backups periodically to verify they’re actually usable.</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># scripts/backup-database.sh</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="at">-e</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Configuration</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="va">DB_HOST</span><span class="op">=</span><span class="st">&quot;prod-db.region.rds.amazonaws.com&quot;</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="va">DB_NAME</span><span class="op">=</span><span class="st">&quot;careconnect&quot;</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="va">DB_USER</span><span class="op">=</span><span class="st">&quot;careconnect_backup&quot;</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="va">DB_PASSWORD</span><span class="op">=</span><span class="st">&quot;</span><span class="va">$DB_BACKUP_PASSWORD</span><span class="st">&quot;</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="va">S3_BUCKET</span><span class="op">=</span><span class="st">&quot;careconnect-prod-backups&quot;</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="va">BACKUP_PREFIX</span><span class="op">=</span><span class="st">&quot;database&quot;</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="va">RETENTION_DAYS</span><span class="op">=</span>30</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Create timestamp</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="va">TIMESTAMP</span><span class="op">=</span><span class="va">$(</span><span class="fu">date</span> +%Y%m%d_%H%M%S<span class="va">)</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="va">BACKUP_FILENAME</span><span class="op">=</span><span class="st">&quot;</span><span class="va">${BACKUP_PREFIX}</span><span class="st">_</span><span class="va">${TIMESTAMP}</span><span class="st">.sql.gz&quot;</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Starting database backup: </span><span class="va">$BACKUP_FILENAME</span><span class="st">&quot;</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Create backup</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="ex">pg_dump</span> <span class="dt">\</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">--host</span><span class="op">=</span><span class="va">$DB_HOST</span> <span class="dt">\</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">--username</span><span class="op">=</span><span class="va">$DB_USER</span> <span class="dt">\</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">--no-password</span> <span class="dt">\</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">--format</span><span class="op">=</span>custom <span class="dt">\</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">--compress</span><span class="op">=</span>9 <span class="dt">\</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">--clean</span> <span class="dt">\</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">--create</span> <span class="dt">\</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">--dbname</span><span class="op">=</span><span class="va">$DB_NAME</span> <span class="dt">\</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">--file</span><span class="op">=</span>/tmp/<span class="va">$BACKUP_FILENAME</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">PGPASSWORD</span><span class="op">=</span><span class="va">$DB_PASSWORD</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Upload to S3</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> s3 cp /tmp/<span class="va">$BACKUP_FILENAME</span> s3://<span class="va">$S3_BUCKET</span>/database/</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean up local file</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> /tmp/<span class="va">$BACKUP_FILENAME</span></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean up old backups</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> s3 ls s3://<span class="va">$S3_BUCKET</span>/database/ <span class="kw">|</span> <span class="dt">\</span></span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">awk</span> <span class="st">&#39;{print $4}&#39;</span> <span class="kw">|</span> <span class="dt">\</span></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span> <span class="at">-n</span> <span class="at">-</span><span class="va">$RETENTION_DAYS</span> <span class="kw">|</span> <span class="dt">\</span></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="bu">read</span> <span class="va">file</span><span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>        <span class="ex">aws</span> s3 rm s3://<span class="va">$S3_BUCKET</span>/database/<span class="va">$file</span></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">done</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Database backup completed: </span><span class="va">$BACKUP_FILENAME</span><span class="st">&quot;</span></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify backup</span></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a><span class="va">BACKUP_SIZE</span><span class="op">=</span><span class="va">$(</span><span class="ex">aws</span> s3 ls s3://<span class="va">$S3_BUCKET</span>/database/<span class="va">$BACKUP_FILENAME</span> <span class="at">--summarize</span> <span class="kw">|</span> <span class="fu">grep</span> <span class="st">&quot;Total Size&quot;</span> <span class="kw">|</span> <span class="fu">awk</span> <span class="st">&#39;{print $3}&#39;</span><span class="va">)</span></span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="st">&quot;</span><span class="va">$BACKUP_SIZE</span><span class="st">&quot;</span> <span class="ot">-gt</span> 1000000 <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span>  <span class="co"># 1MB minimum</span></span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;Backup verification passed: </span><span class="va">$BACKUP_SIZE</span><span class="st"> bytes&quot;</span></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;Backup verification failed: </span><span class="va">$BACKUP_SIZE</span><span class="st"> bytes&quot;</span></span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>    <span class="bu">exit</span> 1</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span></code></pre></div>
<h4 id="point-in-time-recovery">Point-in-Time Recovery</h4>
<p>RDS’s automated backups enable point-in-time recovery
(PITR)—restoring the database to any second within the last 30 days.
This is invaluable when you discover data corruption hours after it
occurred.</p>
<p><strong>When to Use PITR</strong>: - Accidental data deletion
discovered hours later (“someone deleted all patients yesterday at 2:15
PM”) - Bad migration or deployment corrupted data - Ransomware attack
encrypted your data (restore to just before attack)</p>
<p><strong>How PITR Works</strong>: 1. <strong>Base Snapshot</strong>:
RDS takes daily snapshots of your entire database 2. <strong>Transaction
Logs</strong>: Every database modification is logged continuously 3.
<strong>Restoration</strong>: To restore to time T, RDS takes the most
recent snapshot before T, then replays transaction logs up to time T</p>
<p><strong>Script Workflow</strong>: 1. Specify restore time (e.g.,
“2024-10-15 14:30:00” - just before the bad deployment) 2. AWS creates a
NEW RDS instance with data from that exact time 3. You can query this
instance to verify it has correct data 4. If good, redirect application
to this instance; if not, delete and try different time</p>
<p><strong>Why Restore to New Instance</strong>: Never restore to the
production instance directly—you might overwrite good data with bad data
if you picked wrong restore time. Always restore to a new instance,
verify, THEN promote to production.</p>
<p><strong>Cost Note</strong>: The restored instance runs at full cost
until you delete it. Don’t forget to clean up after recovery!</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co"># scripts/restore-database.sh</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="at">-e</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="va">RESTORE_TIME</span><span class="op">=</span><span class="st">&quot;</span><span class="va">$1</span><span class="st">&quot;</span>  <span class="co"># Format: YYYY-MM-DD HH:MM:SS</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="va">SOURCE_DB_INSTANCE</span><span class="op">=</span><span class="st">&quot;careconnect-prod-db&quot;</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="va">TARGET_DB_INSTANCE</span><span class="op">=</span><span class="st">&quot;careconnect-restore-</span><span class="va">$(</span><span class="fu">date</span> +%Y%m%d%H%M%S<span class="va">)</span><span class="st">&quot;</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="ot">-z</span> <span class="st">&quot;</span><span class="va">$RESTORE_TIME</span><span class="st">&quot;</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;Usage: </span><span class="va">$0</span><span class="st"> &#39;YYYY-MM-DD HH:MM:SS&#39;&quot;</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">exit</span> 1</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Starting point-in-time recovery to: </span><span class="va">$RESTORE_TIME</span><span class="st">&quot;</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Create restored DB instance</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> rds restore-db-instance-to-point-in-time <span class="dt">\</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">--target-db-instance-identifier</span> <span class="va">$TARGET_DB_INSTANCE</span> <span class="dt">\</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">--source-db-instance-identifier</span> <span class="va">$SOURCE_DB_INSTANCE</span> <span class="dt">\</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">--restore-time</span> <span class="st">&quot;</span><span class="va">$RESTORE_TIME</span><span class="st">&quot;</span> <span class="dt">\</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">--db-instance-class</span> db.r6g.large <span class="dt">\</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">--no-multi-az</span> <span class="dt">\</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">--no-publicly-accessible</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Restore initiated. Instance: </span><span class="va">$TARGET_DB_INSTANCE</span><span class="st">&quot;</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Wait for instance to be available</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> rds wait db-instance-available <span class="dt">\</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">--db-instance-identifier</span> <span class="va">$TARGET_DB_INSTANCE</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Database restore completed: </span><span class="va">$TARGET_DB_INSTANCE</span><span class="st">&quot;</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Get endpoint</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a><span class="va">RESTORE_ENDPOINT</span><span class="op">=</span><span class="va">$(</span><span class="ex">aws</span> rds describe-db-instances <span class="dt">\</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">--db-instance-identifier</span> <span class="va">$TARGET_DB_INSTANCE</span> <span class="dt">\</span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">--query</span> <span class="st">&#39;DBInstances[0].Endpoint.Address&#39;</span> <span class="dt">\</span></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">--output</span> text<span class="va">)</span></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Restored database endpoint: </span><span class="va">$RESTORE_ENDPOINT</span><span class="st">&quot;</span></span></code></pre></div>
<h2 id="cicd-pipeline">CI/CD Pipeline</h2>
<p>Continuous Integration and Continuous Deployment (CI/CD) automate the
path from code commit to production deployment. For CareConnect, GitHub
Actions orchestrates testing, building, and deploying both backend and
frontend whenever code is pushed to the main branch.</p>
<p><strong>Why Automate Deployment</strong>: Manual deployments are
error-prone—it’s easy to forget a step, deploy to the wrong environment,
or skip testing. Automated pipelines ensure every deployment follows the
same tested process.</p>
<p><strong>Pipeline Philosophy</strong>: Our pipeline follows a strict
sequence: Test → Build → Deploy → Migrate → Smoke Test → Notify. If any
step fails, the pipeline stops immediately, preventing broken code from
reaching production.</p>
<h3 id="github-actions-workflow">GitHub Actions Workflow</h3>
<p>GitHub Actions is tightly integrated with GitHub, making it ideal for
open-source and team projects. Workflows are defined in YAML and run in
ephemeral containers, ensuring clean build environments every time.</p>
<p><strong>Workflow Triggers Explained</strong>: -
<code>on: push: branches: [main]</code>: Automatically deploys whenever
code is merged to main branch - <code>workflow_dispatch</code>: Allows
manual triggering from GitHub UI (useful for hotfixes)</p>
<p><strong>Job Dependencies</strong>: The <code>needs</code> keyword
creates a directed acyclic graph (DAG) of jobs:</p>
<pre><code>test → build-and-deploy-backend → run-migrations → smoke-tests → notify
    → build-and-deploy-frontend ───────────↗</code></pre>
<p>Backend and frontend deploy in parallel (faster), but migrations wait
for backend deployment (migrations need the new code to be live).</p>
<p><strong>Services in GitHub Actions</strong>: The
<code>services: postgres:</code> block starts a PostgreSQL container
alongside the test runner. This gives tests a real database rather than
mocks, catching more bugs. The health check ensures PostgreSQL is ready
before tests run.</p>
<p><strong>Why Cache Maven Packages</strong>: Maven downloads
dependencies from the internet, which is slow. The <code>cache</code>
action stores <code>~/.m2</code> between builds, turning 5-minute
dependency downloads into 10-second cache restores.</p>
<p><strong>Immutable Image Tags</strong>: Each build tags the Docker
image with <code>$GITHUB_SHA</code> (the git commit hash). This creates
an immutable reference—you can always deploy commit <code>abc123</code>
exactly as it was built, essential for rollbacks.</p>
<p><strong>Secrets Management</strong>:
<code>${{ secrets.AWS_ACCESS_KEY_ID }}</code> references secrets stored
in GitHub’s encrypted secrets store. Never hardcode credentials in
workflows—they’d be visible in version history forever.</p>
<p><strong>Deployment Safety</strong>: The workflow waits
(<code>aws ecs wait services-stable</code>) until deployment completes
before running smoke tests. This prevents false positives from testing
the old version while new version is still deploying.</p>
<p><strong>Smoke Tests Strategy</strong>: After deployment, the pipeline
makes real HTTP requests to production endpoints: - <code>curl -f</code>
fails if HTTP status isn’t 2xx, causing the job to fail - Testing
<code>/actuator/health</code> verifies Spring Boot started correctly -
Testing a known-failure case (invalid login) verifies the API logic
works, not just the health endpoint</p>
<p><strong>Notification Strategy</strong>: The <code>if: always()</code>
ensures notifications run even if previous jobs failed. The
<code>if: ${{ success() }}</code> vs <code>if: ${{ failure() }}</code>
conditionals send appropriate messages. This is how the team learns
about deployment results immediately via Slack.</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># .github/workflows/deploy-production.yml</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Deploy to Production</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">push</span><span class="kw">:</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">main</span><span class="kw">]</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">workflow_dispatch</span><span class="kw">:</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">AWS_REGION</span><span class="kw">:</span><span class="at"> us-east-1</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ECR_REPOSITORY</span><span class="kw">:</span><span class="at"> careconnect-backend</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ECS_CLUSTER</span><span class="kw">:</span><span class="at"> careconnect-prod</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ECS_SERVICE</span><span class="kw">:</span><span class="at"> careconnect-prod-service</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">test</span><span class="kw">:</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">postgres</span><span class="kw">:</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> postgres:15</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">POSTGRES_PASSWORD</span><span class="kw">:</span><span class="at"> test</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">POSTGRES_DB</span><span class="kw">:</span><span class="at"> careconnect_test</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> 5432:5432</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">options</span><span class="kw">:</span><span class="at"> --health-cmd=&quot;pg_isready&quot; --health-interval=10s --health-timeout=5s --health-retries=3</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Checkout code</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v4</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Set up JDK 17</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/setup-java@v3</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">java-version</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;17&#39;</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">distribution</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;adopt&#39;</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Cache Maven packages</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/cache@v3</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">path</span><span class="kw">:</span><span class="at"> ~/.m2</span></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">key</span><span class="kw">:</span><span class="at"> ${{ runner.os }}-m2-${{ hashFiles(&#39;**/pom.xml&#39;) }}</span></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">restore-keys</span><span class="kw">:</span><span class="at"> ${{ runner.os }}-m2</span></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run backend tests</span></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">working-directory</span><span class="kw">:</span><span class="at"> backend/core</span></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span><span class="at"> ./mvnw test</span></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">SPRING_DATASOURCE_URL</span><span class="kw">:</span><span class="at"> jdbc:postgresql://localhost:5432/careconnect_test</span></span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">SPRING_DATASOURCE_USERNAME</span><span class="kw">:</span><span class="at"> postgres</span></span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">SPRING_DATASOURCE_PASSWORD</span><span class="kw">:</span><span class="at"> test</span></span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Set up Flutter</span></span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> subosito/flutter-action@v2</span></span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">flutter-version</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;3.9.2&#39;</span></span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run frontend tests</span></span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">working-directory</span><span class="kw">:</span><span class="at"> frontend</span></span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a><span class="fu">      run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a>        flutter pub get</span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>        flutter test</span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">build-and-deploy-backend</span><span class="kw">:</span></span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">needs</span><span class="kw">:</span><span class="at"> test</span></span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Checkout code</span></span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v4</span></span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Configure AWS credentials</span></span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> aws-actions/configure-aws-credentials@v3</span></span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">aws-access-key-id</span><span class="kw">:</span><span class="at"> ${{ secrets.AWS_ACCESS_KEY_ID }}</span></span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">aws-secret-access-key</span><span class="kw">:</span><span class="at"> ${{ secrets.AWS_SECRET_ACCESS_KEY }}</span></span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">aws-region</span><span class="kw">:</span><span class="at"> ${{ env.AWS_REGION }}</span></span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Login to Amazon ECR</span></span>
<span id="cb22-81"><a href="#cb22-81" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">id</span><span class="kw">:</span><span class="at"> login-ecr</span></span>
<span id="cb22-82"><a href="#cb22-82" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> aws-actions/amazon-ecr-login@v1</span></span>
<span id="cb22-83"><a href="#cb22-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-84"><a href="#cb22-84" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Build and tag Docker image</span></span>
<span id="cb22-85"><a href="#cb22-85" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">working-directory</span><span class="kw">:</span><span class="at"> backend/core</span></span>
<span id="cb22-86"><a href="#cb22-86" aria-hidden="true" tabindex="-1"></a><span class="fu">      run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb22-87"><a href="#cb22-87" aria-hidden="true" tabindex="-1"></a>        ./mvnw clean package -DskipTests</span>
<span id="cb22-88"><a href="#cb22-88" aria-hidden="true" tabindex="-1"></a>        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$GITHUB_SHA .</span>
<span id="cb22-89"><a href="#cb22-89" aria-hidden="true" tabindex="-1"></a>        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$GITHUB_SHA $ECR_REGISTRY/$ECR_REPOSITORY:latest</span>
<span id="cb22-90"><a href="#cb22-90" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb22-91"><a href="#cb22-91" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">ECR_REGISTRY</span><span class="kw">:</span><span class="at"> ${{ steps.login-ecr.outputs.registry }}</span></span>
<span id="cb22-92"><a href="#cb22-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-93"><a href="#cb22-93" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Push image to Amazon ECR</span></span>
<span id="cb22-94"><a href="#cb22-94" aria-hidden="true" tabindex="-1"></a><span class="fu">      run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb22-95"><a href="#cb22-95" aria-hidden="true" tabindex="-1"></a>        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$GITHUB_SHA</span>
<span id="cb22-96"><a href="#cb22-96" aria-hidden="true" tabindex="-1"></a>        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest</span>
<span id="cb22-97"><a href="#cb22-97" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb22-98"><a href="#cb22-98" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">ECR_REGISTRY</span><span class="kw">:</span><span class="at"> ${{ steps.login-ecr.outputs.registry }}</span></span>
<span id="cb22-99"><a href="#cb22-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-100"><a href="#cb22-100" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Deploy to Amazon ECS</span></span>
<span id="cb22-101"><a href="#cb22-101" aria-hidden="true" tabindex="-1"></a><span class="fu">      run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb22-102"><a href="#cb22-102" aria-hidden="true" tabindex="-1"></a>        # Get current task definition</span>
<span id="cb22-103"><a href="#cb22-103" aria-hidden="true" tabindex="-1"></a>        TASK_DEFINITION=$(aws ecs describe-task-definition --task-definition careconnect-backend --query &#39;taskDefinition&#39;)</span>
<span id="cb22-104"><a href="#cb22-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-105"><a href="#cb22-105" aria-hidden="true" tabindex="-1"></a>        # Create new task definition with new image</span>
<span id="cb22-106"><a href="#cb22-106" aria-hidden="true" tabindex="-1"></a>        NEW_TASK_DEFINITION=$(echo $TASK_DEFINITION | jq --arg IMAGE &quot;$ECR_REGISTRY/$ECR_REPOSITORY:$GITHUB_SHA&quot; &#39;.containerDefinitions[0].image = $IMAGE&#39; | jq &#39;del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .placementConstraints, .compatibilities, .registeredAt, .registeredBy)&#39;)</span>
<span id="cb22-107"><a href="#cb22-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-108"><a href="#cb22-108" aria-hidden="true" tabindex="-1"></a>        # Register new task definition</span>
<span id="cb22-109"><a href="#cb22-109" aria-hidden="true" tabindex="-1"></a>        NEW_TASK_DEF_ARN=$(echo $NEW_TASK_DEFINITION | aws ecs register-task-definition --cli-input-json file:///dev/stdin --query &#39;taskDefinition.taskDefinitionArn&#39; --output text)</span>
<span id="cb22-110"><a href="#cb22-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-111"><a href="#cb22-111" aria-hidden="true" tabindex="-1"></a>        # Update service</span>
<span id="cb22-112"><a href="#cb22-112" aria-hidden="true" tabindex="-1"></a>        aws ecs update-service --cluster $ECS_CLUSTER --service $ECS_SERVICE --task-definition $NEW_TASK_DEF_ARN</span>
<span id="cb22-113"><a href="#cb22-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-114"><a href="#cb22-114" aria-hidden="true" tabindex="-1"></a>        # Wait for deployment</span>
<span id="cb22-115"><a href="#cb22-115" aria-hidden="true" tabindex="-1"></a>        aws ecs wait services-stable --cluster $ECS_CLUSTER --services $ECS_SERVICE</span>
<span id="cb22-116"><a href="#cb22-116" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb22-117"><a href="#cb22-117" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">ECR_REGISTRY</span><span class="kw">:</span><span class="at"> ${{ steps.login-ecr.outputs.registry }}</span></span>
<span id="cb22-118"><a href="#cb22-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-119"><a href="#cb22-119" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">build-and-deploy-frontend</span><span class="kw">:</span></span>
<span id="cb22-120"><a href="#cb22-120" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">needs</span><span class="kw">:</span><span class="at"> test</span></span>
<span id="cb22-121"><a href="#cb22-121" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb22-122"><a href="#cb22-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-123"><a href="#cb22-123" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb22-124"><a href="#cb22-124" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Checkout code</span></span>
<span id="cb22-125"><a href="#cb22-125" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v4</span></span>
<span id="cb22-126"><a href="#cb22-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-127"><a href="#cb22-127" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Set up Flutter</span></span>
<span id="cb22-128"><a href="#cb22-128" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> subosito/flutter-action@v2</span></span>
<span id="cb22-129"><a href="#cb22-129" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb22-130"><a href="#cb22-130" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">flutter-version</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;3.9.2&#39;</span></span>
<span id="cb22-131"><a href="#cb22-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-132"><a href="#cb22-132" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Build web app</span></span>
<span id="cb22-133"><a href="#cb22-133" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">working-directory</span><span class="kw">:</span><span class="at"> frontend</span></span>
<span id="cb22-134"><a href="#cb22-134" aria-hidden="true" tabindex="-1"></a><span class="fu">      run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb22-135"><a href="#cb22-135" aria-hidden="true" tabindex="-1"></a>        flutter pub get</span>
<span id="cb22-136"><a href="#cb22-136" aria-hidden="true" tabindex="-1"></a>        flutter build web --release</span>
<span id="cb22-137"><a href="#cb22-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-138"><a href="#cb22-138" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Configure AWS credentials</span></span>
<span id="cb22-139"><a href="#cb22-139" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> aws-actions/configure-aws-credentials@v3</span></span>
<span id="cb22-140"><a href="#cb22-140" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb22-141"><a href="#cb22-141" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">aws-access-key-id</span><span class="kw">:</span><span class="at"> ${{ secrets.AWS_ACCESS_KEY_ID }}</span></span>
<span id="cb22-142"><a href="#cb22-142" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">aws-secret-access-key</span><span class="kw">:</span><span class="at"> ${{ secrets.AWS_SECRET_ACCESS_KEY }}</span></span>
<span id="cb22-143"><a href="#cb22-143" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">aws-region</span><span class="kw">:</span><span class="at"> ${{ env.AWS_REGION }}</span></span>
<span id="cb22-144"><a href="#cb22-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-145"><a href="#cb22-145" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Deploy to S3</span></span>
<span id="cb22-146"><a href="#cb22-146" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">working-directory</span><span class="kw">:</span><span class="at"> frontend</span></span>
<span id="cb22-147"><a href="#cb22-147" aria-hidden="true" tabindex="-1"></a><span class="fu">      run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb22-148"><a href="#cb22-148" aria-hidden="true" tabindex="-1"></a>        aws s3 sync build/web s3://careconnect-prod-frontend --delete</span>
<span id="cb22-149"><a href="#cb22-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-150"><a href="#cb22-150" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Invalidate CloudFront</span></span>
<span id="cb22-151"><a href="#cb22-151" aria-hidden="true" tabindex="-1"></a><span class="fu">      run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb22-152"><a href="#cb22-152" aria-hidden="true" tabindex="-1"></a>        DISTRIBUTION_ID=$(aws cloudfront list-distributions --query &quot;DistributionList.Items[?contains(Aliases.Items, &#39;careconnect.example.com&#39;)].Id&quot; --output text)</span>
<span id="cb22-153"><a href="#cb22-153" aria-hidden="true" tabindex="-1"></a>        aws cloudfront create-invalidation --distribution-id $DISTRIBUTION_ID --paths &quot;/*&quot;</span>
<span id="cb22-154"><a href="#cb22-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-155"><a href="#cb22-155" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">run-migrations</span><span class="kw">:</span></span>
<span id="cb22-156"><a href="#cb22-156" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">needs</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">build-and-deploy-backend</span><span class="kw">]</span></span>
<span id="cb22-157"><a href="#cb22-157" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb22-158"><a href="#cb22-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-159"><a href="#cb22-159" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb22-160"><a href="#cb22-160" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Checkout code</span></span>
<span id="cb22-161"><a href="#cb22-161" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v4</span></span>
<span id="cb22-162"><a href="#cb22-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-163"><a href="#cb22-163" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Set up JDK 17</span></span>
<span id="cb22-164"><a href="#cb22-164" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/setup-java@v3</span></span>
<span id="cb22-165"><a href="#cb22-165" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb22-166"><a href="#cb22-166" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">java-version</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;17&#39;</span></span>
<span id="cb22-167"><a href="#cb22-167" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">distribution</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;adopt&#39;</span></span>
<span id="cb22-168"><a href="#cb22-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-169"><a href="#cb22-169" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Configure AWS credentials</span></span>
<span id="cb22-170"><a href="#cb22-170" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> aws-actions/configure-aws-credentials@v3</span></span>
<span id="cb22-171"><a href="#cb22-171" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb22-172"><a href="#cb22-172" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">aws-access-key-id</span><span class="kw">:</span><span class="at"> ${{ secrets.AWS_ACCESS_KEY_ID }}</span></span>
<span id="cb22-173"><a href="#cb22-173" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">aws-secret-access-key</span><span class="kw">:</span><span class="at"> ${{ secrets.AWS_SECRET_ACCESS_KEY }}</span></span>
<span id="cb22-174"><a href="#cb22-174" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">aws-region</span><span class="kw">:</span><span class="at"> ${{ env.AWS_REGION }}</span></span>
<span id="cb22-175"><a href="#cb22-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-176"><a href="#cb22-176" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run database migrations</span></span>
<span id="cb22-177"><a href="#cb22-177" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">working-directory</span><span class="kw">:</span><span class="at"> backend/core</span></span>
<span id="cb22-178"><a href="#cb22-178" aria-hidden="true" tabindex="-1"></a><span class="fu">      run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb22-179"><a href="#cb22-179" aria-hidden="true" tabindex="-1"></a>        # Get database credentials from Secrets Manager</span>
<span id="cb22-180"><a href="#cb22-180" aria-hidden="true" tabindex="-1"></a>        DB_PASSWORD=$(aws secretsmanager get-secret-value --secret-id careconnect/prod/db-password --query SecretString --output text)</span>
<span id="cb22-181"><a href="#cb22-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-182"><a href="#cb22-182" aria-hidden="true" tabindex="-1"></a>        ./mvnw flyway:migrate \</span>
<span id="cb22-183"><a href="#cb22-183" aria-hidden="true" tabindex="-1"></a>          -Dflyway.url=jdbc:postgresql://prod-db.region.rds.amazonaws.com:5432/careconnect \</span>
<span id="cb22-184"><a href="#cb22-184" aria-hidden="true" tabindex="-1"></a>          -Dflyway.user=careconnect_app \</span>
<span id="cb22-185"><a href="#cb22-185" aria-hidden="true" tabindex="-1"></a>          -Dflyway.password=$DB_PASSWORD</span>
<span id="cb22-186"><a href="#cb22-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-187"><a href="#cb22-187" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">smoke-tests</span><span class="kw">:</span></span>
<span id="cb22-188"><a href="#cb22-188" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">needs</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">build-and-deploy-backend</span><span class="kw">,</span><span class="at"> build-and-deploy-frontend</span><span class="kw">,</span><span class="at"> run-migrations</span><span class="kw">]</span></span>
<span id="cb22-189"><a href="#cb22-189" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb22-190"><a href="#cb22-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-191"><a href="#cb22-191" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb22-192"><a href="#cb22-192" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Health check API</span></span>
<span id="cb22-193"><a href="#cb22-193" aria-hidden="true" tabindex="-1"></a><span class="fu">      run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb22-194"><a href="#cb22-194" aria-hidden="true" tabindex="-1"></a>        curl -f https://api.careconnect.example.com/actuator/health</span>
<span id="cb22-195"><a href="#cb22-195" aria-hidden="true" tabindex="-1"></a>        curl -f https://api.careconnect.example.com/actuator/info</span>
<span id="cb22-196"><a href="#cb22-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-197"><a href="#cb22-197" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Health check frontend</span></span>
<span id="cb22-198"><a href="#cb22-198" aria-hidden="true" tabindex="-1"></a><span class="fu">      run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb22-199"><a href="#cb22-199" aria-hidden="true" tabindex="-1"></a>        curl -f https://careconnect.example.com</span>
<span id="cb22-200"><a href="#cb22-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-201"><a href="#cb22-201" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run API tests</span></span>
<span id="cb22-202"><a href="#cb22-202" aria-hidden="true" tabindex="-1"></a><span class="fu">      run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb22-203"><a href="#cb22-203" aria-hidden="true" tabindex="-1"></a>        # Run basic API tests</span>
<span id="cb22-204"><a href="#cb22-204" aria-hidden="true" tabindex="-1"></a>        curl -X POST https://api.careconnect.example.com/api/auth/login \</span>
<span id="cb22-205"><a href="#cb22-205" aria-hidden="true" tabindex="-1"></a>          -H &quot;Content-Type: application/json&quot; \</span>
<span id="cb22-206"><a href="#cb22-206" aria-hidden="true" tabindex="-1"></a>          -d &#39;{&quot;email&quot;:&quot;test@example.com&quot;,&quot;password&quot;:&quot;invalid&quot;}&#39; \</span>
<span id="cb22-207"><a href="#cb22-207" aria-hidden="true" tabindex="-1"></a>          | grep -q &quot;Invalid credentials&quot;</span>
<span id="cb22-208"><a href="#cb22-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-209"><a href="#cb22-209" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">notify</span><span class="kw">:</span></span>
<span id="cb22-210"><a href="#cb22-210" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">needs</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">build-and-deploy-backend</span><span class="kw">,</span><span class="at"> build-and-deploy-frontend</span><span class="kw">,</span><span class="at"> run-migrations</span><span class="kw">,</span><span class="at"> smoke-tests</span><span class="kw">]</span></span>
<span id="cb22-211"><a href="#cb22-211" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb22-212"><a href="#cb22-212" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">if</span><span class="kw">:</span><span class="at"> always()</span></span>
<span id="cb22-213"><a href="#cb22-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-214"><a href="#cb22-214" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb22-215"><a href="#cb22-215" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Notify success</span></span>
<span id="cb22-216"><a href="#cb22-216" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">if</span><span class="kw">:</span><span class="at"> ${{ success() }}</span></span>
<span id="cb22-217"><a href="#cb22-217" aria-hidden="true" tabindex="-1"></a><span class="fu">      run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb22-218"><a href="#cb22-218" aria-hidden="true" tabindex="-1"></a>        curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \</span>
<span id="cb22-219"><a href="#cb22-219" aria-hidden="true" tabindex="-1"></a>          -H &#39;Content-type: application/json&#39; \</span>
<span id="cb22-220"><a href="#cb22-220" aria-hidden="true" tabindex="-1"></a>          --data &#39;{&quot;text&quot;:&quot;✅ Production deployment successful!&quot;}&#39;</span>
<span id="cb22-221"><a href="#cb22-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-222"><a href="#cb22-222" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Notify failure</span></span>
<span id="cb22-223"><a href="#cb22-223" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">if</span><span class="kw">:</span><span class="at"> ${{ failure() }}</span></span>
<span id="cb22-224"><a href="#cb22-224" aria-hidden="true" tabindex="-1"></a><span class="fu">      run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb22-225"><a href="#cb22-225" aria-hidden="true" tabindex="-1"></a>        curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \</span>
<span id="cb22-226"><a href="#cb22-226" aria-hidden="true" tabindex="-1"></a>          -H &#39;Content-type: application/json&#39; \</span>
<span id="cb22-227"><a href="#cb22-227" aria-hidden="true" tabindex="-1"></a>          --data &#39;{&quot;text&quot;:&quot;❌ Production deployment failed!&quot;}&#39;</span></code></pre></div>
<h3 id="rollback-strategy">Rollback Strategy</h3>
<div class="sourceCode" id="cb23"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># scripts/rollback.sh</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="at">-e</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="va">CLUSTER_NAME</span><span class="op">=</span><span class="st">&quot;careconnect-prod&quot;</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="va">SERVICE_NAME</span><span class="op">=</span><span class="st">&quot;careconnect-prod-service&quot;</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Starting rollback process...&quot;</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Get current and previous task definitions</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="va">CURRENT_TASK_DEF</span><span class="op">=</span><span class="va">$(</span><span class="ex">aws</span> ecs describe-services <span class="dt">\</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">--cluster</span> <span class="va">$CLUSTER_NAME</span> <span class="dt">\</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">--services</span> <span class="va">$SERVICE_NAME</span> <span class="dt">\</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">--query</span> <span class="st">&#39;services[0].taskDefinition&#39;</span> <span class="dt">\</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">--output</span> text<span class="va">)</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Current task definition: </span><span class="va">$CURRENT_TASK_DEF</span><span class="st">&quot;</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract revision number</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="va">CURRENT_REVISION</span><span class="op">=</span><span class="va">$(</span><span class="bu">echo</span> <span class="va">$CURRENT_TASK_DEF</span> <span class="kw">|</span> <span class="fu">grep</span> <span class="at">-o</span> <span class="st">&#39;[0-9]*$&#39;</span><span class="va">)</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a><span class="va">PREVIOUS_REVISION</span><span class="op">=</span><span class="va">$((CURRENT_REVISION</span> <span class="op">-</span> <span class="dv">1</span><span class="va">))</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="va">$PREVIOUS_REVISION</span> <span class="ot">-lt</span> 1 <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;Cannot rollback: no previous revision available&quot;</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">exit</span> 1</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a><span class="va">PREVIOUS_TASK_DEF</span><span class="op">=</span><span class="va">$(</span><span class="bu">echo</span> <span class="va">$CURRENT_TASK_DEF</span> <span class="kw">|</span> <span class="fu">sed</span> <span class="st">&quot;s/:</span><span class="va">$CURRENT_REVISION</span><span class="st">/:</span><span class="va">$PREVIOUS_REVISION</span><span class="st">/&quot;</span><span class="va">)</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Rolling back to: </span><span class="va">$PREVIOUS_TASK_DEF</span><span class="st">&quot;</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Update service with previous task definition</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ecs update-service <span class="dt">\</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">--cluster</span> <span class="va">$CLUSTER_NAME</span> <span class="dt">\</span></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">--service</span> <span class="va">$SERVICE_NAME</span> <span class="dt">\</span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">--task-definition</span> <span class="va">$PREVIOUS_TASK_DEF</span></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Wait for rollback to complete</span></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Waiting for rollback to complete...&quot;</span></span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ecs wait services-stable <span class="dt">\</span></span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">--cluster</span> <span class="va">$CLUSTER_NAME</span> <span class="dt">\</span></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">--services</span> <span class="va">$SERVICE_NAME</span></span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Health check</span></span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Performing health check...&quot;</span></span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a><span class="fu">sleep</span> 30  <span class="co"># Wait for service to fully start</span></span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a><span class="va">HEALTH_CHECK_URL</span><span class="op">=</span><span class="st">&quot;https://api.careconnect.example.com/actuator/health&quot;</span></span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="dt">{</span><span class="dv">1</span><span class="dt">..</span><span class="dv">5</span><span class="dt">}</span><span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="ex">curl</span> <span class="at">-f</span> <span class="va">$HEALTH_CHECK_URL</span> <span class="op">&gt;</span> /dev/null <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>        <span class="bu">echo</span> <span class="st">&quot;Rollback successful - health check passed&quot;</span></span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>        <span class="bu">exit</span> 0</span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>        <span class="bu">echo</span> <span class="st">&quot;Health check failed, attempt </span><span class="va">$i</span><span class="st">/5&quot;</span></span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sleep</span> 30</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">fi</span></span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Rollback failed - health check did not pass&quot;</span></span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a><span class="bu">exit</span> 1</span></code></pre></div>
<h2 id="monitoring-and-logging">Monitoring and Logging</h2>
<h3 id="cloudwatch-dashboard">CloudWatch Dashboard</h3>
<div class="sourceCode" id="cb24"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;widgets&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;metric&quot;</span><span class="fu">,</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;properties&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;metrics&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>          <span class="ot">[</span><span class="st">&quot;AWS/ECS&quot;</span><span class="ot">,</span> <span class="st">&quot;CPUUtilization&quot;</span><span class="ot">,</span> <span class="st">&quot;ServiceName&quot;</span><span class="ot">,</span> <span class="st">&quot;careconnect-prod-service&quot;</span><span class="ot">,</span> <span class="st">&quot;ClusterName&quot;</span><span class="ot">,</span> <span class="st">&quot;careconnect-prod&quot;</span><span class="ot">],</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>          <span class="ot">[</span><span class="st">&quot;.&quot;</span><span class="ot">,</span> <span class="st">&quot;MemoryUtilization&quot;</span><span class="ot">,</span> <span class="st">&quot;.&quot;</span><span class="ot">,</span> <span class="st">&quot;.&quot;</span><span class="ot">,</span> <span class="st">&quot;.&quot;</span><span class="ot">,</span> <span class="st">&quot;.&quot;</span><span class="ot">]</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>        <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;period&quot;</span><span class="fu">:</span> <span class="dv">300</span><span class="fu">,</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;stat&quot;</span><span class="fu">:</span> <span class="st">&quot;Average&quot;</span><span class="fu">,</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;region&quot;</span><span class="fu">:</span> <span class="st">&quot;us-east-1&quot;</span><span class="fu">,</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;ECS Service Metrics&quot;</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;metric&quot;</span><span class="fu">,</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;properties&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;metrics&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>          <span class="ot">[</span><span class="st">&quot;AWS/RDS&quot;</span><span class="ot">,</span> <span class="st">&quot;CPUUtilization&quot;</span><span class="ot">,</span> <span class="st">&quot;DBInstanceIdentifier&quot;</span><span class="ot">,</span> <span class="st">&quot;careconnect-prod-db&quot;</span><span class="ot">],</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>          <span class="ot">[</span><span class="st">&quot;.&quot;</span><span class="ot">,</span> <span class="st">&quot;DatabaseConnections&quot;</span><span class="ot">,</span> <span class="st">&quot;.&quot;</span><span class="ot">,</span> <span class="st">&quot;.&quot;</span><span class="ot">],</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>          <span class="ot">[</span><span class="st">&quot;.&quot;</span><span class="ot">,</span> <span class="st">&quot;ReadLatency&quot;</span><span class="ot">,</span> <span class="st">&quot;.&quot;</span><span class="ot">,</span> <span class="st">&quot;.&quot;</span><span class="ot">],</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>          <span class="ot">[</span><span class="st">&quot;.&quot;</span><span class="ot">,</span> <span class="st">&quot;WriteLatency&quot;</span><span class="ot">,</span> <span class="st">&quot;.&quot;</span><span class="ot">,</span> <span class="st">&quot;.&quot;</span><span class="ot">]</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>        <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;period&quot;</span><span class="fu">:</span> <span class="dv">300</span><span class="fu">,</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;stat&quot;</span><span class="fu">:</span> <span class="st">&quot;Average&quot;</span><span class="fu">,</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;region&quot;</span><span class="fu">:</span> <span class="st">&quot;us-east-1&quot;</span><span class="fu">,</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;RDS Metrics&quot;</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;metric&quot;</span><span class="fu">,</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;properties&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;metrics&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>          <span class="ot">[</span><span class="st">&quot;AWS/ApplicationELB&quot;</span><span class="ot">,</span> <span class="st">&quot;RequestCount&quot;</span><span class="ot">,</span> <span class="st">&quot;LoadBalancer&quot;</span><span class="ot">,</span> <span class="st">&quot;careconnect-prod-alb&quot;</span><span class="ot">],</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>          <span class="ot">[</span><span class="st">&quot;.&quot;</span><span class="ot">,</span> <span class="st">&quot;TargetResponseTime&quot;</span><span class="ot">,</span> <span class="st">&quot;.&quot;</span><span class="ot">,</span> <span class="st">&quot;.&quot;</span><span class="ot">],</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>          <span class="ot">[</span><span class="st">&quot;.&quot;</span><span class="ot">,</span> <span class="st">&quot;HTTPCode_Target_2XX_Count&quot;</span><span class="ot">,</span> <span class="st">&quot;.&quot;</span><span class="ot">,</span> <span class="st">&quot;.&quot;</span><span class="ot">],</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>          <span class="ot">[</span><span class="st">&quot;.&quot;</span><span class="ot">,</span> <span class="st">&quot;HTTPCode_Target_4XX_Count&quot;</span><span class="ot">,</span> <span class="st">&quot;.&quot;</span><span class="ot">,</span> <span class="st">&quot;.&quot;</span><span class="ot">],</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>          <span class="ot">[</span><span class="st">&quot;.&quot;</span><span class="ot">,</span> <span class="st">&quot;HTTPCode_Target_5XX_Count&quot;</span><span class="ot">,</span> <span class="st">&quot;.&quot;</span><span class="ot">,</span> <span class="st">&quot;.&quot;</span><span class="ot">]</span></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>        <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;period&quot;</span><span class="fu">:</span> <span class="dv">300</span><span class="fu">,</span></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;stat&quot;</span><span class="fu">:</span> <span class="st">&quot;Sum&quot;</span><span class="fu">,</span></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;region&quot;</span><span class="fu">:</span> <span class="st">&quot;us-east-1&quot;</span><span class="fu">,</span></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;Load Balancer Metrics&quot;</span></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h3 id="application-metrics">Application Metrics</h3>
<div class="sourceCode" id="cb25"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">// config/MetricsConfig.java</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Configuration</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> MetricsConfig <span class="op">{</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> MeterRegistry <span class="fu">meterRegistry</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">CloudWatchMeterRegistry</span><span class="op">(</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>            CloudWatchConfig<span class="op">.</span><span class="fu">DEFAULT</span><span class="op">,</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>            Clock<span class="op">.</span><span class="fu">SYSTEM</span><span class="op">,</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>            CloudWatchAsyncClient<span class="op">.</span><span class="fu">create</span><span class="op">()</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">@ConditionalOnMissingBean</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> TimedAspect <span class="fu">timedAspect</span><span class="op">(</span>MeterRegistry registry<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">TimedAspect</span><span class="op">(</span>registry<span class="op">);</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="co">// Custom metrics in service classes</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> HealthService <span class="op">{</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> Counter vitalSignsRecorded<span class="op">;</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> <span class="bu">Timer</span> apiResponseTime<span class="op">;</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> Gauge activeUsers<span class="op">;</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">HealthService</span><span class="op">(</span>MeterRegistry meterRegistry<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">vitalSignsRecorded</span> <span class="op">=</span> Counter<span class="op">.</span><span class="fu">builder</span><span class="op">(</span><span class="st">&quot;careconnect.vitalsigns.recorded&quot;</span><span class="op">)</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">description</span><span class="op">(</span><span class="st">&quot;Number of vital signs recorded&quot;</span><span class="op">)</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">register</span><span class="op">(</span>meterRegistry<span class="op">);</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">apiResponseTime</span> <span class="op">=</span> <span class="bu">Timer</span><span class="op">.</span><span class="fu">builder</span><span class="op">(</span><span class="st">&quot;careconnect.api.response.time&quot;</span><span class="op">)</span></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">description</span><span class="op">(</span><span class="st">&quot;API response time&quot;</span><span class="op">)</span></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">register</span><span class="op">(</span>meterRegistry<span class="op">);</span></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">activeUsers</span> <span class="op">=</span> Gauge<span class="op">.</span><span class="fu">builder</span><span class="op">(</span><span class="st">&quot;careconnect.users.active&quot;</span><span class="op">)</span></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">description</span><span class="op">(</span><span class="st">&quot;Number of active users&quot;</span><span class="op">)</span></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">register</span><span class="op">(</span>meterRegistry<span class="op">,</span> <span class="kw">this</span><span class="op">,</span> HealthService<span class="op">::</span>getActiveUserCount<span class="op">);</span></span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Timed</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;careconnect.vitalsigns.record&quot;</span><span class="op">,</span> description <span class="op">=</span> <span class="st">&quot;Time to record vital sign&quot;</span><span class="op">)</span></span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> VitalSign <span class="fu">recordVitalSign</span><span class="op">(</span>VitalSignRequest request<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Implementation</span></span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>        vitalSignsRecorded<span class="op">.</span><span class="fu">increment</span><span class="op">();</span></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> vitalSign<span class="op">;</span></span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">int</span> <span class="fu">getActiveUserCount</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Implementation to count active users</span></span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="alerting-configuration">Alerting Configuration</h3>
<div class="sourceCode" id="cb26"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># cloudwatch-alarms.yml (for Terraform or CloudFormation)</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">HighCPUUtilization</span><span class="kw">:</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">Type</span><span class="kw">:</span><span class="at"> AWS::CloudWatch::Alarm</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">Properties</span><span class="kw">:</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">AlarmDescription</span><span class="kw">:</span><span class="at"> High CPU utilization on ECS service</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">MetricName</span><span class="kw">:</span><span class="at"> CPUUtilization</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">Namespace</span><span class="kw">:</span><span class="at"> AWS/ECS</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">Statistic</span><span class="kw">:</span><span class="at"> Average</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">Period</span><span class="kw">:</span><span class="at"> </span><span class="dv">300</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">EvaluationPeriods</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">Threshold</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ComparisonOperator</span><span class="kw">:</span><span class="at"> GreaterThanThreshold</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">Dimensions</span><span class="kw">:</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">Name</span><span class="kw">:</span><span class="at"> ServiceName</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">Value</span><span class="kw">:</span><span class="at"> careconnect-prod-service</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">Name</span><span class="kw">:</span><span class="at"> ClusterName</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">Value</span><span class="kw">:</span><span class="at"> careconnect-prod</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">AlarmActions</span><span class="kw">:</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> !Ref SNSTopic</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a><span class="fu">HighMemoryUtilization</span><span class="kw">:</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">Type</span><span class="kw">:</span><span class="at"> AWS::CloudWatch::Alarm</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">Properties</span><span class="kw">:</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">AlarmDescription</span><span class="kw">:</span><span class="at"> High memory utilization on ECS service</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">MetricName</span><span class="kw">:</span><span class="at"> MemoryUtilization</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">Namespace</span><span class="kw">:</span><span class="at"> AWS/ECS</span></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">Statistic</span><span class="kw">:</span><span class="at"> Average</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">Period</span><span class="kw">:</span><span class="at"> </span><span class="dv">300</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">EvaluationPeriods</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">Threshold</span><span class="kw">:</span><span class="at"> </span><span class="dv">85</span></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ComparisonOperator</span><span class="kw">:</span><span class="at"> GreaterThanThreshold</span></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">Dimensions</span><span class="kw">:</span></span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">Name</span><span class="kw">:</span><span class="at"> ServiceName</span></span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">Value</span><span class="kw">:</span><span class="at"> careconnect-prod-service</span></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">Name</span><span class="kw">:</span><span class="at"> ClusterName</span></span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">Value</span><span class="kw">:</span><span class="at"> careconnect-prod</span></span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">AlarmActions</span><span class="kw">:</span></span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> !Ref SNSTopic</span></span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a><span class="fu">DatabaseConnectionsHigh</span><span class="kw">:</span></span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">Type</span><span class="kw">:</span><span class="at"> AWS::CloudWatch::Alarm</span></span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">Properties</span><span class="kw">:</span></span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">AlarmDescription</span><span class="kw">:</span><span class="at"> High database connections</span></span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">MetricName</span><span class="kw">:</span><span class="at"> DatabaseConnections</span></span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">Namespace</span><span class="kw">:</span><span class="at"> AWS/RDS</span></span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">Statistic</span><span class="kw">:</span><span class="at"> Average</span></span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">Period</span><span class="kw">:</span><span class="at"> </span><span class="dv">300</span></span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">EvaluationPeriods</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">Threshold</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ComparisonOperator</span><span class="kw">:</span><span class="at"> GreaterThanThreshold</span></span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">Dimensions</span><span class="kw">:</span></span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">Name</span><span class="kw">:</span><span class="at"> DBInstanceIdentifier</span></span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">Value</span><span class="kw">:</span><span class="at"> careconnect-prod-db</span></span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">AlarmActions</span><span class="kw">:</span></span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> !Ref SNSTopic</span></span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a><span class="fu">APIErrorRate</span><span class="kw">:</span></span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">Type</span><span class="kw">:</span><span class="at"> AWS::CloudWatch::Alarm</span></span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">Properties</span><span class="kw">:</span></span>
<span id="cb26-60"><a href="#cb26-60" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">AlarmDescription</span><span class="kw">:</span><span class="at"> High API error rate</span></span>
<span id="cb26-61"><a href="#cb26-61" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">MetricName</span><span class="kw">:</span><span class="at"> HTTPCode_Target_5XX_Count</span></span>
<span id="cb26-62"><a href="#cb26-62" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">Namespace</span><span class="kw">:</span><span class="at"> AWS/ApplicationELB</span></span>
<span id="cb26-63"><a href="#cb26-63" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">Statistic</span><span class="kw">:</span><span class="at"> Sum</span></span>
<span id="cb26-64"><a href="#cb26-64" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">Period</span><span class="kw">:</span><span class="at"> </span><span class="dv">300</span></span>
<span id="cb26-65"><a href="#cb26-65" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">EvaluationPeriods</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb26-66"><a href="#cb26-66" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">Threshold</span><span class="kw">:</span><span class="at"> </span><span class="dv">10</span></span>
<span id="cb26-67"><a href="#cb26-67" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ComparisonOperator</span><span class="kw">:</span><span class="at"> GreaterThanThreshold</span></span>
<span id="cb26-68"><a href="#cb26-68" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">Dimensions</span><span class="kw">:</span></span>
<span id="cb26-69"><a href="#cb26-69" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">Name</span><span class="kw">:</span><span class="at"> LoadBalancer</span></span>
<span id="cb26-70"><a href="#cb26-70" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">Value</span><span class="kw">:</span><span class="at"> careconnect-prod-alb</span></span>
<span id="cb26-71"><a href="#cb26-71" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">AlarmActions</span><span class="kw">:</span></span>
<span id="cb26-72"><a href="#cb26-72" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> !Ref SNSTopic</span></span></code></pre></div>
<h3 id="log-aggregation">Log Aggregation</h3>
<div class="sourceCode" id="cb27"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># cloudwatch-logs.yml</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">version</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;3&#39;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="fu">x-logging</span><span class="kw">:</span><span class="at"> </span><span class="ot">&amp;default-logging</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">driver</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;awslogs&quot;</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">options</span><span class="kw">:</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">awslogs-group</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;/ecs/careconnect-prod&quot;</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">awslogs-region</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;us-east-1&quot;</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">awslogs-stream-prefix</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;ecs&quot;</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">backend</span><span class="kw">:</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">logging</span><span class="kw">:</span><span class="at"> </span><span class="ot">*default-logging</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> LOGGING_LEVEL_ROOT=INFO</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> LOGGING_LEVEL_COM_CARECONNECT=DEBUG</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> LOGGING_PATTERN_CONSOLE=%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> LOGGING_PATTERN_FILE=%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</span></span></code></pre></div>
<h2 id="security-and-compliance">Security and Compliance</h2>
<h3 id="security-hardening">Security Hardening</h3>
<h4 id="network-security">Network Security</h4>
<pre class="hcl"><code># Security Groups
resource &quot;aws_security_group&quot; &quot;alb&quot; {
  name_prefix = &quot;${var.environment}-alb-&quot;
  vpc_id      = var.vpc_id

  ingress {
    from_port   = 80
    to_port     = 80
    protocol    = &quot;tcp&quot;
    cidr_blocks = [&quot;0.0.0.0/0&quot;]
  }

  ingress {
    from_port   = 443
    to_port     = 443
    protocol    = &quot;tcp&quot;
    cidr_blocks = [&quot;0.0.0.0/0&quot;]
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = &quot;-1&quot;
    cidr_blocks = [&quot;0.0.0.0/0&quot;]
  }

  tags = {
    Name = &quot;${var.environment}-alb-sg&quot;
  }
}

resource &quot;aws_security_group&quot; &quot;ecs&quot; {
  name_prefix = &quot;${var.environment}-ecs-&quot;
  vpc_id      = var.vpc_id

  ingress {
    from_port       = 8080
    to_port         = 8080
    protocol        = &quot;tcp&quot;
    security_groups = [aws_security_group.alb.id]
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = &quot;-1&quot;
    cidr_blocks = [&quot;0.0.0.0/0&quot;]
  }

  tags = {
    Name = &quot;${var.environment}-ecs-sg&quot;
  }
}

resource &quot;aws_security_group&quot; &quot;rds&quot; {
  name_prefix = &quot;${var.environment}-rds-&quot;
  vpc_id      = var.vpc_id

  ingress {
    from_port       = 5432
    to_port         = 5432
    protocol        = &quot;tcp&quot;
    security_groups = [aws_security_group.ecs.id]
  }

  tags = {
    Name = &quot;${var.environment}-rds-sg&quot;
  }
}</code></pre>
<h4 id="waf-configuration">WAF Configuration</h4>
<pre class="hcl"><code># Web Application Firewall
resource &quot;aws_wafv2_web_acl&quot; &quot;main&quot; {
  name  = &quot;careconnect-${var.environment}-waf&quot;
  scope = &quot;CLOUDFRONT&quot;

  default_action {
    allow {}
  }

  # Rate limiting rule
  rule {
    name     = &quot;RateLimitRule&quot;
    priority = 1

    action {
      block {}
    }

    statement {
      rate_based_statement {
        limit              = 10000
        aggregate_key_type = &quot;IP&quot;
      }
    }

    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = &quot;RateLimitRule&quot;
      sampled_requests_enabled   = true
    }
  }

  # SQL injection protection
  rule {
    name     = &quot;SQLInjectionRule&quot;
    priority = 2

    action {
      block {}
    }

    statement {
      sqli_match_statement {
        field_to_match {
          body {}
        }

        text_transformation {
          priority = 0
          type     = &quot;URL_DECODE&quot;
        }

        text_transformation {
          priority = 1
          type     = &quot;HTML_ENTITY_DECODE&quot;
        }
      }
    }

    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = &quot;SQLInjectionRule&quot;
      sampled_requests_enabled   = true
    }
  }

  # XSS protection
  rule {
    name     = &quot;XSSRule&quot;
    priority = 3

    action {
      block {}
    }

    statement {
      xss_match_statement {
        field_to_match {
          body {}
        }

        text_transformation {
          priority = 0
          type     = &quot;URL_DECODE&quot;
        }

        text_transformation {
          priority = 1
          type     = &quot;HTML_ENTITY_DECODE&quot;
        }
      }
    }

    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = &quot;XSSRule&quot;
      sampled_requests_enabled   = true
    }
  }

  visibility_config {
    cloudwatch_metrics_enabled = true
    metric_name                = &quot;careconnect-${var.environment}-waf&quot;
    sampled_requests_enabled   = true
  }

  tags = {
    Name = &quot;careconnect-${var.environment}-waf&quot;
  }
}</code></pre>
<h3 id="secrets-management">Secrets Management</h3>
<h4 id="aws-secrets-manager-configuration">AWS Secrets Manager
Configuration</h4>
<pre class="hcl"><code># Database password
resource &quot;aws_secretsmanager_secret&quot; &quot;db_password&quot; {
  name                    = &quot;careconnect/${var.environment}/db-password&quot;
  description             = &quot;Database password for CareConnect ${var.environment}&quot;
  recovery_window_in_days = var.environment == &quot;prod&quot; ? 30 : 0

  tags = {
    Name        = &quot;careconnect-${var.environment}-db-password&quot;
    Environment = var.environment
  }
}

resource &quot;aws_secretsmanager_secret_version&quot; &quot;db_password&quot; {
  secret_id     = aws_secretsmanager_secret.db_password.id
  secret_string = var.db_password
}

# JWT secret
resource &quot;aws_secretsmanager_secret&quot; &quot;jwt_secret&quot; {
  name                    = &quot;careconnect/${var.environment}/jwt-secret&quot;
  description             = &quot;JWT secret for CareConnect ${var.environment}&quot;
  recovery_window_in_days = var.environment == &quot;prod&quot; ? 30 : 0

  tags = {
    Name        = &quot;careconnect-${var.environment}-jwt-secret&quot;
    Environment = var.environment
  }
}

resource &quot;aws_secretsmanager_secret_version&quot; &quot;jwt_secret&quot; {
  secret_id     = aws_secretsmanager_secret.jwt_secret.id
  secret_string = var.jwt_secret
}

# API keys
resource &quot;aws_secretsmanager_secret&quot; &quot;api_keys&quot; {
  name                    = &quot;careconnect/${var.environment}/api-keys&quot;
  description             = &quot;API keys for CareConnect ${var.environment}&quot;
  recovery_window_in_days = var.environment == &quot;prod&quot; ? 30 : 0

  tags = {
    Name        = &quot;careconnect-${var.environment}-api-keys&quot;
    Environment = var.environment
  }
}

resource &quot;aws_secretsmanager_secret_version&quot; &quot;api_keys&quot; {
  secret_id = aws_secretsmanager_secret.api_keys.id
  secret_string = jsonencode({
    deepseek_api_key = var.deepseek_api_key
    openai_api_key   = var.openai_api_key
    stripe_secret_key = var.stripe_secret_key
  })
}</code></pre>
<h3 id="hipaa-compliance">HIPAA Compliance</h3>
<h4 id="encryption-configuration">Encryption Configuration</h4>
<div class="sourceCode" id="cb31"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># RDS Encryption</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">DBInstance</span><span class="kw">:</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">Type</span><span class="kw">:</span><span class="at"> AWS::RDS::DBInstance</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">Properties</span><span class="kw">:</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">StorageEncrypted</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">KmsKeyId</span><span class="kw">:</span><span class="at"> !Ref DatabaseKMSKey</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co"># S3 Bucket Encryption</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="fu">S3Bucket</span><span class="kw">:</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">Type</span><span class="kw">:</span><span class="at"> AWS::S3::Bucket</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">Properties</span><span class="kw">:</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">BucketEncryption</span><span class="kw">:</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">ServerSideEncryptionConfiguration</span><span class="kw">:</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">ServerSideEncryptionByDefault</span><span class="kw">:</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">SSEAlgorithm</span><span class="kw">:</span><span class="at"> aws:kms</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">KMSMasterKeyID</span><span class="kw">:</span><span class="at"> !Ref S3KMSKey</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="co"># ECS Task Definition - Encryption in transit</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="fu">TaskDefinition</span><span class="kw">:</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">Type</span><span class="kw">:</span><span class="at"> AWS::ECS::TaskDefinition</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">Properties</span><span class="kw">:</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ContainerDefinitions</span><span class="kw">:</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">Name</span><span class="kw">:</span><span class="at"> careconnect-backend</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">Environment</span><span class="kw">:</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">Name</span><span class="kw">:</span><span class="at"> SERVER_SSL_ENABLED</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">Value</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;true&quot;</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">Name</span><span class="kw">:</span><span class="at"> SERVER_SSL_KEY_STORE_TYPE</span></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">Value</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;PKCS12&quot;</span></span></code></pre></div>
<h4 id="audit-logging">Audit Logging</h4>
<div class="sourceCode" id="cb32"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Audit configuration</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Configuration</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="at">@EnableJpaAuditing</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> AuditConfig <span class="op">{</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> AuditorAware<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> <span class="fu">auditorProvider</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">SpringSecurityAuditorAware</span><span class="op">();</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Audit entity</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="at">@Entity</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="at">@Table</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;audit_logs&quot;</span><span class="op">)</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> AuditLog <span class="op">{</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Id</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GeneratedValue</span><span class="op">(</span>strategy <span class="op">=</span> GenerationType<span class="op">.</span><span class="fu">IDENTITY</span><span class="op">)</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Long</span> id<span class="op">;</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> userId<span class="op">;</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> action<span class="op">;</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> resource<span class="op">;</span></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>columnDefinition <span class="op">=</span> <span class="st">&quot;TEXT&quot;</span><span class="op">)</span></span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> details<span class="op">;</span></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> ipAddress<span class="op">;</span></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> userAgent<span class="op">;</span></span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">@CreationTimestamp</span></span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> LocalDateTime timestamp<span class="op">;</span></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Constructors, getters, setters</span></span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a><span class="co">// Audit service</span></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> AuditService <span class="op">{</span></span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> AuditLogRepository auditLogRepository<span class="op">;</span></span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Async</span></span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">logAction</span><span class="op">(</span><span class="bu">String</span> userId<span class="op">,</span> <span class="bu">String</span> action<span class="op">,</span> <span class="bu">String</span> resource<span class="op">,</span> <span class="bu">String</span> details<span class="op">)</span> <span class="op">{</span></span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a>        AuditLog auditLog <span class="op">=</span> <span class="kw">new</span> <span class="fu">AuditLog</span><span class="op">();</span></span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>        auditLog<span class="op">.</span><span class="fu">setUserId</span><span class="op">(</span>userId<span class="op">);</span></span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>        auditLog<span class="op">.</span><span class="fu">setAction</span><span class="op">(</span>action<span class="op">);</span></span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>        auditLog<span class="op">.</span><span class="fu">setResource</span><span class="op">(</span>resource<span class="op">);</span></span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>        auditLog<span class="op">.</span><span class="fu">setDetails</span><span class="op">(</span>details<span class="op">);</span></span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>        auditLog<span class="op">.</span><span class="fu">setIpAddress</span><span class="op">(</span><span class="fu">getCurrentUserIpAddress</span><span class="op">());</span></span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>        auditLog<span class="op">.</span><span class="fu">setUserAgent</span><span class="op">(</span><span class="fu">getCurrentUserAgent</span><span class="op">());</span></span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>        auditLogRepository<span class="op">.</span><span class="fu">save</span><span class="op">(</span>auditLog<span class="op">);</span></span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="backup-and-disaster-recovery">Backup and Disaster Recovery</h2>
<h3 id="backup-strategy">Backup Strategy</h3>
<h4 id="automated-rds-backups">Automated RDS Backups</h4>
<pre class="hcl"><code># RDS instance with automated backups
resource &quot;aws_db_instance&quot; &quot;main&quot; {
  # ... other configuration

  # Automated backups
  backup_retention_period = var.environment == &quot;prod&quot; ? 30 : 7
  backup_window          = &quot;03:00-04:00&quot;  # UTC
  copy_tags_to_snapshot  = true
  delete_automated_backups = false

  # Point-in-time recovery
  enabled_cloudwatch_logs_exports = [&quot;error&quot;, &quot;general&quot;, &quot;slow-query&quot;]

  # Final snapshot
  final_snapshot_identifier = &quot;${var.environment}-db-final-snapshot-${formatdate(&quot;YYYYMMDD-hhmm&quot;, timestamp())}&quot;
  skip_final_snapshot      = var.environment == &quot;dev&quot; ? true : false

  # Cross-region backup
  dynamic &quot;restore_to_point_in_time&quot; {
    for_each = var.environment == &quot;prod&quot; ? [1] : []
    content {
      restore_time = &quot;2023-01-01T00:00:00Z&quot;  # Example
    }
  }
}

# Cross-region snapshot copy
resource &quot;aws_db_snapshot_copy&quot; &quot;cross_region&quot; {
  count = var.environment == &quot;prod&quot; ? 1 : 0

  source_db_snapshot_identifier = aws_db_instance.main.latest_restorable_time
  target_db_snapshot_identifier = &quot;${var.environment}-cross-region-backup-${formatdate(&quot;YYYYMMDD&quot;, timestamp())}&quot;

  kms_key_id = var.kms_key_id

  tags = {
    Name        = &quot;${var.environment}-cross-region-backup&quot;
    Environment = var.environment
  }
}</code></pre>
<h4 id="s3-backup-configuration">S3 Backup Configuration</h4>
<pre class="hcl"><code># S3 bucket for backups
resource &quot;aws_s3_bucket&quot; &quot;backups&quot; {
  bucket = &quot;careconnect-${var.environment}-backups&quot;

  tags = {
    Name        = &quot;careconnect-${var.environment}-backups&quot;
    Environment = var.environment
  }
}

resource &quot;aws_s3_bucket_versioning&quot; &quot;backups&quot; {
  bucket = aws_s3_bucket.backups.id
  versioning_configuration {
    status = &quot;Enabled&quot;
  }
}

resource &quot;aws_s3_bucket_server_side_encryption_configuration&quot; &quot;backups&quot; {
  bucket = aws_s3_bucket.backups.bucket

  rule {
    apply_server_side_encryption_by_default {
      kms_master_key_id = aws_kms_key.backups.arn
      sse_algorithm     = &quot;aws:kms&quot;
    }
  }
}

resource &quot;aws_s3_bucket_lifecycle_configuration&quot; &quot;backups&quot; {
  bucket = aws_s3_bucket.backups.id

  rule {
    id     = &quot;database_backups&quot;
    status = &quot;Enabled&quot;

    filter {
      prefix = &quot;database/&quot;
    }

    transition {
      days          = 30
      storage_class = &quot;STANDARD_IA&quot;
    }

    transition {
      days          = 90
      storage_class = &quot;GLACIER&quot;
    }

    transition {
      days          = 365
      storage_class = &quot;DEEP_ARCHIVE&quot;
    }

    expiration {
      days = 2557  # 7 years for HIPAA compliance
    }

    noncurrent_version_expiration {
      noncurrent_days = 30
    }
  }
}</code></pre>
<h3 id="disaster-recovery-plan">Disaster Recovery Plan</h3>
<h4 id="rtorpo-requirements">RTO/RPO Requirements</h4>
<ul>
<li><strong>Recovery Time Objective (RTO)</strong>: 4 hours</li>
<li><strong>Recovery Point Objective (RPO)</strong>: 1 hour</li>
<li><strong>Data Retention</strong>: 7 years (HIPAA compliance)</li>
</ul>
<h4 id="dr-site-setup">DR Site Setup</h4>
<pre class="hcl"><code># DR region configuration
provider &quot;aws&quot; {
  alias  = &quot;dr&quot;
  region = var.dr_region
}

# DR VPC
module &quot;vpc_dr&quot; {
  source = &quot;./modules/vpc&quot;
  providers = {
    aws = aws.dr
  }

  environment = &quot;${var.environment}-dr&quot;
  vpc_cidr    = &quot;10.1.0.0/16&quot;
}

# DR RDS (read replica)
resource &quot;aws_db_instance&quot; &quot;dr_replica&quot; {
  provider = aws.dr

  identifier = &quot;careconnect-${var.environment}-dr&quot;

  replicate_source_db = aws_db_instance.main.identifier

  instance_class    = var.db_instance_class
  publicly_accessible = false

  auto_minor_version_upgrade = true
  backup_retention_period    = 7
  backup_window             = &quot;03:00-04:00&quot;

  tags = {
    Name        = &quot;careconnect-${var.environment}-dr&quot;
    Environment = var.environment
    Type        = &quot;DR&quot;
  }
}

# DR ECS cluster (minimal capacity)
module &quot;ecs_dr&quot; {
  source = &quot;./modules/ecs&quot;
  providers = {
    aws = aws.dr
  }

  environment = &quot;${var.environment}-dr&quot;
  vpc_id      = module.vpc_dr.vpc_id
  subnet_ids  = module.vpc_dr.private_subnet_ids

  cluster_name    = &quot;careconnect-${var.environment}-dr&quot;
  desired_count   = 0  # Scale up during disaster
  min_capacity    = 0
  max_capacity    = 10

  container_image = var.backend_container_image
  database_url    = aws_db_instance.dr_replica.endpoint
}</code></pre>
<h4 id="disaster-recovery-runbook">Disaster Recovery Runbook</h4>
<div class="sourceCode" id="cb36"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="co"># scripts/disaster-recovery.sh</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="at">-e</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="va">DR_REGION</span><span class="op">=</span><span class="st">&quot;us-west-2&quot;</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="va">PRIMARY_REGION</span><span class="op">=</span><span class="st">&quot;us-east-1&quot;</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="va">ENVIRONMENT</span><span class="op">=</span><span class="st">&quot;prod&quot;</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Starting disaster recovery process...&quot;</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Promote DR database</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Promoting read replica to primary...&quot;</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> rds promote-read-replica <span class="dt">\</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">--db-instance-identifier</span> careconnect-<span class="va">${ENVIRONMENT}</span>-dr <span class="dt">\</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">--region</span> <span class="va">$DR_REGION</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> rds wait db-instance-available <span class="dt">\</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">--db-instance-identifier</span> careconnect-<span class="va">${ENVIRONMENT}</span>-dr <span class="dt">\</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">--region</span> <span class="va">$DR_REGION</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Scale up DR ECS service</span></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Scaling up DR ECS service...&quot;</span></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ecs update-service <span class="dt">\</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">--cluster</span> careconnect-<span class="va">${ENVIRONMENT}</span>-dr <span class="dt">\</span></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">--service</span> careconnect-<span class="va">${ENVIRONMENT}</span>-dr-service <span class="dt">\</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">--desired-count</span> 3 <span class="dt">\</span></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">--region</span> <span class="va">$DR_REGION</span></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ecs wait services-stable <span class="dt">\</span></span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">--cluster</span> careconnect-<span class="va">${ENVIRONMENT}</span>-dr <span class="dt">\</span></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">--services</span> careconnect-<span class="va">${ENVIRONMENT}</span>-dr-service <span class="dt">\</span></span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">--region</span> <span class="va">$DR_REGION</span></span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Update DNS to point to DR site</span></span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Updating DNS to DR site...&quot;</span></span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a><span class="va">HOSTED_ZONE_ID</span><span class="op">=</span><span class="va">$(</span><span class="ex">aws</span> route53 list-hosted-zones <span class="dt">\</span></span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">--query</span> <span class="st">&quot;HostedZones[?Name==&#39;careconnect.example.com.&#39;].Id&quot;</span> <span class="dt">\</span></span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">--output</span> text <span class="kw">|</span> <span class="fu">cut</span> <span class="at">-d</span><span class="st">&#39;/&#39;</span> <span class="at">-f3</span><span class="va">)</span></span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a><span class="va">DR_ALB_DNS</span><span class="op">=</span><span class="va">$(</span><span class="ex">aws</span> elbv2 describe-load-balancers <span class="dt">\</span></span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">--region</span> <span class="va">$DR_REGION</span> <span class="dt">\</span></span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">--query</span> <span class="st">&quot;LoadBalancers[?contains(LoadBalancerName, &#39;careconnect-</span><span class="va">${ENVIRONMENT}</span><span class="st">-dr&#39;)].DNSName&quot;</span> <span class="dt">\</span></span>
<span id="cb36-44"><a href="#cb36-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">--output</span> text<span class="va">)</span></span>
<span id="cb36-45"><a href="#cb36-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-46"><a href="#cb36-46" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> route53 change-resource-record-sets <span class="dt">\</span></span>
<span id="cb36-47"><a href="#cb36-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">--hosted-zone-id</span> <span class="va">$HOSTED_ZONE_ID</span> <span class="dt">\</span></span>
<span id="cb36-48"><a href="#cb36-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">--change-batch</span> file://<span class="op">&lt;(</span><span class="fu">cat</span> <span class="op">&lt;&lt;EOF</span></span>
<span id="cb36-49"><a href="#cb36-49" aria-hidden="true" tabindex="-1"></a><span class="st">{</span></span>
<span id="cb36-50"><a href="#cb36-50" aria-hidden="true" tabindex="-1"></a><span class="st">  &quot;Changes&quot;: [</span></span>
<span id="cb36-51"><a href="#cb36-51" aria-hidden="true" tabindex="-1"></a><span class="st">    {</span></span>
<span id="cb36-52"><a href="#cb36-52" aria-hidden="true" tabindex="-1"></a><span class="st">      &quot;Action&quot;: &quot;UPSERT&quot;,</span></span>
<span id="cb36-53"><a href="#cb36-53" aria-hidden="true" tabindex="-1"></a><span class="st">      &quot;ResourceRecordSet&quot;: {</span></span>
<span id="cb36-54"><a href="#cb36-54" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;Name&quot;: &quot;api.careconnect.example.com&quot;,</span></span>
<span id="cb36-55"><a href="#cb36-55" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;Type&quot;: &quot;CNAME&quot;,</span></span>
<span id="cb36-56"><a href="#cb36-56" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;TTL&quot;: 60,</span></span>
<span id="cb36-57"><a href="#cb36-57" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;ResourceRecords&quot;: [</span></span>
<span id="cb36-58"><a href="#cb36-58" aria-hidden="true" tabindex="-1"></a><span class="st">          {</span></span>
<span id="cb36-59"><a href="#cb36-59" aria-hidden="true" tabindex="-1"></a><span class="st">            &quot;Value&quot;: &quot;</span><span class="va">$DR_ALB_DNS</span><span class="st">&quot;</span></span>
<span id="cb36-60"><a href="#cb36-60" aria-hidden="true" tabindex="-1"></a><span class="st">          }</span></span>
<span id="cb36-61"><a href="#cb36-61" aria-hidden="true" tabindex="-1"></a><span class="st">        ]</span></span>
<span id="cb36-62"><a href="#cb36-62" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb36-63"><a href="#cb36-63" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb36-64"><a href="#cb36-64" aria-hidden="true" tabindex="-1"></a><span class="st">  ]</span></span>
<span id="cb36-65"><a href="#cb36-65" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb36-66"><a href="#cb36-66" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb36-67"><a href="#cb36-67" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb36-68"><a href="#cb36-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-69"><a href="#cb36-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Verify DR site</span></span>
<span id="cb36-70"><a href="#cb36-70" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Verifying DR site...&quot;</span></span>
<span id="cb36-71"><a href="#cb36-71" aria-hidden="true" tabindex="-1"></a><span class="fu">sleep</span> 60  <span class="co"># Wait for DNS propagation</span></span>
<span id="cb36-72"><a href="#cb36-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-73"><a href="#cb36-73" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-f</span> https://api.careconnect.example.com/actuator/health</span>
<span id="cb36-74"><a href="#cb36-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-75"><a href="#cb36-75" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Disaster recovery completed successfully!&quot;</span></span>
<span id="cb36-76"><a href="#cb36-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-77"><a href="#cb36-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 5: Notify stakeholders</span></span>
<span id="cb36-78"><a href="#cb36-78" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> POST <span class="va">$SLACK_WEBHOOK_URL</span> <span class="dt">\</span></span>
<span id="cb36-79"><a href="#cb36-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">-H</span> <span class="st">&#39;Content-type: application/json&#39;</span> <span class="dt">\</span></span>
<span id="cb36-80"><a href="#cb36-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">--data</span> <span class="st">&#39;{&quot;text&quot;:&quot;🚨 Disaster recovery activated. Site is now running from DR region.&quot;}&#39;</span></span></code></pre></div>
<h3 id="recovery-testing">Recovery Testing</h3>
<h4 id="monthly-dr-tests">Monthly DR Tests</h4>
<div class="sourceCode" id="cb37"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="co"># scripts/dr-test.sh</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="at">-e</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Starting monthly DR test...&quot;</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create test environment in DR region</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="ex">terraform</span> workspace new dr-test</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="ex">terraform</span> plan <span class="at">-var-file</span><span class="op">=</span><span class="st">&quot;environments/dr-test.tfvars&quot;</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="ex">terraform</span> apply <span class="at">-auto-approve</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Run smoke tests against DR environment</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="ex">./scripts/smoke-tests.sh</span> https://dr-test.careconnect.example.com</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate DR test report</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;DR Test Results:&quot;</span> <span class="op">&gt;</span> dr-test-report.txt</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Date: </span><span class="va">$(</span><span class="fu">date</span><span class="va">)</span><span class="st">&quot;</span> <span class="op">&gt;&gt;</span> dr-test-report.txt</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;RTO Achieved: </span><span class="va">$(</span><span class="fu">cat</span> rto-time.txt<span class="va">)</span><span class="st">&quot;</span> <span class="op">&gt;&gt;</span> dr-test-report.txt</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;RPO Achieved: </span><span class="va">$(</span><span class="fu">cat</span> rpo-time.txt<span class="va">)</span><span class="st">&quot;</span> <span class="op">&gt;&gt;</span> dr-test-report.txt</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Cleanup test environment</span></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a><span class="ex">terraform</span> destroy <span class="at">-auto-approve</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a><span class="ex">terraform</span> workspace delete dr-test</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;DR test completed successfully&quot;</span></span></code></pre></div>
<h2 id="performance-optimization">Performance Optimization</h2>
<h3 id="database-optimization">Database Optimization</h3>
<h4 id="query-optimization">Query Optimization</h4>
<div class="sourceCode" id="cb38"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Analyze slow queries</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">query</span>,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    calls,</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    total_exec_time,</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    mean_exec_time,</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">rows</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> pg_stat_statements</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> total_exec_time <span class="op">&gt;</span> <span class="dv">1000</span>  <span class="co">-- queries taking more than 1 second total</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> total_exec_time <span class="kw">DESC</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">20</span>;</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="co">-- Optimize frequently accessed tables</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="kw">ANALYZE</span> users, vital_signs, medications;</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a><span class="co">-- Add missing indexes</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> CONCURRENTLY idx_vital_signs_user_type_date</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a><span class="kw">ON</span> vital_signs(user_id, <span class="kw">type</span>, measurement_time <span class="kw">DESC</span>);</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> CONCURRENTLY idx_messages_conversation_unread</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a><span class="kw">ON</span> messages(conversation_id, is_read, created_at <span class="kw">DESC</span>);</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a><span class="co">-- Partition large tables (PostgreSQL 12+ declarative partitioning)</span></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> vital_signs_partitioned (</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">LIKE</span> vital_signs <span class="kw">INCLUDING</span> <span class="kw">ALL</span></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>) <span class="kw">PARTITION</span> <span class="kw">BY</span> <span class="kw">RANGE</span> (measurement_time);</span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> vital_signs_2023 <span class="kw">PARTITION</span> <span class="kw">OF</span> vital_signs_partitioned</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">FOR</span> <span class="kw">VALUES</span> <span class="kw">FROM</span> (<span class="st">&#39;2023-01-01&#39;</span>) <span class="kw">TO</span> (<span class="st">&#39;2024-01-01&#39;</span>);</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> vital_signs_2024 <span class="kw">PARTITION</span> <span class="kw">OF</span> vital_signs_partitioned</span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">FOR</span> <span class="kw">VALUES</span> <span class="kw">FROM</span> (<span class="st">&#39;2024-01-01&#39;</span>) <span class="kw">TO</span> (<span class="st">&#39;2025-01-01&#39;</span>);</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> vital_signs_2025 <span class="kw">PARTITION</span> <span class="kw">OF</span> vital_signs_partitioned</span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">FOR</span> <span class="kw">VALUES</span> <span class="kw">FROM</span> (<span class="st">&#39;2025-01-01&#39;</span>) <span class="kw">TO</span> (<span class="st">&#39;2026-01-01&#39;</span>);</span></code></pre></div>
<h4 id="connection-pooling">Connection Pooling</h4>
<pre class="properties"><code># application-prod.properties

# HikariCP configuration
spring.datasource.hikari.connection-timeout=20000
spring.datasource.hikari.idle-timeout=300000
spring.datasource.hikari.max-lifetime=1200000
spring.datasource.hikari.maximum-pool-size=20
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.pool-name=CareConnectHikariPool

# Connection validation
spring.datasource.hikari.connection-test-query=SELECT 1
spring.datasource.hikari.validation-timeout=5000

# Performance monitoring
spring.datasource.hikari.register-mbeans=true</code></pre>
<h3 id="caching-strategy">Caching Strategy</h3>
<h4 id="redis-configuration">Redis Configuration</h4>
<div class="sourceCode" id="cb40"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Redis cluster configuration</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">spring</span><span class="kw">:</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">redis</span><span class="kw">:</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">cluster</span><span class="kw">:</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">nodes</span><span class="kw">:</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> prod-cache-001.region.cache.amazonaws.com:6379</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> prod-cache-002.region.cache.amazonaws.com:6379</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> prod-cache-003.region.cache.amazonaws.com:6379</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">timeout</span><span class="kw">:</span><span class="at"> 2000ms</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">lettuce</span><span class="kw">:</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">pool</span><span class="kw">:</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">max-active</span><span class="kw">:</span><span class="at"> </span><span class="dv">20</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">max-idle</span><span class="kw">:</span><span class="at"> </span><span class="dv">5</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">min-idle</span><span class="kw">:</span><span class="at"> </span><span class="dv">0</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">time-between-eviction-runs</span><span class="kw">:</span><span class="at"> 60s</span></span></code></pre></div>
<h4 id="cache-implementation">Cache Implementation</h4>
<div class="sourceCode" id="cb41"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> CachedHealthService <span class="op">{</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Cacheable</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;userVitals&quot;</span><span class="op">,</span> key <span class="op">=</span> <span class="st">&quot;#userId&quot;</span><span class="op">,</span> unless <span class="op">=</span> <span class="st">&quot;#result.isEmpty()&quot;</span><span class="op">)</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">List</span><span class="op">&lt;</span>VitalSignDTO<span class="op">&gt;</span> <span class="fu">getVitalSigns</span><span class="op">(</span><span class="bu">Long</span> userId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> healthRepository<span class="op">.</span><span class="fu">findByUserIdOrderByMeasurementTimeDesc</span><span class="op">(</span>userId<span class="op">)</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">stream</span><span class="op">()</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">map</span><span class="op">(</span><span class="kw">this</span><span class="op">::</span>convertToDTO<span class="op">)</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">collect</span><span class="op">(</span>Collectors<span class="op">.</span><span class="fu">toList</span><span class="op">());</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">@CacheEvict</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;userVitals&quot;</span><span class="op">,</span> key <span class="op">=</span> <span class="st">&quot;#userId&quot;</span><span class="op">)</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> VitalSignDTO <span class="fu">recordVitalSign</span><span class="op">(</span><span class="bu">Long</span> userId<span class="op">,</span> VitalSignRequest request<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Implementation</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Cacheable</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;healthSummary&quot;</span><span class="op">,</span> key <span class="op">=</span> <span class="st">&quot;#userId&quot;</span><span class="op">)</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> HealthSummaryDTO <span class="fu">getHealthSummary</span><span class="op">(</span><span class="bu">Long</span> userId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Expensive aggregation query</span></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">@CacheEvict</span><span class="op">(</span>value <span class="op">=</span> <span class="op">{</span><span class="st">&quot;userVitals&quot;</span><span class="op">,</span> <span class="st">&quot;healthSummary&quot;</span><span class="op">},</span> key <span class="op">=</span> <span class="st">&quot;#userId&quot;</span><span class="op">)</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">evictUserCache</span><span class="op">(</span><span class="bu">Long</span> userId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Manual cache eviction</span></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="cdn-optimization">CDN Optimization</h3>
<h4 id="cloudfront-configuration">CloudFront Configuration</h4>
<pre class="hcl"><code>resource &quot;aws_cloudfront_distribution&quot; &quot;main&quot; {
  origin {
    domain_name = aws_s3_bucket.frontend.bucket_regional_domain_name
    origin_id   = &quot;S3-${aws_s3_bucket.frontend.id}&quot;

    s3_origin_config {
      origin_access_identity = aws_cloudfront_origin_access_identity.main.cloudfront_access_identity_path
    }
  }

  # API origin
  origin {
    domain_name = aws_lb.main.dns_name
    origin_id   = &quot;ALB-${aws_lb.main.name}&quot;

    custom_origin_config {
      http_port              = 80
      https_port             = 443
      origin_protocol_policy = &quot;https-only&quot;
      origin_ssl_protocols   = [&quot;TLSv1.2&quot;]
    }
  }

  enabled             = true
  is_ipv6_enabled     = true
  default_root_object = &quot;index.html&quot;

  # Static assets caching
  default_cache_behavior {
    allowed_methods        = [&quot;GET&quot;, &quot;HEAD&quot;, &quot;OPTIONS&quot;]
    cached_methods         = [&quot;GET&quot;, &quot;HEAD&quot;]
    target_origin_id       = &quot;S3-${aws_s3_bucket.frontend.id}&quot;
    compress               = true
    viewer_protocol_policy = &quot;redirect-to-https&quot;

    forwarded_values {
      query_string = false
      cookies {
        forward = &quot;none&quot;
      }
    }

    min_ttl     = 0
    default_ttl = 86400    # 1 day
    max_ttl     = 31536000 # 1 year
  }

  # API caching
  ordered_cache_behavior {
    path_pattern     = &quot;/api/*&quot;
    allowed_methods  = [&quot;DELETE&quot;, &quot;GET&quot;, &quot;HEAD&quot;, &quot;OPTIONS&quot;, &quot;PATCH&quot;, &quot;POST&quot;, &quot;PUT&quot;]
    cached_methods   = [&quot;GET&quot;, &quot;HEAD&quot;]
    target_origin_id = &quot;ALB-${aws_lb.main.name}&quot;
    compress         = true

    forwarded_values {
      query_string = true
      headers      = [&quot;Authorization&quot;, &quot;Content-Type&quot;]
      cookies {
        forward = &quot;none&quot;
      }
    }

    viewer_protocol_policy = &quot;https-only&quot;
    min_ttl               = 0
    default_ttl           = 0
    max_ttl               = 86400
  }

  price_class = &quot;PriceClass_100&quot;

  restrictions {
    geo_restriction {
      restriction_type = &quot;whitelist&quot;
      locations        = [&quot;US&quot;, &quot;CA&quot;, &quot;GB&quot;, &quot;DE&quot;]
    }
  }

  viewer_certificate {
    acm_certificate_arn = aws_acm_certificate.main.arn
    ssl_support_method  = &quot;sni-only&quot;
  }

  web_acl_id = aws_wafv2_web_acl.main.arn

  tags = {
    Name = &quot;careconnect-${var.environment}-cdn&quot;
  }
}</code></pre>
<h2 id="scaling-strategies">Scaling Strategies</h2>
<h3 id="horizontal-scaling">Horizontal Scaling</h3>
<h4 id="auto-scaling-configuration">Auto Scaling Configuration</h4>
<pre class="hcl"><code># ECS Auto Scaling
resource &quot;aws_appautoscaling_target&quot; &quot;ecs&quot; {
  max_capacity       = var.max_capacity
  min_capacity       = var.min_capacity
  resource_id        = &quot;service/${aws_ecs_cluster.main.name}/${aws_ecs_service.main.name}&quot;
  scalable_dimension = &quot;ecs:service:DesiredCount&quot;
  service_namespace  = &quot;ecs&quot;

  tags = {
    Name = &quot;${var.cluster_name}-scaling-target&quot;
  }
}

# CPU-based scaling
resource &quot;aws_appautoscaling_policy&quot; &quot;ecs_cpu&quot; {
  name               = &quot;${var.cluster_name}-cpu-scaling&quot;
  policy_type        = &quot;TargetTrackingScaling&quot;
  resource_id        = aws_appautoscaling_target.ecs.resource_id
  scalable_dimension = aws_appautoscaling_target.ecs.scalable_dimension
  service_namespace  = aws_appautoscaling_target.ecs.service_namespace

  target_tracking_scaling_policy_configuration {
    predefined_metric_specification {
      predefined_metric_type = &quot;ECSServiceAverageCPUUtilization&quot;
    }
    target_value       = 70.0
    scale_in_cooldown  = 300
    scale_out_cooldown = 300
  }
}

# Memory-based scaling
resource &quot;aws_appautoscaling_policy&quot; &quot;ecs_memory&quot; {
  name               = &quot;${var.cluster_name}-memory-scaling&quot;
  policy_type        = &quot;TargetTrackingScaling&quot;
  resource_id        = aws_appautoscaling_target.ecs.resource_id
  scalable_dimension = aws_appautoscaling_target.ecs.scalable_dimension
  service_namespace  = aws_appautoscaling_target.ecs.service_namespace

  target_tracking_scaling_policy_configuration {
    predefined_metric_specification {
      predefined_metric_type = &quot;ECSServiceAverageMemoryUtilization&quot;
    }
    target_value       = 80.0
    scale_in_cooldown  = 300
    scale_out_cooldown = 60
  }
}

# Custom metric scaling (API request rate)
resource &quot;aws_appautoscaling_policy&quot; &quot;ecs_requests&quot; {
  name               = &quot;${var.cluster_name}-requests-scaling&quot;
  policy_type        = &quot;TargetTrackingScaling&quot;
  resource_id        = aws_appautoscaling_target.ecs.resource_id
  scalable_dimension = aws_appautoscaling_target.ecs.scalable_dimension
  service_namespace  = aws_appautoscaling_target.ecs.service_namespace

  target_tracking_scaling_policy_configuration {
    customized_metric_specification {
      metric_name = &quot;RequestCountPerTarget&quot;
      namespace   = &quot;AWS/ApplicationELB&quot;
      statistic   = &quot;Sum&quot;

      dimensions = {
        TargetGroup  = aws_lb_target_group.main.arn_suffix
        LoadBalancer = aws_lb.main.arn_suffix
      }
    }
    target_value = 1000.0
  }
}</code></pre>
<h3 id="database-scaling">Database Scaling</h3>
<h4 id="read-replicas">Read Replicas</h4>
<pre class="hcl"><code># Read replica for reporting
resource &quot;aws_db_instance&quot; &quot;read_replica&quot; {
  identifier = &quot;careconnect-${var.environment}-read-replica&quot;

  replicate_source_db = aws_db_instance.main.identifier

  instance_class         = var.read_replica_instance_class
  publicly_accessible    = false
  auto_minor_version_upgrade = true

  # Performance Insights
  performance_insights_enabled          = true
  performance_insights_retention_period = 7

  monitoring_interval = 60
  monitoring_role_arn = aws_iam_role.enhanced_monitoring.arn

  tags = {
    Name        = &quot;careconnect-${var.environment}-read-replica&quot;
    Environment = var.environment
    Type        = &quot;ReadReplica&quot;
  }
}

# Connection routing in application
@Configuration
public class DatabaseConfig {

    @Bean
    @Primary
    public DataSource primaryDataSource() {
        return DataSourceBuilder.create()
            .url(&quot;jdbc:postgresql://prod-db.region.rds.amazonaws.com:5432/careconnect&quot;)
            .username(&quot;careconnect_app&quot;)
            .password(&quot;${spring.datasource.password}&quot;)
            .build();
    }

    @Bean
    public DataSource readOnlyDataSource() {
        return DataSourceBuilder.create()
            .url(&quot;jdbc:postgresql://prod-db-read-replica.region.rds.amazonaws.com:5432/careconnect&quot;)
            .username(&quot;careconnect_readonly&quot;)
            .password(&quot;${spring.datasource.readonly.password}&quot;)
            .build();
    }

    @Bean
    public JdbcTemplate readOnlyJdbcTemplate() {
        return new JdbcTemplate(readOnlyDataSource());
    }
}</code></pre>
<h2 id="maintenance-procedures">Maintenance Procedures</h2>
<h3 id="scheduled-maintenance">Scheduled Maintenance</h3>
<h4 id="maintenance-window-planning">Maintenance Window Planning</h4>
<div class="sourceCode" id="cb45"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="co"># scripts/maintenance-window.sh</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="at">-e</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="va">MAINTENANCE_START</span><span class="op">=</span><span class="va">$(</span><span class="fu">date</span><span class="va">)</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="va">CLUSTER_NAME</span><span class="op">=</span><span class="st">&quot;careconnect-prod&quot;</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="va">SERVICE_NAME</span><span class="op">=</span><span class="st">&quot;careconnect-prod-service&quot;</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Starting maintenance window: </span><span class="va">$MAINTENANCE_START</span><span class="st">&quot;</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Enable maintenance mode</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Enabling maintenance mode...&quot;</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ecs update-service <span class="dt">\</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">--cluster</span> <span class="va">$CLUSTER_NAME</span> <span class="dt">\</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">--service</span> maintenance-service <span class="dt">\</span></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">--desired-count</span> 1</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Scale down main service</span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Scaling down main service...&quot;</span></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ecs update-service <span class="dt">\</span></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">--cluster</span> <span class="va">$CLUSTER_NAME</span> <span class="dt">\</span></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">--service</span> <span class="va">$SERVICE_NAME</span> <span class="dt">\</span></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">--desired-count</span> 0</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ecs wait services-stable <span class="dt">\</span></span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">--cluster</span> <span class="va">$CLUSTER_NAME</span> <span class="dt">\</span></span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">--services</span> <span class="va">$SERVICE_NAME</span></span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Database maintenance</span></span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Starting database maintenance...&quot;</span></span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Update RDS instance class if needed</span></span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="st">&quot;</span><span class="va">$UPGRADE_DB_INSTANCE</span><span class="st">&quot;</span> <span class="ot">=</span> <span class="st">&quot;true&quot;</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a>    <span class="ex">aws</span> rds modify-db-instance <span class="dt">\</span></span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a>        <span class="at">--db-instance-identifier</span> careconnect-prod-db <span class="dt">\</span></span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a>        <span class="at">--db-instance-class</span> <span class="va">$NEW_DB_INSTANCE_CLASS</span> <span class="dt">\</span></span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">--apply-immediately</span></span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a>    <span class="ex">aws</span> rds wait db-instance-available <span class="dt">\</span></span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a>        <span class="at">--db-instance-identifier</span> careconnect-prod-db</span>
<span id="cb45-42"><a href="#cb45-42" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb45-43"><a href="#cb45-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-44"><a href="#cb45-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Run database maintenance</span></span>
<span id="cb45-45"><a href="#cb45-45" aria-hidden="true" tabindex="-1"></a><span class="ex">psql</span> <span class="at">-h</span> prod-db.region.rds.amazonaws.com <span class="at">-U</span> admin <span class="at">-d</span> careconnect <span class="op">&lt;&lt; EOF</span></span>
<span id="cb45-46"><a href="#cb45-46" aria-hidden="true" tabindex="-1"></a><span class="st">VACUUM ANALYZE users;</span></span>
<span id="cb45-47"><a href="#cb45-47" aria-hidden="true" tabindex="-1"></a><span class="st">VACUUM ANALYZE vital_signs;</span></span>
<span id="cb45-48"><a href="#cb45-48" aria-hidden="true" tabindex="-1"></a><span class="st">VACUUM ANALYZE medications;</span></span>
<span id="cb45-49"><a href="#cb45-49" aria-hidden="true" tabindex="-1"></a><span class="st">VACUUM ANALYZE allergies;</span></span>
<span id="cb45-50"><a href="#cb45-50" aria-hidden="true" tabindex="-1"></a><span class="st">REINDEX DATABASE careconnect;</span></span>
<span id="cb45-51"><a href="#cb45-51" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb45-52"><a href="#cb45-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-53"><a href="#cb45-53" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Update infrastructure if needed</span></span>
<span id="cb45-54"><a href="#cb45-54" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="ot">-f</span> <span class="st">&quot;infrastructure-updates.tf&quot;</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb45-55"><a href="#cb45-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;Applying infrastructure updates...&quot;</span></span>
<span id="cb45-56"><a href="#cb45-56" aria-hidden="true" tabindex="-1"></a>    <span class="ex">terraform</span> plan <span class="at">-out</span><span class="op">=</span>maintenance.tfplan</span>
<span id="cb45-57"><a href="#cb45-57" aria-hidden="true" tabindex="-1"></a>    <span class="ex">terraform</span> apply maintenance.tfplan</span>
<span id="cb45-58"><a href="#cb45-58" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb45-59"><a href="#cb45-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-60"><a href="#cb45-60" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Deploy application updates</span></span>
<span id="cb45-61"><a href="#cb45-61" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="st">&quot;</span><span class="va">$DEPLOY_NEW_VERSION</span><span class="st">&quot;</span> <span class="ot">=</span> <span class="st">&quot;true&quot;</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb45-62"><a href="#cb45-62" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;Deploying new application version...&quot;</span></span>
<span id="cb45-63"><a href="#cb45-63" aria-hidden="true" tabindex="-1"></a>    <span class="ex">./scripts/blue-green-deploy.sh</span></span>
<span id="cb45-64"><a href="#cb45-64" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb45-65"><a href="#cb45-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scale service back up</span></span>
<span id="cb45-66"><a href="#cb45-66" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;Scaling service back up...&quot;</span></span>
<span id="cb45-67"><a href="#cb45-67" aria-hidden="true" tabindex="-1"></a>    <span class="ex">aws</span> ecs update-service <span class="dt">\</span></span>
<span id="cb45-68"><a href="#cb45-68" aria-hidden="true" tabindex="-1"></a>        <span class="at">--cluster</span> <span class="va">$CLUSTER_NAME</span> <span class="dt">\</span></span>
<span id="cb45-69"><a href="#cb45-69" aria-hidden="true" tabindex="-1"></a>        <span class="at">--service</span> <span class="va">$SERVICE_NAME</span> <span class="dt">\</span></span>
<span id="cb45-70"><a href="#cb45-70" aria-hidden="true" tabindex="-1"></a>        <span class="at">--desired-count</span> 3</span>
<span id="cb45-71"><a href="#cb45-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-72"><a href="#cb45-72" aria-hidden="true" tabindex="-1"></a>    <span class="ex">aws</span> ecs wait services-stable <span class="dt">\</span></span>
<span id="cb45-73"><a href="#cb45-73" aria-hidden="true" tabindex="-1"></a>        <span class="at">--cluster</span> <span class="va">$CLUSTER_NAME</span> <span class="dt">\</span></span>
<span id="cb45-74"><a href="#cb45-74" aria-hidden="true" tabindex="-1"></a>        <span class="at">--services</span> <span class="va">$SERVICE_NAME</span></span>
<span id="cb45-75"><a href="#cb45-75" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb45-76"><a href="#cb45-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-77"><a href="#cb45-77" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Disable maintenance mode</span></span>
<span id="cb45-78"><a href="#cb45-78" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Disabling maintenance mode...&quot;</span></span>
<span id="cb45-79"><a href="#cb45-79" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ecs update-service <span class="dt">\</span></span>
<span id="cb45-80"><a href="#cb45-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">--cluster</span> <span class="va">$CLUSTER_NAME</span> <span class="dt">\</span></span>
<span id="cb45-81"><a href="#cb45-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">--service</span> maintenance-service <span class="dt">\</span></span>
<span id="cb45-82"><a href="#cb45-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">--desired-count</span> 0</span>
<span id="cb45-83"><a href="#cb45-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-84"><a href="#cb45-84" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Run post-maintenance tests</span></span>
<span id="cb45-85"><a href="#cb45-85" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Running post-maintenance tests...&quot;</span></span>
<span id="cb45-86"><a href="#cb45-86" aria-hidden="true" tabindex="-1"></a><span class="ex">./scripts/smoke-tests.sh</span></span>
<span id="cb45-87"><a href="#cb45-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-88"><a href="#cb45-88" aria-hidden="true" tabindex="-1"></a><span class="va">MAINTENANCE_END</span><span class="op">=</span><span class="va">$(</span><span class="fu">date</span><span class="va">)</span></span>
<span id="cb45-89"><a href="#cb45-89" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Maintenance window completed: </span><span class="va">$MAINTENANCE_END</span><span class="st">&quot;</span></span>
<span id="cb45-90"><a href="#cb45-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-91"><a href="#cb45-91" aria-hidden="true" tabindex="-1"></a><span class="co"># 8. Generate maintenance report</span></span>
<span id="cb45-92"><a href="#cb45-92" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&lt;&lt; EOF</span> <span class="op">&gt;</span> maintenance-report-<span class="va">$(</span><span class="fu">date</span> +%Y%m%d<span class="va">)</span>.txt</span>
<span id="cb45-93"><a href="#cb45-93" aria-hidden="true" tabindex="-1"></a><span class="st">Maintenance Window Report</span></span>
<span id="cb45-94"><a href="#cb45-94" aria-hidden="true" tabindex="-1"></a><span class="st">========================</span></span>
<span id="cb45-95"><a href="#cb45-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-96"><a href="#cb45-96" aria-hidden="true" tabindex="-1"></a><span class="st">Start Time: </span><span class="va">$MAINTENANCE_START</span></span>
<span id="cb45-97"><a href="#cb45-97" aria-hidden="true" tabindex="-1"></a><span class="st">End Time: </span><span class="va">$MAINTENANCE_END</span></span>
<span id="cb45-98"><a href="#cb45-98" aria-hidden="true" tabindex="-1"></a><span class="st">Duration: </span><span class="va">$(($(</span><span class="fu">date</span> <span class="at">-d</span> <span class="st">&quot;</span><span class="va">$MAINTENANCE_END</span><span class="st">&quot;</span> +%s<span class="va">)</span> <span class="op">-</span> <span class="va">$(</span><span class="fu">date</span> <span class="at">-d</span> <span class="st">&quot;</span><span class="va">$MAINTENANCE_START</span><span class="st">&quot;</span> +%s<span class="va">)))</span><span class="st"> seconds</span></span>
<span id="cb45-99"><a href="#cb45-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-100"><a href="#cb45-100" aria-hidden="true" tabindex="-1"></a><span class="st">Activities Performed:</span></span>
<span id="cb45-101"><a href="#cb45-101" aria-hidden="true" tabindex="-1"></a><span class="st">- Database optimization: </span><span class="va">$(</span><span class="cf">if</span> <span class="bu">[</span> <span class="st">&quot;</span><span class="va">$DB_OPTIMIZED</span><span class="st">&quot;</span> <span class="ot">=</span> <span class="st">&quot;true&quot;</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span> <span class="bu">echo</span> <span class="st">&quot;Completed&quot;</span><span class="kw">;</span> <span class="cf">else</span> <span class="bu">echo</span> <span class="st">&quot;Skipped&quot;</span><span class="kw">;</span> <span class="cf">fi</span><span class="va">)</span></span>
<span id="cb45-102"><a href="#cb45-102" aria-hidden="true" tabindex="-1"></a><span class="st">- Infrastructure updates: </span><span class="va">$(</span><span class="cf">if</span> <span class="bu">[</span> <span class="ot">-f</span> <span class="st">&quot;infrastructure-updates.tf&quot;</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span> <span class="bu">echo</span> <span class="st">&quot;Applied&quot;</span><span class="kw">;</span> <span class="cf">else</span> <span class="bu">echo</span> <span class="st">&quot;None&quot;</span><span class="kw">;</span> <span class="cf">fi</span><span class="va">)</span></span>
<span id="cb45-103"><a href="#cb45-103" aria-hidden="true" tabindex="-1"></a><span class="st">- Application deployment: </span><span class="va">$(</span><span class="cf">if</span> <span class="bu">[</span> <span class="st">&quot;</span><span class="va">$DEPLOY_NEW_VERSION</span><span class="st">&quot;</span> <span class="ot">=</span> <span class="st">&quot;true&quot;</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span> <span class="bu">echo</span> <span class="st">&quot;Deployed&quot;</span><span class="kw">;</span> <span class="cf">else</span> <span class="bu">echo</span> <span class="st">&quot;Skipped&quot;</span><span class="kw">;</span> <span class="cf">fi</span><span class="va">)</span></span>
<span id="cb45-104"><a href="#cb45-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-105"><a href="#cb45-105" aria-hidden="true" tabindex="-1"></a><span class="st">Post-maintenance test results: </span><span class="va">$(</span><span class="cf">if</span> <span class="ex">./scripts/smoke-tests.sh</span> <span class="op">&gt;</span> /dev/null <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span><span class="kw">;</span> <span class="cf">then</span> <span class="bu">echo</span> <span class="st">&quot;Passed&quot;</span><span class="kw">;</span> <span class="cf">else</span> <span class="bu">echo</span> <span class="st">&quot;Failed&quot;</span><span class="kw">;</span> <span class="cf">fi</span><span class="va">)</span></span>
<span id="cb45-106"><a href="#cb45-106" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb45-107"><a href="#cb45-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-108"><a href="#cb45-108" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Maintenance report generated: maintenance-report-</span><span class="va">$(</span><span class="fu">date</span> +%Y%m%d<span class="va">)</span><span class="st">.txt&quot;</span></span></code></pre></div>
<h3 id="system-updates">System Updates</h3>
<h4 id="security-patching">Security Patching</h4>
<div class="sourceCode" id="cb46"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="co"># scripts/security-patching.sh</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="at">-e</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Starting security patching process...&quot;</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Check for available security updates</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Checking for security updates...&quot;</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Update base Docker images</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> pull openjdk:17-jdk-slim</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> pull postgres:15</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for OS-level patches (for EC2 instances if any)</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a><span class="ex">yum</span> list-security <span class="at">--security</span> <span class="dv">2</span><span class="op">&gt;</span>/dev/null <span class="kw">||</span> <span class="fu">true</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Update dependencies</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Updating application dependencies...&quot;</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Backend dependencies</span></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> backend/core</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a><span class="ex">./mvnw</span> versions:display-dependency-updates</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a><span class="ex">./mvnw</span> versions:use-latest-versions <span class="at">-DallowSnapshots</span><span class="op">=</span>false</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a><span class="ex">./mvnw</span> clean test  <span class="co"># Ensure tests still pass</span></span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Frontend dependencies</span></span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ../../frontend</span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a><span class="ex">flutter</span> pub upgrade</span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a><span class="ex">flutter</span> test</span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Build new container images</span></span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Building updated container images...&quot;</span></span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ../backend/core</span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> build <span class="at">-t</span> careconnect-backend:security-patch-<span class="va">$(</span><span class="fu">date</span> +%Y%m%d<span class="va">)</span> .</span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Deploy to staging first</span></span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Deploying to staging for testing...&quot;</span></span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a><span class="ex">./scripts/deploy-staging.sh</span> security-patch-<span class="va">$(</span><span class="fu">date</span> +%Y%m%d<span class="va">)</span></span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Run security tests</span></span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Running security tests...&quot;</span></span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a><span class="ex">./scripts/security-tests.sh</span> staging</span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Deploy to production if tests pass</span></span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="va">$?</span> <span class="ot">-eq</span> 0 <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;Security tests passed. Deploying to production...&quot;</span></span>
<span id="cb46-49"><a href="#cb46-49" aria-hidden="true" tabindex="-1"></a>    <span class="ex">./scripts/blue-green-deploy.sh</span> security-patch-<span class="va">$(</span><span class="fu">date</span> +%Y%m%d<span class="va">)</span></span>
<span id="cb46-50"><a href="#cb46-50" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb46-51"><a href="#cb46-51" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;Security tests failed. Aborting production deployment.&quot;</span></span>
<span id="cb46-52"><a href="#cb46-52" aria-hidden="true" tabindex="-1"></a>    <span class="bu">exit</span> 1</span>
<span id="cb46-53"><a href="#cb46-53" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb46-54"><a href="#cb46-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-55"><a href="#cb46-55" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Security patching completed successfully.&quot;</span></span></code></pre></div>
<h2 id="troubleshooting-production-issues">Troubleshooting Production
Issues</h2>
<p>This section provides systematic approaches to diagnosing and
resolving common production issues in the CareConnect platform. Each
issue follows a structured format: <strong>Problem</strong> →
<strong>Root Causes</strong> → <strong>Diagnostic Steps</strong> →
<strong>Resolution</strong> → <strong>Prevention</strong>, enabling both
quick fixes during incidents and long-term improvements to prevent
recurrence.</p>
<h3 id="common-issues-and-systematic-solutions">Common Issues and
Systematic Solutions</h3>
<h4 id="problem-ecs-tasks-fail-to-start-or-immediately-exit">Problem:
ECS Tasks Fail to Start or Immediately Exit</h4>
<p><strong>Symptoms</strong>: - New deployments show tasks starting but
immediately transitioning to STOPPED state - CloudWatch Logs show
containers exiting with non-zero exit codes - ALB health checks report
unhealthy targets - Users experience 503 Service Unavailable errors</p>
<p><strong>Root Causes</strong>: This issue typically stems from one of
several configuration or dependency problems:</p>
<ol type="1">
<li><strong>Environment Variable Misconfiguration</strong>: Missing or
incorrect environment variables (database URL, API keys, JWT secrets)
cause application startup failures</li>
<li><strong>Database Connectivity Issues</strong>: Application can’t
reach RDS due to security group rules, subnet configuration, or database
being unavailable</li>
<li><strong>Container Image Problems</strong>: ECR image is corrupt,
missing dependencies, or built for wrong architecture (amd64 vs
arm64)</li>
<li><strong>IAM Permission Errors</strong>: ECS task lacks permissions
to access Secrets Manager, S3, or other AWS services needed at
startup</li>
<li><strong>Resource Constraints</strong>: Task definition specifies
insufficient memory/CPU, causing OOM kills during startup</li>
</ol>
<p><strong>Systematic Diagnostic Steps</strong>:</p>
<ol type="1">
<li><p><strong>Check ECS Task Exit Reason</strong>:</p>
<div class="sourceCode" id="cb47"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get detailed information about stopped tasks</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ecs describe-tasks <span class="dt">\</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">--cluster</span> careconnect-prod <span class="dt">\</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">--tasks</span> <span class="va">$(</span><span class="ex">aws</span> ecs list-tasks <span class="dt">\</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">--cluster</span> careconnect-prod <span class="dt">\</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">--service-name</span> careconnect-prod-service <span class="dt">\</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">--desired-status</span> STOPPED <span class="dt">\</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">--query</span> <span class="st">&#39;taskArns[0]&#39;</span> <span class="dt">\</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">--output</span> text<span class="va">)</span> <span class="dt">\</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">--query</span> <span class="st">&#39;tasks[0].{StopReason:stoppedReason,ExitCode:containers[0].exitCode,LastStatus:lastStatus}&#39;</span></span></code></pre></div>
<p><strong>What this tells you</strong>: The exit code and stop reason
often indicate the category of failure. Exit code 137 = OOM kill. Exit
code 1 with “Essential container exited” = application crash.</p></li>
<li><p><strong>Examine Container Logs</strong>:</p>
<div class="sourceCode" id="cb48"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># View recent logs from failed containers</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> logs filter-log-events <span class="dt">\</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">--log-group-name</span> <span class="st">&quot;/ecs/careconnect-prod&quot;</span> <span class="dt">\</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">--start-time</span> <span class="va">$(</span><span class="fu">date</span> <span class="at">-d</span> <span class="st">&#39;10 minutes ago&#39;</span> +%s<span class="va">)</span>000 <span class="dt">\</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">--query</span> <span class="st">&#39;events[*].[timestamp,message]&#39;</span> <span class="dt">\</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">--output</span> text <span class="kw">|</span> <span class="fu">sort</span></span></code></pre></div>
<p><strong>What to look for</strong>:</p>
<ul>
<li>“Connection refused” or “Connection timeout” = network/database
issue</li>
<li>“Environment variable X not set” = configuration issue</li>
<li>“OutOfMemoryError” or “Killed” = resource constraint</li>
<li>Stack traces with “AccessDeniedException” = IAM permission
issue</li>
</ul></li>
<li><p><strong>Verify Task Definition Configuration</strong>:</p>
<div class="sourceCode" id="cb49"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Review current task definition</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ecs describe-task-definition <span class="dt">\</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">--task-definition</span> careconnect-backend <span class="dt">\</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">--query</span> <span class="st">&#39;taskDefinition.{CPU:cpu,Memory:memory,Env:containerDefinitions[0].environment[*].name}&#39;</span> <span class="dt">\</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">--output</span> json</span></code></pre></div>
<p><strong>What to check</strong>: Ensure all required environment
variables are present. Cross-reference with working configuration in
staging.</p></li>
<li><p><strong>Test Database Connectivity from VPC</strong>:</p>
<div class="sourceCode" id="cb50"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Launch a test container in same VPC/subnet to isolate network issues</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ecs run-task <span class="dt">\</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">--cluster</span> careconnect-prod <span class="dt">\</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">--task-definition</span> careconnect-test-connectivity <span class="dt">\</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">--network-configuration</span> <span class="st">&quot;awsvpcConfiguration={subnets=[subnet-xxx],securityGroups=[sg-xxx]}&quot;</span> <span class="dt">\</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">--launch-type</span> FARGATE</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Then exec into it and test database connection</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ecs execute-command <span class="dt">\</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">--cluster</span> careconnect-prod <span class="dt">\</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">--task</span> <span class="op">&lt;</span>task-id<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">--container</span> connectivity-test <span class="dt">\</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">--interactive</span> <span class="dt">\</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">--command</span> <span class="st">&quot;/bin/sh&quot;</span></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Inside the container:</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a><span class="ex">nc</span> <span class="at">-zv</span> prod-db.region.rds.amazonaws.com 5432</span></code></pre></div>
<p><strong>What this proves</strong>: If this succeeds but application
fails, the issue is in application configuration, not network
connectivity.</p></li>
<li><p><strong>Check Security Group Rules</strong>:</p>
<div class="sourceCode" id="cb51"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify ECS tasks can reach RDS</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ec2 describe-security-groups <span class="dt">\</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">--filters</span> <span class="st">&quot;Name=group-name,Values=careconnect-prod-ecs-tasks&quot;</span> <span class="dt">\</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">--query</span> <span class="st">&#39;SecurityGroups[0].IpPermissionsEgress[*]&#39;</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify RDS accepts connections from ECS</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ec2 describe-security-groups <span class="dt">\</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">--filters</span> <span class="st">&quot;Name=group-name,Values=careconnect-prod-rds&quot;</span> <span class="dt">\</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">--query</span> <span class="st">&#39;SecurityGroups[0].IpPermissions[*]&#39;</span></span></code></pre></div>
<p><strong>What to verify</strong>: ECS security group allows outbound
to port 5432. RDS security group allows inbound from ECS security group
on port 5432.</p></li>
</ol>
<p><strong>Resolution Steps</strong>:</p>
<p><strong>If Environment Variable Missing</strong>:</p>
<div class="sourceCode" id="cb52"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Update task definition with missing variable</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ecs register-task-definition <span class="dt">\</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">--cli-input-json</span> file://updated-task-def.json</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Force new deployment to use updated task definition</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ecs update-service <span class="dt">\</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">--cluster</span> careconnect-prod <span class="dt">\</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">--service</span> careconnect-prod-service <span class="dt">\</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">--force-new-deployment</span></span></code></pre></div>
<p><strong>If Database Connectivity Issue</strong>:</p>
<div class="sourceCode" id="cb53"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add rule to RDS security group allowing ECS tasks</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ec2 authorize-security-group-ingress <span class="dt">\</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">--group-id</span> sg-rds-id <span class="dt">\</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">--protocol</span> tcp <span class="dt">\</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">--port</span> 5432 <span class="dt">\</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">--source-group</span> sg-ecs-tasks-id</span></code></pre></div>
<p><strong>If Resource Constraint</strong>:</p>
<div class="sourceCode" id="cb54"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Update task definition with more resources</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Modify task-def.json: increase &quot;memory&quot;: &quot;2048&quot; to &quot;4096&quot;</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ecs register-task-definition <span class="at">--cli-input-json</span> file://task-def.json</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ecs update-service <span class="at">--cluster</span> careconnect-prod <span class="at">--service</span> careconnect-prod-service <span class="at">--task-definition</span> careconnect-backend:NEW_REVISION</span></code></pre></div>
<p><strong>If IAM Permission Missing</strong>:</p>
<div class="sourceCode" id="cb55"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Attach missing policy to ECS task role</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> iam attach-role-policy <span class="dt">\</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">--role-name</span> careconnect-ecs-task-role <span class="dt">\</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">--policy-arn</span> arn:aws:iam::aws:policy/SecretsManagerReadWrite</span></code></pre></div>
<p><strong>Prevention</strong>: - <strong>Infrastructure as
Code</strong>: All task definitions and security groups should be in
Terraform, reviewed in pull requests - <strong>Automated
Testing</strong>: CI/CD should deploy to staging and run health checks
before allowing production deployment - <strong>Gradual
Rollout</strong>: Use blue-green or canary deployments so issues affect
only a subset of traffic initially - <strong>Resource
Monitoring</strong>: Set up CloudWatch alarms for task stop reasons and
OOM events</p>
<h4 id="problem-database-connection-pool-exhaustion">Problem: Database
Connection Pool Exhaustion</h4>
<p><strong>Symptoms</strong>: - Application logs show “Could not obtain
connection from pool” errors - Response times spike to &gt;30 seconds -
Health checks start failing intermittently - CloudWatch metrics show
DatabaseConnections at or near maximum</p>
<p><strong>Root Causes</strong>: Connection pool issues occur when the
application exhausts available database connections, usually due to:</p>
<ol type="1">
<li><strong>Connection Leaks</strong>: Application code opens database
connections but doesn’t properly close them in exception paths</li>
<li><strong>Slow Queries</strong>: Long-running queries hold connections
for extended periods, starving the pool</li>
<li><strong>Traffic Spikes</strong>: Sudden increase in traffic creates
more concurrent requests than pool can handle</li>
<li><strong>Misconfigured Pool Size</strong>: Pool max size is too small
for the number of ECS tasks and request concurrency</li>
<li><strong>Database Performance</strong>: Database is CPU-bound or
experiencing high I/O wait, slowing all queries</li>
</ol>
<p><strong>Systematic Diagnostic Steps</strong>:</p>
<ol type="1">
<li><p><strong>Check Current Database Connections</strong>:</p>
<div class="sourceCode" id="cb56"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Connect to RDS and query active connections</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="ex">psql</span> <span class="at">-h</span> prod-db.region.rds.amazonaws.com <span class="at">-U</span> admin <span class="at">-d</span> careconnect <span class="at">-c</span> <span class="st">&quot;</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT </span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="st">        state, </span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="st">        COUNT(*) as count,</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="st">        MAX(EXTRACT(EPOCH FROM (now() - state_change))) as max_duration_seconds</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="st">    FROM pg_stat_activity </span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a><span class="st">    WHERE datname = &#39;careconnect&#39;</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a><span class="st">    GROUP BY state</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a><span class="st">    ORDER BY count DESC;</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;</span></span></code></pre></div>
<p><strong>What to look for</strong>: High count of “idle in
transaction” (connection leak) or “active” queries with very long
durations (slow queries).</p></li>
<li><p><strong>Identify Long-Running Queries</strong>:</p>
<div class="sourceCode" id="cb57"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="ex">psql</span> <span class="at">-h</span> prod-db.region.rds.amazonaws.com <span class="at">-U</span> admin <span class="at">-d</span> careconnect <span class="at">-c</span> <span class="st">&quot;</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT </span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="st">        pid,</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="st">        usename,</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="st">        state,</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="st">        query,</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="st">        now() - state_change as duration</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a><span class="st">    FROM pg_stat_activity</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a><span class="st">    WHERE state != &#39;idle&#39;</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a><span class="st">      AND now() - state_change &gt; interval &#39;30 seconds&#39;</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a><span class="st">    ORDER BY duration DESC;</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;</span></span></code></pre></div>
<p><strong>What this reveals</strong>: Specific queries that are holding
connections for excessive time.</p></li>
<li><p><strong>Check HikariCP Metrics</strong> (from application
logs):</p>
<div class="sourceCode" id="cb58"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> logs filter-log-events <span class="dt">\</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">--log-group-name</span> <span class="st">&quot;/ecs/careconnect-prod&quot;</span> <span class="dt">\</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">--filter-pattern</span> <span class="st">&quot;HikariPool&quot;</span> <span class="dt">\</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">--start-time</span> <span class="va">$(</span><span class="fu">date</span> <span class="at">-d</span> <span class="st">&#39;1 hour ago&#39;</span> +%s<span class="va">)</span>000 <span class="dt">\</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">|</span> <span class="ex">jq</span> <span class="at">-r</span> <span class="st">&#39;.events[].message&#39;</span> <span class="dt">\</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">|</span> <span class="fu">grep</span> <span class="at">-E</span> <span class="st">&quot;active|idle|waiting&quot;</span></span></code></pre></div>
<p><strong>What to look for</strong>: Messages like “Thread starvation
or clock leap detected” or “Total connections X (active Y, idle 0,
waiting Z)”.</p></li>
</ol>
<p><strong>Resolution Steps</strong>:</p>
<p><strong>Immediate (During Incident)</strong>:</p>
<div class="sourceCode" id="cb59"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Scale up ECS tasks temporarily to distribute load</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ecs update-service <span class="dt">\</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">--cluster</span> careconnect-prod <span class="dt">\</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">--service</span> careconnect-prod-service <span class="dt">\</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">--desired-count</span> 10  <span class="co"># Double current count</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Kill problematic long-running queries</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a><span class="ex">psql</span> <span class="at">-h</span> prod-db.region.rds.amazonaws.com <span class="at">-U</span> admin <span class="at">-d</span> careconnect <span class="at">-c</span> <span class="st">&quot;</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT pg_terminate_backend(pid)</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a><span class="st">    FROM pg_stat_activity</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a><span class="st">    WHERE state = &#39;active&#39;</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a><span class="st">      AND now() - state_change &gt; interval &#39;5 minutes&#39;;</span></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;</span></span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Restart ECS tasks to clear connection pools</span></span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> ecs update-service <span class="dt">\</span></span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">--cluster</span> careconnect-prod <span class="dt">\</span></span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">--service</span> careconnect-prod-service <span class="dt">\</span></span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">--force-new-deployment</span></span></code></pre></div>
<p><strong>Long-Term (Post-Incident)</strong>: 1. <strong>Increase
Connection Pool Size</strong>: Update
<code>application.properties</code>:
<code>properties    spring.datasource.hikari.maximum-pool-size=20  # Was 10    spring.datasource.hikari.connection-timeout=30000</code></p>
<ol start="2" type="1">
<li><p><strong>Fix Connection Leaks</strong>: Review application code
for improper connection handling. Ensure all <code>@Transactional</code>
methods complete successfully or use try-with-resources for manual
connection management.</p></li>
<li><p><strong>Optimize Slow Queries</strong>:</p>
<div class="sourceCode" id="cb60"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Add missing indexes identified in query analysis</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_vital_signs_user_time <span class="kw">ON</span> vital_signs(user_id, measurement_time <span class="kw">DESC</span>);</span></code></pre></div></li>
</ol>
<p><strong>Prevention</strong>: - <strong>Connection Pool
Monitoring</strong>: Set up CloudWatch alarm when active connections
&gt; 80% of max - <strong>Query Performance Monitoring</strong>: Use
pg_stat_statements to track slow queries over time - <strong>Load
Testing</strong>: Regular load tests identify connection pool limits
before production traffic hits them - <strong>Code Reviews</strong>:
Require review of all database access patterns for proper connection
lifecycle management</p>
<div class="sourceCode" id="cb61"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check ALB metrics</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> cloudwatch get-metric-statistics <span class="dt">\</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">--namespace</span> AWS/ApplicationELB <span class="dt">\</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">--metric-name</span> TargetResponseTime <span class="dt">\</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">--dimensions</span> Name=LoadBalancer,Value=app/careconnect-prod/1234567890abcdef <span class="dt">\</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">--start-time</span> <span class="va">$(</span><span class="fu">date</span> <span class="at">-d</span> <span class="st">&#39;1 hour ago&#39;</span> <span class="at">--iso-8601</span><span class="va">)</span> <span class="dt">\</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">--end-time</span> <span class="va">$(</span><span class="fu">date</span> <span class="at">--iso-8601</span><span class="va">)</span> <span class="dt">\</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">--period</span> 300 <span class="dt">\</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">--statistics</span> Average,Maximum</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Check ECS service CPU/Memory usage</span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> cloudwatch get-metric-statistics <span class="dt">\</span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">--namespace</span> AWS/ECS <span class="dt">\</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">--metric-name</span> CPUUtilization <span class="dt">\</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">--dimensions</span> Name=ServiceName,Value=careconnect-prod-service Name=ClusterName,Value=careconnect-prod <span class="dt">\</span></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">--start-time</span> <span class="va">$(</span><span class="fu">date</span> <span class="at">-d</span> <span class="st">&#39;1 hour ago&#39;</span> <span class="at">--iso-8601</span><span class="va">)</span> <span class="dt">\</span></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">--end-time</span> <span class="va">$(</span><span class="fu">date</span> <span class="at">--iso-8601</span><span class="va">)</span> <span class="dt">\</span></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">--period</span> 300 <span class="dt">\</span></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">--statistics</span> Average,Maximum</span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Analyze application logs for slow queries</span></span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> logs filter-log-events <span class="dt">\</span></span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">--log-group-name</span> <span class="st">&quot;/ecs/careconnect-prod&quot;</span> <span class="dt">\</span></span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">--filter-pattern</span> <span class="st">&quot;Query took longer than&quot;</span> <span class="dt">\</span></span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">--start-time</span> <span class="va">$(</span><span class="fu">date</span> <span class="at">-d</span> <span class="st">&#39;1 hour ago&#39;</span> +%s<span class="va">)</span>000</span></code></pre></div>
<h3 id="diagnostic-tools">Diagnostic Tools</h3>
<h4 id="health-check-script">Health Check Script</h4>
<div class="sourceCode" id="cb62"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="co"># scripts/health-check.sh</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="at">-e</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Running comprehensive health check...&quot;</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. API Health Check</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Checking API health...&quot;</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a><span class="va">API_HEALTH</span><span class="op">=</span><span class="va">$(</span><span class="ex">curl</span> <span class="at">-s</span> https://api.careconnect.example.com/actuator/health<span class="va">)</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">echo</span> <span class="st">&quot;</span><span class="va">$API_HEALTH</span><span class="st">&quot;</span> <span class="kw">|</span> <span class="fu">grep</span> <span class="at">-q</span> <span class="st">&#39;&quot;status&quot;:&quot;UP&quot;&#39;</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;✅ API is healthy&quot;</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;❌ API is unhealthy: </span><span class="va">$API_HEALTH</span><span class="st">&quot;</span></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">exit</span> 1</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Database Health Check</span></span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Checking database connectivity...&quot;</span></span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a><span class="va">DB_CHECK</span><span class="op">=</span><span class="va">$(PGPASSWORD</span><span class="op">=</span><span class="va">$DB_PASSWORD</span> <span class="ex">psql</span> <span class="at">-h</span> prod-db.region.rds.amazonaws.com <span class="dt">\</span></span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>               <span class="at">-U</span> careconnect_app <span class="dt">\</span></span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>               <span class="at">-d</span> careconnect <span class="dt">\</span></span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>               <span class="at">-c</span> <span class="st">&quot;SELECT 1&quot;</span> <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span><span class="va">)</span></span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="va">$?</span> <span class="ot">-eq</span> 0 <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;✅ Database is accessible&quot;</span></span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;❌ Database connection failed: </span><span class="va">$DB_CHECK</span><span class="st">&quot;</span></span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">exit</span> 1</span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Cache Health Check</span></span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Checking Redis connectivity...&quot;</span></span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a><span class="va">REDIS_CHECK</span><span class="op">=</span><span class="va">$(</span><span class="ex">redis-cli</span> <span class="at">-h</span> prod-cache.region.cache.amazonaws.com ping <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span><span class="va">)</span></span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="st">&quot;</span><span class="va">$REDIS_CHECK</span><span class="st">&quot;</span> <span class="ot">=</span> <span class="st">&quot;PONG&quot;</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;✅ Redis is responding&quot;</span></span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;❌ Redis connection failed: </span><span class="va">$REDIS_CHECK</span><span class="st">&quot;</span></span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">exit</span> 1</span>
<span id="cb62-39"><a href="#cb62-39" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb62-40"><a href="#cb62-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-41"><a href="#cb62-41" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. ECS Service Health Check</span></span>
<span id="cb62-42"><a href="#cb62-42" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Checking ECS service status...&quot;</span></span>
<span id="cb62-43"><a href="#cb62-43" aria-hidden="true" tabindex="-1"></a><span class="va">RUNNING_TASKS</span><span class="op">=</span><span class="va">$(</span><span class="ex">aws</span> ecs describe-services <span class="dt">\</span></span>
<span id="cb62-44"><a href="#cb62-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">--cluster</span> careconnect-prod <span class="dt">\</span></span>
<span id="cb62-45"><a href="#cb62-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">--services</span> careconnect-prod-service <span class="dt">\</span></span>
<span id="cb62-46"><a href="#cb62-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">--query</span> <span class="st">&#39;services[0].runningCount&#39;</span> <span class="dt">\</span></span>
<span id="cb62-47"><a href="#cb62-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">--output</span> text<span class="va">)</span></span>
<span id="cb62-48"><a href="#cb62-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-49"><a href="#cb62-49" aria-hidden="true" tabindex="-1"></a><span class="va">DESIRED_TASKS</span><span class="op">=</span><span class="va">$(</span><span class="ex">aws</span> ecs describe-services <span class="dt">\</span></span>
<span id="cb62-50"><a href="#cb62-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">--cluster</span> careconnect-prod <span class="dt">\</span></span>
<span id="cb62-51"><a href="#cb62-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">--services</span> careconnect-prod-service <span class="dt">\</span></span>
<span id="cb62-52"><a href="#cb62-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">--query</span> <span class="st">&#39;services[0].desiredCount&#39;</span> <span class="dt">\</span></span>
<span id="cb62-53"><a href="#cb62-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">--output</span> text<span class="va">)</span></span>
<span id="cb62-54"><a href="#cb62-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-55"><a href="#cb62-55" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="st">&quot;</span><span class="va">$RUNNING_TASKS</span><span class="st">&quot;</span> <span class="ot">-eq</span> <span class="st">&quot;</span><span class="va">$DESIRED_TASKS</span><span class="st">&quot;</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb62-56"><a href="#cb62-56" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;✅ All ECS tasks are running (</span><span class="va">$RUNNING_TASKS</span><span class="st">/</span><span class="va">$DESIRED_TASKS</span><span class="st">)&quot;</span></span>
<span id="cb62-57"><a href="#cb62-57" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb62-58"><a href="#cb62-58" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;❌ ECS tasks mismatch: </span><span class="va">$RUNNING_TASKS</span><span class="st">/</span><span class="va">$DESIRED_TASKS</span><span class="st"> running&quot;</span></span>
<span id="cb62-59"><a href="#cb62-59" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb62-60"><a href="#cb62-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-61"><a href="#cb62-61" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Load Balancer Health Check</span></span>
<span id="cb62-62"><a href="#cb62-62" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Checking load balancer target health...&quot;</span></span>
<span id="cb62-63"><a href="#cb62-63" aria-hidden="true" tabindex="-1"></a><span class="va">HEALTHY_TARGETS</span><span class="op">=</span><span class="va">$(</span><span class="ex">aws</span> elbv2 describe-target-health <span class="dt">\</span></span>
<span id="cb62-64"><a href="#cb62-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">--target-group-arn</span> arn:aws:elasticloadbalancing:us-east-1:123456789012:targetgroup/careconnect-prod/1234567890abcdef <span class="dt">\</span></span>
<span id="cb62-65"><a href="#cb62-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">--query</span> <span class="st">&#39;TargetHealthDescriptions[?TargetHealth.State==`healthy`] | length(@)&#39;</span> <span class="dt">\</span></span>
<span id="cb62-66"><a href="#cb62-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">--output</span> text<span class="va">)</span></span>
<span id="cb62-67"><a href="#cb62-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-68"><a href="#cb62-68" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="st">&quot;</span><span class="va">$HEALTHY_TARGETS</span><span class="st">&quot;</span> <span class="ot">-gt</span> 0 <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb62-69"><a href="#cb62-69" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;✅ Load balancer has </span><span class="va">$HEALTHY_TARGETS</span><span class="st"> healthy targets&quot;</span></span>
<span id="cb62-70"><a href="#cb62-70" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb62-71"><a href="#cb62-71" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;❌ No healthy targets in load balancer&quot;</span></span>
<span id="cb62-72"><a href="#cb62-72" aria-hidden="true" tabindex="-1"></a>    <span class="bu">exit</span> 1</span>
<span id="cb62-73"><a href="#cb62-73" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb62-74"><a href="#cb62-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-75"><a href="#cb62-75" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. SSL Certificate Check</span></span>
<span id="cb62-76"><a href="#cb62-76" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Checking SSL certificate validity...&quot;</span></span>
<span id="cb62-77"><a href="#cb62-77" aria-hidden="true" tabindex="-1"></a><span class="va">SSL_EXPIRY</span><span class="op">=</span><span class="va">$(</span><span class="bu">echo</span> <span class="kw">|</span> <span class="ex">openssl</span> s_client <span class="at">-servername</span> careconnect.example.com <span class="at">-connect</span> careconnect.example.com:443 <span class="dv">2</span><span class="op">&gt;</span>/dev/null <span class="kw">|</span> <span class="ex">openssl</span> x509 <span class="at">-noout</span> <span class="at">-enddate</span> <span class="kw">|</span> <span class="fu">cut</span> <span class="at">-d</span><span class="op">=</span> <span class="at">-f2</span><span class="va">)</span></span>
<span id="cb62-78"><a href="#cb62-78" aria-hidden="true" tabindex="-1"></a><span class="va">SSL_EXPIRY_EPOCH</span><span class="op">=</span><span class="va">$(</span><span class="fu">date</span> <span class="at">-d</span> <span class="st">&quot;</span><span class="va">$SSL_EXPIRY</span><span class="st">&quot;</span> +%s<span class="va">)</span></span>
<span id="cb62-79"><a href="#cb62-79" aria-hidden="true" tabindex="-1"></a><span class="va">CURRENT_EPOCH</span><span class="op">=</span><span class="va">$(</span><span class="fu">date</span> +%s<span class="va">)</span></span>
<span id="cb62-80"><a href="#cb62-80" aria-hidden="true" tabindex="-1"></a><span class="va">DAYS_UNTIL_EXPIRY</span><span class="op">=</span><span class="va">$((</span> (<span class="va">$SSL_EXPIRY_EPOCH</span> <span class="op">-</span> <span class="va">$CURRENT_EPOCH</span>) <span class="op">/</span> <span class="dv">86400</span> <span class="va">))</span></span>
<span id="cb62-81"><a href="#cb62-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-82"><a href="#cb62-82" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="st">&quot;</span><span class="va">$DAYS_UNTIL_EXPIRY</span><span class="st">&quot;</span> <span class="ot">-gt</span> 30 <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb62-83"><a href="#cb62-83" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;✅ SSL certificate is valid for </span><span class="va">$DAYS_UNTIL_EXPIRY</span><span class="st"> more days&quot;</span></span>
<span id="cb62-84"><a href="#cb62-84" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb62-85"><a href="#cb62-85" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;⚠️  SSL certificate expires in </span><span class="va">$DAYS_UNTIL_EXPIRY</span><span class="st"> days&quot;</span></span>
<span id="cb62-86"><a href="#cb62-86" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb62-87"><a href="#cb62-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-88"><a href="#cb62-88" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Health check completed successfully!&quot;</span></span></code></pre></div>
<hr />
<p><em>This deployment and operations guide provides comprehensive
instructions for managing the CareConnect platform in production.
Regular updates to this document ensure operational procedures remain
current with infrastructure changes.</em></p>
<p><em>Last Updated: October 2025</em> <em>Version: 2025.1.0</em></p>
</body>
</html>
