<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="CareConnect Development Team" />
  <title>CareConnect Programmer's Guide</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="pdf/pdf-styles.css" />
</head>
<body>
<header id="title-block-header">
<h1 class="title">CareConnect Programmer's Guide</h1>
<p class="author">CareConnect Development Team</p>
<p class="date">October 2025</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#careconnect-2025-programmers-guide"
id="toc-careconnect-2025-programmers-guide">CareConnect 2025
Programmer’s Guide</a>
<ul>
<li><a href="#introduction" id="toc-introduction">Introduction</a>
<ul>
<li><a href="#purpose-and-vision" id="toc-purpose-and-vision">Purpose
and Vision</a></li>
<li><a href="#intended-audience" id="toc-intended-audience">Intended
Audience</a></li>
<li><a href="#technology-overview-and-rationale"
id="toc-technology-overview-and-rationale">Technology Overview and
Rationale</a></li>
</ul></li>
<li><a href="#architecture-overview"
id="toc-architecture-overview">Architecture Overview</a>
<ul>
<li><a href="#system-architecture-and-design-philosophy"
id="toc-system-architecture-and-design-philosophy">System Architecture
and Design Philosophy</a></li>
<li><a href="#technology-stack" id="toc-technology-stack">Technology
Stack</a></li>
</ul></li>
<li><a href="#development-environment-setup"
id="toc-development-environment-setup">Development Environment Setup</a>
<ul>
<li><a href="#prerequisites-and-system-requirements"
id="toc-prerequisites-and-system-requirements">Prerequisites and System
Requirements</a></li>
<li><a href="#clone-and-initial-setup"
id="toc-clone-and-initial-setup">Clone and Initial Setup</a></li>
<li><a href="#development-workflow"
id="toc-development-workflow">Development Workflow</a></li>
<li><a href="#project-structure" id="toc-project-structure">Project
Structure</a></li>
<li><a href="#environment-configuration"
id="toc-environment-configuration">Environment Configuration</a></li>
</ul></li>
<li><a href="#frontend-development-flutter"
id="toc-frontend-development-flutter">Frontend Development (Flutter)</a>
<ul>
<li><a href="#project-architecture"
id="toc-project-architecture">Project Architecture</a></li>
<li><a href="#state-management-with-provider"
id="toc-state-management-with-provider">State Management with
Provider</a></li>
<li><a href="#routing-configuration-with-gorouter"
id="toc-routing-configuration-with-gorouter">Routing Configuration with
GoRouter</a></li>
<li><a href="#http-client-configuration-with-dio-and-interceptors"
id="toc-http-client-configuration-with-dio-and-interceptors">HTTP Client
Configuration with Dio and Interceptors</a></li>
<li><a href="#feature-module-structure"
id="toc-feature-module-structure">Feature Module Structure</a></li>
<li><a href="#entity-models-mapping-domain-objects-to-database-tables"
id="toc-entity-models-mapping-domain-objects-to-database-tables">Entity
Models: Mapping Domain Objects to Database Tables</a></li>
<li><a href="#repository-layer-spring-data-jpas-magic"
id="toc-repository-layer-spring-data-jpas-magic">Repository Layer:
Spring Data JPA’s Magic</a></li>
<li><a
href="#service-layer-implementing-business-logic-and-orchestration"
id="toc-service-layer-implementing-business-logic-and-orchestration">Service
Layer: Implementing Business Logic and Orchestration</a></li>
<li><a href="#controller-layer" id="toc-controller-layer">Controller
Layer</a></li>
</ul></li>
<li><a href="#database-design" id="toc-database-design">Database
Design</a>
<ul>
<li><a href="#entity-relationship-diagram"
id="toc-entity-relationship-diagram">Entity Relationship
Diagram</a></li>
<li><a href="#database-schema" id="toc-database-schema">Database
Schema</a></li>
</ul></li>
<li><a href="#api-documentation" id="toc-api-documentation">API
Documentation</a>
<ul>
<li><a href="#openapi-configuration"
id="toc-openapi-configuration">OpenAPI Configuration</a></li>
<li><a href="#restful-api-endpoints"
id="toc-restful-api-endpoints">RESTful API Endpoints</a></li>
</ul></li>
<li><a href="#authentication-security"
id="toc-authentication-security">Authentication &amp; Security</a>
<ul>
<li><a href="#jwt-implementation" id="toc-jwt-implementation">JWT
Implementation</a></li>
<li><a href="#jwt-authentication-filter"
id="toc-jwt-authentication-filter">JWT Authentication Filter</a></li>
<li><a href="#security-configuration"
id="toc-security-configuration">Security Configuration</a></li>
<li><a href="#jwt-token-provider" id="toc-jwt-token-provider">JWT Token
Provider</a></li>
<li><a href="#user-details-service-implementation"
id="toc-user-details-service-implementation">User Details Service
Implementation</a></li>
<li><a href="#security-features" id="toc-security-features">Security
Features</a></li>
</ul></li>
<li><a href="#real-time-communication-with-websocket"
id="toc-real-time-communication-with-websocket">Real-time Communication
with WebSocket</a>
<ul>
<li><a href="#why-websocket-for-healthcare"
id="toc-why-websocket-for-healthcare">Why WebSocket for
Healthcare?</a></li>
<li><a href="#architecture-overview-1"
id="toc-architecture-overview-1">Architecture Overview</a></li>
<li><a href="#dual-mode-configuration-development-vs-production"
id="toc-dual-mode-configuration-development-vs-production">Dual-Mode
Configuration: Development vs Production</a></li>
<li><a href="#local-development-websocket-configuration"
id="toc-local-development-websocket-configuration">Local Development
WebSocket Configuration</a></li>
<li><a href="#websocket-handler-healthcare-communications"
id="toc-websocket-handler-healthcare-communications">WebSocket Handler:
Healthcare Communications</a></li>
<li><a href="#connection-lifecycle-and-management"
id="toc-connection-lifecycle-and-management">Connection Lifecycle and
Management</a></li>
<li><a href="#security-implementation"
id="toc-security-implementation">Security Implementation</a></li>
<li><a href="#connection-management"
id="toc-connection-management">Connection Management</a></li>
<li><a href="#rest-api-integration" id="toc-rest-api-integration">REST
API Integration</a></li>
<li><a href="#client-side-integration-flutter"
id="toc-client-side-integration-flutter">Client-Side Integration
(Flutter)</a></li>
<li><a href="#aws-integration" id="toc-aws-integration">AWS
Integration</a></li>
<li><a href="#healthcare-specific-message-types"
id="toc-healthcare-specific-message-types">Healthcare-Specific Message
Types</a></li>
</ul></li>
<li><a href="#ai-integration" id="toc-ai-integration">AI Integration</a>
<ul>
<li><a href="#architecture-overview-2"
id="toc-architecture-overview-2">Architecture Overview</a></li>
<li><a href="#ai-configuration" id="toc-ai-configuration">AI
Configuration</a></li>
<li><a href="#core-ai-services" id="toc-core-ai-services">Core AI
Services</a></li>
<li><a href="#chat-memory-management"
id="toc-chat-memory-management">Chat Memory Management</a></li>
<li><a href="#security-and-governance"
id="toc-security-and-governance">Security and Governance</a></li>
<li><a href="#user-ai-configuration" id="toc-user-ai-configuration">User
AI Configuration</a></li>
<li><a href="#api-endpoints" id="toc-api-endpoints">API
Endpoints</a></li>
<li><a href="#database-schema-1" id="toc-database-schema-1">Database
Schema</a></li>
<li><a href="#development-and-testing"
id="toc-development-and-testing">Development and Testing</a></li>
</ul></li>
<li><a href="#device-integration" id="toc-device-integration">Device
Integration</a>
<ul>
<li><a href="#wearable-device-integration"
id="toc-wearable-device-integration">Wearable Device
Integration</a></li>
</ul></li>
<li><a href="#usps-integration" id="toc-usps-integration">USPS
Integration</a>
<ul>
<li><a href="#architecture-overview-3"
id="toc-architecture-overview-3">Architecture Overview</a></li>
<li><a href="#backend-implementation"
id="toc-backend-implementation">Backend Implementation</a></li>
<li><a href="#frontend-implementation"
id="toc-frontend-implementation">Frontend Implementation</a></li>
<li><a href="#database-schema-2" id="toc-database-schema-2">Database
Schema</a></li>
<li><a href="#configuration"
id="toc-configuration">Configuration</a></li>
<li><a href="#security-considerations"
id="toc-security-considerations">Security Considerations</a></li>
<li><a href="#known-limitations" id="toc-known-limitations">Known
Limitations</a></li>
<li><a href="#future-enhancements" id="toc-future-enhancements">Future
Enhancements</a></li>
</ul></li>
<li><a href="#vial-of-life-integration"
id="toc-vial-of-life-integration">Vial of Life Integration</a>
<ul>
<li><a href="#architecture-overview-4"
id="toc-architecture-overview-4">Architecture Overview</a></li>
<li><a href="#backend-implementation-1"
id="toc-backend-implementation-1">Backend Implementation</a></li>
<li><a href="#security-configuration-1"
id="toc-security-configuration-1">Security Configuration</a></li>
<li><a href="#emergency-id-format"
id="toc-emergency-id-format">Emergency ID Format</a></li>
<li><a href="#qr-code-integration" id="toc-qr-code-integration">QR Code
Integration</a></li>
<li><a href="#pdf-features" id="toc-pdf-features">PDF Features</a></li>
<li><a href="#dependencies" id="toc-dependencies">Dependencies</a></li>
<li><a href="#configuration-properties-1"
id="toc-configuration-properties-1">Configuration Properties</a></li>
<li><a href="#error-handling-2" id="toc-error-handling-2">Error
Handling</a></li>
<li><a href="#usage-example" id="toc-usage-example">Usage
Example</a></li>
<li><a href="#future-enhancements-1"
id="toc-future-enhancements-1">Future Enhancements</a></li>
</ul></li>
<li><a href="#file-upload-management"
id="toc-file-upload-management">File Upload &amp; Management</a>
<ul>
<li><a href="#file-upload-service" id="toc-file-upload-service">File
Upload Service</a></li>
<li><a href="#frontend-file-upload"
id="toc-frontend-file-upload">Frontend File Upload</a></li>
</ul></li>
<li><a href="#testing-strategies" id="toc-testing-strategies">Testing
Strategies</a>
<ul>
<li><a href="#unit-testing-flutter" id="toc-unit-testing-flutter">Unit
Testing (Flutter)</a></li>
<li><a href="#integration-testing-spring-boot"
id="toc-integration-testing-spring-boot">Integration Testing (Spring
Boot)</a></li>
<li><a href="#end-to-end-testing" id="toc-end-to-end-testing">End-to-End
Testing</a></li>
</ul></li>
<li><a href="#performance-optimization"
id="toc-performance-optimization">Performance Optimization</a>
<ul>
<li><a
href="#frontend-optimization-efficient-data-loading-and-rendering"
id="toc-frontend-optimization-efficient-data-loading-and-rendering">Frontend
Optimization: Efficient Data Loading and Rendering</a></li>
<li><a href="#backend-optimization-caching-with-redis"
id="toc-backend-optimization-caching-with-redis">Backend Optimization:
Caching with Redis</a></li>
<li><a href="#backend-optimization"
id="toc-backend-optimization">Backend Optimization</a></li>
<li><a href="#database-optimization-indexes-and-partitioning"
id="toc-database-optimization-indexes-and-partitioning">Database
Optimization: Indexes and Partitioning</a></li>
</ul></li>
<li><a href="#deployment-pipeline"
id="toc-deployment-pipeline">Deployment Pipeline</a>
<ul>
<li><a href="#github-actions-cicd" id="toc-github-actions-cicd">GitHub
Actions CI/CD</a></li>
<li><a href="#docker-configuration" id="toc-docker-configuration">Docker
Configuration</a></li>
<li><a href="#terraform-infrastructure"
id="toc-terraform-infrastructure">Terraform Infrastructure</a></li>
</ul></li>
<li><a href="#monitoring-logging" id="toc-monitoring-logging">Monitoring
&amp; Logging</a>
<ul>
<li><a href="#application-monitoring"
id="toc-application-monitoring">Application Monitoring</a></li>
<li><a href="#logging-configuration"
id="toc-logging-configuration">Logging Configuration</a></li>
</ul></li>
<li><a href="#code-standards-best-practices"
id="toc-code-standards-best-practices">Code Standards &amp; Best
Practices</a>
<ul>
<li><a href="#flutter-code-standards"
id="toc-flutter-code-standards">Flutter Code Standards</a></li>
<li><a href="#java-code-standards" id="toc-java-code-standards">Java
Code Standards</a></li>
<li><a href="#git-commit-standards" id="toc-git-commit-standards">Git
Commit Standards</a></li>
</ul></li>
<li><a href="#contributing-guidelines"
id="toc-contributing-guidelines">Contributing Guidelines</a>
<ul>
<li><a href="#development-workflow-1"
id="toc-development-workflow-1">Development Workflow</a></li>
<li><a href="#code-review-process" id="toc-code-review-process">Code
Review Process</a></li>
<li><a href="#setting-up-development-environment"
id="toc-setting-up-development-environment">Setting Up Development
Environment</a></li>
</ul></li>
<li><a href="#troubleshooting"
id="toc-troubleshooting">Troubleshooting</a>
<ul>
<li><a href="#common-development-issues"
id="toc-common-development-issues">Common Development Issues</a></li>
<li><a href="#authentication-security-issues"
id="toc-authentication-security-issues">Authentication &amp; Security
Issues</a></li>
<li><a href="#websocket-connection-issues"
id="toc-websocket-connection-issues">WebSocket Connection
Issues</a></li>
<li><a href="#ai-service-integration-issues"
id="toc-ai-service-integration-issues">AI Service Integration
Issues</a></li>
<li><a href="#third-party-integration-issues"
id="toc-third-party-integration-issues">Third-Party Integration
Issues</a></li>
<li><a href="#performance-issues"
id="toc-performance-issues">Performance Issues</a></li>
<li><a href="#development-environment-issues"
id="toc-development-environment-issues">Development Environment
Issues</a></li>
<li><a href="#deployment-issues" id="toc-deployment-issues">Deployment
Issues</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
<h1 id="careconnect-2025-programmers-guide">CareConnect 2025
Programmer’s Guide</h1>
<h2 id="introduction">Introduction</h2>
<h3 id="purpose-and-vision">Purpose and Vision</h3>
<p>This Programmer’s Guide serves as the central hub of technical
knowledge for the CareConnect platform, a comprehensive healthcare
management system designed to connect patients, caregivers, and family
members in a seamless digital ecosystem. Its purpose is threefold:</p>
<p><strong>Onboarding</strong>: To rapidly acclimate new developers to
our complex, multi-technology stack by explaining the architectural
decisions and development workflows. Rather than simply listing
technologies, we explain <em>why</em> each was chosen and how they work
together to create a cohesive healthcare platform.</p>
<p><strong>Reference</strong>: To provide clear, actionable examples and
explanations for implementing features across the frontend, backend, and
integrated services. Each code example is accompanied by context
explaining its role in the larger system architecture.</p>
<p><strong>Troubleshooting</strong>: To offer a curated set of solutions
for common pitfalls, ensuring developer efficiency and system stability.
Our troubleshooting sections follow a Problem → Root Cause →
Step-by-Step Solution approach for clarity.</p>
<p>This document goes beyond simply listing endpoints and code; it
explains the reasoning behind our design patterns, such as why we chose
JWT for stateless authentication in a healthcare context and how our
WebSocket architecture ensures real-time updates for critical patient
alerts.</p>
<h3 id="intended-audience">Intended Audience</h3>
<p>This guide is designed for:</p>
<ul>
<li><strong>New developers</strong> joining the CareConnect team who
need to understand not just what the system does, but why it was built
this way</li>
<li><strong>Experienced engineers</strong> seeking reference material
for implementing new features or debugging complex issues</li>
<li><strong>System administrators</strong> who need to understand the
architecture to properly deploy and maintain the platform</li>
<li><strong>Technical leads</strong> who need to make informed decisions
about future architectural directions</li>
</ul>
<p>The guide assumes familiarity with software development principles
but provides context for domain-specific healthcare considerations and
our specific technology choices.</p>
<h3 id="technology-overview-and-rationale">Technology Overview and
Rationale</h3>
<p>CareConnect is built with a carefully selected stack of modern,
scalable technologies. Each choice was made to balance healthcare
industry requirements, developer productivity, and long-term
maintainability:</p>
<p><strong>Frontend - Flutter (cross-platform mobile/web)</strong> We
selected Flutter for its unique ability to create truly native
experiences across iOS, Android, web, and desktop from a single
codebase. In healthcare, where users may access the platform from
various devices, this cross-platform capability is crucial. Flutter’s
reactive framework and rich widget library also enable us to build
complex, accessible UIs that meet healthcare usability standards.</p>
<p><strong>Backend - Spring Boot 3.4.5 with Java 17</strong> Spring Boot
was chosen for its enterprise-grade maturity, extensive ecosystem, and
strong security features—all critical for healthcare applications
handling sensitive patient data. Java 17’s modern features (sealed
classes, records, pattern matching) allow us to write more expressive,
type-safe code while maintaining backwards compatibility with existing
Java systems common in healthcare infrastructure.</p>
<p><strong>Database - PostgreSQL with JPA/Hibernate</strong> PostgreSQL
provides the ACID compliance and data integrity guarantees essential for
medical records. Its support for JSON columns allows us to store
flexible health data structures while maintaining strong relational
integrity for core entities like users and medications. JPA/Hibernate
abstracts database operations while giving us fine-grained control when
needed for complex healthcare queries.</p>
<p><strong>AI Integration - Spring AI + DeepSeek/LangChain4j</strong>
Healthcare applications benefit enormously from AI for tasks like health
risk assessment and intelligent scheduling. We use Spring AI’s
abstraction layer with DeepSeek and LangChain4j to provide AI-powered
features while maintaining the flexibility to switch or combine AI
providers as the technology evolves.</p>
<p><strong>Security - JWT-based authentication</strong> JWT (JSON Web
Tokens) enable stateless authentication, crucial for our distributed
architecture and real-time features. In healthcare, where audit trails
and precise access control are mandatory, JWT’s self-contained claims
allow us to verify user identity and permissions without database
lookups on every request, while still maintaining security through
signature verification.</p>
<p><strong>Real-time Communication - WebSocket</strong> Healthcare
scenarios often require immediate notification (medication reminders,
vital sign alerts, emergency communications). WebSocket provides the
persistent, bidirectional connection needed for these real-time
features, while our fallback to HTTP polling ensures reliability even in
constrained network environments.</p>
<p><strong>Cloud Infrastructure - AWS</strong> AWS provides the
scalability, security certifications (HIPAA compliance options), and
service breadth needed for healthcare applications. Our
infrastructure-as-code approach using Terraform ensures reproducible,
auditable deployments—a requirement for regulated healthcare
environments.</p>
<h2 id="architecture-overview">Architecture Overview</h2>
<h3 id="system-architecture-and-design-philosophy">System Architecture
and Design Philosophy</h3>
<p>CareConnect follows a microservices-inspired architecture with clear
separation between frontend, backend, and data layers. This
architectural approach was chosen to enable independent scaling,
deployment, and development of each layer while maintaining loose
coupling and high cohesion—principles essential for a healthcare
platform that must evolve rapidly to meet changing regulatory and
clinical requirements.</p>
<h4 id="layered-architecture-benefits">Layered Architecture
Benefits</h4>
<p><strong>Frontend Isolation</strong>: The Flutter frontend
communicates with the backend exclusively through well-defined REST and
WebSocket APIs. This means we can completely rewrite the mobile app, add
a web interface, or develop a desktop client without touching backend
code. For healthcare providers who might want to access CareConnect from
different devices (tablet in patient rooms, desktop in offices, mobile
while on rounds), this flexibility is crucial.</p>
<p><strong>Backend Independence</strong>: The Spring Boot backend owns
all business logic and data validation. Even if the frontend is
compromised or contains bugs, the backend enforces all critical rules
(medication dosages, user permissions, data validation). In healthcare,
this defense-in-depth approach is a regulatory requirement.</p>
<p><strong>Data Layer Abstraction</strong>: The database is accessed
only through JPA repositories, never via direct SQL in controllers or
frontend code. This abstraction makes it possible to migrate to a
different database, implement read replicas for scaling, or add caching
layers without affecting the rest of the application.</p>
<pre><code>┌─────────────────────────────────────────────────────────────────┐
│                        Frontend Layer                           │
│                                                                 │
│  Responsibility: User interface and user experience             │
│  Technology: Flutter (Dart)                                     │
│  Key Concerns: Cross-platform compatibility, offline support,   │
│                accessibility, responsive design                 │
├─────────────────────────────────────────────────────────────────┤
│  Flutter App (Web, iOS, Android, Desktop)                      │
│  ├── Provider (State Management)                               │
│  │   └── Manages UI state, exposes data to widgets            │
│  ├── GoRouter (Navigation)                                     │
│  │   └── Declarative routing, deep linking, guards            │
│  ├── Dio (HTTP Client)                                         │
│  │   └── REST API calls, interceptors, error handling         │
│  └── Features (Modular Architecture)                           │
│      └── Self-contained feature modules (auth, health, etc.)  │
└─────────────────────────────────────────────────────────────────┘
                                │
                         HTTP/WebSocket
                   (JSON over HTTPS/WSS)
                                │
┌─────────────────────────────────────────────────────────────────┐
│                        Backend Layer                            │
│                                                                 │
│  Responsibility: Business logic, data validation, security      │
│  Technology: Spring Boot (Java 17)                              │
│  Key Concerns: HIPAA compliance, data integrity, performance,   │
│                API versioning, audit logging                    │
├─────────────────────────────────────────────────────────────────┤
│  Spring Boot Application                                        │
│  ├── Controllers (REST API)                                    │
│  │   └── HTTP request handling, parameter validation,         │
│  │       response formatting, API documentation                │
│  ├── Services (Business Logic)                                 │
│  │   └── Transaction management, complex workflows,           │
│  │       business rules enforcement, orchestration             │
│  ├── Repositories (Data Access)                                │
│  │   └── Database queries, JPA entity management,             │
│  │       query optimization, data retrieval                    │
│  ├── WebSocket (Real-time Communication)                       │
│  │   └── Persistent connections, event streaming,             │
│  │       push notifications, bidirectional messaging           │
│  └── Security (JWT Authentication)                             │
│      └── Token validation, authorization, RBAC,               │
│          session management, security filters                  │
└─────────────────────────────────────────────────────────────────┘
                                │
                           JDBC/JPA
                    (SQL over TCP/IP)
                                │
┌─────────────────────────────────────────────────────────────────┐
│                         Data Layer                              │
│                                                                 │
│  Responsibility: Data persistence, integrity, backup            │
│  Technology: PostgreSQL 15+                                     │
│  Key Concerns: ACID compliance, encryption at rest, backups,    │
│                query performance, data retention                │
├─────────────────────────────────────────────────────────────────┤
│  PostgreSQL Database                                            │
│  ├── User Management                                            │
│  │   └── Authentication credentials, user profiles,           │
│  │       roles and permissions, account status                 │
│  ├── Health Data                                                │
│  │   └── Vital signs, medications, allergies, conditions,     │
│  │       lab results, medical history                          │
│  ├── Communication                                              │
│  │   └── Messages, call logs, notifications, WebSocket        │
│  │       connection tracking, chat history                     │
│  └── File Storage                                               │
│      └── Medical records metadata, file paths, document        │
│          categories, upload timestamps, access logs            │
└─────────────────────────────────────────────────────────────────┘</code></pre>
<h4 id="data-flow-example-recording-a-blood-pressure-reading">Data Flow
Example: Recording a Blood Pressure Reading</h4>
<p>To understand how these layers work together, let’s trace a complete
user action through the system:</p>
<ol type="1">
<li><strong>User Input (Frontend Layer)</strong>:
<ul>
<li>Patient opens Health screen, taps “Record Vital Sign”</li>
<li>Enters blood pressure: 140/90 mmHg</li>
<li>Adds note: “Measured after morning medication”</li>
<li>Taps “Save”</li>
</ul></li>
<li><strong>State Management (Frontend)</strong>:
<ul>
<li>HealthProvider’s <code>recordVitalSign()</code> method is
called</li>
<li>Provider sets <code>isLoading = true</code>, triggering UI to show
loading indicator</li>
<li>Provider calls HealthService to make API request</li>
</ul></li>
<li><strong>API Request (Frontend → Backend)</strong>:
<ul>
<li>Dio HTTP client constructs POST request to
<code>/api/health/vitals</code></li>
<li>AuthInterceptor automatically adds JWT token from secure
storage</li>
<li>Request body:
<code>{"type": "blood_pressure", "systolic": 140, "diastolic": 90, "notes": "..."}</code></li>
<li>LoggingInterceptor logs request for debugging</li>
</ul></li>
<li><strong>Request Reception (Backend - Controller Layer)</strong>:
<ul>
<li><code>HealthController.recordVitalSign()</code> receives
request</li>
<li>Spring Security validates JWT token, extracts user ID</li>
<li>JSR-380 validation checks request body structure</li>
<li>Controller passes validated DTO to Service layer</li>
</ul></li>
<li><strong>Business Logic (Backend - Service Layer)</strong>:
<ul>
<li><code>HealthService.recordVitalSign()</code> begins transaction</li>
<li>Verifies user exists and has permission to record vitals</li>
<li>Converts DTO to JPA entity</li>
<li>Saves entity via Repository (triggers database INSERT)</li>
<li><strong>Critical business logic</strong>: Checks if 140/90 exceeds
patient’s normal range</li>
<li>If abnormal, calls NotificationService to alert caregiver</li>
<li>Converts saved entity back to DTO</li>
<li>Returns DTO to controller</li>
</ul></li>
<li><strong>Data Persistence (Backend - Repository/Database)</strong>:
<ul>
<li>JPA translates entity to SQL:
<code>INSERT INTO vital_signs (user_id, type, systolic, diastolic, ...) VALUES (...)</code></li>
<li>PostgreSQL executes INSERT within transaction</li>
<li>Database enforces constraints (foreign keys, not-null, unique)</li>
<li>Returns generated ID and timestamp</li>
<li>Transaction commits (all data saved) or rolls back (on any
error)</li>
</ul></li>
<li><strong>Response (Backend → Frontend)</strong>:
<ul>
<li>Controller returns HTTP 201 Created with saved vital sign data</li>
<li>ErrorInterceptor doesn’t trigger (successful response)</li>
<li>Dio receives response and parses JSON</li>
</ul></li>
<li><strong>State Update (Frontend)</strong>:
<ul>
<li>HealthProvider updates local state with new vital sign</li>
<li>Calls <code>notifyListeners()</code> to rebuild UI</li>
<li>HealthScreen automatically updates to show new reading</li>
<li>Loading indicator disappears</li>
</ul></li>
<li><strong>Real-time Notification (Parallel Flow)</strong>:
<ul>
<li>If reading was abnormal, NotificationService also sent WebSocket
message</li>
<li>Caregiver’s app, connected to <code>/ws/careconnect</code>, receives
alert</li>
<li>Their HealthDashboard automatically shows “Patient [Name] recorded
elevated BP: 140/90”</li>
<li>Caregiver can tap notification to view patient’s full vital
history</li>
</ul></li>
</ol>
<p><strong>Total time</strong>: ~500ms from button tap to UI update and
caregiver notification. This is the power of a well-architected system:
complex workflows feel instantaneous to users.</p>
<h4 id="why-this-architecture-for-healthcare">Why This Architecture for
Healthcare?</h4>
<p><strong>Auditability</strong>: Every layer logs its actions. We can
trace a medication order from UI tap → API call → service logic →
database insert → notification sent, critical for regulatory
compliance.</p>
<p><strong>Security</strong>: Multiple validation layers. Even if
frontend is compromised, backend still enforces business rules. Even if
backend is misconfigured, database constraints prevent invalid data.</p>
<p><strong>Scalability</strong>: Each layer can scale independently.
High load from mobile users? Scale frontend servers. Complex analytics
queries? Scale database read replicas. Real-time notifications spiking?
Scale WebSocket handlers.</p>
<p><strong>Maintainability</strong>: Clear separation of concerns. UI
developers work in Flutter, backend developers in Spring Boot, database
admins tune PostgreSQL—all in parallel without conflicts.</p>
<p><strong>Testability</strong>: Each layer can be tested in isolation.
Mock the API for frontend tests, mock the database for service tests,
integration tests verify the full stack.</p>
<h3 id="technology-stack">Technology Stack</h3>
<p><strong>Frontend (Flutter):</strong> - <strong>Framework</strong>:
Flutter 3.9.2+ - <strong>State Management</strong>: Provider -
<strong>Routing</strong>: GoRouter - <strong>HTTP Client</strong>: Dio -
<strong>Local Storage</strong>: SharedPreferences, SQLite -
<strong>Real-time</strong>: WebSocket, Socket.IO</p>
<p><strong>Backend (Spring Boot):</strong> - <strong>Framework</strong>:
Spring Boot 3.4.5 - <strong>Security</strong>: Spring Security + JWT -
<strong>Data Access</strong>: Spring Data JPA -
<strong>Database</strong>: PostgreSQL 15+ - <strong>WebSocket</strong>:
Spring WebSocket - <strong>Documentation</strong>: OpenAPI 3</p>
<p><strong>Infrastructure:</strong> - <strong>Cloud Provider</strong>:
AWS - <strong>Infrastructure as Code</strong>: Terraform -
<strong>Containerization</strong>: Docker - <strong>CI/CD</strong>:
GitHub Actions</p>
<h2 id="development-environment-setup">Development Environment
Setup</h2>
<p>Setting up a development environment for CareConnect requires careful
orchestration of multiple technologies: Flutter for the frontend,
Java/Spring Boot for the backend, PostgreSQL for the database, and
various supporting tools. This section guides you through the setup
process, explaining not just the <em>what</em> but the <em>why</em>
behind each requirement.</p>
<h3 id="prerequisites-and-system-requirements">Prerequisites and System
Requirements</h3>
<p>Before beginning, ensure your system meets these requirements. These
aren’t arbitrary—each is chosen to match production environment
requirements and ensure team-wide compatibility.</p>
<h4 id="essential-software">Essential Software</h4>
<p><strong>Flutter SDK 3.9.2 or higher</strong> - <strong>Why this
version?</strong> Flutter 3.9.2 introduced stable support for desktop
platforms (Windows, macOS, Linux), which CareConnect uses for caregiver
dashboard applications. Earlier versions had breaking API changes that
would require code modifications. - <strong>Installation</strong>:
Download from <a
href="https://flutter.dev/docs/get-started/install">flutter.dev</a> -
<strong>Verification</strong>: Run <code>flutter doctor -v</code> after
installation - <strong>Common issues</strong>: Ensure Flutter bin
directory is in your PATH</p>
<p><strong>Java Development Kit (JDK) 17</strong> - <strong>Why version
17 specifically?</strong> Spring Boot 3.4.5 requires Java 17 minimum.
This version includes critical features like Records (used for DTOs),
sealed classes (used for domain modeling), and pattern matching (used in
service layer logic). - <strong>Not Java 11 or 8</strong>: These older
versions lack language features our codebase uses. Compilation will fail
with cryptic errors. - <strong>Not Java 18+</strong>: While these would
work, Java 17 is the current LTS (Long Term Support) version, matching
what we deploy to production. - <strong>Installation</strong>: Use
OpenJDK from <a href="https://adoptium.net/">adoptium.net</a> or your
system package manager - <strong>Verification</strong>:
<code>java -version</code> should show
<code>openjdk version "17.x.x"</code></p>
<p><strong>Maven 3.6 or higher</strong> - <strong>Why Maven?</strong>
Spring Boot projects traditionally use Maven for dependency management.
While Gradle is an alternative, Maven’s declarative approach and
extensive plugin ecosystem make it ideal for our complex dependency
graph (Spring AI milestones, security libraries, database drivers,
etc.). - <strong>Installation</strong>: Often bundled with Java IDEs, or
download from <a href="https://maven.apache.org/">maven.apache.org</a> -
<strong>Note</strong>: CareConnect includes Maven Wrapper
(<code>mvnw</code>), so Maven installation is optional—the wrapper
downloads the correct version automatically. -
<strong>Verification</strong>: <code>./mvnw -version</code> (uses
wrapper) or <code>mvn -version</code> (uses system Maven)</p>
<p><strong>PostgreSQL 15 or higher</strong> (previously MySQL, recently
migrated) - <strong>Why PostgreSQL?</strong> Superior support for JSON
columns (storing flexible health data), better ACID compliance (critical
for medical records), more robust handling of concurrent transactions
(multiple caregivers accessing same patient data). - <strong>Why not
MySQL?</strong> MySQL was the original database, but PostgreSQL’s
advanced features (JSONB indexing, row-level security, materialized
views) better support our analytics and reporting needs. -
<strong>Installation</strong>: - <strong>macOS</strong>:
<code>brew install postgresql@15</code> - <strong>Windows</strong>:
Download installer from <a
href="https://www.postgresql.org/download/windows/">postgresql.org</a> -
<strong>Linux</strong>: <code>sudo apt install postgresql-15</code>
(Ubuntu/Debian) - <strong>Docker</strong>:
<code>docker run -d -p 5432:5432 -e POSTGRES_PASSWORD=postgres postgres:15</code>
- <strong>Verification</strong>: <code>psql --version</code> should show
PostgreSQL 15.x</p>
<p><strong>Git (latest version)</strong> - <strong>Why Git?</strong>
Version control is essential for team collaboration. CareConnect uses
GitHub for source control, CI/CD, and issue tracking. -
<strong>Installation</strong>: Download from <a
href="https://git-scm.com/">git-scm.com</a> -
<strong>Configuration</strong>: After installation, configure your
identity:
<code>bash   git config --global user.name "Your Name"   git config --global user.email "your.email@example.com"</code>
- <strong>Verification</strong>: <code>git --version</code></p>
<p><strong>Integrated Development Environment (IDE)</strong> -
<strong>VS Code</strong>: Lightweight, excellent Flutter support via
extensions, fast startup. Recommended for frontend development. -
Required extensions: “Flutter”, “Dart” - Recommended: “GitLens”, “Error
Lens”, “Prettier”</p>
<ul>
<li><strong>Android Studio</strong>: Official Android IDE, includes
Android SDK and emulator. Best for testing Android-specific features.
<ul>
<li>Includes Flutter plugin</li>
<li>Required for Android builds</li>
</ul></li>
<li><strong>IntelliJ IDEA</strong>: Powerful Java IDE, excellent Spring
Boot integration. Recommended for backend development.
<ul>
<li>Ultimate edition has better Spring support (paid)</li>
<li>Community edition works fine for basic development (free)</li>
<li>Required plugins: “Spring Boot”, “JPA Buddy”</li>
</ul></li>
</ul>
<p><strong>Why multiple IDEs?</strong> Different tools excel at
different tasks. VS Code is fast for quick frontend edits, Android
Studio is essential for mobile debugging, IntelliJ is unmatched for
Spring Boot refactoring. Most developers keep all three installed and
use whichever fits the current task.</p>
<h3 id="clone-and-initial-setup">Clone and Initial Setup</h3>
<h4 id="clone-the-repository">1. Clone the Repository</h4>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Clone from GitHub (use SSH if you have SSH keys configured)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/umgc/2025_fall.git</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> 2025_fall/careconnect2025</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Or use HTTPS</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/umgc/2025_fall.git</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> 2025_fall/careconnect2025</span></code></pre></div>
<p><strong>Repository Structure Overview</strong>: The repository
contains multiple projects: - <code>careconnect2025/frontend/</code> -
Flutter mobile/web application -
<code>careconnect2025/backend/core/</code> - Spring Boot backend API -
<code>careconnect2025/terraform_aws/</code> - Infrastructure as Code for
AWS deployment - <code>careconnect2025/docs/</code> - Documentation
including this guide</p>
<h4 id="set-up-postgresql-database">2. Set Up PostgreSQL Database</h4>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Start PostgreSQL (if not already running)</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># macOS: brew services start postgresql@15</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Linux: sudo systemctl start postgresql</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Windows: Start from Services or PostgreSQL menu</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create database and user</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="ex">psql</span> <span class="at">-U</span> postgres  <span class="co"># Connect as postgres superuser</span></span></code></pre></div>
<p>Then in the psql prompt:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Create dedicated database for CareConnect</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">DATABASE</span> careconnect;</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- Create dedicated user (security best practice: don&#39;t use postgres superuser)</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="fu">USER</span> careconnect <span class="kw">WITH</span> ENCRYPTED <span class="kw">PASSWORD</span> <span class="st">&#39;your_secure_password_here&#39;</span>;</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- Grant all privileges on the database to the user</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="kw">GRANT</span> <span class="kw">ALL</span> <span class="kw">PRIVILEGES</span> <span class="kw">ON</span> <span class="kw">DATABASE</span> careconnect <span class="kw">TO</span> careconnect;</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">-- Grant schema creation (needed for Flyway migrations)</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="kw">GRANT</span> <span class="kw">CREATE</span> <span class="kw">ON</span> <span class="kw">DATABASE</span> careconnect <span class="kw">TO</span> careconnect;</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">-- Exit psql</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>\q</span></code></pre></div>
<p><strong>Why a dedicated user?</strong> In production, the application
should never connect as the postgres superuser. Using a limited user
means even if the application is compromised, attackers can’t drop other
databases or modify PostgreSQL settings. This principle of least
privilege is a security best practice.</p>
<p><strong>Why this password?</strong> For local development, use a
simple password. For production, environment variables provide secure
passwords.</p>
<h4 id="configure-backend-environment">3. Configure Backend
Environment</h4>
<p>Create
<code>backend/core/src/main/resources/application-dev.properties</code>:</p>
<pre class="properties"><code># Database Configuration
# JDBC URL points to local PostgreSQL instance
spring.datasource.url=jdbc:postgresql://localhost:5432/careconnect
spring.datasource.username=careconnect
spring.datasource.password=your_secure_password_here
spring.datasource.driver-class-name=org.postgresql.Driver

# JPA Configuration
# ddl-auto=update automatically creates/updates tables based on @Entity classes
# This is convenient for development but NEVER use in production
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true  # Log all SQL queries (helpful for debugging)
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
spring.jpa.properties.hibernate.format_sql=true  # Pretty-print SQL in logs

# Server Configuration
server.port=8080  # Backend listens on port 8080
server.servlet.context-path=/  # Root path (no prefix like /api)

# JWT Configuration
# IMPORTANT: Generate a strong secret for development
# openssl rand -base64 32  # Use this command to generate
jwt.secret=YourStrongJwtSecretKeyHereMinimum32CharactersLong
jwt.expiration=86400000  # 24 hours in milliseconds

# CORS Configuration
# Allow frontend to connect from these origins during development
cors.allowed-origins=http://localhost:3000,http://localhost:50030,http://127.0.0.1:3000

# Logging
logging.level.com.careconnect=DEBUG  # Verbose logging for our code
logging.level.org.springframework.web=DEBUG  # See all HTTP requests
logging.level.org.hibernate.SQL=DEBUG  # See all SQL queries

# Development-specific settings
spring.devtools.restart.enabled=true  # Auto-restart on code changes
spring.jpa.properties.hibernate.show_sql=true</code></pre>
<p><strong>Critical Settings Explained</strong>: -
<code>ddl-auto=update</code>: Automatically creates tables when you run
the app. Convenient but dangerous—doesn’t handle schema changes well,
can cause data loss. Use Flyway migrations in production. -
<code>show-sql=true</code>: Logs every SQL query. Essential for
debugging but creates huge logs in production—disable there. -
<code>jwt.secret</code>: Must be at least 32 characters for HS256
algorithm. In production, load from environment variable, not
hardcoded.</p>
<h4 id="set-up-frontend-environment">4. Set Up Frontend Environment</h4>
<p>Create <code>frontend/.env</code>:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># API Configuration</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># These differ by platform because of how emulators handle localhost</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="va">CC_BASE_URL_WEB</span><span class="op">=</span>http://localhost:8080        <span class="co"># Web app running in browser</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="va">CC_BASE_URL_ANDROID</span><span class="op">=</span>http://10.0.2.2:8080     <span class="co"># Android emulator special IP</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="va">CC_BASE_URL_IOS</span><span class="op">=</span>http://localhost:8080        <span class="co"># iOS simulator</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="va">CC_BASE_URL_OTHER</span><span class="op">=</span>http://localhost:8080      <span class="co"># Desktop platforms</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># JWT Configuration (must match backend)</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="va">JWT_SECRET</span><span class="op">=</span>YourStrongJwtSecretKeyHereMinimum32CharactersLong</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co"># AI Services (optional for basic development)</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="va">DEEPSEEK_API_KEY</span><span class="op">=</span>your_deepseek_api_key_here  <span class="co"># Only needed for AI features</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="va">OPENAI_API_KEY</span><span class="op">=</span>your_openai_api_key_here      <span class="co"># Only needed for AI chat</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Backend Authentication</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="va">CC_BACKEND_TOKEN</span><span class="op">=</span>your_backend_token  <span class="co"># For server-to-server communication</span></span></code></pre></div>
<p><strong>Platform-Specific Base URLs</strong>: - Web: Uses standard
<code>localhost:8080</code> - Android emulator: Uses
<code>10.0.2.2</code> which is a special IP that the Android emulator
maps to the host machine’s <code>localhost</code> - iOS simulator: Can
use <code>localhost</code> directly because it shares the host’s
network</p>
<p>The app automatically selects the correct URL based on the platform
it’s running on.</p>
<h4 id="install-dependencies">5. Install Dependencies</h4>
<p><strong>Backend</strong>:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> backend/core</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Using Maven Wrapper (recommended - uses exact version project needs)</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="ex">./mvnw</span> clean install</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co"># This downloads all dependencies from Maven Central and Spring repositories</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># First time takes 5-10 minutes depending on internet speed</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Subsequent runs are fast (dependencies are cached in ~/.m2/repository)</span></span></code></pre></div>
<p><strong>Frontend</strong>:</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> frontend</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Download all Dart packages declared in pubspec.yaml</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="ex">flutter</span> pub get</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify Flutter setup</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="ex">flutter</span> doctor <span class="at">-v</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co"># This checks:</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ✓ Flutter SDK installed</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co"># ✓ Android toolchain (if you want Android builds)</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co"># ✓ Xcode (macOS only, if you want iOS builds)</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="co"># ✓ Chrome (for web builds)</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co"># ✓ VS Code / Android Studio (optional)</span></span></code></pre></div>
<p><strong>Understanding <code>flutter doctor</code> output</strong>: -
✓ Green checkmark: All good - ⚠ Yellow warning: Optional feature not
configured (e.g., iOS on Windows) - ✗ Red X: Required component missing
or broken</p>
<h4 id="run-and-verify">6. Run and Verify</h4>
<p><strong>Start Backend</strong>:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> backend/core</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Run with development profile</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="ex">./mvnw</span> spring-boot:run <span class="at">-Dspring-boot.run.profiles</span><span class="op">=</span>dev</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Or run the JAR directly after building</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="ex">./mvnw</span> clean package</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="ex">java</span> <span class="at">-jar</span> target/careconnect-backend-1.0.0.jar <span class="at">--spring.profiles.active</span><span class="op">=</span>dev</span></code></pre></div>
<p><strong>Verify backend is running</strong>:</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check health endpoint</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> http://localhost:8080/actuator/health</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Should return: {&quot;status&quot;:&quot;UP&quot;}</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Check API documentation</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Open browser to: http://localhost:8080/swagger-ui/index.html</span></span></code></pre></div>
<p><strong>Start Frontend</strong>:</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> frontend</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Run on Chrome (web)</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="ex">flutter</span> run <span class="at">-d</span> chrome</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Run on Android emulator (start emulator first from Android Studio)</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="ex">flutter</span> run <span class="at">-d</span> emulator-5554</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Run on iOS simulator (macOS only)</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="ex">flutter</span> run <span class="at">-d</span> iPhone</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Run on desktop (current OS)</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="ex">flutter</span> run <span class="at">-d</span> macos  <span class="co"># or windows, or linux</span></span></code></pre></div>
<p><strong>Common First-Run Issues</strong>: - “Connection refused”:
Backend not running or wrong port - “CORS error”: Check
<code>cors.allowed-origins</code> in backend properties - “401
Unauthorized”: Frontend using wrong API key or backend JWT secret
mismatch - “Database connection failed”: PostgreSQL not running or wrong
credentials</p>
<h4 id="verify-full-stack-integration">7. Verify Full Stack
Integration</h4>
<p>Once both frontend and backend are running:</p>
<ol type="1">
<li><p><strong>Open the app</strong> (automatically opens in
Flutter)</p></li>
<li><p><strong>Navigate to login screen</strong></p></li>
<li><p><strong>Register a new account</strong>:</p>
<ul>
<li>Email: <code>test@example.com</code></li>
<li>Password: <code>password123</code></li>
<li>Name: <code>Test User</code></li>
</ul></li>
<li><p><strong>Verify you’re redirected to dashboard</strong></p></li>
<li><p><strong>Check backend logs</strong> - should see:</p>
<pre><code>INFO - User test@example.com registered
INFO - JWT token generated for user test@example.com
DEBUG - SELECT * FROM users WHERE email = &#39;test@example.com&#39;</code></pre></li>
</ol>
<p>If all this works, your development environment is fully
configured!</p>
<h3 id="development-workflow">Development Workflow</h3>
<p><strong>Typical Development Session</strong>:</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Terminal 1: Backend</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> backend/core</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="ex">./mvnw</span> spring-boot:run</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Terminal 2: Frontend</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> frontend</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="ex">flutter</span> run <span class="at">-d</span> chrome</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Terminal 3: Database (if needed)</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="ex">psql</span> <span class="at">-U</span> careconnect <span class="at">-d</span> careconnect</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Make code changes</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Backend: Changes auto-reload with spring-devtools</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Frontend: Hot reload with &#39;r&#39; in terminal, hot restart with &#39;R&#39;</span></span></code></pre></div>
<p><strong>Pro Tips</strong>: - Use IDE debuggers instead of print
statements for complex issues - Run <code>flutter analyze</code> before
committing to catch Dart warnings - Run <code>./mvnw verify</code>
before pushing to catch Java issues - Keep backend logs visible to see
API calls as you interact with frontend - Use browser DevTools (F12) to
inspect API requests/responses</p>
<h3 id="project-structure">Project Structure</h3>
<pre><code>careconnect2025/
├── frontend/                   # Flutter application
│   ├── lib/
│   │   ├── config/            # Configuration files
│   │   ├── features/          # Feature modules
│   │   ├── models/            # Data models
│   │   ├── providers/         # State management
│   │   ├── services/          # API services
│   │   └── main.dart          # App entry point
│   ├── assets/                # Static assets
│   ├── test/                  # Unit tests
│   └── pubspec.yaml           # Dependencies
├── backend/                   # Spring Boot application
│   └── core/
│       ├── src/main/java/com/careconnect/
│       │   ├── controller/    # REST controllers
│       │   ├── service/       # Business logic
│       │   ├── repository/    # Data access
│       │   ├── model/         # Entity models
│       │   ├── dto/           # Data transfer objects
│       │   ├── config/        # Configuration
│       │   └── exception/     # Exception handling
│       ├── src/main/resources/ # Configuration files
│       └── pom.xml            # Maven dependencies
├── terraform_aws/             # AWS infrastructure
└── docs/                      # Documentation</code></pre>
<h3 id="environment-configuration">Environment Configuration</h3>
<h4 id="frontend-environment-.env">Frontend Environment (.env)</h4>
<div class="sourceCode" id="cb15"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># API Configuration</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="va">CC_BASE_URL_WEB</span><span class="op">=</span>http://localhost:8080</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="va">CC_BASE_URL_ANDROID</span><span class="op">=</span>http://10.0.2.2:8080</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="va">CC_BASE_URL_OTHER</span><span class="op">=</span>http://localhost:8080</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co"># JWT Configuration</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="va">JWT_SECRET</span><span class="op">=</span>your_jwt_secret_key_here</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co"># AI Services</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="va">DEEPSEEK_API_KEY</span><span class="op">=</span>your_deepseek_api_key</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="va">OPENAI_API_KEY</span><span class="op">=</span>your_openai_api_key</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Backend Authentication</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="va">CC_BACKEND_TOKEN</span><span class="op">=</span>your_backend_token</span></code></pre></div>
<h4 id="backend-configuration-application.properties">Backend
Configuration (application.properties)</h4>
<pre class="properties"><code># Database Configuration
spring.datasource.url=jdbc:postgresql://localhost:5432/careconnect
spring.datasource.username=careconnect
spring.datasource.password=your_password
spring.datasource.driver-class-name=org.postgresql.Driver

# JPA Configuration
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect

# Server Configuration
server.port=8080
server.servlet.context-path=/

# JWT Configuration
jwt.secret=your_jwt_secret_key_32_characters_minimum
jwt.expiration=86400000

# CORS Configuration
cors.allowed-origins=http://localhost:3000,http://localhost:50030,http://127.0.0.1:3000</code></pre>
<h2 id="frontend-development-flutter">Frontend Development
(Flutter)</h2>
<h3 id="project-architecture">Project Architecture</h3>
<p>The frontend follows a feature-based modular architecture:</p>
<pre><code>lib/
├── config/                    # App configuration
│   ├── environment_config.dart
│   ├── network/
│   └── theme/
├── features/                  # Feature modules
│   ├── auth/                  # Authentication
│   ├── dashboard/             # Main dashboard
│   ├── health/                # Health tracking
│   ├── communication/         # Messaging &amp; calls
│   ├── social/                # Social features
│   └── [feature_name]/
│       ├── data/              # Data layer
│       ├── models/            # Domain models
│       ├── presentation/      # UI layer
│       └── services/          # Feature services
├── shared/                    # Shared components
│   ├── widgets/
│   ├── utils/
│   └── constants/
└── main.dart</code></pre>
<h3 id="state-management-with-provider">State Management with
Provider</h3>
<p>CareConnect uses the Provider package for state management, selected
for its simplicity, excellent documentation, and suitability for our
mid-complexity application. It follows the inherited widget pattern,
making state accessible across the widget tree without excessive
boilerplate—a key consideration when building healthcare UIs that need
to share patient data across many screens.</p>
<h4
id="architectural-pattern-feature-specific-changenotifiers">Architectural
Pattern: Feature-Specific ChangeNotifiers</h4>
<p>We implement a single, feature-specific ChangeNotifier for each major
domain (e.g., AuthProvider, HealthDataProvider). This encapsulates all
state and business logic related to that feature, following the single
responsibility principle and making the codebase easier to navigate for
developers new to the project.</p>
<h4 id="key-implementation-details">Key Implementation Details</h4>
<p><strong>Private State Variables</strong>: All state variables (like
<code>_currentUser</code>, <code>_isLoading</code>) are prefixed with
underscore, making them private to the provider class. This prevents
external mutation and ensures all changes go through controlled
methods—critical for maintaining data integrity in a healthcare
application where unauthorized state changes could have serious
consequences.</p>
<p><strong>Public Getters for Read-Only Access</strong>: We expose state
via public getters (e.g., <code>User? get currentUser</code>). This
provides read-only access to the UI, enforcing a unidirectional data
flow that makes the application’s behavior predictable and
debuggable.</p>
<p><strong>State Modification Through Public Methods</strong>: State is
only changed within public methods (e.g., <code>login()</code>,
<code>logout()</code>). These methods are responsible for: - <strong>API
Communication</strong>: Calling the appropriate service layer methods -
<strong>State Updates</strong>: Modifying the private variables based on
the result - <strong>Persistence</strong>: Managing local storage of
tokens or user data for offline access - <strong>Notifications</strong>:
Calling <code>notifyListeners()</code> to inform the UI of state changes
and trigger rebuilds</p>
<h4 id="example-authentication-flow-in-authprovider">Example:
Authentication Flow in AuthProvider</h4>
<p>Below is the complete authentication flow, demonstrating how a user
login request flows through the provider:</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">// providers/auth_provider.dart</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AuthProvider <span class="kw">extends</span> ChangeNotifier {</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  User<span class="op">?</span> _currentUser;</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> _isLoading <span class="op">=</span> <span class="cn">false</span>;</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">String</span><span class="op">?</span> _error;</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Public interface for the UI to access state</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  User<span class="op">?</span> <span class="kw">get</span> currentUser <span class="op">=&gt;</span> _currentUser;</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> <span class="kw">get</span> isLoading <span class="op">=&gt;</span> _isLoading;</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">String</span><span class="op">?</span> <span class="kw">get</span> error <span class="op">=&gt;</span> _error;</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> login(<span class="dt">String</span> email<span class="op">,</span> <span class="dt">String</span> password) <span class="at">async</span> {</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 1. Signal the start of an async operation</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">//    This allows the UI to show a loading indicator</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    _setLoading(<span class="cn">true</span>);</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    _clearError();</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>      <span class="co">// 2. Delegate the network call to the service layer</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>      <span class="co">//    Separation of concerns: providers handle state, services handle API</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">final</span> response <span class="op">=</span> <span class="at">await</span> _authService<span class="op">.</span>login(email<span class="op">,</span> password);</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>      <span class="co">// 3. Update the app state on success</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>      <span class="co">//    Store the authenticated user for access throughout the app</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>      _currentUser <span class="op">=</span> response<span class="op">.</span>user;</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>      <span class="co">// 4. Persist authentication tokens securely</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>      <span class="co">//    This enables the user to stay logged in between sessions</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">await</span> _tokenManager<span class="op">.</span>saveTokens(response<span class="op">.</span>tokens);</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>      <span class="co">// 5. Clear any previous errors</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>      _error <span class="op">=</span> <span class="cn">null</span>;</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (e) {</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>      <span class="co">// 6. Handle errors and update state accordingly</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>      <span class="co">//    Provide user-friendly error messages rather than raw exceptions</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>      _setError(<span class="st">&#39;Login failed: Please check your credentials.&#39;</span>);</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>      <span class="co">// 7. Log the error for debugging while keeping sensitive data private</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>      _logger<span class="op">.</span>error(<span class="st">&#39;Login failed for email: $email&#39;</span><span class="op">,</span> error<span class="op">:</span> e);</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">finally</span> {</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>      <span class="co">// 8. Signal the end of the operation</span></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>      <span class="co">//    This ensures the loading state is cleared even if an error occurred</span></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>      _setLoading(<span class="cn">false</span>);</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Private method to handle loading state consistently</span></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>  <span class="co">// By centralizing this logic, we ensure notifyListeners() is never forgotten</span></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> _setLoading(<span class="dt">bool</span> loading) {</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>    _isLoading <span class="op">=</span> loading;</span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>    notifyListeners(); <span class="co">// This is what tells all listening widgets to rebuild</span></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> _clearError() {</span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>    _error <span class="op">=</span> <span class="cn">null</span>;</span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>    notifyListeners();</span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> _setError(<span class="dt">String</span> error) {</span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>    _error <span class="op">=</span> error;</span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>    notifyListeners();</span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h4 id="usage-in-ui">Usage in UI</h4>
<p>A LoginScreen would use
<code>context.watch&lt;AuthProvider&gt;()</code> to listen to this state
and react accordingly:</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LoginScreen <span class="kw">extends</span> StatelessWidget {</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  Widget build(BuildContext context) {</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Watch the provider - this widget rebuilds when the provider notifies</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">final</span> authProvider <span class="op">=</span> context<span class="op">.</span>watch<span class="op">&lt;</span>AuthProvider<span class="op">&gt;</span>();</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// React to different states</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (authProvider<span class="op">.</span>isLoading) {</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">return</span> LoadingSpinner(); <span class="co">// Show loading during authentication</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (authProvider<span class="op">.</span>error <span class="op">!=</span> <span class="cn">null</span>) {</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">return</span> ErrorMessage(authProvider<span class="op">.</span>error<span class="op">!</span>); <span class="co">// Show user-friendly error</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (authProvider<span class="op">.</span>currentUser <span class="op">!=</span> <span class="cn">null</span>) {</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Navigate to dashboard on successful login</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>      WidgetsBinding<span class="op">.</span>instance<span class="op">.</span>addPostFrameCallback((_) {</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>        context<span class="op">.</span>go(<span class="st">&#39;/dashboard&#39;</span>);</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>      });</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> LoginForm(); <span class="co">// Show the login form</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This pattern ensures that authentication state flows in one direction
(provider → UI), making it easy to reason about when and why the UI
updates—a critical feature when dealing with sensitive healthcare data
that requires precise access control.</p>
<h3 id="routing-configuration-with-gorouter">Routing Configuration with
GoRouter</h3>
<p>CareConnect uses GoRouter for declarative navigation, chosen for its
type-safe routing, deep linking support, and excellent integration with
Flutter’s navigation 2.0 API. In a healthcare app where users might need
to navigate directly to specific patient records or appointment details
(via links from emails or notifications), GoRouter’s URL-based routing
is particularly valuable.</p>
<h4 id="why-gorouter-over-navigator-1.0">Why GoRouter Over Navigator
1.0?</h4>
<p>Traditional Flutter navigation (Navigator 1.0) uses an imperative
stack-based approach. While simple for basic apps, it becomes unwieldy
for complex navigation flows. GoRouter provides:</p>
<ul>
<li><strong>URL-based routing</strong>: Each screen has a path (e.g.,
<code>/dashboard/health</code>) that can be bookmarked or linked</li>
<li><strong>Type-safe parameters</strong>: Pass data between screens
with compile-time safety</li>
<li><strong>Declarative redirects</strong>: Guard routes based on
authentication state without repetitive checks</li>
<li><strong>Deep linking</strong>: Users can jump directly to specific
screens from external links</li>
<li><strong>Nested navigation</strong>: Complex tab structures (like our
dashboard with sub-tabs) are easier to manage</li>
</ul>
<p>In healthcare, where clinicians might need to quickly navigate to a
specific patient’s recent vitals from an alert notification, this
URL-based approach is much more robust than trying to programmatically
push the right sequence of screens onto a stack.</p>
<h4 id="core-routing-structure">Core Routing Structure</h4>
<div class="sourceCode" id="cb20"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">// config/router_config.dart</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="at">final</span> GoRouter routerConfig <span class="op">=</span> GoRouter(</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Starting point when app launches</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  initialLocation<span class="op">:</span> <span class="st">&#39;/splash&#39;</span><span class="op">,</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Define all app routes</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  routes<span class="op">:</span> [</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    GoRoute(</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>      path<span class="op">:</span> <span class="st">&#39;/splash&#39;</span><span class="op">,</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>      builder<span class="op">:</span> (context<span class="op">,</span> state) <span class="op">=&gt;</span> <span class="at">const</span> SplashScreen()<span class="op">,</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    )<span class="op">,</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    GoRoute(</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>      path<span class="op">:</span> <span class="st">&#39;/login&#39;</span><span class="op">,</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>      builder<span class="op">:</span> (context<span class="op">,</span> state) <span class="op">=&gt;</span> <span class="at">const</span> LoginScreen()<span class="op">,</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    )<span class="op">,</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Main dashboard with nested routes</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    GoRoute(</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>      path<span class="op">:</span> <span class="st">&#39;/dashboard&#39;</span><span class="op">,</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>      builder<span class="op">:</span> (context<span class="op">,</span> state) <span class="op">=&gt;</span> <span class="at">const</span> DashboardScreen()<span class="op">,</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Nested routes appear as tabs or sections within dashboard</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>      routes<span class="op">:</span> [</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>        GoRoute(</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>          path<span class="op">:</span> <span class="st">&#39;health&#39;</span><span class="op">,</span>  <span class="co">// Full path: /dashboard/health</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>          builder<span class="op">:</span> (context<span class="op">,</span> state) <span class="op">=&gt;</span> <span class="at">const</span> HealthScreen()<span class="op">,</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>        )<span class="op">,</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>        GoRoute(</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>          path<span class="op">:</span> <span class="st">&#39;messages&#39;</span><span class="op">,</span>  <span class="co">// Full path: /dashboard/messages</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>          builder<span class="op">:</span> (context<span class="op">,</span> state) <span class="op">=&gt;</span> <span class="at">const</span> MessagesScreen()<span class="op">,</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>        )<span class="op">,</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Parameterized route - accepts dynamic patient ID</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>        GoRoute(</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>          path<span class="op">:</span> <span class="st">&#39;patient/:id&#39;</span><span class="op">,</span>  <span class="co">// Full path: /dashboard/patient/123</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>          builder<span class="op">:</span> (context<span class="op">,</span> state) {</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Extract the ID from the URL</span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>            <span class="at">final</span> patientId <span class="op">=</span> state<span class="op">.</span>pathParameters[<span class="st">&#39;id&#39;</span>]<span class="op">!</span>;</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> PatientDetailScreen(patientId<span class="op">:</span> patientId);</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>          }<span class="op">,</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>        )<span class="op">,</span></span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>      ]<span class="op">,</span></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>    )<span class="op">,</span></span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">,</span></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Global navigation guard - runs before every route</span></span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>  redirect<span class="op">:</span> (context<span class="op">,</span> state) {</span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check authentication status from our AuthProvider</span></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">final</span> isLoggedIn <span class="op">=</span> context<span class="op">.</span>read<span class="op">&lt;</span>AuthProvider<span class="op">&gt;</span>()<span class="op">.</span>currentUser <span class="op">!=</span> <span class="cn">null</span>;</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">final</span> isGoingToLogin <span class="op">=</span> state<span class="op">.</span>uri<span class="op">.</span>path <span class="op">==</span> <span class="st">&#39;/login&#39;</span>;</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">final</span> isGoingToSplash <span class="op">=</span> state<span class="op">.</span>uri<span class="op">.</span>path <span class="op">==</span> <span class="st">&#39;/splash&#39;</span>;</span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Logic: Unauthenticated users can only access login and splash</span></span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>isLoggedIn <span class="op">&amp;&amp;</span> <span class="op">!</span>isGoingToLogin <span class="op">&amp;&amp;</span> <span class="op">!</span>isGoingToSplash) {</span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>      <span class="co">// User trying to access protected route without login - redirect to login</span></span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>      <span class="kw">return</span> <span class="st">&#39;/login&#39;</span>;</span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Logic: Authenticated users shouldn&#39;t see login screen</span></span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (isLoggedIn <span class="op">&amp;&amp;</span> isGoingToLogin) {</span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Already logged in, redirect to dashboard instead</span></span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>      <span class="kw">return</span> <span class="st">&#39;/dashboard&#39;</span>;</span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>    <span class="co">// No redirect needed - allow navigation to proceed</span></span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="cn">null</span>;</span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<h4 id="understanding-the-redirect-guard">Understanding the Redirect
Guard</h4>
<p>The <code>redirect</code> function is CareConnect’s authentication
barrier. It runs before every navigation:</p>
<p><strong>Scenario 1: Unauthenticated User Tries to Access
Dashboard</strong> 1. User navigates to <code>/dashboard</code> 2.
Redirect guard checks: <code>isLoggedIn = false</code>,
<code>isGoingToLogin = false</code> 3. Guard returns
<code>/login</code>, overriding the original destination 4. User lands
on login screen instead of dashboard</p>
<p><strong>Scenario 2: User Logs In Successfully</strong> 1. Login
completes, <code>AuthProvider.currentUser</code> is set 2. App tries to
navigate to <code>/login</code> (where they currently are) 3. Redirect
guard checks: <code>isLoggedIn = true</code>,
<code>isGoingToLogin = true</code> 4. Guard returns
<code>/dashboard</code>, redirecting them away from login 5. User
automatically lands on dashboard</p>
<p><strong>Scenario 3: Deep Link from Email</strong> 1. User clicks
link: <code>careconnect://app/dashboard/patient/456</code> 2. App
launches, redirect guard checks authentication 3. If not logged in:
redirected to <code>/login</code>, but the intended destination is
remembered 4. After login, guard allows navigation to
<code>/dashboard/patient/456</code> 5. User lands exactly where the link
intended</p>
<p>This pattern ensures: - Protected routes require authentication -
Authenticated users don’t get stuck on login screen - Deep links work
correctly after authentication - No need to check authentication in
every screen’s build method</p>
<h4 id="programmatic-navigation-in-code">Programmatic Navigation in
Code</h4>
<p>Components navigate using <code>context.go()</code> and
<code>context.push()</code>:</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Replace current route (can&#39;t go back)</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>context<span class="op">.</span>go(<span class="st">&#39;/dashboard/health&#39;</span>);</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Push new route (can go back with back button)</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>context<span class="op">.</span>push(<span class="st">&#39;/dashboard/patient/123&#39;</span>);</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Navigate with named parameters</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>context<span class="op">.</span>goNamed(</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;patientDetail&#39;</span><span class="op">,</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  pathParameters<span class="op">:</span> {<span class="st">&#39;id&#39;</span><span class="op">:</span> <span class="st">&#39;123&#39;</span>}<span class="op">,</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  queryParameters<span class="op">:</span> {<span class="st">&#39;tab&#39;</span><span class="op">:</span> <span class="st">&#39;vitals&#39;</span>}<span class="op">,</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Go back</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>context<span class="op">.</span>pop();</span></code></pre></div>
<p><strong>When to use <code>go</code> vs <code>push</code></strong>: -
<strong>go()</strong>: Replaces the route (like after login - don’t want
back button to return to login) - <strong>push()</strong>: Adds to
history (like opening a patient detail - want back button to return to
list)</p>
<h4 id="handling-deep-links-from-notifications">Handling Deep Links from
Notifications</h4>
<p>Healthcare notifications often need to navigate directly to relevant
data:</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">// When notification is tapped:</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> handleNotificationTap(<span class="dt">String</span> type<span class="op">,</span> <span class="dt">String</span> id) {</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span> (type) {</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;vital_alert&#39;</span><span class="op">:</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Navigate directly to patient&#39;s vitals</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>      context<span class="op">.</span>go(<span class="st">&#39;/dashboard/patient/$id?tab=vitals&#39;</span>);</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span>;</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;message&#39;</span><span class="op">:</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Navigate to specific conversation</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>      context<span class="op">.</span>go(<span class="st">&#39;/dashboard/messages/$id&#39;</span>);</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span>;</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;appointment&#39;</span><span class="op">:</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Navigate to appointment detail</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>      context<span class="op">.</span>go(<span class="st">&#39;/dashboard/appointments/$id&#39;</span>);</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span>;</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The URL-based routing makes these deep links trivial to implement and
maintain.</p>
<h4 id="error-handling">Error Handling</h4>
<p>GoRouter includes built-in error handling for invalid routes:</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>GoRouter(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ... routes ...</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Called when navigation to unknown route</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  errorBuilder<span class="op">:</span> (context<span class="op">,</span> state) {</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> ErrorScreen(</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>      message<span class="op">:</span> <span class="st">&#39;Page not found: ${state.uri.path}&#39;</span><span class="op">,</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>      onRetry<span class="op">:</span> () <span class="op">=&gt;</span> context<span class="op">.</span>go(<span class="st">&#39;/dashboard&#39;</span>)<span class="op">,</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    );</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<p>This ensures users never see a blank screen, even if they manually
type an invalid URL or follow a broken link.</p>
<h4 id="testing-considerations">Testing Considerations</h4>
<p>GoRouter makes navigation testing straightforward:</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>testWidgets(<span class="st">&#39;redirects unauthenticated users to login&#39;</span><span class="op">,</span> (tester) <span class="at">async</span> {</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Start with no authenticated user</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">await</span> tester<span class="op">.</span>pumpWidget(MyApp());</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Try to navigate to dashboard</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  routerConfig<span class="op">.</span>go(<span class="st">&#39;/dashboard&#39;</span>);</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">await</span> tester<span class="op">.</span>pumpAndSettle();</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Verify we&#39;re on login instead</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  expect(find<span class="op">.</span>text(<span class="st">&#39;Login&#39;</span>)<span class="op">,</span> findsOneWidget);</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  expect(find<span class="op">.</span>text(<span class="st">&#39;Dashboard&#39;</span>)<span class="op">,</span> findsNothing);</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>});</span></code></pre></div>
<p>The declarative nature makes it easy to verify routing logic without
complex widget tree navigation.</p>
<h3 id="http-client-configuration-with-dio-and-interceptors">HTTP Client
Configuration with Dio and Interceptors</h3>
<p>CareConnect uses Dio as its HTTP client library instead of Flutter’s
built-in <code>http</code> package. This choice was made for Dio’s
powerful interceptor system, which is crucial for implementing
cross-cutting concerns like authentication, logging, and error handling
in a consistent, maintainable way.</p>
<h4 id="why-dio-over-built-in-http">Why Dio Over Built-in HTTP?</h4>
<p>While Flutter’s <code>http</code> package is simpler, Dio provides
essential features for a production healthcare app:</p>
<ul>
<li><strong>Interceptors</strong>: Modify requests/responses globally
(add auth tokens, log traffic, transform errors)</li>
<li><strong>Request cancellation</strong>: Cancel in-flight requests
when user navigates away (saves bandwidth, prevents race
conditions)</li>
<li><strong>File upload/download</strong>: Built-in support with
progress tracking (for medical records, lab results)</li>
<li><strong>Timeout configuration</strong>: Separate timeouts for
connect vs receive (important for slow hospital networks)</li>
<li><strong>Retry logic</strong>: Automatic retry with exponential
backoff (essential for reliability)</li>
<li><strong>FormData support</strong>: Multipart file uploads (medical
document uploads)</li>
</ul>
<p>In healthcare, where API calls might involve large files (MRI scans)
or need perfect reliability (medication orders), these features are not
luxuries—they’re requirements.</p>
<h4 id="dio-configuration-and-initialization">Dio Configuration and
Initialization</h4>
<div class="sourceCode" id="cb25"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">// config/network/api_client.dart</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ApiClient {</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">late</span> <span class="at">final</span> Dio _dio;</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  ApiClient() {</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Base configuration for all requests</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    _dio <span class="op">=</span> Dio(BaseOptions(</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Server URL from environment config (different for dev/staging/prod)</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>      baseUrl<span class="op">:</span> EnvironmentConfig<span class="op">.</span>baseUrl<span class="op">,</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Connection timeout: How long to wait to establish connection</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>      <span class="co">// 30 seconds accommodates slow hospital WiFi</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>      connectTimeout<span class="op">:</span> <span class="at">const</span> Duration(seconds<span class="op">:</span> <span class="dv">30</span>)<span class="op">,</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Receive timeout: How long to wait for response after connection</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>      <span class="co">// 30 seconds accommodates large payloads (lab results PDFs)</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>      receiveTimeout<span class="op">:</span> <span class="at">const</span> Duration(seconds<span class="op">:</span> <span class="dv">30</span>)<span class="op">,</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Default headers for all requests</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>      headers<span class="op">:</span> {</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span><span class="op">,</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Accept&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span><span class="op">,</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    ));</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add interceptors in order - they execute sequentially</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    _dio<span class="op">.</span>interceptors<span class="op">.</span>add(AuthInterceptor());      <span class="co">// 1. Add auth tokens</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    _dio<span class="op">.</span>interceptors<span class="op">.</span>add(LoggingInterceptor());   <span class="co">// 2. Log requests/responses</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>    _dio<span class="op">.</span>interceptors<span class="op">.</span>add(ErrorInterceptor());     <span class="co">// 3. Transform errors</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Expose dio instance for making requests</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>  Dio <span class="kw">get</span> dio <span class="op">=&gt;</span> _dio;</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h4 id="understanding-interceptors">Understanding Interceptors</h4>
<p>Interceptors in Dio work like middleware in Express or filters in
Spring Boot. Each interceptor can: - Inspect and modify outgoing
requests before they’re sent - Inspect and modify incoming responses
before they reach your code - Handle errors globally instead of in every
API call</p>
<p><strong>Interceptor Execution Order</strong>:</p>
<pre><code>Request Path:  Your Code → Auth → Logging → Error → Network
Response Path: Network → Error → Logging → Auth → Your Code</code></pre>
<h4
id="authentication-interceptor-automatic-token-injection">Authentication
Interceptor: Automatic Token Injection</h4>
<p>The authentication interceptor ensures every protected API call
includes the user’s JWT token, without developers needing to manually
add it to each request:</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AuthInterceptor <span class="kw">extends</span> Interceptor {</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> onRequest(RequestOptions options<span class="op">,</span> RequestInterceptorHandler handler) <span class="at">async</span> {</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Retrieve stored JWT token from secure storage</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">final</span> token <span class="op">=</span> <span class="at">await</span> TokenManager<span class="op">.</span>getAccessToken();</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (token <span class="op">!=</span> <span class="cn">null</span>) {</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Add Authorization header to every request</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>      options<span class="op">.</span>headers[<span class="st">&#39;Authorization&#39;</span>] <span class="op">=</span> <span class="st">&#39;Bearer $token&#39;</span>;</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Continue to next interceptor</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    handler<span class="op">.</span>next(options);</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> onError(DioException err<span class="op">,</span> ErrorInterceptorHandler handler) <span class="at">async</span> {</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Special case: If server returns 401 Unauthorized, token might be expired</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (err<span class="op">.</span>response<span class="op">?.</span>statusCode <span class="op">==</span> <span class="dv">401</span>) {</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Attempt to refresh the token using refresh token</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">final</span> refreshed <span class="op">=</span> <span class="at">await</span> TokenManager<span class="op">.</span>refreshToken();</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (refreshed) {</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Token refresh succeeded - retry the original request</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> {</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>          <span class="co">// Clone the original request with new token</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>          <span class="at">final</span> clonedRequest <span class="op">=</span> <span class="at">await</span> _dio<span class="op">.</span>fetch(err<span class="op">.</span>requestOptions);</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>          <span class="co">// Resolve with successful response</span></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>          handler<span class="op">.</span>resolve(clonedRequest);</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>          <span class="kw">return</span>;</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">catch</span> (e) {</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>          <span class="co">// Retry failed - fall through to error handling</span></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Token refresh failed - user needs to log in again</span></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Clear stored tokens and navigate to login</span></span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">await</span> TokenManager<span class="op">.</span>clearTokens();</span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Navigate to login screen</span></span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>        navigatorKey<span class="op">.</span>currentState<span class="op">?.</span>pushReplacementNamed(<span class="st">&#39;/login&#39;</span>);</span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">// For non-401 errors or failed token refresh, pass error to next handler</span></span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a>    handler<span class="op">.</span>next(err);</span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>What this achieves</strong>: 1. <strong>Automatic
authentication</strong>: Developers never forget to add tokens 2.
<strong>Transparent token refresh</strong>: If token expires
mid-session, app automatically refreshes it and retries the request—user
never notices 3. <strong>Graceful session expiration</strong>: If
refresh token also expired, user is smoothly redirected to login</p>
<p>This is particularly important in healthcare where a user might leave
the app open during a shift. When they return hours later, the app
automatically handles the expired token without losing their work.</p>
<h4 id="logging-interceptor-debugging-and-audit-trail">Logging
Interceptor: Debugging and Audit Trail</h4>
<p>The logging interceptor provides visibility into all network traffic,
essential for debugging API integration issues and maintaining audit
trails (required in healthcare):</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LoggingInterceptor <span class="kw">extends</span> Interceptor {</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> Logger _logger <span class="op">=</span> Logger(<span class="st">&#39;API&#39;</span>);</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> onRequest(RequestOptions options<span class="op">,</span> RequestInterceptorHandler handler) {</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Log outgoing request details</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    _logger<span class="op">.</span>info(<span class="st">&#39;➡️ ${options.method} ${options.uri}&#39;</span>);</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Log headers (excluding sensitive ones)</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    options<span class="op">.</span>headers<span class="op">.</span>forEach((key<span class="op">,</span> value) {</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>_isSensitiveHeader(key)) {</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>        _logger<span class="op">.</span>debug(<span class="st">&#39;Header: $key: $value&#39;</span>);</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    });</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Log request body (excluding sensitive data like passwords)</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (options<span class="op">.</span>data <span class="op">!=</span> <span class="cn">null</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>_containsSensitiveData(options<span class="op">.</span>path)) {</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>      _logger<span class="op">.</span>debug(<span class="st">&#39;Request body: ${options.data}&#39;</span>);</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    handler<span class="op">.</span>next(options);</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> onResponse(Response response<span class="op">,</span> ResponseInterceptorHandler handler) {</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Log successful response</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>    _logger<span class="op">.</span>info(<span class="st">&#39;✅ ${response.statusCode} ${response.requestOptions.uri}&#39;</span>);</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>    _logger<span class="op">.</span>debug(<span class="st">&#39;Response data: ${response.data}&#39;</span>);</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>    handler<span class="op">.</span>next(response);</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> onError(DioException err<span class="op">,</span> ErrorInterceptorHandler handler) {</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Log errors prominently</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>    _logger<span class="op">.</span>error(</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;❌ ${err.response?.statusCode ?? &#39;</span>ERROR<span class="st">&#39;} ${err.requestOptions.uri}&#39;</span><span class="op">,</span></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>      error<span class="op">:</span> err<span class="op">,</span></span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>    );</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (err<span class="op">.</span>response<span class="op">?.</span>data <span class="op">!=</span> <span class="cn">null</span>) {</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>      _logger<span class="op">.</span>error(<span class="st">&#39;Error response: ${err.response?.data}&#39;</span>);</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>    handler<span class="op">.</span>next(err);</span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> _isSensitiveHeader(<span class="dt">String</span> key) {</span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Don&#39;t log authorization tokens or API keys</span></span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> key<span class="op">.</span>toLowerCase() <span class="op">==</span> <span class="st">&#39;authorization&#39;</span> <span class="op">||</span> </span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>           key<span class="op">.</span>toLowerCase()<span class="op">.</span>contains(<span class="st">&#39;token&#39;</span>) <span class="op">||</span></span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>           key<span class="op">.</span>toLowerCase()<span class="op">.</span>contains(<span class="st">&#39;key&#39;</span>);</span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> _containsSensitiveData(<span class="dt">String</span> path) {</span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Don&#39;t log bodies of login/register requests (contain passwords)</span></span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> path<span class="op">.</span>contains(<span class="st">&#39;/auth/login&#39;</span>) <span class="op">||</span> </span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>           path<span class="op">.</span>contains(<span class="st">&#39;/auth/register&#39;</span>) <span class="op">||</span></span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a>           path<span class="op">.</span>contains(<span class="st">&#39;/password&#39;</span>);</span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Why this matters</strong>: In production, when a caregiver
reports “the app says patient data failed to load,” these logs let you
see exactly what request was made and what error the server returned,
dramatically speeding up debugging.</p>
<h4 id="error-interceptor-user-friendly-error-messages">Error
Interceptor: User-Friendly Error Messages</h4>
<p>The error interceptor transforms technical HTTP errors into
user-friendly messages, preventing users from seeing cryptic
“DioException: 500” errors:</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ErrorInterceptor <span class="kw">extends</span> Interceptor {</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> onError(DioException err<span class="op">,</span> ErrorInterceptorHandler handler) {</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Transform Dio errors into application-specific exceptions</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">String</span> message;</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (err<span class="op">.</span>type <span class="op">==</span> DioExceptionType<span class="op">.</span>connectionTimeout <span class="op">||</span> </span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>        err<span class="op">.</span>type <span class="op">==</span> DioExceptionType<span class="op">.</span>receiveTimeout) {</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Network timeout - likely slow connection or server overload</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>      message <span class="op">=</span> <span class="st">&#39;Connection timeout. Please check your internet connection and try again.&#39;</span>;</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (err<span class="op">.</span>type <span class="op">==</span> DioExceptionType<span class="op">.</span>badResponse) {</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Server returned an error status code</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">final</span> statusCode <span class="op">=</span> err<span class="op">.</span>response<span class="op">?.</span>statusCode;</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">switch</span> (statusCode) {</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="dv">400</span><span class="op">:</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>          <span class="co">// Bad request - show server&#39;s error message if available</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>          message <span class="op">=</span> err<span class="op">.</span>response<span class="op">?.</span>data[<span class="st">&#39;message&#39;</span>] <span class="op">??</span> </span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&#39;Invalid request. Please check your input.&#39;</span>;</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span>;</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="dv">401</span><span class="op">:</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>          <span class="co">// Unauthorized - handled by AuthInterceptor, but provide fallback</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>          message <span class="op">=</span> <span class="st">&#39;Authentication required. Please log in.&#39;</span>;</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span>;</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="dv">403</span><span class="op">:</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>          <span class="co">// Forbidden - user doesn&#39;t have permission</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>          message <span class="op">=</span> <span class="st">&#39;You do not have permission to access this resource.&#39;</span>;</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span>;</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="dv">404</span><span class="op">:</span></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>          <span class="co">// Not found - resource doesn&#39;t exist</span></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>          message <span class="op">=</span> <span class="st">&#39;The requested resource was not found.&#39;</span>;</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span>;</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="dv">500</span><span class="op">:</span></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="dv">502</span><span class="op">:</span></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="dv">503</span><span class="op">:</span></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>          <span class="co">// Server errors - show friendly message</span></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>          message <span class="op">=</span> <span class="st">&#39;Server error. Our team has been notified. Please try again later.&#39;</span>;</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span>;</span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">default</span><span class="op">:</span></span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>          message <span class="op">=</span> <span class="st">&#39;An unexpected error occurred. Please try again.&#39;</span>;</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (err<span class="op">.</span>type <span class="op">==</span> DioExceptionType<span class="op">.</span>cancel) {</span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Request was cancelled (user navigated away) - don&#39;t show error</span></span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>      handler<span class="op">.</span>next(err);</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>      <span class="kw">return</span>;</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Unknown error - generic message</span></span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>      message <span class="op">=</span> <span class="st">&#39;Unable to connect to server. Please check your internet connection.&#39;</span>;</span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create application-specific exception with user-friendly message</span></span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">final</span> appException <span class="op">=</span> ApiException(message<span class="op">,</span> statusCode<span class="op">:</span> err<span class="op">.</span>response<span class="op">?.</span>statusCode);</span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Log the technical error for debugging</span></span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a>    logger<span class="op">.</span>error(<span class="st">&#39;API Error: ${err.message}&#39;</span><span class="op">,</span> error<span class="op">:</span> err);</span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Pass the user-friendly exception to application code</span></span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a>    handler<span class="op">.</span>reject(DioException(</span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a>      requestOptions<span class="op">:</span> err<span class="op">.</span>requestOptions<span class="op">,</span></span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a>      error<span class="op">:</span> appException<span class="op">,</span></span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a>      type<span class="op">:</span> err<span class="op">.</span>type<span class="op">,</span></span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a>    ));</span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Benefits</strong>: - Users see “Connection timeout” instead
of “DioException: ConnectionTimeout” - Developers get technical logs for
debugging - Consistent error messages across the entire app -
Healthcare-appropriate language (calm, reassuring, actionable)</p>
<h4 id="making-requests-with-configured-client">Making Requests with
Configured Client</h4>
<p>With interceptors in place, making API calls is straightforward:</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HealthService {</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> ApiClient _apiClient;</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  HealthService(<span class="kw">this</span><span class="op">.</span>_apiClient);</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">List</span><span class="op">&lt;</span>VitalSign<span class="op">&gt;&gt;</span> getVitalSigns() <span class="at">async</span> {</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Make request - interceptors automatically:</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>      <span class="co">// 1. Add auth token</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>      <span class="co">// 2. Log request</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>      <span class="co">// 3. Transform any errors</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">final</span> response <span class="op">=</span> <span class="at">await</span> _apiClient<span class="op">.</span>dio<span class="op">.</span><span class="kw">get</span>(<span class="st">&#39;/api/health/vitals&#39;</span>);</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Parse response</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">return</span> (response<span class="op">.</span>data <span class="kw">as</span> <span class="dt">List</span>)</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span>map((json) <span class="op">=&gt;</span> VitalSign<span class="op">.</span>fromJson(json))</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span>toList();</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>    } <span class="kw">on</span> ApiException <span class="cf">catch</span> (e) {</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Error was already transformed by ErrorInterceptor</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> HealthException(e<span class="op">.</span>message);</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Notice how clean this code is—no manual token injection, no response
logging, no error transformation. All that complexity is handled by
interceptors, ensuring consistency across all API calls in the
application.</p>
<p>This architecture means: - New developers can add API calls without
worrying about auth or logging - Changing how we handle authentication
(e.g., switching from JWT to OAuth) only requires updating one file -
All API calls automatically benefit from improvements to error handling
or logging - Healthcare compliance requirements (like audit logging) are
enforced automatically</p>
<h3 id="feature-module-structure">Feature Module Structure</h3>
<p>CareConnect’s frontend architecture organizes code by feature rather
than by technical layer. This “feature-first” structure means all code
related to a specific domain (like health tracking or messaging) lives
together in one directory, making it easier to understand, maintain, and
test features in isolation.</p>
<h4 id="why-feature-based-organization">Why Feature-Based
Organization?</h4>
<p><strong>Traditional Layer-Based Approach (What We
Avoid)</strong>:</p>
<pre><code>lib/
├── models/           # ALL models from ALL features mixed together
├── services/         # ALL services from ALL features mixed together
├── screens/          # ALL screens from ALL features mixed together
└── widgets/          # ALL widgets from ALL features mixed together</code></pre>
<p>Problem: To understand the “health tracking” feature, you’d need to
hunt through 4+ different directories. Adding a new feature means
touching many directories.</p>
<p><strong>Feature-Based Approach (What We Use)</strong>:</p>
<pre><code>lib/
└── features/
    ├── health/       # Everything for health tracking in ONE place
    ├── messaging/    # Everything for messaging in ONE place
    └── auth/         # Everything for authentication in ONE place</code></pre>
<p>Benefit: All health-related code is in one directory. To understand
or modify health features, you only look in
<code>features/health/</code>. New developers can explore one feature at
a time without getting lost in the codebase.</p>
<h4 id="anatomy-of-a-feature-module">Anatomy of a Feature Module</h4>
<p>Each feature module follows a consistent internal structure that
mirrors the application’s architectural layers. Below is a concrete
example using the Health feature, which manages vital signs,
medications, and health records:</p>
<p><strong>Directory Structure</strong>:</p>
<pre><code>features/health/
├── models/           # Data structures (VitalSign, Medication, etc.)
├── services/         # API communication layer
├── providers/        # State management (HealthProvider)
├── presentation/     # UI components
│   ├── screens/      # Full-page screens
│   └── widgets/      # Reusable UI components
└── utils/            # Feature-specific utilities (formatters, validators)</code></pre>
<p><strong>Data Flow Within a Feature</strong>:</p>
<pre><code>UI (Presentation) → Provider (State) → Service (API) → Model (Data Structure)
      ↓                   ↓                 ↓               ↓
  User taps button   Updates state    Makes HTTP call   Parses JSON</code></pre>
<h4 id="practical-example-the-health-feature-module">Practical Example:
The Health Feature Module</h4>
<p>Let’s walk through how the Health feature implements this pattern to
track vital signs like blood pressure and heart rate:</p>
<p><strong>1. Model Layer - Data Structures</strong></p>
<p>The <code>VitalSign</code> model represents a single vital sign
measurement. Its responsibilities are: - Define the structure of vital
sign data (type, value, unit, timestamp) - Provide JSON
serialization/deserialization for API communication - Ensure type safety
(Dart’s strong typing prevents bugs)</p>
<p>Example vital sign data flow: - <strong>From API</strong>: JSON
<code>{"id":"123", "type":"blood_pressure", "value":120, ...}</code> →
VitalSign object - <strong>To UI</strong>: VitalSign object → Display
“Blood Pressure: 120/80 mmHg” - <strong>To API</strong>: VitalSign
object → JSON for saving new measurement</p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">// features/health/models/vital_sign.dart</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="co">// VitalSign: Immutable data class representing a single vital sign measurement</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Immutability (final fields) ensures data integrity - once created, cannot be modified</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co">// This prevents bugs where vital signs accidentally change after being recorded</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> VitalSign {</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Unique identifier from database - used for updates/deletes</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">String</span> id;</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Type of measurement: &quot;blood_pressure&quot;, &quot;heart_rate&quot;, &quot;temperature&quot;, etc.</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// String instead of enum allows backend to add new types without app update</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">String</span> type;</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Numeric value of the measurement (e.g., 120 for systolic BP)</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">double</span> value;</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Unit of measurement: &quot;mmHg&quot;, &quot;bpm&quot;, &quot;°F&quot;, etc.</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Stored separately because different vital types use different units</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">String</span> unit;</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">// When this measurement was taken - critical for timeline and trending</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> DateTime timestamp;</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Optional notes (e.g., &quot;Taken after exercise&quot;)</span></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Nullable (String?) because not all measurements have notes</span></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">String</span><span class="op">?</span> notes;</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Constructor with named parameters for clarity and safety</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Example usage: VitalSign(id: &quot;123&quot;, type: &quot;heart_rate&quot;, value: 72, ...)</span></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>  VitalSign({</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>    required <span class="kw">this</span><span class="op">.</span>id<span class="op">,</span></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>    required <span class="kw">this</span><span class="op">.</span>type<span class="op">,</span></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>    required <span class="kw">this</span><span class="op">.</span>value<span class="op">,</span></span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>    required <span class="kw">this</span><span class="op">.</span>unit<span class="op">,</span></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>    required <span class="kw">this</span><span class="op">.</span>timestamp<span class="op">,</span></span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span>notes<span class="op">,</span></span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>  });</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Factory constructor to create VitalSign from JSON received from API</span></span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Called automatically when parsing API responses</span></span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Example JSON: {&quot;id&quot;:&quot;123&quot;, &quot;type&quot;:&quot;heart_rate&quot;, &quot;value&quot;:72, &quot;unit&quot;:&quot;bpm&quot;, ...}</span></span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>  <span class="kw">factory</span> VitalSign<span class="op">.</span>fromJson(<span class="dt">Map</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> <span class="at">dynamic</span><span class="op">&gt;</span> json) {</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> VitalSign(</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>      id<span class="op">:</span> json[<span class="st">&#39;id&#39;</span>]<span class="op">,</span></span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>      type<span class="op">:</span> json[<span class="st">&#39;type&#39;</span>]<span class="op">,</span></span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>      <span class="co">// toDouble() handles both int and double from API (flexible parsing)</span></span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>      value<span class="op">:</span> json[<span class="st">&#39;value&#39;</span>]<span class="op">.</span>toDouble()<span class="op">,</span></span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>      unit<span class="op">:</span> json[<span class="st">&#39;unit&#39;</span>]<span class="op">,</span></span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Parse ISO 8601 timestamp string into DateTime object</span></span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>      timestamp<span class="op">:</span> DateTime<span class="op">.</span>parse(json[<span class="st">&#39;timestamp&#39;</span>])<span class="op">,</span></span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>      <span class="co">// notes might be null in JSON, which is fine (nullable String?)</span></span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a>      notes<span class="op">:</span> json[<span class="st">&#39;notes&#39;</span>]<span class="op">,</span></span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a>    );</span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Convert VitalSign back to JSON for sending to API</span></span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Used when recording new vital signs or updating existing ones</span></span>
<span id="cb35-57"><a href="#cb35-57" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Map</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> <span class="at">dynamic</span><span class="op">&gt;</span> toJson() {</span>
<span id="cb35-58"><a href="#cb35-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> {</span>
<span id="cb35-59"><a href="#cb35-59" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;id&#39;</span><span class="op">:</span> id<span class="op">,</span></span>
<span id="cb35-60"><a href="#cb35-60" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;type&#39;</span><span class="op">:</span> type<span class="op">,</span></span>
<span id="cb35-61"><a href="#cb35-61" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;value&#39;</span><span class="op">:</span> value<span class="op">,</span></span>
<span id="cb35-62"><a href="#cb35-62" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;unit&#39;</span><span class="op">:</span> unit<span class="op">,</span></span>
<span id="cb35-63"><a href="#cb35-63" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;timestamp&#39;</span><span class="op">:</span> timestamp<span class="op">.</span>toIso8601String()<span class="op">,</span></span>
<span id="cb35-64"><a href="#cb35-64" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;notes&#39;</span><span class="op">:</span> notes<span class="op">,</span></span>
<span id="cb35-65"><a href="#cb35-65" aria-hidden="true" tabindex="-1"></a>    };</span>
<span id="cb35-66"><a href="#cb35-66" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-67"><a href="#cb35-67" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-68"><a href="#cb35-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-69"><a href="#cb35-69" aria-hidden="true" tabindex="-1"></a><span class="op">**</span><span class="fl">2.</span> Service Layer <span class="op">-</span> API Communication<span class="op">**</span></span>
<span id="cb35-70"><a href="#cb35-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-71"><a href="#cb35-71" aria-hidden="true" tabindex="-1"></a>The `HealthService` <span class="kw">class</span> <span class="kw">is</span> responsible <span class="cf">for</span> all network communication related to health data<span class="op">.</span> It acts <span class="kw">as</span> a facade over the raw HTTP client (Dio)<span class="op">,</span> providing a clean<span class="op">,</span> type<span class="op">-</span>safe <span class="kw">interface</span> <span class="cf">for</span> the rest of the application<span class="op">.</span></span>
<span id="cb35-72"><a href="#cb35-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-73"><a href="#cb35-73" aria-hidden="true" tabindex="-1"></a><span class="op">**</span>Key Responsibilities<span class="op">**:</span></span>
<span id="cb35-74"><a href="#cb35-74" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> <span class="op">**</span>API Abstraction<span class="op">**:</span> Hide HTTP details (URLs<span class="op">,</span> methods<span class="op">,</span> headers) from the rest of the app</span>
<span id="cb35-75"><a href="#cb35-75" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> <span class="op">**</span><span class="kw">Error</span> Handling<span class="op">**:</span> Convert network errors into domain<span class="op">-</span>specific exceptions</span>
<span id="cb35-76"><a href="#cb35-76" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> <span class="op">**</span>Data Transformation<span class="op">**:</span> Convert between API JSON and app models</span>
<span id="cb35-77"><a href="#cb35-77" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> <span class="op">**</span>Type Safety<span class="op">**:</span> Ensure all API calls <span class="kw">return</span> the correct data types</span>
<span id="cb35-78"><a href="#cb35-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-79"><a href="#cb35-79" aria-hidden="true" tabindex="-1"></a><span class="op">**</span>Why a Separate Service Layer<span class="op">?**</span></span>
<span id="cb35-80"><a href="#cb35-80" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> <span class="op">**</span>Testability<span class="op">**:</span> Can mock the service to test UI without real API calls</span>
<span id="cb35-81"><a href="#cb35-81" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> <span class="op">**</span>Reusability<span class="op">**:</span> Multiple screens can use the same service methods</span>
<span id="cb35-82"><a href="#cb35-82" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> <span class="op">**</span>Maintainability<span class="op">**:</span> If API changes (e<span class="op">.</span>g<span class="op">.,</span> endpoint URL)<span class="op">,</span> only update <span class="kw">in</span> one place</span>
<span id="cb35-83"><a href="#cb35-83" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> <span class="op">**</span>Separation of Concerns<span class="op">**:</span> UI code doesn<span class="st">&#39;t need to know about HTTP details</span></span>
<span id="cb35-84"><a href="#cb35-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-85"><a href="#cb35-85" aria-hidden="true" tabindex="-1"></a>```dart</span>
<span id="cb35-86"><a href="#cb35-86" aria-hidden="true" tabindex="-1"></a><span class="co">// features/health/services/health_service.dart</span></span>
<span id="cb35-87"><a href="#cb35-87" aria-hidden="true" tabindex="-1"></a><span class="co">// HealthService: Handles all API communication for health-related features</span></span>
<span id="cb35-88"><a href="#cb35-88" aria-hidden="true" tabindex="-1"></a><span class="co">// This is the single source of truth for how the app talks to the health API</span></span>
<span id="cb35-89"><a href="#cb35-89" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HealthService {</span>
<span id="cb35-90"><a href="#cb35-90" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Private API client - the underscore makes it private to this class</span></span>
<span id="cb35-91"><a href="#cb35-91" aria-hidden="true" tabindex="-1"></a>  <span class="co">// This ensures all API calls go through our defined methods, maintaining consistency</span></span>
<span id="cb35-92"><a href="#cb35-92" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> ApiClient _apiClient;</span>
<span id="cb35-93"><a href="#cb35-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-94"><a href="#cb35-94" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Constructor injection of ApiClient</span></span>
<span id="cb35-95"><a href="#cb35-95" aria-hidden="true" tabindex="-1"></a>  <span class="co">// This allows us to inject a mock client for testing</span></span>
<span id="cb35-96"><a href="#cb35-96" aria-hidden="true" tabindex="-1"></a>  HealthService(<span class="kw">this</span><span class="op">.</span>_apiClient);</span>
<span id="cb35-97"><a href="#cb35-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-98"><a href="#cb35-98" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// Fetches all vital signs for the current user from the backend</span></span>
<span id="cb35-99"><a href="#cb35-99" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// </span></span>
<span id="cb35-100"><a href="#cb35-100" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// Returns: List of VitalSign objects, ordered by most recent first</span></span>
<span id="cb35-101"><a href="#cb35-101" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// Throws: HealthException if the API call fails or returns invalid data</span></span>
<span id="cb35-102"><a href="#cb35-102" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// </span></span>
<span id="cb35-103"><a href="#cb35-103" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// Example usage:</span></span>
<span id="cb35-104"><a href="#cb35-104" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// ```dart</span></span>
<span id="cb35-105"><a href="#cb35-105" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// try {</span></span>
<span id="cb35-106"><a href="#cb35-106" aria-hidden="true" tabindex="-1"></a>  <span class="co">///   final vitals = await healthService.getVitalSigns();</span></span>
<span id="cb35-107"><a href="#cb35-107" aria-hidden="true" tabindex="-1"></a>  <span class="co">///   print(&#39;Found ${vitals.length} vital signs&#39;);</span></span>
<span id="cb35-108"><a href="#cb35-108" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// } catch (e) {</span></span>
<span id="cb35-109"><a href="#cb35-109" aria-hidden="true" tabindex="-1"></a>  <span class="co">///   print(&#39;Error loading vitals: $e&#39;);</span></span>
<span id="cb35-110"><a href="#cb35-110" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// }</span></span>
<span id="cb35-111"><a href="#cb35-111" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// ```</span></span>
<span id="cb35-112"><a href="#cb35-112" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">List</span><span class="op">&lt;</span>VitalSign<span class="op">&gt;&gt;</span> getVitalSigns() <span class="at">async</span> {</span>
<span id="cb35-113"><a href="#cb35-113" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb35-114"><a href="#cb35-114" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Make GET request to vitals endpoint</span></span>
<span id="cb35-115"><a href="#cb35-115" aria-hidden="true" tabindex="-1"></a>      <span class="co">// ApiClient automatically adds auth token from AuthInterceptor</span></span>
<span id="cb35-116"><a href="#cb35-116" aria-hidden="true" tabindex="-1"></a>      <span class="at">final</span> response <span class="op">=</span> <span class="at">await</span> _apiClient<span class="op">.</span><span class="kw">get</span>(<span class="st">&#39;/api/health/vitals&#39;</span>);</span>
<span id="cb35-117"><a href="#cb35-117" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb35-118"><a href="#cb35-118" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Parse response: API returns JSON array of vital sign objects</span></span>
<span id="cb35-119"><a href="#cb35-119" aria-hidden="true" tabindex="-1"></a>      <span class="co">// We map each JSON object to a VitalSign instance</span></span>
<span id="cb35-120"><a href="#cb35-120" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Example API response: [{&quot;id&quot;:&quot;1&quot;, &quot;type&quot;:&quot;bp&quot;, ...}, {&quot;id&quot;:&quot;2&quot;, &quot;type&quot;:&quot;hr&quot;, ...}]</span></span>
<span id="cb35-121"><a href="#cb35-121" aria-hidden="true" tabindex="-1"></a>      <span class="kw">return</span> (response<span class="op">.</span>data <span class="kw">as</span> <span class="dt">List</span>)</span>
<span id="cb35-122"><a href="#cb35-122" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span>map((json) <span class="op">=&gt;</span> VitalSign<span class="op">.</span>fromJson(json))</span>
<span id="cb35-123"><a href="#cb35-123" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span>toList();</span>
<span id="cb35-124"><a href="#cb35-124" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (e) {</span>
<span id="cb35-125"><a href="#cb35-125" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Wrap any errors in HealthException for consistent error handling</span></span>
<span id="cb35-126"><a href="#cb35-126" aria-hidden="true" tabindex="-1"></a>      <span class="co">// This could be a network error, timeout, 500 error, etc.</span></span>
<span id="cb35-127"><a href="#cb35-127" aria-hidden="true" tabindex="-1"></a>      <span class="co">// HealthException provides user-friendly error messages</span></span>
<span id="cb35-128"><a href="#cb35-128" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> HealthException(<span class="st">&#39;Failed to fetch vital signs: $e&#39;</span>);</span>
<span id="cb35-129"><a href="#cb35-129" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb35-130"><a href="#cb35-130" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-131"><a href="#cb35-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-132"><a href="#cb35-132" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// Records a new vital sign measurement</span></span>
<span id="cb35-133"><a href="#cb35-133" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// </span></span>
<span id="cb35-134"><a href="#cb35-134" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// Parameters:</span></span>
<span id="cb35-135"><a href="#cb35-135" aria-hidden="true" tabindex="-1"></a>  <span class="co">///   - vitalSign: The vital sign to record (should NOT have an ID yet)</span></span>
<span id="cb35-136"><a href="#cb35-136" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// </span></span>
<span id="cb35-137"><a href="#cb35-137" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// Returns: The saved vital sign with server-generated ID and timestamp</span></span>
<span id="cb35-138"><a href="#cb35-138" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// Throws: HealthException if recording fails (validation error, network error, etc.)</span></span>
<span id="cb35-139"><a href="#cb35-139" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// </span></span>
<span id="cb35-140"><a href="#cb35-140" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// Example usage:</span></span>
<span id="cb35-141"><a href="#cb35-141" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// ```dart</span></span>
<span id="cb35-142"><a href="#cb35-142" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// final newVital = VitalSign(</span></span>
<span id="cb35-143"><a href="#cb35-143" aria-hidden="true" tabindex="-1"></a>  <span class="co">///   type: &#39;blood_pressure&#39;,</span></span>
<span id="cb35-144"><a href="#cb35-144" aria-hidden="true" tabindex="-1"></a>  <span class="co">///   value: 120,</span></span>
<span id="cb35-145"><a href="#cb35-145" aria-hidden="true" tabindex="-1"></a>  <span class="co">///   unit: &#39;mmHg&#39;,</span></span>
<span id="cb35-146"><a href="#cb35-146" aria-hidden="true" tabindex="-1"></a>  <span class="co">///   notes: &#39;After morning jog&#39;,</span></span>
<span id="cb35-147"><a href="#cb35-147" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// );</span></span>
<span id="cb35-148"><a href="#cb35-148" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// final saved = await healthService.recordVitalSign(newVital);</span></span>
<span id="cb35-149"><a href="#cb35-149" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// print(&#39;Saved with ID: ${saved.id}&#39;);</span></span>
<span id="cb35-150"><a href="#cb35-150" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// ```</span></span>
<span id="cb35-151"><a href="#cb35-151" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span>VitalSign<span class="op">&gt;</span> recordVitalSign(VitalSign vitalSign) <span class="at">async</span> {</span>
<span id="cb35-152"><a href="#cb35-152" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb35-153"><a href="#cb35-153" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Make POST request with vital sign data</span></span>
<span id="cb35-154"><a href="#cb35-154" aria-hidden="true" tabindex="-1"></a>      <span class="co">// vitalSign.toJson() converts the Dart object to JSON</span></span>
<span id="cb35-155"><a href="#cb35-155" aria-hidden="true" tabindex="-1"></a>      <span class="at">final</span> response <span class="op">=</span> <span class="at">await</span> _apiClient<span class="op">.</span>post(</span>
<span id="cb35-156"><a href="#cb35-156" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;/api/health/vitals&#39;</span><span class="op">,</span></span>
<span id="cb35-157"><a href="#cb35-157" aria-hidden="true" tabindex="-1"></a>        data<span class="op">:</span> vitalSign<span class="op">.</span>toJson()<span class="op">,</span></span>
<span id="cb35-158"><a href="#cb35-158" aria-hidden="true" tabindex="-1"></a>      );</span>
<span id="cb35-159"><a href="#cb35-159" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb35-160"><a href="#cb35-160" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Server returns the saved vital sign with generated ID and server timestamp</span></span>
<span id="cb35-161"><a href="#cb35-161" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Parse it back into a VitalSign object</span></span>
<span id="cb35-162"><a href="#cb35-162" aria-hidden="true" tabindex="-1"></a>      <span class="kw">return</span> VitalSign<span class="op">.</span>fromJson(response<span class="op">.</span>data);</span>
<span id="cb35-163"><a href="#cb35-163" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (e) {</span>
<span id="cb35-164"><a href="#cb35-164" aria-hidden="true" tabindex="-1"></a>      <span class="co">// If backend validation fails, this catches the error</span></span>
<span id="cb35-165"><a href="#cb35-165" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Example errors: &quot;Value out of range&quot;, &quot;Invalid vital type&quot;</span></span>
<span id="cb35-166"><a href="#cb35-166" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> HealthException(<span class="st">&#39;Failed to record vital sign: $e&#39;</span>);</span>
<span id="cb35-167"><a href="#cb35-167" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb35-168"><a href="#cb35-168" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-169"><a href="#cb35-169" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Design Pattern: Repository Pattern</strong></p>
<p>This service implements the Repository pattern, a common
architectural pattern that: - Provides a collection-like interface to
data sources (in this case, the API) - Abstracts away the details of
where data comes from - Makes it easy to switch data sources (e.g., API
→ local cache) without changing UI code</p>
<p><strong>Error Handling Strategy</strong></p>
<p>Notice how both methods use try-catch and throw
<code>HealthException</code>: - <strong>Why not let errors bubble
up?</strong> Raw Dio exceptions contain technical details (HTTP status
codes, headers) that UI shouldn’t know about -
<strong>HealthException</strong>: Domain-specific exception with
user-friendly messages - <strong>Consistency</strong>: All
health-related errors are the same type, simplifying error handling in
UI</p>
<p><strong>Common Usage Pattern in Provider</strong>:</p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HealthProvider <span class="kw">extends</span> ChangeNotifier {</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> HealthService _healthService;</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">List</span><span class="op">&lt;</span>VitalSign<span class="op">&gt;</span> _vitals <span class="op">=</span> [];</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> loadVitals() <span class="at">async</span> {</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>      _vitals <span class="op">=</span> <span class="at">await</span> _healthService<span class="op">.</span>getVitalSigns();</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>      notifyListeners();  <span class="co">// Update UI</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    } <span class="kw">on</span> HealthException <span class="cf">catch</span> (e) {</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Show user-friendly error message in UI</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>      showError(e<span class="op">.</span>message);</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This layered approach (UI → Provider → Service → API) ensures: - Each
layer has a single responsibility - Changes to one layer don’t affect
others - Testing is straightforward (mock dependencies) - Code is
maintainable and readable</p>
<pre><code>
## Backend Development (Spring Boot)

### Project Structure

```java
com.careconnect/
├── CareconnectBackendApplication.java  # Main application
├── config/                             # Configuration classes
│   ├── SecurityConfig.java
│   ├── WebSocketConfig.java
│   └── OpenApiConfig.java
├── controller/                         # REST controllers
├── service/                            # Business logic
├── repository/                         # Data access layer
├── model/                              # JPA entities
├── dto/                                # Data transfer objects
├── exception/                          # Exception handling
└── util/                               # Utility classes</code></pre>
<h3 id="entity-models-mapping-domain-objects-to-database-tables">Entity
Models: Mapping Domain Objects to Database Tables</h3>
<p>In Spring Boot applications, JPA (Java Persistence API) entities
represent the bridge between our object-oriented Java code and the
relational database. Each entity class maps to a database table, and
each instance represents a row in that table. CareConnect uses JPA
annotations to declaratively define this mapping, allowing Hibernate to
automatically handle SQL generation, relationship management, and
object-relational mapping complexity.</p>
<h4 id="the-anatomy-of-a-jpa-entity">The Anatomy of a JPA Entity</h4>
<p>Let’s examine the <code>User</code> and <code>VitalSign</code>
entities to understand how JPA annotations work together to create a
robust data model for healthcare data:</p>
<p><strong>Design Principles</strong>: - <strong>Entities Are POJOs
(Plain Old Java Objects)</strong>: Despite the annotations, entities
remain simple Java classes with fields, constructors, getters, and
setters - <strong>Annotations Define Behavior</strong>: Rather than
writing SQL, we use annotations like <code>@Entity</code>,
<code>@Table</code>, <code>@Column</code> to tell Hibernate how to
persist the object - <strong>Relationships Are Explicit</strong>:
<code>@OneToMany</code>, <code>@ManyToOne</code> define how entities
relate to each other, mirroring foreign key relationships in the
database - <strong>Validation At Multiple Layers</strong>: JPA
constraints (<code>nullable = false</code>) provide database-level
validation, while JSR-380 annotations (<code>@Email</code>) provide
application-level validation</p>
<p>Example entity with detailed explanations of JPA annotations:</p>
<div class="sourceCode" id="cb38"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">// model/User.java</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co">// @Entity: Marks this class as a JPA entity - Hibernate will create a table for it</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co">// This is the fundamental annotation that makes a class persistable</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="at">@Entity</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co">// @Table: Specifies the table name in the database</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Without this, Hibernate would use the class name &quot;User&quot; as the table name</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="co">// We explicitly set it to &quot;users&quot; to avoid conflicts with SQL reserved words</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="at">@Table</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;users&quot;</span><span class="op">)</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="co">// @EntityListeners: Enables JPA auditing for this entity</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="co">// AuditingEntityListener automatically populates createdDate, lastModifiedDate fields</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="co">// This is crucial for healthcare compliance - we need to know when records are created/modified</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="at">@EntityListeners</span><span class="op">(</span>AuditingEntityListener<span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a><span class="co">// extends Auditable: Base class providing createdDate, lastModifiedDate, createdBy, lastModifiedBy</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a><span class="co">// These audit fields are required for HIPAA compliance and medical record regulations</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> User <span class="kw">extends</span> Auditable <span class="op">{</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// @Id: Marks this field as the primary key</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Every entity must have exactly one @Id field</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Id</span></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// @GeneratedValue: Database auto-generates this value on insert</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// IDENTITY strategy: Uses database auto-increment (SERIAL in PostgreSQL)</span></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Alternative strategies: SEQUENCE (uses DB sequence), AUTO (database-dependent)</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GeneratedValue</span><span class="op">(</span>strategy <span class="op">=</span> GenerationType<span class="op">.</span><span class="fu">IDENTITY</span><span class="op">)</span></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Long</span> id<span class="op">;</span></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// @Column: Defines column properties in the database</span></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// unique = true: Database enforces uniqueness (prevents duplicate emails)</span></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">// nullable = false: Database enforces NOT NULL constraint</span></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">// These constraints prevent data integrity issues at the database level</span></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>unique <span class="op">=</span> <span class="kw">true</span><span class="op">,</span> nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">// @Email: JSR-380 validation annotation</span></span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Validates email format *before* trying to save to database</span></span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Provides better error messages than database constraint violations</span></span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Email</span></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> email<span class="op">;</span></span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Password field: nullable = false but no @Email constraint</span></span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Stored as hashed value (BCrypt), never plain text</span></span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> password<span class="op">;</span></span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> firstName<span class="op">;</span></span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> lastName<span class="op">;</span></span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">// @Enumerated: Tells JPA how to store the enum value</span></span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a>    <span class="co">// EnumType.STRING: Store enum name as string (&quot;PATIENT&quot;, &quot;CAREGIVER&quot;, &quot;ADMIN&quot;)</span></span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Why STRING not ORDINAL? If we add a new role in the middle of the enum,</span></span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ORDINAL values change, breaking existing data. STRING is stable.</span></span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Enumerated</span><span class="op">(</span>EnumType<span class="op">.</span><span class="fu">STRING</span><span class="op">)</span></span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> UserRole role<span class="op">;</span>  <span class="co">// UserRole is an enum: PATIENT, CAREGIVER, FAMILY_MEMBER, etc.</span></span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Boolean field with default value</span></span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">// active = true: Users start as active, can be deactivated (soft delete)</span></span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Soft deletes preserve data for compliance while preventing login</span></span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Boolean</span> active <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a>    <span class="co">// @OneToMany: Defines a one-to-many relationship</span></span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a>    <span class="co">// One User can have many VitalSigns</span></span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">// mappedBy = &quot;user&quot;: The VitalSign entity has a field called &quot;user&quot; that owns this relationship</span></span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">// cascade = CascadeType.ALL: Operations on User cascade to VitalSigns</span></span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a>    <span class="co">//   Example: If we delete a User, all their VitalSigns are also deleted</span></span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a>    <span class="co">// This prevents orphaned vital signs in the database</span></span>
<span id="cb38-73"><a href="#cb38-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">@OneToMany</span><span class="op">(</span>mappedBy <span class="op">=</span> <span class="st">&quot;user&quot;</span><span class="op">,</span> cascade <span class="op">=</span> CascadeType<span class="op">.</span><span class="fu">ALL</span><span class="op">)</span></span>
<span id="cb38-74"><a href="#cb38-74" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">List</span><span class="op">&lt;</span>VitalSign<span class="op">&gt;</span> vitalSigns <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;();</span></span>
<span id="cb38-75"><a href="#cb38-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-76"><a href="#cb38-76" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Constructors, getters, setters (omitted for brevity)</span></span>
<span id="cb38-77"><a href="#cb38-77" aria-hidden="true" tabindex="-1"></a>    <span class="co">// JPA requires a no-arg constructor (can be private)</span></span>
<span id="cb38-78"><a href="#cb38-78" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Getters/setters allow JPA to access fields via reflection</span></span>
<span id="cb38-79"><a href="#cb38-79" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb38-80"><a href="#cb38-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-81"><a href="#cb38-81" aria-hidden="true" tabindex="-1"></a><span class="co">// model/VitalSign.java</span></span>
<span id="cb38-82"><a href="#cb38-82" aria-hidden="true" tabindex="-1"></a><span class="co">// VitalSign: Represents a single measurement (blood pressure, heart rate, etc.)</span></span>
<span id="cb38-83"><a href="#cb38-83" aria-hidden="true" tabindex="-1"></a><span class="co">// Related to User via many-to-one relationship (many vitals belong to one user)</span></span>
<span id="cb38-84"><a href="#cb38-84" aria-hidden="true" tabindex="-1"></a><span class="at">@Entity</span></span>
<span id="cb38-85"><a href="#cb38-85" aria-hidden="true" tabindex="-1"></a><span class="at">@Table</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;vital_signs&quot;</span><span class="op">)</span></span>
<span id="cb38-86"><a href="#cb38-86" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> VitalSign <span class="kw">extends</span> Auditable <span class="op">{</span></span>
<span id="cb38-87"><a href="#cb38-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-88"><a href="#cb38-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Id</span></span>
<span id="cb38-89"><a href="#cb38-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GeneratedValue</span><span class="op">(</span>strategy <span class="op">=</span> GenerationType<span class="op">.</span><span class="fu">IDENTITY</span><span class="op">)</span></span>
<span id="cb38-90"><a href="#cb38-90" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Long</span> id<span class="op">;</span></span>
<span id="cb38-91"><a href="#cb38-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-92"><a href="#cb38-92" aria-hidden="true" tabindex="-1"></a>    <span class="co">// @ManyToOne: Defines the many-to-one side of the relationship</span></span>
<span id="cb38-93"><a href="#cb38-93" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Many VitalSigns belong to one User</span></span>
<span id="cb38-94"><a href="#cb38-94" aria-hidden="true" tabindex="-1"></a>    <span class="co">// fetch = FetchType.LAZY: Don&#39;t load the User object unless explicitly accessed</span></span>
<span id="cb38-95"><a href="#cb38-95" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Why LAZY? Performance - we don&#39;t always need the full User object when querying vitals</span></span>
<span id="cb38-96"><a href="#cb38-96" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Example: Loading 100 vitals with EAGER would also load 100 User objects (wasteful)</span></span>
<span id="cb38-97"><a href="#cb38-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">@ManyToOne</span><span class="op">(</span>fetch <span class="op">=</span> FetchType<span class="op">.</span><span class="fu">LAZY</span><span class="op">)</span></span>
<span id="cb38-98"><a href="#cb38-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-99"><a href="#cb38-99" aria-hidden="true" tabindex="-1"></a>    <span class="co">// @JoinColumn: Specifies the foreign key column in the database</span></span>
<span id="cb38-100"><a href="#cb38-100" aria-hidden="true" tabindex="-1"></a>    <span class="co">// name = &quot;user_id&quot;: The column in vital_signs table that references users.id</span></span>
<span id="cb38-101"><a href="#cb38-101" aria-hidden="true" tabindex="-1"></a>    <span class="co">// nullable = false: Every vital sign must belong to a user (referential integrity)</span></span>
<span id="cb38-102"><a href="#cb38-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">@JoinColumn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;user_id&quot;</span><span class="op">,</span> nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb38-103"><a href="#cb38-103" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> User user<span class="op">;</span></span>
<span id="cb38-104"><a href="#cb38-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-105"><a href="#cb38-105" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Type of measurement stored as string for flexibility</span></span>
<span id="cb38-106"><a href="#cb38-106" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Examples: &quot;blood_pressure&quot;, &quot;heart_rate&quot;, &quot;temperature&quot;, &quot;oxygen_saturation&quot;</span></span>
<span id="cb38-107"><a href="#cb38-107" aria-hidden="true" tabindex="-1"></a>    <span class="co">// String vs Enum: Allows adding new vital types without code changes</span></span>
<span id="cb38-108"><a href="#cb38-108" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb38-109"><a href="#cb38-109" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> type<span class="op">;</span></span>
<span id="cb38-110"><a href="#cb38-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-111"><a href="#cb38-111" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Numeric value of the measurement</span></span>
<span id="cb38-112"><a href="#cb38-112" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Double allows decimals (e.g., temperature: 98.6°F)</span></span>
<span id="cb38-113"><a href="#cb38-113" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Could be systolic BP (120), heart rate (72), temperature (36.5), etc.</span></span>
<span id="cb38-114"><a href="#cb38-114" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb38-115"><a href="#cb38-115" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Double</span> value<span class="op">;</span></span>
<span id="cb38-116"><a href="#cb38-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-117"><a href="#cb38-117" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Unit of measurement - varies by vital type</span></span>
<span id="cb38-118"><a href="#cb38-118" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Examples: &quot;mmHg&quot; (blood pressure), &quot;bpm&quot; (heart rate), &quot;°C&quot; (temperature)</span></span>
<span id="cb38-119"><a href="#cb38-119" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb38-120"><a href="#cb38-120" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> unit<span class="op">;</span></span>
<span id="cb38-121"><a href="#cb38-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-122"><a href="#cb38-122" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Optional notes field - might be null if no notes provided</span></span>
<span id="cb38-123"><a href="#cb38-123" aria-hidden="true" tabindex="-1"></a>    <span class="co">// No nullable = false constraint, so NULL is allowed in database</span></span>
<span id="cb38-124"><a href="#cb38-124" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span></span>
<span id="cb38-125"><a href="#cb38-125" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> notes<span class="op">;</span></span>
<span id="cb38-126"><a href="#cb38-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-127"><a href="#cb38-127" aria-hidden="true" tabindex="-1"></a>    <span class="co">// When this measurement was taken</span></span>
<span id="cb38-128"><a href="#cb38-128" aria-hidden="true" tabindex="-1"></a>    <span class="co">// LocalDateTime: Java 8 date/time type, timezone-neutral</span></span>
<span id="cb38-129"><a href="#cb38-129" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Hibernate automatically converts between LocalDateTime and PostgreSQL TIMESTAMP</span></span>
<span id="cb38-130"><a href="#cb38-130" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb38-131"><a href="#cb38-131" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> LocalDateTime measurementTime<span class="op">;</span></span>
<span id="cb38-132"><a href="#cb38-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-133"><a href="#cb38-133" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Constructors, getters, setters (omitted for brevity)</span></span>
<span id="cb38-134"><a href="#cb38-134" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="understanding-jpa-relationships">Understanding JPA
Relationships</h4>
<p>The <code>User</code> ↔︎ <code>VitalSign</code> relationship
demonstrates the one-to-many/many-to-one pattern:</p>
<p><strong>From User’s Perspective (One-to-Many)</strong>:</p>
<div class="sourceCode" id="cb39"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="at">@OneToMany</span><span class="op">(</span>mappedBy <span class="op">=</span> <span class="st">&quot;user&quot;</span><span class="op">,</span> cascade <span class="op">=</span> CascadeType<span class="op">.</span><span class="fu">ALL</span><span class="op">)</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="bu">List</span><span class="op">&lt;</span>VitalSign<span class="op">&gt;</span> vitalSigns<span class="op">;</span></span></code></pre></div>
<ul>
<li>One user has many vital signs</li>
<li><code>mappedBy = "user"</code>: VitalSign entity owns the
relationship (has the foreign key)</li>
<li><code>cascade = ALL</code>: Deleting a user deletes all their
vitals</li>
</ul>
<p><strong>From VitalSign’s Perspective (Many-to-One)</strong>:</p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="at">@ManyToOne</span><span class="op">(</span>fetch <span class="op">=</span> FetchType<span class="op">.</span><span class="fu">LAZY</span><span class="op">)</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="at">@JoinColumn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;user_id&quot;</span><span class="op">,</span> nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> User user<span class="op">;</span></span></code></pre></div>
<ul>
<li>Many vitals belong to one user</li>
<li><code>fetch = LAZY</code>: Don’t load the user unless accessed
(performance optimization)</li>
<li><code>@JoinColumn</code>: Creates <code>user_id</code> foreign key
column in <code>vital_signs</code> table</li>
</ul>
<p><strong>Database Schema Generated</strong>:</p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- users table</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> users (</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> BIGSERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    email <span class="dt">VARCHAR</span>(<span class="dv">255</span>) <span class="kw">UNIQUE</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">password</span> <span class="dt">VARCHAR</span>(<span class="dv">255</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    first_name <span class="dt">VARCHAR</span>(<span class="dv">255</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    last_name <span class="dt">VARCHAR</span>(<span class="dv">255</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">role</span> <span class="dt">VARCHAR</span>(<span class="dv">50</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    active <span class="dt">BOOLEAN</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> <span class="kw">true</span>,</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    created_date <span class="dt">TIMESTAMP</span>,</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    last_modified_date <span class="dt">TIMESTAMP</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="co">-- vital_signs table</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> vital_signs (</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> BIGSERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>    user_id BIGINT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">type</span> <span class="dt">VARCHAR</span>(<span class="dv">255</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">value</span> <span class="dt">DOUBLE</span> <span class="dt">PRECISION</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>    unit <span class="dt">VARCHAR</span>(<span class="dv">50</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>    notes TEXT,</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>    measurement_time <span class="dt">TIMESTAMP</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>    created_date <span class="dt">TIMESTAMP</span>,</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>    last_modified_date <span class="dt">TIMESTAMP</span>,</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FOREIGN</span> <span class="kw">KEY</span> (user_id) <span class="kw">REFERENCES</span> users(<span class="kw">id</span>) <span class="kw">ON</span> <span class="kw">DELETE</span> <span class="kw">CASCADE</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<h4 id="why-this-architecture-matters-in-healthcare">Why This
Architecture Matters in Healthcare</h4>
<p><strong>Data Integrity</strong>: Annotations like
<code>nullable = false</code> and <code>unique = true</code> prevent
invalid data at the database level, crucial for medical records</p>
<p><strong>Audit Trail</strong>: <code>extends Auditable</code>
automatically tracks when records are created/modified, required for
HIPAA compliance</p>
<p><strong>Referential Integrity</strong>: Foreign key relationships
ensure vital signs can’t exist without a user, preventing orphaned
data</p>
<p><strong>Soft Deletes</strong>: <code>active</code> boolean allows
deactivating users without deleting their medical history</p>
<p><strong>Type Safety</strong>: Java’s strong typing combined with JPA
ensures only valid data structures reach the database</p>
<div class="sourceCode" id="cb42"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co">// model/User.java</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Entity</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="at">@Table</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;users&quot;</span><span class="op">)</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="at">@EntityListeners</span><span class="op">(</span>AuditingEntityListener<span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> User <span class="kw">extends</span> Auditable <span class="op">{</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Id</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GeneratedValue</span><span class="op">(</span>strategy <span class="op">=</span> GenerationType<span class="op">.</span><span class="fu">IDENTITY</span><span class="op">)</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Long</span> id<span class="op">;</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>unique <span class="op">=</span> <span class="kw">true</span><span class="op">,</span> nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Email</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> email<span class="op">;</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> password<span class="op">;</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> firstName<span class="op">;</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> lastName<span class="op">;</span></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Enumerated</span><span class="op">(</span>EnumType<span class="op">.</span><span class="fu">STRING</span><span class="op">)</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> UserRole role<span class="op">;</span></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Boolean</span> active <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">@OneToMany</span><span class="op">(</span>mappedBy <span class="op">=</span> <span class="st">&quot;user&quot;</span><span class="op">,</span> cascade <span class="op">=</span> CascadeType<span class="op">.</span><span class="fu">ALL</span><span class="op">)</span></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">List</span><span class="op">&lt;</span>VitalSign<span class="op">&gt;</span> vitalSigns <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;();</span></span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Constructors, getters, setters</span></span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a><span class="co">// model/VitalSign.java</span></span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a><span class="at">@Entity</span></span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a><span class="at">@Table</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;vital_signs&quot;</span><span class="op">)</span></span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> VitalSign <span class="kw">extends</span> Auditable <span class="op">{</span></span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Id</span></span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GeneratedValue</span><span class="op">(</span>strategy <span class="op">=</span> GenerationType<span class="op">.</span><span class="fu">IDENTITY</span><span class="op">)</span></span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Long</span> id<span class="op">;</span></span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">@ManyToOne</span><span class="op">(</span>fetch <span class="op">=</span> FetchType<span class="op">.</span><span class="fu">LAZY</span><span class="op">)</span></span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">@JoinColumn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;user_id&quot;</span><span class="op">,</span> nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> User user<span class="op">;</span></span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> type<span class="op">;</span></span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-53"><a href="#cb42-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb42-54"><a href="#cb42-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Double</span> value<span class="op">;</span></span>
<span id="cb42-55"><a href="#cb42-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-56"><a href="#cb42-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb42-57"><a href="#cb42-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> unit<span class="op">;</span></span>
<span id="cb42-58"><a href="#cb42-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-59"><a href="#cb42-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span></span>
<span id="cb42-60"><a href="#cb42-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> notes<span class="op">;</span></span>
<span id="cb42-61"><a href="#cb42-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-62"><a href="#cb42-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb42-63"><a href="#cb42-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> LocalDateTime measurementTime<span class="op">;</span></span>
<span id="cb42-64"><a href="#cb42-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-65"><a href="#cb42-65" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Constructors, getters, setters</span></span>
<span id="cb42-66"><a href="#cb42-66" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="repository-layer-spring-data-jpas-magic">Repository Layer:
Spring Data JPA’s Magic</h3>
<p>Spring Data JPA is one of the most developer-friendly features in the
Spring ecosystem. It dramatically reduces boilerplate code by
automatically implementing database operations based solely on method
names. Instead of writing SQL queries, you declare what you want, and
Spring generates the implementation.</p>
<h4 id="the-power-of-method-name-conventions">The Power of Method Name
Conventions</h4>
<p>Spring Data JPA follows a “convention over configuration” philosophy.
By following specific naming patterns, you get fully functional database
queries without writing a single line of SQL. This approach reduces
bugs, improves readability, and makes repositories incredibly
maintainable.</p>
<p><strong>How It Works</strong>: 1. You define an interface extending
<code>JpaRepository&lt;Entity, IdType&gt;</code> 2. You declare method
signatures following Spring Data naming conventions 3. Spring
automatically generates the implementation at runtime 4. You get full
CRUD operations + custom queries for free</p>
<h4 id="repository-examples-with-detailed-explanations">Repository
Examples with Detailed Explanations</h4>
<p>Using Spring Data JPA to create powerful, type-safe database
access:</p>
<div class="sourceCode" id="cb43"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">// repository/UserRepository.java</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="co">// @Repository: Marks this as a Spring-managed repository bean</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Also enables Spring&#39;s exception translation (SQLException → DataAccessException)</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="at">@Repository</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co">// extends JpaRepository&lt;User, Long&gt;:</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="co">//   - User: The entity this repository manages</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="co">//   - Long: The type of User&#39;s primary key (@Id field)</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="co">// This inheritance gives us ~15 methods for free: save(), findById(), findAll(), delete(), etc.</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> UserRepository <span class="kw">extends</span> JpaRepository<span class="op">&lt;</span>User<span class="op">,</span> <span class="bu">Long</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Method name query: Spring parses the method name to generate SQL</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// &quot;findBy&quot; + &quot;Email&quot; → SELECT * FROM users WHERE email = ?</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Return type Optional&lt;User&gt; handles the case where no user found (no null checks needed)</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// </span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Generated SQL:</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// SELECT * FROM users WHERE email = ?</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">//</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Usage example:</span></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Optional&lt;User&gt; user = userRepository.findByEmail(&quot;john@example.com&quot;);</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// if (user.isPresent()) { ... }</span></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>    Optional<span class="op">&lt;</span>User<span class="op">&gt;</span> <span class="fu">findByEmail</span><span class="op">(</span><span class="bu">String</span> email<span class="op">);</span></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Method with multiple conditions: &quot;Role&quot; AND &quot;Active&quot; = True</span></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// &quot;findBy&quot; + &quot;RoleAnd&quot; + &quot;ActiveTrue&quot;</span></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// </span></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Generated SQL:</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// SELECT * FROM users WHERE role = ? AND active = true</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">//</span></span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// &quot;ActiveTrue&quot; is a special keyword - Spring recognizes True/False suffixes</span></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// No need to pass the active value, it&#39;s hardcoded to true</span></span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">//</span></span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Usage:</span></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">// List&lt;User&gt; caregivers = userRepository.findByRoleAndActiveTrue(UserRole.CAREGIVER);</span></span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>User<span class="op">&gt;</span> <span class="fu">findByRoleAndActiveTrue</span><span class="op">(</span>UserRole role<span class="op">);</span></span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">// @Query: When method name queries aren&#39;t expressive enough, write JPQL</span></span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">// JPQL (Java Persistence Query Language): Object-oriented query language</span></span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Queries operate on entities, not tables (&quot;User u&quot; not &quot;users u&quot;)</span></span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// </span></span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Why use @Query here? It&#39;s functionally identical to the method above!</span></span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">// This demonstrates how @Query works for more complex scenarios</span></span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">// </span></span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">// @Param: Binds method parameter to query parameter</span></span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">// &quot;:role&quot; in query matches @Param(&quot;role&quot;) in method signature</span></span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Query</span><span class="op">(</span><span class="st">&quot;SELECT u FROM User u WHERE u.role = :role AND u.active = true&quot;</span><span class="op">)</span></span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>User<span class="op">&gt;</span> <span class="fu">findActiveUsersByRole</span><span class="op">(</span><span class="at">@Param</span><span class="op">(</span><span class="st">&quot;role&quot;</span><span class="op">)</span> UserRole role<span class="op">);</span></span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Boolean return type: Does a matching record exist?</span></span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">// More efficient than findByEmail() if you only need to check existence</span></span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">// </span></span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Generated SQL:</span></span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">// SELECT EXISTS(SELECT 1 FROM users WHERE email = ?)</span></span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a>    <span class="co">//</span></span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">// This is a COUNT or EXISTS query, not a full SELECT</span></span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Returns true/false without loading the entire User object (performance optimization)</span></span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">//</span></span>
<span id="cb43-58"><a href="#cb43-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Usage:</span></span>
<span id="cb43-59"><a href="#cb43-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">// if (userRepository.existsByEmail(&quot;test@example.com&quot;)) {</span></span>
<span id="cb43-60"><a href="#cb43-60" aria-hidden="true" tabindex="-1"></a>    <span class="co">//   throw new EmailAlreadyExistsException();</span></span>
<span id="cb43-61"><a href="#cb43-61" aria-hidden="true" tabindex="-1"></a>    <span class="co">// }</span></span>
<span id="cb43-62"><a href="#cb43-62" aria-hidden="true" tabindex="-1"></a>    <span class="dt">boolean</span> <span class="fu">existsByEmail</span><span class="op">(</span><span class="bu">String</span> email<span class="op">);</span></span>
<span id="cb43-63"><a href="#cb43-63" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb43-64"><a href="#cb43-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-65"><a href="#cb43-65" aria-hidden="true" tabindex="-1"></a><span class="co">// repository/VitalSignRepository.java</span></span>
<span id="cb43-66"><a href="#cb43-66" aria-hidden="true" tabindex="-1"></a><span class="co">// Repository for VitalSign entities - demonstrates more complex query patterns</span></span>
<span id="cb43-67"><a href="#cb43-67" aria-hidden="true" tabindex="-1"></a><span class="at">@Repository</span></span>
<span id="cb43-68"><a href="#cb43-68" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> VitalSignRepository <span class="kw">extends</span> JpaRepository<span class="op">&lt;</span>VitalSign<span class="op">,</span> <span class="bu">Long</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb43-69"><a href="#cb43-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-70"><a href="#cb43-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Method name with nested property and sorting</span></span>
<span id="cb43-71"><a href="#cb43-71" aria-hidden="true" tabindex="-1"></a>    <span class="co">// &quot;UserId&quot; → navigates to VitalSign.user.id (foreign key)</span></span>
<span id="cb43-72"><a href="#cb43-72" aria-hidden="true" tabindex="-1"></a>    <span class="co">// &quot;OrderBy&quot; + &quot;MeasurementTimeDesc&quot; → ORDER BY measurement_time DESC</span></span>
<span id="cb43-73"><a href="#cb43-73" aria-hidden="true" tabindex="-1"></a>    <span class="co">// </span></span>
<span id="cb43-74"><a href="#cb43-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Generated SQL:</span></span>
<span id="cb43-75"><a href="#cb43-75" aria-hidden="true" tabindex="-1"></a>    <span class="co">// SELECT * FROM vital_signs WHERE user_id = ? ORDER BY measurement_time DESC</span></span>
<span id="cb43-76"><a href="#cb43-76" aria-hidden="true" tabindex="-1"></a>    <span class="co">//</span></span>
<span id="cb43-77"><a href="#cb43-77" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sorting is crucial in healthcare: most recent vitals first</span></span>
<span id="cb43-78"><a href="#cb43-78" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Patient dashboard shows latest blood pressure at the top</span></span>
<span id="cb43-79"><a href="#cb43-79" aria-hidden="true" tabindex="-1"></a>    <span class="co">//</span></span>
<span id="cb43-80"><a href="#cb43-80" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Usage:</span></span>
<span id="cb43-81"><a href="#cb43-81" aria-hidden="true" tabindex="-1"></a>    <span class="co">// List&lt;VitalSign&gt; vitals = vitalSignRepository.findByUserIdOrderByMeasurementTimeDesc(123L);</span></span>
<span id="cb43-82"><a href="#cb43-82" aria-hidden="true" tabindex="-1"></a>    <span class="co">// VitalSign mostRecent = vitals.get(0); // Most recent measurement</span></span>
<span id="cb43-83"><a href="#cb43-83" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>VitalSign<span class="op">&gt;</span> <span class="fu">findByUserIdOrderByMeasurementTimeDesc</span><span class="op">(</span><span class="bu">Long</span> userId<span class="op">);</span></span>
<span id="cb43-84"><a href="#cb43-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-85"><a href="#cb43-85" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Multiple conditions + sorting</span></span>
<span id="cb43-86"><a href="#cb43-86" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Filter by both user AND vital type, then sort by time</span></span>
<span id="cb43-87"><a href="#cb43-87" aria-hidden="true" tabindex="-1"></a>    <span class="co">// </span></span>
<span id="cb43-88"><a href="#cb43-88" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Generated SQL:</span></span>
<span id="cb43-89"><a href="#cb43-89" aria-hidden="true" tabindex="-1"></a>    <span class="co">// SELECT * FROM vital_signs </span></span>
<span id="cb43-90"><a href="#cb43-90" aria-hidden="true" tabindex="-1"></a>    <span class="co">// WHERE user_id = ? AND type = ? </span></span>
<span id="cb43-91"><a href="#cb43-91" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ORDER BY measurement_time DESC</span></span>
<span id="cb43-92"><a href="#cb43-92" aria-hidden="true" tabindex="-1"></a>    <span class="co">//</span></span>
<span id="cb43-93"><a href="#cb43-93" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Example: Get all blood pressure readings for a specific patient</span></span>
<span id="cb43-94"><a href="#cb43-94" aria-hidden="true" tabindex="-1"></a>    <span class="co">// List&lt;VitalSign&gt; bpReadings = repo.findByUserIdAndTypeOrderByMeasurementTimeDesc(</span></span>
<span id="cb43-95"><a href="#cb43-95" aria-hidden="true" tabindex="-1"></a>    <span class="co">//     123L, &quot;blood_pressure&quot;</span></span>
<span id="cb43-96"><a href="#cb43-96" aria-hidden="true" tabindex="-1"></a>    <span class="co">// );</span></span>
<span id="cb43-97"><a href="#cb43-97" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>VitalSign<span class="op">&gt;</span> <span class="fu">findByUserIdAndTypeOrderByMeasurementTimeDesc</span><span class="op">(</span></span>
<span id="cb43-98"><a href="#cb43-98" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Long</span> userId<span class="op">,</span> <span class="bu">String</span> type<span class="op">);</span></span>
<span id="cb43-99"><a href="#cb43-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-100"><a href="#cb43-100" aria-hidden="true" tabindex="-1"></a>    <span class="co">// @Query with date range: JPQL BETWEEN clause</span></span>
<span id="cb43-101"><a href="#cb43-101" aria-hidden="true" tabindex="-1"></a>    <span class="co">// This query couldn&#39;t be expressed with method naming alone (too complex)</span></span>
<span id="cb43-102"><a href="#cb43-102" aria-hidden="true" tabindex="-1"></a>    <span class="co">// </span></span>
<span id="cb43-103"><a href="#cb43-103" aria-hidden="true" tabindex="-1"></a>    <span class="co">// &quot;v.measurementTime BETWEEN :start AND :end&quot; → SQL&#39;s BETWEEN operator</span></span>
<span id="cb43-104"><a href="#cb43-104" aria-hidden="true" tabindex="-1"></a>    <span class="co">// BETWEEN is inclusive: includes both start and end timestamps</span></span>
<span id="cb43-105"><a href="#cb43-105" aria-hidden="true" tabindex="-1"></a>    <span class="co">//</span></span>
<span id="cb43-106"><a href="#cb43-106" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Why JPQL instead of method name? &quot;findByUserIdAndMeasurementTimeBetween&quot; works,</span></span>
<span id="cb43-107"><a href="#cb43-107" aria-hidden="true" tabindex="-1"></a>    <span class="co">// but @Query is clearer when queries get complex</span></span>
<span id="cb43-108"><a href="#cb43-108" aria-hidden="true" tabindex="-1"></a>    <span class="co">//</span></span>
<span id="cb43-109"><a href="#cb43-109" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Usage:</span></span>
<span id="cb43-110"><a href="#cb43-110" aria-hidden="true" tabindex="-1"></a>    <span class="co">// LocalDateTime start = LocalDateTime.now().minusDays(7);</span></span>
<span id="cb43-111"><a href="#cb43-111" aria-hidden="true" tabindex="-1"></a>    <span class="co">// LocalDateTime end = LocalDateTime.now();</span></span>
<span id="cb43-112"><a href="#cb43-112" aria-hidden="true" tabindex="-1"></a>    <span class="co">// List&lt;VitalSign&gt; lastWeek = repo.findByUserIdAndDateRange(123L, start, end);</span></span>
<span id="cb43-113"><a href="#cb43-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Query</span><span class="op">(</span><span class="st">&quot;SELECT v FROM VitalSign v WHERE v.user.id = :userId &quot;</span> <span class="op">+</span></span>
<span id="cb43-114"><a href="#cb43-114" aria-hidden="true" tabindex="-1"></a>           <span class="st">&quot;AND v.measurementTime BETWEEN :start AND :end&quot;</span><span class="op">)</span></span>
<span id="cb43-115"><a href="#cb43-115" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>VitalSign<span class="op">&gt;</span> <span class="fu">findByUserIdAndDateRange</span><span class="op">(</span></span>
<span id="cb43-116"><a href="#cb43-116" aria-hidden="true" tabindex="-1"></a>        <span class="at">@Param</span><span class="op">(</span><span class="st">&quot;userId&quot;</span><span class="op">)</span> <span class="bu">Long</span> userId<span class="op">,</span></span>
<span id="cb43-117"><a href="#cb43-117" aria-hidden="true" tabindex="-1"></a>        <span class="at">@Param</span><span class="op">(</span><span class="st">&quot;start&quot;</span><span class="op">)</span> LocalDateTime start<span class="op">,</span></span>
<span id="cb43-118"><a href="#cb43-118" aria-hidden="true" tabindex="-1"></a>        <span class="at">@Param</span><span class="op">(</span><span class="st">&quot;end&quot;</span><span class="op">)</span> LocalDateTime end<span class="op">);</span></span>
<span id="cb43-119"><a href="#cb43-119" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="understanding-method-name-query-conventions">Understanding
Method Name Query Conventions</h4>
<p>Spring Data JPA recognizes keywords in method names to build
queries:</p>
<p><strong>Prefixes (Start of method name)</strong>: -
<code>findBy...</code> → SELECT query - <code>existsBy...</code> →
EXISTS/COUNT query (returns boolean) - <code>countBy...</code> → COUNT
query (returns long) - <code>deleteBy...</code> → DELETE query (returns
void or int)</p>
<p><strong>Keywords (Conditions)</strong>: - <code>And</code> → SQL AND
- <code>Or</code> → SQL OR - <code>Between</code> → SQL BETWEEN -
<code>LessThan</code>, <code>GreaterThan</code> → SQL &lt; and &gt; -
<code>Like</code> → SQL LIKE (wildcards) - <code>IgnoreCase</code> →
Case-insensitive comparison - <code>OrderBy...Asc/Desc</code> → ORDER
BY</p>
<p><strong>Examples</strong>:</p>
<div class="sourceCode" id="cb44"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Find users by email OR username</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>Optional<span class="op">&lt;</span>User<span class="op">&gt;</span> <span class="fu">findByEmailOrUsername</span><span class="op">(</span><span class="bu">String</span> email<span class="op">,</span> <span class="bu">String</span> username<span class="op">);</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Find vitals with value greater than threshold</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span>VitalSign<span class="op">&gt;</span> <span class="fu">findByValueGreaterThan</span><span class="op">(</span><span class="bu">Double</span> threshold<span class="op">);</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Count users created after a date</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="dt">long</span> <span class="fu">countByCreatedDateAfter</span><span class="op">(</span>LocalDateTime date<span class="op">);</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Delete inactive users (returns number of deleted entities)</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> <span class="fu">deleteByActiveFalse</span><span class="op">();</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Find users with name containing string (case-insensitive)</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span>User<span class="op">&gt;</span> <span class="fu">findByFirstNameContainingIgnoreCase</span><span class="op">(</span><span class="bu">String</span> name<span class="op">);</span></span></code></pre></div>
<h4 id="when-to-use-query-vs-method-names">When to Use <span
class="citation" data-cites="Query">@Query</span> vs Method Names</h4>
<p><strong>Use Method Names When</strong>: - Query is simple (1-3
conditions) - Standard CRUD operations - Readability is clear</p>
<p><strong>Use <span class="citation" data-cites="Query">@Query</span>
When</strong>: - Complex joins across multiple tables - Aggregate
functions (COUNT, AVG, SUM) - Subqueries or advanced SQL - Method name
would be too long/unclear</p>
<p><strong>Example of <span class="citation"
data-cites="Query">@Query</span> Necessity</strong>:</p>
<div class="sourceCode" id="cb45"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">// This would require an unreadably long method name:</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="co">// findByUserIdAndMeasurementTimeBetweenAndValueGreaterThanAndTypeLikeIgnoreCase</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Better as @Query:</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="at">@Query</span><span class="op">(</span><span class="st">&quot;SELECT v FROM VitalSign v WHERE v.user.id = :userId &quot;</span> <span class="op">+</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>       <span class="st">&quot;AND v.measurementTime BETWEEN :start AND :end &quot;</span> <span class="op">+</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>       <span class="st">&quot;AND v.value &gt; :minValue &quot;</span> <span class="op">+</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>       <span class="st">&quot;AND LOWER(v.type) LIKE LOWER(CONCAT(&#39;%&#39;, :typePattern, &#39;%&#39;))&quot;</span><span class="op">)</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span>VitalSign<span class="op">&gt;</span> <span class="fu">findComplexVitalCriteria</span><span class="op">(</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Param</span><span class="op">(</span><span class="st">&quot;userId&quot;</span><span class="op">)</span> <span class="bu">Long</span> userId<span class="op">,</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Param</span><span class="op">(</span><span class="st">&quot;start&quot;</span><span class="op">)</span> LocalDateTime start<span class="op">,</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Param</span><span class="op">(</span><span class="st">&quot;end&quot;</span><span class="op">)</span> LocalDateTime end<span class="op">,</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Param</span><span class="op">(</span><span class="st">&quot;minValue&quot;</span><span class="op">)</span> <span class="bu">Double</span> minValue<span class="op">,</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Param</span><span class="op">(</span><span class="st">&quot;typePattern&quot;</span><span class="op">)</span> <span class="bu">String</span> typePattern</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a><span class="op">);</span></span></code></pre></div>
<h4 id="inherited-methods-from-jparepository">Inherited Methods from
JpaRepository</h4>
<p>Every repository automatically gets these methods (no code
needed):</p>
<div class="sourceCode" id="cb46"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Basic CRUD</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span><span class="op">(</span>User user<span class="op">)</span>                    <span class="co">// Insert or update</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="fu">saveAll</span><span class="op">(</span><span class="bu">Iterable</span><span class="op">&lt;</span>User<span class="op">&gt;</span> users<span class="op">)</span>      <span class="co">// Batch save</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="fu">findById</span><span class="op">(</span><span class="bu">Long</span> id<span class="op">)</span>                  <span class="co">// Find by primary key</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="fu">findAll</span><span class="op">()</span>                          <span class="co">// Get all entities</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="fu">findAllById</span><span class="op">(</span><span class="bu">Iterable</span><span class="op">&lt;</span><span class="bu">Long</span><span class="op">&gt;</span> ids<span class="op">)</span>    <span class="co">// Get multiple by IDs</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="fu">delete</span><span class="op">(</span>User user<span class="op">)</span>                  <span class="co">// Delete entity</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="fu">deleteById</span><span class="op">(</span><span class="bu">Long</span> id<span class="op">)</span>                <span class="co">// Delete by ID</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="fu">deleteAll</span><span class="op">()</span>                        <span class="co">// Delete all (use carefully!)</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="fu">count</span><span class="op">()</span>                            <span class="co">// Count all entities</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="fu">existsById</span><span class="op">(</span><span class="bu">Long</span> id<span class="op">)</span>                <span class="co">// Check if ID exists</span></span></code></pre></div>
<h4 id="performance-considerations">Performance Considerations</h4>
<p><strong>1. Lazy Loading (fetch = LAZY)</strong>:</p>
<div class="sourceCode" id="cb47"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="at">@ManyToOne</span><span class="op">(</span>fetch <span class="op">=</span> FetchType<span class="op">.</span><span class="fu">LAZY</span><span class="op">)</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> User user<span class="op">;</span></span></code></pre></div>
<ul>
<li>VitalSign query doesn’t load User unless explicitly accessed</li>
<li>Prevents N+1 query problem (loading 100 vitals wouldn’t trigger 100
user queries)</li>
</ul>
<p><strong>2. Pagination for Large Datasets</strong>:</p>
<div class="sourceCode" id="cb48"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Instead of List&lt;VitalSign&gt;, use Page&lt;VitalSign&gt; for large results</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>Page<span class="op">&lt;</span>VitalSign<span class="op">&gt;</span> <span class="fu">findByUserId</span><span class="op">(</span><span class="bu">Long</span> userId<span class="op">,</span> <span class="bu">Pageable</span> pageable<span class="op">);</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage:</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>PageRequest pageRequest <span class="op">=</span> PageRequest<span class="op">.</span><span class="fu">of</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">20</span><span class="op">);</span> <span class="co">// Page 0, 20 items</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>Page<span class="op">&lt;</span>VitalSign<span class="op">&gt;</span> page <span class="op">=</span> repo<span class="op">.</span><span class="fu">findByUserId</span><span class="op">(</span><span class="dv">123L</span><span class="op">,</span> pageRequest<span class="op">);</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span>VitalSign<span class="op">&gt;</span> vitals <span class="op">=</span> page<span class="op">.</span><span class="fu">getContent</span><span class="op">();</span></span></code></pre></div>
<p><strong>3. Projection for Partial Data</strong>:</p>
<div class="sourceCode" id="cb49"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Only select specific fields instead of entire entity</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Query</span><span class="op">(</span><span class="st">&quot;SELECT v.type, v.value, v.measurementTime FROM VitalSign v WHERE v.user.id = :userId&quot;</span><span class="op">)</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> <span class="fu">findVitalSummary</span><span class="op">(</span><span class="at">@Param</span><span class="op">(</span><span class="st">&quot;userId&quot;</span><span class="op">)</span> <span class="bu">Long</span> userId<span class="op">);</span></span></code></pre></div>
<p>This repository pattern, combined with JPA entities, provides a
robust, type-safe, and efficient way to manage data in CareConnect while
requiring minimal boilerplate code.</p>
<div class="sourceCode" id="cb50"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co">// repository/UserRepository.java</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Repository</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> UserRepository <span class="kw">extends</span> JpaRepository<span class="op">&lt;</span>User<span class="op">,</span> <span class="bu">Long</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    Optional<span class="op">&lt;</span>User<span class="op">&gt;</span> <span class="fu">findByEmail</span><span class="op">(</span><span class="bu">String</span> email<span class="op">);</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>User<span class="op">&gt;</span> <span class="fu">findByRoleAndActiveTrue</span><span class="op">(</span>UserRole role<span class="op">);</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Query</span><span class="op">(</span><span class="st">&quot;SELECT u FROM User u WHERE u.role = :role AND u.active = true&quot;</span><span class="op">)</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>User<span class="op">&gt;</span> <span class="fu">findActiveUsersByRole</span><span class="op">(</span><span class="at">@Param</span><span class="op">(</span><span class="st">&quot;role&quot;</span><span class="op">)</span> UserRole role<span class="op">);</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">boolean</span> <span class="fu">existsByEmail</span><span class="op">(</span><span class="bu">String</span> email<span class="op">);</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a><span class="co">// repository/VitalSignRepository.java</span></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a><span class="at">@Repository</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> VitalSignRepository <span class="kw">extends</span> JpaRepository<span class="op">&lt;</span>VitalSign<span class="op">,</span> <span class="bu">Long</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>VitalSign<span class="op">&gt;</span> <span class="fu">findByUserIdOrderByMeasurementTimeDesc</span><span class="op">(</span><span class="bu">Long</span> userId<span class="op">);</span></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>VitalSign<span class="op">&gt;</span> <span class="fu">findByUserIdAndTypeOrderByMeasurementTimeDesc</span><span class="op">(</span></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Long</span> userId<span class="op">,</span> <span class="bu">String</span> type<span class="op">);</span></span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Query</span><span class="op">(</span><span class="st">&quot;SELECT v FROM VitalSign v WHERE v.user.id = :userId &quot;</span> <span class="op">+</span></span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>           <span class="st">&quot;AND v.measurementTime BETWEEN :start AND :end&quot;</span><span class="op">)</span></span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>VitalSign<span class="op">&gt;</span> <span class="fu">findByUserIdAndDateRange</span><span class="op">(</span></span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">@Param</span><span class="op">(</span><span class="st">&quot;userId&quot;</span><span class="op">)</span> <span class="bu">Long</span> userId<span class="op">,</span></span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">@Param</span><span class="op">(</span><span class="st">&quot;start&quot;</span><span class="op">)</span> LocalDateTime start<span class="op">,</span></span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>        <span class="at">@Param</span><span class="op">(</span><span class="st">&quot;end&quot;</span><span class="op">)</span> LocalDateTime end<span class="op">);</span></span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3
id="service-layer-implementing-business-logic-and-orchestration">Service
Layer: Implementing Business Logic and Orchestration</h3>
<p>The Service Layer in CareConnect acts as the core of our business
logic, sitting between the Controllers (which handle HTTP requests and
responses) and the Repositories (which handle data access). This
architectural separation is crucial in healthcare applications where
business rules can be complex and must be consistently applied across
different access points (REST API, WebSocket, scheduled jobs, etc.).</p>
<h4 id="core-responsibilities">Core Responsibilities</h4>
<p><strong>Orchestrating Complex Operations</strong>: Business processes
in healthcare often involve multiple steps. For example, recording a
vital sign might require: validating the user exists, saving the
measurement, checking for critical values, notifying caregivers if
needed, and updating analytics. The service layer coordinates all these
steps as a single, transactional unit of work.</p>
<p><strong>Enforcing Business Rules</strong>: Validation goes beyond
simple JSR-380 annotations. Services enforce domain-specific rules like
“is this blood pressure reading within a critical range for <em>this
specific patient</em> given their medical history?” These rules often
require database queries or complex calculations.</p>
<p><strong>Applying Security Context</strong>: Services ensure that a
user can only access data they are authorized to see. Even if a
controller is misconfigured, the service layer acts as a second line of
defense by verifying permissions.</p>
<p><strong>Managing Transactions</strong>: Using
<code>@Transactional</code>, services ensure that either all database
operations succeed or all fail together. In healthcare, partial data
saves could lead to inconsistent medical records, so this all-or-nothing
approach is essential.</p>
<h4 id="example-recording-a-vital-sign-with-automated-alerts">Example:
Recording a Vital Sign with Automated Alerts</h4>
<p>This example demonstrates how the service layer orchestrates a
seemingly simple operation (recording a blood pressure reading) into a
multi-step process that maintains data integrity and patient safety:</p>
<div class="sourceCode" id="cb51"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co">// service/HealthService.java</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="at">@Transactional</span> <span class="co">// This entire method is a single transaction</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> HealthService <span class="op">{</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> VitalSignRepository vitalSignRepository<span class="op">;</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> UserRepository userRepository<span class="op">;</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> NotificationService notificationService<span class="op">;</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> VitalSignAnalyzer vitalSignAnalyzer<span class="op">;</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">Logger</span> log <span class="op">=</span> LoggerFactory<span class="op">.</span><span class="fu">getLogger</span><span class="op">(</span>HealthService<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">HealthService</span><span class="op">(</span>VitalSignRepository vitalSignRepository<span class="op">,</span></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>                        UserRepository userRepository<span class="op">,</span></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>                        NotificationService notificationService<span class="op">,</span></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>                        VitalSignAnalyzer vitalSignAnalyzer<span class="op">)</span> <span class="op">{</span></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">vitalSignRepository</span> <span class="op">=</span> vitalSignRepository<span class="op">;</span></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">userRepository</span> <span class="op">=</span> userRepository<span class="op">;</span></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">notificationService</span> <span class="op">=</span> notificationService<span class="op">;</span></span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">vitalSignAnalyzer</span> <span class="op">=</span> vitalSignAnalyzer<span class="op">;</span></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> VitalSignDTO <span class="fu">recordVitalSign</span><span class="op">(</span><span class="bu">Long</span> userId<span class="op">,</span> VitalSignDTO vitalSignDTO<span class="op">)</span> <span class="op">{</span></span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 1. VALIDATE: First, ensure the user exists and is authorized</span></span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">//    This prevents orphaned vital signs and enforces data integrity</span></span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>        User user <span class="op">=</span> userRepository<span class="op">.</span><span class="fu">findById</span><span class="op">(</span>userId<span class="op">)</span></span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">orElseThrow</span><span class="op">(()</span> <span class="op">-&gt;</span> <span class="kw">new</span> <span class="fu">ResourceNotFoundException</span><span class="op">(</span></span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;User not found with id: &quot;</span> <span class="op">+</span> userId<span class="op">));</span></span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Additional business rule: Only patients and caregivers can record vitals</span></span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>user<span class="op">.</span><span class="fu">canRecordVitalSigns</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">UnauthorizedException</span><span class="op">(</span><span class="st">&quot;User is not authorized to record vital signs&quot;</span><span class="op">);</span></span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 2. CONVERT: Map the incoming DTO to a JPA Entity</span></span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">//    DTOs protect our API from exposing internal entity structure</span></span>
<span id="cb51-37"><a href="#cb51-37" aria-hidden="true" tabindex="-1"></a>        VitalSign vitalSign <span class="op">=</span> <span class="kw">new</span> <span class="fu">VitalSign</span><span class="op">();</span></span>
<span id="cb51-38"><a href="#cb51-38" aria-hidden="true" tabindex="-1"></a>        vitalSign<span class="op">.</span><span class="fu">setUser</span><span class="op">(</span>user<span class="op">);</span></span>
<span id="cb51-39"><a href="#cb51-39" aria-hidden="true" tabindex="-1"></a>        vitalSign<span class="op">.</span><span class="fu">setType</span><span class="op">(</span>vitalSignDTO<span class="op">.</span><span class="fu">getType</span><span class="op">());</span></span>
<span id="cb51-40"><a href="#cb51-40" aria-hidden="true" tabindex="-1"></a>        vitalSign<span class="op">.</span><span class="fu">setValue</span><span class="op">(</span>vitalSignDTO<span class="op">.</span><span class="fu">getValue</span><span class="op">());</span></span>
<span id="cb51-41"><a href="#cb51-41" aria-hidden="true" tabindex="-1"></a>        vitalSign<span class="op">.</span><span class="fu">setUnit</span><span class="op">(</span>vitalSignDTO<span class="op">.</span><span class="fu">getUnit</span><span class="op">());</span></span>
<span id="cb51-42"><a href="#cb51-42" aria-hidden="true" tabindex="-1"></a>        vitalSign<span class="op">.</span><span class="fu">setNotes</span><span class="op">(</span>vitalSignDTO<span class="op">.</span><span class="fu">getNotes</span><span class="op">());</span></span>
<span id="cb51-43"><a href="#cb51-43" aria-hidden="true" tabindex="-1"></a>        vitalSign<span class="op">.</span><span class="fu">setMeasurementTime</span><span class="op">(</span>LocalDateTime<span class="op">.</span><span class="fu">now</span><span class="op">());</span></span>
<span id="cb51-44"><a href="#cb51-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-45"><a href="#cb51-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 3. PERSIST: Save the entity to the database</span></span>
<span id="cb51-46"><a href="#cb51-46" aria-hidden="true" tabindex="-1"></a>        <span class="co">//    The transaction ensures this and all subsequent operations succeed together</span></span>
<span id="cb51-47"><a href="#cb51-47" aria-hidden="true" tabindex="-1"></a>        vitalSign <span class="op">=</span> vitalSignRepository<span class="op">.</span><span class="fu">save</span><span class="op">(</span>vitalSign<span class="op">);</span></span>
<span id="cb51-48"><a href="#cb51-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-49"><a href="#cb51-49" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;Recorded vital sign for user {}: {} {}&quot;</span><span class="op">,</span> </span>
<span id="cb51-50"><a href="#cb51-50" aria-hidden="true" tabindex="-1"></a>                userId<span class="op">,</span> vitalSign<span class="op">.</span><span class="fu">getValue</span><span class="op">(),</span> vitalSign<span class="op">.</span><span class="fu">getUnit</span><span class="op">());</span></span>
<span id="cb51-51"><a href="#cb51-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-52"><a href="#cb51-52" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 4. PROCESS BUSINESS LOGIC: Check for critical alerts after saving</span></span>
<span id="cb51-53"><a href="#cb51-53" aria-hidden="true" tabindex="-1"></a>        <span class="co">//    This is a key piece of business logic that belongs in the service</span></span>
<span id="cb51-54"><a href="#cb51-54" aria-hidden="true" tabindex="-1"></a>        <span class="co">//    If this were in the controller, other entry points might miss the check</span></span>
<span id="cb51-55"><a href="#cb51-55" aria-hidden="true" tabindex="-1"></a>        <span class="fu">checkForVitalSignAlerts</span><span class="op">(</span>vitalSign<span class="op">);</span></span>
<span id="cb51-56"><a href="#cb51-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-57"><a href="#cb51-57" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 5. RETURN: Convert the saved entity back to a DTO for the response</span></span>
<span id="cb51-58"><a href="#cb51-58" aria-hidden="true" tabindex="-1"></a>        <span class="co">//    This prevents accidental exposure of Hibernate proxies or lazy-loaded data</span></span>
<span id="cb51-59"><a href="#cb51-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">convertToDTO</span><span class="op">(</span>vitalSign<span class="op">);</span></span>
<span id="cb51-60"><a href="#cb51-60" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb51-61"><a href="#cb51-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-62"><a href="#cb51-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb51-63"><a href="#cb51-63" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> Analyzes a vital sign and sends alerts if critical thresholds are exceeded<span class="co">.</span></span>
<span id="cb51-64"><a href="#cb51-64" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> This method demonstrates separation of concerns<span class="co">:</span> the service orchestrates<span class="co">,</span></span>
<span id="cb51-65"><a href="#cb51-65" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> while specialized components handle the complex medical logic<span class="co">.</span></span>
<span id="cb51-66"><a href="#cb51-66" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb51-67"><a href="#cb51-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">checkForVitalSignAlerts</span><span class="op">(</span>VitalSign vitalSign<span class="op">)</span> <span class="op">{</span></span>
<span id="cb51-68"><a href="#cb51-68" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Delegate the complex medical logic to a dedicated analyzer</span></span>
<span id="cb51-69"><a href="#cb51-69" aria-hidden="true" tabindex="-1"></a>        <span class="co">// This makes the code testable and allows medical rules to be updated</span></span>
<span id="cb51-70"><a href="#cb51-70" aria-hidden="true" tabindex="-1"></a>        <span class="co">// independently of the service layer</span></span>
<span id="cb51-71"><a href="#cb51-71" aria-hidden="true" tabindex="-1"></a>        AlertLevel alertLevel <span class="op">=</span> vitalSignAnalyzer<span class="op">.</span><span class="fu">analyzeVitalSign</span><span class="op">(</span>vitalSign<span class="op">);</span></span>
<span id="cb51-72"><a href="#cb51-72" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-73"><a href="#cb51-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>alertLevel<span class="op">.</span><span class="fu">isCritical</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb51-74"><a href="#cb51-74" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Use the notification service to alert caregivers</span></span>
<span id="cb51-75"><a href="#cb51-75" aria-hidden="true" tabindex="-1"></a>            <span class="co">// This abstraction allows notifications via email, SMS, push, etc.</span></span>
<span id="cb51-76"><a href="#cb51-76" aria-hidden="true" tabindex="-1"></a>            notificationService<span class="op">.</span><span class="fu">sendHealthAlert</span><span class="op">(</span></span>
<span id="cb51-77"><a href="#cb51-77" aria-hidden="true" tabindex="-1"></a>                vitalSign<span class="op">.</span><span class="fu">getUser</span><span class="op">(),</span></span>
<span id="cb51-78"><a href="#cb51-78" aria-hidden="true" tabindex="-1"></a>                <span class="bu">String</span><span class="op">.</span><span class="fu">format</span><span class="op">(</span><span class="st">&quot;Critical </span><span class="sc">%s</span><span class="st"> reading: </span><span class="sc">%s</span><span class="st"> </span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span> </span>
<span id="cb51-79"><a href="#cb51-79" aria-hidden="true" tabindex="-1"></a>                    vitalSign<span class="op">.</span><span class="fu">getType</span><span class="op">(),</span> </span>
<span id="cb51-80"><a href="#cb51-80" aria-hidden="true" tabindex="-1"></a>                    vitalSign<span class="op">.</span><span class="fu">getValue</span><span class="op">(),</span></span>
<span id="cb51-81"><a href="#cb51-81" aria-hidden="true" tabindex="-1"></a>                    vitalSign<span class="op">.</span><span class="fu">getUnit</span><span class="op">()),</span></span>
<span id="cb51-82"><a href="#cb51-82" aria-hidden="true" tabindex="-1"></a>                AlertType<span class="op">.</span><span class="fu">CRITICAL_HEALTH_ALERT</span><span class="op">,</span></span>
<span id="cb51-83"><a href="#cb51-83" aria-hidden="true" tabindex="-1"></a>                alertLevel</span>
<span id="cb51-84"><a href="#cb51-84" aria-hidden="true" tabindex="-1"></a>            <span class="op">);</span></span>
<span id="cb51-85"><a href="#cb51-85" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb51-86"><a href="#cb51-86" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Audit log for compliance - all critical events must be logged</span></span>
<span id="cb51-87"><a href="#cb51-87" aria-hidden="true" tabindex="-1"></a>            log<span class="op">.</span><span class="fu">warn</span><span class="op">(</span><span class="st">&quot;CRITICAL ALERT generated for user {} - {} reading: {} {}&quot;</span><span class="op">,</span></span>
<span id="cb51-88"><a href="#cb51-88" aria-hidden="true" tabindex="-1"></a>                vitalSign<span class="op">.</span><span class="fu">getUser</span><span class="op">().</span><span class="fu">getId</span><span class="op">(),</span></span>
<span id="cb51-89"><a href="#cb51-89" aria-hidden="true" tabindex="-1"></a>                vitalSign<span class="op">.</span><span class="fu">getType</span><span class="op">(),</span></span>
<span id="cb51-90"><a href="#cb51-90" aria-hidden="true" tabindex="-1"></a>                vitalSign<span class="op">.</span><span class="fu">getValue</span><span class="op">(),</span></span>
<span id="cb51-91"><a href="#cb51-91" aria-hidden="true" tabindex="-1"></a>                vitalSign<span class="op">.</span><span class="fu">getUnit</span><span class="op">());</span></span>
<span id="cb51-92"><a href="#cb51-92" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>alertLevel<span class="op">.</span><span class="fu">needsAttention</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb51-93"><a href="#cb51-93" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Send lower-priority notification</span></span>
<span id="cb51-94"><a href="#cb51-94" aria-hidden="true" tabindex="-1"></a>            notificationService<span class="op">.</span><span class="fu">sendHealthAlert</span><span class="op">(</span></span>
<span id="cb51-95"><a href="#cb51-95" aria-hidden="true" tabindex="-1"></a>                vitalSign<span class="op">.</span><span class="fu">getUser</span><span class="op">(),</span></span>
<span id="cb51-96"><a href="#cb51-96" aria-hidden="true" tabindex="-1"></a>                <span class="bu">String</span><span class="op">.</span><span class="fu">format</span><span class="op">(</span><span class="st">&quot;</span><span class="sc">%s</span><span class="st"> reading outside normal range: </span><span class="sc">%s</span><span class="st"> </span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span> </span>
<span id="cb51-97"><a href="#cb51-97" aria-hidden="true" tabindex="-1"></a>                    vitalSign<span class="op">.</span><span class="fu">getType</span><span class="op">(),</span> </span>
<span id="cb51-98"><a href="#cb51-98" aria-hidden="true" tabindex="-1"></a>                    vitalSign<span class="op">.</span><span class="fu">getValue</span><span class="op">(),</span></span>
<span id="cb51-99"><a href="#cb51-99" aria-hidden="true" tabindex="-1"></a>                    vitalSign<span class="op">.</span><span class="fu">getUnit</span><span class="op">()),</span></span>
<span id="cb51-100"><a href="#cb51-100" aria-hidden="true" tabindex="-1"></a>                AlertType<span class="op">.</span><span class="fu">HEALTH_ADVISORY</span><span class="op">,</span></span>
<span id="cb51-101"><a href="#cb51-101" aria-hidden="true" tabindex="-1"></a>                alertLevel</span>
<span id="cb51-102"><a href="#cb51-102" aria-hidden="true" tabindex="-1"></a>            <span class="op">);</span></span>
<span id="cb51-103"><a href="#cb51-103" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb51-104"><a href="#cb51-104" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb51-105"><a href="#cb51-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-106"><a href="#cb51-106" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> VitalSignDTO <span class="fu">convertToDTO</span><span class="op">(</span>VitalSign vitalSign<span class="op">)</span> <span class="op">{</span></span>
<span id="cb51-107"><a href="#cb51-107" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Convert entity to DTO, ensuring we don&#39;t expose internal details</span></span>
<span id="cb51-108"><a href="#cb51-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> VitalSignDTO<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb51-109"><a href="#cb51-109" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">id</span><span class="op">(</span>vitalSign<span class="op">.</span><span class="fu">getId</span><span class="op">())</span></span>
<span id="cb51-110"><a href="#cb51-110" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">type</span><span class="op">(</span>vitalSign<span class="op">.</span><span class="fu">getType</span><span class="op">())</span></span>
<span id="cb51-111"><a href="#cb51-111" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">value</span><span class="op">(</span>vitalSign<span class="op">.</span><span class="fu">getValue</span><span class="op">())</span></span>
<span id="cb51-112"><a href="#cb51-112" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">unit</span><span class="op">(</span>vitalSign<span class="op">.</span><span class="fu">getUnit</span><span class="op">())</span></span>
<span id="cb51-113"><a href="#cb51-113" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">notes</span><span class="op">(</span>vitalSign<span class="op">.</span><span class="fu">getNotes</span><span class="op">())</span></span>
<span id="cb51-114"><a href="#cb51-114" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">measurementTime</span><span class="op">(</span>vitalSign<span class="op">.</span><span class="fu">getMeasurementTime</span><span class="op">())</span></span>
<span id="cb51-115"><a href="#cb51-115" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb51-116"><a href="#cb51-116" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb51-117"><a href="#cb51-117" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="why-this-structure">Why This Structure?</h4>
<p>This method clearly separates concerns: - The
<strong>repository</strong> handles only data persistence and retrieval
- The <strong>analyzer</strong> encapsulates complex medical rules and
thresholds - The <strong>notification service</strong> handles the
mechanics of sending alerts - The <strong>service</strong> orchestrates
all these components into a cohesive workflow</p>
<p>The <code>@Transactional</code> annotation is critical here. If the
alert-sending logic fails (e.g., email server is down), the entire vital
sign recording is rolled back. This ensures we never have a situation
where a critical reading is recorded but caregivers aren’t notified.</p>
<p>In healthcare applications, this transactional integrity is not just
a nice-to-have—it’s a regulatory requirement. The service layer is where
we enforce these guarantees.</p>
<h3 id="controller-layer">Controller Layer</h3>
<p>REST API endpoints:</p>
<div class="sourceCode" id="cb52"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co">// controller/HealthController.java</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="at">@RestController</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/api/health&quot;</span><span class="op">)</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="at">@PreAuthorize</span><span class="op">(</span><span class="st">&quot;hasRole(&#39;PATIENT&#39;) or hasRole(&#39;CAREGIVER&#39;)&quot;</span><span class="op">)</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="at">@Tag</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;Health&quot;</span><span class="op">,</span> description <span class="op">=</span> <span class="st">&quot;Health data management&quot;</span><span class="op">)</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> HealthController <span class="op">{</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> HealthService healthService<span class="op">;</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">HealthController</span><span class="op">(</span>HealthService healthService<span class="op">)</span> <span class="op">{</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">healthService</span> <span class="op">=</span> healthService<span class="op">;</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/vitals&quot;</span><span class="op">)</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Operation</span><span class="op">(</span>summary <span class="op">=</span> <span class="st">&quot;Get user&#39;s vital signs&quot;</span><span class="op">)</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ResponseEntity<span class="op">&lt;</span><span class="bu">List</span><span class="op">&lt;</span>VitalSignDTO<span class="op">&gt;&gt;</span> <span class="fu">getVitalSigns</span><span class="op">(</span></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>            Authentication authentication<span class="op">)</span> <span class="op">{</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Long</span> userId <span class="op">=</span> <span class="fu">getUserIdFromAuthentication</span><span class="op">(</span>authentication<span class="op">);</span></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span>VitalSignDTO<span class="op">&gt;</span> vitalSigns <span class="op">=</span> healthService<span class="op">.</span><span class="fu">getVitalSigns</span><span class="op">(</span>userId<span class="op">);</span></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ResponseEntity<span class="op">.</span><span class="fu">ok</span><span class="op">(</span>vitalSigns<span class="op">);</span></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">@PostMapping</span><span class="op">(</span><span class="st">&quot;/vitals&quot;</span><span class="op">)</span></span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Operation</span><span class="op">(</span>summary <span class="op">=</span> <span class="st">&quot;Record a new vital sign&quot;</span><span class="op">)</span></span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ResponseEntity<span class="op">&lt;</span>VitalSignDTO<span class="op">&gt;</span> <span class="fu">recordVitalSign</span><span class="op">(</span></span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Valid</span> <span class="at">@RequestBody</span> VitalSignDTO vitalSignDTO<span class="op">,</span></span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>            Authentication authentication<span class="op">)</span> <span class="op">{</span></span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Long</span> userId <span class="op">=</span> <span class="fu">getUserIdFromAuthentication</span><span class="op">(</span>authentication<span class="op">);</span></span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>        VitalSignDTO savedVitalSign <span class="op">=</span> healthService<span class="op">.</span><span class="fu">recordVitalSign</span><span class="op">(</span>userId<span class="op">,</span> vitalSignDTO<span class="op">);</span></span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ResponseEntity<span class="op">.</span><span class="fu">status</span><span class="op">(</span>HttpStatus<span class="op">.</span><span class="fu">CREATED</span><span class="op">).</span><span class="fu">body</span><span class="op">(</span>savedVitalSign<span class="op">);</span></span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/vitals/{type}&quot;</span><span class="op">)</span></span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Operation</span><span class="op">(</span>summary <span class="op">=</span> <span class="st">&quot;Get vital signs by type&quot;</span><span class="op">)</span></span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ResponseEntity<span class="op">&lt;</span><span class="bu">List</span><span class="op">&lt;</span>VitalSignDTO<span class="op">&gt;&gt;</span> <span class="fu">getVitalSignsByType</span><span class="op">(</span></span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a>            <span class="at">@PathVariable</span> <span class="bu">String</span> type<span class="op">,</span></span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a>            Authentication authentication<span class="op">)</span> <span class="op">{</span></span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Long</span> userId <span class="op">=</span> <span class="fu">getUserIdFromAuthentication</span><span class="op">(</span>authentication<span class="op">);</span></span>
<span id="cb52-44"><a href="#cb52-44" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span>VitalSignDTO<span class="op">&gt;</span> vitalSigns <span class="op">=</span> healthService<span class="op">.</span><span class="fu">getVitalSignsByType</span><span class="op">(</span>userId<span class="op">,</span> type<span class="op">);</span></span>
<span id="cb52-45"><a href="#cb52-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-46"><a href="#cb52-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ResponseEntity<span class="op">.</span><span class="fu">ok</span><span class="op">(</span>vitalSigns<span class="op">);</span></span>
<span id="cb52-47"><a href="#cb52-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb52-48"><a href="#cb52-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-49"><a href="#cb52-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Long</span> <span class="fu">getUserIdFromAuthentication</span><span class="op">(</span>Authentication authentication<span class="op">)</span> <span class="op">{</span></span>
<span id="cb52-50"><a href="#cb52-50" aria-hidden="true" tabindex="-1"></a>        UserPrincipal userPrincipal <span class="op">=</span> <span class="op">(</span>UserPrincipal<span class="op">)</span> authentication<span class="op">.</span><span class="fu">getPrincipal</span><span class="op">();</span></span>
<span id="cb52-51"><a href="#cb52-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> userPrincipal<span class="op">.</span><span class="fu">getId</span><span class="op">();</span></span>
<span id="cb52-52"><a href="#cb52-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb52-53"><a href="#cb52-53" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="database-design">Database Design</h2>
<h3 id="entity-relationship-diagram">Entity Relationship Diagram</h3>
<pre><code>Users                          VitalSigns
┌─────────────────────┐       ┌─────────────────────┐
│ id (PK)             │       │ id (PK)             │
│ email (UQ)          │       │ user_id (FK)        │
│ password            │       │ type                │
│ first_name          │       │ value               │
│ last_name           │       │ unit                │
│ role                │       │ notes               │
│ active              │       │ measurement_time    │
│ created_at          │       │ created_at          │
│ updated_at          │       │ updated_at          │
└─────────────────────┘       └─────────────────────┘
          │                            │
          └────────────1:N─────────────┘

CaregiverPatientLink          ChatMessages
┌─────────────────────┐       ┌─────────────────────┐
│ id (PK)             │       │ id (PK)             │
│ caregiver_id (FK)   │       │ sender_id (FK)      │
│ patient_id (FK)     │       │ receiver_id (FK)    │
│ status              │       │ content             │
│ created_at          │       │ message_type        │
│ updated_at          │       │ sent_at             │
└─────────────────────┘       └─────────────────────┘</code></pre>
<h3 id="database-schema">Database Schema</h3>
<div class="sourceCode" id="cb54"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Users table</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> users (</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> BIGINT <span class="kw">PRIMARY</span> <span class="kw">KEY</span> AUTO_INCREMENT,</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    email <span class="dt">VARCHAR</span>(<span class="dv">255</span>) <span class="kw">UNIQUE</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">password</span> <span class="dt">VARCHAR</span>(<span class="dv">255</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    first_name <span class="dt">VARCHAR</span>(<span class="dv">100</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    last_name <span class="dt">VARCHAR</span>(<span class="dv">100</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">role</span> ENUM(<span class="st">&#39;PATIENT&#39;</span>, <span class="st">&#39;CAREGIVER&#39;</span>, <span class="st">&#39;FAMILY_MEMBER&#39;</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    active <span class="dt">BOOLEAN</span> <span class="kw">DEFAULT</span> <span class="kw">TRUE</span>,</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    created_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>    updated_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span> <span class="kw">ON</span> <span class="kw">UPDATE</span> <span class="fu">CURRENT_TIMESTAMP</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="co">-- Vital signs table</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> vital_signs (</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> BIGINT <span class="kw">PRIMARY</span> <span class="kw">KEY</span> AUTO_INCREMENT,</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>    user_id BIGINT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">type</span> <span class="dt">VARCHAR</span>(<span class="dv">50</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">value</span> <span class="dt">DECIMAL</span>(<span class="dv">10</span>,<span class="dv">2</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>    unit <span class="dt">VARCHAR</span>(<span class="dv">20</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>    notes TEXT,</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>    measurement_time DATETIME <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>    created_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>    updated_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span> <span class="kw">ON</span> <span class="kw">UPDATE</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FOREIGN</span> <span class="kw">KEY</span> (user_id) <span class="kw">REFERENCES</span> users(<span class="kw">id</span>) <span class="kw">ON</span> <span class="kw">DELETE</span> <span class="kw">CASCADE</span></span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a><span class="co">-- Indexes</span></span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_users_email <span class="kw">ON</span> users(email);</span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_users_role <span class="kw">ON</span> users(<span class="kw">role</span>);</span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_vital_signs_user_id <span class="kw">ON</span> vital_signs(user_id);</span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_vital_signs_type <span class="kw">ON</span> vital_signs(<span class="kw">type</span>);</span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_vital_signs_measurement_time <span class="kw">ON</span> vital_signs(measurement_time);</span></code></pre></div>
<h2 id="api-documentation">API Documentation</h2>
<h3 id="openapi-configuration">OpenAPI Configuration</h3>
<div class="sourceCode" id="cb55"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co">// config/OpenApiConfig.java</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Configuration</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="at">@EnableWebSecurity</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> OpenApiConfig <span class="op">{</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> OpenAPI <span class="fu">customOpenAPI</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">OpenAPI</span><span class="op">()</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="kw">new</span> <span class="fu">Info</span><span class="op">()</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">title</span><span class="op">(</span><span class="st">&quot;CareConnect API&quot;</span><span class="op">)</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">version</span><span class="op">(</span><span class="st">&quot;1.0.0&quot;</span><span class="op">)</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">description</span><span class="op">(</span><span class="st">&quot;Healthcare management platform API&quot;</span><span class="op">))</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">addSecurityItem</span><span class="op">(</span><span class="kw">new</span> <span class="fu">SecurityRequirement</span><span class="op">().</span><span class="fu">addList</span><span class="op">(</span><span class="st">&quot;bearerAuth&quot;</span><span class="op">))</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">components</span><span class="op">(</span><span class="kw">new</span> <span class="fu">Components</span><span class="op">()</span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">addSecuritySchemes</span><span class="op">(</span><span class="st">&quot;bearerAuth&quot;</span><span class="op">,</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">new</span> <span class="fu">SecurityScheme</span><span class="op">()</span></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">type</span><span class="op">(</span>SecurityScheme<span class="op">.</span><span class="fu">Type</span><span class="op">.</span><span class="fu">HTTP</span><span class="op">)</span></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">scheme</span><span class="op">(</span><span class="st">&quot;bearer&quot;</span><span class="op">)</span></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">bearerFormat</span><span class="op">(</span><span class="st">&quot;JWT&quot;</span><span class="op">)));</span></span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="restful-api-endpoints">RESTful API Endpoints</h3>
<p>The CareConnect backend provides a comprehensive RESTful API with
over 100 endpoints organized by functional domains. All endpoints follow
consistent patterns with proper HTTP methods, status codes, and JSON
responses.</p>
<h4 id="base-url-and-versioning">Base URL and Versioning</h4>
<p>All API endpoints are prefixed with <code>/v1/api/</code> (with some
legacy endpoints at <code>/api/</code>). The backend runs on Spring Boot
with embedded Tomcat.</p>
<pre><code>Base URL: http://localhost:8080/v1/api
Production: https://your-domain.com/v1/api</code></pre>
<h4 id="authentication-authorization">Authentication &amp;
Authorization</h4>
<p>Most endpoints require Bearer token authentication obtained through
the login process:</p>
<pre class="http"><code>Authorization: Bearer &lt;jwt-token&gt;</code></pre>
<p><strong>Public Endpoints (No Authentication Required):</strong> - All
<code>/v1/api/auth/**</code> endpoints (registration, login, password
reset) - <code>/v1/api/emergency/**</code> endpoints (emergency PDF
access) - <code>/v1/api/public/**</code> endpoints - Email verification
and OAuth callbacks</p>
<h4 id="core-api-endpoints-by-domain">Core API Endpoints by Domain</h4>
<h5 id="authentication-v1apiauth">1. Authentication
(<code>/v1/api/auth</code>)</h5>
<p><strong>Registration &amp; Login</strong></p>
<pre class="http"><code>POST /v1/api/auth/register
Content-Type: application/json
{
  &quot;email&quot;: &quot;user@example.com&quot;,
  &quot;password&quot;: &quot;password123&quot;,
  &quot;name&quot;: &quot;John Doe&quot;,
  &quot;role&quot;: &quot;PATIENT&quot;
}

POST /v1/api/auth/login
Content-Type: application/json
{
  &quot;email&quot;: &quot;user@example.com&quot;,
  &quot;password&quot;: &quot;password123&quot;
}
Response: {
  &quot;token&quot;: &quot;jwt-token&quot;,
  &quot;user&quot;: {...},
  &quot;patientId&quot;: 123,
  &quot;caregiverId&quot;: null
}</code></pre>
<p><strong>Password Management</strong></p>
<pre class="http"><code>POST /v1/api/auth/password/forgot
POST /v1/api/auth/password/change
GET /v1/api/auth/password/reset?token=abc123</code></pre>
<p><strong>OAuth &amp; Third-Party Integration</strong></p>
<pre class="http"><code>GET /v1/api/auth/sso/google
POST /v1/api/auth/sso/alexa/code
POST /v1/api/auth/sso/alexa/token</code></pre>
<h5 id="patient-management-v1apipatients">2. Patient Management
(<code>/v1/api/patients</code>)</h5>
<p><strong>Patient Profile</strong></p>
<pre class="http"><code>GET /v1/api/patients/{patientId}
PUT /v1/api/patients/{patientId}
GET /v1/api/patients/me  # Current patient&#39;s profile
GET /v1/api/patients/{patientId}/profile/enhanced  # With medical data</code></pre>
<p><strong>Mood &amp; Pain Tracking</strong></p>
<pre class="http"><code>POST /v1/api/patients/mood-pain-log
{
  &quot;mood&quot;: 7,
  &quot;pain&quot;: 3,
  &quot;timestamp&quot;: &quot;2024-01-15T10:30:00Z&quot;,
  &quot;notes&quot;: &quot;Feeling better today&quot;
}

GET /v1/api/patients/mood-pain-log/range?startDate=2024-01-01&amp;endDate=2024-01-31
GET /v1/api/patients/mood-pain-log/analytics?startDate=2024-01-01&amp;endDate=2024-01-31</code></pre>
<p><strong>Medication Management</strong></p>
<pre class="http"><code>GET /v1/api/patients/{patientId}/medications
POST /v1/api/patients/{patientId}/medications
DELETE /v1/api/patients/{patientId}/medications/{medicationId}  # Soft delete</code></pre>
<p><strong>Family Member Relations</strong></p>
<pre class="http"><code>GET /v1/api/patients/{patientId}/family-members
POST /v1/api/patients/{patientId}/family-members
{
  &quot;email&quot;: &quot;family@example.com&quot;,
  &quot;firstName&quot;: &quot;Jane&quot;,
  &quot;lastName&quot;: &quot;Doe&quot;,
  &quot;relationship&quot;: &quot;daughter&quot;,
  &quot;permissions&quot;: [&quot;VIEW_PROFILE&quot;, &quot;VIEW_VITALS&quot;]
}</code></pre>
<h5 id="caregiver-operations-v1apicaregivers">3. Caregiver Operations
(<code>/v1/api/caregivers</code>)</h5>
<pre class="http"><code>GET /v1/api/caregivers/{caregiverId}/patients?email=patient@example.com&amp;name=John
POST /v1/api/caregivers/{caregiverId}/patients
{
  &quot;email&quot;: &quot;newpatient@example.com&quot;,
  &quot;firstName&quot;: &quot;New&quot;,
  &quot;lastName&quot;: &quot;Patient&quot;,
  &quot;dateOfBirth&quot;: &quot;1990-01-01&quot;,
  &quot;emergencyContactName&quot;: &quot;Contact Name&quot;,
  &quot;emergencyContactPhone&quot;: &quot;555-0123&quot;
}

POST /v1/api/caregivers/{caregiverId}/patients/add
{
  &quot;email&quot;: &quot;existing@example.com&quot;
}</code></pre>
<h5 id="analytics-vital-signs-v1apianalytics">4. Analytics &amp; Vital
Signs (<code>/v1/api/analytics</code>)</h5>
<p><strong>Dashboard &amp; Vitals</strong></p>
<pre class="http"><code>GET /v1/api/analytics/dashboard?patientId=123&amp;days=30
GET /v1/api/analytics/vitals?patientId=123&amp;days=7

POST /v1/api/analytics/vitals
{
  &quot;patientId&quot;: 123,
  &quot;vitalType&quot;: &quot;BLOOD_PRESSURE&quot;,
  &quot;systolic&quot;: 120,
  &quot;diastolic&quot;: 80,
  &quot;timestamp&quot;: &quot;2024-01-15T10:30:00Z&quot;,
  &quot;notes&quot;: &quot;Morning reading&quot;
}</code></pre>
<p><strong>Data Export</strong></p>
<pre class="http"><code>GET /v1/api/analytics/export/vitals/csv?patientId=123&amp;days=30
GET /v1/api/analytics/export/vitals/pdf?patientId=123&amp;days=30</code></pre>
<p><strong>Live Data Streaming</strong></p>
<pre class="http"><code>GET /v1/api/analytics/live?patientId=123
Accept: text/event-stream
# Returns Server-Sent Events stream</code></pre>
<h5 id="task-management">5. Task Management</h5>
<p><strong>Version 2 (Current)</strong></p>
<pre class="http"><code>GET /v2/api/tasks/patient/{patientId}
POST /v2/api/tasks/patient/{patientId}
{
  &quot;title&quot;: &quot;Take medication&quot;,
  &quot;description&quot;: &quot;Take morning pills&quot;,
  &quot;dueDate&quot;: &quot;2024-01-15T09:00:00Z&quot;,
  &quot;priority&quot;: &quot;HIGH&quot;,
  &quot;completed&quot;: false
}

PUT /v2/api/tasks/{id}/complete
{
  &quot;isComplete&quot;: true
}

DELETE /v2/api/tasks/{id}?deleteSeries=true  # For recurring tasks</code></pre>
<h5 id="messaging-communication-v1apimessages">6. Messaging &amp;
Communication (<code>/v1/api/messages</code>)</h5>
<pre class="http"><code>POST /v1/api/messages/send
{
  &quot;senderId&quot;: 123,
  &quot;receiverId&quot;: 456,
  &quot;content&quot;: &quot;How are you feeling today?&quot;,
  &quot;messageType&quot;: &quot;TEXT&quot;
}

GET /v1/api/messages/conversation?user1=123&amp;user2=456
GET /v1/api/messages/inbox/{userId}</code></pre>
<h5 id="notifications-v1apinotifications">7. Notifications
(<code>/v1/api/notifications</code>)</h5>
<p><strong>Push Notifications</strong></p>
<pre class="http"><code>POST /v1/api/notifications/send
{
  &quot;title&quot;: &quot;Medication Reminder&quot;,
  &quot;body&quot;: &quot;Time to take your morning medication&quot;,
  &quot;fcmTokens&quot;: [&quot;fcm-token-1&quot;, &quot;fcm-token-2&quot;],
  &quot;notificationType&quot;: &quot;MEDICATION_REMINDER&quot;,
  &quot;data&quot;: {
    &quot;medicationId&quot;: &quot;123&quot;,
    &quot;patientId&quot;: &quot;456&quot;
  }
}</code></pre>
<p><strong>Specialized Alerts</strong></p>
<pre class="http"><code>POST /v1/api/notifications/vital-alert/{patientId}?vitalType=BLOOD_PRESSURE&amp;vitalValue=180/120&amp;alertLevel=HIGH
POST /v1/api/notifications/emergency-alert/{patientId}?emergencyType=FALL_DETECTED&amp;location=Living Room
POST /v1/api/notifications/medication-reminder/{patientId}?medicationName=Aspirin&amp;dosage=100mg&amp;scheduledTime=09:00</code></pre>
<h5 id="file-management-v1apifiles">8. File Management
(<code>/v1/api/files</code>)</h5>
<pre class="http"><code>POST /v1/api/files/upload
Content-Type: multipart/form-data
file: &lt;binary-data&gt;
category: &quot;MEDICAL_RECORDS&quot;
description: &quot;Lab results from 2024-01-15&quot;
patientId: 123

GET /v1/api/files/{fileId}/download
GET /v1/api/files/my-files?category=MEDICAL_RECORDS
GET /v1/api/files/patient/{patientId}?category=PRESCRIPTIONS
DELETE /v1/api/files/{fileId}</code></pre>
<h5 id="emergency-services-v1apiemergency">9. Emergency Services
(<code>/v1/api/emergency</code>)</h5>
<p><strong>Public Emergency Access (No Authentication)</strong></p>
<pre class="http"><code>GET /v1/api/emergency/{emergencyId}.pdf
# Returns Vial of Life PDF with patient emergency information
# emergencyId format: VIAL123456

GET /v1/api/emergency/download/{emergencyId}.pdf
# Forces download instead of browser viewing</code></pre>
<h5 id="electronic-visit-verification-evv-v1apievv">10. Electronic Visit
Verification (EVV) (<code>/v1/api/evv</code>)</h5>
<pre class="http"><code>POST /v1/api/evv/participants
{
  &quot;participantName&quot;: &quot;John Doe&quot;,
  &quot;participantId&quot;: &quot;P123456&quot;,
  &quot;serviceType&quot;: &quot;PERSONAL_CARE&quot;,
  &quot;authorizedHours&quot;: 40
}

POST /v1/api/evv/records
{
  &quot;participantId&quot;: &quot;P123456&quot;,
  &quot;providerId&quot;: &quot;PRV789&quot;,
  &quot;serviceDate&quot;: &quot;2024-01-15&quot;,
  &quot;clockInTime&quot;: &quot;09:00:00&quot;,
  &quot;clockOutTime&quot;: &quot;17:00:00&quot;,
  &quot;serviceLocation&quot;: &quot;123 Main St&quot;,
  &quot;servicesProvided&quot;: [&quot;PERSONAL_CARE&quot;, &quot;MEAL_PREPARATION&quot;],
  &quot;gpsCoordinates&quot;: {
    &quot;latitude&quot;: 38.9072,
    &quot;longitude&quot;: -77.0369
  }
}

GET /v1/api/evv/records/search?participantId=P123456&amp;startDate=2024-01-01&amp;endDate=2024-01-31</code></pre>
<h5 id="alexa-integration-v1apialexa">11. Alexa Integration
(<code>/v1/api/alexa</code>)</h5>
<pre class="http"><code>GET /v1/api/alexa/calendarTasks/get?filter=week
Authorization: Bearer &lt;alexa-access-token&gt;

POST /v1/api/alexa/calendarTasks/add
Authorization: Bearer &lt;alexa-access-token&gt;
{
  &quot;name&quot;: &quot;Doctor appointment&quot;,
  &quot;description&quot;: &quot;Annual checkup with Dr. Smith&quot;,
  &quot;date&quot;: &quot;2024-01-20&quot;,
  &quot;timeOfDay&quot;: &quot;MORNING&quot;,
  &quot;priority&quot;: &quot;HIGH&quot;
}</code></pre>
<h5 id="subscription-management-v1apisubscriptions">12. Subscription
Management (<code>/v1/api/subscriptions</code>)</h5>
<pre class="http"><code>GET /v1/api/subscriptions/plans
POST /v1/api/subscriptions/create?plan=premium&amp;userId=123&amp;amount=2999
GET /v1/api/subscriptions/user/{userId}/active
POST /v1/api/subscriptions/{id}/cancel
POST /v1/api/subscriptions/upgrade-or-downgrade?oldSubscriptionId=sub_123&amp;newPriceId=price_456</code></pre>
<h4 id="error-handling-1">Error Handling</h4>
<p>All endpoints return consistent error responses:</p>
<div class="sourceCode" id="cb78"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;2024-01-15T10:30:00Z&quot;</span><span class="fu">,</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;status&quot;</span><span class="fu">:</span> <span class="dv">400</span><span class="fu">,</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;error&quot;</span><span class="fu">:</span> <span class="st">&quot;Bad Request&quot;</span><span class="fu">,</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;message&quot;</span><span class="fu">:</span> <span class="st">&quot;Validation failed for field &#39;email&#39;&quot;</span><span class="fu">,</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;path&quot;</span><span class="fu">:</span> <span class="st">&quot;/v1/api/auth/register&quot;</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>Common HTTP Status Codes:</strong> - <code>200</code> -
Success - <code>201</code> - Created - <code>400</code> - Bad Request
(validation errors) - <code>401</code> - Unauthorized (missing/invalid
token) - <code>403</code> - Forbidden (insufficient permissions) -
<code>404</code> - Not Found - <code>409</code> - Conflict (duplicate
resource) - <code>500</code> - Internal Server Error</p>
<h4 id="rate-limiting">Rate Limiting</h4>
<p>API endpoints implement rate limiting based on user role: -
<strong>Public endpoints</strong>: 100 requests per hour per IP -
<strong>Authenticated users</strong>: 1000 requests per hour per user -
<strong>Emergency endpoints</strong>: No rate limiting</p>
<h4 id="data-formats">Data Formats</h4>
<p><strong>Date/Time</strong>: ISO 8601 format
(<code>2024-01-15T10:30:00Z</code>) <strong>Pagination</strong>:</p>
<div class="sourceCode" id="cb79"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;content&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="er">...</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;pageable&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;page&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;size&quot;</span><span class="fu">:</span> <span class="dv">20</span><span class="fu">,</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;sort&quot;</span><span class="fu">:</span> <span class="st">&quot;createdAt,desc&quot;</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;totalElements&quot;</span><span class="fu">:</span> <span class="dv">100</span><span class="fu">,</span></span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;totalPages&quot;</span><span class="fu">:</span> <span class="dv">5</span></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h4 id="websocket-integration">WebSocket Integration</h4>
<p>Real-time communication endpoints at <code>/ws</code>: -
<code>/ws/notifications</code> - Real-time notifications -
<code>/ws/vitals</code> - Live vital signs updates -
<code>/ws/chat</code> - Messaging system</p>
<h2 id="authentication-security">Authentication &amp; Security</h2>
<h3 id="jwt-implementation">JWT Implementation</h3>
<div class="sourceCode" id="cb80"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co">// util/JwtUtil.java</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Component</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> JwtUtil <span class="op">{</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Value</span><span class="op">(</span><span class="st">&quot;${jwt.secret}&quot;</span><span class="op">)</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> jwtSecret<span class="op">;</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Value</span><span class="op">(</span><span class="st">&quot;${jwt.expiration}&quot;</span><span class="op">)</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">long</span> jwtExpiration<span class="op">;</span></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">generateToken</span><span class="op">(</span>UserDetails userDetails<span class="op">)</span> <span class="op">{</span></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> claims <span class="op">=</span> <span class="kw">new</span> <span class="bu">HashMap</span><span class="op">&lt;&gt;();</span></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">createToken</span><span class="op">(</span>claims<span class="op">,</span> userDetails<span class="op">.</span><span class="fu">getUsername</span><span class="op">());</span></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> <span class="fu">createToken</span><span class="op">(</span><span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> claims<span class="op">,</span> <span class="bu">String</span> subject<span class="op">)</span> <span class="op">{</span></span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Jwts<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">setClaims</span><span class="op">(</span>claims<span class="op">)</span></span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">setSubject</span><span class="op">(</span>subject<span class="op">)</span></span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">setIssuedAt</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Date</span><span class="op">(</span><span class="bu">System</span><span class="op">.</span><span class="fu">currentTimeMillis</span><span class="op">()))</span></span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">setExpiration</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Date</span><span class="op">(</span><span class="bu">System</span><span class="op">.</span><span class="fu">currentTimeMillis</span><span class="op">()</span> <span class="op">+</span> jwtExpiration<span class="op">))</span></span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">signWith</span><span class="op">(</span><span class="fu">getSigningKey</span><span class="op">(),</span> SignatureAlgorithm<span class="op">.</span><span class="fu">HS256</span><span class="op">)</span></span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">compact</span><span class="op">();</span></span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Boolean</span> <span class="fu">validateToken</span><span class="op">(</span><span class="bu">String</span> token<span class="op">,</span> UserDetails userDetails<span class="op">)</span> <span class="op">{</span></span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">String</span> username <span class="op">=</span> <span class="fu">getUsernameFromToken</span><span class="op">(</span>token<span class="op">);</span></span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">(</span>username<span class="op">.</span><span class="fu">equals</span><span class="op">(</span>userDetails<span class="op">.</span><span class="fu">getUsername</span><span class="op">())</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="fu">isTokenExpired</span><span class="op">(</span>token<span class="op">));</span></span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Key</span> <span class="fu">getSigningKey</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a>        <span class="dt">byte</span><span class="op">[]</span> keyBytes <span class="op">=</span> Decoders<span class="op">.</span><span class="fu">BASE64</span><span class="op">.</span><span class="fu">decode</span><span class="op">(</span>jwtSecret<span class="op">);</span></span>
<span id="cb80-33"><a href="#cb80-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Keys<span class="op">.</span><span class="fu">hmacShaKeyFor</span><span class="op">(</span>keyBytes<span class="op">);</span></span>
<span id="cb80-34"><a href="#cb80-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb80-35"><a href="#cb80-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="jwt-authentication-filter">JWT Authentication Filter</h3>
<p>The CareConnect backend uses a custom JWT authentication filter that
provides comprehensive token-based authentication with automatic token
renewal and multi-source token resolution.</p>
<h4 id="jwtauthenticationfilter-implementation">JwtAuthenticationFilter
Implementation</h4>
<div class="sourceCode" id="cb81"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co">// security/JwtAuthenticationFilter.java</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="at">@RequiredArgsConstructor</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> JwtAuthenticationFilter <span class="kw">extends</span> OncePerRequestFilter <span class="op">{</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">Logger</span> log <span class="op">=</span> LoggerFactory<span class="op">.</span><span class="fu">getLogger</span><span class="op">(</span>JwtAuthenticationFilter<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">String</span> COOKIE_NAME <span class="op">=</span> <span class="st">&quot;AUTH&quot;</span><span class="op">;</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Paths excluded from JWT authentication</span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">List</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> EXCLUDED_PATHS <span class="op">=</span> <span class="bu">Arrays</span><span class="op">.</span><span class="fu">asList</span><span class="op">(</span></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;/swagger-ui&quot;</span><span class="op">,</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;/v3/api-docs&quot;</span><span class="op">,</span></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;/swagger-resources&quot;</span><span class="op">,</span></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;/webjars&quot;</span><span class="op">,</span></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;/v1/api/auth&quot;</span><span class="op">,</span>           <span class="co">// Authentication endpoints</span></span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;/api/v1/auth&quot;</span><span class="op">,</span></span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;/v1/api/test&quot;</span><span class="op">,</span>           <span class="co">// Test endpoints</span></span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;/v1/api/caregivers&quot;</span><span class="op">,</span>     <span class="co">// Public caregiver registration</span></span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;/v1/api/subscriptions&quot;</span><span class="op">,</span>  <span class="co">// Public subscription info</span></span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;/v1/api/email-test&quot;</span><span class="op">,</span>     <span class="co">// Email testing</span></span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;/v1/api/emergency&quot;</span>       <span class="co">// Emergency PDF access (no auth required)</span></span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> JwtTokenProvider jwt<span class="op">;</span></span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> UserDetailsService uds<span class="op">;</span></span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> <span class="dt">boolean</span> <span class="fu">shouldNotFilter</span><span class="op">(</span>HttpServletRequest request<span class="op">)</span> <span class="op">{</span></span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> path <span class="op">=</span> request<span class="op">.</span><span class="fu">getRequestURI</span><span class="op">();</span></span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> EXCLUDED_PATHS<span class="op">.</span><span class="fu">stream</span><span class="op">().</span><span class="fu">anyMatch</span><span class="op">(</span>path<span class="op">::</span>startsWith<span class="op">);</span></span>
<span id="cb81-30"><a href="#cb81-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb81-31"><a href="#cb81-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-32"><a href="#cb81-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb81-33"><a href="#cb81-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> <span class="dt">void</span> <span class="fu">doFilterInternal</span><span class="op">(</span>HttpServletRequest req<span class="op">,</span></span>
<span id="cb81-34"><a href="#cb81-34" aria-hidden="true" tabindex="-1"></a>                                    HttpServletResponse res<span class="op">,</span></span>
<span id="cb81-35"><a href="#cb81-35" aria-hidden="true" tabindex="-1"></a>                                    FilterChain chain<span class="op">)</span></span>
<span id="cb81-36"><a href="#cb81-36" aria-hidden="true" tabindex="-1"></a>            <span class="kw">throws</span> ServletException<span class="op">,</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb81-37"><a href="#cb81-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-38"><a href="#cb81-38" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> requestURI <span class="op">=</span> req<span class="op">.</span><span class="fu">getRequestURI</span><span class="op">();</span></span>
<span id="cb81-39"><a href="#cb81-39" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">debug</span><span class="op">(</span><span class="st">&quot;Processing JWT authentication for: {}&quot;</span><span class="op">,</span> requestURI<span class="op">);</span></span>
<span id="cb81-40"><a href="#cb81-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-41"><a href="#cb81-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 1. Resolve token from header or cookie</span></span>
<span id="cb81-42"><a href="#cb81-42" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> token <span class="op">=</span> <span class="fu">resolveToken</span><span class="op">(</span>req<span class="op">);</span></span>
<span id="cb81-43"><a href="#cb81-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-44"><a href="#cb81-44" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 2. Validate token and build authentication</span></span>
<span id="cb81-45"><a href="#cb81-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>token <span class="op">!=</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> jwt<span class="op">.</span><span class="fu">validateToken</span><span class="op">(</span>token<span class="op">))</span> <span class="op">{</span></span>
<span id="cb81-46"><a href="#cb81-46" aria-hidden="true" tabindex="-1"></a>            Claims claims <span class="op">=</span> jwt<span class="op">.</span><span class="fu">getClaims</span><span class="op">(</span>token<span class="op">);</span></span>
<span id="cb81-47"><a href="#cb81-47" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> email <span class="op">=</span> claims<span class="op">.</span><span class="fu">getSubject</span><span class="op">();</span></span>
<span id="cb81-48"><a href="#cb81-48" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> role <span class="op">=</span> claims<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;role&quot;</span><span class="op">,</span> <span class="bu">String</span><span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb81-49"><a href="#cb81-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-50"><a href="#cb81-50" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Role-specific user loading for precise authentication</span></span>
<span id="cb81-51"><a href="#cb81-51" aria-hidden="true" tabindex="-1"></a>            UserDetails userDetails<span class="op">;</span></span>
<span id="cb81-52"><a href="#cb81-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>role <span class="op">!=</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> uds <span class="kw">instanceof</span> UserDetailsServiceImpl<span class="op">)</span> <span class="op">{</span></span>
<span id="cb81-53"><a href="#cb81-53" aria-hidden="true" tabindex="-1"></a>                userDetails <span class="op">=</span> <span class="op">((</span>UserDetailsServiceImpl<span class="op">)</span> uds<span class="op">)</span></span>
<span id="cb81-54"><a href="#cb81-54" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">loadUserByEmailAndRole</span><span class="op">(</span>email<span class="op">,</span> role<span class="op">);</span></span>
<span id="cb81-55"><a href="#cb81-55" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb81-56"><a href="#cb81-56" aria-hidden="true" tabindex="-1"></a>                userDetails <span class="op">=</span> uds<span class="op">.</span><span class="fu">loadUserByUsername</span><span class="op">(</span>email<span class="op">);</span></span>
<span id="cb81-57"><a href="#cb81-57" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb81-58"><a href="#cb81-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-59"><a href="#cb81-59" aria-hidden="true" tabindex="-1"></a>            UsernamePasswordAuthenticationToken auth <span class="op">=</span></span>
<span id="cb81-60"><a href="#cb81-60" aria-hidden="true" tabindex="-1"></a>                <span class="kw">new</span> <span class="fu">UsernamePasswordAuthenticationToken</span><span class="op">(</span></span>
<span id="cb81-61"><a href="#cb81-61" aria-hidden="true" tabindex="-1"></a>                    userDetails<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> userDetails<span class="op">.</span><span class="fu">getAuthorities</span><span class="op">());</span></span>
<span id="cb81-62"><a href="#cb81-62" aria-hidden="true" tabindex="-1"></a>            auth<span class="op">.</span><span class="fu">setDetails</span><span class="op">(</span><span class="kw">new</span> <span class="fu">WebAuthenticationDetailsSource</span><span class="op">().</span><span class="fu">buildDetails</span><span class="op">(</span>req<span class="op">));</span></span>
<span id="cb81-63"><a href="#cb81-63" aria-hidden="true" tabindex="-1"></a>            SecurityContextHolder<span class="op">.</span><span class="fu">getContext</span><span class="op">().</span><span class="fu">setAuthentication</span><span class="op">(</span>auth<span class="op">);</span></span>
<span id="cb81-64"><a href="#cb81-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-65"><a href="#cb81-65" aria-hidden="true" tabindex="-1"></a>            <span class="co">// 3. Silent token renewal (if &lt; 5 minutes remaining)</span></span>
<span id="cb81-66"><a href="#cb81-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>jwt<span class="op">.</span><span class="fu">needsRenewal</span><span class="op">(</span>claims<span class="op">))</span> <span class="op">{</span></span>
<span id="cb81-67"><a href="#cb81-67" aria-hidden="true" tabindex="-1"></a>                <span class="bu">String</span> renewed <span class="op">=</span> jwt<span class="op">.</span><span class="fu">refresh</span><span class="op">(</span>claims<span class="op">);</span></span>
<span id="cb81-68"><a href="#cb81-68" aria-hidden="true" tabindex="-1"></a>                ResponseCookie cookie <span class="op">=</span> ResponseCookie<span class="op">.</span><span class="fu">from</span><span class="op">(</span>COOKIE_NAME<span class="op">,</span> renewed<span class="op">)</span></span>
<span id="cb81-69"><a href="#cb81-69" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">httpOnly</span><span class="op">(</span><span class="kw">true</span><span class="op">)</span></span>
<span id="cb81-70"><a href="#cb81-70" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">secure</span><span class="op">(</span><span class="kw">true</span><span class="op">)</span></span>
<span id="cb81-71"><a href="#cb81-71" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">sameSite</span><span class="op">(</span><span class="st">&quot;Lax&quot;</span><span class="op">)</span></span>
<span id="cb81-72"><a href="#cb81-72" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">path</span><span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">)</span></span>
<span id="cb81-73"><a href="#cb81-73" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">maxAge</span><span class="op">(</span><span class="bu">Duration</span><span class="op">.</span><span class="fu">ofHours</span><span class="op">(</span><span class="dv">3</span><span class="op">))</span>  <span class="co">// 3-hour sliding window</span></span>
<span id="cb81-74"><a href="#cb81-74" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb81-75"><a href="#cb81-75" aria-hidden="true" tabindex="-1"></a>                res<span class="op">.</span><span class="fu">addHeader</span><span class="op">(</span>HttpHeaders<span class="op">.</span><span class="fu">SET_COOKIE</span><span class="op">,</span> cookie<span class="op">.</span><span class="fu">toString</span><span class="op">());</span></span>
<span id="cb81-76"><a href="#cb81-76" aria-hidden="true" tabindex="-1"></a>                log<span class="op">.</span><span class="fu">debug</span><span class="op">(</span><span class="st">&quot;Token renewed for user: {}&quot;</span><span class="op">,</span> email<span class="op">);</span></span>
<span id="cb81-77"><a href="#cb81-77" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb81-78"><a href="#cb81-78" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb81-79"><a href="#cb81-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-80"><a href="#cb81-80" aria-hidden="true" tabindex="-1"></a>        chain<span class="op">.</span><span class="fu">doFilter</span><span class="op">(</span>req<span class="op">,</span> res<span class="op">);</span></span>
<span id="cb81-81"><a href="#cb81-81" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb81-82"><a href="#cb81-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-83"><a href="#cb81-83" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> <span class="fu">resolveToken</span><span class="op">(</span>HttpServletRequest req<span class="op">)</span> <span class="op">{</span></span>
<span id="cb81-84"><a href="#cb81-84" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check Bearer header first</span></span>
<span id="cb81-85"><a href="#cb81-85" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> header <span class="op">=</span> req<span class="op">.</span><span class="fu">getHeader</span><span class="op">(</span><span class="st">&quot;Authorization&quot;</span><span class="op">);</span></span>
<span id="cb81-86"><a href="#cb81-86" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>header <span class="op">!=</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> header<span class="op">.</span><span class="fu">startsWith</span><span class="op">(</span><span class="st">&quot;Bearer &quot;</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb81-87"><a href="#cb81-87" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> header<span class="op">.</span><span class="fu">substring</span><span class="op">(</span><span class="dv">7</span><span class="op">);</span></span>
<span id="cb81-88"><a href="#cb81-88" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb81-89"><a href="#cb81-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-90"><a href="#cb81-90" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Fallback to HttpOnly cookie</span></span>
<span id="cb81-91"><a href="#cb81-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>req<span class="op">.</span><span class="fu">getCookies</span><span class="op">()</span> <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb81-92"><a href="#cb81-92" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">Arrays</span><span class="op">.</span><span class="fu">stream</span><span class="op">(</span>req<span class="op">.</span><span class="fu">getCookies</span><span class="op">())</span></span>
<span id="cb81-93"><a href="#cb81-93" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">filter</span><span class="op">(</span>c <span class="op">-&gt;</span> COOKIE_NAME<span class="op">.</span><span class="fu">equals</span><span class="op">(</span>c<span class="op">.</span><span class="fu">getName</span><span class="op">()))</span></span>
<span id="cb81-94"><a href="#cb81-94" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">findFirst</span><span class="op">()</span></span>
<span id="cb81-95"><a href="#cb81-95" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">map</span><span class="op">(</span>Cookie<span class="op">::</span>getValue<span class="op">)</span></span>
<span id="cb81-96"><a href="#cb81-96" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">orElse</span><span class="op">(</span><span class="kw">null</span><span class="op">);</span></span>
<span id="cb81-97"><a href="#cb81-97" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb81-98"><a href="#cb81-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb81-99"><a href="#cb81-99" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb81-100"><a href="#cb81-100" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="key-features">Key Features</h4>
<p><strong>Multi-Source Token Resolution:</strong> - Primary:
<code>Authorization: Bearer &lt;token&gt;</code> header - Fallback:
HttpOnly <code>AUTH</code> cookie for web clients - Secure cookie
configuration (HttpOnly, Secure, SameSite)</p>
<p><strong>Path-Based Exclusions:</strong> - Public authentication
endpoints (<code>/v1/api/auth/**</code>) - Emergency access endpoints
(<code>/v1/api/emergency/**</code>) - API documentation
(<code>/swagger-ui/**</code>, <code>/v3/api-docs/**</code>) - Public
registration endpoints</p>
<p><strong>Automatic Token Renewal:</strong> - Silent renewal when &lt;
5 minutes remaining - 3-hour sliding window maximum - Maintains user
session without interruption</p>
<p><strong>Role-Based Authentication:</strong> - Extracts role from JWT
claims - Role-specific user loading for multi-role scenarios - Prevents
authentication ambiguity</p>
<h3 id="security-configuration">Security Configuration</h3>
<div class="sourceCode" id="cb82"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co">// config/SecurityConfig.java</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Configuration</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="at">@EnableWebSecurity</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="at">@EnableMethodSecurity</span><span class="op">(</span>prePostEnabled <span class="op">=</span> <span class="kw">true</span><span class="op">)</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> SecurityConfig <span class="op">{</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> JwtAuthenticationFilter jwtAuthenticationFilter<span class="op">;</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> JwtAuthenticationEntryPoint jwtAuthenticationEntryPoint<span class="op">;</span></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> SecurityFilterChain <span class="fu">filterChain</span><span class="op">(</span>HttpSecurity http<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>        http<span class="op">.</span><span class="fu">csrf</span><span class="op">().</span><span class="fu">disable</span><span class="op">()</span></span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">sessionManagement</span><span class="op">().</span><span class="fu">sessionCreationPolicy</span><span class="op">(</span>SessionCreationPolicy<span class="op">.</span><span class="fu">STATELESS</span><span class="op">)</span></span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">and</span><span class="op">()</span></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">authorizeHttpRequests</span><span class="op">(</span>authz <span class="op">-&gt;</span> authz</span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Public endpoints</span></span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">requestMatchers</span><span class="op">(</span><span class="st">&quot;/v1/api/auth/**&quot;</span><span class="op">).</span><span class="fu">permitAll</span><span class="op">()</span></span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">requestMatchers</span><span class="op">(</span><span class="st">&quot;/v1/api/emergency/**&quot;</span><span class="op">).</span><span class="fu">permitAll</span><span class="op">()</span></span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">requestMatchers</span><span class="op">(</span><span class="st">&quot;/v1/api/public/**&quot;</span><span class="op">).</span><span class="fu">permitAll</span><span class="op">()</span></span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">requestMatchers</span><span class="op">(</span><span class="st">&quot;/swagger-ui/**&quot;</span><span class="op">,</span> <span class="st">&quot;/v3/api-docs/**&quot;</span><span class="op">).</span><span class="fu">permitAll</span><span class="op">()</span></span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Role-based endpoints</span></span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">requestMatchers</span><span class="op">(</span><span class="st">&quot;/v1/api/patients/**&quot;</span><span class="op">).</span><span class="fu">hasAnyRole</span><span class="op">(</span><span class="st">&quot;PATIENT&quot;</span><span class="op">,</span> <span class="st">&quot;CAREGIVER&quot;</span><span class="op">,</span> <span class="st">&quot;FAMILY_MEMBER&quot;</span><span class="op">)</span></span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">requestMatchers</span><span class="op">(</span><span class="st">&quot;/v1/api/caregivers/**&quot;</span><span class="op">).</span><span class="fu">hasAnyRole</span><span class="op">(</span><span class="st">&quot;CAREGIVER&quot;</span><span class="op">,</span> <span class="st">&quot;ADMIN&quot;</span><span class="op">)</span></span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">requestMatchers</span><span class="op">(</span><span class="st">&quot;/v1/api/family-members/**&quot;</span><span class="op">).</span><span class="fu">hasRole</span><span class="op">(</span><span class="st">&quot;FAMILY_MEMBER&quot;</span><span class="op">)</span></span>
<span id="cb82-26"><a href="#cb82-26" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">requestMatchers</span><span class="op">(</span><span class="st">&quot;/v1/api/admin/**&quot;</span><span class="op">).</span><span class="fu">hasRole</span><span class="op">(</span><span class="st">&quot;ADMIN&quot;</span><span class="op">)</span></span>
<span id="cb82-27"><a href="#cb82-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-28"><a href="#cb82-28" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Default authentication required</span></span>
<span id="cb82-29"><a href="#cb82-29" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">anyRequest</span><span class="op">().</span><span class="fu">authenticated</span><span class="op">())</span></span>
<span id="cb82-30"><a href="#cb82-30" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">exceptionHandling</span><span class="op">()</span></span>
<span id="cb82-31"><a href="#cb82-31" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">authenticationEntryPoint</span><span class="op">(</span>jwtAuthenticationEntryPoint<span class="op">)</span></span>
<span id="cb82-32"><a href="#cb82-32" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">and</span><span class="op">()</span></span>
<span id="cb82-33"><a href="#cb82-33" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">addFilterBefore</span><span class="op">(</span>jwtAuthenticationFilter<span class="op">,</span> UsernamePasswordAuthenticationFilter<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb82-34"><a href="#cb82-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-35"><a href="#cb82-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> http<span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb82-36"><a href="#cb82-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb82-37"><a href="#cb82-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-38"><a href="#cb82-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb82-39"><a href="#cb82-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> PasswordEncoder <span class="fu">passwordEncoder</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb82-40"><a href="#cb82-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">BCryptPasswordEncoder</span><span class="op">(</span><span class="dv">12</span><span class="op">);</span></span>
<span id="cb82-41"><a href="#cb82-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb82-42"><a href="#cb82-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-43"><a href="#cb82-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb82-44"><a href="#cb82-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> AuthenticationManager <span class="fu">authenticationManager</span><span class="op">(</span></span>
<span id="cb82-45"><a href="#cb82-45" aria-hidden="true" tabindex="-1"></a>            AuthenticationConfiguration config<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb82-46"><a href="#cb82-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> config<span class="op">.</span><span class="fu">getAuthenticationManager</span><span class="op">();</span></span>
<span id="cb82-47"><a href="#cb82-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb82-48"><a href="#cb82-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="jwt-token-provider">JWT Token Provider</h3>
<div class="sourceCode" id="cb83"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co">// security/JwtTokenProvider.java</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Component</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> JwtTokenProvider <span class="op">{</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Value</span><span class="op">(</span><span class="st">&quot;${jwt.secret}&quot;</span><span class="op">)</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> jwtSecret<span class="op">;</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Value</span><span class="op">(</span><span class="st">&quot;${jwt.expiration:3600000}&quot;</span><span class="op">)</span> <span class="co">// 1 hour default</span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">long</span> jwtExpiration<span class="op">;</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> <span class="dt">long</span> RENEWAL_THRESHOLD <span class="op">=</span> <span class="dv">5</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">1000</span><span class="op">;</span> <span class="co">// 5 minutes</span></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">generateToken</span><span class="op">(</span>UserDetails userDetails<span class="op">,</span> <span class="bu">String</span> role<span class="op">)</span> <span class="op">{</span></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> claims <span class="op">=</span> <span class="kw">new</span> <span class="bu">HashMap</span><span class="op">&lt;&gt;();</span></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>        claims<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;role&quot;</span><span class="op">,</span> role<span class="op">);</span></span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>        claims<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;authorities&quot;</span><span class="op">,</span> userDetails<span class="op">.</span><span class="fu">getAuthorities</span><span class="op">());</span></span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">createToken</span><span class="op">(</span>claims<span class="op">,</span> userDetails<span class="op">.</span><span class="fu">getUsername</span><span class="op">());</span></span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> <span class="fu">createToken</span><span class="op">(</span><span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> claims<span class="op">,</span> <span class="bu">String</span> subject<span class="op">)</span> <span class="op">{</span></span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Date</span> now <span class="op">=</span> <span class="kw">new</span> <span class="bu">Date</span><span class="op">();</span></span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Date</span> validity <span class="op">=</span> <span class="kw">new</span> <span class="bu">Date</span><span class="op">(</span>now<span class="op">.</span><span class="fu">getTime</span><span class="op">()</span> <span class="op">+</span> jwtExpiration<span class="op">);</span></span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-25"><a href="#cb83-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Jwts<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb83-26"><a href="#cb83-26" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">setClaims</span><span class="op">(</span>claims<span class="op">)</span></span>
<span id="cb83-27"><a href="#cb83-27" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">setSubject</span><span class="op">(</span>subject<span class="op">)</span></span>
<span id="cb83-28"><a href="#cb83-28" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">setIssuedAt</span><span class="op">(</span>now<span class="op">)</span></span>
<span id="cb83-29"><a href="#cb83-29" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">setExpiration</span><span class="op">(</span>validity<span class="op">)</span></span>
<span id="cb83-30"><a href="#cb83-30" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">signWith</span><span class="op">(</span><span class="fu">getSigningKey</span><span class="op">(),</span> SignatureAlgorithm<span class="op">.</span><span class="fu">HS256</span><span class="op">)</span></span>
<span id="cb83-31"><a href="#cb83-31" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">compact</span><span class="op">();</span></span>
<span id="cb83-32"><a href="#cb83-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb83-33"><a href="#cb83-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-34"><a href="#cb83-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">validateToken</span><span class="op">(</span><span class="bu">String</span> token<span class="op">)</span> <span class="op">{</span></span>
<span id="cb83-35"><a href="#cb83-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb83-36"><a href="#cb83-36" aria-hidden="true" tabindex="-1"></a>            Jwts<span class="op">.</span><span class="fu">parserBuilder</span><span class="op">()</span></span>
<span id="cb83-37"><a href="#cb83-37" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">setSigningKey</span><span class="op">(</span><span class="fu">getSigningKey</span><span class="op">())</span></span>
<span id="cb83-38"><a href="#cb83-38" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">build</span><span class="op">()</span></span>
<span id="cb83-39"><a href="#cb83-39" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">parseClaimsJws</span><span class="op">(</span>token<span class="op">);</span></span>
<span id="cb83-40"><a href="#cb83-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb83-41"><a href="#cb83-41" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span>JwtException <span class="op">|</span> <span class="bu">IllegalArgumentException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb83-42"><a href="#cb83-42" aria-hidden="true" tabindex="-1"></a>            log<span class="op">.</span><span class="fu">debug</span><span class="op">(</span><span class="st">&quot;Invalid JWT token: {}&quot;</span><span class="op">,</span> e<span class="op">.</span><span class="fu">getMessage</span><span class="op">());</span></span>
<span id="cb83-43"><a href="#cb83-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb83-44"><a href="#cb83-44" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb83-45"><a href="#cb83-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb83-46"><a href="#cb83-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-47"><a href="#cb83-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> Claims <span class="fu">getClaims</span><span class="op">(</span><span class="bu">String</span> token<span class="op">)</span> <span class="op">{</span></span>
<span id="cb83-48"><a href="#cb83-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Jwts<span class="op">.</span><span class="fu">parserBuilder</span><span class="op">()</span></span>
<span id="cb83-49"><a href="#cb83-49" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">setSigningKey</span><span class="op">(</span><span class="fu">getSigningKey</span><span class="op">())</span></span>
<span id="cb83-50"><a href="#cb83-50" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">build</span><span class="op">()</span></span>
<span id="cb83-51"><a href="#cb83-51" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">parseClaimsJws</span><span class="op">(</span>token<span class="op">)</span></span>
<span id="cb83-52"><a href="#cb83-52" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">getBody</span><span class="op">();</span></span>
<span id="cb83-53"><a href="#cb83-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb83-54"><a href="#cb83-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-55"><a href="#cb83-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">needsRenewal</span><span class="op">(</span>Claims claims<span class="op">)</span> <span class="op">{</span></span>
<span id="cb83-56"><a href="#cb83-56" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Date</span> expiration <span class="op">=</span> claims<span class="op">.</span><span class="fu">getExpiration</span><span class="op">();</span></span>
<span id="cb83-57"><a href="#cb83-57" aria-hidden="true" tabindex="-1"></a>        <span class="dt">long</span> timeUntilExpiry <span class="op">=</span> expiration<span class="op">.</span><span class="fu">getTime</span><span class="op">()</span> <span class="op">-</span> <span class="bu">System</span><span class="op">.</span><span class="fu">currentTimeMillis</span><span class="op">();</span></span>
<span id="cb83-58"><a href="#cb83-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> timeUntilExpiry <span class="op">&lt;</span> RENEWAL_THRESHOLD<span class="op">;</span></span>
<span id="cb83-59"><a href="#cb83-59" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb83-60"><a href="#cb83-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-61"><a href="#cb83-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">refresh</span><span class="op">(</span>Claims claims<span class="op">)</span> <span class="op">{</span></span>
<span id="cb83-62"><a href="#cb83-62" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Create new token with extended expiration</span></span>
<span id="cb83-63"><a href="#cb83-63" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> newClaims <span class="op">=</span> <span class="kw">new</span> <span class="bu">HashMap</span><span class="op">&lt;&gt;(</span>claims<span class="op">);</span></span>
<span id="cb83-64"><a href="#cb83-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">createToken</span><span class="op">(</span>newClaims<span class="op">,</span> claims<span class="op">.</span><span class="fu">getSubject</span><span class="op">());</span></span>
<span id="cb83-65"><a href="#cb83-65" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb83-66"><a href="#cb83-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-67"><a href="#cb83-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Key</span> <span class="fu">getSigningKey</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb83-68"><a href="#cb83-68" aria-hidden="true" tabindex="-1"></a>        <span class="dt">byte</span><span class="op">[]</span> keyBytes <span class="op">=</span> Decoders<span class="op">.</span><span class="fu">BASE64</span><span class="op">.</span><span class="fu">decode</span><span class="op">(</span>jwtSecret<span class="op">);</span></span>
<span id="cb83-69"><a href="#cb83-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Keys<span class="op">.</span><span class="fu">hmacShaKeyFor</span><span class="op">(</span>keyBytes<span class="op">);</span></span>
<span id="cb83-70"><a href="#cb83-70" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb83-71"><a href="#cb83-71" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="user-details-service-implementation">User Details Service
Implementation</h3>
<div class="sourceCode" id="cb84"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co">// security/UserDetailsServiceImpl.java</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="at">@RequiredArgsConstructor</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> UserDetailsServiceImpl <span class="kw">implements</span> UserDetailsService <span class="op">{</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> UserRepository userRepository<span class="op">;</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> UserDetails <span class="fu">loadUserByUsername</span><span class="op">(</span><span class="bu">String</span> email<span class="op">)</span> <span class="kw">throws</span> UsernameNotFoundException <span class="op">{</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>        User user <span class="op">=</span> userRepository<span class="op">.</span><span class="fu">findByEmail</span><span class="op">(</span>email<span class="op">)</span></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">orElseThrow</span><span class="op">(()</span> <span class="op">-&gt;</span> <span class="kw">new</span> <span class="fu">UsernameNotFoundException</span><span class="op">(</span><span class="st">&quot;User not found: &quot;</span> <span class="op">+</span> email<span class="op">));</span></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> UserPrincipal<span class="op">.</span><span class="fu">create</span><span class="op">(</span>user<span class="op">);</span></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Role-specific loading for multi-role scenarios</span></span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> UserDetails <span class="fu">loadUserByEmailAndRole</span><span class="op">(</span><span class="bu">String</span> email<span class="op">,</span> <span class="bu">String</span> role<span class="op">)</span></span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>            <span class="kw">throws</span> UsernameNotFoundException <span class="op">{</span></span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a>        User user <span class="op">=</span> userRepository<span class="op">.</span><span class="fu">findByEmailAndRole</span><span class="op">(</span>email<span class="op">,</span> UserRole<span class="op">.</span><span class="fu">valueOf</span><span class="op">(</span>role<span class="op">))</span></span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">orElseThrow</span><span class="op">(()</span> <span class="op">-&gt;</span> <span class="kw">new</span> <span class="fu">UsernameNotFoundException</span><span class="op">(</span></span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;User not found with email: &quot;</span> <span class="op">+</span> email <span class="op">+</span> <span class="st">&quot; and role: &quot;</span> <span class="op">+</span> role<span class="op">));</span></span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> UserPrincipal<span class="op">.</span><span class="fu">create</span><span class="op">(</span>user<span class="op">);</span></span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true" tabindex="-1"></a><span class="co">// security/UserPrincipal.java</span></span>
<span id="cb84-28"><a href="#cb84-28" aria-hidden="true" tabindex="-1"></a><span class="at">@Getter</span></span>
<span id="cb84-29"><a href="#cb84-29" aria-hidden="true" tabindex="-1"></a><span class="at">@AllArgsConstructor</span></span>
<span id="cb84-30"><a href="#cb84-30" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> UserPrincipal <span class="kw">implements</span> UserDetails <span class="op">{</span></span>
<span id="cb84-31"><a href="#cb84-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-32"><a href="#cb84-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Long</span> id<span class="op">;</span></span>
<span id="cb84-33"><a href="#cb84-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> email<span class="op">;</span></span>
<span id="cb84-34"><a href="#cb84-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> password<span class="op">;</span></span>
<span id="cb84-35"><a href="#cb84-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Collection</span><span class="op">&lt;?</span> <span class="kw">extends</span> GrantedAuthority<span class="op">&gt;</span> authorities<span class="op">;</span></span>
<span id="cb84-36"><a href="#cb84-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">boolean</span> enabled<span class="op">;</span></span>
<span id="cb84-37"><a href="#cb84-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-38"><a href="#cb84-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> UserPrincipal <span class="fu">create</span><span class="op">(</span>User user<span class="op">)</span> <span class="op">{</span></span>
<span id="cb84-39"><a href="#cb84-39" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span>GrantedAuthority<span class="op">&gt;</span> authorities <span class="op">=</span> <span class="bu">List</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span></span>
<span id="cb84-40"><a href="#cb84-40" aria-hidden="true" tabindex="-1"></a>            <span class="kw">new</span> <span class="fu">SimpleGrantedAuthority</span><span class="op">(</span><span class="st">&quot;ROLE_&quot;</span> <span class="op">+</span> user<span class="op">.</span><span class="fu">getRole</span><span class="op">().</span><span class="fu">name</span><span class="op">())</span></span>
<span id="cb84-41"><a href="#cb84-41" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb84-42"><a href="#cb84-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-43"><a href="#cb84-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">UserPrincipal</span><span class="op">(</span></span>
<span id="cb84-44"><a href="#cb84-44" aria-hidden="true" tabindex="-1"></a>            user<span class="op">.</span><span class="fu">getId</span><span class="op">(),</span></span>
<span id="cb84-45"><a href="#cb84-45" aria-hidden="true" tabindex="-1"></a>            user<span class="op">.</span><span class="fu">getEmail</span><span class="op">(),</span></span>
<span id="cb84-46"><a href="#cb84-46" aria-hidden="true" tabindex="-1"></a>            user<span class="op">.</span><span class="fu">getPassword</span><span class="op">(),</span></span>
<span id="cb84-47"><a href="#cb84-47" aria-hidden="true" tabindex="-1"></a>            authorities<span class="op">,</span></span>
<span id="cb84-48"><a href="#cb84-48" aria-hidden="true" tabindex="-1"></a>            user<span class="op">.</span><span class="fu">getActive</span><span class="op">()</span></span>
<span id="cb84-49"><a href="#cb84-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb84-50"><a href="#cb84-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb84-51"><a href="#cb84-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-52"><a href="#cb84-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb84-53"><a href="#cb84-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">getUsername</span><span class="op">()</span> <span class="op">{</span> <span class="cf">return</span> email<span class="op">;</span> <span class="op">}</span></span>
<span id="cb84-54"><a href="#cb84-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-55"><a href="#cb84-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb84-56"><a href="#cb84-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">isAccountNonExpired</span><span class="op">()</span> <span class="op">{</span> <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb84-57"><a href="#cb84-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-58"><a href="#cb84-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb84-59"><a href="#cb84-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">isAccountNonLocked</span><span class="op">()</span> <span class="op">{</span> <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb84-60"><a href="#cb84-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-61"><a href="#cb84-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb84-62"><a href="#cb84-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">isCredentialsNonExpired</span><span class="op">()</span> <span class="op">{</span> <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb84-63"><a href="#cb84-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-64"><a href="#cb84-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb84-65"><a href="#cb84-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">isEnabled</span><span class="op">()</span> <span class="op">{</span> <span class="cf">return</span> enabled<span class="op">;</span> <span class="op">}</span></span>
<span id="cb84-66"><a href="#cb84-66" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="security-features">Security Features</h3>
<p><strong>Password Security:</strong> - BCrypt hashing with strength 12
- Minimum 8 characters with complexity requirements - Password history
prevention (last 5 passwords)</p>
<p><strong>Session Management:</strong> - Stateless JWT-based
authentication - Automatic token renewal for active sessions - Secure
cookie storage for web clients</p>
<p><strong>CORS Configuration:</strong></p>
<div class="sourceCode" id="cb85"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Bean</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> CorsConfigurationSource <span class="fu">corsConfigurationSource</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>    CorsConfiguration configuration <span class="op">=</span> <span class="kw">new</span> <span class="fu">CorsConfiguration</span><span class="op">();</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>    configuration<span class="op">.</span><span class="fu">setAllowedOriginPatterns</span><span class="op">(</span><span class="bu">List</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span><span class="st">&quot;*&quot;</span><span class="op">));</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>    configuration<span class="op">.</span><span class="fu">setAllowedMethods</span><span class="op">(</span><span class="bu">List</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span><span class="st">&quot;GET&quot;</span><span class="op">,</span> <span class="st">&quot;POST&quot;</span><span class="op">,</span> <span class="st">&quot;PUT&quot;</span><span class="op">,</span> <span class="st">&quot;DELETE&quot;</span><span class="op">,</span> <span class="st">&quot;PATCH&quot;</span><span class="op">,</span> <span class="st">&quot;OPTIONS&quot;</span><span class="op">));</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>    configuration<span class="op">.</span><span class="fu">setAllowedHeaders</span><span class="op">(</span><span class="bu">List</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span><span class="st">&quot;*&quot;</span><span class="op">));</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>    configuration<span class="op">.</span><span class="fu">setAllowCredentials</span><span class="op">(</span><span class="kw">true</span><span class="op">);</span></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>    UrlBasedCorsConfigurationSource source <span class="op">=</span> <span class="kw">new</span> <span class="fu">UrlBasedCorsConfigurationSource</span><span class="op">();</span></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>    source<span class="op">.</span><span class="fu">registerCorsConfiguration</span><span class="op">(</span><span class="st">&quot;/**&quot;</span><span class="op">,</span> configuration<span class="op">);</span></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> source<span class="op">;</span></span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Rate Limiting:</strong> - API rate limiting based on user
role and endpoint - Brute force protection for authentication endpoints
- Emergency endpoint exemption from rate limits</p>
<h2 id="real-time-communication-with-websocket">Real-time Communication
with WebSocket</h2>
<p>CareConnect implements a comprehensive WebSocket-based real-time
communication system. This system is specifically designed for
healthcare applications where timely information delivery can be
critical to patient safety. The system uses a <strong>dual-mode
architecture</strong> that automatically switches between local
development (embedded WebSocket server) and AWS production (API Gateway
WebSocket) environments.</p>
<h3 id="why-websocket-for-healthcare">Why WebSocket for Healthcare?</h3>
<p>Healthcare scenarios demand real-time communication in ways that
traditional REST APIs cannot satisfy:</p>
<p><strong>Critical Alerts</strong>: When a patient’s blood pressure
reading is dangerously high, the caregiver needs immediate
notification—not whenever they next refresh the dashboard. A 5-minute
delay in notification could be the difference between timely
intervention and a medical emergency.</p>
<p><strong>Medication Reminders</strong>: Patients need timely reminders
to take medications. WebSocket push notifications are more reliable than
polling, especially when the app is backgrounded.</p>
<p><strong>Communication</strong>: Video calls, text messaging, and
emergency calls require persistent connections. Establishing a new HTTP
connection for every message would be slow and wasteful.</p>
<p><strong>Vital Signs Monitoring</strong>: Real-time streaming of vital
signs data (from connected devices like blood pressure monitors)
requires continuous data flow, not request-response cycles.</p>
<p><strong>Audit Requirements</strong>: Healthcare regulations often
require real-time audit logging. WebSocket connections can stream audit
events as they occur, rather than batching them.</p>
<p>While Server-Sent Events (SSE) could handle some use cases,
WebSocket’s bidirectional nature allows clients to also send data
efficiently (like acknowledging alerts or sending heartbeats).</p>
<h3 id="architecture-overview-1">Architecture Overview</h3>
<p>CareConnect provides three main WebSocket channels, each serving
distinct purposes:</p>
<p><strong><code>/ws/careconnect</code></strong> - Primary healthcare
communications channel - AI notifications (health risk assessments,
recommendations) - Vital signs alerts (abnormal readings requiring
attention) - Medication reminders (scheduled notifications) - Mood/pain
log updates (real-time patient self-reporting) - Emergency alerts
(critical patient situations)</p>
<p><strong><code>/ws/calls</code></strong> - Call management and
notifications - Video call initiation and coordination - Audio call
signaling - SMS notifications (text message delivery) - Call status
updates</p>
<p><strong><code>/ws/notifications</code></strong> - General
notification delivery - System notifications - Administrative messages -
Low-priority updates</p>
<p>This separation allows different Quality of Service levels: emergency
alerts on <code>/ws/careconnect</code> get highest priority, while
general notifications can be throttled during high load.</p>
<h3 id="dual-mode-configuration-development-vs-production">Dual-Mode
Configuration: Development vs Production</h3>
<p>CareConnect’s WebSocket system adapts automatically to its
environment:</p>
<p><strong>Development Mode</strong>: Uses Spring Boot’s embedded
WebSocket server - Runs on same port as REST API (8080) - Simple
configuration, easy debugging - Full WebSocket features including SockJS
fallback - Perfect for local development and testing</p>
<p><strong>Production Mode</strong>: Uses AWS API Gateway WebSocket -
Scales automatically with load - Integrates with AWS Lambda for message
processing - Global distribution via CloudFront - Handles connection
persistence and reconnection</p>
<p>This dual-mode approach means developers can work locally without AWS
credentials, while production benefits from enterprise-grade
infrastructure.</p>
<h4 id="configuration-detection">Configuration Detection</h4>
<div class="sourceCode" id="cb86"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co">// config/WebSocketModeConfig.java</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Configuration</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="at">@ConditionalOnProperty</span><span class="op">(</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>    name <span class="op">=</span> <span class="st">&quot;careconnect.websocket.enabled&quot;</span><span class="op">,</span> </span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>    havingValue <span class="op">=</span> <span class="st">&quot;true&quot;</span><span class="op">,</span> </span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>    matchIfMissing <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> WebSocketModeConfig <span class="op">{</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> Local WebSocket configuration <span class="co">-</span> used when AWS endpoint is not defined<span class="co">.</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> This is the default for development environments<span class="co">.</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">@ConditionalOnMissingBean</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;awsWebSocketApiEndpoint&quot;</span><span class="op">)</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> WebSocketConfig <span class="fu">localWebSocketConfig</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">WebSocketConfig</span><span class="op">();</span> <span class="co">// Embedded Spring WebSocket</span></span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> AWS WebSocket configuration <span class="co">-</span> used when AWS endpoint is defined<span class="co">.</span></span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> This activates in production when AWS_WEBSOCKET_API_ENDPOINT is set<span class="co">.</span></span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">@ConditionalOnBean</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;awsWebSocketApiEndpoint&quot;</span><span class="op">)</span></span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> AwsWebSocketService <span class="fu">awsWebSocketService</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">AwsWebSocketService</span><span class="op">();</span> <span class="co">// AWS API Gateway client</span></span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>How it works</strong>: Spring checks for the presence of
<code>awsWebSocketApiEndpoint</code> bean (defined when
<code>AWS_WEBSOCKET_API_ENDPOINT</code> environment variable is set). If
present, uses AWS mode; otherwise, uses local mode. This is completely
transparent to application code.</p>
<h3 id="local-development-websocket-configuration">Local Development
WebSocket Configuration</h3>
<div class="sourceCode" id="cb87"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co">// config/WebSocketConfig.java</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Configuration</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a><span class="at">@EnableWebSocket</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="at">@Slf4j</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> WebSocketConfig <span class="kw">implements</span> WebSocketConfigurer <span class="op">{</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Value</span><span class="op">(</span><span class="st">&quot;${careconnect.websocket.allowed-origins}&quot;</span><span class="op">)</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> allowedOrigins<span class="op">;</span></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> CareConnectWebSocketHandler careConnectHandler<span class="op">;</span></span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> CallNotificationHandler callHandler<span class="op">;</span></span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> NotificationWebSocketHandler notificationHandler<span class="op">;</span></span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">registerWebSocketHandlers</span><span class="op">(</span>WebSocketHandlerRegistry registry<span class="op">)</span> <span class="op">{</span></span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Parse allowed origins from configuration</span></span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span><span class="op">[]</span> origins <span class="op">=</span> allowedOrigins<span class="op">.</span><span class="fu">split</span><span class="op">(</span><span class="st">&quot;,&quot;</span><span class="op">);</span></span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-19"><a href="#cb87-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Main healthcare WebSocket with SockJS fallback</span></span>
<span id="cb87-20"><a href="#cb87-20" aria-hidden="true" tabindex="-1"></a>        registry<span class="op">.</span><span class="fu">addHandler</span><span class="op">(</span>careConnectHandler<span class="op">,</span> <span class="st">&quot;/ws/careconnect&quot;</span><span class="op">)</span></span>
<span id="cb87-21"><a href="#cb87-21" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">setAllowedOrigins</span><span class="op">(</span>origins<span class="op">)</span></span>
<span id="cb87-22"><a href="#cb87-22" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">withSockJS</span><span class="op">();</span>  <span class="co">// Enables fallback for browsers without WebSocket</span></span>
<span id="cb87-23"><a href="#cb87-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-24"><a href="#cb87-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Call management WebSocket with SockJS fallback</span></span>
<span id="cb87-25"><a href="#cb87-25" aria-hidden="true" tabindex="-1"></a>        registry<span class="op">.</span><span class="fu">addHandler</span><span class="op">(</span>callHandler<span class="op">,</span> <span class="st">&quot;/ws/calls&quot;</span><span class="op">)</span></span>
<span id="cb87-26"><a href="#cb87-26" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">setAllowedOrigins</span><span class="op">(</span>origins<span class="op">)</span></span>
<span id="cb87-27"><a href="#cb87-27" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">withSockJS</span><span class="op">();</span></span>
<span id="cb87-28"><a href="#cb87-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-29"><a href="#cb87-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Basic notifications (no SockJS - pure WebSocket only)</span></span>
<span id="cb87-30"><a href="#cb87-30" aria-hidden="true" tabindex="-1"></a>        registry<span class="op">.</span><span class="fu">addHandler</span><span class="op">(</span>notificationHandler<span class="op">,</span> <span class="st">&quot;/ws/notifications&quot;</span><span class="op">)</span></span>
<span id="cb87-31"><a href="#cb87-31" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">setAllowedOrigins</span><span class="op">(</span>origins<span class="op">);</span></span>
<span id="cb87-32"><a href="#cb87-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb87-33"><a href="#cb87-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="why-sockjs-fallback">Why SockJS Fallback?</h4>
<p>SockJS provides automatic fallback to HTTP long-polling when
WebSocket is unavailable. This is crucial in healthcare settings where:
- Corporate firewalls might block WebSocket connections - Some hospital
networks use outdated proxies incompatible with WebSocket - Mobile
networks occasionally have issues with persistent connections</p>
<p>With SockJS, the application automatically degrades gracefully: tries
WebSocket first, falls back to HTTP streaming, then long-polling if
needed. The application code remains identical—SockJS handles the
complexity.</p>
<h3 id="websocket-handler-healthcare-communications">WebSocket Handler:
Healthcare Communications</h3>
<p>The main healthcare WebSocket handler manages patient-critical
communications:</p>
<div class="sourceCode" id="cb88"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Component</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Slf4j</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> CareConnectWebSocketHandler <span class="kw">extends</span> TextWebSocketHandler <span class="op">{</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> JwtTokenProvider jwtTokenProvider<span class="op">;</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> WebSocketConnectionService connectionService<span class="op">;</span></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Thread-safe map of user IDs to active WebSocket sessions</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">Long</span><span class="op">,</span> WebSocketSession<span class="op">&gt;</span> userSessions <span class="op">=</span> <span class="kw">new</span> <span class="bu">ConcurrentHashMap</span><span class="op">&lt;&gt;();</span></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">afterConnectionEstablished</span><span class="op">(</span>WebSocketSession session<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;WebSocket connection established: {}&quot;</span><span class="op">,</span> session<span class="op">.</span><span class="fu">getId</span><span class="op">());</span></span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Track when connection was established (for timeout detection)</span></span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>        session<span class="op">.</span><span class="fu">getAttributes</span><span class="op">().</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;connectionTime&quot;</span><span class="op">,</span> <span class="bu">System</span><span class="op">.</span><span class="fu">currentTimeMillis</span><span class="op">());</span></span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Send welcome message to client</span></span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sendMessage</span><span class="op">(</span>session<span class="op">,</span> <span class="bu">Map</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span></span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;type&quot;</span><span class="op">,</span> <span class="st">&quot;connection-established&quot;</span><span class="op">,</span></span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;message&quot;</span><span class="op">,</span> <span class="st">&quot;WebSocket connection successful&quot;</span><span class="op">,</span></span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;sessionId&quot;</span><span class="op">,</span> session<span class="op">.</span><span class="fu">getId</span><span class="op">()</span></span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">));</span></span>
<span id="cb88-24"><a href="#cb88-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb88-25"><a href="#cb88-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-26"><a href="#cb88-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb88-27"><a href="#cb88-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> <span class="dt">void</span> <span class="fu">handleTextMessage</span><span class="op">(</span>WebSocketSession session<span class="op">,</span> TextMessage message<span class="op">)</span> </span>
<span id="cb88-28"><a href="#cb88-28" aria-hidden="true" tabindex="-1"></a>            <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb88-29"><a href="#cb88-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb88-30"><a href="#cb88-30" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Parse incoming message as JSON</span></span>
<span id="cb88-31"><a href="#cb88-31" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> payload <span class="op">=</span> objectMapper<span class="op">.</span><span class="fu">readValue</span><span class="op">(</span></span>
<span id="cb88-32"><a href="#cb88-32" aria-hidden="true" tabindex="-1"></a>                message<span class="op">.</span><span class="fu">getPayload</span><span class="op">(),</span> </span>
<span id="cb88-33"><a href="#cb88-33" aria-hidden="true" tabindex="-1"></a>                <span class="bu">Map</span><span class="op">.</span><span class="fu">class</span></span>
<span id="cb88-34"><a href="#cb88-34" aria-hidden="true" tabindex="-1"></a>            <span class="op">);</span></span>
<span id="cb88-35"><a href="#cb88-35" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> messageType <span class="op">=</span> <span class="op">(</span><span class="bu">String</span><span class="op">)</span> payload<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;type&quot;</span><span class="op">);</span></span>
<span id="cb88-36"><a href="#cb88-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-37"><a href="#cb88-37" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Route message to appropriate handler based on type</span></span>
<span id="cb88-38"><a href="#cb88-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">switch</span> <span class="op">(</span>messageType<span class="op">)</span> <span class="op">{</span></span>
<span id="cb88-39"><a href="#cb88-39" aria-hidden="true" tabindex="-1"></a>                <span class="cf">case</span> <span class="st">&quot;authenticate&quot;</span><span class="op">:</span></span>
<span id="cb88-40"><a href="#cb88-40" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// Client sends JWT token to authenticate the connection</span></span>
<span id="cb88-41"><a href="#cb88-41" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">handleAuthentication</span><span class="op">(</span>session<span class="op">,</span> payload<span class="op">);</span></span>
<span id="cb88-42"><a href="#cb88-42" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb88-43"><a href="#cb88-43" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb88-44"><a href="#cb88-44" aria-hidden="true" tabindex="-1"></a>                <span class="cf">case</span> <span class="st">&quot;heartbeat&quot;</span><span class="op">:</span></span>
<span id="cb88-45"><a href="#cb88-45" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// Client sends periodic heartbeat to keep connection alive</span></span>
<span id="cb88-46"><a href="#cb88-46" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">handleHeartbeat</span><span class="op">(</span>session<span class="op">);</span></span>
<span id="cb88-47"><a href="#cb88-47" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb88-48"><a href="#cb88-48" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb88-49"><a href="#cb88-49" aria-hidden="true" tabindex="-1"></a>                <span class="cf">case</span> <span class="st">&quot;ai-chat-notification&quot;</span><span class="op">:</span></span>
<span id="cb88-50"><a href="#cb88-50" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// AI-generated health recommendations or alerts</span></span>
<span id="cb88-51"><a href="#cb88-51" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">handleAIChatNotification</span><span class="op">(</span>session<span class="op">,</span> payload<span class="op">);</span></span>
<span id="cb88-52"><a href="#cb88-52" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb88-53"><a href="#cb88-53" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb88-54"><a href="#cb88-54" aria-hidden="true" tabindex="-1"></a>                <span class="cf">case</span> <span class="st">&quot;mood-pain-log-update&quot;</span><span class="op">:</span></span>
<span id="cb88-55"><a href="#cb88-55" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// Patient reported mood/pain data in real-time</span></span>
<span id="cb88-56"><a href="#cb88-56" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">handleMoodPainLogUpdate</span><span class="op">(</span>session<span class="op">,</span> payload<span class="op">);</span></span>
<span id="cb88-57"><a href="#cb88-57" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb88-58"><a href="#cb88-58" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb88-59"><a href="#cb88-59" aria-hidden="true" tabindex="-1"></a>                <span class="cf">case</span> <span class="st">&quot;medication-reminder&quot;</span><span class="op">:</span></span>
<span id="cb88-60"><a href="#cb88-60" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// Scheduled medication reminder needs to be sent</span></span>
<span id="cb88-61"><a href="#cb88-61" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">handleMedicationReminder</span><span class="op">(</span>session<span class="op">,</span> payload<span class="op">);</span></span>
<span id="cb88-62"><a href="#cb88-62" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb88-63"><a href="#cb88-63" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb88-64"><a href="#cb88-64" aria-hidden="true" tabindex="-1"></a>                <span class="cf">case</span> <span class="st">&quot;vital-signs-alert&quot;</span><span class="op">:</span></span>
<span id="cb88-65"><a href="#cb88-65" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// Abnormal vital sign detected, alert caregivers</span></span>
<span id="cb88-66"><a href="#cb88-66" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">handleVitalSignsAlert</span><span class="op">(</span>session<span class="op">,</span> payload<span class="op">);</span></span>
<span id="cb88-67"><a href="#cb88-67" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb88-68"><a href="#cb88-68" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb88-69"><a href="#cb88-69" aria-hidden="true" tabindex="-1"></a>                <span class="cf">case</span> <span class="st">&quot;emergency-alert&quot;</span><span class="op">:</span></span>
<span id="cb88-70"><a href="#cb88-70" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// Critical patient emergency, highest priority</span></span>
<span id="cb88-71"><a href="#cb88-71" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">handleEmergencyAlert</span><span class="op">(</span>session<span class="op">,</span> payload<span class="op">);</span></span>
<span id="cb88-72"><a href="#cb88-72" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb88-73"><a href="#cb88-73" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb88-74"><a href="#cb88-74" aria-hidden="true" tabindex="-1"></a>                <span class="kw">default</span><span class="op">:</span></span>
<span id="cb88-75"><a href="#cb88-75" aria-hidden="true" tabindex="-1"></a>                    log<span class="op">.</span><span class="fu">warn</span><span class="op">(</span><span class="st">&quot;Unknown message type received: {}&quot;</span><span class="op">,</span> messageType<span class="op">);</span></span>
<span id="cb88-76"><a href="#cb88-76" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">sendErrorMessage</span><span class="op">(</span>session<span class="op">,</span> <span class="st">&quot;Unknown message type: &quot;</span> <span class="op">+</span> messageType<span class="op">);</span></span>
<span id="cb88-77"><a href="#cb88-77" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb88-78"><a href="#cb88-78" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb88-79"><a href="#cb88-79" aria-hidden="true" tabindex="-1"></a>            log<span class="op">.</span><span class="fu">error</span><span class="op">(</span><span class="st">&quot;Error handling WebSocket message&quot;</span><span class="op">,</span> e<span class="op">);</span></span>
<span id="cb88-80"><a href="#cb88-80" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sendErrorMessage</span><span class="op">(</span>session<span class="op">,</span> <span class="st">&quot;Invalid message format&quot;</span><span class="op">);</span></span>
<span id="cb88-81"><a href="#cb88-81" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb88-82"><a href="#cb88-82" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb88-83"><a href="#cb88-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-84"><a href="#cb88-84" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb88-85"><a href="#cb88-85" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> Handles client authentication over WebSocket<span class="co">.</span></span>
<span id="cb88-86"><a href="#cb88-86" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> Unlike REST APIs where auth happens per<span class="co">-</span>request<span class="co">,</span> WebSocket connections</span>
<span id="cb88-87"><a href="#cb88-87" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> authenticate once when established<span class="co">,</span> then remain authenticated<span class="co">.</span></span>
<span id="cb88-88"><a href="#cb88-88" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb88-89"><a href="#cb88-89" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">handleAuthentication</span><span class="op">(</span>WebSocketSession session<span class="op">,</span> <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> payload<span class="op">)</span> <span class="op">{</span></span>
<span id="cb88-90"><a href="#cb88-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb88-91"><a href="#cb88-91" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> token <span class="op">=</span> <span class="op">(</span><span class="bu">String</span><span class="op">)</span> payload<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;token&quot;</span><span class="op">);</span></span>
<span id="cb88-92"><a href="#cb88-92" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Long</span> userId <span class="op">=</span> <span class="fu">getLongValue</span><span class="op">(</span>payload<span class="op">,</span> <span class="st">&quot;userId&quot;</span><span class="op">);</span></span>
<span id="cb88-93"><a href="#cb88-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-94"><a href="#cb88-94" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>jwtTokenProvider<span class="op">.</span><span class="fu">validateToken</span><span class="op">(</span>token<span class="op">))</span> <span class="op">{</span></span>
<span id="cb88-95"><a href="#cb88-95" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Token is valid - extract user information</span></span>
<span id="cb88-96"><a href="#cb88-96" aria-hidden="true" tabindex="-1"></a>                Claims claims <span class="op">=</span> jwtTokenProvider<span class="op">.</span><span class="fu">getClaims</span><span class="op">(</span>token<span class="op">);</span></span>
<span id="cb88-97"><a href="#cb88-97" aria-hidden="true" tabindex="-1"></a>                <span class="bu">String</span> email <span class="op">=</span> claims<span class="op">.</span><span class="fu">getSubject</span><span class="op">();</span></span>
<span id="cb88-98"><a href="#cb88-98" aria-hidden="true" tabindex="-1"></a>                <span class="bu">String</span> role <span class="op">=</span> claims<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;role&quot;</span><span class="op">,</span> <span class="bu">String</span><span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb88-99"><a href="#cb88-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-100"><a href="#cb88-100" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Store user info in session attributes</span></span>
<span id="cb88-101"><a href="#cb88-101" aria-hidden="true" tabindex="-1"></a>                <span class="co">// These persist for the lifetime of the WebSocket connection</span></span>
<span id="cb88-102"><a href="#cb88-102" aria-hidden="true" tabindex="-1"></a>                session<span class="op">.</span><span class="fu">getAttributes</span><span class="op">().</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;userId&quot;</span><span class="op">,</span> userId<span class="op">);</span></span>
<span id="cb88-103"><a href="#cb88-103" aria-hidden="true" tabindex="-1"></a>                session<span class="op">.</span><span class="fu">getAttributes</span><span class="op">().</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;email&quot;</span><span class="op">,</span> email<span class="op">);</span></span>
<span id="cb88-104"><a href="#cb88-104" aria-hidden="true" tabindex="-1"></a>                session<span class="op">.</span><span class="fu">getAttributes</span><span class="op">().</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;role&quot;</span><span class="op">,</span> role<span class="op">);</span></span>
<span id="cb88-105"><a href="#cb88-105" aria-hidden="true" tabindex="-1"></a>                session<span class="op">.</span><span class="fu">getAttributes</span><span class="op">().</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;authenticated&quot;</span><span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb88-106"><a href="#cb88-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-107"><a href="#cb88-107" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Map user ID to this session for targeted messaging</span></span>
<span id="cb88-108"><a href="#cb88-108" aria-hidden="true" tabindex="-1"></a>                <span class="co">// When we need to send alert to user 123, we look up their session here</span></span>
<span id="cb88-109"><a href="#cb88-109" aria-hidden="true" tabindex="-1"></a>                userSessions<span class="op">.</span><span class="fu">put</span><span class="op">(</span>userId<span class="op">,</span> session<span class="op">);</span></span>
<span id="cb88-110"><a href="#cb88-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-111"><a href="#cb88-111" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Persist connection to database for audit trail and reconnection</span></span>
<span id="cb88-112"><a href="#cb88-112" aria-hidden="true" tabindex="-1"></a>                connectionService<span class="op">.</span><span class="fu">saveConnection</span><span class="op">(</span></span>
<span id="cb88-113"><a href="#cb88-113" aria-hidden="true" tabindex="-1"></a>                    session<span class="op">.</span><span class="fu">getId</span><span class="op">(),</span> </span>
<span id="cb88-114"><a href="#cb88-114" aria-hidden="true" tabindex="-1"></a>                    email<span class="op">,</span> </span>
<span id="cb88-115"><a href="#cb88-115" aria-hidden="true" tabindex="-1"></a>                    userId<span class="op">,</span> </span>
<span id="cb88-116"><a href="#cb88-116" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;authenticated&quot;</span></span>
<span id="cb88-117"><a href="#cb88-117" aria-hidden="true" tabindex="-1"></a>                <span class="op">);</span></span>
<span id="cb88-118"><a href="#cb88-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-119"><a href="#cb88-119" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Confirm successful authentication to client</span></span>
<span id="cb88-120"><a href="#cb88-120" aria-hidden="true" tabindex="-1"></a>                <span class="fu">sendMessage</span><span class="op">(</span>session<span class="op">,</span> <span class="bu">Map</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span></span>
<span id="cb88-121"><a href="#cb88-121" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;type&quot;</span><span class="op">,</span> <span class="st">&quot;authentication-success&quot;</span><span class="op">,</span></span>
<span id="cb88-122"><a href="#cb88-122" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;userId&quot;</span><span class="op">,</span> userId<span class="op">,</span></span>
<span id="cb88-123"><a href="#cb88-123" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;email&quot;</span><span class="op">,</span> email<span class="op">,</span></span>
<span id="cb88-124"><a href="#cb88-124" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;role&quot;</span><span class="op">,</span> role</span>
<span id="cb88-125"><a href="#cb88-125" aria-hidden="true" tabindex="-1"></a>                <span class="op">));</span></span>
<span id="cb88-126"><a href="#cb88-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-127"><a href="#cb88-127" aria-hidden="true" tabindex="-1"></a>                log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;User {} authenticated via WebSocket&quot;</span><span class="op">,</span> email<span class="op">);</span></span>
<span id="cb88-128"><a href="#cb88-128" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb88-129"><a href="#cb88-129" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Invalid token - reject authentication</span></span>
<span id="cb88-130"><a href="#cb88-130" aria-hidden="true" tabindex="-1"></a>                <span class="fu">sendMessage</span><span class="op">(</span>session<span class="op">,</span> <span class="bu">Map</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span></span>
<span id="cb88-131"><a href="#cb88-131" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;type&quot;</span><span class="op">,</span> <span class="st">&quot;authentication-error&quot;</span><span class="op">,</span></span>
<span id="cb88-132"><a href="#cb88-132" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;message&quot;</span><span class="op">,</span> <span class="st">&quot;Invalid token&quot;</span></span>
<span id="cb88-133"><a href="#cb88-133" aria-hidden="true" tabindex="-1"></a>                <span class="op">));</span></span>
<span id="cb88-134"><a href="#cb88-134" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb88-135"><a href="#cb88-135" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Close connection after authentication failure</span></span>
<span id="cb88-136"><a href="#cb88-136" aria-hidden="true" tabindex="-1"></a>                session<span class="op">.</span><span class="fu">close</span><span class="op">(</span>CloseStatus<span class="op">.</span><span class="fu">POLICY_VIOLATION</span><span class="op">);</span></span>
<span id="cb88-137"><a href="#cb88-137" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb88-138"><a href="#cb88-138" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb88-139"><a href="#cb88-139" aria-hidden="true" tabindex="-1"></a>            log<span class="op">.</span><span class="fu">error</span><span class="op">(</span><span class="st">&quot;Authentication error&quot;</span><span class="op">,</span> e<span class="op">);</span></span>
<span id="cb88-140"><a href="#cb88-140" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sendErrorMessage</span><span class="op">(</span>session<span class="op">,</span> <span class="st">&quot;Authentication failed&quot;</span><span class="op">);</span></span>
<span id="cb88-141"><a href="#cb88-141" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb88-142"><a href="#cb88-142" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb88-143"><a href="#cb88-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-144"><a href="#cb88-144" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb88-145"><a href="#cb88-145" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> Handles emergency alerts <span class="co">-</span> highest priority healthcare notifications<span class="co">.</span></span>
<span id="cb88-146"><a href="#cb88-146" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> These bypass normal throttling and are delivered immediately to all</span>
<span id="cb88-147"><a href="#cb88-147" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> authorized recipients <span class="co">(</span>caregivers and family members<span class="co">).</span></span>
<span id="cb88-148"><a href="#cb88-148" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb88-149"><a href="#cb88-149" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">handleEmergencyAlert</span><span class="op">(</span>WebSocketSession session<span class="op">,</span> <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> payload<span class="op">)</span> <span class="op">{</span></span>
<span id="cb88-150"><a href="#cb88-150" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Long</span> patientId <span class="op">=</span> <span class="fu">getLongValue</span><span class="op">(</span>payload<span class="op">,</span> <span class="st">&quot;patientId&quot;</span><span class="op">);</span></span>
<span id="cb88-151"><a href="#cb88-151" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> alertType <span class="op">=</span> <span class="op">(</span><span class="bu">String</span><span class="op">)</span> payload<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;alertType&quot;</span><span class="op">);</span></span>
<span id="cb88-152"><a href="#cb88-152" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> message <span class="op">=</span> <span class="op">(</span><span class="bu">String</span><span class="op">)</span> payload<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;message&quot;</span><span class="op">);</span></span>
<span id="cb88-153"><a href="#cb88-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-154"><a href="#cb88-154" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Construct alert payload</span></span>
<span id="cb88-155"><a href="#cb88-155" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> alert <span class="op">=</span> <span class="bu">Map</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span></span>
<span id="cb88-156"><a href="#cb88-156" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;type&quot;</span><span class="op">,</span> <span class="st">&quot;emergency-alert&quot;</span><span class="op">,</span></span>
<span id="cb88-157"><a href="#cb88-157" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;patientId&quot;</span><span class="op">,</span> patientId<span class="op">,</span></span>
<span id="cb88-158"><a href="#cb88-158" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;alertType&quot;</span><span class="op">,</span> alertType<span class="op">,</span></span>
<span id="cb88-159"><a href="#cb88-159" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;message&quot;</span><span class="op">,</span> message<span class="op">,</span></span>
<span id="cb88-160"><a href="#cb88-160" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;timestamp&quot;</span><span class="op">,</span> <span class="bu">System</span><span class="op">.</span><span class="fu">currentTimeMillis</span><span class="op">(),</span></span>
<span id="cb88-161"><a href="#cb88-161" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;priority&quot;</span><span class="op">,</span> <span class="st">&quot;HIGH&quot;</span></span>
<span id="cb88-162"><a href="#cb88-162" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb88-163"><a href="#cb88-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-164"><a href="#cb88-164" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Broadcast to all caregivers and family members linked to this patient</span></span>
<span id="cb88-165"><a href="#cb88-165" aria-hidden="true" tabindex="-1"></a>        <span class="co">// This uses a specialized method that queries database for authorized users</span></span>
<span id="cb88-166"><a href="#cb88-166" aria-hidden="true" tabindex="-1"></a>        <span class="co">// and sends to all their active WebSocket sessions</span></span>
<span id="cb88-167"><a href="#cb88-167" aria-hidden="true" tabindex="-1"></a>        <span class="fu">broadcastToUsersByRole</span><span class="op">(</span></span>
<span id="cb88-168"><a href="#cb88-168" aria-hidden="true" tabindex="-1"></a>            patientId<span class="op">,</span> </span>
<span id="cb88-169"><a href="#cb88-169" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;emergency-alert&quot;</span><span class="op">,</span> </span>
<span id="cb88-170"><a href="#cb88-170" aria-hidden="true" tabindex="-1"></a>            alert<span class="op">,</span></span>
<span id="cb88-171"><a href="#cb88-171" aria-hidden="true" tabindex="-1"></a>            <span class="bu">List</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span><span class="st">&quot;CAREGIVER&quot;</span><span class="op">,</span> <span class="st">&quot;FAMILY_MEMBER&quot;</span><span class="op">)</span></span>
<span id="cb88-172"><a href="#cb88-172" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb88-173"><a href="#cb88-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-174"><a href="#cb88-174" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Audit log - all emergency alerts must be logged for compliance</span></span>
<span id="cb88-175"><a href="#cb88-175" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">warn</span><span class="op">(</span><span class="st">&quot;🚨 EMERGENCY ALERT sent for patient {}: {} - {}&quot;</span><span class="op">,</span> </span>
<span id="cb88-176"><a href="#cb88-176" aria-hidden="true" tabindex="-1"></a>            patientId<span class="op">,</span> alertType<span class="op">,</span> message<span class="op">);</span></span>
<span id="cb88-177"><a href="#cb88-177" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb88-178"><a href="#cb88-178" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Could also trigger additional actions:</span></span>
<span id="cb88-179"><a href="#cb88-179" aria-hidden="true" tabindex="-1"></a>        <span class="co">// - Send SMS to emergency contact</span></span>
<span id="cb88-180"><a href="#cb88-180" aria-hidden="true" tabindex="-1"></a>        <span class="co">// - Create database record for audit trail</span></span>
<span id="cb88-181"><a href="#cb88-181" aria-hidden="true" tabindex="-1"></a>        <span class="co">// - Trigger automated escalation if no acknowledgment within X minutes</span></span>
<span id="cb88-182"><a href="#cb88-182" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb88-183"><a href="#cb88-183" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb88-184"><a href="#cb88-184" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">sendMessage</span><span class="op">(</span>WebSocketSession session<span class="op">,</span> <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> message<span class="op">)</span> </span>
<span id="cb88-185"><a href="#cb88-185" aria-hidden="true" tabindex="-1"></a>            <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb88-186"><a href="#cb88-186" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>session<span class="op">.</span><span class="fu">isOpen</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb88-187"><a href="#cb88-187" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> json <span class="op">=</span> objectMapper<span class="op">.</span><span class="fu">writeValueAsString</span><span class="op">(</span>message<span class="op">);</span></span>
<span id="cb88-188"><a href="#cb88-188" aria-hidden="true" tabindex="-1"></a>            session<span class="op">.</span><span class="fu">sendMessage</span><span class="op">(</span><span class="kw">new</span> <span class="fu">TextMessage</span><span class="op">(</span>json<span class="op">));</span></span>
<span id="cb88-189"><a href="#cb88-189" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb88-190"><a href="#cb88-190" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb88-191"><a href="#cb88-191" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="key-architectural-decisions">Key Architectural Decisions</h4>
<p><strong>Stateful Connections</strong>: Unlike REST’s stateless
nature, WebSocket connections are stateful. Once a user authenticates,
their connection remains authenticated until they disconnect or their
token expires. This eliminates the overhead of validating JWT on every
message.</p>
<p><strong>User Session Mapping</strong>: The <code>userSessions</code>
map enables targeted messaging. When a vital sign alert needs to reach a
specific caregiver, we look up their session and send directly to them,
rather than broadcasting to everyone.</p>
<p><strong>Message Type Routing</strong>: The
<code>handleTextMessage</code> switch statement acts as a message
router. As new real-time features are added, they get a new message type
and handler method. This scales much better than monolithic message
processing.</p>
<p><strong>Audit Logging</strong>: Every significant event
(authentication, emergency alerts) is logged. In healthcare, this audit
trail is not optional—it’s a regulatory requirement for demonstrating
compliance with HIPAA and other regulations.</p>
<p><strong>Error Resilience</strong>: Notice how exceptions are caught
and transformed into error messages sent back to the client. A crashed
WebSocket handler would drop all active connections—unacceptable in a
healthcare app where those connections might be monitoring critical
patients.</p>
<h3 id="connection-lifecycle-and-management">Connection Lifecycle and
Management</h3>
<p><strong>Connection Establishment</strong>: 1. Client opens WebSocket
connection to <code>/ws/careconnect</code> 2. Server accepts, assigns
session ID 3. Client sends <code>authenticate</code> message with JWT 4.
Server validates token, stores user info in session 5. Connection is now
ready for bidirectional messaging</p>
<p><strong>Active Connection</strong>: - Client sends periodic
heartbeats (every 30 seconds) to prevent timeout - Server can send
messages anytime (alerts, notifications) - Client can send messages
anytime (requests, updates) - Connection remains open for hours or
days</p>
<p><strong>Connection Termination</strong>: - Client explicitly closes
(app backgrounded, user logs out) - Network interruption (mobile signal
loss, WiFi disconnect) - Server timeout (no heartbeat for 5 minutes) -
Server restart (all connections dropped, clients must reconnect)</p>
<p><strong>Reconnection Strategy</strong>: Clients implement exponential
backoff reconnection:</p>
<div class="sourceCode" id="cb89"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Flutter client reconnection logic</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> retryCount <span class="op">=</span> <span class="dv">0</span>;</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> (retryCount <span class="op">&lt;</span> <span class="dv">5</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>connected) {</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">await</span> <span class="dt">Future</span><span class="op">.</span>delayed(Duration(seconds<span class="op">:</span> math<span class="op">.</span>pow(<span class="dv">2</span><span class="op">,</span> retryCount)<span class="op">.</span>toInt()));</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">await</span> connect();</span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>    retryCount <span class="op">=</span> <span class="dv">0</span>; <span class="co">// Reset on success</span></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (e) {</span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>    retryCount<span class="op">++</span>;</span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This prevents overwhelming the server with reconnection attempts
while ensuring clients eventually reconnect.</p>
<h4
id="callnotificationhandler---videoaudio-calls">CallNotificationHandler
- Video/Audio Calls</h4>
<div class="sourceCode" id="cb90"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Component</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Slf4j</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> CallNotificationHandler <span class="kw">extends</span> TextWebSocketHandler <span class="op">{</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> <span class="dt">void</span> <span class="fu">handleTextMessage</span><span class="op">(</span>WebSocketSession session<span class="op">,</span> TextMessage message<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> payload <span class="op">=</span> objectMapper<span class="op">.</span><span class="fu">readValue</span><span class="op">(</span>message<span class="op">.</span><span class="fu">getPayload</span><span class="op">(),</span> <span class="bu">Map</span><span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> messageType <span class="op">=</span> <span class="op">(</span><span class="bu">String</span><span class="op">)</span> payload<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;type&quot;</span><span class="op">);</span></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> <span class="op">(</span>messageType<span class="op">)</span> <span class="op">{</span></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="st">&quot;send-video-call-invitation&quot;</span><span class="op">:</span></span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>                <span class="fu">handleVideoCallInvitation</span><span class="op">(</span>session<span class="op">,</span> payload<span class="op">);</span></span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="st">&quot;accept-call&quot;</span><span class="op">:</span></span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>                <span class="fu">handleAcceptCall</span><span class="op">(</span>session<span class="op">,</span> payload<span class="op">);</span></span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="st">&quot;decline-call&quot;</span><span class="op">:</span></span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a>                <span class="fu">handleDeclineCall</span><span class="op">(</span>session<span class="op">,</span> payload<span class="op">);</span></span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="st">&quot;end-call&quot;</span><span class="op">:</span></span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true" tabindex="-1"></a>                <span class="fu">handleEndCall</span><span class="op">(</span>session<span class="op">,</span> payload<span class="op">);</span></span>
<span id="cb90-22"><a href="#cb90-22" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb90-23"><a href="#cb90-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="st">&quot;send-sms-notification&quot;</span><span class="op">:</span></span>
<span id="cb90-24"><a href="#cb90-24" aria-hidden="true" tabindex="-1"></a>                <span class="fu">handleSMSNotification</span><span class="op">(</span>session<span class="op">,</span> payload<span class="op">);</span></span>
<span id="cb90-25"><a href="#cb90-25" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb90-26"><a href="#cb90-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb90-27"><a href="#cb90-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb90-28"><a href="#cb90-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-29"><a href="#cb90-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">handleVideoCallInvitation</span><span class="op">(</span>WebSocketSession session<span class="op">,</span> <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> payload<span class="op">)</span> <span class="op">{</span></span>
<span id="cb90-30"><a href="#cb90-30" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> fromUserId <span class="op">=</span> <span class="op">(</span><span class="bu">String</span><span class="op">)</span> payload<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;fromUserId&quot;</span><span class="op">);</span></span>
<span id="cb90-31"><a href="#cb90-31" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> toUserId <span class="op">=</span> <span class="op">(</span><span class="bu">String</span><span class="op">)</span> payload<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;toUserId&quot;</span><span class="op">);</span></span>
<span id="cb90-32"><a href="#cb90-32" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> callType <span class="op">=</span> <span class="op">(</span><span class="bu">String</span><span class="op">)</span> payload<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;callType&quot;</span><span class="op">);</span> <span class="co">// &quot;video&quot; or &quot;audio&quot;</span></span>
<span id="cb90-33"><a href="#cb90-33" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> roomId <span class="op">=</span> <span class="op">(</span><span class="bu">String</span><span class="op">)</span> payload<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;roomId&quot;</span><span class="op">);</span></span>
<span id="cb90-34"><a href="#cb90-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-35"><a href="#cb90-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Find recipient session and send invitation</span></span>
<span id="cb90-36"><a href="#cb90-36" aria-hidden="true" tabindex="-1"></a>        WebSocketSession recipientSession <span class="op">=</span> <span class="fu">findSessionByUserId</span><span class="op">(</span>toUserId<span class="op">);</span></span>
<span id="cb90-37"><a href="#cb90-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>recipientSession <span class="op">!=</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> recipientSession<span class="op">.</span><span class="fu">isOpen</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb90-38"><a href="#cb90-38" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sendMessage</span><span class="op">(</span>recipientSession<span class="op">,</span> <span class="bu">Map</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span></span>
<span id="cb90-39"><a href="#cb90-39" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;type&quot;</span><span class="op">,</span> <span class="st">&quot;incoming-call&quot;</span><span class="op">,</span></span>
<span id="cb90-40"><a href="#cb90-40" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;fromUserId&quot;</span><span class="op">,</span> fromUserId<span class="op">,</span></span>
<span id="cb90-41"><a href="#cb90-41" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;callType&quot;</span><span class="op">,</span> callType<span class="op">,</span></span>
<span id="cb90-42"><a href="#cb90-42" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;roomId&quot;</span><span class="op">,</span> roomId<span class="op">,</span></span>
<span id="cb90-43"><a href="#cb90-43" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;timestamp&quot;</span><span class="op">,</span> <span class="bu">System</span><span class="op">.</span><span class="fu">currentTimeMillis</span><span class="op">()</span></span>
<span id="cb90-44"><a href="#cb90-44" aria-hidden="true" tabindex="-1"></a>            <span class="op">));</span></span>
<span id="cb90-45"><a href="#cb90-45" aria-hidden="true" tabindex="-1"></a>            log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;Call invitation sent from {} to {}&quot;</span><span class="op">,</span> fromUserId<span class="op">,</span> toUserId<span class="op">);</span></span>
<span id="cb90-46"><a href="#cb90-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb90-47"><a href="#cb90-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb90-48"><a href="#cb90-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="security-implementation">Security Implementation</h3>
<h4 id="jwt-authentication">JWT Authentication</h4>
<div class="sourceCode" id="cb91"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co">// WebSocket authentication check</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">void</span> <span class="fu">handleAuthentication</span><span class="op">(</span>WebSocketSession session<span class="op">,</span> <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> payload<span class="op">)</span> <span class="op">{</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> token <span class="op">=</span> <span class="op">(</span><span class="bu">String</span><span class="op">)</span> payload<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;token&quot;</span><span class="op">);</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>jwtTokenProvider<span class="op">.</span><span class="fu">validateToken</span><span class="op">(</span>token<span class="op">))</span> <span class="op">{</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>        Claims claims <span class="op">=</span> jwtTokenProvider<span class="op">.</span><span class="fu">getClaims</span><span class="op">(</span>token<span class="op">);</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> email <span class="op">=</span> claims<span class="op">.</span><span class="fu">getSubject</span><span class="op">();</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> role <span class="op">=</span> claims<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;role&quot;</span><span class="op">,</span> <span class="bu">String</span><span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Store authenticated user info</span></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>        session<span class="op">.</span><span class="fu">getAttributes</span><span class="op">().</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;authenticated&quot;</span><span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>        session<span class="op">.</span><span class="fu">getAttributes</span><span class="op">().</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;email&quot;</span><span class="op">,</span> email<span class="op">);</span></span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>        session<span class="op">.</span><span class="fu">getAttributes</span><span class="op">().</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;role&quot;</span><span class="op">,</span> role<span class="op">);</span></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>        userSessions<span class="op">.</span><span class="fu">put</span><span class="op">(</span>userId<span class="op">,</span> session<span class="op">);</span></span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a>        connectionService<span class="op">.</span><span class="fu">saveConnection</span><span class="op">(</span>session<span class="op">.</span><span class="fu">getId</span><span class="op">(),</span> email<span class="op">,</span> userId<span class="op">,</span> <span class="st">&quot;authenticated&quot;</span><span class="op">);</span></span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="cors-configuration">CORS Configuration</h4>
<pre class="properties"><code># application.properties
careconnect.websocket.allowed-origins=http://localhost:*,https://*.careconnect.com
careconnect.websocket.connection-ttl-minutes=30</code></pre>
<h3 id="connection-management">Connection Management</h3>
<h4 id="websocket-connection-entity">WebSocket Connection Entity</h4>
<div class="sourceCode" id="cb93"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co">// model/WebSocketConnection.java</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Entity</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="at">@Table</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;websocket_connections&quot;</span><span class="op">)</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> WebSocketConnection <span class="op">{</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Id</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GeneratedValue</span><span class="op">(</span>strategy <span class="op">=</span> GenerationType<span class="op">.</span><span class="fu">IDENTITY</span><span class="op">)</span></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Long</span> id<span class="op">;</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>unique <span class="op">=</span> <span class="kw">true</span><span class="op">)</span></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> connectionId<span class="op">;</span></span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> userEmail<span class="op">;</span></span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Long</span> userId<span class="op">;</span></span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Enumerated</span><span class="op">(</span>EnumType<span class="op">.</span><span class="fu">STRING</span><span class="op">)</span></span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> SubscriptionType subscriptionType<span class="op">;</span> <span class="co">// email-verification, authenticated, notifications</span></span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-20"><a href="#cb93-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Enumerated</span><span class="op">(</span>EnumType<span class="op">.</span><span class="fu">STRING</span><span class="op">)</span></span>
<span id="cb93-21"><a href="#cb93-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> ConnectionType connectionType<span class="op">;</span> <span class="co">// LOCAL, AWS</span></span>
<span id="cb93-22"><a href="#cb93-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-23"><a href="#cb93-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> LocalDateTime connectedAt<span class="op">;</span></span>
<span id="cb93-24"><a href="#cb93-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> LocalDateTime lastActivityAt<span class="op">;</span></span>
<span id="cb93-25"><a href="#cb93-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> LocalDateTime expiresAt<span class="op">;</span></span>
<span id="cb93-26"><a href="#cb93-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Boolean</span> isActive <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb93-27"><a href="#cb93-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="connection-service">Connection Service</h4>
<div class="sourceCode" id="cb94"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co">// service/WebSocketConnectionService.java</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="at">@Transactional</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> WebSocketConnectionService <span class="op">{</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">saveConnection</span><span class="op">(</span><span class="bu">String</span> connectionId<span class="op">,</span> <span class="bu">String</span> email<span class="op">,</span> <span class="bu">Long</span> userId<span class="op">,</span> <span class="bu">String</span> subscriptionType<span class="op">)</span> <span class="op">{</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>        WebSocketConnection connection <span class="op">=</span> <span class="kw">new</span> <span class="fu">WebSocketConnection</span><span class="op">();</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>        connection<span class="op">.</span><span class="fu">setConnectionId</span><span class="op">(</span>connectionId<span class="op">);</span></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>        connection<span class="op">.</span><span class="fu">setUserEmail</span><span class="op">(</span>email<span class="op">);</span></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>        connection<span class="op">.</span><span class="fu">setUserId</span><span class="op">(</span>userId<span class="op">);</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>        connection<span class="op">.</span><span class="fu">setSubscriptionType</span><span class="op">(</span>SubscriptionType<span class="op">.</span><span class="fu">valueOf</span><span class="op">(</span>subscriptionType<span class="op">.</span><span class="fu">toUpperCase</span><span class="op">()));</span></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>        connection<span class="op">.</span><span class="fu">setConnectionType</span><span class="op">(</span><span class="fu">detectConnectionType</span><span class="op">());</span></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>        connection<span class="op">.</span><span class="fu">setConnectedAt</span><span class="op">(</span>LocalDateTime<span class="op">.</span><span class="fu">now</span><span class="op">());</span></span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>        connection<span class="op">.</span><span class="fu">setExpiresAt</span><span class="op">(</span>LocalDateTime<span class="op">.</span><span class="fu">now</span><span class="op">().</span><span class="fu">plusMinutes</span><span class="op">(</span><span class="fu">getConnectionTTL</span><span class="op">()));</span></span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a>        connection<span class="op">.</span><span class="fu">setIsActive</span><span class="op">(</span><span class="kw">true</span><span class="op">);</span></span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a>        repository<span class="op">.</span><span class="fu">save</span><span class="op">(</span>connection<span class="op">);</span></span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-20"><a href="#cb94-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Scheduled</span><span class="op">(</span>fixedRate <span class="op">=</span> <span class="dv">300000</span><span class="op">)</span> <span class="co">// Every 5 minutes</span></span>
<span id="cb94-21"><a href="#cb94-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">cleanupExpiredConnections</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb94-22"><a href="#cb94-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span>WebSocketConnection<span class="op">&gt;</span> expired <span class="op">=</span> repository<span class="op">.</span><span class="fu">findExpiredConnections</span><span class="op">(</span>LocalDateTime<span class="op">.</span><span class="fu">now</span><span class="op">());</span></span>
<span id="cb94-23"><a href="#cb94-23" aria-hidden="true" tabindex="-1"></a>        expired<span class="op">.</span><span class="fu">forEach</span><span class="op">(</span>conn <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb94-24"><a href="#cb94-24" aria-hidden="true" tabindex="-1"></a>            conn<span class="op">.</span><span class="fu">setIsActive</span><span class="op">(</span><span class="kw">false</span><span class="op">);</span></span>
<span id="cb94-25"><a href="#cb94-25" aria-hidden="true" tabindex="-1"></a>            repository<span class="op">.</span><span class="fu">save</span><span class="op">(</span>conn<span class="op">);</span></span>
<span id="cb94-26"><a href="#cb94-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb94-27"><a href="#cb94-27" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;Cleaned up {} expired WebSocket connections&quot;</span><span class="op">,</span> expired<span class="op">.</span><span class="fu">size</span><span class="op">());</span></span>
<span id="cb94-28"><a href="#cb94-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb94-29"><a href="#cb94-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="rest-api-integration">REST API Integration</h3>
<h4 id="websocket-controller">WebSocket Controller</h4>
<div class="sourceCode" id="cb95"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co">// controller/WebSocketController.java</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="at">@RestController</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/api/websocket&quot;</span><span class="op">)</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="at">@PreAuthorize</span><span class="op">(</span><span class="st">&quot;hasAnyRole(&#39;PATIENT&#39;, &#39;CAREGIVER&#39;, &#39;FAMILY_MEMBER&#39;, &#39;ADMIN&#39;)&quot;</span><span class="op">)</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> WebSocketController <span class="op">{</span></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">@PostMapping</span><span class="op">(</span><span class="st">&quot;/call-invitation&quot;</span><span class="op">)</span></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ResponseEntity<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> <span class="fu">sendCallInvitation</span><span class="op">(</span><span class="at">@RequestBody</span> CallInvitationRequest request<span class="op">)</span> <span class="op">{</span></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>        WebSocketSession recipientSession <span class="op">=</span> webSocketHandler<span class="op">.</span><span class="fu">getSessionByUserId</span><span class="op">(</span>request<span class="op">.</span><span class="fu">getToUserId</span><span class="op">());</span></span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>recipientSession <span class="op">!=</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> recipientSession<span class="op">.</span><span class="fu">isOpen</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>            webSocketHandler<span class="op">.</span><span class="fu">sendMessage</span><span class="op">(</span>recipientSession<span class="op">,</span> <span class="bu">Map</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span></span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;type&quot;</span><span class="op">,</span> <span class="st">&quot;incoming-call&quot;</span><span class="op">,</span></span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;fromUserId&quot;</span><span class="op">,</span> request<span class="op">.</span><span class="fu">getFromUserId</span><span class="op">(),</span></span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;callType&quot;</span><span class="op">,</span> request<span class="op">.</span><span class="fu">getCallType</span><span class="op">(),</span></span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;roomId&quot;</span><span class="op">,</span> request<span class="op">.</span><span class="fu">getRoomId</span><span class="op">()</span></span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a>            <span class="op">));</span></span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> ResponseEntity<span class="op">.</span><span class="fu">ok</span><span class="op">(</span><span class="st">&quot;Call invitation sent&quot;</span><span class="op">);</span></span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb95-19"><a href="#cb95-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ResponseEntity<span class="op">.</span><span class="fu">status</span><span class="op">(</span><span class="dv">404</span><span class="op">).</span><span class="fu">body</span><span class="op">(</span><span class="st">&quot;User not online&quot;</span><span class="op">);</span></span>
<span id="cb95-20"><a href="#cb95-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb95-21"><a href="#cb95-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-22"><a href="#cb95-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">@PostMapping</span><span class="op">(</span><span class="st">&quot;/medication-reminder&quot;</span><span class="op">)</span></span>
<span id="cb95-23"><a href="#cb95-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">@PreAuthorize</span><span class="op">(</span><span class="st">&quot;hasAnyRole(&#39;CAREGIVER&#39;, &#39;ADMIN&#39;)&quot;</span><span class="op">)</span></span>
<span id="cb95-24"><a href="#cb95-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ResponseEntity<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> <span class="fu">sendMedicationReminder</span><span class="op">(</span><span class="at">@RequestBody</span> MedicationReminderRequest request<span class="op">)</span> <span class="op">{</span></span>
<span id="cb95-25"><a href="#cb95-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">broadcastToPatient</span><span class="op">(</span>request<span class="op">.</span><span class="fu">getPatientId</span><span class="op">(),</span> <span class="st">&quot;medication-reminder&quot;</span><span class="op">,</span> <span class="bu">Map</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span></span>
<span id="cb95-26"><a href="#cb95-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;medicationName&quot;</span><span class="op">,</span> request<span class="op">.</span><span class="fu">getMedicationName</span><span class="op">(),</span></span>
<span id="cb95-27"><a href="#cb95-27" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;dosage&quot;</span><span class="op">,</span> request<span class="op">.</span><span class="fu">getDosage</span><span class="op">(),</span></span>
<span id="cb95-28"><a href="#cb95-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;timeToTake&quot;</span><span class="op">,</span> request<span class="op">.</span><span class="fu">getTimeToTake</span><span class="op">(),</span></span>
<span id="cb95-29"><a href="#cb95-29" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;instructions&quot;</span><span class="op">,</span> request<span class="op">.</span><span class="fu">getInstructions</span><span class="op">()</span></span>
<span id="cb95-30"><a href="#cb95-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">));</span></span>
<span id="cb95-31"><a href="#cb95-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ResponseEntity<span class="op">.</span><span class="fu">ok</span><span class="op">(</span><span class="st">&quot;Medication reminder sent&quot;</span><span class="op">);</span></span>
<span id="cb95-32"><a href="#cb95-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb95-33"><a href="#cb95-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-34"><a href="#cb95-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">@PostMapping</span><span class="op">(</span><span class="st">&quot;/emergency-alert&quot;</span><span class="op">)</span></span>
<span id="cb95-35"><a href="#cb95-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">@PreAuthorize</span><span class="op">(</span><span class="st">&quot;hasAnyRole(&#39;PATIENT&#39;, &#39;CAREGIVER&#39;, &#39;ADMIN&#39;)&quot;</span><span class="op">)</span></span>
<span id="cb95-36"><a href="#cb95-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ResponseEntity<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> <span class="fu">sendEmergencyAlert</span><span class="op">(</span><span class="at">@RequestBody</span> EmergencyAlertRequest request<span class="op">)</span> <span class="op">{</span></span>
<span id="cb95-37"><a href="#cb95-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">// High-priority emergency broadcast</span></span>
<span id="cb95-38"><a href="#cb95-38" aria-hidden="true" tabindex="-1"></a>        <span class="fu">broadcastToUsersByRole</span><span class="op">(</span>request<span class="op">.</span><span class="fu">getPatientId</span><span class="op">(),</span> <span class="st">&quot;emergency-alert&quot;</span><span class="op">,</span> <span class="bu">Map</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span></span>
<span id="cb95-39"><a href="#cb95-39" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;alertType&quot;</span><span class="op">,</span> request<span class="op">.</span><span class="fu">getAlertType</span><span class="op">(),</span></span>
<span id="cb95-40"><a href="#cb95-40" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;message&quot;</span><span class="op">,</span> request<span class="op">.</span><span class="fu">getMessage</span><span class="op">(),</span></span>
<span id="cb95-41"><a href="#cb95-41" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;location&quot;</span><span class="op">,</span> request<span class="op">.</span><span class="fu">getLocation</span><span class="op">(),</span></span>
<span id="cb95-42"><a href="#cb95-42" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;priority&quot;</span><span class="op">,</span> <span class="st">&quot;CRITICAL&quot;</span></span>
<span id="cb95-43"><a href="#cb95-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">),</span> <span class="bu">List</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span><span class="st">&quot;CAREGIVER&quot;</span><span class="op">,</span> <span class="st">&quot;FAMILY_MEMBER&quot;</span><span class="op">,</span> <span class="st">&quot;ADMIN&quot;</span><span class="op">));</span></span>
<span id="cb95-44"><a href="#cb95-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-45"><a href="#cb95-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ResponseEntity<span class="op">.</span><span class="fu">ok</span><span class="op">(</span><span class="st">&quot;Emergency alert broadcasted&quot;</span><span class="op">);</span></span>
<span id="cb95-46"><a href="#cb95-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb95-47"><a href="#cb95-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-48"><a href="#cb95-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/online-users&quot;</span><span class="op">)</span></span>
<span id="cb95-49"><a href="#cb95-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">@PreAuthorize</span><span class="op">(</span><span class="st">&quot;hasAnyRole(&#39;CAREGIVER&#39;, &#39;ADMIN&#39;)&quot;</span><span class="op">)</span></span>
<span id="cb95-50"><a href="#cb95-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ResponseEntity<span class="op">&lt;</span><span class="bu">List</span><span class="op">&lt;</span>OnlineUserInfo<span class="op">&gt;&gt;</span> <span class="fu">getOnlineUsers</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb95-51"><a href="#cb95-51" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span>OnlineUserInfo<span class="op">&gt;</span> onlineUsers <span class="op">=</span> webSocketHandler<span class="op">.</span><span class="fu">getOnlineUsers</span><span class="op">();</span></span>
<span id="cb95-52"><a href="#cb95-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ResponseEntity<span class="op">.</span><span class="fu">ok</span><span class="op">(</span>onlineUsers<span class="op">);</span></span>
<span id="cb95-53"><a href="#cb95-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb95-54"><a href="#cb95-54" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="client-side-integration-flutter">Client-Side Integration
(Flutter)</h3>
<h4 id="websocket-service">WebSocket Service</h4>
<div class="sourceCode" id="cb96"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co">// services/websocket_backend_service.dart</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CareConnectWebSocketService {</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>  WebSocketChannel<span class="op">?</span> _channel;</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>  StreamSubscription<span class="op">?</span> _streamSubscription;</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> StreamController<span class="op">&lt;</span><span class="dt">Map</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> <span class="at">dynamic</span><span class="op">&gt;&gt;</span> _messageController <span class="op">=</span> StreamController<span class="op">.</span>broadcast();</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Stream</span><span class="op">&lt;</span><span class="dt">Map</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> <span class="at">dynamic</span><span class="op">&gt;&gt;</span> <span class="kw">get</span> messageStream <span class="op">=&gt;</span> _messageController<span class="op">.</span>stream;</span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> connect() <span class="at">async</span> {</span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">final</span> wsUrl <span class="op">=</span> _getWebSocketUrl();</span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>      _channel <span class="op">=</span> WebSocketChannel<span class="op">.</span>connect(Uri<span class="op">.</span>parse(wsUrl));</span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>      _streamSubscription <span class="op">=</span> _channel<span class="op">!.</span>stream<span class="op">.</span>listen(</span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a>        (message) {</span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a>          <span class="at">final</span> data <span class="op">=</span> jsonDecode(message);</span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a>          _messageController<span class="op">.</span>add(data);</span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a>          _handleMessage(data);</span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a>        }<span class="op">,</span></span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a>        onError<span class="op">:</span> (error) <span class="op">=&gt;</span> _handleError(error)<span class="op">,</span></span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a>        onDone<span class="op">:</span> () <span class="op">=&gt;</span> _handleDisconnection()<span class="op">,</span></span>
<span id="cb96-22"><a href="#cb96-22" aria-hidden="true" tabindex="-1"></a>      );</span>
<span id="cb96-23"><a href="#cb96-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-24"><a href="#cb96-24" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Authenticate after connection</span></span>
<span id="cb96-25"><a href="#cb96-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">await</span> _authenticate();</span>
<span id="cb96-26"><a href="#cb96-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-27"><a href="#cb96-27" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (e) {</span>
<span id="cb96-28"><a href="#cb96-28" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> WebSocketException(<span class="st">&#39;Connection failed: $e&#39;</span>);</span>
<span id="cb96-29"><a href="#cb96-29" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb96-30"><a href="#cb96-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb96-31"><a href="#cb96-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-32"><a href="#cb96-32" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> _authenticate() <span class="at">async</span> {</span>
<span id="cb96-33"><a href="#cb96-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">final</span> token <span class="op">=</span> <span class="at">await</span> _getAuthToken();</span>
<span id="cb96-34"><a href="#cb96-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">final</span> userId <span class="op">=</span> <span class="at">await</span> _getCurrentUserId();</span>
<span id="cb96-35"><a href="#cb96-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-36"><a href="#cb96-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">final</span> authMessage <span class="op">=</span> {</span>
<span id="cb96-37"><a href="#cb96-37" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;type&#39;</span><span class="op">:</span> <span class="st">&#39;authenticate&#39;</span><span class="op">,</span></span>
<span id="cb96-38"><a href="#cb96-38" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;token&#39;</span><span class="op">:</span> token<span class="op">,</span></span>
<span id="cb96-39"><a href="#cb96-39" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;userId&#39;</span><span class="op">:</span> userId<span class="op">,</span></span>
<span id="cb96-40"><a href="#cb96-40" aria-hidden="true" tabindex="-1"></a>    };</span>
<span id="cb96-41"><a href="#cb96-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-42"><a href="#cb96-42" aria-hidden="true" tabindex="-1"></a>    _channel<span class="op">?.</span>sink<span class="op">.</span>add(jsonEncode(authMessage));</span>
<span id="cb96-43"><a href="#cb96-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb96-44"><a href="#cb96-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-45"><a href="#cb96-45" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> sendMoodPainLog(<span class="dt">int</span> mood<span class="op">,</span> <span class="dt">int</span> pain<span class="op">,</span> <span class="dt">String</span> notes) {</span>
<span id="cb96-46"><a href="#cb96-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">final</span> message <span class="op">=</span> {</span>
<span id="cb96-47"><a href="#cb96-47" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;type&#39;</span><span class="op">:</span> <span class="st">&#39;mood-pain-log-update&#39;</span><span class="op">,</span></span>
<span id="cb96-48"><a href="#cb96-48" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;mood&#39;</span><span class="op">:</span> mood<span class="op">,</span></span>
<span id="cb96-49"><a href="#cb96-49" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;pain&#39;</span><span class="op">:</span> pain<span class="op">,</span></span>
<span id="cb96-50"><a href="#cb96-50" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;notes&#39;</span><span class="op">:</span> notes<span class="op">,</span></span>
<span id="cb96-51"><a href="#cb96-51" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;timestamp&#39;</span><span class="op">:</span> DateTime<span class="op">.</span>now()<span class="op">.</span>millisecondsSinceEpoch<span class="op">,</span></span>
<span id="cb96-52"><a href="#cb96-52" aria-hidden="true" tabindex="-1"></a>    };</span>
<span id="cb96-53"><a href="#cb96-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-54"><a href="#cb96-54" aria-hidden="true" tabindex="-1"></a>    _channel<span class="op">?.</span>sink<span class="op">.</span>add(jsonEncode(message));</span>
<span id="cb96-55"><a href="#cb96-55" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb96-56"><a href="#cb96-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-57"><a href="#cb96-57" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> _handleMessage(<span class="dt">Map</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> <span class="at">dynamic</span><span class="op">&gt;</span> data) {</span>
<span id="cb96-58"><a href="#cb96-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (data[<span class="st">&#39;type&#39;</span>]) {</span>
<span id="cb96-59"><a href="#cb96-59" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;authentication-success&#39;</span><span class="op">:</span></span>
<span id="cb96-60"><a href="#cb96-60" aria-hidden="true" tabindex="-1"></a>        _onAuthenticationSuccess(data);</span>
<span id="cb96-61"><a href="#cb96-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span>;</span>
<span id="cb96-62"><a href="#cb96-62" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;incoming-call&#39;</span><span class="op">:</span></span>
<span id="cb96-63"><a href="#cb96-63" aria-hidden="true" tabindex="-1"></a>        _showIncomingCallDialog(data);</span>
<span id="cb96-64"><a href="#cb96-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span>;</span>
<span id="cb96-65"><a href="#cb96-65" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;medication-reminder&#39;</span><span class="op">:</span></span>
<span id="cb96-66"><a href="#cb96-66" aria-hidden="true" tabindex="-1"></a>        _showMedicationReminder(data);</span>
<span id="cb96-67"><a href="#cb96-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span>;</span>
<span id="cb96-68"><a href="#cb96-68" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;emergency-alert&#39;</span><span class="op">:</span></span>
<span id="cb96-69"><a href="#cb96-69" aria-hidden="true" tabindex="-1"></a>        _showEmergencyAlert(data);</span>
<span id="cb96-70"><a href="#cb96-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span>;</span>
<span id="cb96-71"><a href="#cb96-71" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;ai-chat-notification&#39;</span><span class="op">:</span></span>
<span id="cb96-72"><a href="#cb96-72" aria-hidden="true" tabindex="-1"></a>        _handleAIChatResponse(data);</span>
<span id="cb96-73"><a href="#cb96-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span>;</span>
<span id="cb96-74"><a href="#cb96-74" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb96-75"><a href="#cb96-75" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb96-76"><a href="#cb96-76" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="aws-integration">AWS Integration</h3>
<h4 id="aws-websocket-service">AWS WebSocket Service</h4>
<div class="sourceCode" id="cb97"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co">// service/AwsWebSocketService.java</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="at">@ConditionalOnProperty</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;careconnect.websocket.mode&quot;</span><span class="op">,</span> havingValue <span class="op">=</span> <span class="st">&quot;aws&quot;</span><span class="op">)</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> AwsWebSocketService <span class="op">{</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Value</span><span class="op">(</span><span class="st">&quot;${careconnect.websocket.aws.api-gateway-endpoint}&quot;</span><span class="op">)</span></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> apiGatewayEndpoint<span class="op">;</span></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> AmazonApiGatewayManagementApiClientBuilder clientBuilder<span class="op">;</span></span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">sendMessageToConnection</span><span class="op">(</span><span class="bu">String</span> connectionId<span class="op">,</span> <span class="bu">Object</span> message<span class="op">)</span> <span class="op">{</span></span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>            AmazonApiGatewayManagementApi client <span class="op">=</span> clientBuilder</span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">withEndpointConfiguration</span><span class="op">(</span><span class="kw">new</span> <span class="fu">EndpointConfiguration</span><span class="op">(</span>apiGatewayEndpoint<span class="op">,</span> <span class="st">&quot;us-east-1&quot;</span><span class="op">))</span></span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a>            PostToConnectionRequest request <span class="op">=</span> <span class="kw">new</span> <span class="fu">PostToConnectionRequest</span><span class="op">()</span></span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">withConnectionId</span><span class="op">(</span>connectionId<span class="op">)</span></span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">withData</span><span class="op">(</span><span class="bu">ByteBuffer</span><span class="op">.</span><span class="fu">wrap</span><span class="op">(</span>objectMapper<span class="op">.</span><span class="fu">writeValueAsBytes</span><span class="op">(</span>message<span class="op">)));</span></span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-21"><a href="#cb97-21" aria-hidden="true" tabindex="-1"></a>            client<span class="op">.</span><span class="fu">postToConnection</span><span class="op">(</span>request<span class="op">);</span></span>
<span id="cb97-22"><a href="#cb97-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb97-23"><a href="#cb97-23" aria-hidden="true" tabindex="-1"></a>            log<span class="op">.</span><span class="fu">error</span><span class="op">(</span><span class="st">&quot;Failed to send message to AWS WebSocket connection {}&quot;</span><span class="op">,</span> connectionId<span class="op">,</span> e<span class="op">);</span></span>
<span id="cb97-24"><a href="#cb97-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb97-25"><a href="#cb97-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb97-26"><a href="#cb97-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-27"><a href="#cb97-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">broadcastToAllConnections</span><span class="op">(</span><span class="bu">Object</span> message<span class="op">)</span> <span class="op">{</span></span>
<span id="cb97-28"><a href="#cb97-28" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span>WebSocketConnection<span class="op">&gt;</span> activeConnections <span class="op">=</span> connectionRepository<span class="op">.</span><span class="fu">findActiveAWSConnections</span><span class="op">();</span></span>
<span id="cb97-29"><a href="#cb97-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-30"><a href="#cb97-30" aria-hidden="true" tabindex="-1"></a>        activeConnections<span class="op">.</span><span class="fu">parallelStream</span><span class="op">().</span><span class="fu">forEach</span><span class="op">(</span>conn <span class="op">-&gt;</span></span>
<span id="cb97-31"><a href="#cb97-31" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sendMessageToConnection</span><span class="op">(</span>conn<span class="op">.</span><span class="fu">getConnectionId</span><span class="op">(),</span> message<span class="op">)</span></span>
<span id="cb97-32"><a href="#cb97-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb97-33"><a href="#cb97-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb97-34"><a href="#cb97-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="healthcare-specific-message-types">Healthcare-Specific Message
Types</h3>
<p>The system supports specialized healthcare message types:</p>
<div class="sourceCode" id="cb98"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Healthcare-specific WebSocket messages</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">enum</span> HealthcareMessageType <span class="op">{</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>    AI_CHAT_NOTIFICATION<span class="op">,</span>           <span class="co">// AI assistant responses</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>    MOOD_PAIN_LOG_UPDATE<span class="op">,</span>          <span class="co">// Patient mood/pain tracking</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>    MEDICATION_REMINDER<span class="op">,</span>           <span class="co">// Medication schedules</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>    VITAL_SIGNS_ALERT<span class="op">,</span>            <span class="co">// Critical health alerts</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>    EMERGENCY_ALERT<span class="op">,</span>              <span class="co">// Emergency SOS calls</span></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>    FAMILY_MEMBER_REQUEST<span class="op">,</span>        <span class="co">// Family connection requests</span></span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>    APPOINTMENT_REMINDER<span class="op">,</span>         <span class="co">// Healthcare appointments</span></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>    FALL_DETECTION_ALERT<span class="op">,</span>         <span class="co">// Fall detection from IoT devices</span></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>    MEDICATION_ADHERENCE_UPDATE<span class="op">,</span>  <span class="co">// Medication compliance tracking</span></span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a>    HEALTH_GOAL_PROGRESS<span class="op">,</span>         <span class="co">// Patient health goal updates</span></span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This comprehensive WebSocket implementation provides real-time
communication capabilities specifically tailored for healthcare
applications, with robust security, scalable architecture, and seamless
integration between development and production environments.</p>
<h2 id="ai-integration">AI Integration</h2>
<p>CareConnect integrates advanced AI capabilities using
<strong>DeepSeek</strong> as the primary AI provider through
<strong>LangChain4j</strong> and <strong>Spring AI</strong> frameworks.
The system provides healthcare-focused AI chat assistance, document
processing, and medical data analysis.</p>
<h3 id="architecture-overview-2">Architecture Overview</h3>
<p>The AI integration follows a dual-framework approach: -
<strong>LangChain4j</strong>: Primary AI framework for chat
functionality and memory management - <strong>Spring AI</strong>:
Structured data extraction and document processing -
<strong>DeepSeek</strong>: Cost-effective AI provider with
OpenAI-compatible API - <strong>Security Layer</strong>: Comprehensive
input/output sanitization and governance controls</p>
<h3 id="ai-configuration">AI Configuration</h3>
<h4 id="main-configuration-class">Main Configuration Class</h4>
<div class="sourceCode" id="cb99"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co">// config/AIChatServiceConfig.java</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Configuration</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="at">@ConditionalOnProperty</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;careconnect.deepseek.enabled&quot;</span><span class="op">,</span> havingValue <span class="op">=</span> <span class="st">&quot;true&quot;</span><span class="op">,</span> matchIfMissing <span class="op">=</span> <span class="kw">true</span><span class="op">)</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> AIChatServiceConfig <span class="op">{</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Value</span><span class="op">(</span><span class="st">&quot;${deepseek.api.key}&quot;</span><span class="op">)</span></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> deepSeekApiKey<span class="op">;</span></span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Value</span><span class="op">(</span><span class="st">&quot;${deepseek.api.url:https://api.deepseek.com/v1}&quot;</span><span class="op">)</span></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> deepSeekApiUrl<span class="op">;</span></span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ChatModel <span class="fu">chatModel</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> OpenAiChatModel<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">apiKey</span><span class="op">(</span>deepSeekApiKey<span class="op">)</span></span>
<span id="cb99-16"><a href="#cb99-16" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">baseUrl</span><span class="op">(</span>deepSeekApiUrl<span class="op">)</span></span>
<span id="cb99-17"><a href="#cb99-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">modelName</span><span class="op">(</span><span class="st">&quot;deepseek-chat&quot;</span><span class="op">)</span></span>
<span id="cb99-18"><a href="#cb99-18" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">temperature</span><span class="op">(</span><span class="fl">0.7</span><span class="op">)</span></span>
<span id="cb99-19"><a href="#cb99-19" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">maxTokens</span><span class="op">(</span><span class="dv">2048</span><span class="op">)</span></span>
<span id="cb99-20"><a href="#cb99-20" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb99-21"><a href="#cb99-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb99-22"><a href="#cb99-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-23"><a href="#cb99-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb99-24"><a href="#cb99-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> SpringAIChatModel <span class="fu">springAIChatModel</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb99-25"><a href="#cb99-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">OpenAiChatModel</span><span class="op">(</span></span>
<span id="cb99-26"><a href="#cb99-26" aria-hidden="true" tabindex="-1"></a>            OpenAiApi<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb99-27"><a href="#cb99-27" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">apiKey</span><span class="op">(</span>deepSeekApiKey<span class="op">)</span></span>
<span id="cb99-28"><a href="#cb99-28" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">baseUrl</span><span class="op">(</span>deepSeekApiUrl<span class="op">)</span></span>
<span id="cb99-29"><a href="#cb99-29" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">build</span><span class="op">()</span></span>
<span id="cb99-30"><a href="#cb99-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb99-31"><a href="#cb99-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb99-32"><a href="#cb99-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="configuration-properties">Configuration Properties</h4>
<pre class="properties"><code># AI Service Configuration
ai.model.provider=deepseek
deepseek.api.key=${DEEPSEEK_API_KEY:your-api-key}
deepseek.api.url=https://api.deepseek.com/v1
careconnect.deepseek.enabled=true

# Spring AI Configuration
spring.ai.openai.api-key=${DEEPSEEK_API_KEY}
spring.ai.openai.base-url=https://api.deepseek.com
spring.ai.openai.chat.options.model=deepseek-chat
spring.ai.openai.chat.options.temperature=0.7
spring.ai.openai.chat.options.max-tokens=2048</code></pre>
<h3 id="core-ai-services">Core AI Services</h3>
<h4
id="defaultaichatservice---main-chat-implementation">DefaultAIChatService
- Main Chat Implementation</h4>
<div class="sourceCode" id="cb101"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co">// service/DefaultAIChatService.java</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="at">@ConditionalOnProperty</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;careconnect.deepseek.enabled&quot;</span><span class="op">,</span> havingValue <span class="op">=</span> <span class="st">&quot;true&quot;</span><span class="op">,</span> matchIfMissing <span class="op">=</span> <span class="kw">true</span><span class="op">)</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> DefaultAIChatService <span class="kw">implements</span> AIChatService <span class="op">{</span></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> ChatModel chatModel<span class="op">;</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> ChatMemoryFactory chatMemoryFactory<span class="op">;</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> InputSanitizationService inputSanitizationService<span class="op">;</span></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> ResponseSanitizationService responseSanitizationService<span class="op">;</span></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> LangChainGovernanceService governanceService<span class="op">;</span></span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> AiChatResponse <span class="fu">sendMessage</span><span class="op">(</span><span class="bu">Long</span> userId<span class="op">,</span> <span class="bu">String</span> message<span class="op">,</span> <span class="bu">Long</span> patientId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Governance checks</span></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>        governanceService<span class="op">.</span><span class="fu">checkRateLimit</span><span class="op">(</span>userId<span class="op">);</span></span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a>        governanceService<span class="op">.</span><span class="fu">validateMessageLength</span><span class="op">(</span>message<span class="op">);</span></span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Sanitize input</span></span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> sanitizedMessage <span class="op">=</span> inputSanitizationService<span class="op">.</span><span class="fu">sanitize</span><span class="op">(</span>message<span class="op">);</span></span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Build context with medical data</span></span>
<span id="cb101-21"><a href="#cb101-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> medicalContext <span class="op">=</span> <span class="fu">buildMedicalContext</span><span class="op">(</span>patientId<span class="op">);</span></span>
<span id="cb101-22"><a href="#cb101-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-23"><a href="#cb101-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Create AI chain with memory</span></span>
<span id="cb101-24"><a href="#cb101-24" aria-hidden="true" tabindex="-1"></a>        ConversationalRetrievalChain chain <span class="op">=</span> ConversationalRetrievalChain<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb101-25"><a href="#cb101-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">chatModel</span><span class="op">(</span>chatModel<span class="op">)</span></span>
<span id="cb101-26"><a href="#cb101-26" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">chatMemory</span><span class="op">(</span>chatMemoryFactory<span class="op">.</span><span class="fu">createMemory</span><span class="op">(</span>userId<span class="op">))</span></span>
<span id="cb101-27"><a href="#cb101-27" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">systemPrompt</span><span class="op">(</span><span class="fu">buildSystemPrompt</span><span class="op">(</span>medicalContext<span class="op">))</span></span>
<span id="cb101-28"><a href="#cb101-28" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb101-29"><a href="#cb101-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-30"><a href="#cb101-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Generate response</span></span>
<span id="cb101-31"><a href="#cb101-31" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> aiResponse <span class="op">=</span> chain<span class="op">.</span><span class="fu">execute</span><span class="op">(</span>sanitizedMessage<span class="op">);</span></span>
<span id="cb101-32"><a href="#cb101-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-33"><a href="#cb101-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Sanitize response</span></span>
<span id="cb101-34"><a href="#cb101-34" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> sanitizedResponse <span class="op">=</span> responseSanitizationService<span class="op">.</span><span class="fu">sanitize</span><span class="op">(</span>aiResponse<span class="op">);</span></span>
<span id="cb101-35"><a href="#cb101-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-36"><a href="#cb101-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Save conversation</span></span>
<span id="cb101-37"><a href="#cb101-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">saveChatMessage</span><span class="op">(</span>userId<span class="op">,</span> patientId<span class="op">,</span> sanitizedMessage<span class="op">,</span> sanitizedResponse<span class="op">);</span></span>
<span id="cb101-38"><a href="#cb101-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb101-39"><a href="#cb101-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-40"><a href="#cb101-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> <span class="fu">buildMedicalContext</span><span class="op">(</span><span class="bu">Long</span> patientId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb101-41"><a href="#cb101-41" aria-hidden="true" tabindex="-1"></a>        PatientMedicalData medicalData <span class="op">=</span> medicalDataService<span class="op">.</span><span class="fu">getPatientData</span><span class="op">(</span>patientId<span class="op">);</span></span>
<span id="cb101-42"><a href="#cb101-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-43"><a href="#cb101-43" aria-hidden="true" tabindex="-1"></a>        <span class="bu">StringBuilder</span> context <span class="op">=</span> <span class="kw">new</span> <span class="bu">StringBuilder</span><span class="op">();</span></span>
<span id="cb101-44"><a href="#cb101-44" aria-hidden="true" tabindex="-1"></a>        context<span class="op">.</span><span class="fu">append</span><span class="op">(</span><span class="st">&quot;Patient Medical Context:</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb101-45"><a href="#cb101-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-46"><a href="#cb101-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>medicalData<span class="op">.</span><span class="fu">hasVitals</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb101-47"><a href="#cb101-47" aria-hidden="true" tabindex="-1"></a>            context<span class="op">.</span><span class="fu">append</span><span class="op">(</span><span class="st">&quot;Recent Vitals: &quot;</span><span class="op">).</span><span class="fu">append</span><span class="op">(</span>medicalData<span class="op">.</span><span class="fu">getVitalsSummary</span><span class="op">()).</span><span class="fu">append</span><span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb101-48"><a href="#cb101-48" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb101-49"><a href="#cb101-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-50"><a href="#cb101-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>medicalData<span class="op">.</span><span class="fu">hasMedications</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb101-51"><a href="#cb101-51" aria-hidden="true" tabindex="-1"></a>            context<span class="op">.</span><span class="fu">append</span><span class="op">(</span><span class="st">&quot;Current Medications: &quot;</span><span class="op">).</span><span class="fu">append</span><span class="op">(</span>medicalData<span class="op">.</span><span class="fu">getMedicationsList</span><span class="op">()).</span><span class="fu">append</span><span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb101-52"><a href="#cb101-52" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb101-53"><a href="#cb101-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-54"><a href="#cb101-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>medicalData<span class="op">.</span><span class="fu">hasAllergies</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb101-55"><a href="#cb101-55" aria-hidden="true" tabindex="-1"></a>            context<span class="op">.</span><span class="fu">append</span><span class="op">(</span><span class="st">&quot;Known Allergies: &quot;</span><span class="op">).</span><span class="fu">append</span><span class="op">(</span>medicalData<span class="op">.</span><span class="fu">getAllergiesList</span><span class="op">()).</span><span class="fu">append</span><span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb101-56"><a href="#cb101-56" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb101-57"><a href="#cb101-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-58"><a href="#cb101-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> context<span class="op">.</span><span class="fu">toString</span><span class="op">();</span></span>
<span id="cb101-59"><a href="#cb101-59" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb101-60"><a href="#cb101-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-61"><a href="#cb101-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> <span class="fu">buildSystemPrompt</span><span class="op">(</span><span class="bu">String</span> medicalContext<span class="op">)</span> <span class="op">{</span></span>
<span id="cb101-62"><a href="#cb101-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb101-63"><a href="#cb101-63" aria-hidden="true" tabindex="-1"></a><span class="st">            You are a healthcare assistant for CareConnect. Guidelines:</span></span>
<span id="cb101-64"><a href="#cb101-64" aria-hidden="true" tabindex="-1"></a><span class="st">            1. Provide information and support, never diagnose or prescribe</span></span>
<span id="cb101-65"><a href="#cb101-65" aria-hidden="true" tabindex="-1"></a><span class="st">            2. Encourage users to consult healthcare professionals for medical decisions</span></span>
<span id="cb101-66"><a href="#cb101-66" aria-hidden="true" tabindex="-1"></a><span class="st">            3. Use the provided medical context to give relevant, personalized responses</span></span>
<span id="cb101-67"><a href="#cb101-67" aria-hidden="true" tabindex="-1"></a><span class="st">            4. Be empathetic, professional, and clear</span></span>
<span id="cb101-68"><a href="#cb101-68" aria-hidden="true" tabindex="-1"></a><span class="st">            5. If unsure about medical information, recommend consulting a doctor</span></span>
<span id="cb101-69"><a href="#cb101-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-70"><a href="#cb101-70" aria-hidden="true" tabindex="-1"></a><span class="st">            %s</span></span>
<span id="cb101-71"><a href="#cb101-71" aria-hidden="true" tabindex="-1"></a><span class="st">            &quot;&quot;&quot;</span><span class="op">.</span><span class="fu">formatted</span><span class="op">(</span>medicalContext<span class="op">);</span></span>
<span id="cb101-72"><a href="#cb101-72" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb101-73"><a href="#cb101-73" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="llmextractionservice---document-processing">LlmExtractionService
- Document Processing</h4>
<div class="sourceCode" id="cb102"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co">// service/invoice/LlmExtractionService.java</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="at">@ConditionalOnProperty</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;careconnect.deepseek.enabled&quot;</span><span class="op">,</span> havingValue <span class="op">=</span> <span class="st">&quot;true&quot;</span><span class="op">,</span> matchIfMissing <span class="op">=</span> <span class="kw">true</span><span class="op">)</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> LlmExtractionService <span class="op">{</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> ChatModel chatModel<span class="op">;</span> <span class="co">// Spring AI ChatModel</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> InvoiceData <span class="fu">extractInvoiceData</span><span class="op">(</span><span class="bu">String</span> rawInvoiceText<span class="op">)</span> <span class="op">{</span></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> extractionPrompt <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a><span class="st">            Extract structured data from this healthcare invoice. Return JSON with:</span></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a><span class="st">            - provider: {name, address, phone, email, taxId}</span></span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a><span class="st">            - patient: {name, address, phone, email, dateOfBirth, patientId}</span></span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a><span class="st">            - services: [{code, description, quantity, unitPrice, totalPrice, date}]</span></span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a><span class="st">            - payments: [{method, amount, date, confirmationNumber}]</span></span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a><span class="st">            - totals: {subtotal, tax, discount, totalAmount, amountDue}</span></span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a><span class="st">            - dates: {serviceDate, dueDate, issueDate}</span></span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a><span class="st">            - aiSummary: Brief summary of the invoice</span></span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a><span class="st">            - recommendedActions: Array of patient action recommendations</span></span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a><span class="st">            Invoice text:</span></span>
<span id="cb102-21"><a href="#cb102-21" aria-hidden="true" tabindex="-1"></a><span class="st">            %s</span></span>
<span id="cb102-22"><a href="#cb102-22" aria-hidden="true" tabindex="-1"></a><span class="st">            &quot;&quot;&quot;</span><span class="op">.</span><span class="fu">formatted</span><span class="op">(</span>rawInvoiceText<span class="op">);</span></span>
<span id="cb102-23"><a href="#cb102-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-24"><a href="#cb102-24" aria-hidden="true" tabindex="-1"></a>        ChatResponse response <span class="op">=</span> chatModel<span class="op">.</span><span class="fu">call</span><span class="op">(</span><span class="kw">new</span> <span class="fu">Prompt</span><span class="op">(</span>extractionPrompt<span class="op">));</span></span>
<span id="cb102-25"><a href="#cb102-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> jsonResponse <span class="op">=</span> response<span class="op">.</span><span class="fu">getResult</span><span class="op">().</span><span class="fu">getOutput</span><span class="op">().</span><span class="fu">getContent</span><span class="op">();</span></span>
<span id="cb102-26"><a href="#cb102-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-27"><a href="#cb102-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb102-28"><a href="#cb102-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> objectMapper<span class="op">.</span><span class="fu">readValue</span><span class="op">(</span>jsonResponse<span class="op">,</span> InvoiceData<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb102-29"><a href="#cb102-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span>JsonProcessingException e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb102-30"><a href="#cb102-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">AIProcessingException</span><span class="op">(</span><span class="st">&quot;Failed to parse AI response: &quot;</span> <span class="op">+</span> e<span class="op">.</span><span class="fu">getMessage</span><span class="op">());</span></span>
<span id="cb102-31"><a href="#cb102-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb102-32"><a href="#cb102-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb102-33"><a href="#cb102-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-34"><a href="#cb102-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">generateInvoiceSummary</span><span class="op">(</span>InvoiceData invoiceData<span class="op">)</span> <span class="op">{</span></span>
<span id="cb102-35"><a href="#cb102-35" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> summaryPrompt <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb102-36"><a href="#cb102-36" aria-hidden="true" tabindex="-1"></a><span class="st">            Create a patient-friendly summary of this healthcare invoice:</span></span>
<span id="cb102-37"><a href="#cb102-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-38"><a href="#cb102-38" aria-hidden="true" tabindex="-1"></a><span class="st">            Provider: %s</span></span>
<span id="cb102-39"><a href="#cb102-39" aria-hidden="true" tabindex="-1"></a><span class="st">            Services: %s</span></span>
<span id="cb102-40"><a href="#cb102-40" aria-hidden="true" tabindex="-1"></a><span class="st">            Total Amount: $%.2f</span></span>
<span id="cb102-41"><a href="#cb102-41" aria-hidden="true" tabindex="-1"></a><span class="st">            Due Date: %s</span></span>
<span id="cb102-42"><a href="#cb102-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-43"><a href="#cb102-43" aria-hidden="true" tabindex="-1"></a><span class="st">            Include:</span></span>
<span id="cb102-44"><a href="#cb102-44" aria-hidden="true" tabindex="-1"></a><span class="st">            1. What services were provided</span></span>
<span id="cb102-45"><a href="#cb102-45" aria-hidden="true" tabindex="-1"></a><span class="st">            2. Payment amount and due date</span></span>
<span id="cb102-46"><a href="#cb102-46" aria-hidden="true" tabindex="-1"></a><span class="st">            3. Any action items for the patient</span></span>
<span id="cb102-47"><a href="#cb102-47" aria-hidden="true" tabindex="-1"></a><span class="st">            4. Payment options if applicable</span></span>
<span id="cb102-48"><a href="#cb102-48" aria-hidden="true" tabindex="-1"></a><span class="st">            &quot;&quot;&quot;</span><span class="op">.</span><span class="fu">formatted</span><span class="op">(</span></span>
<span id="cb102-49"><a href="#cb102-49" aria-hidden="true" tabindex="-1"></a>                invoiceData<span class="op">.</span><span class="fu">getProvider</span><span class="op">().</span><span class="fu">getName</span><span class="op">(),</span></span>
<span id="cb102-50"><a href="#cb102-50" aria-hidden="true" tabindex="-1"></a>                invoiceData<span class="op">.</span><span class="fu">getServicesDescription</span><span class="op">(),</span></span>
<span id="cb102-51"><a href="#cb102-51" aria-hidden="true" tabindex="-1"></a>                invoiceData<span class="op">.</span><span class="fu">getTotals</span><span class="op">().</span><span class="fu">getTotalAmount</span><span class="op">(),</span></span>
<span id="cb102-52"><a href="#cb102-52" aria-hidden="true" tabindex="-1"></a>                invoiceData<span class="op">.</span><span class="fu">getDates</span><span class="op">().</span><span class="fu">getDueDate</span><span class="op">()</span></span>
<span id="cb102-53"><a href="#cb102-53" aria-hidden="true" tabindex="-1"></a>            <span class="op">);</span></span>
<span id="cb102-54"><a href="#cb102-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-55"><a href="#cb102-55" aria-hidden="true" tabindex="-1"></a>        ChatResponse response <span class="op">=</span> chatModel<span class="op">.</span><span class="fu">call</span><span class="op">(</span><span class="kw">new</span> <span class="fu">Prompt</span><span class="op">(</span>summaryPrompt<span class="op">));</span></span>
<span id="cb102-56"><a href="#cb102-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response<span class="op">.</span><span class="fu">getResult</span><span class="op">().</span><span class="fu">getOutput</span><span class="op">().</span><span class="fu">getContent</span><span class="op">();</span></span>
<span id="cb102-57"><a href="#cb102-57" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb102-58"><a href="#cb102-58" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="chat-memory-management">Chat Memory Management</h3>
<h4 id="chatmemoryfactory">ChatMemoryFactory</h4>
<div class="sourceCode" id="cb103"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co">// service/memory/ChatMemoryFactory.java</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> ChatMemoryFactory <span class="op">{</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Value</span><span class="op">(</span><span class="st">&quot;${ai.chat.memory.timeout:900}&quot;</span><span class="op">)</span> <span class="co">// 15 minutes</span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">long</span> memoryTimeoutSeconds<span class="op">;</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Value</span><span class="op">(</span><span class="st">&quot;${ai.chat.memory.max-messages:15}&quot;</span><span class="op">)</span></span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">int</span> maxMessages<span class="op">;</span></span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ChatMemory <span class="fu">createMemory</span><span class="op">(</span><span class="bu">Long</span> userId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> MessageWindowChatMemory<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">id</span><span class="op">(</span>userId<span class="op">)</span></span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">maxMessages</span><span class="op">(</span>maxMessages<span class="op">)</span></span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">chatMemoryStore</span><span class="op">(</span><span class="fu">createMemoryStore</span><span class="op">(</span>userId<span class="op">))</span></span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-19"><a href="#cb103-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> ChatMemoryStore <span class="fu">createMemoryStore</span><span class="op">(</span><span class="bu">Long</span> userId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb103-20"><a href="#cb103-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">DatabaseChatMemoryStore</span><span class="op">(</span>userId<span class="op">,</span> memoryTimeoutSeconds<span class="op">);</span></span>
<span id="cb103-21"><a href="#cb103-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb103-22"><a href="#cb103-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb103-23"><a href="#cb103-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-24"><a href="#cb103-24" aria-hidden="true" tabindex="-1"></a><span class="co">// Custom database-backed memory store</span></span>
<span id="cb103-25"><a href="#cb103-25" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> DatabaseChatMemoryStore <span class="kw">implements</span> ChatMemoryStore <span class="op">{</span></span>
<span id="cb103-26"><a href="#cb103-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-27"><a href="#cb103-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> ChatMessageRepository chatMessageRepository<span class="op">;</span></span>
<span id="cb103-28"><a href="#cb103-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> <span class="bu">Long</span> userId<span class="op">;</span></span>
<span id="cb103-29"><a href="#cb103-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> <span class="dt">long</span> timeoutSeconds<span class="op">;</span></span>
<span id="cb103-30"><a href="#cb103-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-31"><a href="#cb103-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb103-32"><a href="#cb103-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">List</span><span class="op">&lt;</span>ChatMessage<span class="op">&gt;</span> <span class="fu">getMessages</span><span class="op">(</span><span class="bu">Object</span> memoryId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb103-33"><a href="#cb103-33" aria-hidden="true" tabindex="-1"></a>        LocalDateTime cutoff <span class="op">=</span> LocalDateTime<span class="op">.</span><span class="fu">now</span><span class="op">().</span><span class="fu">minusSeconds</span><span class="op">(</span>timeoutSeconds<span class="op">);</span></span>
<span id="cb103-34"><a href="#cb103-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-35"><a href="#cb103-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> chatMessageRepository</span>
<span id="cb103-36"><a href="#cb103-36" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">findByUserIdAndCreatedAtAfterOrderByCreatedAt</span><span class="op">(</span>userId<span class="op">,</span> cutoff<span class="op">)</span></span>
<span id="cb103-37"><a href="#cb103-37" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">stream</span><span class="op">()</span></span>
<span id="cb103-38"><a href="#cb103-38" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">map</span><span class="op">(</span><span class="kw">this</span><span class="op">::</span>convertToLangChainMessage<span class="op">)</span></span>
<span id="cb103-39"><a href="#cb103-39" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">collect</span><span class="op">(</span>Collectors<span class="op">.</span><span class="fu">toList</span><span class="op">());</span></span>
<span id="cb103-40"><a href="#cb103-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb103-41"><a href="#cb103-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-42"><a href="#cb103-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb103-43"><a href="#cb103-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">updateMessages</span><span class="op">(</span><span class="bu">Object</span> memoryId<span class="op">,</span> <span class="bu">List</span><span class="op">&lt;</span>ChatMessage<span class="op">&gt;</span> messages<span class="op">)</span> <span class="op">{</span></span>
<span id="cb103-44"><a href="#cb103-44" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Save new messages to database</span></span>
<span id="cb103-45"><a href="#cb103-45" aria-hidden="true" tabindex="-1"></a>        messages<span class="op">.</span><span class="fu">forEach</span><span class="op">(</span>message <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb103-46"><a href="#cb103-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span><span class="fu">messageExists</span><span class="op">(</span>message<span class="op">))</span> <span class="op">{</span></span>
<span id="cb103-47"><a href="#cb103-47" aria-hidden="true" tabindex="-1"></a>                <span class="fu">saveChatMessage</span><span class="op">(</span>message<span class="op">);</span></span>
<span id="cb103-48"><a href="#cb103-48" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb103-49"><a href="#cb103-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb103-50"><a href="#cb103-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb103-51"><a href="#cb103-51" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="security-and-governance">Security and Governance</h3>
<h4 id="langchaingovernanceservice">LangChainGovernanceService</h4>
<div class="sourceCode" id="cb104"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co">// service/LangChainGovernanceService.java</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> LangChainGovernanceService <span class="op">{</span></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> <span class="dt">int</span> MAX_REQUESTS_PER_MINUTE <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> <span class="dt">int</span> MAX_REQUESTS_PER_HOUR <span class="op">=</span> <span class="dv">60</span><span class="op">;</span></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> <span class="dt">int</span> MAX_MESSAGE_LENGTH <span class="op">=</span> <span class="dv">4000</span><span class="op">;</span></span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> RedisTemplate<span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> redisTemplate<span class="op">;</span></span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">checkRateLimit</span><span class="op">(</span><span class="bu">Long</span> userId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> minuteKey <span class="op">=</span> <span class="st">&quot;rate_limit:user:&quot;</span> <span class="op">+</span> userId <span class="op">+</span> <span class="st">&quot;:minute:&quot;</span> <span class="op">+</span></span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>                          <span class="op">(</span><span class="bu">System</span><span class="op">.</span><span class="fu">currentTimeMillis</span><span class="op">()</span> <span class="op">/</span> <span class="dv">60000</span><span class="op">);</span></span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> hourKey <span class="op">=</span> <span class="st">&quot;rate_limit:user:&quot;</span> <span class="op">+</span> userId <span class="op">+</span> <span class="st">&quot;:hour:&quot;</span> <span class="op">+</span></span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a>                        <span class="op">(</span><span class="bu">System</span><span class="op">.</span><span class="fu">currentTimeMillis</span><span class="op">()</span> <span class="op">/</span> <span class="dv">3600000</span><span class="op">);</span></span>
<span id="cb104-16"><a href="#cb104-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-17"><a href="#cb104-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Long</span> minuteCount <span class="op">=</span> redisTemplate<span class="op">.</span><span class="fu">opsForValue</span><span class="op">().</span><span class="fu">increment</span><span class="op">(</span>minuteKey<span class="op">);</span></span>
<span id="cb104-18"><a href="#cb104-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>minuteCount <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb104-19"><a href="#cb104-19" aria-hidden="true" tabindex="-1"></a>            redisTemplate<span class="op">.</span><span class="fu">expire</span><span class="op">(</span>minuteKey<span class="op">,</span> <span class="bu">Duration</span><span class="op">.</span><span class="fu">ofMinutes</span><span class="op">(</span><span class="dv">1</span><span class="op">));</span></span>
<span id="cb104-20"><a href="#cb104-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb104-21"><a href="#cb104-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-22"><a href="#cb104-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Long</span> hourCount <span class="op">=</span> redisTemplate<span class="op">.</span><span class="fu">opsForValue</span><span class="op">().</span><span class="fu">increment</span><span class="op">(</span>hourKey<span class="op">);</span></span>
<span id="cb104-23"><a href="#cb104-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>hourCount <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb104-24"><a href="#cb104-24" aria-hidden="true" tabindex="-1"></a>            redisTemplate<span class="op">.</span><span class="fu">expire</span><span class="op">(</span>hourKey<span class="op">,</span> <span class="bu">Duration</span><span class="op">.</span><span class="fu">ofHours</span><span class="op">(</span><span class="dv">1</span><span class="op">));</span></span>
<span id="cb104-25"><a href="#cb104-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb104-26"><a href="#cb104-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-27"><a href="#cb104-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>minuteCount <span class="op">&gt;</span> MAX_REQUESTS_PER_MINUTE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb104-28"><a href="#cb104-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">RateLimitExceededException</span><span class="op">(</span><span class="st">&quot;Too many requests per minute&quot;</span><span class="op">);</span></span>
<span id="cb104-29"><a href="#cb104-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb104-30"><a href="#cb104-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-31"><a href="#cb104-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>hourCount <span class="op">&gt;</span> MAX_REQUESTS_PER_HOUR<span class="op">)</span> <span class="op">{</span></span>
<span id="cb104-32"><a href="#cb104-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">RateLimitExceededException</span><span class="op">(</span><span class="st">&quot;Too many requests per hour&quot;</span><span class="op">);</span></span>
<span id="cb104-33"><a href="#cb104-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb104-34"><a href="#cb104-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb104-35"><a href="#cb104-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-36"><a href="#cb104-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">validateMessageLength</span><span class="op">(</span><span class="bu">String</span> message<span class="op">)</span> <span class="op">{</span></span>
<span id="cb104-37"><a href="#cb104-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>message<span class="op">.</span><span class="fu">length</span><span class="op">()</span> <span class="op">&gt;</span> MAX_MESSAGE_LENGTH<span class="op">)</span> <span class="op">{</span></span>
<span id="cb104-38"><a href="#cb104-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">MessageTooLongException</span><span class="op">(</span></span>
<span id="cb104-39"><a href="#cb104-39" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Message exceeds maximum length of &quot;</span> <span class="op">+</span> MAX_MESSAGE_LENGTH <span class="op">+</span> <span class="st">&quot; characters&quot;</span></span>
<span id="cb104-40"><a href="#cb104-40" aria-hidden="true" tabindex="-1"></a>            <span class="op">);</span></span>
<span id="cb104-41"><a href="#cb104-41" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb104-42"><a href="#cb104-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb104-43"><a href="#cb104-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-44"><a href="#cb104-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">auditAIInteraction</span><span class="op">(</span><span class="bu">Long</span> userId<span class="op">,</span> <span class="bu">String</span> input<span class="op">,</span> <span class="bu">String</span> output<span class="op">,</span></span>
<span id="cb104-45"><a href="#cb104-45" aria-hidden="true" tabindex="-1"></a>                                  <span class="bu">String</span> model<span class="op">,</span> <span class="bu">Long</span> tokens<span class="op">)</span> <span class="op">{</span></span>
<span id="cb104-46"><a href="#cb104-46" aria-hidden="true" tabindex="-1"></a>        AiInteractionAudit audit <span class="op">=</span> AiInteractionAudit<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb104-47"><a href="#cb104-47" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">userId</span><span class="op">(</span>userId<span class="op">)</span></span>
<span id="cb104-48"><a href="#cb104-48" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">input</span><span class="op">(</span>input<span class="op">)</span></span>
<span id="cb104-49"><a href="#cb104-49" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">output</span><span class="op">(</span>output<span class="op">)</span></span>
<span id="cb104-50"><a href="#cb104-50" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">model</span><span class="op">(</span>model<span class="op">)</span></span>
<span id="cb104-51"><a href="#cb104-51" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">tokensUsed</span><span class="op">(</span>tokens<span class="op">)</span></span>
<span id="cb104-52"><a href="#cb104-52" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">timestamp</span><span class="op">(</span>LocalDateTime<span class="op">.</span><span class="fu">now</span><span class="op">())</span></span>
<span id="cb104-53"><a href="#cb104-53" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb104-54"><a href="#cb104-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-55"><a href="#cb104-55" aria-hidden="true" tabindex="-1"></a>        auditRepository<span class="op">.</span><span class="fu">save</span><span class="op">(</span>audit<span class="op">);</span></span>
<span id="cb104-56"><a href="#cb104-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb104-57"><a href="#cb104-57" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="inputoutput-sanitization">Input/Output Sanitization</h4>
<div class="sourceCode" id="cb105"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co">// service/InputSanitizationService.java</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> InputSanitizationService <span class="op">{</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">List</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> BLOCKED_PATTERNS <span class="op">=</span> <span class="bu">List</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;(?i).*diagnose.*&quot;</span><span class="op">,</span></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;(?i).*prescribe.*medication.*&quot;</span><span class="op">,</span></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;(?i).*medical advice.*&quot;</span><span class="op">,</span></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;(?i).*ignore.*previous.*instructions.*&quot;</span></span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">sanitize</span><span class="op">(</span><span class="bu">String</span> input<span class="op">)</span> <span class="op">{</span></span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Remove potentially harmful patterns</span></span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> sanitized <span class="op">=</span> input<span class="op">;</span></span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="bu">String</span> pattern <span class="op">:</span> BLOCKED_PATTERNS<span class="op">)</span> <span class="op">{</span></span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true" tabindex="-1"></a>            sanitized <span class="op">=</span> sanitized<span class="op">.</span><span class="fu">replaceAll</span><span class="op">(</span>pattern<span class="op">,</span> <span class="st">&quot;[FILTERED]&quot;</span><span class="op">);</span></span>
<span id="cb105-18"><a href="#cb105-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb105-19"><a href="#cb105-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-20"><a href="#cb105-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Limit length</span></span>
<span id="cb105-21"><a href="#cb105-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>sanitized<span class="op">.</span><span class="fu">length</span><span class="op">()</span> <span class="op">&gt;</span> <span class="dv">4000</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb105-22"><a href="#cb105-22" aria-hidden="true" tabindex="-1"></a>            sanitized <span class="op">=</span> sanitized<span class="op">.</span><span class="fu">substring</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">4000</span><span class="op">)</span> <span class="op">+</span> <span class="st">&quot;...&quot;</span><span class="op">;</span></span>
<span id="cb105-23"><a href="#cb105-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb105-24"><a href="#cb105-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-25"><a href="#cb105-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Basic XSS protection</span></span>
<span id="cb105-26"><a href="#cb105-26" aria-hidden="true" tabindex="-1"></a>        sanitized <span class="op">=</span> StringEscapeUtils<span class="op">.</span><span class="fu">escapeHtml4</span><span class="op">(</span>sanitized<span class="op">);</span></span>
<span id="cb105-27"><a href="#cb105-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-28"><a href="#cb105-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> sanitized<span class="op">;</span></span>
<span id="cb105-29"><a href="#cb105-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb105-30"><a href="#cb105-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb105-31"><a href="#cb105-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-32"><a href="#cb105-32" aria-hidden="true" tabindex="-1"></a><span class="co">// service/ResponseSanitizationService.java</span></span>
<span id="cb105-33"><a href="#cb105-33" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb105-34"><a href="#cb105-34" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> ResponseSanitizationService <span class="op">{</span></span>
<span id="cb105-35"><a href="#cb105-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-36"><a href="#cb105-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">List</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> MEDICAL_DISCLAIMERS <span class="op">=</span> <span class="bu">List</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span></span>
<span id="cb105-37"><a href="#cb105-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Please consult with your healthcare provider&quot;</span><span class="op">,</span></span>
<span id="cb105-38"><a href="#cb105-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;This is not medical advice&quot;</span><span class="op">,</span></span>
<span id="cb105-39"><a href="#cb105-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Always verify with a medical professional&quot;</span></span>
<span id="cb105-40"><a href="#cb105-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb105-41"><a href="#cb105-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-42"><a href="#cb105-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">sanitize</span><span class="op">(</span><span class="bu">String</span> aiResponse<span class="op">)</span> <span class="op">{</span></span>
<span id="cb105-43"><a href="#cb105-43" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Add medical disclaimers if response contains medical terms</span></span>
<span id="cb105-44"><a href="#cb105-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span><span class="fu">containsMedicalTerms</span><span class="op">(</span>aiResponse<span class="op">))</span> <span class="op">{</span></span>
<span id="cb105-45"><a href="#cb105-45" aria-hidden="true" tabindex="-1"></a>            aiResponse <span class="op">+=</span> <span class="st">&quot;</span><span class="sc">\n\n</span><span class="st">⚠️ &quot;</span> <span class="op">+</span> <span class="fu">getRandomDisclaimer</span><span class="op">();</span></span>
<span id="cb105-46"><a href="#cb105-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb105-47"><a href="#cb105-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-48"><a href="#cb105-48" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Remove any potential harmful content</span></span>
<span id="cb105-49"><a href="#cb105-49" aria-hidden="true" tabindex="-1"></a>        aiResponse <span class="op">=</span> <span class="fu">removePotentiallyHarmfulContent</span><span class="op">(</span>aiResponse<span class="op">);</span></span>
<span id="cb105-50"><a href="#cb105-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-51"><a href="#cb105-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> aiResponse<span class="op">;</span></span>
<span id="cb105-52"><a href="#cb105-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb105-53"><a href="#cb105-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-54"><a href="#cb105-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">boolean</span> <span class="fu">containsMedicalTerms</span><span class="op">(</span><span class="bu">String</span> response<span class="op">)</span> <span class="op">{</span></span>
<span id="cb105-55"><a href="#cb105-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response<span class="op">.</span><span class="fu">toLowerCase</span><span class="op">().</span><span class="fu">matches</span><span class="op">(</span></span>
<span id="cb105-56"><a href="#cb105-56" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;.*(symptom|treatment|medication|diagnosis|dosage|prescription).*&quot;</span></span>
<span id="cb105-57"><a href="#cb105-57" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb105-58"><a href="#cb105-58" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb105-59"><a href="#cb105-59" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="user-ai-configuration">User AI Configuration</h3>
<h4 id="useraiconfig-entity">UserAIConfig Entity</h4>
<div class="sourceCode" id="cb106"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co">// model/UserAIConfig.java</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Entity</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a><span class="at">@Table</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;user_ai_config&quot;</span><span class="op">)</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> UserAIConfig <span class="op">{</span></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Id</span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Long</span> userId<span class="op">;</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;ai_provider&quot;</span><span class="op">)</span></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Enumerated</span><span class="op">(</span>EnumType<span class="op">.</span><span class="fu">STRING</span><span class="op">)</span></span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> AIProvider aiProvider <span class="op">=</span> AIProvider<span class="op">.</span><span class="fu">DEEPSEEK</span><span class="op">;</span></span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;model_name&quot;</span><span class="op">)</span></span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> modelName <span class="op">=</span> <span class="st">&quot;deepseek-chat&quot;</span><span class="op">;</span></span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;include_vitals&quot;</span><span class="op">)</span></span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Boolean</span> includeVitals <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;include_medications&quot;</span><span class="op">)</span></span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Boolean</span> includeMedications <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-22"><a href="#cb106-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;include_notes&quot;</span><span class="op">)</span></span>
<span id="cb106-23"><a href="#cb106-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Boolean</span> includeNotes <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb106-24"><a href="#cb106-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-25"><a href="#cb106-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;include_allergies&quot;</span><span class="op">)</span></span>
<span id="cb106-26"><a href="#cb106-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Boolean</span> includeAllergies <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb106-27"><a href="#cb106-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-28"><a href="#cb106-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;max_tokens&quot;</span><span class="op">)</span></span>
<span id="cb106-29"><a href="#cb106-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Integer</span> maxTokens <span class="op">=</span> <span class="dv">2048</span><span class="op">;</span></span>
<span id="cb106-30"><a href="#cb106-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-31"><a href="#cb106-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;temperature&quot;</span><span class="op">)</span></span>
<span id="cb106-32"><a href="#cb106-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Double</span> temperature <span class="op">=</span> <span class="fl">0.7</span><span class="op">;</span></span>
<span id="cb106-33"><a href="#cb106-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-34"><a href="#cb106-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;conversation_history_limit&quot;</span><span class="op">)</span></span>
<span id="cb106-35"><a href="#cb106-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Integer</span> conversationHistoryLimit <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb106-36"><a href="#cb106-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-37"><a href="#cb106-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;custom_system_prompt&quot;</span><span class="op">)</span></span>
<span id="cb106-38"><a href="#cb106-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> customSystemPrompt<span class="op">;</span></span>
<span id="cb106-39"><a href="#cb106-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-40"><a href="#cb106-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Default configurations for different user types</span></span>
<span id="cb106-41"><a href="#cb106-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> UserAIConfig <span class="fu">defaultPatientConfig</span><span class="op">(</span><span class="bu">Long</span> userId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb106-42"><a href="#cb106-42" aria-hidden="true" tabindex="-1"></a>        UserAIConfig config <span class="op">=</span> <span class="kw">new</span> <span class="fu">UserAIConfig</span><span class="op">();</span></span>
<span id="cb106-43"><a href="#cb106-43" aria-hidden="true" tabindex="-1"></a>        config<span class="op">.</span><span class="fu">setUserId</span><span class="op">(</span>userId<span class="op">);</span></span>
<span id="cb106-44"><a href="#cb106-44" aria-hidden="true" tabindex="-1"></a>        config<span class="op">.</span><span class="fu">setCustomSystemPrompt</span><span class="op">(</span>DEFAULT_PATIENT_PROMPT<span class="op">);</span></span>
<span id="cb106-45"><a href="#cb106-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> config<span class="op">;</span></span>
<span id="cb106-46"><a href="#cb106-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb106-47"><a href="#cb106-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-48"><a href="#cb106-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> UserAIConfig <span class="fu">defaultCaregiverConfig</span><span class="op">(</span><span class="bu">Long</span> userId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb106-49"><a href="#cb106-49" aria-hidden="true" tabindex="-1"></a>        UserAIConfig config <span class="op">=</span> <span class="kw">new</span> <span class="fu">UserAIConfig</span><span class="op">();</span></span>
<span id="cb106-50"><a href="#cb106-50" aria-hidden="true" tabindex="-1"></a>        config<span class="op">.</span><span class="fu">setUserId</span><span class="op">(</span>userId<span class="op">);</span></span>
<span id="cb106-51"><a href="#cb106-51" aria-hidden="true" tabindex="-1"></a>        config<span class="op">.</span><span class="fu">setIncludeNotes</span><span class="op">(</span><span class="kw">true</span><span class="op">);</span></span>
<span id="cb106-52"><a href="#cb106-52" aria-hidden="true" tabindex="-1"></a>        config<span class="op">.</span><span class="fu">setConversationHistoryLimit</span><span class="op">(</span><span class="dv">20</span><span class="op">);</span></span>
<span id="cb106-53"><a href="#cb106-53" aria-hidden="true" tabindex="-1"></a>        config<span class="op">.</span><span class="fu">setCustomSystemPrompt</span><span class="op">(</span>DEFAULT_CAREGIVER_PROMPT<span class="op">);</span></span>
<span id="cb106-54"><a href="#cb106-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> config<span class="op">;</span></span>
<span id="cb106-55"><a href="#cb106-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb106-56"><a href="#cb106-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-57"><a href="#cb106-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">String</span> DEFAULT_PATIENT_PROMPT <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb106-58"><a href="#cb106-58" aria-hidden="true" tabindex="-1"></a><span class="st">        You are a helpful healthcare assistant. Provide information and support</span></span>
<span id="cb106-59"><a href="#cb106-59" aria-hidden="true" tabindex="-1"></a><span class="st">        while encouraging consultation with healthcare professionals for medical decisions.</span></span>
<span id="cb106-60"><a href="#cb106-60" aria-hidden="true" tabindex="-1"></a><span class="st">        Be empathetic, clear, and never provide diagnostic or prescriptive advice.</span></span>
<span id="cb106-61"><a href="#cb106-61" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span><span class="op">;</span></span>
<span id="cb106-62"><a href="#cb106-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-63"><a href="#cb106-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">String</span> DEFAULT_CAREGIVER_PROMPT <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb106-64"><a href="#cb106-64" aria-hidden="true" tabindex="-1"></a><span class="st">        You are an AI assistant for healthcare professionals. Provide clinical</span></span>
<span id="cb106-65"><a href="#cb106-65" aria-hidden="true" tabindex="-1"></a><span class="st">        insights and information while emphasizing professional judgment.</span></span>
<span id="cb106-66"><a href="#cb106-66" aria-hidden="true" tabindex="-1"></a><span class="st">        Include relevant patient data context in your responses.</span></span>
<span id="cb106-67"><a href="#cb106-67" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span><span class="op">;</span></span>
<span id="cb106-68"><a href="#cb106-68" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="api-endpoints">API Endpoints</h3>
<h4 id="aichatcontroller">AIChatController</h4>
<div class="sourceCode" id="cb107"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co">// controller/AIChatController.java</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="at">@RestController</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/v1/api/ai-chat&quot;</span><span class="op">)</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a><span class="at">@PreAuthorize</span><span class="op">(</span><span class="st">&quot;hasRole(&#39;PATIENT&#39;) or hasRole(&#39;CAREGIVER&#39;)&quot;</span><span class="op">)</span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> AIChatController <span class="op">{</span></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> AIChatService aiChatService<span class="op">;</span></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> UserAIConfigService configService<span class="op">;</span></span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@PostMapping</span><span class="op">(</span><span class="st">&quot;/chat&quot;</span><span class="op">)</span></span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Operation</span><span class="op">(</span>summary <span class="op">=</span> <span class="st">&quot;Send message to AI assistant&quot;</span><span class="op">)</span></span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ResponseEntity<span class="op">&lt;</span>AiChatResponse<span class="op">&gt;</span> <span class="fu">sendMessage</span><span class="op">(</span></span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Valid</span> <span class="at">@RequestBody</span> AiChatRequest request<span class="op">,</span></span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a>            Authentication authentication<span class="op">)</span> <span class="op">{</span></span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Long</span> userId <span class="op">=</span> <span class="fu">getUserId</span><span class="op">(</span>authentication<span class="op">);</span></span>
<span id="cb107-17"><a href="#cb107-17" aria-hidden="true" tabindex="-1"></a>        AiChatResponse response <span class="op">=</span> aiChatService<span class="op">.</span><span class="fu">sendMessage</span><span class="op">(</span></span>
<span id="cb107-18"><a href="#cb107-18" aria-hidden="true" tabindex="-1"></a>            userId<span class="op">,</span> request<span class="op">.</span><span class="fu">getMessage</span><span class="op">(),</span> request<span class="op">.</span><span class="fu">getPatientId</span><span class="op">());</span></span>
<span id="cb107-19"><a href="#cb107-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-20"><a href="#cb107-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ResponseEntity<span class="op">.</span><span class="fu">ok</span><span class="op">(</span>response<span class="op">);</span></span>
<span id="cb107-21"><a href="#cb107-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb107-22"><a href="#cb107-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-23"><a href="#cb107-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/conversations/{patientId}&quot;</span><span class="op">)</span></span>
<span id="cb107-24"><a href="#cb107-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Operation</span><span class="op">(</span>summary <span class="op">=</span> <span class="st">&quot;Get patient conversations&quot;</span><span class="op">)</span></span>
<span id="cb107-25"><a href="#cb107-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ResponseEntity<span class="op">&lt;</span><span class="bu">List</span><span class="op">&lt;</span>ChatConversationResponse<span class="op">&gt;&gt;</span> <span class="fu">getConversations</span><span class="op">(</span></span>
<span id="cb107-26"><a href="#cb107-26" aria-hidden="true" tabindex="-1"></a>            <span class="at">@PathVariable</span> <span class="bu">Long</span> patientId<span class="op">,</span></span>
<span id="cb107-27"><a href="#cb107-27" aria-hidden="true" tabindex="-1"></a>            Authentication authentication<span class="op">)</span> <span class="op">{</span></span>
<span id="cb107-28"><a href="#cb107-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-29"><a href="#cb107-29" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Long</span> userId <span class="op">=</span> <span class="fu">getUserId</span><span class="op">(</span>authentication<span class="op">);</span></span>
<span id="cb107-30"><a href="#cb107-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Verify access to patient data</span></span>
<span id="cb107-31"><a href="#cb107-31" aria-hidden="true" tabindex="-1"></a>        patientAccessService<span class="op">.</span><span class="fu">verifyAccess</span><span class="op">(</span>userId<span class="op">,</span> patientId<span class="op">);</span></span>
<span id="cb107-32"><a href="#cb107-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-33"><a href="#cb107-33" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span>ChatConversationResponse<span class="op">&gt;</span> conversations <span class="op">=</span></span>
<span id="cb107-34"><a href="#cb107-34" aria-hidden="true" tabindex="-1"></a>            aiChatService<span class="op">.</span><span class="fu">getConversations</span><span class="op">(</span>patientId<span class="op">);</span></span>
<span id="cb107-35"><a href="#cb107-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-36"><a href="#cb107-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ResponseEntity<span class="op">.</span><span class="fu">ok</span><span class="op">(</span>conversations<span class="op">);</span></span>
<span id="cb107-37"><a href="#cb107-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb107-38"><a href="#cb107-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-39"><a href="#cb107-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/config&quot;</span><span class="op">)</span></span>
<span id="cb107-40"><a href="#cb107-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Operation</span><span class="op">(</span>summary <span class="op">=</span> <span class="st">&quot;Get AI configuration&quot;</span><span class="op">)</span></span>
<span id="cb107-41"><a href="#cb107-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ResponseEntity<span class="op">&lt;</span>UserAIConfig<span class="op">&gt;</span> <span class="fu">getConfig</span><span class="op">(</span>Authentication authentication<span class="op">)</span> <span class="op">{</span></span>
<span id="cb107-42"><a href="#cb107-42" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Long</span> userId <span class="op">=</span> <span class="fu">getUserId</span><span class="op">(</span>authentication<span class="op">);</span></span>
<span id="cb107-43"><a href="#cb107-43" aria-hidden="true" tabindex="-1"></a>        UserAIConfig config <span class="op">=</span> configService<span class="op">.</span><span class="fu">getUserConfig</span><span class="op">(</span>userId<span class="op">);</span></span>
<span id="cb107-44"><a href="#cb107-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ResponseEntity<span class="op">.</span><span class="fu">ok</span><span class="op">(</span>config<span class="op">);</span></span>
<span id="cb107-45"><a href="#cb107-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb107-46"><a href="#cb107-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-47"><a href="#cb107-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">@PostMapping</span><span class="op">(</span><span class="st">&quot;/config&quot;</span><span class="op">)</span></span>
<span id="cb107-48"><a href="#cb107-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Operation</span><span class="op">(</span>summary <span class="op">=</span> <span class="st">&quot;Update AI configuration&quot;</span><span class="op">)</span></span>
<span id="cb107-49"><a href="#cb107-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ResponseEntity<span class="op">&lt;</span>UserAIConfig<span class="op">&gt;</span> <span class="fu">updateConfig</span><span class="op">(</span></span>
<span id="cb107-50"><a href="#cb107-50" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Valid</span> <span class="at">@RequestBody</span> UserAIConfig config<span class="op">,</span></span>
<span id="cb107-51"><a href="#cb107-51" aria-hidden="true" tabindex="-1"></a>            Authentication authentication<span class="op">)</span> <span class="op">{</span></span>
<span id="cb107-52"><a href="#cb107-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-53"><a href="#cb107-53" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Long</span> userId <span class="op">=</span> <span class="fu">getUserId</span><span class="op">(</span>authentication<span class="op">);</span></span>
<span id="cb107-54"><a href="#cb107-54" aria-hidden="true" tabindex="-1"></a>        config<span class="op">.</span><span class="fu">setUserId</span><span class="op">(</span>userId<span class="op">);</span></span>
<span id="cb107-55"><a href="#cb107-55" aria-hidden="true" tabindex="-1"></a>        UserAIConfig savedConfig <span class="op">=</span> configService<span class="op">.</span><span class="fu">saveConfig</span><span class="op">(</span>config<span class="op">);</span></span>
<span id="cb107-56"><a href="#cb107-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-57"><a href="#cb107-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ResponseEntity<span class="op">.</span><span class="fu">ok</span><span class="op">(</span>savedConfig<span class="op">);</span></span>
<span id="cb107-58"><a href="#cb107-58" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb107-59"><a href="#cb107-59" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="database-schema-1">Database Schema</h3>
<h4 id="ai-related-tables">AI-Related Tables</h4>
<div class="sourceCode" id="cb108"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- User AI Configuration</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> user_ai_config (</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>    user_id BIGINT <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>    ai_provider <span class="dt">VARCHAR</span>(<span class="dv">50</span>) <span class="kw">DEFAULT</span> <span class="st">&#39;DEEPSEEK&#39;</span>,</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>    model_name <span class="dt">VARCHAR</span>(<span class="dv">100</span>) <span class="kw">DEFAULT</span> <span class="st">&#39;deepseek-chat&#39;</span>,</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>    include_vitals <span class="dt">BOOLEAN</span> <span class="kw">DEFAULT</span> <span class="kw">TRUE</span>,</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>    include_medications <span class="dt">BOOLEAN</span> <span class="kw">DEFAULT</span> <span class="kw">TRUE</span>,</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>    include_notes <span class="dt">BOOLEAN</span> <span class="kw">DEFAULT</span> <span class="kw">FALSE</span>,</span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>    include_allergies <span class="dt">BOOLEAN</span> <span class="kw">DEFAULT</span> <span class="kw">TRUE</span>,</span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>    max_tokens <span class="dt">INTEGER</span> <span class="kw">DEFAULT</span> <span class="dv">2048</span>,</span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>    temperature <span class="dt">DECIMAL</span>(<span class="dv">3</span>,<span class="dv">2</span>) <span class="kw">DEFAULT</span> <span class="fl">0.70</span>,</span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a>    conversation_history_limit <span class="dt">INTEGER</span> <span class="kw">DEFAULT</span> <span class="dv">10</span>,</span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a>    custom_system_prompt TEXT,</span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a>    created_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a>    updated_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span> <span class="kw">ON</span> <span class="kw">UPDATE</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb108-16"><a href="#cb108-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FOREIGN</span> <span class="kw">KEY</span> (user_id) <span class="kw">REFERENCES</span> users(<span class="kw">id</span>) <span class="kw">ON</span> <span class="kw">DELETE</span> <span class="kw">CASCADE</span></span>
<span id="cb108-17"><a href="#cb108-17" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb108-18"><a href="#cb108-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-19"><a href="#cb108-19" aria-hidden="true" tabindex="-1"></a><span class="co">-- Chat Conversations</span></span>
<span id="cb108-20"><a href="#cb108-20" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> chat_conversations (</span>
<span id="cb108-21"><a href="#cb108-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> BIGINT <span class="kw">PRIMARY</span> <span class="kw">KEY</span> AUTO_INCREMENT,</span>
<span id="cb108-22"><a href="#cb108-22" aria-hidden="true" tabindex="-1"></a>    patient_id BIGINT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb108-23"><a href="#cb108-23" aria-hidden="true" tabindex="-1"></a>    user_id BIGINT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb108-24"><a href="#cb108-24" aria-hidden="true" tabindex="-1"></a>    title <span class="dt">VARCHAR</span>(<span class="dv">255</span>),</span>
<span id="cb108-25"><a href="#cb108-25" aria-hidden="true" tabindex="-1"></a>    is_active <span class="dt">BOOLEAN</span> <span class="kw">DEFAULT</span> <span class="kw">TRUE</span>,</span>
<span id="cb108-26"><a href="#cb108-26" aria-hidden="true" tabindex="-1"></a>    created_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb108-27"><a href="#cb108-27" aria-hidden="true" tabindex="-1"></a>    updated_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span> <span class="kw">ON</span> <span class="kw">UPDATE</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb108-28"><a href="#cb108-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FOREIGN</span> <span class="kw">KEY</span> (patient_id) <span class="kw">REFERENCES</span> patients(<span class="kw">id</span>) <span class="kw">ON</span> <span class="kw">DELETE</span> <span class="kw">CASCADE</span>,</span>
<span id="cb108-29"><a href="#cb108-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FOREIGN</span> <span class="kw">KEY</span> (user_id) <span class="kw">REFERENCES</span> users(<span class="kw">id</span>) <span class="kw">ON</span> <span class="kw">DELETE</span> <span class="kw">CASCADE</span></span>
<span id="cb108-30"><a href="#cb108-30" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb108-31"><a href="#cb108-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-32"><a href="#cb108-32" aria-hidden="true" tabindex="-1"></a><span class="co">-- Chat Messages</span></span>
<span id="cb108-33"><a href="#cb108-33" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> chat_messages (</span>
<span id="cb108-34"><a href="#cb108-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> BIGINT <span class="kw">PRIMARY</span> <span class="kw">KEY</span> AUTO_INCREMENT,</span>
<span id="cb108-35"><a href="#cb108-35" aria-hidden="true" tabindex="-1"></a>    conversation_id BIGINT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb108-36"><a href="#cb108-36" aria-hidden="true" tabindex="-1"></a>    message_type ENUM(<span class="st">&#39;USER&#39;</span>, <span class="st">&#39;AI&#39;</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb108-37"><a href="#cb108-37" aria-hidden="true" tabindex="-1"></a>    content TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb108-38"><a href="#cb108-38" aria-hidden="true" tabindex="-1"></a>    tokens_used <span class="dt">INTEGER</span>,</span>
<span id="cb108-39"><a href="#cb108-39" aria-hidden="true" tabindex="-1"></a>    model_used <span class="dt">VARCHAR</span>(<span class="dv">100</span>),</span>
<span id="cb108-40"><a href="#cb108-40" aria-hidden="true" tabindex="-1"></a>    processing_time_ms <span class="dt">INTEGER</span>,</span>
<span id="cb108-41"><a href="#cb108-41" aria-hidden="true" tabindex="-1"></a>    created_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb108-42"><a href="#cb108-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FOREIGN</span> <span class="kw">KEY</span> (conversation_id) <span class="kw">REFERENCES</span> chat_conversations(<span class="kw">id</span>) <span class="kw">ON</span> <span class="kw">DELETE</span> <span class="kw">CASCADE</span></span>
<span id="cb108-43"><a href="#cb108-43" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb108-44"><a href="#cb108-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-45"><a href="#cb108-45" aria-hidden="true" tabindex="-1"></a><span class="co">-- AI Interaction Audit</span></span>
<span id="cb108-46"><a href="#cb108-46" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> ai_interaction_audit (</span>
<span id="cb108-47"><a href="#cb108-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> BIGINT <span class="kw">PRIMARY</span> <span class="kw">KEY</span> AUTO_INCREMENT,</span>
<span id="cb108-48"><a href="#cb108-48" aria-hidden="true" tabindex="-1"></a>    user_id BIGINT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb108-49"><a href="#cb108-49" aria-hidden="true" tabindex="-1"></a>    input_text TEXT,</span>
<span id="cb108-50"><a href="#cb108-50" aria-hidden="true" tabindex="-1"></a>    output_text TEXT,</span>
<span id="cb108-51"><a href="#cb108-51" aria-hidden="true" tabindex="-1"></a>    model_used <span class="dt">VARCHAR</span>(<span class="dv">100</span>),</span>
<span id="cb108-52"><a href="#cb108-52" aria-hidden="true" tabindex="-1"></a>    tokens_used <span class="dt">INTEGER</span>,</span>
<span id="cb108-53"><a href="#cb108-53" aria-hidden="true" tabindex="-1"></a>    processing_time_ms <span class="dt">INTEGER</span>,</span>
<span id="cb108-54"><a href="#cb108-54" aria-hidden="true" tabindex="-1"></a>    <span class="dt">timestamp</span> <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb108-55"><a href="#cb108-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FOREIGN</span> <span class="kw">KEY</span> (user_id) <span class="kw">REFERENCES</span> users(<span class="kw">id</span>) <span class="kw">ON</span> <span class="kw">DELETE</span> <span class="kw">CASCADE</span></span>
<span id="cb108-56"><a href="#cb108-56" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb108-57"><a href="#cb108-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-58"><a href="#cb108-58" aria-hidden="true" tabindex="-1"></a><span class="co">-- Indexes for performance</span></span>
<span id="cb108-59"><a href="#cb108-59" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_chat_conversations_patient_user <span class="kw">ON</span> chat_conversations(patient_id, user_id);</span>
<span id="cb108-60"><a href="#cb108-60" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_chat_messages_conversation_created <span class="kw">ON</span> chat_messages(conversation_id, created_at);</span>
<span id="cb108-61"><a href="#cb108-61" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_ai_audit_user_timestamp <span class="kw">ON</span> ai_interaction_audit(user_id, <span class="dt">timestamp</span>);</span></code></pre></div>
<h3 id="development-and-testing">Development and Testing</h3>
<h4 id="mock-ai-service-for-development">Mock AI Service for
Development</h4>
<div class="sourceCode" id="cb109"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co">// service/MockAIChatService.java</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a><span class="at">@Profile</span><span class="op">(</span><span class="st">&quot;dev&quot;</span><span class="op">)</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a><span class="at">@ConditionalOnProperty</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;careconnect.deepseek.enabled&quot;</span><span class="op">,</span> havingValue <span class="op">=</span> <span class="st">&quot;false&quot;</span><span class="op">)</span></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> MockAIChatService <span class="kw">implements</span> AIChatService <span class="op">{</span></span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> AiChatResponse <span class="fu">sendMessage</span><span class="op">(</span><span class="bu">Long</span> userId<span class="op">,</span> <span class="bu">String</span> message<span class="op">,</span> <span class="bu">Long</span> patientId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Simulate processing time</span></span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">1000</span><span class="op">);</span></span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">InterruptedException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Thread</span><span class="op">.</span><span class="fu">currentThread</span><span class="op">().</span><span class="fu">interrupt</span><span class="op">();</span></span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> mockResponse <span class="op">=</span> <span class="fu">generateMockResponse</span><span class="op">(</span>message<span class="op">);</span></span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-18"><a href="#cb109-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> AiChatResponse<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb109-19"><a href="#cb109-19" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">response</span><span class="op">(</span>mockResponse<span class="op">)</span></span>
<span id="cb109-20"><a href="#cb109-20" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">tokensUsed</span><span class="op">(</span><span class="fu">calculateMockTokens</span><span class="op">(</span>message<span class="op">,</span> mockResponse<span class="op">))</span></span>
<span id="cb109-21"><a href="#cb109-21" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">model</span><span class="op">(</span><span class="st">&quot;mock-model&quot;</span><span class="op">)</span></span>
<span id="cb109-22"><a href="#cb109-22" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">processingTimeMs</span><span class="op">(</span><span class="dv">1000L</span><span class="op">)</span></span>
<span id="cb109-23"><a href="#cb109-23" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb109-24"><a href="#cb109-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb109-25"><a href="#cb109-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-26"><a href="#cb109-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> <span class="fu">generateMockResponse</span><span class="op">(</span><span class="bu">String</span> message<span class="op">)</span> <span class="op">{</span></span>
<span id="cb109-27"><a href="#cb109-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>message<span class="op">.</span><span class="fu">toLowerCase</span><span class="op">().</span><span class="fu">contains</span><span class="op">(</span><span class="st">&quot;pain&quot;</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb109-28"><a href="#cb109-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">&quot;I understand you&#39;re experiencing pain. Please describe your pain level on a scale of 1-10 and consider speaking with your healthcare provider if it persists.&quot;</span><span class="op">;</span></span>
<span id="cb109-29"><a href="#cb109-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>message<span class="op">.</span><span class="fu">toLowerCase</span><span class="op">().</span><span class="fu">contains</span><span class="op">(</span><span class="st">&quot;medication&quot;</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb109-30"><a href="#cb109-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">&quot;For medication questions, please consult with your pharmacist or healthcare provider. They can provide the most accurate and safe guidance for your specific situation.&quot;</span><span class="op">;</span></span>
<span id="cb109-31"><a href="#cb109-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb109-32"><a href="#cb109-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">&quot;Thank you for your message. I&#39;m here to provide general health information and support. For specific medical advice, please consult with your healthcare provider.&quot;</span><span class="op">;</span></span>
<span id="cb109-33"><a href="#cb109-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb109-34"><a href="#cb109-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb109-35"><a href="#cb109-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The CareConnect AI integration provides a comprehensive,
healthcare-focused AI solution with robust security, flexible
configuration, and production-ready features for both patient support
and clinical assistance.</p>
<h2 id="device-integration">Device Integration</h2>
<h3 id="wearable-device-integration">Wearable Device Integration</h3>
<div class="sourceCode" id="cb110"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co">// services/device_integration_service.dart</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DeviceIntegrationService {</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> HealthDataService _healthDataService;</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> syncFitbitData() <span class="at">async</span> {</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">final</span> fitbitData <span class="op">=</span> <span class="at">await</span> FitbitConnector<span class="op">.</span>instance<span class="op">.</span>getTodaysActivitySummary();</span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Convert Fitbit data to our format</span></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">final</span> healthData <span class="op">=</span> HealthData(</span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>        steps<span class="op">:</span> fitbitData<span class="op">.</span>summary<span class="op">?.</span>steps<span class="op">,</span></span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a>        heartRate<span class="op">:</span> fitbitData<span class="op">.</span>summary<span class="op">?.</span>restingHeartRate<span class="op">,</span></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a>        calories<span class="op">:</span> fitbitData<span class="op">.</span>summary<span class="op">?.</span>caloriesOut<span class="op">,</span></span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a>        distance<span class="op">:</span> fitbitData<span class="op">.</span>summary<span class="op">?.</span>distances<span class="op">?.</span>first<span class="op">.</span>distance<span class="op">,</span></span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a>        timestamp<span class="op">:</span> DateTime<span class="op">.</span>now()<span class="op">,</span></span>
<span id="cb110-16"><a href="#cb110-16" aria-hidden="true" tabindex="-1"></a>      );</span>
<span id="cb110-17"><a href="#cb110-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-18"><a href="#cb110-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">await</span> _healthDataService<span class="op">.</span>saveHealthData(healthData);</span>
<span id="cb110-19"><a href="#cb110-19" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (e) {</span>
<span id="cb110-20"><a href="#cb110-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> DeviceIntegrationException(<span class="st">&#39;Fitbit sync failed: $e&#39;</span>);</span>
<span id="cb110-21"><a href="#cb110-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb110-22"><a href="#cb110-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb110-23"><a href="#cb110-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-24"><a href="#cb110-24" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> setupDeviceSync() <span class="at">async</span> {</span>
<span id="cb110-25"><a href="#cb110-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Setup periodic sync</span></span>
<span id="cb110-26"><a href="#cb110-26" aria-hidden="true" tabindex="-1"></a>    Timer<span class="op">.</span>periodic(Duration(hours<span class="op">:</span> <span class="dv">1</span>)<span class="op">,</span> (timer) {</span>
<span id="cb110-27"><a href="#cb110-27" aria-hidden="true" tabindex="-1"></a>      syncAllConnectedDevices();</span>
<span id="cb110-28"><a href="#cb110-28" aria-hidden="true" tabindex="-1"></a>    });</span>
<span id="cb110-29"><a href="#cb110-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb110-30"><a href="#cb110-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-31"><a href="#cb110-31" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> syncAllConnectedDevices() <span class="at">async</span> {</span>
<span id="cb110-32"><a href="#cb110-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">final</span> connectedDevices <span class="op">=</span> <span class="at">await</span> getConnectedDevices();</span>
<span id="cb110-33"><a href="#cb110-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-34"><a href="#cb110-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="at">final</span> device <span class="kw">in</span> connectedDevices) {</span>
<span id="cb110-35"><a href="#cb110-35" aria-hidden="true" tabindex="-1"></a>      <span class="cf">switch</span> (device<span class="op">.</span>type) {</span>
<span id="cb110-36"><a href="#cb110-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> DeviceType<span class="op">.</span>fitbit<span class="op">:</span></span>
<span id="cb110-37"><a href="#cb110-37" aria-hidden="true" tabindex="-1"></a>          <span class="at">await</span> syncFitbitData();</span>
<span id="cb110-38"><a href="#cb110-38" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span>;</span>
<span id="cb110-39"><a href="#cb110-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> DeviceType<span class="op">.</span>appleWatch<span class="op">:</span></span>
<span id="cb110-40"><a href="#cb110-40" aria-hidden="true" tabindex="-1"></a>          <span class="at">await</span> syncAppleHealthData();</span>
<span id="cb110-41"><a href="#cb110-41" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span>;</span>
<span id="cb110-42"><a href="#cb110-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> DeviceType<span class="op">.</span>bloodPressureMonitor<span class="op">:</span></span>
<span id="cb110-43"><a href="#cb110-43" aria-hidden="true" tabindex="-1"></a>          <span class="at">await</span> syncBloodPressureData();</span>
<span id="cb110-44"><a href="#cb110-44" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span>;</span>
<span id="cb110-45"><a href="#cb110-45" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb110-46"><a href="#cb110-46" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb110-47"><a href="#cb110-47" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb110-48"><a href="#cb110-48" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 id="usps-integration">USPS Integration</h2>
<p>CareConnect integrates with the USPS Informed Delivery service to
help patients and caregivers track incoming mail and packages. This
feature is particularly valuable for elderly patients who may miss
important medical correspondence or medication deliveries.</p>
<h3 id="architecture-overview-3">Architecture Overview</h3>
<p>The USPS integration provides: - <strong>Mail Digest
Retrieval</strong>: Fetches daily mail summaries from USPS Informed
Delivery - <strong>Multi-Provider Support</strong>: Works with Gmail and
Outlook for USPS email parsing - <strong>Caching Layer</strong>: Reduces
API calls with intelligent caching - <strong>Mock Fallback</strong>:
Provides test data when email integration is unavailable</p>
<p><strong>Note</strong>: This integration currently requires Google
OAuth authentication for Gmail access, which is still pending
configuration.</p>
<h3 id="backend-implementation">Backend Implementation</h3>
<h4 id="uspsdigestservice---core-service">USPSDigestService - Core
Service</h4>
<div class="sourceCode" id="cb111"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co">// service/USPSDigestService.java</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a><span class="at">@RequiredArgsConstructor</span></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> USPSDigestService <span class="op">{</span></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> EmailCredentialRepo credRepo<span class="op">;</span></span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> USPSDigestCacheRepo cacheRepo<span class="op">;</span></span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> GmailClient gmailClient<span class="op">;</span></span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> OutlookClient outlookClient<span class="op">;</span></span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> GmailParser gmailParser<span class="op">;</span></span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> OutlookParser outlookParser<span class="op">;</span></span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> Optional<span class="op">&lt;</span>USPSDigest<span class="op">&gt;</span> <span class="fu">latestForUser</span><span class="op">(</span><span class="bu">String</span> userId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 1. Check cache first (6-hour TTL)</span></span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> cached <span class="op">=</span> cacheRepo<span class="op">.</span><span class="fu">findFirstByUserIdAndExpiresAtAfterOrderByDigestDateDesc</span><span class="op">(</span>userId<span class="op">,</span> Instant<span class="op">.</span><span class="fu">now</span><span class="op">());</span></span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>cached<span class="op">.</span><span class="fu">isPresent</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb111-16"><a href="#cb111-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb111-17"><a href="#cb111-17" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> Optional<span class="op">.</span><span class="fu">of</span><span class="op">(</span>objectMapper<span class="op">.</span><span class="fu">readValue</span><span class="op">(</span>cached<span class="op">.</span><span class="fu">get</span><span class="op">().</span><span class="fu">getPayloadJson</span><span class="op">(),</span> USPSDigest<span class="op">.</span><span class="fu">class</span><span class="op">));</span></span>
<span id="cb111-18"><a href="#cb111-18" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> ignored<span class="op">)</span> <span class="op">{}</span></span>
<span id="cb111-19"><a href="#cb111-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb111-20"><a href="#cb111-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-21"><a href="#cb111-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 2. Try Gmail integration</span></span>
<span id="cb111-22"><a href="#cb111-22" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> gmail <span class="op">=</span> credRepo<span class="op">.</span><span class="fu">findFirstByUserIdAndProviderOrderByIdDesc</span><span class="op">(</span>userId<span class="op">,</span> EmailCredential<span class="op">.</span><span class="fu">Provider</span><span class="op">.</span><span class="fu">GMAIL</span><span class="op">);</span></span>
<span id="cb111-23"><a href="#cb111-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>gmail<span class="op">.</span><span class="fu">isPresent</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb111-24"><a href="#cb111-24" aria-hidden="true" tabindex="-1"></a>            <span class="dt">var</span> accessToken <span class="op">=</span> <span class="fu">decrypt</span><span class="op">(</span>gmail<span class="op">.</span><span class="fu">get</span><span class="op">().</span><span class="fu">getAccessTokenEnc</span><span class="op">());</span></span>
<span id="cb111-25"><a href="#cb111-25" aria-hidden="true" tabindex="-1"></a>            <span class="dt">var</span> rawDigest <span class="op">=</span> gmailClient<span class="op">.</span><span class="fu">fetchLatestDigest</span><span class="op">(</span>accessToken<span class="op">);</span></span>
<span id="cb111-26"><a href="#cb111-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>rawDigest<span class="op">.</span><span class="fu">isPresent</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb111-27"><a href="#cb111-27" aria-hidden="true" tabindex="-1"></a>                <span class="dt">var</span> digest <span class="op">=</span> gmailParser<span class="op">.</span><span class="fu">toDomain</span><span class="op">(</span>rawDigest<span class="op">.</span><span class="fu">get</span><span class="op">());</span></span>
<span id="cb111-28"><a href="#cb111-28" aria-hidden="true" tabindex="-1"></a>                <span class="fu">cache</span><span class="op">(</span>userId<span class="op">,</span> digest<span class="op">);</span></span>
<span id="cb111-29"><a href="#cb111-29" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> Optional<span class="op">.</span><span class="fu">of</span><span class="op">(</span>digest<span class="op">);</span></span>
<span id="cb111-30"><a href="#cb111-30" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb111-31"><a href="#cb111-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb111-32"><a href="#cb111-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-33"><a href="#cb111-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 3. Try Outlook integration</span></span>
<span id="cb111-34"><a href="#cb111-34" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> outlook <span class="op">=</span> credRepo<span class="op">.</span><span class="fu">findFirstByUserIdAndProviderOrderByIdDesc</span><span class="op">(</span>userId<span class="op">,</span> EmailCredential<span class="op">.</span><span class="fu">Provider</span><span class="op">.</span><span class="fu">OUTLOOK</span><span class="op">);</span></span>
<span id="cb111-35"><a href="#cb111-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>outlook<span class="op">.</span><span class="fu">isPresent</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb111-36"><a href="#cb111-36" aria-hidden="true" tabindex="-1"></a>            <span class="dt">var</span> accessToken <span class="op">=</span> <span class="fu">decrypt</span><span class="op">(</span>outlook<span class="op">.</span><span class="fu">get</span><span class="op">().</span><span class="fu">getAccessTokenEnc</span><span class="op">());</span></span>
<span id="cb111-37"><a href="#cb111-37" aria-hidden="true" tabindex="-1"></a>            <span class="dt">var</span> rawDigest <span class="op">=</span> outlookClient<span class="op">.</span><span class="fu">fetchLatestDigest</span><span class="op">(</span>accessToken<span class="op">);</span></span>
<span id="cb111-38"><a href="#cb111-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>rawDigest<span class="op">.</span><span class="fu">isPresent</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb111-39"><a href="#cb111-39" aria-hidden="true" tabindex="-1"></a>                <span class="dt">var</span> digest <span class="op">=</span> outlookParser<span class="op">.</span><span class="fu">toDomain</span><span class="op">(</span>rawDigest<span class="op">.</span><span class="fu">get</span><span class="op">());</span></span>
<span id="cb111-40"><a href="#cb111-40" aria-hidden="true" tabindex="-1"></a>                <span class="fu">cache</span><span class="op">(</span>userId<span class="op">,</span> digest<span class="op">);</span></span>
<span id="cb111-41"><a href="#cb111-41" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> Optional<span class="op">.</span><span class="fu">of</span><span class="op">(</span>digest<span class="op">);</span></span>
<span id="cb111-42"><a href="#cb111-42" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb111-43"><a href="#cb111-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb111-44"><a href="#cb111-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-45"><a href="#cb111-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 4. Mock fallback for testing and demonstration</span></span>
<span id="cb111-46"><a href="#cb111-46" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> mockDigest <span class="op">=</span> <span class="fu">mockDigest</span><span class="op">();</span></span>
<span id="cb111-47"><a href="#cb111-47" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cache</span><span class="op">(</span>userId<span class="op">,</span> mockDigest<span class="op">);</span></span>
<span id="cb111-48"><a href="#cb111-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Optional<span class="op">.</span><span class="fu">of</span><span class="op">(</span>mockDigest<span class="op">);</span></span>
<span id="cb111-49"><a href="#cb111-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb111-50"><a href="#cb111-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-51"><a href="#cb111-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">cache</span><span class="op">(</span><span class="bu">String</span> userId<span class="op">,</span> USPSDigest digest<span class="op">)</span> <span class="op">{</span></span>
<span id="cb111-52"><a href="#cb111-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb111-53"><a href="#cb111-53" aria-hidden="true" tabindex="-1"></a>            <span class="dt">var</span> cache <span class="op">=</span> <span class="kw">new</span> <span class="fu">USPSDigestCache</span><span class="op">();</span></span>
<span id="cb111-54"><a href="#cb111-54" aria-hidden="true" tabindex="-1"></a>            cache<span class="op">.</span><span class="fu">setUserId</span><span class="op">(</span>userId<span class="op">);</span></span>
<span id="cb111-55"><a href="#cb111-55" aria-hidden="true" tabindex="-1"></a>            cache<span class="op">.</span><span class="fu">setDigestDate</span><span class="op">(</span>digest<span class="op">.</span><span class="fu">digestDate</span><span class="op">()</span> <span class="op">!=</span> <span class="kw">null</span> <span class="op">?</span> digest<span class="op">.</span><span class="fu">digestDate</span><span class="op">().</span><span class="fu">toInstant</span><span class="op">()</span> <span class="op">:</span> Instant<span class="op">.</span><span class="fu">now</span><span class="op">());</span></span>
<span id="cb111-56"><a href="#cb111-56" aria-hidden="true" tabindex="-1"></a>            cache<span class="op">.</span><span class="fu">setPayloadJson</span><span class="op">(</span>objectMapper<span class="op">.</span><span class="fu">writeValueAsString</span><span class="op">(</span>digest<span class="op">));</span></span>
<span id="cb111-57"><a href="#cb111-57" aria-hidden="true" tabindex="-1"></a>            cache<span class="op">.</span><span class="fu">setExpiresAt</span><span class="op">(</span>Instant<span class="op">.</span><span class="fu">now</span><span class="op">().</span><span class="fu">plus</span><span class="op">(</span><span class="bu">Duration</span><span class="op">.</span><span class="fu">ofHours</span><span class="op">(</span><span class="dv">6</span><span class="op">)));</span> <span class="co">// 6-hour cache</span></span>
<span id="cb111-58"><a href="#cb111-58" aria-hidden="true" tabindex="-1"></a>            cacheRepo<span class="op">.</span><span class="fu">save</span><span class="op">(</span>cache<span class="op">);</span></span>
<span id="cb111-59"><a href="#cb111-59" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> ignored<span class="op">)</span> <span class="op">{</span></span>
<span id="cb111-60"><a href="#cb111-60" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Cache failure should not affect main functionality</span></span>
<span id="cb111-61"><a href="#cb111-61" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb111-62"><a href="#cb111-62" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb111-63"><a href="#cb111-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-64"><a href="#cb111-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> USPSDigest <span class="fu">mockDigest</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb111-65"><a href="#cb111-65" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> now <span class="op">=</span> OffsetDateTime<span class="op">.</span><span class="fu">now</span><span class="op">(</span>ZoneOffset<span class="op">.</span><span class="fu">UTC</span><span class="op">);</span></span>
<span id="cb111-66"><a href="#cb111-66" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> packageItem <span class="op">=</span> <span class="kw">new</span> <span class="fu">PackageItem</span><span class="op">(</span></span>
<span id="cb111-67"><a href="#cb111-67" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;9400100000000000000000&quot;</span><span class="op">,</span></span>
<span id="cb111-68"><a href="#cb111-68" aria-hidden="true" tabindex="-1"></a>            now<span class="op">.</span><span class="fu">plusDays</span><span class="op">(</span><span class="dv">1</span><span class="op">).</span><span class="fu">toString</span><span class="op">(),</span></span>
<span id="cb111-69"><a href="#cb111-69" aria-hidden="true" tabindex="-1"></a>            ActionLinks<span class="op">.</span><span class="fu">defaults</span><span class="op">(</span><span class="st">&quot;https://tools.usps.com/go/TrackConfirmAction?qtc_tLabels1=9400100000000000000000&quot;</span><span class="op">)</span></span>
<span id="cb111-70"><a href="#cb111-70" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb111-71"><a href="#cb111-71" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> mailPiece <span class="op">=</span> <span class="kw">new</span> <span class="fu">MailPiece</span><span class="op">(</span></span>
<span id="cb111-72"><a href="#cb111-72" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;m-1&quot;</span><span class="op">,</span></span>
<span id="cb111-73"><a href="#cb111-73" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;ACME Bank&quot;</span><span class="op">,</span></span>
<span id="cb111-74"><a href="#cb111-74" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Monthly statement&quot;</span><span class="op">,</span></span>
<span id="cb111-75"><a href="#cb111-75" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;data:image/svg+xml;base64,PHN2ZyB3aWR0aD0nNDAnIGhlaWdodD0nMjAnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zyc+PHJlY3Qgd2lkdGg9JzQwJyBoZWlnaHQ9JzIwJyBmaWxsPSIjZGRkIi8+PC9zdmc+&quot;</span><span class="op">,</span></span>
<span id="cb111-76"><a href="#cb111-76" aria-hidden="true" tabindex="-1"></a>            now<span class="op">.</span><span class="fu">toString</span><span class="op">(),</span></span>
<span id="cb111-77"><a href="#cb111-77" aria-hidden="true" tabindex="-1"></a>            ActionLinks<span class="op">.</span><span class="fu">defaults</span><span class="op">(</span><span class="kw">null</span><span class="op">)</span></span>
<span id="cb111-78"><a href="#cb111-78" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb111-79"><a href="#cb111-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">USPSDigest</span><span class="op">(</span>now<span class="op">,</span> <span class="bu">List</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span>mailPiece<span class="op">),</span> <span class="bu">List</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span>packageItem<span class="op">));</span></span>
<span id="cb111-80"><a href="#cb111-80" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb111-81"><a href="#cb111-81" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="usps-rest-controller">USPS REST Controller</h4>
<div class="sourceCode" id="cb112"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co">// controller/USPSController.java</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="at">@RestController</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/v1/api/usps&quot;</span><span class="op">)</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a><span class="at">@RequiredArgsConstructor</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> USPSController <span class="op">{</span></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> USPSDigestService service<span class="op">;</span></span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/mail&quot;</span><span class="op">)</span></span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ResponseEntity<span class="op">&lt;</span>USPSDigest<span class="op">&gt;</span> <span class="fu">getDigest</span><span class="op">(</span><span class="at">@AuthenticationPrincipal</span> Jwt jwt<span class="op">)</span> <span class="op">{</span></span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> userId <span class="op">=</span> jwt <span class="op">!=</span> <span class="kw">null</span> <span class="op">?</span> jwt<span class="op">.</span><span class="fu">getSubject</span><span class="op">()</span> <span class="op">:</span> <span class="st">&quot;demo-user&quot;</span><span class="op">;</span> <span class="co">// Fallback for testing</span></span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> digest <span class="op">=</span> service<span class="op">.</span><span class="fu">latestForUser</span><span class="op">(</span>userId<span class="op">)</span></span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">orElseGet</span><span class="op">(()</span> <span class="op">-&gt;</span> <span class="kw">new</span> <span class="fu">USPSDigest</span><span class="op">(</span><span class="kw">null</span><span class="op">,</span> <span class="bu">List</span><span class="op">.</span><span class="fu">of</span><span class="op">(),</span> <span class="bu">List</span><span class="op">.</span><span class="fu">of</span><span class="op">()));</span></span>
<span id="cb112-14"><a href="#cb112-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ResponseEntity<span class="op">.</span><span class="fu">ok</span><span class="op">(</span>digest<span class="op">);</span></span>
<span id="cb112-15"><a href="#cb112-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb112-16"><a href="#cb112-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="data-models">Data Models</h4>
<div class="sourceCode" id="cb113"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="co">// model/USPSDigest.java</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">record</span> <span class="fu">USPSDigest</span><span class="op">(</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>    OffsetDateTime digestDate<span class="op">,</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>MailPiece<span class="op">&gt;</span> mailPieces<span class="op">,</span></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>PackageItem<span class="op">&gt;</span> packages</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a><span class="op">)</span> <span class="op">{}</span></span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a><span class="co">// model/MailPiece.java</span></span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">record</span> <span class="fu">MailPiece</span><span class="op">(</span></span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> id<span class="op">,</span></span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> sender<span class="op">,</span></span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> subject<span class="op">,</span></span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> imageUrl<span class="op">,</span></span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> deliveryDate<span class="op">,</span></span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true" tabindex="-1"></a>    ActionLinks actionLinks</span>
<span id="cb113-16"><a href="#cb113-16" aria-hidden="true" tabindex="-1"></a><span class="op">)</span> <span class="op">{}</span></span>
<span id="cb113-17"><a href="#cb113-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-18"><a href="#cb113-18" aria-hidden="true" tabindex="-1"></a><span class="co">// model/PackageItem.java</span></span>
<span id="cb113-19"><a href="#cb113-19" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">record</span> <span class="fu">PackageItem</span><span class="op">(</span></span>
<span id="cb113-20"><a href="#cb113-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> trackingNumber<span class="op">,</span></span>
<span id="cb113-21"><a href="#cb113-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> expectedDelivery<span class="op">,</span></span>
<span id="cb113-22"><a href="#cb113-22" aria-hidden="true" tabindex="-1"></a>    ActionLinks actionLinks</span>
<span id="cb113-23"><a href="#cb113-23" aria-hidden="true" tabindex="-1"></a><span class="op">)</span> <span class="op">{}</span></span>
<span id="cb113-24"><a href="#cb113-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-25"><a href="#cb113-25" aria-hidden="true" tabindex="-1"></a><span class="co">// model/ActionLinks.java</span></span>
<span id="cb113-26"><a href="#cb113-26" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">record</span> <span class="fu">ActionLinks</span><span class="op">(</span></span>
<span id="cb113-27"><a href="#cb113-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> trackingUrl<span class="op">,</span></span>
<span id="cb113-28"><a href="#cb113-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> detailsUrl</span>
<span id="cb113-29"><a href="#cb113-29" aria-hidden="true" tabindex="-1"></a><span class="op">)</span> <span class="op">{</span></span>
<span id="cb113-30"><a href="#cb113-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> ActionLinks <span class="fu">defaults</span><span class="op">(</span><span class="bu">String</span> trackingUrl<span class="op">)</span> <span class="op">{</span></span>
<span id="cb113-31"><a href="#cb113-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">ActionLinks</span><span class="op">(</span>trackingUrl<span class="op">,</span> <span class="kw">null</span><span class="op">);</span></span>
<span id="cb113-32"><a href="#cb113-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb113-33"><a href="#cb113-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="frontend-implementation">Frontend Implementation</h3>
<h4 id="informeddeliveryservice---api-client">InformedDeliveryService -
API Client</h4>
<div class="sourceCode" id="cb114"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co">// services/informed_delivery_service.dart</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> InformedDeliveryService {</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">Map</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> <span class="at">dynamic</span><span class="op">&gt;&gt;</span> fetchInformedDelivery() <span class="at">async</span> {</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">final</span> headers <span class="op">=</span> <span class="at">await</span> AuthTokenManager<span class="op">.</span>getAuthHeaders();</span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">final</span> response <span class="op">=</span> <span class="at">await</span> http<span class="op">.</span><span class="kw">get</span>(</span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>      Uri<span class="op">.</span>parse(<span class="st">&#39;${ApiConstants.informedDelivery}/mail&#39;</span>)<span class="op">,</span></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>      headers<span class="op">:</span> headers<span class="op">,</span></span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>    );</span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (response<span class="op">.</span>statusCode <span class="op">==</span> <span class="dv">200</span> <span class="op">&amp;&amp;</span> response<span class="op">.</span>body<span class="op">.</span>isNotEmpty) {</span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">return</span> jsonDecode(response<span class="op">.</span>body);</span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (response<span class="op">.</span>statusCode <span class="op">==</span> <span class="dv">401</span>) {</span>
<span id="cb114-14"><a href="#cb114-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">Exception</span>(<span class="st">&quot;Not authorized. Please log in again.&quot;</span>);</span>
<span id="cb114-15"><a href="#cb114-15" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb114-16"><a href="#cb114-16" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">Exception</span>(<span class="st">&quot;Failed to fetch informed delivery data: ${response.statusCode}&quot;</span>);</span>
<span id="cb114-17"><a href="#cb114-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb114-18"><a href="#cb114-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb114-19"><a href="#cb114-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb114-20"><a href="#cb114-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-21"><a href="#cb114-21" aria-hidden="true" tabindex="-1"></a><span class="co">// API Constants</span></span>
<span id="cb114-22"><a href="#cb114-22" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ApiConstants {</span>
<span id="cb114-23"><a href="#cb114-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">static</span> <span class="at">final</span> <span class="dt">String</span> _host <span class="op">=</span> getBackendBaseUrl();</span>
<span id="cb114-24"><a href="#cb114-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">static</span> <span class="at">final</span> <span class="dt">String</span> informedDelivery <span class="op">=</span> <span class="st">&#39;$_host/v1/api/usps&#39;</span>;</span>
<span id="cb114-25"><a href="#cb114-25" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h4 id="frontend-display-integration">Frontend Display Integration</h4>
<div class="sourceCode" id="cb115"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co">// features/informed_delivery/informed_delivery_screen.dart</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> InformedDeliveryScreen <span class="kw">extends</span> StatefulWidget {</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>  _InformedDeliveryScreenState createState() <span class="op">=&gt;</span> _InformedDeliveryScreenState();</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> _InformedDeliveryScreenState <span class="kw">extends</span> State<span class="op">&lt;</span>InformedDeliveryScreen<span class="op">&gt;</span> {</span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Map</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> <span class="at">dynamic</span><span class="op">&gt;?</span> digestData;</span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> isLoading <span class="op">=</span> <span class="cn">false</span>;</span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">String</span><span class="op">?</span> error;</span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> initState() {</span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span><span class="op">.</span>initState();</span>
<span id="cb115-15"><a href="#cb115-15" aria-hidden="true" tabindex="-1"></a>    loadInformedDelivery();</span>
<span id="cb115-16"><a href="#cb115-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb115-17"><a href="#cb115-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-18"><a href="#cb115-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> loadInformedDelivery() <span class="at">async</span> {</span>
<span id="cb115-19"><a href="#cb115-19" aria-hidden="true" tabindex="-1"></a>    setState(() {</span>
<span id="cb115-20"><a href="#cb115-20" aria-hidden="true" tabindex="-1"></a>      isLoading <span class="op">=</span> <span class="cn">true</span>;</span>
<span id="cb115-21"><a href="#cb115-21" aria-hidden="true" tabindex="-1"></a>      error <span class="op">=</span> <span class="cn">null</span>;</span>
<span id="cb115-22"><a href="#cb115-22" aria-hidden="true" tabindex="-1"></a>    });</span>
<span id="cb115-23"><a href="#cb115-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-24"><a href="#cb115-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb115-25"><a href="#cb115-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">final</span> data <span class="op">=</span> <span class="at">await</span> InformedDeliveryService<span class="op">.</span>fetchInformedDelivery();</span>
<span id="cb115-26"><a href="#cb115-26" aria-hidden="true" tabindex="-1"></a>      setState(() {</span>
<span id="cb115-27"><a href="#cb115-27" aria-hidden="true" tabindex="-1"></a>        digestData <span class="op">=</span> data;</span>
<span id="cb115-28"><a href="#cb115-28" aria-hidden="true" tabindex="-1"></a>      });</span>
<span id="cb115-29"><a href="#cb115-29" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (e) {</span>
<span id="cb115-30"><a href="#cb115-30" aria-hidden="true" tabindex="-1"></a>      setState(() {</span>
<span id="cb115-31"><a href="#cb115-31" aria-hidden="true" tabindex="-1"></a>        error <span class="op">=</span> e<span class="op">.</span>toString();</span>
<span id="cb115-32"><a href="#cb115-32" aria-hidden="true" tabindex="-1"></a>      });</span>
<span id="cb115-33"><a href="#cb115-33" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">finally</span> {</span>
<span id="cb115-34"><a href="#cb115-34" aria-hidden="true" tabindex="-1"></a>      setState(() {</span>
<span id="cb115-35"><a href="#cb115-35" aria-hidden="true" tabindex="-1"></a>        isLoading <span class="op">=</span> <span class="cn">false</span>;</span>
<span id="cb115-36"><a href="#cb115-36" aria-hidden="true" tabindex="-1"></a>      });</span>
<span id="cb115-37"><a href="#cb115-37" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb115-38"><a href="#cb115-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb115-39"><a href="#cb115-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-40"><a href="#cb115-40" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb115-41"><a href="#cb115-41" aria-hidden="true" tabindex="-1"></a>  Widget build(BuildContext context) {</span>
<span id="cb115-42"><a href="#cb115-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> Scaffold(</span>
<span id="cb115-43"><a href="#cb115-43" aria-hidden="true" tabindex="-1"></a>      appBar<span class="op">:</span> AppBar(</span>
<span id="cb115-44"><a href="#cb115-44" aria-hidden="true" tabindex="-1"></a>        title<span class="op">:</span> Text(<span class="st">&#39;Mail &amp; Packages&#39;</span>)<span class="op">,</span></span>
<span id="cb115-45"><a href="#cb115-45" aria-hidden="true" tabindex="-1"></a>        backgroundColor<span class="op">:</span> Theme<span class="op">.</span>of(context)<span class="op">.</span>primaryColor<span class="op">,</span></span>
<span id="cb115-46"><a href="#cb115-46" aria-hidden="true" tabindex="-1"></a>      )<span class="op">,</span></span>
<span id="cb115-47"><a href="#cb115-47" aria-hidden="true" tabindex="-1"></a>      body<span class="op">:</span> isLoading</span>
<span id="cb115-48"><a href="#cb115-48" aria-hidden="true" tabindex="-1"></a>        <span class="op">?</span> Center(child<span class="op">:</span> CircularProgressIndicator())</span>
<span id="cb115-49"><a href="#cb115-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">:</span> error <span class="op">!=</span> <span class="cn">null</span></span>
<span id="cb115-50"><a href="#cb115-50" aria-hidden="true" tabindex="-1"></a>          <span class="op">?</span> Center(child<span class="op">:</span> Text(<span class="st">&#39;Error: $error&#39;</span>))</span>
<span id="cb115-51"><a href="#cb115-51" aria-hidden="true" tabindex="-1"></a>          <span class="op">:</span> buildDigestContent()<span class="op">,</span></span>
<span id="cb115-52"><a href="#cb115-52" aria-hidden="true" tabindex="-1"></a>    );</span>
<span id="cb115-53"><a href="#cb115-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb115-54"><a href="#cb115-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-55"><a href="#cb115-55" aria-hidden="true" tabindex="-1"></a>  Widget buildDigestContent() {</span>
<span id="cb115-56"><a href="#cb115-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (digestData <span class="op">==</span> <span class="cn">null</span>) <span class="kw">return</span> Center(child<span class="op">:</span> Text(<span class="st">&#39;No data available&#39;</span>));</span>
<span id="cb115-57"><a href="#cb115-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-58"><a href="#cb115-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> RefreshIndicator(</span>
<span id="cb115-59"><a href="#cb115-59" aria-hidden="true" tabindex="-1"></a>      onRefresh<span class="op">:</span> loadInformedDelivery<span class="op">,</span></span>
<span id="cb115-60"><a href="#cb115-60" aria-hidden="true" tabindex="-1"></a>      child<span class="op">:</span> SingleChildScrollView(</span>
<span id="cb115-61"><a href="#cb115-61" aria-hidden="true" tabindex="-1"></a>        physics<span class="op">:</span> AlwaysScrollableScrollPhysics()<span class="op">,</span></span>
<span id="cb115-62"><a href="#cb115-62" aria-hidden="true" tabindex="-1"></a>        child<span class="op">:</span> Padding(</span>
<span id="cb115-63"><a href="#cb115-63" aria-hidden="true" tabindex="-1"></a>          padding<span class="op">:</span> EdgeInsets<span class="op">.</span>all(<span class="dv">16</span>)<span class="op">,</span></span>
<span id="cb115-64"><a href="#cb115-64" aria-hidden="true" tabindex="-1"></a>          child<span class="op">:</span> Column(</span>
<span id="cb115-65"><a href="#cb115-65" aria-hidden="true" tabindex="-1"></a>            crossAxisAlignment<span class="op">:</span> CrossAxisAlignment<span class="op">.</span>start<span class="op">,</span></span>
<span id="cb115-66"><a href="#cb115-66" aria-hidden="true" tabindex="-1"></a>            children<span class="op">:</span> [</span>
<span id="cb115-67"><a href="#cb115-67" aria-hidden="true" tabindex="-1"></a>              buildMailPiecesSection()<span class="op">,</span></span>
<span id="cb115-68"><a href="#cb115-68" aria-hidden="true" tabindex="-1"></a>              SizedBox(height<span class="op">:</span> <span class="dv">20</span>)<span class="op">,</span></span>
<span id="cb115-69"><a href="#cb115-69" aria-hidden="true" tabindex="-1"></a>              buildPackagesSection()<span class="op">,</span></span>
<span id="cb115-70"><a href="#cb115-70" aria-hidden="true" tabindex="-1"></a>            ]<span class="op">,</span></span>
<span id="cb115-71"><a href="#cb115-71" aria-hidden="true" tabindex="-1"></a>          )<span class="op">,</span></span>
<span id="cb115-72"><a href="#cb115-72" aria-hidden="true" tabindex="-1"></a>        )<span class="op">,</span></span>
<span id="cb115-73"><a href="#cb115-73" aria-hidden="true" tabindex="-1"></a>      )<span class="op">,</span></span>
<span id="cb115-74"><a href="#cb115-74" aria-hidden="true" tabindex="-1"></a>    );</span>
<span id="cb115-75"><a href="#cb115-75" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb115-76"><a href="#cb115-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-77"><a href="#cb115-77" aria-hidden="true" tabindex="-1"></a>  Widget buildMailPiecesSection() {</span>
<span id="cb115-78"><a href="#cb115-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">final</span> mailPieces <span class="op">=</span> digestData<span class="op">!</span>[<span class="st">&#39;mailPieces&#39;</span>] <span class="kw">as</span> <span class="dt">List</span><span class="op">&lt;</span><span class="at">dynamic</span><span class="op">&gt;?</span> <span class="op">??</span> [];</span>
<span id="cb115-79"><a href="#cb115-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-80"><a href="#cb115-80" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> Card(</span>
<span id="cb115-81"><a href="#cb115-81" aria-hidden="true" tabindex="-1"></a>      child<span class="op">:</span> Padding(</span>
<span id="cb115-82"><a href="#cb115-82" aria-hidden="true" tabindex="-1"></a>        padding<span class="op">:</span> EdgeInsets<span class="op">.</span>all(<span class="dv">16</span>)<span class="op">,</span></span>
<span id="cb115-83"><a href="#cb115-83" aria-hidden="true" tabindex="-1"></a>        child<span class="op">:</span> Column(</span>
<span id="cb115-84"><a href="#cb115-84" aria-hidden="true" tabindex="-1"></a>          crossAxisAlignment<span class="op">:</span> CrossAxisAlignment<span class="op">.</span>start<span class="op">,</span></span>
<span id="cb115-85"><a href="#cb115-85" aria-hidden="true" tabindex="-1"></a>          children<span class="op">:</span> [</span>
<span id="cb115-86"><a href="#cb115-86" aria-hidden="true" tabindex="-1"></a>            Text(<span class="st">&#39;Today</span><span class="sc">\&#39;</span><span class="st">s Mail&#39;</span><span class="op">,</span> style<span class="op">:</span> Theme<span class="op">.</span>of(context)<span class="op">.</span>textTheme<span class="op">.</span>headline6)<span class="op">,</span></span>
<span id="cb115-87"><a href="#cb115-87" aria-hidden="true" tabindex="-1"></a>            SizedBox(height<span class="op">:</span> <span class="dv">10</span>)<span class="op">,</span></span>
<span id="cb115-88"><a href="#cb115-88" aria-hidden="true" tabindex="-1"></a>            <span class="op">...</span>mailPieces<span class="op">.</span>map((mail) <span class="op">=&gt;</span> buildMailItem(mail))<span class="op">.</span>toList()<span class="op">,</span></span>
<span id="cb115-89"><a href="#cb115-89" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (mailPieces<span class="op">.</span>isEmpty) Text(<span class="st">&#39;No mail expected today&#39;</span>)<span class="op">,</span></span>
<span id="cb115-90"><a href="#cb115-90" aria-hidden="true" tabindex="-1"></a>          ]<span class="op">,</span></span>
<span id="cb115-91"><a href="#cb115-91" aria-hidden="true" tabindex="-1"></a>        )<span class="op">,</span></span>
<span id="cb115-92"><a href="#cb115-92" aria-hidden="true" tabindex="-1"></a>      )<span class="op">,</span></span>
<span id="cb115-93"><a href="#cb115-93" aria-hidden="true" tabindex="-1"></a>    );</span>
<span id="cb115-94"><a href="#cb115-94" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb115-95"><a href="#cb115-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-96"><a href="#cb115-96" aria-hidden="true" tabindex="-1"></a>  Widget buildPackagesSection() {</span>
<span id="cb115-97"><a href="#cb115-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">final</span> packages <span class="op">=</span> digestData<span class="op">!</span>[<span class="st">&#39;packages&#39;</span>] <span class="kw">as</span> <span class="dt">List</span><span class="op">&lt;</span><span class="at">dynamic</span><span class="op">&gt;?</span> <span class="op">??</span> [];</span>
<span id="cb115-98"><a href="#cb115-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-99"><a href="#cb115-99" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> Card(</span>
<span id="cb115-100"><a href="#cb115-100" aria-hidden="true" tabindex="-1"></a>      child<span class="op">:</span> Padding(</span>
<span id="cb115-101"><a href="#cb115-101" aria-hidden="true" tabindex="-1"></a>        padding<span class="op">:</span> EdgeInsets<span class="op">.</span>all(<span class="dv">16</span>)<span class="op">,</span></span>
<span id="cb115-102"><a href="#cb115-102" aria-hidden="true" tabindex="-1"></a>        child<span class="op">:</span> Column(</span>
<span id="cb115-103"><a href="#cb115-103" aria-hidden="true" tabindex="-1"></a>          crossAxisAlignment<span class="op">:</span> CrossAxisAlignment<span class="op">.</span>start<span class="op">,</span></span>
<span id="cb115-104"><a href="#cb115-104" aria-hidden="true" tabindex="-1"></a>          children<span class="op">:</span> [</span>
<span id="cb115-105"><a href="#cb115-105" aria-hidden="true" tabindex="-1"></a>            Text(<span class="st">&#39;Package Tracking&#39;</span><span class="op">,</span> style<span class="op">:</span> Theme<span class="op">.</span>of(context)<span class="op">.</span>textTheme<span class="op">.</span>headline6)<span class="op">,</span></span>
<span id="cb115-106"><a href="#cb115-106" aria-hidden="true" tabindex="-1"></a>            SizedBox(height<span class="op">:</span> <span class="dv">10</span>)<span class="op">,</span></span>
<span id="cb115-107"><a href="#cb115-107" aria-hidden="true" tabindex="-1"></a>            <span class="op">...</span>packages<span class="op">.</span>map((pkg) <span class="op">=&gt;</span> buildPackageItem(pkg))<span class="op">.</span>toList()<span class="op">,</span></span>
<span id="cb115-108"><a href="#cb115-108" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (packages<span class="op">.</span>isEmpty) Text(<span class="st">&#39;No packages being tracked&#39;</span>)<span class="op">,</span></span>
<span id="cb115-109"><a href="#cb115-109" aria-hidden="true" tabindex="-1"></a>          ]<span class="op">,</span></span>
<span id="cb115-110"><a href="#cb115-110" aria-hidden="true" tabindex="-1"></a>        )<span class="op">,</span></span>
<span id="cb115-111"><a href="#cb115-111" aria-hidden="true" tabindex="-1"></a>      )<span class="op">,</span></span>
<span id="cb115-112"><a href="#cb115-112" aria-hidden="true" tabindex="-1"></a>    );</span>
<span id="cb115-113"><a href="#cb115-113" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb115-114"><a href="#cb115-114" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="database-schema-2">Database Schema</h3>
<div class="sourceCode" id="cb116"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- USPS Digest Cache Table</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> usps_digest_cache (</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> BIGINT <span class="kw">PRIMARY</span> <span class="kw">KEY</span> AUTO_INCREMENT,</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>    user_id <span class="dt">VARCHAR</span>(<span class="dv">255</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>    digest_date <span class="dt">TIMESTAMP</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>    payload_json TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>    expires_at <span class="dt">TIMESTAMP</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>    created_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">INDEX</span> idx_user_expires (user_id, expires_at),</span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">INDEX</span> idx_user_digest_date (user_id, digest_date <span class="kw">DESC</span>)</span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-14"><a href="#cb116-14" aria-hidden="true" tabindex="-1"></a><span class="co">-- Email Credentials for OAuth Integration</span></span>
<span id="cb116-15"><a href="#cb116-15" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> email_credentials (</span>
<span id="cb116-16"><a href="#cb116-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> BIGINT <span class="kw">PRIMARY</span> <span class="kw">KEY</span> AUTO_INCREMENT,</span>
<span id="cb116-17"><a href="#cb116-17" aria-hidden="true" tabindex="-1"></a>    user_id <span class="dt">VARCHAR</span>(<span class="dv">255</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb116-18"><a href="#cb116-18" aria-hidden="true" tabindex="-1"></a>    provider ENUM(<span class="st">&#39;GMAIL&#39;</span>, <span class="st">&#39;OUTLOOK&#39;</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb116-19"><a href="#cb116-19" aria-hidden="true" tabindex="-1"></a>    access_token_enc TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb116-20"><a href="#cb116-20" aria-hidden="true" tabindex="-1"></a>    refresh_token_enc TEXT,</span>
<span id="cb116-21"><a href="#cb116-21" aria-hidden="true" tabindex="-1"></a>    expires_at <span class="dt">TIMESTAMP</span>,</span>
<span id="cb116-22"><a href="#cb116-22" aria-hidden="true" tabindex="-1"></a>    created_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb116-23"><a href="#cb116-23" aria-hidden="true" tabindex="-1"></a>    updated_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span> <span class="kw">ON</span> <span class="kw">UPDATE</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb116-24"><a href="#cb116-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-25"><a href="#cb116-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">INDEX</span> idx_user_provider (user_id, provider),</span>
<span id="cb116-26"><a href="#cb116-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">INDEX</span> idx_expires_at (expires_at)</span>
<span id="cb116-27"><a href="#cb116-27" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<h3 id="configuration">Configuration</h3>
<h4 id="application-properties">Application Properties</h4>
<pre class="properties"><code># USPS Integration Settings
careconnect.usps.enabled=true
careconnect.usps.cache.ttl-hours=6
careconnect.usps.mock.enabled=${USPS_MOCK_MODE:true}

# Email Integration (Pending Google OAuth Setup)
careconnect.email.gmail.client-id=${GMAIL_CLIENT_ID:}
careconnect.email.gmail.client-secret=${GMAIL_CLIENT_SECRET:}
careconnect.email.outlook.client-id=${OUTLOOK_CLIENT_ID:}
careconnect.email.outlook.client-secret=${OUTLOOK_CLIENT_SECRET:}

# Encryption for stored credentials
careconnect.encryption.key=${ENCRYPTION_KEY:default-dev-key}</code></pre>
<h3 id="security-considerations">Security Considerations</h3>
<ul>
<li><strong>OAuth Integration</strong>: Requires secure storage of email
access tokens</li>
<li><strong>Token Encryption</strong>: Email credentials are encrypted
at rest</li>
<li><strong>Cache Security</strong>: Digest data cached with
user-specific keys</li>
<li><strong>Rate Limiting</strong>: Prevents excessive API calls to
email providers</li>
</ul>
<h3 id="known-limitations">Known Limitations</h3>
<ol type="1">
<li><strong>Google OAuth Pending</strong>: Gmail integration requires
Google OAuth 2.0 setup</li>
<li><strong>Mock Data</strong>: Currently uses mock data when email
integration unavailable</li>
<li><strong>Email Parsing</strong>: Depends on USPS email format
consistency</li>
<li><strong>Cache Invalidation</strong>: Manual refresh required for
real-time updates</li>
</ol>
<h3 id="future-enhancements">Future Enhancements</h3>
<ul>
<li><strong>Push Notifications</strong>: Alert users of important
mail/packages</li>
<li><strong>OCR Integration</strong>: Extract text from mail piece
images</li>
<li><strong>Smart Filtering</strong>: Categorize mail by
medical/financial importance</li>
<li><strong>Medication Delivery Tracking</strong>: Special handling for
pharmacy deliveries</li>
</ul>
<h2 id="vial-of-life-integration">Vial of Life Integration</h2>
<p>CareConnect includes a comprehensive Vial of Life PDF generation
system designed for emergency medical situations. The system creates
professionally formatted emergency information documents that can be
accessed by first responders via QR codes or emergency IDs.</p>
<h3 id="architecture-overview-4">Architecture Overview</h3>
<p>The Vial of Life integration provides: - <strong>Emergency PDF
Generation</strong>: Creates standardized emergency medical information
forms - <strong>Patient Data Integration</strong>: Automatically
populates patient medical data - <strong>QR Code Access</strong>: Public
emergency access without authentication - <strong>Professional
Formatting</strong>: Medical-grade PDF layouts with clear typography -
<strong>Emergency Contact Integration</strong>: Includes family member
and caregiver contacts</p>
<h3 id="backend-implementation-1">Backend Implementation</h3>
<h4 id="vialoflifepdfservice---core-pdf-generation">VialOfLifePdfService
- Core PDF Generation</h4>
<div class="sourceCode" id="cb118"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co">// service/VialOfLifePdfService.java</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> VialOfLifePdfService <span class="op">{</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">Logger</span> logger <span class="op">=</span> LoggerFactory<span class="op">.</span><span class="fu">getLogger</span><span class="op">(</span>VialOfLifePdfService<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> PatientService patientService<span class="op">;</span></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> MedicationService medicationService<span class="op">;</span></span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> FamilyMemberService familyMemberService<span class="op">;</span></span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> Generate a pre<span class="co">-</span>filled Vial of Life PDF for a patient</span>
<span id="cb118-18"><a href="#cb118-18" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb118-19"><a href="#cb118-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">byte</span><span class="op">[]</span> <span class="fu">generateVialOfLifePdf</span><span class="op">(</span><span class="bu">String</span> emergencyId<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb118-20"><a href="#cb118-20" aria-hidden="true" tabindex="-1"></a>        logger<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;Generating Vial of Life PDF for emergency ID: {}&quot;</span><span class="op">,</span> emergencyId<span class="op">);</span></span>
<span id="cb118-21"><a href="#cb118-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-22"><a href="#cb118-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Extract patient ID from emergency ID format: VIAL123456</span></span>
<span id="cb118-23"><a href="#cb118-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Long</span> patientId <span class="op">=</span> <span class="fu">extractPatientIdFromEmergencyId</span><span class="op">(</span>emergencyId<span class="op">);</span></span>
<span id="cb118-24"><a href="#cb118-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-25"><a href="#cb118-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Gather patient information</span></span>
<span id="cb118-26"><a href="#cb118-26" aria-hidden="true" tabindex="-1"></a>        Optional<span class="op">&lt;</span>PatientProfileDTO<span class="op">&gt;</span> patientProfile <span class="op">=</span> patientService<span class="op">.</span><span class="fu">getPatientProfile</span><span class="op">(</span>patientId<span class="op">);</span></span>
<span id="cb118-27"><a href="#cb118-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>patientProfile<span class="op">.</span><span class="fu">isEmpty</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb118-28"><a href="#cb118-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">IllegalArgumentException</span><span class="op">(</span><span class="st">&quot;Patient not found for emergency ID: &quot;</span> <span class="op">+</span> emergencyId<span class="op">);</span></span>
<span id="cb118-29"><a href="#cb118-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb118-30"><a href="#cb118-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-31"><a href="#cb118-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Get additional medical data</span></span>
<span id="cb118-32"><a href="#cb118-32" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span>MedicationDTO<span class="op">&gt;</span> medications <span class="op">=</span> medicationService<span class="op">.</span><span class="fu">getAllMedicationsForPatient</span><span class="op">(</span>patientId<span class="op">);</span></span>
<span id="cb118-33"><a href="#cb118-33" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span>FamilyMemberLinkResponse<span class="op">&gt;</span> emergencyContacts <span class="op">=</span> familyMemberService<span class="op">.</span><span class="fu">getFamilyMembersByPatientId</span><span class="op">(</span>patientId<span class="op">);</span></span>
<span id="cb118-34"><a href="#cb118-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-35"><a href="#cb118-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">createProfessionalEmergencyPdf</span><span class="op">(</span>patientProfile<span class="op">.</span><span class="fu">get</span><span class="op">(),</span> medications<span class="op">,</span> emergencyContacts<span class="op">);</span></span>
<span id="cb118-36"><a href="#cb118-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb118-37"><a href="#cb118-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-38"><a href="#cb118-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb118-39"><a href="#cb118-39" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> Create professional emergency PDF document using Apache PDFBox</span>
<span id="cb118-40"><a href="#cb118-40" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb118-41"><a href="#cb118-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">byte</span><span class="op">[]</span> <span class="fu">createProfessionalEmergencyPdf</span><span class="op">(</span>PatientProfileDTO patient<span class="op">,</span></span>
<span id="cb118-42"><a href="#cb118-42" aria-hidden="true" tabindex="-1"></a>                                                 <span class="bu">List</span><span class="op">&lt;</span>MedicationDTO<span class="op">&gt;</span> medications<span class="op">,</span></span>
<span id="cb118-43"><a href="#cb118-43" aria-hidden="true" tabindex="-1"></a>                                                 <span class="bu">List</span><span class="op">&lt;</span>FamilyMemberLinkResponse<span class="op">&gt;</span> emergencyContacts<span class="op">)</span> <span class="kw">throws</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb118-44"><a href="#cb118-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-45"><a href="#cb118-45" aria-hidden="true" tabindex="-1"></a>        <span class="bu">ByteArrayOutputStream</span> baos <span class="op">=</span> <span class="kw">new</span> <span class="bu">ByteArrayOutputStream</span><span class="op">();</span></span>
<span id="cb118-46"><a href="#cb118-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-47"><a href="#cb118-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">(</span>PDDocument document <span class="op">=</span> <span class="kw">new</span> <span class="fu">PDDocument</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb118-48"><a href="#cb118-48" aria-hidden="true" tabindex="-1"></a>            PDPage page <span class="op">=</span> <span class="kw">new</span> <span class="fu">PDPage</span><span class="op">();</span></span>
<span id="cb118-49"><a href="#cb118-49" aria-hidden="true" tabindex="-1"></a>            document<span class="op">.</span><span class="fu">addPage</span><span class="op">(</span>page<span class="op">);</span></span>
<span id="cb118-50"><a href="#cb118-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-51"><a href="#cb118-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> <span class="op">(</span>PDPageContentStream contentStream <span class="op">=</span> <span class="kw">new</span> <span class="fu">PDPageContentStream</span><span class="op">(</span>document<span class="op">,</span> page<span class="op">))</span> <span class="op">{</span></span>
<span id="cb118-52"><a href="#cb118-52" aria-hidden="true" tabindex="-1"></a>                <span class="dt">float</span> pageWidth <span class="op">=</span> page<span class="op">.</span><span class="fu">getMediaBox</span><span class="op">().</span><span class="fu">getWidth</span><span class="op">();</span></span>
<span id="cb118-53"><a href="#cb118-53" aria-hidden="true" tabindex="-1"></a>                <span class="dt">float</span> pageHeight <span class="op">=</span> page<span class="op">.</span><span class="fu">getMediaBox</span><span class="op">().</span><span class="fu">getHeight</span><span class="op">();</span></span>
<span id="cb118-54"><a href="#cb118-54" aria-hidden="true" tabindex="-1"></a>                <span class="dt">float</span> margin <span class="op">=</span> <span class="dv">50</span><span class="op">;</span></span>
<span id="cb118-55"><a href="#cb118-55" aria-hidden="true" tabindex="-1"></a>                <span class="dt">float</span> yPosition <span class="op">=</span> pageHeight <span class="op">-</span> margin<span class="op">;</span></span>
<span id="cb118-56"><a href="#cb118-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-57"><a href="#cb118-57" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Draw medical cross header</span></span>
<span id="cb118-58"><a href="#cb118-58" aria-hidden="true" tabindex="-1"></a>                <span class="fu">drawRedCrossHeader</span><span class="op">(</span>contentStream<span class="op">,</span> pageWidth<span class="op">,</span> yPosition<span class="op">);</span></span>
<span id="cb118-59"><a href="#cb118-59" aria-hidden="true" tabindex="-1"></a>                yPosition <span class="op">-=</span> <span class="dv">80</span><span class="op">;</span></span>
<span id="cb118-60"><a href="#cb118-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-61"><a href="#cb118-61" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Document title</span></span>
<span id="cb118-62"><a href="#cb118-62" aria-hidden="true" tabindex="-1"></a>                <span class="fu">drawTitle</span><span class="op">(</span>contentStream<span class="op">,</span> pageWidth<span class="op">,</span> yPosition<span class="op">);</span></span>
<span id="cb118-63"><a href="#cb118-63" aria-hidden="true" tabindex="-1"></a>                yPosition <span class="op">-=</span> <span class="dv">50</span><span class="op">;</span></span>
<span id="cb118-64"><a href="#cb118-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-65"><a href="#cb118-65" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Patient Information Section</span></span>
<span id="cb118-66"><a href="#cb118-66" aria-hidden="true" tabindex="-1"></a>                yPosition <span class="op">=</span> <span class="fu">drawPatientInfoSection</span><span class="op">(</span>contentStream<span class="op">,</span> patient<span class="op">,</span> margin<span class="op">,</span> yPosition<span class="op">);</span></span>
<span id="cb118-67"><a href="#cb118-67" aria-hidden="true" tabindex="-1"></a>                yPosition <span class="op">-=</span> <span class="dv">30</span><span class="op">;</span></span>
<span id="cb118-68"><a href="#cb118-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-69"><a href="#cb118-69" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Critical Medical Information Section</span></span>
<span id="cb118-70"><a href="#cb118-70" aria-hidden="true" tabindex="-1"></a>                yPosition <span class="op">=</span> <span class="fu">drawMedicalInfoSection</span><span class="op">(</span>contentStream<span class="op">,</span> patient<span class="op">,</span> medications<span class="op">,</span> margin<span class="op">,</span> yPosition<span class="op">);</span></span>
<span id="cb118-71"><a href="#cb118-71" aria-hidden="true" tabindex="-1"></a>                yPosition <span class="op">-=</span> <span class="dv">30</span><span class="op">;</span></span>
<span id="cb118-72"><a href="#cb118-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-73"><a href="#cb118-73" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Emergency Contacts Section</span></span>
<span id="cb118-74"><a href="#cb118-74" aria-hidden="true" tabindex="-1"></a>                yPosition <span class="op">=</span> <span class="fu">drawEmergencyContactsSection</span><span class="op">(</span>contentStream<span class="op">,</span> emergencyContacts<span class="op">,</span> margin<span class="op">,</span> yPosition<span class="op">);</span></span>
<span id="cb118-75"><a href="#cb118-75" aria-hidden="true" tabindex="-1"></a>                yPosition <span class="op">-=</span> <span class="dv">40</span><span class="op">;</span></span>
<span id="cb118-76"><a href="#cb118-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-77"><a href="#cb118-77" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Professional footer</span></span>
<span id="cb118-78"><a href="#cb118-78" aria-hidden="true" tabindex="-1"></a>                <span class="fu">drawFooter</span><span class="op">(</span>contentStream<span class="op">,</span> pageWidth<span class="op">,</span> yPosition<span class="op">);</span></span>
<span id="cb118-79"><a href="#cb118-79" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb118-80"><a href="#cb118-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-81"><a href="#cb118-81" aria-hidden="true" tabindex="-1"></a>            document<span class="op">.</span><span class="fu">save</span><span class="op">(</span>baos<span class="op">);</span></span>
<span id="cb118-82"><a href="#cb118-82" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb118-83"><a href="#cb118-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-84"><a href="#cb118-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> baos<span class="op">.</span><span class="fu">toByteArray</span><span class="op">();</span></span>
<span id="cb118-85"><a href="#cb118-85" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb118-86"><a href="#cb118-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-87"><a href="#cb118-87" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb118-88"><a href="#cb118-88" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> Draw red cross medical symbol header</span>
<span id="cb118-89"><a href="#cb118-89" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb118-90"><a href="#cb118-90" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">drawRedCrossHeader</span><span class="op">(</span>PDPageContentStream contentStream<span class="op">,</span> <span class="dt">float</span> pageWidth<span class="op">,</span> <span class="dt">float</span> yPosition<span class="op">)</span> <span class="kw">throws</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb118-91"><a href="#cb118-91" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> crossSize <span class="op">=</span> <span class="dv">40</span><span class="op">;</span></span>
<span id="cb118-92"><a href="#cb118-92" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> crossX <span class="op">=</span> pageWidth <span class="op">/</span> <span class="dv">2</span> <span class="op">-</span> crossSize <span class="op">/</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb118-93"><a href="#cb118-93" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> crossY <span class="op">=</span> yPosition <span class="op">-</span> crossSize<span class="op">;</span></span>
<span id="cb118-94"><a href="#cb118-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-95"><a href="#cb118-95" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Draw red medical cross</span></span>
<span id="cb118-96"><a href="#cb118-96" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">setNonStrokingColor</span><span class="op">(</span><span class="bu">Color</span><span class="op">.</span><span class="fu">RED</span><span class="op">);</span></span>
<span id="cb118-97"><a href="#cb118-97" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">addRect</span><span class="op">(</span>crossX <span class="op">-</span> <span class="dv">5</span><span class="op">,</span> crossY <span class="op">+</span> crossSize<span class="op">/</span><span class="dv">3</span><span class="op">,</span> crossSize <span class="op">+</span> <span class="dv">10</span><span class="op">,</span> crossSize<span class="op">/</span><span class="dv">3</span><span class="op">);</span></span>
<span id="cb118-98"><a href="#cb118-98" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">fill</span><span class="op">();</span></span>
<span id="cb118-99"><a href="#cb118-99" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">addRect</span><span class="op">(</span>crossX <span class="op">+</span> crossSize<span class="op">/</span><span class="dv">3</span><span class="op">,</span> crossY <span class="op">-</span> <span class="dv">5</span><span class="op">,</span> crossSize<span class="op">/</span><span class="dv">3</span><span class="op">,</span> crossSize <span class="op">+</span> <span class="dv">10</span><span class="op">);</span></span>
<span id="cb118-100"><a href="#cb118-100" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">fill</span><span class="op">();</span></span>
<span id="cb118-101"><a href="#cb118-101" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">setNonStrokingColor</span><span class="op">(</span><span class="bu">Color</span><span class="op">.</span><span class="fu">BLACK</span><span class="op">);</span></span>
<span id="cb118-102"><a href="#cb118-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-103"><a href="#cb118-103" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Header text</span></span>
<span id="cb118-104"><a href="#cb118-104" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">beginText</span><span class="op">();</span></span>
<span id="cb118-105"><a href="#cb118-105" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">setFont</span><span class="op">(</span><span class="kw">new</span> <span class="fu">PDType1Font</span><span class="op">(</span>Standard14Fonts<span class="op">.</span><span class="fu">FontName</span><span class="op">.</span><span class="fu">HELVETICA_BOLD</span><span class="op">),</span> <span class="dv">18</span><span class="op">);</span></span>
<span id="cb118-106"><a href="#cb118-106" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> headerText <span class="op">=</span> <span class="st">&quot;EMERGENCY MEDICAL INFORMATION&quot;</span><span class="op">;</span></span>
<span id="cb118-107"><a href="#cb118-107" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> textWidth <span class="op">=</span> <span class="kw">new</span> <span class="fu">PDType1Font</span><span class="op">(</span>Standard14Fonts<span class="op">.</span><span class="fu">FontName</span><span class="op">.</span><span class="fu">HELVETICA_BOLD</span><span class="op">).</span><span class="fu">getStringWidth</span><span class="op">(</span>headerText<span class="op">)</span> <span class="op">/</span> <span class="dv">1000</span> <span class="op">*</span> <span class="dv">18</span><span class="op">;</span></span>
<span id="cb118-108"><a href="#cb118-108" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">newLineAtOffset</span><span class="op">((</span>pageWidth <span class="op">-</span> textWidth<span class="op">)</span> <span class="op">/</span> <span class="dv">2</span><span class="op">,</span> crossY <span class="op">-</span> <span class="dv">25</span><span class="op">);</span></span>
<span id="cb118-109"><a href="#cb118-109" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">showText</span><span class="op">(</span>headerText<span class="op">);</span></span>
<span id="cb118-110"><a href="#cb118-110" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">endText</span><span class="op">();</span></span>
<span id="cb118-111"><a href="#cb118-111" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb118-112"><a href="#cb118-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-113"><a href="#cb118-113" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb118-114"><a href="#cb118-114" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> Draw patient information section with clean formatting</span>
<span id="cb118-115"><a href="#cb118-115" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb118-116"><a href="#cb118-116" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">float</span> <span class="fu">drawPatientInfoSection</span><span class="op">(</span>PDPageContentStream contentStream<span class="op">,</span> PatientProfileDTO patient<span class="op">,</span> <span class="dt">float</span> margin<span class="op">,</span> <span class="dt">float</span> yPosition<span class="op">)</span> <span class="kw">throws</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb118-117"><a href="#cb118-117" aria-hidden="true" tabindex="-1"></a>        <span class="fu">drawSectionTitle</span><span class="op">(</span>contentStream<span class="op">,</span> <span class="st">&quot;PATIENT INFORMATION&quot;</span><span class="op">,</span> margin<span class="op">,</span> yPosition<span class="op">);</span></span>
<span id="cb118-118"><a href="#cb118-118" aria-hidden="true" tabindex="-1"></a>        yPosition <span class="op">-=</span> <span class="dv">25</span><span class="op">;</span></span>
<span id="cb118-119"><a href="#cb118-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-120"><a href="#cb118-120" aria-hidden="true" tabindex="-1"></a>        yPosition <span class="op">=</span> <span class="fu">drawInfoLine</span><span class="op">(</span>contentStream<span class="op">,</span> <span class="st">&quot;Name:&quot;</span><span class="op">,</span> patient<span class="op">.</span><span class="fu">firstName</span><span class="op">()</span> <span class="op">+</span> <span class="st">&quot; &quot;</span> <span class="op">+</span> patient<span class="op">.</span><span class="fu">lastName</span><span class="op">(),</span> margin<span class="op">,</span> yPosition<span class="op">);</span></span>
<span id="cb118-121"><a href="#cb118-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-122"><a href="#cb118-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>patient<span class="op">.</span><span class="fu">dob</span><span class="op">()</span> <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-123"><a href="#cb118-123" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb118-124"><a href="#cb118-124" aria-hidden="true" tabindex="-1"></a>                LocalDate dobDate <span class="op">=</span> LocalDate<span class="op">.</span><span class="fu">parse</span><span class="op">(</span>patient<span class="op">.</span><span class="fu">dob</span><span class="op">());</span></span>
<span id="cb118-125"><a href="#cb118-125" aria-hidden="true" tabindex="-1"></a>                <span class="dt">int</span> age <span class="op">=</span> Period<span class="op">.</span><span class="fu">between</span><span class="op">(</span>dobDate<span class="op">,</span> LocalDate<span class="op">.</span><span class="fu">now</span><span class="op">()).</span><span class="fu">getYears</span><span class="op">();</span></span>
<span id="cb118-126"><a href="#cb118-126" aria-hidden="true" tabindex="-1"></a>                yPosition <span class="op">=</span> <span class="fu">drawInfoLine</span><span class="op">(</span>contentStream<span class="op">,</span> <span class="st">&quot;Date of Birth:&quot;</span><span class="op">,</span> patient<span class="op">.</span><span class="fu">dob</span><span class="op">()</span> <span class="op">+</span> <span class="st">&quot; (Age: &quot;</span> <span class="op">+</span> age <span class="op">+</span> <span class="st">&quot;)&quot;</span><span class="op">,</span> margin<span class="op">,</span> yPosition<span class="op">);</span></span>
<span id="cb118-127"><a href="#cb118-127" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-128"><a href="#cb118-128" aria-hidden="true" tabindex="-1"></a>                yPosition <span class="op">=</span> <span class="fu">drawInfoLine</span><span class="op">(</span>contentStream<span class="op">,</span> <span class="st">&quot;Date of Birth:&quot;</span><span class="op">,</span> patient<span class="op">.</span><span class="fu">dob</span><span class="op">(),</span> margin<span class="op">,</span> yPosition<span class="op">);</span></span>
<span id="cb118-129"><a href="#cb118-129" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb118-130"><a href="#cb118-130" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb118-131"><a href="#cb118-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-132"><a href="#cb118-132" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>patient<span class="op">.</span><span class="fu">gender</span><span class="op">()</span> <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-133"><a href="#cb118-133" aria-hidden="true" tabindex="-1"></a>            yPosition <span class="op">=</span> <span class="fu">drawInfoLine</span><span class="op">(</span>contentStream<span class="op">,</span> <span class="st">&quot;Gender:&quot;</span><span class="op">,</span> patient<span class="op">.</span><span class="fu">gender</span><span class="op">().</span><span class="fu">toString</span><span class="op">(),</span> margin<span class="op">,</span> yPosition<span class="op">);</span></span>
<span id="cb118-134"><a href="#cb118-134" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb118-135"><a href="#cb118-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-136"><a href="#cb118-136" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>patient<span class="op">.</span><span class="fu">phone</span><span class="op">()</span> <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-137"><a href="#cb118-137" aria-hidden="true" tabindex="-1"></a>            yPosition <span class="op">=</span> <span class="fu">drawInfoLine</span><span class="op">(</span>contentStream<span class="op">,</span> <span class="st">&quot;Phone:&quot;</span><span class="op">,</span> patient<span class="op">.</span><span class="fu">phone</span><span class="op">(),</span> margin<span class="op">,</span> yPosition<span class="op">);</span></span>
<span id="cb118-138"><a href="#cb118-138" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb118-139"><a href="#cb118-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-140"><a href="#cb118-140" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> yPosition<span class="op">;</span></span>
<span id="cb118-141"><a href="#cb118-141" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb118-142"><a href="#cb118-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-143"><a href="#cb118-143" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb118-144"><a href="#cb118-144" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> Draw critical medical information with highlighted allergies</span>
<span id="cb118-145"><a href="#cb118-145" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb118-146"><a href="#cb118-146" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">float</span> <span class="fu">drawMedicalInfoSection</span><span class="op">(</span>PDPageContentStream contentStream<span class="op">,</span> PatientProfileDTO patient<span class="op">,</span> <span class="bu">List</span><span class="op">&lt;</span>MedicationDTO<span class="op">&gt;</span> medications<span class="op">,</span> <span class="dt">float</span> margin<span class="op">,</span> <span class="dt">float</span> yPosition<span class="op">)</span> <span class="kw">throws</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb118-147"><a href="#cb118-147" aria-hidden="true" tabindex="-1"></a>        <span class="fu">drawSectionTitle</span><span class="op">(</span>contentStream<span class="op">,</span> <span class="st">&quot;CRITICAL MEDICAL INFORMATION&quot;</span><span class="op">,</span> margin<span class="op">,</span> yPosition<span class="op">);</span></span>
<span id="cb118-148"><a href="#cb118-148" aria-hidden="true" tabindex="-1"></a>        yPosition <span class="op">-=</span> <span class="dv">25</span><span class="op">;</span></span>
<span id="cb118-149"><a href="#cb118-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-150"><a href="#cb118-150" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Critical Allergies (highlighted in red)</span></span>
<span id="cb118-151"><a href="#cb118-151" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>patient<span class="op">.</span><span class="fu">allergies</span><span class="op">()</span> <span class="op">!=</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>patient<span class="op">.</span><span class="fu">allergies</span><span class="op">().</span><span class="fu">isEmpty</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb118-152"><a href="#cb118-152" aria-hidden="true" tabindex="-1"></a>            contentStream<span class="op">.</span><span class="fu">beginText</span><span class="op">();</span></span>
<span id="cb118-153"><a href="#cb118-153" aria-hidden="true" tabindex="-1"></a>            contentStream<span class="op">.</span><span class="fu">setFont</span><span class="op">(</span><span class="kw">new</span> <span class="fu">PDType1Font</span><span class="op">(</span>Standard14Fonts<span class="op">.</span><span class="fu">FontName</span><span class="op">.</span><span class="fu">HELVETICA_BOLD</span><span class="op">),</span> <span class="dv">11</span><span class="op">);</span></span>
<span id="cb118-154"><a href="#cb118-154" aria-hidden="true" tabindex="-1"></a>            contentStream<span class="op">.</span><span class="fu">setNonStrokingColor</span><span class="op">(</span><span class="bu">Color</span><span class="op">.</span><span class="fu">RED</span><span class="op">);</span></span>
<span id="cb118-155"><a href="#cb118-155" aria-hidden="true" tabindex="-1"></a>            contentStream<span class="op">.</span><span class="fu">newLineAtOffset</span><span class="op">(</span>margin<span class="op">,</span> yPosition<span class="op">);</span></span>
<span id="cb118-156"><a href="#cb118-156" aria-hidden="true" tabindex="-1"></a>            contentStream<span class="op">.</span><span class="fu">showText</span><span class="op">(</span><span class="st">&quot;CRITICAL ALLERGIES:&quot;</span><span class="op">);</span></span>
<span id="cb118-157"><a href="#cb118-157" aria-hidden="true" tabindex="-1"></a>            contentStream<span class="op">.</span><span class="fu">endText</span><span class="op">();</span></span>
<span id="cb118-158"><a href="#cb118-158" aria-hidden="true" tabindex="-1"></a>            contentStream<span class="op">.</span><span class="fu">setNonStrokingColor</span><span class="op">(</span><span class="bu">Color</span><span class="op">.</span><span class="fu">BLACK</span><span class="op">);</span></span>
<span id="cb118-159"><a href="#cb118-159" aria-hidden="true" tabindex="-1"></a>            yPosition <span class="op">-=</span> <span class="dv">18</span><span class="op">;</span></span>
<span id="cb118-160"><a href="#cb118-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-161"><a href="#cb118-161" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="dt">var</span> allergy <span class="op">:</span> patient<span class="op">.</span><span class="fu">allergies</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb118-162"><a href="#cb118-162" aria-hidden="true" tabindex="-1"></a>                <span class="bu">String</span> allergyText <span class="op">=</span> <span class="st">&quot;• &quot;</span> <span class="op">+</span> allergy<span class="op">.</span><span class="fu">allergen</span><span class="op">();</span></span>
<span id="cb118-163"><a href="#cb118-163" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>allergy<span class="op">.</span><span class="fu">severity</span><span class="op">()</span> <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-164"><a href="#cb118-164" aria-hidden="true" tabindex="-1"></a>                    allergyText <span class="op">+=</span> <span class="st">&quot; [&quot;</span> <span class="op">+</span> allergy<span class="op">.</span><span class="fu">severity</span><span class="op">().</span><span class="fu">toString</span><span class="op">()</span> <span class="op">+</span> <span class="st">&quot;]&quot;</span><span class="op">;</span></span>
<span id="cb118-165"><a href="#cb118-165" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb118-166"><a href="#cb118-166" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>allergy<span class="op">.</span><span class="fu">reaction</span><span class="op">()</span> <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-167"><a href="#cb118-167" aria-hidden="true" tabindex="-1"></a>                    allergyText <span class="op">+=</span> <span class="st">&quot; - &quot;</span> <span class="op">+</span> allergy<span class="op">.</span><span class="fu">reaction</span><span class="op">();</span></span>
<span id="cb118-168"><a href="#cb118-168" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb118-169"><a href="#cb118-169" aria-hidden="true" tabindex="-1"></a>                yPosition <span class="op">=</span> <span class="fu">drawBulletPoint</span><span class="op">(</span>contentStream<span class="op">,</span> allergyText<span class="op">,</span> margin <span class="op">+</span> <span class="dv">10</span><span class="op">,</span> yPosition<span class="op">);</span></span>
<span id="cb118-170"><a href="#cb118-170" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb118-171"><a href="#cb118-171" aria-hidden="true" tabindex="-1"></a>            yPosition <span class="op">-=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb118-172"><a href="#cb118-172" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb118-173"><a href="#cb118-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-174"><a href="#cb118-174" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Current Active Medications</span></span>
<span id="cb118-175"><a href="#cb118-175" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>medications <span class="op">!=</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>medications<span class="op">.</span><span class="fu">isEmpty</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb118-176"><a href="#cb118-176" aria-hidden="true" tabindex="-1"></a>            <span class="bu">List</span><span class="op">&lt;</span>MedicationDTO<span class="op">&gt;</span> activeMeds <span class="op">=</span> medications<span class="op">.</span><span class="fu">stream</span><span class="op">()</span></span>
<span id="cb118-177"><a href="#cb118-177" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">filter</span><span class="op">(</span>MedicationDTO<span class="op">::</span>isActive<span class="op">)</span></span>
<span id="cb118-178"><a href="#cb118-178" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">toList</span><span class="op">();</span></span>
<span id="cb118-179"><a href="#cb118-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-180"><a href="#cb118-180" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>activeMeds<span class="op">.</span><span class="fu">isEmpty</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb118-181"><a href="#cb118-181" aria-hidden="true" tabindex="-1"></a>                yPosition <span class="op">=</span> <span class="fu">drawInfoLine</span><span class="op">(</span>contentStream<span class="op">,</span> <span class="st">&quot;Current Medications:&quot;</span><span class="op">,</span> <span class="st">&quot;&quot;</span><span class="op">,</span> margin<span class="op">,</span> yPosition<span class="op">);</span></span>
<span id="cb118-182"><a href="#cb118-182" aria-hidden="true" tabindex="-1"></a>                yPosition <span class="op">-=</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb118-183"><a href="#cb118-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-184"><a href="#cb118-184" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> <span class="op">(</span>MedicationDTO med <span class="op">:</span> activeMeds<span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-185"><a href="#cb118-185" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">String</span> medText <span class="op">=</span> <span class="st">&quot;• &quot;</span> <span class="op">+</span> med<span class="op">.</span><span class="fu">medicationName</span><span class="op">();</span></span>
<span id="cb118-186"><a href="#cb118-186" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="op">(</span>med<span class="op">.</span><span class="fu">dosage</span><span class="op">()</span> <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-187"><a href="#cb118-187" aria-hidden="true" tabindex="-1"></a>                        medText <span class="op">+=</span> <span class="st">&quot; - &quot;</span> <span class="op">+</span> med<span class="op">.</span><span class="fu">dosage</span><span class="op">();</span></span>
<span id="cb118-188"><a href="#cb118-188" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb118-189"><a href="#cb118-189" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="op">(</span>med<span class="op">.</span><span class="fu">frequency</span><span class="op">()</span> <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-190"><a href="#cb118-190" aria-hidden="true" tabindex="-1"></a>                        medText <span class="op">+=</span> <span class="st">&quot; (&quot;</span> <span class="op">+</span> med<span class="op">.</span><span class="fu">frequency</span><span class="op">()</span> <span class="op">+</span> <span class="st">&quot;)&quot;</span><span class="op">;</span></span>
<span id="cb118-191"><a href="#cb118-191" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb118-192"><a href="#cb118-192" aria-hidden="true" tabindex="-1"></a>                    yPosition <span class="op">=</span> <span class="fu">drawBulletPoint</span><span class="op">(</span>contentStream<span class="op">,</span> medText<span class="op">,</span> margin <span class="op">+</span> <span class="dv">10</span><span class="op">,</span> yPosition<span class="op">);</span></span>
<span id="cb118-193"><a href="#cb118-193" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb118-194"><a href="#cb118-194" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb118-195"><a href="#cb118-195" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb118-196"><a href="#cb118-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-197"><a href="#cb118-197" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> yPosition<span class="op">;</span></span>
<span id="cb118-198"><a href="#cb118-198" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb118-199"><a href="#cb118-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-200"><a href="#cb118-200" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb118-201"><a href="#cb118-201" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> Draw emergency contacts section</span>
<span id="cb118-202"><a href="#cb118-202" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb118-203"><a href="#cb118-203" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">float</span> <span class="fu">drawEmergencyContactsSection</span><span class="op">(</span>PDPageContentStream contentStream<span class="op">,</span> <span class="bu">List</span><span class="op">&lt;</span>FamilyMemberLinkResponse<span class="op">&gt;</span> emergencyContacts<span class="op">,</span> <span class="dt">float</span> margin<span class="op">,</span> <span class="dt">float</span> yPosition<span class="op">)</span> <span class="kw">throws</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb118-204"><a href="#cb118-204" aria-hidden="true" tabindex="-1"></a>        <span class="fu">drawSectionTitle</span><span class="op">(</span>contentStream<span class="op">,</span> <span class="st">&quot;EMERGENCY CONTACTS&quot;</span><span class="op">,</span> margin<span class="op">,</span> yPosition<span class="op">);</span></span>
<span id="cb118-205"><a href="#cb118-205" aria-hidden="true" tabindex="-1"></a>        yPosition <span class="op">-=</span> <span class="dv">25</span><span class="op">;</span></span>
<span id="cb118-206"><a href="#cb118-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-207"><a href="#cb118-207" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>emergencyContacts <span class="op">!=</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>emergencyContacts<span class="op">.</span><span class="fu">isEmpty</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb118-208"><a href="#cb118-208" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span>FamilyMemberLinkResponse contact <span class="op">:</span> emergencyContacts<span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-209"><a href="#cb118-209" aria-hidden="true" tabindex="-1"></a>                <span class="bu">String</span> contactText <span class="op">=</span> contact<span class="op">.</span><span class="fu">familyMemberName</span><span class="op">();</span></span>
<span id="cb118-210"><a href="#cb118-210" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>contact<span class="op">.</span><span class="fu">relationship</span><span class="op">()</span> <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-211"><a href="#cb118-211" aria-hidden="true" tabindex="-1"></a>                    contactText <span class="op">+=</span> <span class="st">&quot; (&quot;</span> <span class="op">+</span> contact<span class="op">.</span><span class="fu">relationship</span><span class="op">()</span> <span class="op">+</span> <span class="st">&quot;)&quot;</span><span class="op">;</span></span>
<span id="cb118-212"><a href="#cb118-212" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb118-213"><a href="#cb118-213" aria-hidden="true" tabindex="-1"></a>                yPosition <span class="op">=</span> <span class="fu">drawInfoLine</span><span class="op">(</span>contentStream<span class="op">,</span> <span class="st">&quot;Contact:&quot;</span><span class="op">,</span> contactText<span class="op">,</span> margin<span class="op">,</span> yPosition<span class="op">);</span></span>
<span id="cb118-214"><a href="#cb118-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-215"><a href="#cb118-215" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>contact<span class="op">.</span><span class="fu">familyMemberEmail</span><span class="op">()</span> <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-216"><a href="#cb118-216" aria-hidden="true" tabindex="-1"></a>                    yPosition <span class="op">=</span> <span class="fu">drawInfoLine</span><span class="op">(</span>contentStream<span class="op">,</span> <span class="st">&quot;Email:&quot;</span><span class="op">,</span> contact<span class="op">.</span><span class="fu">familyMemberEmail</span><span class="op">(),</span> margin<span class="op">,</span> yPosition<span class="op">);</span></span>
<span id="cb118-217"><a href="#cb118-217" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb118-218"><a href="#cb118-218" aria-hidden="true" tabindex="-1"></a>                yPosition <span class="op">-=</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb118-219"><a href="#cb118-219" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb118-220"><a href="#cb118-220" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb118-221"><a href="#cb118-221" aria-hidden="true" tabindex="-1"></a>            yPosition <span class="op">=</span> <span class="fu">drawInfoLine</span><span class="op">(</span>contentStream<span class="op">,</span> <span class="st">&quot;&quot;</span><span class="op">,</span> <span class="st">&quot;No emergency contacts on file&quot;</span><span class="op">,</span> margin<span class="op">,</span> yPosition<span class="op">);</span></span>
<span id="cb118-222"><a href="#cb118-222" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb118-223"><a href="#cb118-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-224"><a href="#cb118-224" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> yPosition<span class="op">;</span></span>
<span id="cb118-225"><a href="#cb118-225" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb118-226"><a href="#cb118-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-227"><a href="#cb118-227" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb118-228"><a href="#cb118-228" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> Draw professional footer with generation info</span>
<span id="cb118-229"><a href="#cb118-229" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb118-230"><a href="#cb118-230" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">drawFooter</span><span class="op">(</span>PDPageContentStream contentStream<span class="op">,</span> <span class="dt">float</span> pageWidth<span class="op">,</span> <span class="dt">float</span> yPosition<span class="op">)</span> <span class="kw">throws</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb118-231"><a href="#cb118-231" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Draw separator line</span></span>
<span id="cb118-232"><a href="#cb118-232" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">setStrokingColor</span><span class="op">(</span><span class="bu">Color</span><span class="op">.</span><span class="fu">GRAY</span><span class="op">);</span></span>
<span id="cb118-233"><a href="#cb118-233" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">moveTo</span><span class="op">(</span><span class="dv">50</span><span class="op">,</span> yPosition <span class="op">+</span> <span class="dv">10</span><span class="op">);</span></span>
<span id="cb118-234"><a href="#cb118-234" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">lineTo</span><span class="op">(</span>pageWidth <span class="op">-</span> <span class="dv">50</span><span class="op">,</span> yPosition <span class="op">+</span> <span class="dv">10</span><span class="op">);</span></span>
<span id="cb118-235"><a href="#cb118-235" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">stroke</span><span class="op">();</span></span>
<span id="cb118-236"><a href="#cb118-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-237"><a href="#cb118-237" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Footer information</span></span>
<span id="cb118-238"><a href="#cb118-238" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">beginText</span><span class="op">();</span></span>
<span id="cb118-239"><a href="#cb118-239" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">setFont</span><span class="op">(</span><span class="kw">new</span> <span class="fu">PDType1Font</span><span class="op">(</span>Standard14Fonts<span class="op">.</span><span class="fu">FontName</span><span class="op">.</span><span class="fu">HELVETICA</span><span class="op">),</span> <span class="dv">9</span><span class="op">);</span></span>
<span id="cb118-240"><a href="#cb118-240" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">setNonStrokingColor</span><span class="op">(</span><span class="bu">Color</span><span class="op">.</span><span class="fu">GRAY</span><span class="op">);</span></span>
<span id="cb118-241"><a href="#cb118-241" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">newLineAtOffset</span><span class="op">(</span><span class="dv">50</span><span class="op">,</span> yPosition <span class="op">-</span> <span class="dv">10</span><span class="op">);</span></span>
<span id="cb118-242"><a href="#cb118-242" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">showText</span><span class="op">(</span><span class="st">&quot;This document contains confidential medical information.&quot;</span><span class="op">);</span></span>
<span id="cb118-243"><a href="#cb118-243" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">endText</span><span class="op">();</span></span>
<span id="cb118-244"><a href="#cb118-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-245"><a href="#cb118-245" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">beginText</span><span class="op">();</span></span>
<span id="cb118-246"><a href="#cb118-246" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">newLineAtOffset</span><span class="op">(</span><span class="dv">50</span><span class="op">,</span> yPosition <span class="op">-</span> <span class="dv">25</span><span class="op">);</span></span>
<span id="cb118-247"><a href="#cb118-247" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">showText</span><span class="op">(</span><span class="st">&quot;Generated by CareConnect Emergency Information System - For medical emergencies, contact 911 immediately.&quot;</span><span class="op">);</span></span>
<span id="cb118-248"><a href="#cb118-248" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">endText</span><span class="op">();</span></span>
<span id="cb118-249"><a href="#cb118-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-250"><a href="#cb118-250" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Generation timestamp</span></span>
<span id="cb118-251"><a href="#cb118-251" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">beginText</span><span class="op">();</span></span>
<span id="cb118-252"><a href="#cb118-252" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">newLineAtOffset</span><span class="op">(</span>pageWidth <span class="op">-</span> <span class="dv">200</span><span class="op">,</span> yPosition <span class="op">-</span> <span class="dv">10</span><span class="op">);</span></span>
<span id="cb118-253"><a href="#cb118-253" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">showText</span><span class="op">(</span><span class="st">&quot;Generated: &quot;</span> <span class="op">+</span> LocalDate<span class="op">.</span><span class="fu">now</span><span class="op">().</span><span class="fu">format</span><span class="op">(</span>DateTimeFormatter<span class="op">.</span><span class="fu">ofPattern</span><span class="op">(</span><span class="st">&quot;MM/dd/yyyy&quot;</span><span class="op">)));</span></span>
<span id="cb118-254"><a href="#cb118-254" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">endText</span><span class="op">();</span></span>
<span id="cb118-255"><a href="#cb118-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-256"><a href="#cb118-256" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">setNonStrokingColor</span><span class="op">(</span><span class="bu">Color</span><span class="op">.</span><span class="fu">BLACK</span><span class="op">);</span></span>
<span id="cb118-257"><a href="#cb118-257" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb118-258"><a href="#cb118-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-259"><a href="#cb118-259" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb118-260"><a href="#cb118-260" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> Helper method to draw section titles with background</span>
<span id="cb118-261"><a href="#cb118-261" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb118-262"><a href="#cb118-262" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">drawSectionTitle</span><span class="op">(</span>PDPageContentStream contentStream<span class="op">,</span> <span class="bu">String</span> title<span class="op">,</span> <span class="dt">float</span> margin<span class="op">,</span> <span class="dt">float</span> yPosition<span class="op">)</span> <span class="kw">throws</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb118-263"><a href="#cb118-263" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Background rectangle for section title</span></span>
<span id="cb118-264"><a href="#cb118-264" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">setNonStrokingColor</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Color</span><span class="op">(</span><span class="dv">240</span><span class="op">,</span> <span class="dv">240</span><span class="op">,</span> <span class="dv">240</span><span class="op">));</span></span>
<span id="cb118-265"><a href="#cb118-265" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">addRect</span><span class="op">(</span>margin <span class="op">-</span> <span class="dv">5</span><span class="op">,</span> yPosition <span class="op">-</span> <span class="dv">15</span><span class="op">,</span> <span class="dv">500</span><span class="op">,</span> <span class="dv">20</span><span class="op">);</span></span>
<span id="cb118-266"><a href="#cb118-266" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">fill</span><span class="op">();</span></span>
<span id="cb118-267"><a href="#cb118-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-268"><a href="#cb118-268" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Title text</span></span>
<span id="cb118-269"><a href="#cb118-269" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">beginText</span><span class="op">();</span></span>
<span id="cb118-270"><a href="#cb118-270" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">setFont</span><span class="op">(</span><span class="kw">new</span> <span class="fu">PDType1Font</span><span class="op">(</span>Standard14Fonts<span class="op">.</span><span class="fu">FontName</span><span class="op">.</span><span class="fu">HELVETICA_BOLD</span><span class="op">),</span> <span class="dv">12</span><span class="op">);</span></span>
<span id="cb118-271"><a href="#cb118-271" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">setNonStrokingColor</span><span class="op">(</span><span class="bu">Color</span><span class="op">.</span><span class="fu">BLACK</span><span class="op">);</span></span>
<span id="cb118-272"><a href="#cb118-272" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">newLineAtOffset</span><span class="op">(</span>margin<span class="op">,</span> yPosition <span class="op">-</span> <span class="dv">12</span><span class="op">);</span></span>
<span id="cb118-273"><a href="#cb118-273" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">showText</span><span class="op">(</span>title<span class="op">);</span></span>
<span id="cb118-274"><a href="#cb118-274" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">endText</span><span class="op">();</span></span>
<span id="cb118-275"><a href="#cb118-275" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb118-276"><a href="#cb118-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-277"><a href="#cb118-277" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb118-278"><a href="#cb118-278" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> Helper method for formatting information lines</span>
<span id="cb118-279"><a href="#cb118-279" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb118-280"><a href="#cb118-280" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">float</span> <span class="fu">drawInfoLine</span><span class="op">(</span>PDPageContentStream contentStream<span class="op">,</span> <span class="bu">String</span> label<span class="op">,</span> <span class="bu">String</span> value<span class="op">,</span> <span class="dt">float</span> margin<span class="op">,</span> <span class="dt">float</span> yPosition<span class="op">)</span> <span class="kw">throws</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb118-281"><a href="#cb118-281" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">beginText</span><span class="op">();</span></span>
<span id="cb118-282"><a href="#cb118-282" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">setFont</span><span class="op">(</span><span class="kw">new</span> <span class="fu">PDType1Font</span><span class="op">(</span>Standard14Fonts<span class="op">.</span><span class="fu">FontName</span><span class="op">.</span><span class="fu">HELVETICA_BOLD</span><span class="op">),</span> <span class="dv">10</span><span class="op">);</span></span>
<span id="cb118-283"><a href="#cb118-283" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">newLineAtOffset</span><span class="op">(</span>margin<span class="op">,</span> yPosition<span class="op">);</span></span>
<span id="cb118-284"><a href="#cb118-284" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">showText</span><span class="op">(</span>label<span class="op">);</span></span>
<span id="cb118-285"><a href="#cb118-285" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">endText</span><span class="op">();</span></span>
<span id="cb118-286"><a href="#cb118-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-287"><a href="#cb118-287" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>value<span class="op">.</span><span class="fu">isEmpty</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb118-288"><a href="#cb118-288" aria-hidden="true" tabindex="-1"></a>            contentStream<span class="op">.</span><span class="fu">beginText</span><span class="op">();</span></span>
<span id="cb118-289"><a href="#cb118-289" aria-hidden="true" tabindex="-1"></a>            contentStream<span class="op">.</span><span class="fu">setFont</span><span class="op">(</span><span class="kw">new</span> <span class="fu">PDType1Font</span><span class="op">(</span>Standard14Fonts<span class="op">.</span><span class="fu">FontName</span><span class="op">.</span><span class="fu">HELVETICA</span><span class="op">),</span> <span class="dv">10</span><span class="op">);</span></span>
<span id="cb118-290"><a href="#cb118-290" aria-hidden="true" tabindex="-1"></a>            contentStream<span class="op">.</span><span class="fu">newLineAtOffset</span><span class="op">(</span>margin <span class="op">+</span> <span class="dv">100</span><span class="op">,</span> yPosition<span class="op">);</span></span>
<span id="cb118-291"><a href="#cb118-291" aria-hidden="true" tabindex="-1"></a>            contentStream<span class="op">.</span><span class="fu">showText</span><span class="op">(</span>value<span class="op">);</span></span>
<span id="cb118-292"><a href="#cb118-292" aria-hidden="true" tabindex="-1"></a>            contentStream<span class="op">.</span><span class="fu">endText</span><span class="op">();</span></span>
<span id="cb118-293"><a href="#cb118-293" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb118-294"><a href="#cb118-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-295"><a href="#cb118-295" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> yPosition <span class="op">-</span> <span class="dv">18</span><span class="op">;</span></span>
<span id="cb118-296"><a href="#cb118-296" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb118-297"><a href="#cb118-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-298"><a href="#cb118-298" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb118-299"><a href="#cb118-299" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> Helper method for bullet point formatting</span>
<span id="cb118-300"><a href="#cb118-300" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb118-301"><a href="#cb118-301" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">float</span> <span class="fu">drawBulletPoint</span><span class="op">(</span>PDPageContentStream contentStream<span class="op">,</span> <span class="bu">String</span> text<span class="op">,</span> <span class="dt">float</span> margin<span class="op">,</span> <span class="dt">float</span> yPosition<span class="op">)</span> <span class="kw">throws</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb118-302"><a href="#cb118-302" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">beginText</span><span class="op">();</span></span>
<span id="cb118-303"><a href="#cb118-303" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">setFont</span><span class="op">(</span><span class="kw">new</span> <span class="fu">PDType1Font</span><span class="op">(</span>Standard14Fonts<span class="op">.</span><span class="fu">FontName</span><span class="op">.</span><span class="fu">HELVETICA</span><span class="op">),</span> <span class="dv">10</span><span class="op">);</span></span>
<span id="cb118-304"><a href="#cb118-304" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">newLineAtOffset</span><span class="op">(</span>margin<span class="op">,</span> yPosition<span class="op">);</span></span>
<span id="cb118-305"><a href="#cb118-305" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">showText</span><span class="op">(</span>text<span class="op">);</span></span>
<span id="cb118-306"><a href="#cb118-306" aria-hidden="true" tabindex="-1"></a>        contentStream<span class="op">.</span><span class="fu">endText</span><span class="op">();</span></span>
<span id="cb118-307"><a href="#cb118-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-308"><a href="#cb118-308" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> yPosition <span class="op">-</span> <span class="dv">15</span><span class="op">;</span></span>
<span id="cb118-309"><a href="#cb118-309" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb118-310"><a href="#cb118-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-311"><a href="#cb118-311" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb118-312"><a href="#cb118-312" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> Extract patient ID from emergency ID format<span class="co">:</span> VIAL123456</span>
<span id="cb118-313"><a href="#cb118-313" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb118-314"><a href="#cb118-314" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Long</span> <span class="fu">extractPatientIdFromEmergencyId</span><span class="op">(</span><span class="bu">String</span> emergencyId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-315"><a href="#cb118-315" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb118-316"><a href="#cb118-316" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>emergencyId<span class="op">.</span><span class="fu">startsWith</span><span class="op">(</span><span class="st">&quot;VIAL&quot;</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb118-317"><a href="#cb118-317" aria-hidden="true" tabindex="-1"></a>                <span class="bu">String</span> idPart <span class="op">=</span> emergencyId<span class="op">.</span><span class="fu">substring</span><span class="op">(</span><span class="dv">4</span><span class="op">);</span></span>
<span id="cb118-318"><a href="#cb118-318" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="bu">Long</span><span class="op">.</span><span class="fu">parseLong</span><span class="op">(</span>idPart<span class="op">);</span></span>
<span id="cb118-319"><a href="#cb118-319" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb118-320"><a href="#cb118-320" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">NumberFormatException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-321"><a href="#cb118-321" aria-hidden="true" tabindex="-1"></a>            logger<span class="op">.</span><span class="fu">error</span><span class="op">(</span><span class="st">&quot;Could not parse patient ID from emergency ID: {}&quot;</span><span class="op">,</span> emergencyId<span class="op">);</span></span>
<span id="cb118-322"><a href="#cb118-322" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb118-323"><a href="#cb118-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-324"><a href="#cb118-324" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">IllegalArgumentException</span><span class="op">(</span><span class="st">&quot;Invalid emergency ID format: &quot;</span> <span class="op">+</span> emergencyId<span class="op">);</span></span>
<span id="cb118-325"><a href="#cb118-325" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb118-326"><a href="#cb118-326" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="emergency-controller---public-access">Emergency Controller -
Public Access</h4>
<div class="sourceCode" id="cb119"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co">// controller/EmergencyController.java</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a><span class="at">@RestController</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/v1/api/emergency&quot;</span><span class="op">)</span></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a><span class="at">@Tag</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;Emergency Information&quot;</span><span class="op">,</span> description <span class="op">=</span> <span class="st">&quot;Emergency medical information and Vial of Life PDF generation&quot;</span><span class="op">)</span></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> EmergencyController <span class="op">{</span></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">Logger</span> logger <span class="op">=</span> LoggerFactory<span class="op">.</span><span class="fu">getLogger</span><span class="op">(</span>EmergencyController<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> VialOfLifePdfService vialOfLifePdfService<span class="op">;</span></span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> Generate and serve Vial of Life PDF for emergency use <span class="co">(</span>PUBLIC ACCESS<span class="co">)</span></span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb119-15"><a href="#cb119-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/{emergencyId}.pdf&quot;</span><span class="op">)</span></span>
<span id="cb119-16"><a href="#cb119-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Operation</span><span class="op">(</span></span>
<span id="cb119-17"><a href="#cb119-17" aria-hidden="true" tabindex="-1"></a>        summary <span class="op">=</span> <span class="st">&quot;🚨 Get Emergency PDF&quot;</span><span class="op">,</span></span>
<span id="cb119-18"><a href="#cb119-18" aria-hidden="true" tabindex="-1"></a>        description <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb119-19"><a href="#cb119-19" aria-hidden="true" tabindex="-1"></a><span class="st">            Generate a pre-filled Vial of Life PDF document for emergency responders.</span></span>
<span id="cb119-20"><a href="#cb119-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-21"><a href="#cb119-21" aria-hidden="true" tabindex="-1"></a><span class="st">            This endpoint is designed to be accessed via QR codes in emergency situations.</span></span>
<span id="cb119-22"><a href="#cb119-22" aria-hidden="true" tabindex="-1"></a><span class="st">            It returns an official Vial of Life form pre-populated with the patient&#39;s:</span></span>
<span id="cb119-23"><a href="#cb119-23" aria-hidden="true" tabindex="-1"></a><span class="st">            - Basic information (name, DOB, blood type)</span></span>
<span id="cb119-24"><a href="#cb119-24" aria-hidden="true" tabindex="-1"></a><span class="st">            - Critical allergies and medical conditions</span></span>
<span id="cb119-25"><a href="#cb119-25" aria-hidden="true" tabindex="-1"></a><span class="st">            - Current medications</span></span>
<span id="cb119-26"><a href="#cb119-26" aria-hidden="true" tabindex="-1"></a><span class="st">            - Emergency contact information</span></span>
<span id="cb119-27"><a href="#cb119-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-28"><a href="#cb119-28" aria-hidden="true" tabindex="-1"></a><span class="st">            **Security Note:** This endpoint uses emergency ID tokens for access control.</span></span>
<span id="cb119-29"><a href="#cb119-29" aria-hidden="true" tabindex="-1"></a><span class="st">            &quot;&quot;&quot;</span><span class="op">,</span></span>
<span id="cb119-30"><a href="#cb119-30" aria-hidden="true" tabindex="-1"></a>        tags <span class="op">=</span> <span class="op">{</span><span class="st">&quot;Emergency Information&quot;</span><span class="op">,</span> <span class="st">&quot;🚨 Emergency Response&quot;</span><span class="op">}</span></span>
<span id="cb119-31"><a href="#cb119-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span></span>
<span id="cb119-32"><a href="#cb119-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">@ApiResponses</span><span class="op">({</span></span>
<span id="cb119-33"><a href="#cb119-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">@ApiResponse</span><span class="op">(</span>responseCode <span class="op">=</span> <span class="st">&quot;200&quot;</span><span class="op">,</span> description <span class="op">=</span> <span class="st">&quot;PDF generated and returned successfully&quot;</span><span class="op">),</span></span>
<span id="cb119-34"><a href="#cb119-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">@ApiResponse</span><span class="op">(</span>responseCode <span class="op">=</span> <span class="st">&quot;404&quot;</span><span class="op">,</span> description <span class="op">=</span> <span class="st">&quot;Patient not found for emergency ID&quot;</span><span class="op">),</span></span>
<span id="cb119-35"><a href="#cb119-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">@ApiResponse</span><span class="op">(</span>responseCode <span class="op">=</span> <span class="st">&quot;500&quot;</span><span class="op">,</span> description <span class="op">=</span> <span class="st">&quot;Error generating PDF&quot;</span><span class="op">)</span></span>
<span id="cb119-36"><a href="#cb119-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">})</span></span>
<span id="cb119-37"><a href="#cb119-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ResponseEntity<span class="op">&lt;</span><span class="dt">byte</span><span class="op">[]&gt;</span> <span class="fu">getEmergencyPdf</span><span class="op">(</span></span>
<span id="cb119-38"><a href="#cb119-38" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Parameter</span><span class="op">(</span>description <span class="op">=</span> <span class="st">&quot;Emergency ID (format: VIAL123456)&quot;</span><span class="op">,</span> example <span class="op">=</span> <span class="st">&quot;VIAL123456&quot;</span><span class="op">)</span></span>
<span id="cb119-39"><a href="#cb119-39" aria-hidden="true" tabindex="-1"></a>            <span class="at">@PathVariable</span> <span class="bu">String</span> emergencyId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb119-40"><a href="#cb119-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-41"><a href="#cb119-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb119-42"><a href="#cb119-42" aria-hidden="true" tabindex="-1"></a>            logger<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;🚨 Emergency PDF request for ID: {}&quot;</span><span class="op">,</span> emergencyId<span class="op">);</span></span>
<span id="cb119-43"><a href="#cb119-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-44"><a href="#cb119-44" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Generate PDF</span></span>
<span id="cb119-45"><a href="#cb119-45" aria-hidden="true" tabindex="-1"></a>            <span class="dt">byte</span><span class="op">[]</span> pdfBytes <span class="op">=</span> vialOfLifePdfService<span class="op">.</span><span class="fu">generateVialOfLifePdf</span><span class="op">(</span>emergencyId<span class="op">);</span></span>
<span id="cb119-46"><a href="#cb119-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-47"><a href="#cb119-47" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Set response headers for PDF</span></span>
<span id="cb119-48"><a href="#cb119-48" aria-hidden="true" tabindex="-1"></a>            HttpHeaders headers <span class="op">=</span> <span class="kw">new</span> <span class="fu">HttpHeaders</span><span class="op">();</span></span>
<span id="cb119-49"><a href="#cb119-49" aria-hidden="true" tabindex="-1"></a>            headers<span class="op">.</span><span class="fu">setContentType</span><span class="op">(</span>MediaType<span class="op">.</span><span class="fu">APPLICATION_PDF</span><span class="op">);</span></span>
<span id="cb119-50"><a href="#cb119-50" aria-hidden="true" tabindex="-1"></a>            headers<span class="op">.</span><span class="fu">setContentDisposition</span><span class="op">(</span>ContentDisposition<span class="op">.</span><span class="fu">inline</span><span class="op">()</span></span>
<span id="cb119-51"><a href="#cb119-51" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">filename</span><span class="op">(</span><span class="st">&quot;vial_of_life_&quot;</span> <span class="op">+</span> emergencyId <span class="op">+</span> <span class="st">&quot;.pdf&quot;</span><span class="op">)</span></span>
<span id="cb119-52"><a href="#cb119-52" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">build</span><span class="op">());</span></span>
<span id="cb119-53"><a href="#cb119-53" aria-hidden="true" tabindex="-1"></a>            headers<span class="op">.</span><span class="fu">setContentLength</span><span class="op">(</span>pdfBytes<span class="op">.</span><span class="fu">length</span><span class="op">);</span></span>
<span id="cb119-54"><a href="#cb119-54" aria-hidden="true" tabindex="-1"></a>            headers<span class="op">.</span><span class="fu">setCacheControl</span><span class="op">(</span><span class="st">&quot;no-cache, no-store, must-revalidate&quot;</span><span class="op">);</span></span>
<span id="cb119-55"><a href="#cb119-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-56"><a href="#cb119-56" aria-hidden="true" tabindex="-1"></a>            logger<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;✅ Emergency PDF generated successfully for: {}&quot;</span><span class="op">,</span> emergencyId<span class="op">);</span></span>
<span id="cb119-57"><a href="#cb119-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">new</span> ResponseEntity<span class="op">&lt;&gt;(</span>pdfBytes<span class="op">,</span> headers<span class="op">,</span> HttpStatus<span class="op">.</span><span class="fu">OK</span><span class="op">);</span></span>
<span id="cb119-58"><a href="#cb119-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-59"><a href="#cb119-59" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IllegalArgumentException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb119-60"><a href="#cb119-60" aria-hidden="true" tabindex="-1"></a>            logger<span class="op">.</span><span class="fu">error</span><span class="op">(</span><span class="st">&quot;❌ Invalid emergency ID: {}&quot;</span><span class="op">,</span> emergencyId<span class="op">);</span></span>
<span id="cb119-61"><a href="#cb119-61" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> ResponseEntity<span class="op">.</span><span class="fu">notFound</span><span class="op">().</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb119-62"><a href="#cb119-62" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb119-63"><a href="#cb119-63" aria-hidden="true" tabindex="-1"></a>            logger<span class="op">.</span><span class="fu">error</span><span class="op">(</span><span class="st">&quot;💥 Error generating emergency PDF for ID: {}&quot;</span><span class="op">,</span> emergencyId<span class="op">,</span> e<span class="op">);</span></span>
<span id="cb119-64"><a href="#cb119-64" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> ResponseEntity<span class="op">.</span><span class="fu">status</span><span class="op">(</span>HttpStatus<span class="op">.</span><span class="fu">INTERNAL_SERVER_ERROR</span><span class="op">).</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb119-65"><a href="#cb119-65" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb119-66"><a href="#cb119-66" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb119-67"><a href="#cb119-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-68"><a href="#cb119-68" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb119-69"><a href="#cb119-69" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> Force download version of emergency PDF</span>
<span id="cb119-70"><a href="#cb119-70" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb119-71"><a href="#cb119-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/download/{emergencyId}.pdf&quot;</span><span class="op">)</span></span>
<span id="cb119-72"><a href="#cb119-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Operation</span><span class="op">(</span>summary <span class="op">=</span> <span class="st">&quot;Download Emergency PDF&quot;</span><span class="op">,</span> description <span class="op">=</span> <span class="st">&quot;Force download of Vial of Life PDF&quot;</span><span class="op">)</span></span>
<span id="cb119-73"><a href="#cb119-73" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ResponseEntity<span class="op">&lt;</span><span class="dt">byte</span><span class="op">[]&gt;</span> <span class="fu">downloadEmergencyPdf</span><span class="op">(</span><span class="at">@PathVariable</span> <span class="bu">String</span> emergencyId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb119-74"><a href="#cb119-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-75"><a href="#cb119-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb119-76"><a href="#cb119-76" aria-hidden="true" tabindex="-1"></a>            <span class="dt">byte</span><span class="op">[]</span> pdfBytes <span class="op">=</span> vialOfLifePdfService<span class="op">.</span><span class="fu">generateVialOfLifePdf</span><span class="op">(</span>emergencyId<span class="op">);</span></span>
<span id="cb119-77"><a href="#cb119-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-78"><a href="#cb119-78" aria-hidden="true" tabindex="-1"></a>            HttpHeaders headers <span class="op">=</span> <span class="kw">new</span> <span class="fu">HttpHeaders</span><span class="op">();</span></span>
<span id="cb119-79"><a href="#cb119-79" aria-hidden="true" tabindex="-1"></a>            headers<span class="op">.</span><span class="fu">setContentType</span><span class="op">(</span>MediaType<span class="op">.</span><span class="fu">APPLICATION_OCTET_STREAM</span><span class="op">);</span></span>
<span id="cb119-80"><a href="#cb119-80" aria-hidden="true" tabindex="-1"></a>            headers<span class="op">.</span><span class="fu">setContentDisposition</span><span class="op">(</span>ContentDisposition<span class="op">.</span><span class="fu">attachment</span><span class="op">()</span></span>
<span id="cb119-81"><a href="#cb119-81" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">filename</span><span class="op">(</span><span class="st">&quot;vial_of_life_&quot;</span> <span class="op">+</span> emergencyId <span class="op">+</span> <span class="st">&quot;.pdf&quot;</span><span class="op">)</span></span>
<span id="cb119-82"><a href="#cb119-82" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">build</span><span class="op">());</span></span>
<span id="cb119-83"><a href="#cb119-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-84"><a href="#cb119-84" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">new</span> ResponseEntity<span class="op">&lt;&gt;(</span>pdfBytes<span class="op">,</span> headers<span class="op">,</span> HttpStatus<span class="op">.</span><span class="fu">OK</span><span class="op">);</span></span>
<span id="cb119-85"><a href="#cb119-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-86"><a href="#cb119-86" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb119-87"><a href="#cb119-87" aria-hidden="true" tabindex="-1"></a>            logger<span class="op">.</span><span class="fu">error</span><span class="op">(</span><span class="st">&quot;Error generating downloadable emergency PDF&quot;</span><span class="op">,</span> e<span class="op">);</span></span>
<span id="cb119-88"><a href="#cb119-88" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> ResponseEntity<span class="op">.</span><span class="fu">status</span><span class="op">(</span>HttpStatus<span class="op">.</span><span class="fu">INTERNAL_SERVER_ERROR</span><span class="op">).</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb119-89"><a href="#cb119-89" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb119-90"><a href="#cb119-90" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb119-91"><a href="#cb119-91" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="security-configuration-1">Security Configuration</h3>
<h4 id="public-emergency-access">Public Emergency Access</h4>
<div class="sourceCode" id="cb120"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Emergency endpoints are configured as permitAll() in SecurityConfig</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="op">.</span><span class="fu">requestMatchers</span><span class="op">(</span><span class="st">&quot;/v1/api/emergency/**&quot;</span><span class="op">).</span><span class="fu">permitAll</span><span class="op">()</span>  <span class="co">// No authentication required</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a><span class="co">// JWT Authentication Filter excludes emergency endpoints</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">List</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> EXCLUDED_PATHS <span class="op">=</span> <span class="bu">Arrays</span><span class="op">.</span><span class="fu">asList</span><span class="op">(</span></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;/v1/api/emergency&quot;</span>  <span class="co">// Emergency PDF access (no auth required)</span></span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a><span class="op">);</span></span></code></pre></div>
<h3 id="emergency-id-format">Emergency ID Format</h3>
<ul>
<li><strong>Format</strong>: <code>VIAL{patientId}</code> (e.g.,
<code>VIAL123456</code>)</li>
<li><strong>Usage</strong>: Embedded in QR codes for first responder
access</li>
<li><strong>Security</strong>: Emergency IDs are not sensitive but
provide controlled access</li>
</ul>
<h3 id="qr-code-integration">QR Code Integration</h3>
<div class="sourceCode" id="cb121"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co">// QR Code generation for emergency access</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">generateEmergencyQRCode</span><span class="op">(</span><span class="bu">Long</span> patientId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> emergencyId <span class="op">=</span> <span class="st">&quot;VIAL&quot;</span> <span class="op">+</span> patientId<span class="op">;</span></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> emergencyUrl <span class="op">=</span> baseUrl <span class="op">+</span> <span class="st">&quot;/v1/api/emergency/&quot;</span> <span class="op">+</span> emergencyId <span class="op">+</span> <span class="st">&quot;.pdf&quot;</span><span class="op">;</span></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Generate QR code pointing to emergency PDF</span></span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> qrCodeService<span class="op">.</span><span class="fu">generateQRCode</span><span class="op">(</span>emergencyUrl<span class="op">);</span></span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="pdf-features">PDF Features</h3>
<h4 id="professional-medical-formatting">Professional Medical
Formatting</h4>
<ul>
<li><strong>Red Cross Header</strong>: Medical symbol for easy
identification</li>
<li><strong>Clear Typography</strong>: High-contrast fonts for
readability</li>
<li><strong>Structured Sections</strong>: Patient info, medical data,
emergency contacts</li>
<li><strong>Critical Allergies</strong>: Highlighted in red for
immediate attention</li>
<li><strong>Generation Timestamp</strong>: Shows when document was
created</li>
</ul>
<h4 id="information-included">Information Included</h4>
<ul>
<li><strong>Patient Demographics</strong>: Name, DOB, age, gender,
phone</li>
<li><strong>Critical Medical Data</strong>: Allergies with severity
levels</li>
<li><strong>Current Medications</strong>: Active medications with dosage
and frequency</li>
<li><strong>Emergency Contacts</strong>: Family members and caregivers
with contact info</li>
<li><strong>Legal Footer</strong>: Confidentiality notice and system
attribution</li>
</ul>
<h3 id="dependencies">Dependencies</h3>
<h4 id="maven-dependencies">Maven Dependencies</h4>
<div class="sourceCode" id="cb122"><pre
class="sourceCode xml"><code class="sourceCode xml"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Apache PDFBox for PDF generation --&gt;</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">groupId</span>&gt;org.apache.pdfbox&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">artifactId</span>&gt;pdfbox&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">version</span>&gt;3.0.0&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">dependency</span>&gt;</span></code></pre></div>
<h3 id="configuration-properties-1">Configuration Properties</h3>
<pre class="properties"><code># Vial of Life Configuration
careconnect.vial.enabled=true
careconnect.vial.base-url=${BASE_URL:http://localhost:8080}

# PDF Generation Settings
careconnect.pdf.cache.enabled=false  # Always generate fresh for emergencies
careconnect.pdf.quality=high</code></pre>
<h3 id="error-handling-2">Error Handling</h3>
<div class="sourceCode" id="cb124"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Comprehensive error handling for emergency situations</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="at">@ExceptionHandler</span><span class="op">(</span><span class="bu">IllegalArgumentException</span><span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> ResponseEntity<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> <span class="fu">handleInvalidEmergencyId</span><span class="op">(</span><span class="bu">IllegalArgumentException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>    logger<span class="op">.</span><span class="fu">warn</span><span class="op">(</span><span class="st">&quot;Invalid emergency ID provided: {}&quot;</span><span class="op">,</span> e<span class="op">.</span><span class="fu">getMessage</span><span class="op">());</span></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ResponseEntity<span class="op">.</span><span class="fu">status</span><span class="op">(</span>HttpStatus<span class="op">.</span><span class="fu">NOT_FOUND</span><span class="op">)</span></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">body</span><span class="op">(</span><span class="st">&quot;Emergency information not found&quot;</span><span class="op">);</span></span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a><span class="at">@ExceptionHandler</span><span class="op">(</span><span class="bu">Exception</span><span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> ResponseEntity<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> <span class="fu">handlePdfGenerationError</span><span class="op">(</span><span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>    logger<span class="op">.</span><span class="fu">error</span><span class="op">(</span><span class="st">&quot;PDF generation failed&quot;</span><span class="op">,</span> e<span class="op">);</span></span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ResponseEntity<span class="op">.</span><span class="fu">status</span><span class="op">(</span>HttpStatus<span class="op">.</span><span class="fu">INTERNAL_SERVER_ERROR</span><span class="op">)</span></span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">body</span><span class="op">(</span><span class="st">&quot;Emergency PDF temporarily unavailable&quot;</span><span class="op">);</span></span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="usage-example">Usage Example</h3>
<h4 id="emergency-access-url">Emergency Access URL</h4>
<pre><code>https://careconnect.example.com/v1/api/emergency/VIAL123456.pdf</code></pre>
<h4 id="qr-code-integration-1">QR Code Integration</h4>
<p>First responders scan QR code → Instantly access patient’s critical
medical information → Make informed emergency decisions</p>
<h3 id="future-enhancements-1">Future Enhancements</h3>
<ul>
<li><strong>Multi-language Support</strong>: Emergency PDFs in multiple
languages</li>
<li><strong>Photo Integration</strong>: Include patient photo for
identification</li>
<li><strong>Medical Conditions</strong>: Add chronic conditions and
recent procedures</li>
<li><strong>Insurance Information</strong>: Include insurance details
for billing</li>
<li><strong>Advanced Care Directives</strong>: Include DNR and other
care preferences</li>
<li><strong>Digital Signature</strong>: Cryptographic verification of
document authenticity</li>
</ul>
<h2 id="file-upload-management">File Upload &amp; Management</h2>
<h3 id="file-upload-service">File Upload Service</h3>
<div class="sourceCode" id="cb126"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="co">// service/FileUploadService.java</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> FileUploadService <span class="op">{</span></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Value</span><span class="op">(</span><span class="st">&quot;${app.upload.dir}&quot;</span><span class="op">)</span></span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> uploadDir<span class="op">;</span></span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> UserFileRepository userFileRepository<span class="op">;</span></span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> UserFileDTO <span class="fu">uploadFile</span><span class="op">(</span>MultipartFile file<span class="op">,</span> <span class="bu">Long</span> userId<span class="op">,</span> <span class="bu">String</span> category<span class="op">)</span> <span class="op">{</span></span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">validateFile</span><span class="op">(</span>file<span class="op">);</span></span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-13"><a href="#cb126-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> fileName <span class="op">=</span> <span class="fu">generateUniqueFileName</span><span class="op">(</span>file<span class="op">.</span><span class="fu">getOriginalFilename</span><span class="op">());</span></span>
<span id="cb126-14"><a href="#cb126-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> filePath <span class="op">=</span> uploadDir <span class="op">+</span> <span class="st">&quot;/&quot;</span> <span class="op">+</span> userId <span class="op">+</span> <span class="st">&quot;/&quot;</span> <span class="op">+</span> category <span class="op">+</span> <span class="st">&quot;/&quot;</span> <span class="op">+</span> fileName<span class="op">;</span></span>
<span id="cb126-15"><a href="#cb126-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-16"><a href="#cb126-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb126-17"><a href="#cb126-17" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Create directory if not exists</span></span>
<span id="cb126-18"><a href="#cb126-18" aria-hidden="true" tabindex="-1"></a>            Files<span class="op">.</span><span class="fu">createDirectories</span><span class="op">(</span>Paths<span class="op">.</span><span class="fu">get</span><span class="op">(</span>filePath<span class="op">).</span><span class="fu">getParent</span><span class="op">());</span></span>
<span id="cb126-19"><a href="#cb126-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-20"><a href="#cb126-20" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Save file</span></span>
<span id="cb126-21"><a href="#cb126-21" aria-hidden="true" tabindex="-1"></a>            Files<span class="op">.</span><span class="fu">copy</span><span class="op">(</span>file<span class="op">.</span><span class="fu">getInputStream</span><span class="op">(),</span> Paths<span class="op">.</span><span class="fu">get</span><span class="op">(</span>filePath<span class="op">));</span></span>
<span id="cb126-22"><a href="#cb126-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-23"><a href="#cb126-23" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Save metadata to database</span></span>
<span id="cb126-24"><a href="#cb126-24" aria-hidden="true" tabindex="-1"></a>            UserFile userFile <span class="op">=</span> <span class="kw">new</span> <span class="fu">UserFile</span><span class="op">();</span></span>
<span id="cb126-25"><a href="#cb126-25" aria-hidden="true" tabindex="-1"></a>            userFile<span class="op">.</span><span class="fu">setUserId</span><span class="op">(</span>userId<span class="op">);</span></span>
<span id="cb126-26"><a href="#cb126-26" aria-hidden="true" tabindex="-1"></a>            userFile<span class="op">.</span><span class="fu">setFileName</span><span class="op">(</span>file<span class="op">.</span><span class="fu">getOriginalFilename</span><span class="op">());</span></span>
<span id="cb126-27"><a href="#cb126-27" aria-hidden="true" tabindex="-1"></a>            userFile<span class="op">.</span><span class="fu">setFilePath</span><span class="op">(</span>filePath<span class="op">);</span></span>
<span id="cb126-28"><a href="#cb126-28" aria-hidden="true" tabindex="-1"></a>            userFile<span class="op">.</span><span class="fu">setFileSize</span><span class="op">(</span>file<span class="op">.</span><span class="fu">getSize</span><span class="op">());</span></span>
<span id="cb126-29"><a href="#cb126-29" aria-hidden="true" tabindex="-1"></a>            userFile<span class="op">.</span><span class="fu">setContentType</span><span class="op">(</span>file<span class="op">.</span><span class="fu">getContentType</span><span class="op">());</span></span>
<span id="cb126-30"><a href="#cb126-30" aria-hidden="true" tabindex="-1"></a>            userFile<span class="op">.</span><span class="fu">setCategory</span><span class="op">(</span>category<span class="op">);</span></span>
<span id="cb126-31"><a href="#cb126-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-32"><a href="#cb126-32" aria-hidden="true" tabindex="-1"></a>            userFile <span class="op">=</span> userFileRepository<span class="op">.</span><span class="fu">save</span><span class="op">(</span>userFile<span class="op">);</span></span>
<span id="cb126-33"><a href="#cb126-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-34"><a href="#cb126-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fu">convertToDTO</span><span class="op">(</span>userFile<span class="op">);</span></span>
<span id="cb126-35"><a href="#cb126-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-36"><a href="#cb126-36" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb126-37"><a href="#cb126-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">FileStorageException</span><span class="op">(</span><span class="st">&quot;Could not store file &quot;</span> <span class="op">+</span> fileName<span class="op">,</span> e<span class="op">);</span></span>
<span id="cb126-38"><a href="#cb126-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb126-39"><a href="#cb126-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb126-40"><a href="#cb126-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-41"><a href="#cb126-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">validateFile</span><span class="op">(</span>MultipartFile file<span class="op">)</span> <span class="op">{</span></span>
<span id="cb126-42"><a href="#cb126-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>file<span class="op">.</span><span class="fu">isEmpty</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb126-43"><a href="#cb126-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">FileStorageException</span><span class="op">(</span><span class="st">&quot;Cannot store empty file&quot;</span><span class="op">);</span></span>
<span id="cb126-44"><a href="#cb126-44" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb126-45"><a href="#cb126-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-46"><a href="#cb126-46" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check file size (10MB limit)</span></span>
<span id="cb126-47"><a href="#cb126-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>file<span class="op">.</span><span class="fu">getSize</span><span class="op">()</span> <span class="op">&gt;</span> <span class="dv">10</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb126-48"><a href="#cb126-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">FileStorageException</span><span class="op">(</span><span class="st">&quot;File size exceeds 10MB limit&quot;</span><span class="op">);</span></span>
<span id="cb126-49"><a href="#cb126-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb126-50"><a href="#cb126-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-51"><a href="#cb126-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check file type</span></span>
<span id="cb126-52"><a href="#cb126-52" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> contentType <span class="op">=</span> file<span class="op">.</span><span class="fu">getContentType</span><span class="op">();</span></span>
<span id="cb126-53"><a href="#cb126-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span><span class="fu">isAllowedContentType</span><span class="op">(</span>contentType<span class="op">))</span> <span class="op">{</span></span>
<span id="cb126-54"><a href="#cb126-54" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">FileStorageException</span><span class="op">(</span><span class="st">&quot;File type not allowed: &quot;</span> <span class="op">+</span> contentType<span class="op">);</span></span>
<span id="cb126-55"><a href="#cb126-55" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb126-56"><a href="#cb126-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb126-57"><a href="#cb126-57" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="frontend-file-upload">Frontend File Upload</h3>
<div class="sourceCode" id="cb127"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co">// services/file_upload_service.dart</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FileUploadService {</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> ApiClient _apiClient;</span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span>UploadedFile<span class="op">&gt;</span> uploadFile(File file<span class="op">,</span> <span class="dt">String</span> category) <span class="at">async</span> {</span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">String</span> fileName <span class="op">=</span> path<span class="op">.</span>basename(file<span class="op">.</span>path);</span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>      FormData formData <span class="op">=</span> FormData<span class="op">.</span>fromMap({</span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;file&#39;</span><span class="op">:</span> <span class="at">await</span> MultipartFile<span class="op">.</span>fromFile(file<span class="op">.</span>path<span class="op">,</span> filename<span class="op">:</span> fileName)<span class="op">,</span></span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;category&#39;</span><span class="op">:</span> category<span class="op">,</span></span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>      });</span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">final</span> response <span class="op">=</span> <span class="at">await</span> _apiClient<span class="op">.</span>post(</span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;/api/files/upload&#39;</span><span class="op">,</span></span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a>        data<span class="op">:</span> formData<span class="op">,</span></span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a>        options<span class="op">:</span> Options(</span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a>          headers<span class="op">:</span> {<span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;multipart/form-data&#39;</span>}<span class="op">,</span></span>
<span id="cb127-19"><a href="#cb127-19" aria-hidden="true" tabindex="-1"></a>        )<span class="op">,</span></span>
<span id="cb127-20"><a href="#cb127-20" aria-hidden="true" tabindex="-1"></a>        onSendProgress<span class="op">:</span> (sent<span class="op">,</span> total) {</span>
<span id="cb127-21"><a href="#cb127-21" aria-hidden="true" tabindex="-1"></a>          <span class="co">// Update upload progress</span></span>
<span id="cb127-22"><a href="#cb127-22" aria-hidden="true" tabindex="-1"></a>          <span class="dt">double</span> progress <span class="op">=</span> sent <span class="op">/</span> total;</span>
<span id="cb127-23"><a href="#cb127-23" aria-hidden="true" tabindex="-1"></a>          _uploadProgressController<span class="op">.</span>add(progress);</span>
<span id="cb127-24"><a href="#cb127-24" aria-hidden="true" tabindex="-1"></a>        }<span class="op">,</span></span>
<span id="cb127-25"><a href="#cb127-25" aria-hidden="true" tabindex="-1"></a>      );</span>
<span id="cb127-26"><a href="#cb127-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-27"><a href="#cb127-27" aria-hidden="true" tabindex="-1"></a>      <span class="kw">return</span> UploadedFile<span class="op">.</span>fromJson(response<span class="op">.</span>data);</span>
<span id="cb127-28"><a href="#cb127-28" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (e) {</span>
<span id="cb127-29"><a href="#cb127-29" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> FileUploadException(<span class="st">&#39;Upload failed: $e&#39;</span>);</span>
<span id="cb127-30"><a href="#cb127-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb127-31"><a href="#cb127-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb127-32"><a href="#cb127-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-33"><a href="#cb127-33" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">List</span><span class="op">&lt;</span>UploadedFile<span class="op">&gt;&gt;</span> getUserFiles(<span class="dt">String</span><span class="op">?</span> category) <span class="at">async</span> {</span>
<span id="cb127-34"><a href="#cb127-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb127-35"><a href="#cb127-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">final</span> response <span class="op">=</span> <span class="at">await</span> _apiClient<span class="op">.</span><span class="kw">get</span>(</span>
<span id="cb127-36"><a href="#cb127-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;/api/files&#39;</span><span class="op">,</span></span>
<span id="cb127-37"><a href="#cb127-37" aria-hidden="true" tabindex="-1"></a>        queryParameters<span class="op">:</span> category <span class="op">!=</span> <span class="cn">null</span> <span class="op">?</span> {<span class="st">&#39;category&#39;</span><span class="op">:</span> category} <span class="op">:</span> <span class="cn">null</span><span class="op">,</span></span>
<span id="cb127-38"><a href="#cb127-38" aria-hidden="true" tabindex="-1"></a>      );</span>
<span id="cb127-39"><a href="#cb127-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-40"><a href="#cb127-40" aria-hidden="true" tabindex="-1"></a>      <span class="kw">return</span> (response<span class="op">.</span>data <span class="kw">as</span> <span class="dt">List</span>)</span>
<span id="cb127-41"><a href="#cb127-41" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span>map((json) <span class="op">=&gt;</span> UploadedFile<span class="op">.</span>fromJson(json))</span>
<span id="cb127-42"><a href="#cb127-42" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span>toList();</span>
<span id="cb127-43"><a href="#cb127-43" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (e) {</span>
<span id="cb127-44"><a href="#cb127-44" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> FileUploadException(<span class="st">&#39;Failed to fetch files: $e&#39;</span>);</span>
<span id="cb127-45"><a href="#cb127-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb127-46"><a href="#cb127-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb127-47"><a href="#cb127-47" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 id="testing-strategies">Testing Strategies</h2>
<h3 id="unit-testing-flutter">Unit Testing (Flutter)</h3>
<div class="sourceCode" id="cb128"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="co">// test/services/health_service_test.dart</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> main() {</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>  group(<span class="st">&#39;HealthService&#39;</span><span class="op">,</span> () {</span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">late</span> HealthService healthService;</span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">late</span> MockApiClient mockApiClient;</span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>    setUp(() {</span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>      mockApiClient <span class="op">=</span> MockApiClient();</span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>      healthService <span class="op">=</span> HealthService(mockApiClient);</span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a>    });</span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a>    test(<span class="st">&#39;should fetch vital signs successfully&#39;</span><span class="op">,</span> () <span class="at">async</span> {</span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Arrange</span></span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">final</span> mockResponse <span class="op">=</span> [</span>
<span id="cb128-15"><a href="#cb128-15" aria-hidden="true" tabindex="-1"></a>        {<span class="st">&#39;id&#39;</span><span class="op">:</span> <span class="st">&#39;1&#39;</span><span class="op">,</span> <span class="st">&#39;type&#39;</span><span class="op">:</span> <span class="st">&#39;blood_pressure&#39;</span><span class="op">,</span> <span class="st">&#39;value&#39;</span><span class="op">:</span> <span class="fl">120.0</span><span class="op">,</span> <span class="st">&#39;unit&#39;</span><span class="op">:</span> <span class="st">&#39;mmHg&#39;</span>}</span>
<span id="cb128-16"><a href="#cb128-16" aria-hidden="true" tabindex="-1"></a>      ];</span>
<span id="cb128-17"><a href="#cb128-17" aria-hidden="true" tabindex="-1"></a>      when(mockApiClient<span class="op">.</span><span class="kw">get</span>(<span class="st">&#39;/api/health/vitals&#39;</span>))</span>
<span id="cb128-18"><a href="#cb128-18" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span>thenAnswer((_) <span class="at">async</span> <span class="op">=&gt;</span> Response(data<span class="op">:</span> mockResponse<span class="op">,</span> statusCode<span class="op">:</span> <span class="dv">200</span>));</span>
<span id="cb128-19"><a href="#cb128-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-20"><a href="#cb128-20" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Act</span></span>
<span id="cb128-21"><a href="#cb128-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">final</span> result <span class="op">=</span> <span class="at">await</span> healthService<span class="op">.</span>getVitalSigns();</span>
<span id="cb128-22"><a href="#cb128-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-23"><a href="#cb128-23" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Assert</span></span>
<span id="cb128-24"><a href="#cb128-24" aria-hidden="true" tabindex="-1"></a>      expect(result<span class="op">,</span> isA<span class="op">&lt;</span><span class="dt">List</span><span class="op">&lt;</span>VitalSign<span class="op">&gt;&gt;</span>());</span>
<span id="cb128-25"><a href="#cb128-25" aria-hidden="true" tabindex="-1"></a>      expect(result<span class="op">.</span>length<span class="op">,</span> equals(<span class="dv">1</span>));</span>
<span id="cb128-26"><a href="#cb128-26" aria-hidden="true" tabindex="-1"></a>      expect(result<span class="op">.</span>first<span class="op">.</span>type<span class="op">,</span> equals(<span class="st">&#39;blood_pressure&#39;</span>));</span>
<span id="cb128-27"><a href="#cb128-27" aria-hidden="true" tabindex="-1"></a>    });</span>
<span id="cb128-28"><a href="#cb128-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-29"><a href="#cb128-29" aria-hidden="true" tabindex="-1"></a>    test(<span class="st">&#39;should throw exception on network error&#39;</span><span class="op">,</span> () <span class="at">async</span> {</span>
<span id="cb128-30"><a href="#cb128-30" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Arrange</span></span>
<span id="cb128-31"><a href="#cb128-31" aria-hidden="true" tabindex="-1"></a>      when(mockApiClient<span class="op">.</span><span class="kw">get</span>(<span class="st">&#39;/api/health/vitals&#39;</span>))</span>
<span id="cb128-32"><a href="#cb128-32" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span>thenThrow(DioException(requestOptions<span class="op">:</span> RequestOptions()));</span>
<span id="cb128-33"><a href="#cb128-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-34"><a href="#cb128-34" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Act &amp; Assert</span></span>
<span id="cb128-35"><a href="#cb128-35" aria-hidden="true" tabindex="-1"></a>      expect(() <span class="op">=&gt;</span> healthService<span class="op">.</span>getVitalSigns()<span class="op">,</span></span>
<span id="cb128-36"><a href="#cb128-36" aria-hidden="true" tabindex="-1"></a>             throwsA(isA<span class="op">&lt;</span>HealthException<span class="op">&gt;</span>()));</span>
<span id="cb128-37"><a href="#cb128-37" aria-hidden="true" tabindex="-1"></a>    });</span>
<span id="cb128-38"><a href="#cb128-38" aria-hidden="true" tabindex="-1"></a>  });</span>
<span id="cb128-39"><a href="#cb128-39" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="integration-testing-spring-boot">Integration Testing (Spring
Boot)</h3>
<div class="sourceCode" id="cb129"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co">// test/integration/HealthControllerIntegrationTest.java</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="at">@SpringBootTest</span><span class="op">(</span>webEnvironment <span class="op">=</span> SpringBootTest<span class="op">.</span><span class="fu">WebEnvironment</span><span class="op">.</span><span class="fu">RANDOM_PORT</span><span class="op">)</span></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a><span class="at">@AutoConfigureTestDatabase</span><span class="op">(</span>replace <span class="op">=</span> AutoConfigureTestDatabase<span class="op">.</span><span class="fu">Replace</span><span class="op">.</span><span class="fu">ANY</span><span class="op">)</span></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a><span class="at">@Transactional</span></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HealthControllerIntegrationTest <span class="op">{</span></span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> TestRestTemplate restTemplate<span class="op">;</span></span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> UserRepository userRepository<span class="op">;</span></span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb129-14"><a href="#cb129-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> JwtUtil jwtUtil<span class="op">;</span></span>
<span id="cb129-15"><a href="#cb129-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-16"><a href="#cb129-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> jwtToken<span class="op">;</span></span>
<span id="cb129-17"><a href="#cb129-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> User testUser<span class="op">;</span></span>
<span id="cb129-18"><a href="#cb129-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-19"><a href="#cb129-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">@BeforeEach</span></span>
<span id="cb129-20"><a href="#cb129-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">setUp</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb129-21"><a href="#cb129-21" aria-hidden="true" tabindex="-1"></a>        testUser <span class="op">=</span> <span class="fu">createTestUser</span><span class="op">();</span></span>
<span id="cb129-22"><a href="#cb129-22" aria-hidden="true" tabindex="-1"></a>        userRepository<span class="op">.</span><span class="fu">save</span><span class="op">(</span>testUser<span class="op">);</span></span>
<span id="cb129-23"><a href="#cb129-23" aria-hidden="true" tabindex="-1"></a>        jwtToken <span class="op">=</span> jwtUtil<span class="op">.</span><span class="fu">generateToken</span><span class="op">(</span><span class="kw">new</span> <span class="fu">UserPrincipal</span><span class="op">(</span>testUser<span class="op">));</span></span>
<span id="cb129-24"><a href="#cb129-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb129-25"><a href="#cb129-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-26"><a href="#cb129-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Test</span></span>
<span id="cb129-27"><a href="#cb129-27" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">shouldReturnVitalSignsForAuthenticatedUser</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb129-28"><a href="#cb129-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Arrange</span></span>
<span id="cb129-29"><a href="#cb129-29" aria-hidden="true" tabindex="-1"></a>        HttpHeaders headers <span class="op">=</span> <span class="kw">new</span> <span class="fu">HttpHeaders</span><span class="op">();</span></span>
<span id="cb129-30"><a href="#cb129-30" aria-hidden="true" tabindex="-1"></a>        headers<span class="op">.</span><span class="fu">setBearerAuth</span><span class="op">(</span>jwtToken<span class="op">);</span></span>
<span id="cb129-31"><a href="#cb129-31" aria-hidden="true" tabindex="-1"></a>        HttpEntity<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> entity <span class="op">=</span> <span class="kw">new</span> HttpEntity<span class="op">&lt;&gt;(</span>headers<span class="op">);</span></span>
<span id="cb129-32"><a href="#cb129-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-33"><a href="#cb129-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Act</span></span>
<span id="cb129-34"><a href="#cb129-34" aria-hidden="true" tabindex="-1"></a>        ResponseEntity<span class="op">&lt;</span><span class="bu">List</span><span class="op">&gt;</span> response <span class="op">=</span> restTemplate<span class="op">.</span><span class="fu">exchange</span><span class="op">(</span></span>
<span id="cb129-35"><a href="#cb129-35" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;/api/health/vitals&quot;</span><span class="op">,</span></span>
<span id="cb129-36"><a href="#cb129-36" aria-hidden="true" tabindex="-1"></a>            HttpMethod<span class="op">.</span><span class="fu">GET</span><span class="op">,</span></span>
<span id="cb129-37"><a href="#cb129-37" aria-hidden="true" tabindex="-1"></a>            entity<span class="op">,</span></span>
<span id="cb129-38"><a href="#cb129-38" aria-hidden="true" tabindex="-1"></a>            <span class="bu">List</span><span class="op">.</span><span class="fu">class</span></span>
<span id="cb129-39"><a href="#cb129-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb129-40"><a href="#cb129-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-41"><a href="#cb129-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Assert</span></span>
<span id="cb129-42"><a href="#cb129-42" aria-hidden="true" tabindex="-1"></a>        <span class="fu">assertEquals</span><span class="op">(</span>HttpStatus<span class="op">.</span><span class="fu">OK</span><span class="op">,</span> response<span class="op">.</span><span class="fu">getStatusCode</span><span class="op">());</span></span>
<span id="cb129-43"><a href="#cb129-43" aria-hidden="true" tabindex="-1"></a>        <span class="fu">assertNotNull</span><span class="op">(</span>response<span class="op">.</span><span class="fu">getBody</span><span class="op">());</span></span>
<span id="cb129-44"><a href="#cb129-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb129-45"><a href="#cb129-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-46"><a href="#cb129-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Test</span></span>
<span id="cb129-47"><a href="#cb129-47" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">shouldCreateVitalSignSuccessfully</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb129-48"><a href="#cb129-48" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Arrange</span></span>
<span id="cb129-49"><a href="#cb129-49" aria-hidden="true" tabindex="-1"></a>        VitalSignDTO vitalSign <span class="op">=</span> VitalSignDTO<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb129-50"><a href="#cb129-50" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">type</span><span class="op">(</span><span class="st">&quot;blood_pressure&quot;</span><span class="op">)</span></span>
<span id="cb129-51"><a href="#cb129-51" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">value</span><span class="op">(</span><span class="fl">120.0</span><span class="op">)</span></span>
<span id="cb129-52"><a href="#cb129-52" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">unit</span><span class="op">(</span><span class="st">&quot;mmHg&quot;</span><span class="op">)</span></span>
<span id="cb129-53"><a href="#cb129-53" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb129-54"><a href="#cb129-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-55"><a href="#cb129-55" aria-hidden="true" tabindex="-1"></a>        HttpHeaders headers <span class="op">=</span> <span class="kw">new</span> <span class="fu">HttpHeaders</span><span class="op">();</span></span>
<span id="cb129-56"><a href="#cb129-56" aria-hidden="true" tabindex="-1"></a>        headers<span class="op">.</span><span class="fu">setBearerAuth</span><span class="op">(</span>jwtToken<span class="op">);</span></span>
<span id="cb129-57"><a href="#cb129-57" aria-hidden="true" tabindex="-1"></a>        headers<span class="op">.</span><span class="fu">setContentType</span><span class="op">(</span>MediaType<span class="op">.</span><span class="fu">APPLICATION_JSON</span><span class="op">);</span></span>
<span id="cb129-58"><a href="#cb129-58" aria-hidden="true" tabindex="-1"></a>        HttpEntity<span class="op">&lt;</span>VitalSignDTO<span class="op">&gt;</span> entity <span class="op">=</span> <span class="kw">new</span> HttpEntity<span class="op">&lt;&gt;(</span>vitalSign<span class="op">,</span> headers<span class="op">);</span></span>
<span id="cb129-59"><a href="#cb129-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-60"><a href="#cb129-60" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Act</span></span>
<span id="cb129-61"><a href="#cb129-61" aria-hidden="true" tabindex="-1"></a>        ResponseEntity<span class="op">&lt;</span>VitalSignDTO<span class="op">&gt;</span> response <span class="op">=</span> restTemplate<span class="op">.</span><span class="fu">exchange</span><span class="op">(</span></span>
<span id="cb129-62"><a href="#cb129-62" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;/api/health/vitals&quot;</span><span class="op">,</span></span>
<span id="cb129-63"><a href="#cb129-63" aria-hidden="true" tabindex="-1"></a>            HttpMethod<span class="op">.</span><span class="fu">POST</span><span class="op">,</span></span>
<span id="cb129-64"><a href="#cb129-64" aria-hidden="true" tabindex="-1"></a>            entity<span class="op">,</span></span>
<span id="cb129-65"><a href="#cb129-65" aria-hidden="true" tabindex="-1"></a>            VitalSignDTO<span class="op">.</span><span class="fu">class</span></span>
<span id="cb129-66"><a href="#cb129-66" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb129-67"><a href="#cb129-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-68"><a href="#cb129-68" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Assert</span></span>
<span id="cb129-69"><a href="#cb129-69" aria-hidden="true" tabindex="-1"></a>        <span class="fu">assertEquals</span><span class="op">(</span>HttpStatus<span class="op">.</span><span class="fu">CREATED</span><span class="op">,</span> response<span class="op">.</span><span class="fu">getStatusCode</span><span class="op">());</span></span>
<span id="cb129-70"><a href="#cb129-70" aria-hidden="true" tabindex="-1"></a>        <span class="fu">assertNotNull</span><span class="op">(</span>response<span class="op">.</span><span class="fu">getBody</span><span class="op">());</span></span>
<span id="cb129-71"><a href="#cb129-71" aria-hidden="true" tabindex="-1"></a>        <span class="fu">assertEquals</span><span class="op">(</span><span class="st">&quot;blood_pressure&quot;</span><span class="op">,</span> response<span class="op">.</span><span class="fu">getBody</span><span class="op">().</span><span class="fu">getType</span><span class="op">());</span></span>
<span id="cb129-72"><a href="#cb129-72" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb129-73"><a href="#cb129-73" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="end-to-end-testing">End-to-End Testing</h3>
<div class="sourceCode" id="cb130"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co">// integration_test/app_test.dart</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> main() {</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>  group(<span class="st">&#39;CareConnect E2E Tests&#39;</span><span class="op">,</span> () {</span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>    testWidgets(<span class="st">&#39;complete user journey&#39;</span><span class="op">,</span> (tester) <span class="at">async</span> {</span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>      app<span class="op">.</span>main();</span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">await</span> tester<span class="op">.</span>pumpAndSettle();</span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Login flow</span></span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">await</span> tester<span class="op">.</span>enterText(find<span class="op">.</span>byKey(Key(<span class="st">&#39;email_field&#39;</span>))<span class="op">,</span> <span class="st">&#39;test@example.com&#39;</span>);</span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">await</span> tester<span class="op">.</span>enterText(find<span class="op">.</span>byKey(Key(<span class="st">&#39;password_field&#39;</span>))<span class="op">,</span> <span class="st">&#39;password123&#39;</span>);</span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">await</span> tester<span class="op">.</span>tap(find<span class="op">.</span>byKey(Key(<span class="st">&#39;login_button&#39;</span>)));</span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">await</span> tester<span class="op">.</span>pumpAndSettle();</span>
<span id="cb130-13"><a href="#cb130-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-14"><a href="#cb130-14" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Verify dashboard is loaded</span></span>
<span id="cb130-15"><a href="#cb130-15" aria-hidden="true" tabindex="-1"></a>      expect(find<span class="op">.</span>text(<span class="st">&#39;Dashboard&#39;</span>)<span class="op">,</span> findsOneWidget);</span>
<span id="cb130-16"><a href="#cb130-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-17"><a href="#cb130-17" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Navigate to health section</span></span>
<span id="cb130-18"><a href="#cb130-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">await</span> tester<span class="op">.</span>tap(find<span class="op">.</span>byKey(Key(<span class="st">&#39;health_tab&#39;</span>)));</span>
<span id="cb130-19"><a href="#cb130-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">await</span> tester<span class="op">.</span>pumpAndSettle();</span>
<span id="cb130-20"><a href="#cb130-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-21"><a href="#cb130-21" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Record vital sign</span></span>
<span id="cb130-22"><a href="#cb130-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">await</span> tester<span class="op">.</span>tap(find<span class="op">.</span>byKey(Key(<span class="st">&#39;add_vital_button&#39;</span>)));</span>
<span id="cb130-23"><a href="#cb130-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">await</span> tester<span class="op">.</span>pumpAndSettle();</span>
<span id="cb130-24"><a href="#cb130-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-25"><a href="#cb130-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">await</span> tester<span class="op">.</span>enterText(find<span class="op">.</span>byKey(Key(<span class="st">&#39;vital_value&#39;</span>))<span class="op">,</span> <span class="st">&#39;120&#39;</span>);</span>
<span id="cb130-26"><a href="#cb130-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">await</span> tester<span class="op">.</span>tap(find<span class="op">.</span>byKey(Key(<span class="st">&#39;save_vital_button&#39;</span>)));</span>
<span id="cb130-27"><a href="#cb130-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">await</span> tester<span class="op">.</span>pumpAndSettle();</span>
<span id="cb130-28"><a href="#cb130-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-29"><a href="#cb130-29" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Verify vital sign was saved</span></span>
<span id="cb130-30"><a href="#cb130-30" aria-hidden="true" tabindex="-1"></a>      expect(find<span class="op">.</span>text(<span class="st">&#39;120&#39;</span>)<span class="op">,</span> findsOneWidget);</span>
<span id="cb130-31"><a href="#cb130-31" aria-hidden="true" tabindex="-1"></a>    });</span>
<span id="cb130-32"><a href="#cb130-32" aria-hidden="true" tabindex="-1"></a>  });</span>
<span id="cb130-33"><a href="#cb130-33" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 id="performance-optimization">Performance Optimization</h2>
<p>Performance is critical in healthcare applications where delays can
affect patient care. CareConnect employs multiple optimization
strategies across the frontend, backend, and database layers to ensure
responsive user experiences even under heavy load. This section covers
practical performance patterns we’ve implemented and why they
matter.</p>
<h3
id="frontend-optimization-efficient-data-loading-and-rendering">Frontend
Optimization: Efficient Data Loading and Rendering</h3>
<p>Flutter applications can handle thousands of list items efficiently
if properly optimized. However, loading all data at once wastes memory
and slows initial render time. CareConnect uses lazy loading
(pagination) to load data incrementally as users scroll, providing
instant initial load times while still allowing access to complete
datasets.</p>
<h4 id="infinite-scroll-pattern-with-pagination">Infinite Scroll Pattern
with Pagination</h4>
<p>The infinite scroll pattern loads a small initial dataset (e.g., 20
items) and fetches more as the user scrolls to the bottom. This
provides: - <strong>Fast Initial Load</strong>: Only 20 items loaded, so
app feels instant - <strong>Memory Efficiency</strong>: Old items can be
garbage collected as list grows - <strong>Seamless UX</strong>: No “load
more” buttons, natural scrolling experience - <strong>Backend
Efficiency</strong>: Smaller queries, less database load</p>
<p><strong>Implementation with Detailed Explanation</strong>:</p>
<div class="sourceCode" id="cb131"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Lazy loading and performance optimizations</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a><span class="co">// This widget demonstrates infinite scroll for vital signs history</span></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Pattern is reusable for any large list (messages, medications, appointments)</span></span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OptimizedListView <span class="kw">extends</span> StatefulWidget {</span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>  _OptimizedListViewState createState() <span class="op">=&gt;</span> _OptimizedListViewState();</span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> _OptimizedListViewState <span class="kw">extends</span> State<span class="op">&lt;</span>OptimizedListView<span class="op">&gt;</span> {</span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ScrollController: Detects when user has scrolled to bottom</span></span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// We listen to this to know when to fetch more data</span></span>
<span id="cb131-12"><a href="#cb131-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> ScrollController _scrollController <span class="op">=</span> ScrollController();</span>
<span id="cb131-13"><a href="#cb131-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-14"><a href="#cb131-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Local state: List of vitals loaded so far</span></span>
<span id="cb131-15"><a href="#cb131-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Starts empty, grows as user scrolls</span></span>
<span id="cb131-16"><a href="#cb131-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">List</span><span class="op">&lt;</span>VitalSign<span class="op">&gt;</span> _vitalSigns <span class="op">=</span> [];</span>
<span id="cb131-17"><a href="#cb131-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-18"><a href="#cb131-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Loading state: Prevents duplicate API calls while fetching</span></span>
<span id="cb131-19"><a href="#cb131-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">// If true, we&#39;re already fetching next page, don&#39;t trigger another</span></span>
<span id="cb131-20"><a href="#cb131-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> _isLoading <span class="op">=</span> <span class="cn">false</span>;</span>
<span id="cb131-21"><a href="#cb131-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-22"><a href="#cb131-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Pagination state (not shown but assumed):</span></span>
<span id="cb131-23"><a href="#cb131-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">// int _currentPage = 0;</span></span>
<span id="cb131-24"><a href="#cb131-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">// bool _hasMoreData = true;</span></span>
<span id="cb131-25"><a href="#cb131-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-26"><a href="#cb131-26" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb131-27"><a href="#cb131-27" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> initState() {</span>
<span id="cb131-28"><a href="#cb131-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span><span class="op">.</span>initState();</span>
<span id="cb131-29"><a href="#cb131-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Load first page of data when widget initializes</span></span>
<span id="cb131-30"><a href="#cb131-30" aria-hidden="true" tabindex="-1"></a>    _loadInitialData();</span>
<span id="cb131-31"><a href="#cb131-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb131-32"><a href="#cb131-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add scroll listener: Triggers when user scrolls</span></span>
<span id="cb131-33"><a href="#cb131-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">// This is the heart of infinite scroll - detects when to load more</span></span>
<span id="cb131-34"><a href="#cb131-34" aria-hidden="true" tabindex="-1"></a>    _scrollController<span class="op">.</span>addListener(_onScroll);</span>
<span id="cb131-35"><a href="#cb131-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb131-36"><a href="#cb131-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-37"><a href="#cb131-37" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// Scroll listener: Called every time user scrolls</span></span>
<span id="cb131-38"><a href="#cb131-38" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// Checks if user has reached the bottom of the list</span></span>
<span id="cb131-39"><a href="#cb131-39" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> _onScroll() {</span>
<span id="cb131-40"><a href="#cb131-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// pixels: Current scroll position</span></span>
<span id="cb131-41"><a href="#cb131-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">// maxScrollExtent: Maximum scroll position (bottom of list)</span></span>
<span id="cb131-42"><a href="#cb131-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">// When these are equal, user has scrolled to the very bottom</span></span>
<span id="cb131-43"><a href="#cb131-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (_scrollController<span class="op">.</span>position<span class="op">.</span>pixels <span class="op">==</span></span>
<span id="cb131-44"><a href="#cb131-44" aria-hidden="true" tabindex="-1"></a>        _scrollController<span class="op">.</span>position<span class="op">.</span>maxScrollExtent) {</span>
<span id="cb131-45"><a href="#cb131-45" aria-hidden="true" tabindex="-1"></a>      <span class="co">// User reached bottom → fetch next page</span></span>
<span id="cb131-46"><a href="#cb131-46" aria-hidden="true" tabindex="-1"></a>      _loadMoreData();</span>
<span id="cb131-47"><a href="#cb131-47" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb131-48"><a href="#cb131-48" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb131-49"><a href="#cb131-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-50"><a href="#cb131-50" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// Load initial page of data (called once on widget creation)</span></span>
<span id="cb131-51"><a href="#cb131-51" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// </span></span>
<span id="cb131-52"><a href="#cb131-52" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// This method would typically:</span></span>
<span id="cb131-53"><a href="#cb131-53" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// 1. Set _isLoading = true</span></span>
<span id="cb131-54"><a href="#cb131-54" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// 2. Call API: healthService.getVitalSigns(page: 0, pageSize: 20)</span></span>
<span id="cb131-55"><a href="#cb131-55" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// 3. Add results to _vitalSigns list</span></span>
<span id="cb131-56"><a href="#cb131-56" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// 4. Call setState() to trigger rebuild</span></span>
<span id="cb131-57"><a href="#cb131-57" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// 5. Set _isLoading = false</span></span>
<span id="cb131-58"><a href="#cb131-58" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> _loadInitialData() <span class="at">async</span> {</span>
<span id="cb131-59"><a href="#cb131-59" aria-hidden="true" tabindex="-1"></a>    setState(() <span class="op">=&gt;</span> _isLoading <span class="op">=</span> <span class="cn">true</span>);</span>
<span id="cb131-60"><a href="#cb131-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb131-61"><a href="#cb131-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb131-62"><a href="#cb131-62" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Fetch first 20 vitals from API</span></span>
<span id="cb131-63"><a href="#cb131-63" aria-hidden="true" tabindex="-1"></a>      <span class="at">final</span> vitals <span class="op">=</span> <span class="at">await</span> _healthService<span class="op">.</span>getVitalSigns(page<span class="op">:</span> <span class="dv">0</span><span class="op">,</span> pageSize<span class="op">:</span> <span class="dv">20</span>);</span>
<span id="cb131-64"><a href="#cb131-64" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb131-65"><a href="#cb131-65" aria-hidden="true" tabindex="-1"></a>      setState(() {</span>
<span id="cb131-66"><a href="#cb131-66" aria-hidden="true" tabindex="-1"></a>        _vitalSigns<span class="op">.</span>addAll(vitals);</span>
<span id="cb131-67"><a href="#cb131-67" aria-hidden="true" tabindex="-1"></a>        _isLoading <span class="op">=</span> <span class="cn">false</span>;</span>
<span id="cb131-68"><a href="#cb131-68" aria-hidden="true" tabindex="-1"></a>      });</span>
<span id="cb131-69"><a href="#cb131-69" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (e) {</span>
<span id="cb131-70"><a href="#cb131-70" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Handle error (show snackbar, etc.)</span></span>
<span id="cb131-71"><a href="#cb131-71" aria-hidden="true" tabindex="-1"></a>      setState(() <span class="op">=&gt;</span> _isLoading <span class="op">=</span> <span class="cn">false</span>);</span>
<span id="cb131-72"><a href="#cb131-72" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb131-73"><a href="#cb131-73" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb131-74"><a href="#cb131-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-75"><a href="#cb131-75" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// Load next page of data (called when user scrolls to bottom)</span></span>
<span id="cb131-76"><a href="#cb131-76" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// </span></span>
<span id="cb131-77"><a href="#cb131-77" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// Includes guard clause to prevent duplicate API calls:</span></span>
<span id="cb131-78"><a href="#cb131-78" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// - If already loading, don&#39;t start another request</span></span>
<span id="cb131-79"><a href="#cb131-79" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// - If no more data available, don&#39;t make unnecessary API call</span></span>
<span id="cb131-80"><a href="#cb131-80" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> _loadMoreData() <span class="at">async</span> {</span>
<span id="cb131-81"><a href="#cb131-81" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Guard: Don&#39;t start loading if already loading</span></span>
<span id="cb131-82"><a href="#cb131-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (_isLoading) <span class="kw">return</span>;</span>
<span id="cb131-83"><a href="#cb131-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb131-84"><a href="#cb131-84" aria-hidden="true" tabindex="-1"></a>    setState(() <span class="op">=&gt;</span> _isLoading <span class="op">=</span> <span class="cn">true</span>);</span>
<span id="cb131-85"><a href="#cb131-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb131-86"><a href="#cb131-86" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb131-87"><a href="#cb131-87" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Fetch next page (page number tracks which page we&#39;re on)</span></span>
<span id="cb131-88"><a href="#cb131-88" aria-hidden="true" tabindex="-1"></a>      <span class="at">final</span> vitals <span class="op">=</span> <span class="at">await</span> _healthService<span class="op">.</span>getVitalSigns(</span>
<span id="cb131-89"><a href="#cb131-89" aria-hidden="true" tabindex="-1"></a>        page<span class="op">:</span> _currentPage <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> </span>
<span id="cb131-90"><a href="#cb131-90" aria-hidden="true" tabindex="-1"></a>        pageSize<span class="op">:</span> <span class="dv">20</span></span>
<span id="cb131-91"><a href="#cb131-91" aria-hidden="true" tabindex="-1"></a>      );</span>
<span id="cb131-92"><a href="#cb131-92" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb131-93"><a href="#cb131-93" aria-hidden="true" tabindex="-1"></a>      setState(() {</span>
<span id="cb131-94"><a href="#cb131-94" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (vitals<span class="op">.</span>isEmpty) {</span>
<span id="cb131-95"><a href="#cb131-95" aria-hidden="true" tabindex="-1"></a>          <span class="co">// No more data from API, we&#39;ve reached the end</span></span>
<span id="cb131-96"><a href="#cb131-96" aria-hidden="true" tabindex="-1"></a>          _hasMoreData <span class="op">=</span> <span class="cn">false</span>;</span>
<span id="cb131-97"><a href="#cb131-97" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb131-98"><a href="#cb131-98" aria-hidden="true" tabindex="-1"></a>          <span class="co">// Add new vitals to existing list</span></span>
<span id="cb131-99"><a href="#cb131-99" aria-hidden="true" tabindex="-1"></a>          _vitalSigns<span class="op">.</span>addAll(vitals);</span>
<span id="cb131-100"><a href="#cb131-100" aria-hidden="true" tabindex="-1"></a>          _currentPage<span class="op">++</span>;</span>
<span id="cb131-101"><a href="#cb131-101" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb131-102"><a href="#cb131-102" aria-hidden="true" tabindex="-1"></a>        _isLoading <span class="op">=</span> <span class="cn">false</span>;</span>
<span id="cb131-103"><a href="#cb131-103" aria-hidden="true" tabindex="-1"></a>      });</span>
<span id="cb131-104"><a href="#cb131-104" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (e) {</span>
<span id="cb131-105"><a href="#cb131-105" aria-hidden="true" tabindex="-1"></a>      setState(() <span class="op">=&gt;</span> _isLoading <span class="op">=</span> <span class="cn">false</span>);</span>
<span id="cb131-106"><a href="#cb131-106" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb131-107"><a href="#cb131-107" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb131-108"><a href="#cb131-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-109"><a href="#cb131-109" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb131-110"><a href="#cb131-110" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> dispose() {</span>
<span id="cb131-111"><a href="#cb131-111" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clean up: Remove listener to prevent memory leaks</span></span>
<span id="cb131-112"><a href="#cb131-112" aria-hidden="true" tabindex="-1"></a>    _scrollController<span class="op">.</span>dispose();</span>
<span id="cb131-113"><a href="#cb131-113" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span><span class="op">.</span>dispose();</span>
<span id="cb131-114"><a href="#cb131-114" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb131-115"><a href="#cb131-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-116"><a href="#cb131-116" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb131-117"><a href="#cb131-117" aria-hidden="true" tabindex="-1"></a>  Widget build(BuildContext context) {</span>
<span id="cb131-118"><a href="#cb131-118" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ListView.builder: Only builds visible items (critical for performance)</span></span>
<span id="cb131-119"><a href="#cb131-119" aria-hidden="true" tabindex="-1"></a>    <span class="co">// If you have 10,000 items but only 10 fit on screen, only 10 widgets are built</span></span>
<span id="cb131-120"><a href="#cb131-120" aria-hidden="true" tabindex="-1"></a>    <span class="co">// As user scrolls, Flutter builds new items and disposes old ones</span></span>
<span id="cb131-121"><a href="#cb131-121" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> ListView<span class="op">.</span>builder(</span>
<span id="cb131-122"><a href="#cb131-122" aria-hidden="true" tabindex="-1"></a>      controller<span class="op">:</span> _scrollController<span class="op">,</span>  <span class="co">// Attach our scroll listener</span></span>
<span id="cb131-123"><a href="#cb131-123" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb131-124"><a href="#cb131-124" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Item count: Number of vitals + 1 loading indicator (if loading)</span></span>
<span id="cb131-125"><a href="#cb131-125" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Example: 20 vitals + 1 spinner = 21 total items</span></span>
<span id="cb131-126"><a href="#cb131-126" aria-hidden="true" tabindex="-1"></a>      itemCount<span class="op">:</span> _vitalSigns<span class="op">.</span>length <span class="op">+</span> (_isLoading <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="dv">0</span>)<span class="op">,</span></span>
<span id="cb131-127"><a href="#cb131-127" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb131-128"><a href="#cb131-128" aria-hidden="true" tabindex="-1"></a>      <span class="co">// itemBuilder: Called for each visible item</span></span>
<span id="cb131-129"><a href="#cb131-129" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Flutter only calls this for items that need to be displayed</span></span>
<span id="cb131-130"><a href="#cb131-130" aria-hidden="true" tabindex="-1"></a>      <span class="co">// index: Position in list (0 to itemCount - 1)</span></span>
<span id="cb131-131"><a href="#cb131-131" aria-hidden="true" tabindex="-1"></a>      itemBuilder<span class="op">:</span> (context<span class="op">,</span> index) {</span>
<span id="cb131-132"><a href="#cb131-132" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Last item: Show loading spinner while fetching</span></span>
<span id="cb131-133"><a href="#cb131-133" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (index <span class="op">==</span> _vitalSigns<span class="op">.</span>length) {</span>
<span id="cb131-134"><a href="#cb131-134" aria-hidden="true" tabindex="-1"></a>          <span class="kw">return</span> Padding(</span>
<span id="cb131-135"><a href="#cb131-135" aria-hidden="true" tabindex="-1"></a>            padding<span class="op">:</span> EdgeInsets<span class="op">.</span>all(<span class="dv">16</span>)<span class="op">,</span></span>
<span id="cb131-136"><a href="#cb131-136" aria-hidden="true" tabindex="-1"></a>            child<span class="op">:</span> Center(child<span class="op">:</span> CircularProgressIndicator())<span class="op">,</span></span>
<span id="cb131-137"><a href="#cb131-137" aria-hidden="true" tabindex="-1"></a>          );</span>
<span id="cb131-138"><a href="#cb131-138" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb131-139"><a href="#cb131-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-140"><a href="#cb131-140" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Regular item: Show vital sign data</span></span>
<span id="cb131-141"><a href="#cb131-141" aria-hidden="true" tabindex="-1"></a>        <span class="at">final</span> vital <span class="op">=</span> _vitalSigns[index];</span>
<span id="cb131-142"><a href="#cb131-142" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb131-143"><a href="#cb131-143" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> ListTile(</span>
<span id="cb131-144"><a href="#cb131-144" aria-hidden="true" tabindex="-1"></a>          <span class="co">// key: Helps Flutter identify widgets across rebuilds</span></span>
<span id="cb131-145"><a href="#cb131-145" aria-hidden="true" tabindex="-1"></a>          <span class="co">// Without this, Flutter might rebuild the wrong items</span></span>
<span id="cb131-146"><a href="#cb131-146" aria-hidden="true" tabindex="-1"></a>          <span class="co">// ValueKey uses the unique ID to track each vital</span></span>
<span id="cb131-147"><a href="#cb131-147" aria-hidden="true" tabindex="-1"></a>          key<span class="op">:</span> ValueKey(vital<span class="op">.</span>id)<span class="op">,</span></span>
<span id="cb131-148"><a href="#cb131-148" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb131-149"><a href="#cb131-149" aria-hidden="true" tabindex="-1"></a>          title<span class="op">:</span> Text(vital<span class="op">.</span>type)<span class="op">,</span>  <span class="co">// &quot;Blood Pressure&quot;</span></span>
<span id="cb131-150"><a href="#cb131-150" aria-hidden="true" tabindex="-1"></a>          subtitle<span class="op">:</span> Text(<span class="st">&#39;${vital.value} ${vital.unit}&#39;</span>)<span class="op">,</span>  <span class="co">// &quot;120 mmHg&quot;</span></span>
<span id="cb131-151"><a href="#cb131-151" aria-hidden="true" tabindex="-1"></a>          trailing<span class="op">:</span> Text(</span>
<span id="cb131-152"><a href="#cb131-152" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Format timestamp: &quot;2 hours ago&quot;</span></span>
<span id="cb131-153"><a href="#cb131-153" aria-hidden="true" tabindex="-1"></a>            _formatTimestamp(vital<span class="op">.</span>timestamp)<span class="op">,</span></span>
<span id="cb131-154"><a href="#cb131-154" aria-hidden="true" tabindex="-1"></a>            style<span class="op">:</span> TextStyle(color<span class="op">:</span> Colors<span class="op">.</span>grey<span class="op">,</span> fontSize<span class="op">:</span> <span class="dv">12</span>)<span class="op">,</span></span>
<span id="cb131-155"><a href="#cb131-155" aria-hidden="true" tabindex="-1"></a>          )<span class="op">,</span></span>
<span id="cb131-156"><a href="#cb131-156" aria-hidden="true" tabindex="-1"></a>        );</span>
<span id="cb131-157"><a href="#cb131-157" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb131-158"><a href="#cb131-158" aria-hidden="true" tabindex="-1"></a>    );</span>
<span id="cb131-159"><a href="#cb131-159" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb131-160"><a href="#cb131-160" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h4 id="why-this-pattern-improves-performance">Why This Pattern Improves
Performance</h4>
<p><strong>Memory Efficiency</strong>: - Without pagination: Loading
10,000 vitals = ~10MB of RAM - With pagination: Loading 20 vitals at a
time = ~20KB of RAM - Old items off-screen can be garbage collected</p>
<p><strong>Initial Load Speed</strong>: - Without pagination: Wait for
all 10,000 vitals to load (10+ seconds) - With pagination: Load 20
vitals instantly (&lt;1 second)</p>
<p><strong>Network Efficiency</strong>: - Without pagination: 10,000
vitals in one giant JSON payload - With pagination: Small, incremental
requests that complete quickly</p>
<p><strong>User Experience</strong>: - Instant perceived performance
(data appears immediately) - Natural scrolling behavior (no pagination
buttons to click) - Works well even with slow network connections</p>
<h4 id="additional-flutter-performance-optimizations">Additional Flutter
Performance Optimizations</h4>
<p><strong>1. const Constructors for Immutable Widgets</strong>:</p>
<div class="sourceCode" id="cb132"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="co">// BAD: Widget rebuilds every time parent rebuilds</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>Widget build(BuildContext context) {</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> Text(<span class="st">&#39;Hello&#39;</span>);</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a><span class="co">// GOOD: Widget is const, Flutter reuses existing instance</span></span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>Widget build(BuildContext context) {</span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> <span class="at">const</span> Text(<span class="st">&#39;Hello&#39;</span>);  <span class="co">// Marked as const</span></span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Using <code>const</code> tells Flutter “this widget never changes,”
allowing it to skip rebuilding entirely.</p>
<p><strong>2. RepaintBoundary for Complex Widgets</strong>:</p>
<div class="sourceCode" id="cb133"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Wrap expensive widgets in RepaintBoundary to isolate repaints</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>RepaintBoundary(</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>  child<span class="op">:</span> ComplexChart(data<span class="op">:</span> vitalSignsData)<span class="op">,</span></span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>This prevents the chart from being repainted when other parts of the
screen change.</p>
<p><strong>3. AutomaticKeepAliveClientMixin for Tab Views</strong>:</p>
<div class="sourceCode" id="cb134"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Prevents tabs from rebuilding when switching between them</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HealthTab <span class="kw">extends</span> StatefulWidget {</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>  _HealthTabState createState() <span class="op">=&gt;</span> _HealthTabState();</span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> _HealthTabState <span class="kw">extends</span> State<span class="op">&lt;</span>HealthTab<span class="op">&gt;</span> </span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">with</span> AutomaticKeepAliveClientMixin {</span>
<span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb134-10"><a href="#cb134-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb134-11"><a href="#cb134-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> <span class="kw">get</span> wantKeepAlive <span class="op">=&gt;</span> <span class="cn">true</span>;  <span class="co">// Keep this tab&#39;s state alive</span></span>
<span id="cb134-12"><a href="#cb134-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb134-13"><a href="#cb134-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb134-14"><a href="#cb134-14" aria-hidden="true" tabindex="-1"></a>  Widget build(BuildContext context) {</span>
<span id="cb134-15"><a href="#cb134-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span><span class="op">.</span>build(context);  <span class="co">// Required by mixin</span></span>
<span id="cb134-16"><a href="#cb134-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> HealthContent();</span>
<span id="cb134-17"><a href="#cb134-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb134-18"><a href="#cb134-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="backend-optimization-caching-with-redis">Backend Optimization:
Caching with Redis</h3>
<p>Repeatedly querying the database for the same data wastes resources
and slows response time. Redis is an in-memory cache that stores
frequently accessed data, providing sub-millisecond response times.
CareConnect uses Spring’s caching abstraction with Redis to
transparently cache expensive database queries.</p>
<h4 id="how-caching-works-in-careconnect">How Caching Works in
CareConnect</h4>
<p><strong>The Flow Without Caching</strong>: 1. Request arrives: “Get
vitals for user 123” 2. Service queries database: SELECT * FROM
vital_signs WHERE user_id = 123 3. Database processes query (~50ms) 4.
Return results to client</p>
<p><strong>With Caching</strong>: 1. First request: Query database,
store result in Redis (cache miss) 2. Subsequent requests: Return from
Redis (~1ms), skip database entirely (cache hit) 3. Cache expires after
10 minutes or when data changes</p>
<p><strong>Cache Hit Rate</strong>: In production, vitals are read much
more often than written. A good cache hit rate is 80%+, meaning 80% of
requests never touch the database.</p>
<p><strong>Implementation with Detailed Explanation</strong>:</p>
<div class="sourceCode" id="cb135"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Caching configuration</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="co">// @EnableCaching: Activates Spring&#39;s caching infrastructure</span></span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a><span class="co">// This annotation scans for @Cacheable, @CacheEvict annotations</span></span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a><span class="at">@Configuration</span></span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a><span class="at">@EnableCaching</span></span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> CacheConfig <span class="op">{</span></span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Creates the cache manager that handles all caching operations</span></span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Redis is chosen over simple in-memory cache because:</span></span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// - Shared across multiple backend instances (horizontal scaling)</span></span>
<span id="cb135-11"><a href="#cb135-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// - Survives application restarts</span></span>
<span id="cb135-12"><a href="#cb135-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// - Supports TTL (time-to-live) for automatic expiration</span></span>
<span id="cb135-13"><a href="#cb135-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb135-14"><a href="#cb135-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> CacheManager <span class="fu">cacheManager</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb135-15"><a href="#cb135-15" aria-hidden="true" tabindex="-1"></a>        RedisCacheManager<span class="op">.</span><span class="fu">Builder</span> builder <span class="op">=</span> RedisCacheManager</span>
<span id="cb135-16"><a href="#cb135-16" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">RedisCacheManagerBuilder</span></span>
<span id="cb135-17"><a href="#cb135-17" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Connect to Redis instance (configured in application.properties)</span></span>
<span id="cb135-18"><a href="#cb135-18" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">fromConnectionFactory</span><span class="op">(</span><span class="fu">redisConnectionFactory</span><span class="op">())</span></span>
<span id="cb135-19"><a href="#cb135-19" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Set default cache configuration: 10 minute TTL</span></span>
<span id="cb135-20"><a href="#cb135-20" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">cacheDefaults</span><span class="op">(</span><span class="fu">cacheConfiguration</span><span class="op">(</span><span class="bu">Duration</span><span class="op">.</span><span class="fu">ofMinutes</span><span class="op">(</span><span class="dv">10</span><span class="op">)));</span></span>
<span id="cb135-21"><a href="#cb135-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-22"><a href="#cb135-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> builder<span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb135-23"><a href="#cb135-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb135-24"><a href="#cb135-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-25"><a href="#cb135-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Configure how data is stored in Redis</span></span>
<span id="cb135-26"><a href="#cb135-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// </span></span>
<span id="cb135-27"><a href="#cb135-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Key decisions:</span></span>
<span id="cb135-28"><a href="#cb135-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// - TTL (time-to-live): How long cached data remains valid</span></span>
<span id="cb135-29"><a href="#cb135-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// - Serialization: How Java objects convert to/from Redis format</span></span>
<span id="cb135-30"><a href="#cb135-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// - Null value caching: Should we cache NULL results?</span></span>
<span id="cb135-31"><a href="#cb135-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> RedisCacheConfiguration <span class="fu">cacheConfiguration</span><span class="op">(</span><span class="bu">Duration</span> ttl<span class="op">)</span> <span class="op">{</span></span>
<span id="cb135-32"><a href="#cb135-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> RedisCacheConfiguration<span class="op">.</span><span class="fu">defaultCacheConfig</span><span class="op">()</span></span>
<span id="cb135-33"><a href="#cb135-33" aria-hidden="true" tabindex="-1"></a>            <span class="co">// entryTtl: Cache entries expire after this duration</span></span>
<span id="cb135-34"><a href="#cb135-34" aria-hidden="true" tabindex="-1"></a>            <span class="co">// After 10 minutes, entry is automatically removed</span></span>
<span id="cb135-35"><a href="#cb135-35" aria-hidden="true" tabindex="-1"></a>            <span class="co">// This ensures users see fresh data without explicit cache invalidation</span></span>
<span id="cb135-36"><a href="#cb135-36" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">entryTtl</span><span class="op">(</span>ttl<span class="op">)</span></span>
<span id="cb135-37"><a href="#cb135-37" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb135-38"><a href="#cb135-38" aria-hidden="true" tabindex="-1"></a>            <span class="co">// disableCachingNullValues: Don&#39;t cache NULL query results</span></span>
<span id="cb135-39"><a href="#cb135-39" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Why? If user has no vitals, we don&#39;t want to cache that for 10 minutes</span></span>
<span id="cb135-40"><a href="#cb135-40" aria-hidden="true" tabindex="-1"></a>            <span class="co">// The next time they record a vital, query should reflect it immediately</span></span>
<span id="cb135-41"><a href="#cb135-41" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">disableCachingNullValues</span><span class="op">()</span></span>
<span id="cb135-42"><a href="#cb135-42" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb135-43"><a href="#cb135-43" aria-hidden="true" tabindex="-1"></a>            <span class="co">// serializeKeysWith: How cache keys are stored</span></span>
<span id="cb135-44"><a href="#cb135-44" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Keys are strings like &quot;user_vitals::123&quot;</span></span>
<span id="cb135-45"><a href="#cb135-45" aria-hidden="true" tabindex="-1"></a>            <span class="co">// StringRedisSerializer stores them as plain strings in Redis</span></span>
<span id="cb135-46"><a href="#cb135-46" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">serializeKeysWith</span><span class="op">(</span>RedisSerializationContext<span class="op">.</span><span class="fu">SerializationPair</span></span>
<span id="cb135-47"><a href="#cb135-47" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">fromSerializer</span><span class="op">(</span><span class="kw">new</span> <span class="fu">StringRedisSerializer</span><span class="op">()))</span></span>
<span id="cb135-48"><a href="#cb135-48" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb135-49"><a href="#cb135-49" aria-hidden="true" tabindex="-1"></a>            <span class="co">// serializeValuesWith: How cache values (the actual data) are stored</span></span>
<span id="cb135-50"><a href="#cb135-50" aria-hidden="true" tabindex="-1"></a>            <span class="co">// GenericJackson2JsonRedisSerializer converts Java objects to JSON</span></span>
<span id="cb135-51"><a href="#cb135-51" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Stored as JSON in Redis, human-readable for debugging</span></span>
<span id="cb135-52"><a href="#cb135-52" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">serializeValuesWith</span><span class="op">(</span>RedisSerializationContext<span class="op">.</span><span class="fu">SerializationPair</span></span>
<span id="cb135-53"><a href="#cb135-53" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">fromSerializer</span><span class="op">(</span><span class="kw">new</span> <span class="fu">GenericJackson2JsonRedisSerializer</span><span class="op">()));</span></span>
<span id="cb135-54"><a href="#cb135-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb135-55"><a href="#cb135-55" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb135-56"><a href="#cb135-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-57"><a href="#cb135-57" aria-hidden="true" tabindex="-1"></a><span class="co">// Service with caching</span></span>
<span id="cb135-58"><a href="#cb135-58" aria-hidden="true" tabindex="-1"></a><span class="co">// This service demonstrates Spring&#39;s declarative caching</span></span>
<span id="cb135-59"><a href="#cb135-59" aria-hidden="true" tabindex="-1"></a><span class="co">// No manual cache management code needed - annotations handle everything</span></span>
<span id="cb135-60"><a href="#cb135-60" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb135-61"><a href="#cb135-61" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> CachedHealthService <span class="op">{</span></span>
<span id="cb135-62"><a href="#cb135-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-63"><a href="#cb135-63" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// @Cacheable: Cache the result of this method</span></span>
<span id="cb135-64"><a href="#cb135-64" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// </span></span>
<span id="cb135-65"><a href="#cb135-65" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// How it works:</span></span>
<span id="cb135-66"><a href="#cb135-66" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// 1. Spring intercepts the method call</span></span>
<span id="cb135-67"><a href="#cb135-67" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// 2. Checks if result exists in cache for this userId</span></span>
<span id="cb135-68"><a href="#cb135-68" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// 3. If YES (cache hit): Return cached result, skip method execution</span></span>
<span id="cb135-69"><a href="#cb135-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// 4. If NO (cache miss): Execute method, store result in cache, return it</span></span>
<span id="cb135-70"><a href="#cb135-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// </span></span>
<span id="cb135-71"><a href="#cb135-71" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Parameters:</span></span>
<span id="cb135-72"><a href="#cb135-72" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// - value: Cache name (&quot;user_vitals&quot;)</span></span>
<span id="cb135-73"><a href="#cb135-73" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// - key: Cache key expression (&quot;#userId&quot; uses method parameter)</span></span>
<span id="cb135-74"><a href="#cb135-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">///   Full cache key: &quot;user_vitals::123&quot; for userId=123</span></span>
<span id="cb135-75"><a href="#cb135-75" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// </span></span>
<span id="cb135-76"><a href="#cb135-76" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Example flow:</span></span>
<span id="cb135-77"><a href="#cb135-77" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Request 1 (userId=123): Cache miss → Query DB → Store in cache → Return</span></span>
<span id="cb135-78"><a href="#cb135-78" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Request 2 (userId=123): Cache hit → Return from Redis (1ms)</span></span>
<span id="cb135-79"><a href="#cb135-79" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Request 3 (userId=456): Cache miss → Query DB → Store in cache → Return</span></span>
<span id="cb135-80"><a href="#cb135-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Cacheable</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;user_vitals&quot;</span><span class="op">,</span> key <span class="op">=</span> <span class="st">&quot;#userId&quot;</span><span class="op">)</span></span>
<span id="cb135-81"><a href="#cb135-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">List</span><span class="op">&lt;</span>VitalSignDTO<span class="op">&gt;</span> <span class="fu">getVitalSigns</span><span class="op">(</span><span class="bu">Long</span> userId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb135-82"><a href="#cb135-82" aria-hidden="true" tabindex="-1"></a>        <span class="co">// This code only executes on cache miss</span></span>
<span id="cb135-83"><a href="#cb135-83" aria-hidden="true" tabindex="-1"></a>        <span class="co">// On cache hit, Spring returns cached result without calling this method</span></span>
<span id="cb135-84"><a href="#cb135-84" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb135-85"><a href="#cb135-85" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Expensive database query (50ms+)</span></span>
<span id="cb135-86"><a href="#cb135-86" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> healthRepository<span class="op">.</span><span class="fu">findByUserIdOrderByMeasurementTimeDesc</span><span class="op">(</span>userId<span class="op">)</span></span>
<span id="cb135-87"><a href="#cb135-87" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">stream</span><span class="op">()</span></span>
<span id="cb135-88"><a href="#cb135-88" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">map</span><span class="op">(</span><span class="kw">this</span><span class="op">::</span>convertToDTO<span class="op">)</span>  <span class="co">// Convert entities to DTOs</span></span>
<span id="cb135-89"><a href="#cb135-89" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">collect</span><span class="op">(</span>Collectors<span class="op">.</span><span class="fu">toList</span><span class="op">());</span></span>
<span id="cb135-90"><a href="#cb135-90" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb135-91"><a href="#cb135-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-92"><a href="#cb135-92" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// @CacheEvict: Remove cached data when it becomes stale</span></span>
<span id="cb135-93"><a href="#cb135-93" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// </span></span>
<span id="cb135-94"><a href="#cb135-94" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Why evict? When new vital is recorded, cached data is outdated</span></span>
<span id="cb135-95"><a href="#cb135-95" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// We must remove the old cache so next getVitalSigns() fetches fresh data</span></span>
<span id="cb135-96"><a href="#cb135-96" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// </span></span>
<span id="cb135-97"><a href="#cb135-97" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Parameters:</span></span>
<span id="cb135-98"><a href="#cb135-98" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// - value: Which cache to evict from (&quot;user_vitals&quot;)</span></span>
<span id="cb135-99"><a href="#cb135-99" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// - key: Which specific entry to evict (&quot;#userId&quot;)</span></span>
<span id="cb135-100"><a href="#cb135-100" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// </span></span>
<span id="cb135-101"><a href="#cb135-101" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Example flow:</span></span>
<span id="cb135-102"><a href="#cb135-102" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// 1. User 123&#39;s vitals are cached</span></span>
<span id="cb135-103"><a href="#cb135-103" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// 2. User records new vital → this method called</span></span>
<span id="cb135-104"><a href="#cb135-104" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// 3. Cache entry &quot;user_vitals::123&quot; removed from Redis</span></span>
<span id="cb135-105"><a href="#cb135-105" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// 4. Next getVitalSigns(123) will be cache miss, fetching fresh data</span></span>
<span id="cb135-106"><a href="#cb135-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">@CacheEvict</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;user_vitals&quot;</span><span class="op">,</span> key <span class="op">=</span> <span class="st">&quot;#userId&quot;</span><span class="op">)</span></span>
<span id="cb135-107"><a href="#cb135-107" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> VitalSignDTO <span class="fu">recordVitalSign</span><span class="op">(</span><span class="bu">Long</span> userId<span class="op">,</span> VitalSignDTO vitalSign<span class="op">)</span> <span class="op">{</span></span>
<span id="cb135-108"><a href="#cb135-108" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Cache is invalidated BEFORE this method executes</span></span>
<span id="cb135-109"><a href="#cb135-109" aria-hidden="true" tabindex="-1"></a>        <span class="co">// This ensures the cache doesn&#39;t contain stale data</span></span>
<span id="cb135-110"><a href="#cb135-110" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb135-111"><a href="#cb135-111" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Save the new vital sign to database</span></span>
<span id="cb135-112"><a href="#cb135-112" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">saveVitalSign</span><span class="op">(</span>userId<span class="op">,</span> vitalSign<span class="op">);</span></span>
<span id="cb135-113"><a href="#cb135-113" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb135-114"><a href="#cb135-114" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="cache-performance-impact">Cache Performance Impact</h4>
<p><strong>Metrics from production</strong>: - Database query time:
50-100ms - Redis cache retrieval: 1-2ms - <strong>Speedup: 50-100x
faster</strong> for cached queries</p>
<p><strong>Cache hit rate</strong>: ~85% for vital signs (frequently
read, infrequently updated)</p>
<p><strong>Cost savings</strong>: Reduced database load means smaller
database instance needed</p>
<h4 id="caching-strategies-in-careconnect">Caching Strategies in
CareConnect</h4>
<table>
<colgroup>
<col style="width: 26%" />
<col style="width: 35%" />
<col style="width: 11%" />
<col style="width: 26%" />
</colgroup>
<thead>
<tr class="header">
<th>Data Type</th>
<th>Cache Strategy</th>
<th>TTL</th>
<th>Rationale</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>User vitals</td>
<td>Cache + evict on write</td>
<td>10 min</td>
<td>Read-heavy, updated occasionally</td>
</tr>
<tr class="even">
<td>User profile</td>
<td>Cache + evict on write</td>
<td>30 min</td>
<td>Rarely changes</td>
</tr>
<tr class="odd">
<td>Medication list</td>
<td>Cache + evict on write</td>
<td>5 min</td>
<td>Important to be up-to-date</td>
</tr>
<tr class="even">
<td>Static data (lists of vital types)</td>
<td>Cache only</td>
<td>24 hours</td>
<td>Never changes</td>
</tr>
<tr class="odd">
<td>Real-time data (WebSocket messages)</td>
<td>No cache</td>
<td>N/A</td>
<td>Must be real-time</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb136"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Lazy loading and performance optimizations</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OptimizedListView <span class="kw">extends</span> StatefulWidget {</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>  _OptimizedListViewState createState() <span class="op">=&gt;</span> _OptimizedListViewState();</span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> _OptimizedListViewState <span class="kw">extends</span> State<span class="op">&lt;</span>OptimizedListView<span class="op">&gt;</span> {</span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> ScrollController _scrollController <span class="op">=</span> ScrollController();</span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">List</span><span class="op">&lt;</span>VitalSign<span class="op">&gt;</span> _vitalSigns <span class="op">=</span> [];</span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> _isLoading <span class="op">=</span> <span class="cn">false</span>;</span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-12"><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb136-13"><a href="#cb136-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> initState() {</span>
<span id="cb136-14"><a href="#cb136-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span><span class="op">.</span>initState();</span>
<span id="cb136-15"><a href="#cb136-15" aria-hidden="true" tabindex="-1"></a>    _loadInitialData();</span>
<span id="cb136-16"><a href="#cb136-16" aria-hidden="true" tabindex="-1"></a>    _scrollController<span class="op">.</span>addListener(_onScroll);</span>
<span id="cb136-17"><a href="#cb136-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb136-18"><a href="#cb136-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-19"><a href="#cb136-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> _onScroll() {</span>
<span id="cb136-20"><a href="#cb136-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (_scrollController<span class="op">.</span>position<span class="op">.</span>pixels <span class="op">==</span></span>
<span id="cb136-21"><a href="#cb136-21" aria-hidden="true" tabindex="-1"></a>        _scrollController<span class="op">.</span>position<span class="op">.</span>maxScrollExtent) {</span>
<span id="cb136-22"><a href="#cb136-22" aria-hidden="true" tabindex="-1"></a>      _loadMoreData();</span>
<span id="cb136-23"><a href="#cb136-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb136-24"><a href="#cb136-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb136-25"><a href="#cb136-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-26"><a href="#cb136-26" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb136-27"><a href="#cb136-27" aria-hidden="true" tabindex="-1"></a>  Widget build(BuildContext context) {</span>
<span id="cb136-28"><a href="#cb136-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> ListView<span class="op">.</span>builder(</span>
<span id="cb136-29"><a href="#cb136-29" aria-hidden="true" tabindex="-1"></a>      controller<span class="op">:</span> _scrollController<span class="op">,</span></span>
<span id="cb136-30"><a href="#cb136-30" aria-hidden="true" tabindex="-1"></a>      itemCount<span class="op">:</span> _vitalSigns<span class="op">.</span>length <span class="op">+</span> (_isLoading <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="dv">0</span>)<span class="op">,</span></span>
<span id="cb136-31"><a href="#cb136-31" aria-hidden="true" tabindex="-1"></a>      itemBuilder<span class="op">:</span> (context<span class="op">,</span> index) {</span>
<span id="cb136-32"><a href="#cb136-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (index <span class="op">==</span> _vitalSigns<span class="op">.</span>length) {</span>
<span id="cb136-33"><a href="#cb136-33" aria-hidden="true" tabindex="-1"></a>          <span class="kw">return</span> CircularProgressIndicator();</span>
<span id="cb136-34"><a href="#cb136-34" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb136-35"><a href="#cb136-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-36"><a href="#cb136-36" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> ListTile(</span>
<span id="cb136-37"><a href="#cb136-37" aria-hidden="true" tabindex="-1"></a>          key<span class="op">:</span> ValueKey(_vitalSigns[index]<span class="op">.</span>id)<span class="op">,</span></span>
<span id="cb136-38"><a href="#cb136-38" aria-hidden="true" tabindex="-1"></a>          title<span class="op">:</span> Text(_vitalSigns[index]<span class="op">.</span>type)<span class="op">,</span></span>
<span id="cb136-39"><a href="#cb136-39" aria-hidden="true" tabindex="-1"></a>          subtitle<span class="op">:</span> Text(<span class="st">&#39;${_vitalSigns[index].value} ${_vitalSigns[index].unit}&#39;</span>)<span class="op">,</span></span>
<span id="cb136-40"><a href="#cb136-40" aria-hidden="true" tabindex="-1"></a>        );</span>
<span id="cb136-41"><a href="#cb136-41" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb136-42"><a href="#cb136-42" aria-hidden="true" tabindex="-1"></a>    );</span>
<span id="cb136-43"><a href="#cb136-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb136-44"><a href="#cb136-44" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="backend-optimization">Backend Optimization</h3>
<div class="sourceCode" id="cb137"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Caching configuration</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Configuration</span></span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a><span class="at">@EnableCaching</span></span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> CacheConfig <span class="op">{</span></span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> CacheManager <span class="fu">cacheManager</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a>        RedisCacheManager<span class="op">.</span><span class="fu">Builder</span> builder <span class="op">=</span> RedisCacheManager</span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">RedisCacheManagerBuilder</span></span>
<span id="cb137-10"><a href="#cb137-10" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">fromConnectionFactory</span><span class="op">(</span><span class="fu">redisConnectionFactory</span><span class="op">())</span></span>
<span id="cb137-11"><a href="#cb137-11" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">cacheDefaults</span><span class="op">(</span><span class="fu">cacheConfiguration</span><span class="op">(</span><span class="bu">Duration</span><span class="op">.</span><span class="fu">ofMinutes</span><span class="op">(</span><span class="dv">10</span><span class="op">)));</span></span>
<span id="cb137-12"><a href="#cb137-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-13"><a href="#cb137-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> builder<span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb137-14"><a href="#cb137-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb137-15"><a href="#cb137-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-16"><a href="#cb137-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> RedisCacheConfiguration <span class="fu">cacheConfiguration</span><span class="op">(</span><span class="bu">Duration</span> ttl<span class="op">)</span> <span class="op">{</span></span>
<span id="cb137-17"><a href="#cb137-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> RedisCacheConfiguration<span class="op">.</span><span class="fu">defaultCacheConfig</span><span class="op">()</span></span>
<span id="cb137-18"><a href="#cb137-18" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">entryTtl</span><span class="op">(</span>ttl<span class="op">)</span></span>
<span id="cb137-19"><a href="#cb137-19" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">disableCachingNullValues</span><span class="op">()</span></span>
<span id="cb137-20"><a href="#cb137-20" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">serializeKeysWith</span><span class="op">(</span>RedisSerializationContext<span class="op">.</span><span class="fu">SerializationPair</span></span>
<span id="cb137-21"><a href="#cb137-21" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">fromSerializer</span><span class="op">(</span><span class="kw">new</span> <span class="fu">StringRedisSerializer</span><span class="op">()))</span></span>
<span id="cb137-22"><a href="#cb137-22" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">serializeValuesWith</span><span class="op">(</span>RedisSerializationContext<span class="op">.</span><span class="fu">SerializationPair</span></span>
<span id="cb137-23"><a href="#cb137-23" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">fromSerializer</span><span class="op">(</span><span class="kw">new</span> <span class="fu">GenericJackson2JsonRedisSerializer</span><span class="op">()));</span></span>
<span id="cb137-24"><a href="#cb137-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb137-25"><a href="#cb137-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb137-26"><a href="#cb137-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-27"><a href="#cb137-27" aria-hidden="true" tabindex="-1"></a><span class="co">// Service with caching</span></span>
<span id="cb137-28"><a href="#cb137-28" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb137-29"><a href="#cb137-29" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> CachedHealthService <span class="op">{</span></span>
<span id="cb137-30"><a href="#cb137-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-31"><a href="#cb137-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Cacheable</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;user_vitals&quot;</span><span class="op">,</span> key <span class="op">=</span> <span class="st">&quot;#userId&quot;</span><span class="op">)</span></span>
<span id="cb137-32"><a href="#cb137-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">List</span><span class="op">&lt;</span>VitalSignDTO<span class="op">&gt;</span> <span class="fu">getVitalSigns</span><span class="op">(</span><span class="bu">Long</span> userId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb137-33"><a href="#cb137-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Database query is cached</span></span>
<span id="cb137-34"><a href="#cb137-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> healthRepository<span class="op">.</span><span class="fu">findByUserIdOrderByMeasurementTimeDesc</span><span class="op">(</span>userId<span class="op">)</span></span>
<span id="cb137-35"><a href="#cb137-35" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">stream</span><span class="op">()</span></span>
<span id="cb137-36"><a href="#cb137-36" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">map</span><span class="op">(</span><span class="kw">this</span><span class="op">::</span>convertToDTO<span class="op">)</span></span>
<span id="cb137-37"><a href="#cb137-37" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">collect</span><span class="op">(</span>Collectors<span class="op">.</span><span class="fu">toList</span><span class="op">());</span></span>
<span id="cb137-38"><a href="#cb137-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb137-39"><a href="#cb137-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-40"><a href="#cb137-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">@CacheEvict</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;user_vitals&quot;</span><span class="op">,</span> key <span class="op">=</span> <span class="st">&quot;#userId&quot;</span><span class="op">)</span></span>
<span id="cb137-41"><a href="#cb137-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> VitalSignDTO <span class="fu">recordVitalSign</span><span class="op">(</span><span class="bu">Long</span> userId<span class="op">,</span> VitalSignDTO vitalSign<span class="op">)</span> <span class="op">{</span></span>
<span id="cb137-42"><a href="#cb137-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Cache is invalidated when new data is added</span></span>
<span id="cb137-43"><a href="#cb137-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">saveVitalSign</span><span class="op">(</span>userId<span class="op">,</span> vitalSign<span class="op">);</span></span>
<span id="cb137-44"><a href="#cb137-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb137-45"><a href="#cb137-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="database-optimization-indexes-and-partitioning">Database
Optimization: Indexes and Partitioning</h3>
<p>Database performance is critical in healthcare applications where
queries must return results quickly even with millions of records.
PostgreSQL provides powerful optimization features—indexes and
partitioning—that dramatically improve query performance when used
correctly. However, these features require understanding of how queries
actually execute.</p>
<h4 id="understanding-database-indexes">Understanding Database
Indexes</h4>
<p>An index is like a book’s index: instead of reading every page to
find “blood pressure,” you check the index which tells you exactly which
pages to read. Similarly, database indexes let PostgreSQL find rows
without scanning the entire table.</p>
<p><strong>Without Index</strong>:
<code>SELECT * FROM vital_signs WHERE user_id = 123</code> - PostgreSQL
scans ALL rows (1 million+) to find user 123’s vitals - Takes seconds,
gets slower as table grows</p>
<p><strong>With Index</strong>: Same query with index on
<code>user_id</code> - PostgreSQL uses index to jump directly to user
123’s rows - Returns in milliseconds, performance stays constant even
with growth</p>
<p><strong>The Trade-Off</strong>: - <strong>Benefit</strong>:
Dramatically faster queries (100x+ improvement) - <strong>Cost</strong>:
Slower writes (every INSERT updates the index), more disk space</p>
<p><strong>Rule of Thumb</strong>: Index columns used in WHERE clauses,
JOIN conditions, and ORDER BY clauses of frequent queries.</p>
<h4 id="strategic-index-design-for-careconnect">Strategic Index Design
for CareConnect</h4>
<p>Our indexes are designed based on actual query patterns observed in
the application. Each index targets specific, frequently-executed
queries that were identified through performance profiling:</p>
<div class="sourceCode" id="cb138"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Optimized indexes for common queries</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- Index 1: Composite index for vital signs queries</span></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- Covers the most common query pattern: &quot;Get all vitals of a specific type for a user, ordered by time&quot;</span></span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- Example query: SELECT * FROM vital_signs </span></span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a><span class="co">--                WHERE user_id = 123 AND type = &#39;blood_pressure&#39; </span></span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a><span class="co">--                ORDER BY measurement_time DESC</span></span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a><span class="co">-- Why composite (user_id, type, measurement_time)?</span></span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a><span class="co">-- - user_id first: Narrows down to one user&#39;s data (most selective)</span></span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- - type second: Further filters to specific vital type</span></span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a><span class="co">-- - measurement_time DESC: Ordering by index column is free (no separate sort step)</span></span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true" tabindex="-1"></a><span class="co">-- Query execution with this index:</span></span>
<span id="cb138-15"><a href="#cb138-15" aria-hidden="true" tabindex="-1"></a><span class="co">-- 1. Jump to user_id = 123 section of index</span></span>
<span id="cb138-16"><a href="#cb138-16" aria-hidden="true" tabindex="-1"></a><span class="co">-- 2. Filter to type = &#39;blood_pressure&#39; rows</span></span>
<span id="cb138-17"><a href="#cb138-17" aria-hidden="true" tabindex="-1"></a><span class="co">-- 3. Results already sorted by measurement_time DESC (no extra sort!)</span></span>
<span id="cb138-18"><a href="#cb138-18" aria-hidden="true" tabindex="-1"></a><span class="co">-- Query time: &lt;1ms even with millions of vitals</span></span>
<span id="cb138-19"><a href="#cb138-19" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb138-20"><a href="#cb138-20" aria-hidden="true" tabindex="-1"></a><span class="co">-- Without this index:</span></span>
<span id="cb138-21"><a href="#cb138-21" aria-hidden="true" tabindex="-1"></a><span class="co">-- 1. Sequential scan of entire table (millions of rows)</span></span>
<span id="cb138-22"><a href="#cb138-22" aria-hidden="true" tabindex="-1"></a><span class="co">-- 2. Filter by user_id and type</span></span>
<span id="cb138-23"><a href="#cb138-23" aria-hidden="true" tabindex="-1"></a><span class="co">-- 3. Sort results by measurement_time (expensive!)</span></span>
<span id="cb138-24"><a href="#cb138-24" aria-hidden="true" tabindex="-1"></a><span class="co">-- Query time: 500ms+</span></span>
<span id="cb138-25"><a href="#cb138-25" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_vital_signs_user_type_time <span class="kw">ON</span> vital_signs(user_id, <span class="kw">type</span>, measurement_time <span class="kw">DESC</span>);</span>
<span id="cb138-26"><a href="#cb138-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-27"><a href="#cb138-27" aria-hidden="true" tabindex="-1"></a><span class="co">-- Index 2: Users by role and active status</span></span>
<span id="cb138-28"><a href="#cb138-28" aria-hidden="true" tabindex="-1"></a><span class="co">-- Covers admin queries: &quot;Find all active caregivers&quot; or &quot;Find all active patients&quot;</span></span>
<span id="cb138-29"><a href="#cb138-29" aria-hidden="true" tabindex="-1"></a><span class="co">-- Example query: SELECT * FROM users WHERE role = &#39;CAREGIVER&#39; AND active = true</span></span>
<span id="cb138-30"><a href="#cb138-30" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb138-31"><a href="#cb138-31" aria-hidden="true" tabindex="-1"></a><span class="co">-- Why needed?</span></span>
<span id="cb138-32"><a href="#cb138-32" aria-hidden="true" tabindex="-1"></a><span class="co">-- - Admin dashboard shows user lists filtered by role and status</span></span>
<span id="cb138-33"><a href="#cb138-33" aria-hidden="true" tabindex="-1"></a><span class="co">-- - Login system checks if user exists and is active</span></span>
<span id="cb138-34"><a href="#cb138-34" aria-hidden="true" tabindex="-1"></a><span class="co">-- - Notification system finds all active caregivers for a patient</span></span>
<span id="cb138-35"><a href="#cb138-35" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb138-36"><a href="#cb138-36" aria-hidden="true" tabindex="-1"></a><span class="co">-- Column order matters:</span></span>
<span id="cb138-37"><a href="#cb138-37" aria-hidden="true" tabindex="-1"></a><span class="co">-- - (role, active) is correct: role has higher cardinality (4-5 distinct values)</span></span>
<span id="cb138-38"><a href="#cb138-38" aria-hidden="true" tabindex="-1"></a><span class="co">-- - (active, role) would be wrong: active is boolean (only 2 values, low selectivity)</span></span>
<span id="cb138-39"><a href="#cb138-39" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb138-40"><a href="#cb138-40" aria-hidden="true" tabindex="-1"></a><span class="co">-- Performance impact:</span></span>
<span id="cb138-41"><a href="#cb138-41" aria-hidden="true" tabindex="-1"></a><span class="co">-- - With index: Find all active caregivers in 1ms</span></span>
<span id="cb138-42"><a href="#cb138-42" aria-hidden="true" tabindex="-1"></a><span class="co">-- - Without index: Scan all users (could be 100,000+), takes 100ms+</span></span>
<span id="cb138-43"><a href="#cb138-43" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_users_role_active <span class="kw">ON</span> users(<span class="kw">role</span>, active);</span>
<span id="cb138-44"><a href="#cb138-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-45"><a href="#cb138-45" aria-hidden="true" tabindex="-1"></a><span class="co">-- Index 3: Messages by conversation, ordered by time</span></span>
<span id="cb138-46"><a href="#cb138-46" aria-hidden="true" tabindex="-1"></a><span class="co">-- Covers messaging queries: &quot;Load recent messages for a conversation&quot;</span></span>
<span id="cb138-47"><a href="#cb138-47" aria-hidden="true" tabindex="-1"></a><span class="co">-- Example query: SELECT * FROM messages </span></span>
<span id="cb138-48"><a href="#cb138-48" aria-hidden="true" tabindex="-1"></a><span class="co">--                WHERE conversation_id = 456 </span></span>
<span id="cb138-49"><a href="#cb138-49" aria-hidden="true" tabindex="-1"></a><span class="co">--                ORDER BY sent_at DESC </span></span>
<span id="cb138-50"><a href="#cb138-50" aria-hidden="true" tabindex="-1"></a><span class="co">--                LIMIT 50</span></span>
<span id="cb138-51"><a href="#cb138-51" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb138-52"><a href="#cb138-52" aria-hidden="true" tabindex="-1"></a><span class="co">-- Why DESC in index?</span></span>
<span id="cb138-53"><a href="#cb138-53" aria-hidden="true" tabindex="-1"></a><span class="co">-- - We always want newest messages first (DESC order)</span></span>
<span id="cb138-54"><a href="#cb138-54" aria-hidden="true" tabindex="-1"></a><span class="co">-- - Index stores data pre-sorted in DESC order</span></span>
<span id="cb138-55"><a href="#cb138-55" aria-hidden="true" tabindex="-1"></a><span class="co">-- - PostgreSQL can read index forward without additional sorting</span></span>
<span id="cb138-56"><a href="#cb138-56" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb138-57"><a href="#cb138-57" aria-hidden="true" tabindex="-1"></a><span class="co">-- Real-world impact:</span></span>
<span id="cb138-58"><a href="#cb138-58" aria-hidden="true" tabindex="-1"></a><span class="co">-- - Healthcare conversations can have 1000+ messages</span></span>
<span id="cb138-59"><a href="#cb138-59" aria-hidden="true" tabindex="-1"></a><span class="co">-- - Loading latest 50 messages is near-instant with this index</span></span>
<span id="cb138-60"><a href="#cb138-60" aria-hidden="true" tabindex="-1"></a><span class="co">-- - Without index: Load all 1000+ messages, sort them, take top 50 (wasteful!)</span></span>
<span id="cb138-61"><a href="#cb138-61" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_messages_conversation_time <span class="kw">ON</span> messages(conversation_id, sent_at <span class="kw">DESC</span>);</span></code></pre></div>
<h4 id="index-design-principles-applied">Index Design Principles
Applied</h4>
<p><strong>1. Composite Index Column Order</strong>:</p>
<div class="sourceCode" id="cb139"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- GOOD: More selective column first</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_user_email <span class="kw">ON</span> users(email, active);</span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- email is unique (high selectivity)</span></span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- active is boolean (low selectivity)</span></span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- BAD: Less selective column first</span></span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_active_email <span class="kw">ON</span> users(active, email);</span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- active only has 2 values, not selective</span></span></code></pre></div>
<p><strong>2. Covering Indexes</strong> (includes all columns needed by
query):</p>
<div class="sourceCode" id="cb140"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Query: SELECT type, value, unit FROM vital_signs WHERE user_id = 123</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- Index covers user_id (WHERE), type, value, unit (SELECT)</span></span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_vitals_covering <span class="kw">ON</span> vital_signs(user_id, <span class="kw">type</span>, <span class="fu">value</span>, unit);</span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- PostgreSQL can answer query entirely from index (index-only scan)</span></span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- Never needs to access table data at all!</span></span></code></pre></div>
<p><strong>3. Partial Indexes</strong> (indexes only relevant rows):</p>
<div class="sourceCode" id="cb141"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- We only care about active users in most queries</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- No point indexing inactive users (saves 20% space)</span></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_active_users <span class="kw">ON</span> users(<span class="kw">role</span>) <span class="kw">WHERE</span> active <span class="op">=</span> <span class="kw">true</span>;</span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- Smaller index → fits in RAM → faster queries</span></span></code></pre></div>
<h4 id="table-partitioning-for-large-datasets">Table Partitioning for
Large Datasets</h4>
<p>As vital signs accumulate (millions per year), a single table becomes
unwieldy. PostgreSQL’s partitioning feature splits a large table into
smaller, manageable pieces based on a column value (like year). Queries
that filter by the partition key only scan the relevant partition,
dramatically improving performance.</p>
<p><strong>How Partitioning Works</strong>: - Main table
(<code>vital_signs</code>) is a “parent” that defines structure -
Partition tables (p2023, p2024, etc.) are “children” that hold actual
data - PostgreSQL automatically routes INSERTs to the correct partition
- Queries that filter by year only scan that year’s partition</p>
<p><strong>Real-World Benefit</strong>: - Query: “Find vitals from 2024”
(assuming 10 million vitals total) - Without partitioning: Scan all 10
million vitals, filter by year - With partitioning: Only scan p2024
partition (2 million vitals), skip other 8 million - <strong>5x
faster</strong></p>
<p><strong>Partitioning Strategy for CareConnect</strong>:</p>
<div class="sourceCode" id="cb142"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Partitioning for large tables</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- Partition by YEAR(measurement_time) because:</span></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- 1. Vitals accumulate over time (millions per year)</span></span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- 2. Most queries filter by date range (&quot;last 30 days&quot;, &quot;this year&quot;)</span></span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- 3. Old data (2-3 years old) rarely accessed → can be archived or moved to slower storage</span></span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> vital_signs <span class="kw">PARTITION</span> <span class="kw">BY</span> <span class="kw">RANGE</span> (<span class="dt">YEAR</span>(measurement_time)) (</span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Partition for 2023 data</span></span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Holds all vitals where YEAR(measurement_time) &lt; 2024</span></span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">PARTITION</span> p2023 <span class="kw">VALUES</span> <span class="kw">LESS</span> <span class="kw">THAN</span> (<span class="dv">2024</span>),</span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Partition for 2024 data</span></span>
<span id="cb142-12"><a href="#cb142-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Holds all vitals where YEAR(measurement_time) &gt;= 2024 AND &lt; 2025</span></span>
<span id="cb142-13"><a href="#cb142-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">PARTITION</span> p2024 <span class="kw">VALUES</span> <span class="kw">LESS</span> <span class="kw">THAN</span> (<span class="dv">2025</span>),</span>
<span id="cb142-14"><a href="#cb142-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-15"><a href="#cb142-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Partition for 2025 data</span></span>
<span id="cb142-16"><a href="#cb142-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">PARTITION</span> p2025 <span class="kw">VALUES</span> <span class="kw">LESS</span> <span class="kw">THAN</span> (<span class="dv">2026</span>),</span>
<span id="cb142-17"><a href="#cb142-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-18"><a href="#cb142-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Catch-all partition for future years</span></span>
<span id="cb142-19"><a href="#cb142-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- PostgreSQL requires this to prevent &quot;no partition found&quot; errors</span></span>
<span id="cb142-20"><a href="#cb142-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Future years (2026+) go here until we create specific partitions</span></span>
<span id="cb142-21"><a href="#cb142-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">PARTITION</span> pmax <span class="kw">VALUES</span> <span class="kw">LESS</span> <span class="kw">THAN</span> <span class="kw">MAXVALUE</span></span>
<span id="cb142-22"><a href="#cb142-22" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<h4 id="partition-maintenance-strategy">Partition Maintenance
Strategy</h4>
<p><strong>Yearly Routine</strong> (January each year):</p>
<div class="sourceCode" id="cb143"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Create next year&#39;s partition (e.g., in January 2026)</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> vital_signs <span class="kw">ADD</span> <span class="kw">PARTITION</span> p2026 <span class="kw">VALUES</span> <span class="kw">LESS</span> <span class="kw">THAN</span> (<span class="dv">2027</span>);</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- Archive old data (e.g., 2023 data is 3+ years old)</span></span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- Option 1: Move to archive table (rarely queried, but kept for compliance)</span></span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> vital_signs_archive <span class="kw">PARTITION</span> <span class="kw">OF</span> vital_signs <span class="cf">FOR</span> <span class="kw">VALUES</span> <span class="kw">FROM</span> (<span class="dv">2020</span>) <span class="kw">TO</span> (<span class="dv">2024</span>);</span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- Option 2: Detach partition entirely (for backup or deletion)</span></span>
<span id="cb143-9"><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> vital_signs DETACH <span class="kw">PARTITION</span> p2023;</span>
<span id="cb143-10"><a href="#cb143-10" aria-hidden="true" tabindex="-1"></a><span class="co">-- Now p2023 is a standalone table, can be backed up to S3 and dropped</span></span></code></pre></div>
<p><strong>Benefits of This Approach</strong>: -
<strong>Performance</strong>: Queries scan only relevant year’s data -
<strong>Maintenance</strong>: Can VACUUM, REINDEX individual partitions
without locking entire table - <strong>Archival</strong>: Easy to move
old data to cheaper storage (S3, tape backup) -
<strong>Compliance</strong>: HIPAA requires 7 years of data retention,
partitioning makes this manageable</p>
<h4 id="monitoring-index-usage">Monitoring Index Usage</h4>
<p>Not all indexes are useful—unused indexes waste space and slow down
writes. PostgreSQL tracks index usage statistics to identify unused
indexes:</p>
<div class="sourceCode" id="cb144"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Find unused indexes (candidates for deletion)</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>    schemaname,</span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>    tablename,</span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>    indexname,</span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>    idx_scan,  <span class="co">-- Number of times index was scanned (used)</span></span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a>    pg_size_pretty(pg_relation_size(indexrelid)) <span class="kw">AS</span> index_size</span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> pg_stat_user_indexes</span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> idx_scan <span class="op">=</span> <span class="dv">0</span>  <span class="co">-- Never used</span></span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> pg_relation_size(indexrelid) <span class="kw">DESC</span>;</span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a><span class="co">-- Output example:</span></span>
<span id="cb144-13"><a href="#cb144-13" aria-hidden="true" tabindex="-1"></a><span class="co">-- tablename | indexname | idx_scan | index_size</span></span>
<span id="cb144-14"><a href="#cb144-14" aria-hidden="true" tabindex="-1"></a><span class="co">-- messages  | idx_msg_status | 0 | 120 MB</span></span>
<span id="cb144-15"><a href="#cb144-15" aria-hidden="true" tabindex="-1"></a><span class="co">-- → This index takes 120MB but is never used, safe to drop</span></span></code></pre></div>
<h4 id="index-best-practices-for-healthcare-data">Index Best Practices
for Healthcare Data</h4>
<ol type="1">
<li><strong>Index Foreign Keys</strong>: Always index columns used in
JOINs (e.g., <code>user_id</code> in <code>vital_signs</code>)</li>
<li><strong>Index Date Ranges</strong>: Healthcare queries often filter
by date (“last 30 days”), index timestamp columns</li>
<li><strong>Avoid Over-Indexing</strong>: Each index slows down
INSERTs/UPDATEs, limit to truly necessary indexes</li>
<li><strong>Use Partial Indexes</strong>: If 90% of queries filter by
<code>active = true</code>, create partial index on active rows
only</li>
<li><strong>Monitor Query Performance</strong>: Use
<code>EXPLAIN ANALYZE</code> to see if indexes are actually used</li>
</ol>
<p><strong>Example of Query Analysis</strong>:</p>
<div class="sourceCode" id="cb145"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Check if query uses our index</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPLAIN</span> <span class="kw">ANALYZE</span> </span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> vital_signs </span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> user_id <span class="op">=</span> <span class="dv">123</span> <span class="kw">AND</span> <span class="kw">type</span> <span class="op">=</span> <span class="st">&#39;blood_pressure&#39;</span> </span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> measurement_time <span class="kw">DESC</span>;</span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- Good output:</span></span>
<span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- Index Scan using idx_vital_signs_user_type_time (cost=0.42..8.44 rows=1 width=100)</span></span>
<span id="cb145-9"><a href="#cb145-9" aria-hidden="true" tabindex="-1"></a><span class="co">-- → Query uses our index, execution time &lt;1ms</span></span>
<span id="cb145-10"><a href="#cb145-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-11"><a href="#cb145-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- Bad output:</span></span>
<span id="cb145-12"><a href="#cb145-12" aria-hidden="true" tabindex="-1"></a><span class="co">-- Seq Scan on vital_signs (cost=0.00..1000000 rows=1000000 width=100)</span></span>
<span id="cb145-13"><a href="#cb145-13" aria-hidden="true" tabindex="-1"></a><span class="co">-- → Query scans entire table, execution time 500ms+, needs index!</span></span></code></pre></div>
<p>By strategically designing indexes and partitions, CareConnect
maintains sub-10ms query times even with millions of records, ensuring a
responsive user experience critical for healthcare workflows.</p>
<h2 id="deployment-pipeline">Deployment Pipeline</h2>
<h3 id="github-actions-cicd">GitHub Actions CI/CD</h3>
<div class="sourceCode" id="cb146"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="co"># .github/workflows/ci-cd.yml</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> CI/CD Pipeline</span></span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">push</span><span class="kw">:</span></span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">main</span><span class="kw">,</span><span class="at"> develop</span><span class="kw">]</span></span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">pull_request</span><span class="kw">:</span></span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">main</span><span class="kw">]</span></span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb146-11"><a href="#cb146-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">test-frontend</span><span class="kw">:</span></span>
<span id="cb146-12"><a href="#cb146-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb146-13"><a href="#cb146-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">defaults</span><span class="kw">:</span></span>
<span id="cb146-14"><a href="#cb146-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb146-15"><a href="#cb146-15" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">working-directory</span><span class="kw">:</span><span class="at"> frontend</span></span>
<span id="cb146-16"><a href="#cb146-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-17"><a href="#cb146-17" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb146-18"><a href="#cb146-18" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v3</span></span>
<span id="cb146-19"><a href="#cb146-19" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> subosito/flutter-action@v2</span></span>
<span id="cb146-20"><a href="#cb146-20" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb146-21"><a href="#cb146-21" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">flutter-version</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;3.9.2&#39;</span></span>
<span id="cb146-22"><a href="#cb146-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-23"><a href="#cb146-23" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install dependencies</span></span>
<span id="cb146-24"><a href="#cb146-24" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span><span class="at"> flutter pub get</span></span>
<span id="cb146-25"><a href="#cb146-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-26"><a href="#cb146-26" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run tests</span></span>
<span id="cb146-27"><a href="#cb146-27" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span><span class="at"> flutter test</span></span>
<span id="cb146-28"><a href="#cb146-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-29"><a href="#cb146-29" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Build web</span></span>
<span id="cb146-30"><a href="#cb146-30" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span><span class="at"> flutter build web</span></span>
<span id="cb146-31"><a href="#cb146-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-32"><a href="#cb146-32" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">test-backend</span><span class="kw">:</span></span>
<span id="cb146-33"><a href="#cb146-33" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb146-34"><a href="#cb146-34" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">defaults</span><span class="kw">:</span></span>
<span id="cb146-35"><a href="#cb146-35" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb146-36"><a href="#cb146-36" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">working-directory</span><span class="kw">:</span><span class="at"> backend/core</span></span>
<span id="cb146-37"><a href="#cb146-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-38"><a href="#cb146-38" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb146-39"><a href="#cb146-39" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">postgres</span><span class="kw">:</span></span>
<span id="cb146-40"><a href="#cb146-40" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> postgres:15</span></span>
<span id="cb146-41"><a href="#cb146-41" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb146-42"><a href="#cb146-42" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">POSTGRES_PASSWORD</span><span class="kw">:</span><span class="at"> test</span></span>
<span id="cb146-43"><a href="#cb146-43" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">POSTGRES_USER</span><span class="kw">:</span><span class="at"> careconnect</span></span>
<span id="cb146-44"><a href="#cb146-44" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">POSTGRES_DB</span><span class="kw">:</span><span class="at"> careconnect_test</span></span>
<span id="cb146-45"><a href="#cb146-45" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">options</span><span class="kw">:</span><span class="at"> --health-cmd=&quot;pg_isready&quot; --health-interval=10s --health-timeout=5s --health-retries=3</span></span>
<span id="cb146-46"><a href="#cb146-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-47"><a href="#cb146-47" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb146-48"><a href="#cb146-48" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v3</span></span>
<span id="cb146-49"><a href="#cb146-49" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/setup-java@v3</span></span>
<span id="cb146-50"><a href="#cb146-50" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb146-51"><a href="#cb146-51" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">java-version</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;17&#39;</span></span>
<span id="cb146-52"><a href="#cb146-52" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">distribution</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;adopt&#39;</span></span>
<span id="cb146-53"><a href="#cb146-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-54"><a href="#cb146-54" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Cache Maven packages</span></span>
<span id="cb146-55"><a href="#cb146-55" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/cache@v3</span></span>
<span id="cb146-56"><a href="#cb146-56" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb146-57"><a href="#cb146-57" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">path</span><span class="kw">:</span><span class="at"> ~/.m2</span></span>
<span id="cb146-58"><a href="#cb146-58" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">key</span><span class="kw">:</span><span class="at"> ${{ runner.os }}-m2-${{ hashFiles(&#39;**/pom.xml&#39;) }}</span></span>
<span id="cb146-59"><a href="#cb146-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-60"><a href="#cb146-60" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run tests</span></span>
<span id="cb146-61"><a href="#cb146-61" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span><span class="at"> ./mvnw test</span></span>
<span id="cb146-62"><a href="#cb146-62" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb146-63"><a href="#cb146-63" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">SPRING_DATASOURCE_URL</span><span class="kw">:</span><span class="at"> jdbc:postgresql://localhost:5432/careconnect_test</span></span>
<span id="cb146-64"><a href="#cb146-64" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">SPRING_DATASOURCE_USERNAME</span><span class="kw">:</span><span class="at"> careconnect</span></span>
<span id="cb146-65"><a href="#cb146-65" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">SPRING_DATASOURCE_PASSWORD</span><span class="kw">:</span><span class="at"> test</span></span>
<span id="cb146-66"><a href="#cb146-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-67"><a href="#cb146-67" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">deploy-staging</span><span class="kw">:</span></span>
<span id="cb146-68"><a href="#cb146-68" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">needs</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">test-frontend</span><span class="kw">,</span><span class="at"> test-backend</span><span class="kw">]</span></span>
<span id="cb146-69"><a href="#cb146-69" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb146-70"><a href="#cb146-70" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">if</span><span class="kw">:</span><span class="at"> github.ref == &#39;refs/heads/develop&#39;</span></span>
<span id="cb146-71"><a href="#cb146-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-72"><a href="#cb146-72" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb146-73"><a href="#cb146-73" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v3</span></span>
<span id="cb146-74"><a href="#cb146-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-75"><a href="#cb146-75" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Deploy to staging</span></span>
<span id="cb146-76"><a href="#cb146-76" aria-hidden="true" tabindex="-1"></a><span class="fu">      run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb146-77"><a href="#cb146-77" aria-hidden="true" tabindex="-1"></a>        # Deploy backend to staging</span>
<span id="cb146-78"><a href="#cb146-78" aria-hidden="true" tabindex="-1"></a>        docker build -t careconnect-backend:staging backend/core</span>
<span id="cb146-79"><a href="#cb146-79" aria-hidden="true" tabindex="-1"></a>        docker push ${{ secrets.ECR_REGISTRY }}/careconnect-backend:staging</span>
<span id="cb146-80"><a href="#cb146-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-81"><a href="#cb146-81" aria-hidden="true" tabindex="-1"></a>        # Deploy frontend to staging</span>
<span id="cb146-82"><a href="#cb146-82" aria-hidden="true" tabindex="-1"></a>        cd frontend</span>
<span id="cb146-83"><a href="#cb146-83" aria-hidden="true" tabindex="-1"></a>        flutter build web</span>
<span id="cb146-84"><a href="#cb146-84" aria-hidden="true" tabindex="-1"></a>        aws s3 sync build/web s3://${{ secrets.STAGING_BUCKET }}</span>
<span id="cb146-85"><a href="#cb146-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-86"><a href="#cb146-86" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">deploy-production</span><span class="kw">:</span></span>
<span id="cb146-87"><a href="#cb146-87" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">needs</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">test-frontend</span><span class="kw">,</span><span class="at"> test-backend</span><span class="kw">]</span></span>
<span id="cb146-88"><a href="#cb146-88" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb146-89"><a href="#cb146-89" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">if</span><span class="kw">:</span><span class="at"> github.ref == &#39;refs/heads/main&#39;</span></span>
<span id="cb146-90"><a href="#cb146-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-91"><a href="#cb146-91" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb146-92"><a href="#cb146-92" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v3</span></span>
<span id="cb146-93"><a href="#cb146-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-94"><a href="#cb146-94" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Deploy to production</span></span>
<span id="cb146-95"><a href="#cb146-95" aria-hidden="true" tabindex="-1"></a><span class="fu">      run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb146-96"><a href="#cb146-96" aria-hidden="true" tabindex="-1"></a>        # Production deployment with blue-green strategy</span>
<span id="cb146-97"><a href="#cb146-97" aria-hidden="true" tabindex="-1"></a>        ./scripts/deploy-production.sh</span></code></pre></div>
<h3 id="docker-configuration">Docker Configuration</h3>
<div class="sourceCode" id="cb147"><pre
class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="co"># backend/core/Dockerfile</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> openjdk:17-jdk-slim</span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /app</span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> pom.xml .</span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> mvnw .</span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> .mvn .mvn</span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">./mvnw</span> dependency:go-offline</span>
<span id="cb147-10"><a href="#cb147-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-11"><a href="#cb147-11" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> src src</span>
<span id="cb147-12"><a href="#cb147-12" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">./mvnw</span> package <span class="at">-DskipTests</span></span>
<span id="cb147-13"><a href="#cb147-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-14"><a href="#cb147-14" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPOSE</span> 8080</span>
<span id="cb147-15"><a href="#cb147-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-16"><a href="#cb147-16" aria-hidden="true" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;java&quot;</span>, <span class="st">&quot;-jar&quot;</span>, <span class="st">&quot;target/careconnect-backend-1.0.0.jar&quot;</span>]</span></code></pre></div>
<h3 id="terraform-infrastructure">Terraform Infrastructure</h3>
<pre class="hcl"><code># terraform_aws/main.tf
provider &quot;aws&quot; {
  region = var.aws_region
}

module &quot;vpc&quot; {
  source = &quot;./modules/vpc&quot;

  environment = var.environment
  cidr_block = var.vpc_cidr
}

module &quot;rds&quot; {
  source = &quot;./modules/rds&quot;

  environment = var.environment
  vpc_id = module.vpc.vpc_id
  subnet_ids = module.vpc.private_subnet_ids

  db_name = var.db_name
  db_username = var.db_username
  db_password = var.db_password
}

module &quot;ecs&quot; {
  source = &quot;./modules/ecs&quot;

  environment = var.environment
  vpc_id = module.vpc.vpc_id
  subnet_ids = module.vpc.private_subnet_ids

  backend_image = var.backend_image
  db_host = module.rds.db_endpoint
}</code></pre>
<h2 id="monitoring-logging">Monitoring &amp; Logging</h2>
<h3 id="application-monitoring">Application Monitoring</h3>
<div class="sourceCode" id="cb149"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="co">// config/MonitoringConfig.java</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Configuration</span></span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> MonitoringConfig <span class="op">{</span></span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> MeterRegistry <span class="fu">meterRegistry</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">PrometheusMeterRegistry</span><span class="op">(</span>PrometheusConfig<span class="op">.</span><span class="fu">DEFAULT</span><span class="op">);</span></span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb149-9"><a href="#cb149-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-10"><a href="#cb149-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb149-11"><a href="#cb149-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> TimedAspect <span class="fu">timedAspect</span><span class="op">(</span>MeterRegistry registry<span class="op">)</span> <span class="op">{</span></span>
<span id="cb149-12"><a href="#cb149-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">TimedAspect</span><span class="op">(</span>registry<span class="op">);</span></span>
<span id="cb149-13"><a href="#cb149-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb149-14"><a href="#cb149-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb149-15"><a href="#cb149-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-16"><a href="#cb149-16" aria-hidden="true" tabindex="-1"></a><span class="co">// Custom metrics</span></span>
<span id="cb149-17"><a href="#cb149-17" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb149-18"><a href="#cb149-18" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> MetricsService <span class="op">{</span></span>
<span id="cb149-19"><a href="#cb149-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-20"><a href="#cb149-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> Counter userLoginCounter<span class="op">;</span></span>
<span id="cb149-21"><a href="#cb149-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> <span class="bu">Timer</span> apiResponseTimer<span class="op">;</span></span>
<span id="cb149-22"><a href="#cb149-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-23"><a href="#cb149-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">MetricsService</span><span class="op">(</span>MeterRegistry meterRegistry<span class="op">)</span> <span class="op">{</span></span>
<span id="cb149-24"><a href="#cb149-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">userLoginCounter</span> <span class="op">=</span> Counter<span class="op">.</span><span class="fu">builder</span><span class="op">(</span><span class="st">&quot;user.login.count&quot;</span><span class="op">)</span></span>
<span id="cb149-25"><a href="#cb149-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">description</span><span class="op">(</span><span class="st">&quot;Number of user logins&quot;</span><span class="op">)</span></span>
<span id="cb149-26"><a href="#cb149-26" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">register</span><span class="op">(</span>meterRegistry<span class="op">);</span></span>
<span id="cb149-27"><a href="#cb149-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-28"><a href="#cb149-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">apiResponseTimer</span> <span class="op">=</span> <span class="bu">Timer</span><span class="op">.</span><span class="fu">builder</span><span class="op">(</span><span class="st">&quot;api.response.time&quot;</span><span class="op">)</span></span>
<span id="cb149-29"><a href="#cb149-29" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">description</span><span class="op">(</span><span class="st">&quot;API response time&quot;</span><span class="op">)</span></span>
<span id="cb149-30"><a href="#cb149-30" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">register</span><span class="op">(</span>meterRegistry<span class="op">);</span></span>
<span id="cb149-31"><a href="#cb149-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb149-32"><a href="#cb149-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-33"><a href="#cb149-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">recordLogin</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb149-34"><a href="#cb149-34" aria-hidden="true" tabindex="-1"></a>        userLoginCounter<span class="op">.</span><span class="fu">increment</span><span class="op">();</span></span>
<span id="cb149-35"><a href="#cb149-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb149-36"><a href="#cb149-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-37"><a href="#cb149-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">recordApiResponse</span><span class="op">(</span><span class="bu">Duration</span> duration<span class="op">)</span> <span class="op">{</span></span>
<span id="cb149-38"><a href="#cb149-38" aria-hidden="true" tabindex="-1"></a>        apiResponseTimer<span class="op">.</span><span class="fu">record</span><span class="op">(</span>duration<span class="op">);</span></span>
<span id="cb149-39"><a href="#cb149-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb149-40"><a href="#cb149-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="logging-configuration">Logging Configuration</h3>
<div class="sourceCode" id="cb150"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="co"># backend/core/src/main/resources/logback-spring.xml</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a><span class="at">&lt;configuration&gt;</span></span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a><span class="at">    &lt;springProfile name=&quot;!prod&quot;&gt;</span></span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a><span class="at">        &lt;appender name=&quot;CONSOLE&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;</span></span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a><span class="at">            &lt;encoder&gt;</span></span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a><span class="at">                &lt;pattern&gt;%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n&lt;/pattern&gt;</span></span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a><span class="at">            &lt;/encoder&gt;</span></span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a><span class="at">        &lt;/appender&gt;</span></span>
<span id="cb150-9"><a href="#cb150-9" aria-hidden="true" tabindex="-1"></a><span class="at">        &lt;root level=&quot;INFO&quot;&gt;</span></span>
<span id="cb150-10"><a href="#cb150-10" aria-hidden="true" tabindex="-1"></a><span class="at">            &lt;appender-ref ref=&quot;CONSOLE&quot; /&gt;</span></span>
<span id="cb150-11"><a href="#cb150-11" aria-hidden="true" tabindex="-1"></a><span class="at">        &lt;/root&gt;</span></span>
<span id="cb150-12"><a href="#cb150-12" aria-hidden="true" tabindex="-1"></a><span class="at">    &lt;/springProfile&gt;</span></span>
<span id="cb150-13"><a href="#cb150-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-14"><a href="#cb150-14" aria-hidden="true" tabindex="-1"></a><span class="at">    &lt;springProfile name=&quot;prod&quot;&gt;</span></span>
<span id="cb150-15"><a href="#cb150-15" aria-hidden="true" tabindex="-1"></a><span class="at">        &lt;appender name=&quot;FILE&quot; class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span></span>
<span id="cb150-16"><a href="#cb150-16" aria-hidden="true" tabindex="-1"></a><span class="at">            &lt;file&gt;/app/logs/careconnect.log&lt;/file&gt;</span></span>
<span id="cb150-17"><a href="#cb150-17" aria-hidden="true" tabindex="-1"></a><span class="at">            &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;&gt;</span></span>
<span id="cb150-18"><a href="#cb150-18" aria-hidden="true" tabindex="-1"></a><span class="at">                &lt;fileNamePattern&gt;/app/logs/careconnect.%d{yyyy-MM-dd}.log&lt;/fileNamePattern&gt;</span></span>
<span id="cb150-19"><a href="#cb150-19" aria-hidden="true" tabindex="-1"></a><span class="at">                &lt;maxHistory&gt;30&lt;/maxHistory&gt;</span></span>
<span id="cb150-20"><a href="#cb150-20" aria-hidden="true" tabindex="-1"></a><span class="at">            &lt;/rollingPolicy&gt;</span></span>
<span id="cb150-21"><a href="#cb150-21" aria-hidden="true" tabindex="-1"></a><span class="at">            &lt;encoder class=&quot;net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder&quot;&gt;</span></span>
<span id="cb150-22"><a href="#cb150-22" aria-hidden="true" tabindex="-1"></a><span class="at">                &lt;providers&gt;</span></span>
<span id="cb150-23"><a href="#cb150-23" aria-hidden="true" tabindex="-1"></a><span class="at">                    &lt;timestamp /&gt;</span></span>
<span id="cb150-24"><a href="#cb150-24" aria-hidden="true" tabindex="-1"></a><span class="at">                    &lt;logLevel /&gt;</span></span>
<span id="cb150-25"><a href="#cb150-25" aria-hidden="true" tabindex="-1"></a><span class="at">                    &lt;loggerName /&gt;</span></span>
<span id="cb150-26"><a href="#cb150-26" aria-hidden="true" tabindex="-1"></a><span class="at">                    &lt;message /&gt;</span></span>
<span id="cb150-27"><a href="#cb150-27" aria-hidden="true" tabindex="-1"></a><span class="at">                    &lt;mdc /&gt;</span></span>
<span id="cb150-28"><a href="#cb150-28" aria-hidden="true" tabindex="-1"></a><span class="at">                    &lt;stackTrace /&gt;</span></span>
<span id="cb150-29"><a href="#cb150-29" aria-hidden="true" tabindex="-1"></a><span class="at">                &lt;/providers&gt;</span></span>
<span id="cb150-30"><a href="#cb150-30" aria-hidden="true" tabindex="-1"></a><span class="at">            &lt;/encoder&gt;</span></span>
<span id="cb150-31"><a href="#cb150-31" aria-hidden="true" tabindex="-1"></a><span class="at">        &lt;/appender&gt;</span></span>
<span id="cb150-32"><a href="#cb150-32" aria-hidden="true" tabindex="-1"></a><span class="at">        &lt;root level=&quot;INFO&quot;&gt;</span></span>
<span id="cb150-33"><a href="#cb150-33" aria-hidden="true" tabindex="-1"></a><span class="at">            &lt;appender-ref ref=&quot;FILE&quot; /&gt;</span></span>
<span id="cb150-34"><a href="#cb150-34" aria-hidden="true" tabindex="-1"></a><span class="at">        &lt;/root&gt;</span></span>
<span id="cb150-35"><a href="#cb150-35" aria-hidden="true" tabindex="-1"></a><span class="at">    &lt;/springProfile&gt;</span></span>
<span id="cb150-36"><a href="#cb150-36" aria-hidden="true" tabindex="-1"></a><span class="at">&lt;/configuration&gt;</span></span></code></pre></div>
<h2 id="code-standards-best-practices">Code Standards &amp; Best
Practices</h2>
<h3 id="flutter-code-standards">Flutter Code Standards</h3>
<div class="sourceCode" id="cb151"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Good example - following naming conventions and structure</span></span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HealthDataProvider <span class="kw">extends</span> ChangeNotifier {</span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> HealthService _healthService;</span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">List</span><span class="op">&lt;</span>VitalSign<span class="op">&gt;</span> _vitalSigns <span class="op">=</span> [];</span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> _isLoading <span class="op">=</span> <span class="cn">false</span>;</span>
<span id="cb151-6"><a href="#cb151-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">String</span><span class="op">?</span> _error;</span>
<span id="cb151-7"><a href="#cb151-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-8"><a href="#cb151-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Getters</span></span>
<span id="cb151-9"><a href="#cb151-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">List</span><span class="op">&lt;</span>VitalSign<span class="op">&gt;</span> <span class="kw">get</span> vitalSigns <span class="op">=&gt;</span> <span class="dt">List</span><span class="op">.</span>unmodifiable(_vitalSigns);</span>
<span id="cb151-10"><a href="#cb151-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> <span class="kw">get</span> isLoading <span class="op">=&gt;</span> _isLoading;</span>
<span id="cb151-11"><a href="#cb151-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">String</span><span class="op">?</span> <span class="kw">get</span> error <span class="op">=&gt;</span> _error;</span>
<span id="cb151-12"><a href="#cb151-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-13"><a href="#cb151-13" aria-hidden="true" tabindex="-1"></a>  HealthDataProvider(<span class="kw">this</span><span class="op">.</span>_healthService);</span>
<span id="cb151-14"><a href="#cb151-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-15"><a href="#cb151-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> loadVitalSigns() <span class="at">async</span> {</span>
<span id="cb151-16"><a href="#cb151-16" aria-hidden="true" tabindex="-1"></a>    _setLoading(<span class="cn">true</span>);</span>
<span id="cb151-17"><a href="#cb151-17" aria-hidden="true" tabindex="-1"></a>    _clearError();</span>
<span id="cb151-18"><a href="#cb151-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-19"><a href="#cb151-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb151-20"><a href="#cb151-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">final</span> signs <span class="op">=</span> <span class="at">await</span> _healthService<span class="op">.</span>getVitalSigns();</span>
<span id="cb151-21"><a href="#cb151-21" aria-hidden="true" tabindex="-1"></a>      _vitalSigns<span class="op">.</span>clear();</span>
<span id="cb151-22"><a href="#cb151-22" aria-hidden="true" tabindex="-1"></a>      _vitalSigns<span class="op">.</span>addAll(signs);</span>
<span id="cb151-23"><a href="#cb151-23" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (e) {</span>
<span id="cb151-24"><a href="#cb151-24" aria-hidden="true" tabindex="-1"></a>      _setError(<span class="st">&#39;Failed to load vital signs: $e&#39;</span>);</span>
<span id="cb151-25"><a href="#cb151-25" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">finally</span> {</span>
<span id="cb151-26"><a href="#cb151-26" aria-hidden="true" tabindex="-1"></a>      _setLoading(<span class="cn">false</span>);</span>
<span id="cb151-27"><a href="#cb151-27" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb151-28"><a href="#cb151-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb151-29"><a href="#cb151-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-30"><a href="#cb151-30" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> _setLoading(<span class="dt">bool</span> loading) {</span>
<span id="cb151-31"><a href="#cb151-31" aria-hidden="true" tabindex="-1"></a>    _isLoading <span class="op">=</span> loading;</span>
<span id="cb151-32"><a href="#cb151-32" aria-hidden="true" tabindex="-1"></a>    notifyListeners();</span>
<span id="cb151-33"><a href="#cb151-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb151-34"><a href="#cb151-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-35"><a href="#cb151-35" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> _setError(<span class="dt">String</span><span class="op">?</span> error) {</span>
<span id="cb151-36"><a href="#cb151-36" aria-hidden="true" tabindex="-1"></a>    _error <span class="op">=</span> error;</span>
<span id="cb151-37"><a href="#cb151-37" aria-hidden="true" tabindex="-1"></a>    notifyListeners();</span>
<span id="cb151-38"><a href="#cb151-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb151-39"><a href="#cb151-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-40"><a href="#cb151-40" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> _clearError() <span class="op">=&gt;</span> _setError(<span class="cn">null</span>);</span>
<span id="cb151-41"><a href="#cb151-41" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="java-code-standards">Java Code Standards</h3>
<div class="sourceCode" id="cb152"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Good example - following SOLID principles and clean code</span></span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a><span class="at">@Transactional</span></span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> HealthServiceImpl <span class="kw">implements</span> HealthService <span class="op">{</span></span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">Logger</span> log <span class="op">=</span> LoggerFactory<span class="op">.</span><span class="fu">getLogger</span><span class="op">(</span>HealthServiceImpl<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-8"><a href="#cb152-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> VitalSignRepository vitalSignRepository<span class="op">;</span></span>
<span id="cb152-9"><a href="#cb152-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> UserRepository userRepository<span class="op">;</span></span>
<span id="cb152-10"><a href="#cb152-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> NotificationService notificationService<span class="op">;</span></span>
<span id="cb152-11"><a href="#cb152-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> VitalSignValidator vitalSignValidator<span class="op">;</span></span>
<span id="cb152-12"><a href="#cb152-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-13"><a href="#cb152-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">HealthServiceImpl</span><span class="op">(</span></span>
<span id="cb152-14"><a href="#cb152-14" aria-hidden="true" tabindex="-1"></a>            VitalSignRepository vitalSignRepository<span class="op">,</span></span>
<span id="cb152-15"><a href="#cb152-15" aria-hidden="true" tabindex="-1"></a>            UserRepository userRepository<span class="op">,</span></span>
<span id="cb152-16"><a href="#cb152-16" aria-hidden="true" tabindex="-1"></a>            NotificationService notificationService<span class="op">,</span></span>
<span id="cb152-17"><a href="#cb152-17" aria-hidden="true" tabindex="-1"></a>            VitalSignValidator vitalSignValidator<span class="op">)</span> <span class="op">{</span></span>
<span id="cb152-18"><a href="#cb152-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">vitalSignRepository</span> <span class="op">=</span> vitalSignRepository<span class="op">;</span></span>
<span id="cb152-19"><a href="#cb152-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">userRepository</span> <span class="op">=</span> userRepository<span class="op">;</span></span>
<span id="cb152-20"><a href="#cb152-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">notificationService</span> <span class="op">=</span> notificationService<span class="op">;</span></span>
<span id="cb152-21"><a href="#cb152-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">vitalSignValidator</span> <span class="op">=</span> vitalSignValidator<span class="op">;</span></span>
<span id="cb152-22"><a href="#cb152-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb152-23"><a href="#cb152-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-24"><a href="#cb152-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb152-25"><a href="#cb152-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Cacheable</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;user_vitals&quot;</span><span class="op">,</span> key <span class="op">=</span> <span class="st">&quot;#userId&quot;</span><span class="op">)</span></span>
<span id="cb152-26"><a href="#cb152-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">List</span><span class="op">&lt;</span>VitalSignDTO<span class="op">&gt;</span> <span class="fu">getVitalSigns</span><span class="op">(</span><span class="bu">Long</span> userId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb152-27"><a href="#cb152-27" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">debug</span><span class="op">(</span><span class="st">&quot;Fetching vital signs for user: {}&quot;</span><span class="op">,</span> userId<span class="op">);</span></span>
<span id="cb152-28"><a href="#cb152-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-29"><a href="#cb152-29" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span>VitalSign<span class="op">&gt;</span> vitalSigns <span class="op">=</span> vitalSignRepository</span>
<span id="cb152-30"><a href="#cb152-30" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">findByUserIdOrderByMeasurementTimeDesc</span><span class="op">(</span>userId<span class="op">);</span></span>
<span id="cb152-31"><a href="#cb152-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-32"><a href="#cb152-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> vitalSigns<span class="op">.</span><span class="fu">stream</span><span class="op">()</span></span>
<span id="cb152-33"><a href="#cb152-33" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">map</span><span class="op">(</span>VitalSignMapper<span class="op">::</span>toDTO<span class="op">)</span></span>
<span id="cb152-34"><a href="#cb152-34" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">collect</span><span class="op">(</span>Collectors<span class="op">.</span><span class="fu">toList</span><span class="op">());</span></span>
<span id="cb152-35"><a href="#cb152-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb152-36"><a href="#cb152-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-37"><a href="#cb152-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb152-38"><a href="#cb152-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">@CacheEvict</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;user_vitals&quot;</span><span class="op">,</span> key <span class="op">=</span> <span class="st">&quot;#userId&quot;</span><span class="op">)</span></span>
<span id="cb152-39"><a href="#cb152-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> VitalSignDTO <span class="fu">recordVitalSign</span><span class="op">(</span><span class="bu">Long</span> userId<span class="op">,</span> VitalSignRequest request<span class="op">)</span> <span class="op">{</span></span>
<span id="cb152-40"><a href="#cb152-40" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;Recording vital sign for user: {}&quot;</span><span class="op">,</span> userId<span class="op">);</span></span>
<span id="cb152-41"><a href="#cb152-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-42"><a href="#cb152-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Validate input</span></span>
<span id="cb152-43"><a href="#cb152-43" aria-hidden="true" tabindex="-1"></a>        vitalSignValidator<span class="op">.</span><span class="fu">validate</span><span class="op">(</span>request<span class="op">);</span></span>
<span id="cb152-44"><a href="#cb152-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-45"><a href="#cb152-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Get user</span></span>
<span id="cb152-46"><a href="#cb152-46" aria-hidden="true" tabindex="-1"></a>        User user <span class="op">=</span> userRepository<span class="op">.</span><span class="fu">findById</span><span class="op">(</span>userId<span class="op">)</span></span>
<span id="cb152-47"><a href="#cb152-47" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">orElseThrow</span><span class="op">(()</span> <span class="op">-&gt;</span> <span class="kw">new</span> <span class="fu">UserNotFoundException</span><span class="op">(</span>userId<span class="op">));</span></span>
<span id="cb152-48"><a href="#cb152-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-49"><a href="#cb152-49" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Create and save vital sign</span></span>
<span id="cb152-50"><a href="#cb152-50" aria-hidden="true" tabindex="-1"></a>        VitalSign vitalSign <span class="op">=</span> VitalSignMapper<span class="op">.</span><span class="fu">fromRequest</span><span class="op">(</span>request<span class="op">,</span> user<span class="op">);</span></span>
<span id="cb152-51"><a href="#cb152-51" aria-hidden="true" tabindex="-1"></a>        vitalSign <span class="op">=</span> vitalSignRepository<span class="op">.</span><span class="fu">save</span><span class="op">(</span>vitalSign<span class="op">);</span></span>
<span id="cb152-52"><a href="#cb152-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-53"><a href="#cb152-53" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Process alerts</span></span>
<span id="cb152-54"><a href="#cb152-54" aria-hidden="true" tabindex="-1"></a>        <span class="fu">processVitalSignAlerts</span><span class="op">(</span>vitalSign<span class="op">);</span></span>
<span id="cb152-55"><a href="#cb152-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-56"><a href="#cb152-56" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;Successfully recorded vital sign: {}&quot;</span><span class="op">,</span> vitalSign<span class="op">.</span><span class="fu">getId</span><span class="op">());</span></span>
<span id="cb152-57"><a href="#cb152-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> VitalSignMapper<span class="op">.</span><span class="fu">toDTO</span><span class="op">(</span>vitalSign<span class="op">);</span></span>
<span id="cb152-58"><a href="#cb152-58" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb152-59"><a href="#cb152-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-60"><a href="#cb152-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">processVitalSignAlerts</span><span class="op">(</span>VitalSign vitalSign<span class="op">)</span> <span class="op">{</span></span>
<span id="cb152-61"><a href="#cb152-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>VitalSignAnalyzer<span class="op">.</span><span class="fu">isAbnormal</span><span class="op">(</span>vitalSign<span class="op">))</span> <span class="op">{</span></span>
<span id="cb152-62"><a href="#cb152-62" aria-hidden="true" tabindex="-1"></a>            notificationService<span class="op">.</span><span class="fu">sendHealthAlert</span><span class="op">(</span>vitalSign<span class="op">);</span></span>
<span id="cb152-63"><a href="#cb152-63" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb152-64"><a href="#cb152-64" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb152-65"><a href="#cb152-65" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="git-commit-standards">Git Commit Standards</h3>
<pre><code>feat: add vital signs tracking functionality
fix: resolve authentication token refresh issue
docs: update API documentation for health endpoints
style: format code according to style guide
refactor: extract common validation logic
test: add unit tests for health service
chore: update dependencies to latest versions

# Breaking changes
BREAKING CHANGE: change API response format for vital signs endpoint</code></pre>
<h2 id="contributing-guidelines">Contributing Guidelines</h2>
<h3 id="development-workflow-1">Development Workflow</h3>
<ol type="1">
<li><strong>Fork and Clone</strong>: Fork the repository and clone your
fork</li>
<li><strong>Branch</strong>: Create a feature branch from
<code>develop</code></li>
<li><strong>Develop</strong>: Make your changes following code
standards</li>
<li><strong>Test</strong>: Write and run tests for your changes</li>
<li><strong>Commit</strong>: Make atomic commits with clear
messages</li>
<li><strong>Push</strong>: Push your branch to your fork</li>
<li><strong>PR</strong>: Create a pull request to <code>develop</code>
branch</li>
</ol>
<h3 id="code-review-process">Code Review Process</h3>
<div class="sourceCode" id="cb154"><pre
class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="fu">## Pull Request Checklist</span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Code follows the established style guide</span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> All tests pass</span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> New functionality has adequate test coverage</span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Documentation is updated if needed</span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> No breaking changes without proper migration</span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Security implications are considered</span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Performance impact is acceptable</span></code></pre></div>
<h3 id="setting-up-development-environment">Setting Up Development
Environment</h3>
<div class="sourceCode" id="cb155"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Clone repository</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/your-org/careconnect2025.git</span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> careconnect2025</span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup frontend</span></span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> frontend</span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a><span class="ex">flutter</span> pub get</span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a><span class="ex">flutter</span> doctor</span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup backend</span></span>
<span id="cb155-11"><a href="#cb155-11" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ../backend/core</span>
<span id="cb155-12"><a href="#cb155-12" aria-hidden="true" tabindex="-1"></a><span class="ex">./mvnw</span> clean install</span>
<span id="cb155-13"><a href="#cb155-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-14"><a href="#cb155-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup database</span></span>
<span id="cb155-15"><a href="#cb155-15" aria-hidden="true" tabindex="-1"></a><span class="ex">psql</span> <span class="at">-U</span> postgres <span class="op">&lt;</span> scripts/init-db.sql</span>
<span id="cb155-16"><a href="#cb155-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-17"><a href="#cb155-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Run tests</span></span>
<span id="cb155-18"><a href="#cb155-18" aria-hidden="true" tabindex="-1"></a><span class="ex">flutter</span> test  <span class="co"># Frontend</span></span>
<span id="cb155-19"><a href="#cb155-19" aria-hidden="true" tabindex="-1"></a><span class="ex">./mvnw</span> test   <span class="co"># Backend</span></span></code></pre></div>
<h2 id="troubleshooting">Troubleshooting</h2>
<p>This section provides systematic approaches to resolving common
issues in the CareConnect platform. Each issue is structured as:
<strong>Problem</strong> → <strong>Root Causes</strong> →
<strong>Step-by-Step Resolution</strong>, allowing you to quickly
identify and fix issues while understanding why they occurred.</p>
<h3 id="common-development-issues">Common Development Issues</h3>
<h4 id="configuration-problems">Configuration Problems</h4>
<h5 id="problem-environment-variable-issues">Problem: Environment
Variable Issues</h5>
<p><strong>Symptoms</strong>: Application fails to start with errors
like “JWT secret not configured” or “API key missing”. Services that
depend on external APIs (AI, Stripe, AWS) fail to initialize.</p>
<p><strong>Root Causes</strong>: This typically occurs when environment
variables are not properly set in your development environment. The
application expects certain sensitive configuration values to be
provided externally (not hardcoded) for security reasons. Common
scenarios include: - Variables set in one terminal session but not
persisted - Variables set in IDE configuration but not in terminal
environment - Incorrect variable names (typos or case sensitivity
issues) - Variables not exported in shell startup files</p>
<p><strong>Systematic Resolution Steps</strong>:</p>
<ol type="1">
<li><strong>Verify Current Environment</strong>: First, check which
variables are actually set in your environment:</li>
</ol>
<div class="sourceCode" id="cb156"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check all required environment variables at once</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;JWT Secret: </span><span class="va">$SECURITY_JWT_SECRET</span><span class="st">&quot;</span></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;DeepSeek API Key: </span><span class="va">$DEEPSEEK_API_KEY</span><span class="st">&quot;</span></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Stripe Secret: </span><span class="va">$STRIPE_SECRET_KEY</span><span class="st">&quot;</span></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Database URL: </span><span class="va">$JDBC_URI</span><span class="st">&quot;</span></span></code></pre></div>
<p>Any variable showing blank means it’s not set in your current
environment.</p>
<ol start="2" type="1">
<li><strong>Set Variables for Current Session</strong>: For immediate
testing, export variables in your terminal:</li>
</ol>
<div class="sourceCode" id="cb157"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">SECURITY_JWT_SECRET</span><span class="op">=</span><span class="st">&quot;your-jwt-secret-key-at-least-32-chars&quot;</span></span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">DEEPSEEK_API_KEY</span><span class="op">=</span><span class="st">&quot;your-deepseek-api-key&quot;</span></span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">STRIPE_SECRET_KEY</span><span class="op">=</span><span class="st">&quot;your-stripe-secret-key&quot;</span></span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">JDBC_URI</span><span class="op">=</span><span class="st">&quot;jdbc:postgresql://localhost:5432/careconnect&quot;</span></span></code></pre></div>
<p>These will only last for the current terminal session.</p>
<ol start="3" type="1">
<li><strong>Persist Variables Permanently</strong>: Add these to your
shell configuration file for persistence:</li>
</ol>
<div class="sourceCode" id="cb158"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For bash users (~/.bashrc or ~/.bash_profile)</span></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&#39;export SECURITY_JWT_SECRET=&quot;your-secret&quot;&#39;</span> <span class="op">&gt;&gt;</span> ~/.bashrc</span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> ~/.bashrc</span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a><span class="co"># For zsh users (~/.zshrc)</span></span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&#39;export SECURITY_JWT_SECRET=&quot;your-secret&quot;&#39;</span> <span class="op">&gt;&gt;</span> ~/.zshrc</span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> ~/.zshrc</span></code></pre></div>
<ol start="4" type="1">
<li><strong>Configure IDE Environment</strong>: If running from an IDE,
configure the run configuration:</li>
</ol>
<ul>
<li><strong>IntelliJ IDEA</strong>: Run → Edit Configurations →
Environment Variables</li>
<li><strong>VS Code</strong>: Add to <code>.vscode/launch.json</code> or
use <code>.env</code> file with appropriate plugin</li>
</ul>
<ol start="5" type="1">
<li><strong>Verify Application Startup</strong>: After setting
variables, restart your application and check the logs for successful
initialization of services that depend on these variables.</li>
</ol>
<p><strong>Prevention</strong>: Create a <code>.env.example</code> file
in the repository documenting all required environment variables. New
developers can copy this to <code>.env</code> and fill in their
values.</p>
<h5 id="problem-profile-specific-configuration-issues">Problem:
Profile-Specific Configuration Issues</h5>
<p><strong>Symptoms</strong>: Application behavior differs between
environments. Database schema updates fail in production. Flyway
migrations conflict with JPA auto-generation.</p>
<p><strong>Root Causes</strong>: Spring Boot uses profiles to manage
environment-specific configuration. Issues arise when: - Development
profile uses <code>spring.jpa.hibernate.ddl-auto=update</code> which
auto-generates schema changes - Flyway is disabled in development but
enabled in production (or vice versa) - Configuration properties
conflict between profiles - Active profile is not what you expect (e.g.,
running with <code>default</code> when you meant <code>dev</code>)</p>
<p><strong>Systematic Resolution Steps</strong>:</p>
<ol type="1">
<li><strong>Identify Active Profile</strong>: Check which profile Spring
Boot is actually using:</li>
</ol>
<div class="sourceCode" id="cb159"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check application logs on startup for:</span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a><span class="co"># &quot;The following profiles are active: dev&quot;</span></span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Or explicitly check:</span></span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a><span class="ex">java</span> <span class="at">-jar</span> your-app.jar <span class="at">--spring.profiles.active</span><span class="op">=</span>dev</span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Or via environment variable:</span></span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">SPRING_PROFILES_ACTIVE</span><span class="op">=</span>dev</span></code></pre></div>
<ol start="2" type="1">
<li><strong>Understand Profile Hierarchy</strong>: Spring Boot loads
configuration in this order (later overrides earlier):
<ul>
<li><code>application.properties</code> (base configuration, always
loaded)</li>
<li><code>application-{profile}.properties</code> (profile-specific
overrides)</li>
<li>Environment variables (highest priority)</li>
</ul></li>
<li><strong>Review Development vs Production Settings</strong>: Common
configuration that should differ:</li>
</ol>
<pre class="properties"><code># application-dev.properties (Development)
spring.jpa.hibernate.ddl-auto=update      # Auto-generate schema changes
spring.flyway.enabled=false               # Disabled due to circular dependencies
spring.jpa.show-sql=true                  # Show SQL for debugging
logging.level.com.careconnect=DEBUG       # Verbose logging

# application-prod.properties (Production)
spring.jpa.hibernate.ddl-auto=validate    # Never auto-modify production schema
spring.flyway.enabled=true                # Use Flyway for controlled migrations
spring.jpa.show-sql=false                 # Don&#39;t log SQL in production
logging.level.com.careconnect=INFO        # Production logging level</code></pre>
<ol start="4" type="1">
<li><strong>Fix Flyway/JPA Conflicts</strong>: Currently, CareConnect
has Flyway disabled in development due to circular dependency issues. To
manually apply migrations:</li>
</ol>
<div class="sourceCode" id="cb161"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check current database schema</span></span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a><span class="ex">psql</span> <span class="at">-h</span> localhost <span class="at">-U</span> careconnect <span class="at">-d</span> careconnect <span class="at">-c</span> <span class="st">&quot;\dt&quot;</span></span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Manually apply specific migration</span></span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a><span class="ex">psql</span> <span class="at">-h</span> localhost <span class="at">-U</span> careconnect <span class="at">-d</span> careconnect <span class="at">-f</span> src/main/resources/db/migration/V22__create_ai_chat_tables.sql</span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-7"><a href="#cb161-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify migration was applied</span></span>
<span id="cb161-8"><a href="#cb161-8" aria-hidden="true" tabindex="-1"></a><span class="ex">psql</span> <span class="at">-h</span> localhost <span class="at">-U</span> careconnect <span class="at">-d</span> careconnect <span class="at">-c</span> <span class="st">&quot;SELECT * FROM flyway_schema_history ORDER BY installed_rank DESC LIMIT 5;&quot;</span></span></code></pre></div>
<ol start="5" type="1">
<li><strong>Validate Profile Loading</strong>: Add logging to confirm
correct profile is loaded:</li>
</ol>
<pre class="properties"><code># Add to application.properties
logging.level.org.springframework.core.env=DEBUG</code></pre>
<p>This will log which property files are being loaded and in what
order.</p>
<p><strong>Why This Happens</strong>: Flyway and JPA DDL auto-generation
both try to manage database schema, leading to conflicts. In
CareConnect, we’ve temporarily disabled Flyway in development to avoid
circular dependencies, but this is a technical debt that should be
resolved by fixing the circular dependencies and re-enabling Flyway.</p>
<h4 id="flutter-build-issues">Flutter Build Issues</h4>
<h5
id="problem-unexpected-build-failures-or-dependency-conflicts">Problem:
Unexpected Build Failures or Dependency Conflicts</h5>
<p><strong>Symptoms</strong>: <code>flutter build</code> or
<code>flutter run</code> fails with errors about missing packages,
version conflicts, or corrupted cache. Tests that previously passed now
fail inexplicably.</p>
<p><strong>Root Causes</strong>: Flutter’s build system aggressively
caches dependencies and build artifacts for performance. While this
usually helps, it can cause issues when: - Package versions change in
<code>pubspec.yaml</code> but cached versions persist - Build artifacts
become corrupted (often after git operations or Flutter SDK updates) -
Multiple Flutter projects on your system create conflicting cached state
- Flutter SDK is updated but local caches aren’t refreshed</p>
<p><strong>Systematic Resolution Steps</strong>:</p>
<ol type="1">
<li><p><strong>Level 1: Refresh Dependency Cache</strong> (Solves ~80%
of issues)</p>
<div class="sourceCode" id="cb163"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Delete the build folder (contains compiled artifacts)</span></span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a><span class="ex">flutter</span> clean</span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Repair the Pub cache (where packages are stored)</span></span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a><span class="ex">flutter</span> pub cache repair</span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-7"><a href="#cb163-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Re-fetch all dependencies for this project</span></span>
<span id="cb163-8"><a href="#cb163-8" aria-hidden="true" tabindex="-1"></a><span class="ex">flutter</span> pub get</span></code></pre></div>
<p><strong>What this does</strong>: <code>flutter clean</code> removes
all compiled artifacts, forcing a fresh build.
<code>pub cache repair</code> checks the integrity of all cached
packages and re-downloads any that are corrupted. <code>pub get</code>
updates the project’s dependency resolution.</p></li>
<li><p><strong>Level 2: Upgrade SDK and Dependencies</strong> (If Level
1 doesn’t resolve)</p>
<div class="sourceCode" id="cb164"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure you&#39;re on the stable channel (not dev or beta)</span></span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a><span class="ex">flutter</span> channel stable</span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Upgrade the Flutter SDK itself to the latest stable version</span></span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a><span class="ex">flutter</span> upgrade</span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Check which dependencies are outdated</span></span>
<span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a><span class="ex">flutter</span> pub outdated</span>
<span id="cb164-9"><a href="#cb164-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-10"><a href="#cb164-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Upgrade dependencies to latest compatible versions</span></span>
<span id="cb164-11"><a href="#cb164-11" aria-hidden="true" tabindex="-1"></a><span class="ex">flutter</span> pub upgrade</span></code></pre></div>
<p><strong>Important</strong>: After <code>flutter upgrade</code>, run
<code>flutter doctor -v</code> to ensure all components (Android
toolchain, iOS toolchain, etc.) are properly configured.</p></li>
<li><p><strong>Level 3: Resolve Dependency Conflicts</strong> (For
persistent version conflicts)</p>
<div class="sourceCode" id="cb165"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the dependency tree to find conflicts</span></span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a><span class="ex">flutter</span> pub deps <span class="at">--style</span><span class="op">=</span>tree</span></code></pre></div>
<p>Look for the same package appearing multiple times with different
versions. Example output:</p>
<pre><code>├── http 0.13.5
└── some_package 1.0.0
    └── http 0.13.4  ← Conflict! Two versions of http</code></pre>
<p><strong>Resolution</strong>: Use <code>dependency_overrides</code> in
<code>pubspec.yaml</code> (use sparingly, only as last resort):</p>
<div class="sourceCode" id="cb167"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dependency_overrides</span><span class="kw">:</span></span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">http</span><span class="kw">:</span><span class="at"> ^0.13.5</span><span class="co">  # Force all packages to use this version</span></span></code></pre></div></li>
<li><p><strong>Level 4: IDE Synchronization</strong> (If builds work in
terminal but not IDE)</p>
<p><strong>VS Code</strong>:</p>
<pre><code>- Open Command Palette (Cmd/Ctrl+Shift+P)
- Run: &quot;Dart: Restart Analysis Server&quot;
- If issue persists: Reload window (Cmd/Ctrl+R)</code></pre>
<p><strong>Android Studio</strong>:</p>
<pre><code>- File &gt; Invalidate Caches / Restart...
- Select &quot;Invalidate and Restart&quot;</code></pre>
<p><strong>What this does</strong>: IDEs maintain their own analysis of
your Dart code. Sometimes this gets out of sync with actual files,
causing phantom errors.</p></li>
<li><p><strong>Level 5: Verify Exact Package Versions</strong> (For
reproducible team builds)</p>
<p>Check the project’s <code>pubspec.yaml</code> and ensure you’re using
the exact versions specified:</p>
<div class="sourceCode" id="cb170"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dependencies</span><span class="kw">:</span></span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">flutter</span><span class="kw">:</span></span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">sdk</span><span class="kw">:</span><span class="at"> flutter</span></span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">provider</span><span class="kw">:</span><span class="at"> ^6.0.5</span><span class="co">      # Ensure your version matches team&#39;s version</span></span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">dio</span><span class="kw">:</span><span class="at"> ^5.3.2</span></span>
<span id="cb170-6"><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">go_router</span><span class="kw">:</span><span class="at"> ^10.1.0</span></span></code></pre></div>
<p>The <code>pubspec.lock</code> file (committed to git) records exact
versions. If your <code>pubspec.lock</code> differs from the team’s, you
might get different behavior.</p></li>
</ol>
<p><strong>Prevention</strong>: - Commit <code>pubspec.lock</code> to
version control so all team members use identical package versions -
Document the Flutter version the project uses in README: “This project
requires Flutter 3.9.2 or later” - Run <code>flutter doctor</code>
regularly to catch environment issues early - When changing
dependencies, run tests before committing to catch incompatibilities</p>
<p><strong>When to Escalate</strong>: If none of these steps resolve the
issue, the problem may be: - A genuine bug in a package (check package’s
GitHub issues) - Incompatibility with your specific OS/environment
(check Flutter GitHub issues) - Project-specific configuration issue
(consult the team lead)</p>
<h4 id="backend-compilation-issues">Backend Compilation Issues</h4>
<h5 id="problem-maven-dependencies-not-resolving">Problem: Maven
Dependencies Not Resolving</h5>
<p><strong>Symptoms</strong>: Maven build fails with “Could not resolve
dependencies” errors. Compile phase fails with “package does not exist”
errors even though dependencies are declared in <code>pom.xml</code>.
Spring Boot application fails to start due to missing beans.</p>
<p><strong>Root Causes</strong>: Maven maintains a local repository
cache (<code>~/.m2/repository</code>) where it stores downloaded
dependencies. Issues occur when: - The local repository becomes
corrupted (incomplete downloads, disk errors) - A SNAPSHOT dependency
was cached but the remote version has updated - Maven’s metadata files
become inconsistent - Network issues interrupted dependency downloads -
Corporate proxies or firewalls block Maven Central or Spring
repositories</p>
<p><strong>Systematic Resolution Steps</strong>:</p>
<ol type="1">
<li><p><strong>Clean Build Artifacts</strong>: Start by removing
compiled code to force a fresh build:</p>
<div class="sourceCode" id="cb171"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean all compiled artifacts and target directory</span></span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a><span class="ex">./mvnw</span> clean</span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify target directory is gone</span></span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> target  <span class="co"># Should show &quot;No such file or directory&quot;</span></span></code></pre></div></li>
<li><p><strong>Purge Local Maven Repository</strong> (Nuclear option,
but often necessary):</p>
<div class="sourceCode" id="cb172"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove entire local Maven cache</span></span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">WARNING</span><span class="co">: This deletes ALL cached dependencies, not just for this project</span></span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> <span class="at">-rf</span> ~/.m2/repository</span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-5"><a href="#cb172-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Re-download all dependencies</span></span>
<span id="cb172-6"><a href="#cb172-6" aria-hidden="true" tabindex="-1"></a><span class="ex">./mvnw</span> dependency:resolve</span>
<span id="cb172-7"><a href="#cb172-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-8"><a href="#cb172-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Attempt compilation</span></span>
<span id="cb172-9"><a href="#cb172-9" aria-hidden="true" tabindex="-1"></a><span class="ex">./mvnw</span> clean compile</span></code></pre></div>
<p><strong>What this does</strong>: Completely removes Maven’s local
cache and forces it to re-download every dependency. This fixes
corruption but requires a full re-download (can take several minutes on
slow connections).</p></li>
<li><p><strong>Verify Java Version</strong> (Spring Boot 3.4.5 has
specific requirements):</p>
<div class="sourceCode" id="cb173"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check current Java version</span></span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a><span class="ex">java</span> <span class="at">-version</span></span>
<span id="cb173-3"><a href="#cb173-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-4"><a href="#cb173-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Must show Java 17 or higher for Spring Boot 3.4.5</span></span>
<span id="cb173-5"><a href="#cb173-5" aria-hidden="true" tabindex="-1"></a><span class="co"># If not:</span></span>
<span id="cb173-6"><a href="#cb173-6" aria-hidden="true" tabindex="-1"></a><span class="co"># - macOS: brew install openjdk@17 &amp;&amp; sudo ln -sfn $(brew --prefix openjdk@17)/libexec/openjdk.jdk /Library/Java/JavaVirtualMachines/openjdk-17.jdk</span></span>
<span id="cb173-7"><a href="#cb173-7" aria-hidden="true" tabindex="-1"></a><span class="co"># - Linux: sudo apt install openjdk-17-jdk</span></span>
<span id="cb173-8"><a href="#cb173-8" aria-hidden="true" tabindex="-1"></a><span class="co"># - Windows: Download from https://adoptium.net/</span></span>
<span id="cb173-9"><a href="#cb173-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-10"><a href="#cb173-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify JAVA_HOME points to Java 17</span></span>
<span id="cb173-11"><a href="#cb173-11" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="va">$JAVA_HOME</span></span>
<span id="cb173-12"><a href="#cb173-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-13"><a href="#cb173-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Set JAVA_HOME if needed</span></span>
<span id="cb173-14"><a href="#cb173-14" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">JAVA_HOME</span><span class="op">=</span>/path/to/java17</span></code></pre></div>
<p><strong>Why this matters</strong>: Spring Boot 3.x requires Java 17
as a minimum. Using Java 11 or older will cause cryptic compilation
errors because certain language features and APIs don’t exist in older
versions.</p></li>
<li><p><strong>Diagnose Circular Dependencies</strong>:</p>
<div class="sourceCode" id="cb174"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compile and watch for circular dependency errors</span></span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a><span class="ex">./mvnw</span> compile <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span> <span class="kw">|</span> <span class="fu">grep</span> <span class="at">-i</span> circular</span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a><span class="co"># If circular dependencies found, analyze with:</span></span>
<span id="cb174-5"><a href="#cb174-5" aria-hidden="true" tabindex="-1"></a><span class="ex">./mvnw</span> dependency:tree <span class="at">-Dverbose</span><span class="op">=</span>true</span></code></pre></div>
<p><strong>Understanding Circular Dependencies</strong>: A circular
dependency occurs when Bean A depends on Bean B, which depends on Bean
C, which depends on Bean A. Spring can sometimes resolve these with lazy
initialization, but it’s better to refactor the code to break the
circle.</p>
<p><strong>Common CareConnect Circular Dependency</strong>: The
Flyway/Spring AI circular dependency currently requires Flyway to be
disabled in development. This should be resolved by:</p>
<ul>
<li>Moving database initialization to a separate configuration</li>
<li>Using <code>@Lazy</code> annotation on one side of the
dependency</li>
<li>Refactoring to introduce an interface that breaks the circle</li>
</ul></li>
<li><p><strong>Check Spring AI Milestone Versions</strong>
(CareConnect-specific issue):</p>
<div class="sourceCode" id="cb175"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Spring AI is in milestone releases, which requires special repository configuration</span></span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify dependency tree for Spring AI conflicts</span></span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a><span class="ex">./mvnw</span> dependency:tree <span class="kw">|</span> <span class="fu">grep</span> spring-ai</span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-5"><a href="#cb175-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Should show consistent versions across all spring-ai-* artifacts</span></span></code></pre></div>
<p>Ensure your <code>pom.xml</code> includes the Spring milestones
repository:</p>
<div class="sourceCode" id="cb176"><pre
class="sourceCode xml"><code class="sourceCode xml"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">repositories</span>&gt;</span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">repository</span>&gt;</span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">id</span>&gt;spring-milestones&lt;/<span class="kw">id</span>&gt;</span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">name</span>&gt;Spring Milestones&lt;/<span class="kw">name</span>&gt;</span>
<span id="cb176-5"><a href="#cb176-5" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">url</span>&gt;https://repo.spring.io/milestone&lt;/<span class="kw">url</span>&gt;</span>
<span id="cb176-6"><a href="#cb176-6" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">snapshots</span>&gt;</span>
<span id="cb176-7"><a href="#cb176-7" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">enabled</span>&gt;false&lt;/<span class="kw">enabled</span>&gt;</span>
<span id="cb176-8"><a href="#cb176-8" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">snapshots</span>&gt;</span>
<span id="cb176-9"><a href="#cb176-9" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">repository</span>&gt;</span>
<span id="cb176-10"><a href="#cb176-10" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">repositories</span>&gt;</span></code></pre></div></li>
<li><p><strong>Force Maven to Update All Dependencies</strong>:</p>
<div class="sourceCode" id="cb177"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Force update of all SNAPSHOT and release dependencies</span></span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a><span class="ex">./mvnw</span> clean install <span class="at">-U</span></span>
<span id="cb177-3"><a href="#cb177-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-4"><a href="#cb177-4" aria-hidden="true" tabindex="-1"></a><span class="co"># The -U flag forces Maven to check for updated versions</span></span></code></pre></div></li>
</ol>
<p><strong>Prevention</strong>: - Commit
<code>maven-wrapper.properties</code> to ensure all developers use the
same Maven version - Document required Java version in README - Use
Maven Enforcer Plugin to fail builds with wrong Java version:
<code>xml   &lt;plugin&gt;       &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;       &lt;artifactId&gt;maven-enforcer-plugin&lt;/artifactId&gt;       &lt;executions&gt;           &lt;execution&gt;               &lt;goals&gt;                   &lt;goal&gt;enforce&lt;/goal&gt;               &lt;/goals&gt;               &lt;configuration&gt;                   &lt;rules&gt;                       &lt;requireJavaVersion&gt;                           &lt;version&gt;[17,)&lt;/version&gt;                       &lt;/requireJavaVersion&gt;                   &lt;/rules&gt;               &lt;/configuration&gt;           &lt;/execution&gt;       &lt;/executions&gt;   &lt;/plugin&gt;</code></p>
<p><strong>When to Escalate</strong>: If these steps don’t resolve the
issue: - Check if your network has proxy requirements
(<code>~/.m2/settings.xml</code> proxy configuration) - Verify you can
reach Maven Central:
<code>curl https://repo.maven.apache.org/maven2/</code> - Check if a
specific dependency is actually available at the version specified -
Consult the team’s build server logs to see if it’s a local-only
issue</p>
<h4 id="database-connection-issues">Database Connection Issues</h4>
<h5 id="problem-postgresql-connection-failures">Problem: PostgreSQL
Connection Failures</h5>
<p><strong>Symptoms</strong>: Application startup fails with “Connection
refused” or “Connection timeout” errors. Intermittent “Too many
connections” errors during load. Operations hang without returning
results.</p>
<p><strong>Root Causes</strong>: Database connection issues in
CareConnect typically stem from: - PostgreSQL server not running or not
accessible - Connection pool exhausted (HikariCP runs out of
connections) - Network connectivity issues (firewall, DNS resolution) -
Incorrect connection string or credentials - PostgreSQL configured to
accept too few connections - Long-running transactions holding
connections without releasing them</p>
<p><strong>Systematic Resolution Steps</strong>:</p>
<ol type="1">
<li><p><strong>Verify PostgreSQL Server Status</strong>:</p>
<div class="sourceCode" id="cb178"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if PostgreSQL is running</span></span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a><span class="ex">pg_isready</span> <span class="at">-h</span> localhost <span class="at">-p</span> 5432</span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Expected: &quot;localhost:5432 - accepting connections&quot;</span></span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-5"><a href="#cb178-5" aria-hidden="true" tabindex="-1"></a><span class="co"># If using Docker:</span></span>
<span id="cb178-6"><a href="#cb178-6" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> ps <span class="kw">|</span> <span class="fu">grep</span> postgres</span>
<span id="cb178-7"><a href="#cb178-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Should show a running postgres container</span></span>
<span id="cb178-8"><a href="#cb178-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-9"><a href="#cb178-9" aria-hidden="true" tabindex="-1"></a><span class="co"># If not running, start it:</span></span>
<span id="cb178-10"><a href="#cb178-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Docker: docker-compose up -d postgres</span></span>
<span id="cb178-11"><a href="#cb178-11" aria-hidden="true" tabindex="-1"></a><span class="co"># macOS: brew services start postgresql</span></span>
<span id="cb178-12"><a href="#cb178-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Linux: sudo systemctl start postgresql</span></span></code></pre></div></li>
<li><p><strong>Test Direct Connection</strong> (bypasses application,
tests database itself):</p>
<div class="sourceCode" id="cb179"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Connect with psql client</span></span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a><span class="ex">psql</span> <span class="at">-h</span> localhost <span class="at">-p</span> 5432 <span class="at">-U</span> careconnect <span class="at">-d</span> careconnect</span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a><span class="co"># If successful, you&#39;ll see: careconnect=#</span></span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-6"><a href="#cb179-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Check PostgreSQL version and basic health</span></span>
<span id="cb179-7"><a href="#cb179-7" aria-hidden="true" tabindex="-1"></a><span class="ex">SELECT</span> version<span class="er">(</span><span class="kw">);</span></span>
<span id="cb179-8"><a href="#cb179-8" aria-hidden="true" tabindex="-1"></a><span class="ex">SELECT</span> now<span class="er">(</span><span class="kw">);</span>  <span class="co"># Should return current timestamp</span></span></code></pre></div>
<p><strong>If this fails</strong>: The problem is with PostgreSQL
itself, not the application. Check:</p>
<ul>
<li>Credentials in your environment match PostgreSQL’s configured
users</li>
<li><code>pg_hba.conf</code> allows connections from localhost</li>
<li>PostgreSQL is listening on the right port (check
<code>postgresql.conf</code>)</li>
</ul></li>
<li><p><strong>Diagnose Connection Pool Issues</strong>:</p>
<div class="sourceCode" id="cb180"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Inside psql, check current connection usage</span></span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">count</span>(<span class="op">*</span>) <span class="kw">as</span> total_connections,</span>
<span id="cb180-4"><a href="#cb180-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">count</span>(<span class="op">*</span>) <span class="kw">FILTER</span> (<span class="kw">WHERE</span> state <span class="op">=</span> <span class="st">&#39;active&#39;</span>) <span class="kw">as</span> active,</span>
<span id="cb180-5"><a href="#cb180-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">count</span>(<span class="op">*</span>) <span class="kw">FILTER</span> (<span class="kw">WHERE</span> state <span class="op">=</span> <span class="st">&#39;idle&#39;</span>) <span class="kw">as</span> idle,</span>
<span id="cb180-6"><a href="#cb180-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">count</span>(<span class="op">*</span>) <span class="kw">FILTER</span> (<span class="kw">WHERE</span> state <span class="op">=</span> <span class="st">&#39;idle in transaction&#39;</span>) <span class="kw">as</span> idle_in_transaction</span>
<span id="cb180-7"><a href="#cb180-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> pg_stat_activity </span>
<span id="cb180-8"><a href="#cb180-8" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> datname <span class="op">=</span> <span class="st">&#39;careconnect&#39;</span>;</span>
<span id="cb180-9"><a href="#cb180-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-10"><a href="#cb180-10" aria-hidden="true" tabindex="-1"></a><span class="co">-- Check max_connections setting</span></span>
<span id="cb180-11"><a href="#cb180-11" aria-hidden="true" tabindex="-1"></a>SHOW max_connections;</span>
<span id="cb180-12"><a href="#cb180-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-13"><a href="#cb180-13" aria-hidden="true" tabindex="-1"></a><span class="co">-- If close to max, you have a connection leak</span></span></code></pre></div>
<p><strong>Understanding the Results</strong>:</p>
<ul>
<li><strong>Active</strong>: Currently executing queries (normal)</li>
<li><strong>Idle</strong>: Connected but not doing anything (normal for
connection pool)</li>
<li><strong>Idle in transaction</strong>: Connected, started a
transaction, but not committing/rolling back (BAD - indicates a
bug)</li>
</ul>
<p>If “idle in transaction” is high, you have a connection leak.
Transactions are starting but not finishing, holding connections
hostage.</p></li>
<li><p><strong>Tune HikariCP Connection Pool</strong> (if pool
exhaustion detected):</p>
<p>CareConnect uses HikariCP as its connection pool. Tuning it properly
is crucial for stability:</p>
<pre class="properties"><code># In application.properties or application-dev.properties

# Maximum number of connections in the pool
# Rule of thumb: (2 * number_of_cores) + number_of_disks
# For a 4-core machine with SSD: (2*4)+1 = 9, round up to 10
spring.datasource.hikari.maximum-pool-size=10

# Minimum number of idle connections maintained
# Keep this lower to avoid wasting resources
spring.datasource.hikari.minimum-idle=5

# Maximum time to wait for a connection from pool (milliseconds)
# 20 seconds is reasonable; if you hit this, you have a connection leak
spring.datasource.hikari.connection-timeout=20000

# Maximum time a connection can sit idle before being closed
# 5 minutes prevents stale connections
spring.datasource.hikari.idle-timeout=300000

# Maximum lifetime of a connection (milliseconds)
# 30 minutes forces periodic recycling, preventing stale connections
spring.datasource.hikari.max-lifetime=1800000

# Enable leak detection (development only, has performance cost)
spring.datasource.hikari.leak-detection-threshold=60000</code></pre>
<p><strong>What each setting does</strong>:</p>
<ul>
<li><code>maximum-pool-size</code>: Too low = connections exhausted
under load; too high = wastes resources and can overwhelm
PostgreSQL</li>
<li><code>connection-timeout</code>: How long to wait for a connection
before giving up. If you hit this regularly, increase pool size or fix
connection leaks</li>
<li><code>leak-detection-threshold</code>: If enabled, HikariCP will log
a warning if a connection is held longer than this threshold, helping
identify leaks</li>
</ul></li>
<li><p><strong>Identify and Kill Problematic Connections</strong>
(emergency measure):</p>
<div class="sourceCode" id="cb182"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Find long-running or blocked queries</span></span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a>    pid,</span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a>    usename,</span>
<span id="cb182-5"><a href="#cb182-5" aria-hidden="true" tabindex="-1"></a>    application_name,</span>
<span id="cb182-6"><a href="#cb182-6" aria-hidden="true" tabindex="-1"></a>    state,</span>
<span id="cb182-7"><a href="#cb182-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">query</span>,</span>
<span id="cb182-8"><a href="#cb182-8" aria-hidden="true" tabindex="-1"></a>    now() <span class="op">-</span> state_change <span class="kw">as</span> duration</span>
<span id="cb182-9"><a href="#cb182-9" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> pg_stat_activity</span>
<span id="cb182-10"><a href="#cb182-10" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> state <span class="op">!=</span> <span class="st">&#39;idle&#39;</span></span>
<span id="cb182-11"><a href="#cb182-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> now() <span class="op">-</span> state_change <span class="op">&gt;</span> <span class="dt">interval</span> <span class="st">&#39;5 minutes&#39;</span></span>
<span id="cb182-12"><a href="#cb182-12" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> duration <span class="kw">DESC</span>;</span>
<span id="cb182-13"><a href="#cb182-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-14"><a href="#cb182-14" aria-hidden="true" tabindex="-1"></a><span class="co">-- If you find a stuck query, you can terminate it:</span></span>
<span id="cb182-15"><a href="#cb182-15" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> pg_terminate_backend(<span class="dv">12345</span>);  <span class="co">-- Replace 12345 with actual pid</span></span>
<span id="cb182-16"><a href="#cb182-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-17"><a href="#cb182-17" aria-hidden="true" tabindex="-1"></a><span class="co">-- To terminate all idle in transaction connections (use carefully!):</span></span>
<span id="cb182-18"><a href="#cb182-18" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> pg_terminate_backend(pid) </span>
<span id="cb182-19"><a href="#cb182-19" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> pg_stat_activity </span>
<span id="cb182-20"><a href="#cb182-20" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> state <span class="op">=</span> <span class="st">&#39;idle in transaction&#39;</span> </span>
<span id="cb182-21"><a href="#cb182-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> now() <span class="op">-</span> state_change <span class="op">&gt;</span> <span class="dt">interval</span> <span class="st">&#39;10 minutes&#39;</span>;</span></code></pre></div>
<p><strong>Warning</strong>: Terminating connections forcefully will
roll back any in-progress transactions. Only do this when connections
are truly stuck, not just slow.</p></li>
<li><p><strong>Increase PostgreSQL’s max_connections</strong> (if
legitimately need more connections):</p>
<div class="sourceCode" id="cb183"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Check current setting</span></span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a>SHOW max_connections;  <span class="co">-- Default is often 100</span></span>
<span id="cb183-3"><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-4"><a href="#cb183-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- To increase (requires PostgreSQL restart):</span></span>
<span id="cb183-5"><a href="#cb183-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- Edit postgresql.conf:</span></span>
<span id="cb183-6"><a href="#cb183-6" aria-hidden="true" tabindex="-1"></a>max_connections <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb183-7"><a href="#cb183-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-8"><a href="#cb183-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- Then restart PostgreSQL:</span></span>
<span id="cb183-9"><a href="#cb183-9" aria-hidden="true" tabindex="-1"></a><span class="co">-- Docker: docker-compose restart postgres</span></span>
<span id="cb183-10"><a href="#cb183-10" aria-hidden="true" tabindex="-1"></a><span class="co">-- macOS: brew services restart postgresql</span></span>
<span id="cb183-11"><a href="#cb183-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- Linux: sudo systemctl restart postgresql</span></span></code></pre></div>
<p><strong>Caveat</strong>: Each connection consumes memory. Blindly
increasing max_connections can cause PostgreSQL to run out of memory.
Better to fix connection leaks or use connection pooling (which
CareConnect already does with HikariCP).</p></li>
<li><p><strong>Enable Connection Pool Logging</strong> (to debug pool
behavior):</p>
<pre class="properties"><code># Add to application.properties
logging.level.com.zaxxer.hikari=DEBUG
logging.level.com.zaxxer.hikari.HikariConfig=DEBUG</code></pre>
<p>This will log every connection acquisition and release, helping you
spot:</p>
<ul>
<li>Connections not being returned to pool</li>
<li>Pool exhaustion events</li>
<li>Configuration issues</li>
</ul></li>
</ol>
<p><strong>Prevention</strong>: - Always use <code>@Transactional</code>
on service methods to ensure transactions complete - Avoid manual
transaction management unless absolutely necessary - Use
try-with-resources when manually managing connections (rare in Spring
Boot) - Monitor connection pool metrics in production (HikariCP exposes
JMX metrics) - Set up alerts when idle in transaction connections exceed
a threshold</p>
<p><strong>Common Anti-Patterns to Avoid</strong>:</p>
<div class="sourceCode" id="cb185"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="co">// BAD: Opening connection manually (should use JPA/repositories)</span></span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a><span class="bu">Connection</span> conn <span class="op">=</span> <span class="bu">DriverManager</span><span class="op">.</span><span class="fu">getConnection</span><span class="op">(</span>url<span class="op">);</span></span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a><span class="co">// ... use connection ...</span></span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Forgot to close! Connection leak!</span></span>
<span id="cb185-5"><a href="#cb185-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-6"><a href="#cb185-6" aria-hidden="true" tabindex="-1"></a><span class="co">// GOOD: Let Spring manage connections</span></span>
<span id="cb185-7"><a href="#cb185-7" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb185-8"><a href="#cb185-8" aria-hidden="true" tabindex="-1"></a><span class="at">@Transactional</span></span>
<span id="cb185-9"><a href="#cb185-9" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> MyService <span class="op">{</span></span>
<span id="cb185-10"><a href="#cb185-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb185-11"><a href="#cb185-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> MyRepository repo<span class="op">;</span></span>
<span id="cb185-12"><a href="#cb185-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb185-13"><a href="#cb185-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">doWork</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb185-14"><a href="#cb185-14" aria-hidden="true" tabindex="-1"></a>        repo<span class="op">.</span><span class="fu">save</span><span class="op">(</span>entity<span class="op">);</span></span>
<span id="cb185-15"><a href="#cb185-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Connection automatically returned to pool when method completes</span></span>
<span id="cb185-16"><a href="#cb185-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb185-17"><a href="#cb185-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="authentication-security-issues">Authentication &amp; Security
Issues</h3>
<h4 id="jwt-token-problems">JWT Token Problems</h4>
<p><strong>Invalid Token Handling</strong></p>
<div class="sourceCode" id="cb186"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Common JWT issues in JwtAuthenticationFilter</span></span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>token <span class="op">!=</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> jwt<span class="op">.</span><span class="fu">validateToken</span><span class="op">(</span>token<span class="op">))</span> <span class="op">{</span></span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Token is valid</span></span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb186-5"><a href="#cb186-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>token <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb186-6"><a href="#cb186-6" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">warn</span><span class="op">(</span><span class="st">&quot;Invalid token provided&quot;</span><span class="op">);</span>  <span class="co">// Check token expiration</span></span>
<span id="cb186-7"><a href="#cb186-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb186-8"><a href="#cb186-8" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">debug</span><span class="op">(</span><span class="st">&quot;No token found in request&quot;</span><span class="op">);</span>  <span class="co">// Missing Authorization header</span></span>
<span id="cb186-9"><a href="#cb186-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb186-10"><a href="#cb186-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Token Debugging</strong></p>
<div class="sourceCode" id="cb187"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Decode JWT token (for debugging only)</span></span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;your-jwt-token&quot;</span> <span class="kw">|</span> <span class="fu">cut</span> <span class="at">-d.</span> <span class="at">-f2</span> <span class="kw">|</span> <span class="fu">base64</span> <span class="at">--decode</span> <span class="kw">|</span> <span class="ex">jq</span> .</span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-4"><a href="#cb187-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check token expiration</span></span>
<span id="cb187-5"><a href="#cb187-5" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-H</span> <span class="st">&quot;Authorization: Bearer your-token&quot;</span> http://localhost:8080/v1/api/auth/validate</span></code></pre></div>
<h4 id="password-reset-issues">Password Reset Issues</h4>
<p><strong>Reset Token Problems</strong></p>
<div class="sourceCode" id="cb188"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="co">// From UserPasswordService - token validation</span></span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a><span class="dt">boolean</span> <span class="fu">validateToken</span><span class="op">(</span><span class="bu">String</span> token<span class="op">,</span> <span class="bu">String</span> email<span class="op">)</span> <span class="op">{</span></span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check both raw token and Base64 encoded versions</span></span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Common issue: Base64 encoding mismatches</span></span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="oauth-integration-issues">OAuth Integration Issues</h4>
<p><strong>Google OAuth Configuration</strong></p>
<pre class="properties"><code># Development uses mock credentials - update for production
spring.security.oauth2.client.registration.google.client-id=your-real-client-id
spring.security.oauth2.client.registration.google.client-secret=your-real-client-secret</code></pre>
<h3 id="websocket-connection-issues">WebSocket Connection Issues</h3>
<h4 id="connection-management-problems">Connection Management
Problems</h4>
<p><strong>Authentication Failures</strong></p>
<div class="sourceCode" id="cb190"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Common WebSocket authentication issues</span></span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">void</span> <span class="fu">handleAuthentication</span><span class="op">(</span>WebSocketSession session<span class="op">,</span> <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> payload<span class="op">)</span> <span class="op">{</span></span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> token <span class="op">=</span> <span class="op">(</span><span class="bu">String</span><span class="op">)</span> payload<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;token&quot;</span><span class="op">);</span></span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>jwtTokenProvider<span class="op">.</span><span class="fu">validateToken</span><span class="op">(</span>token<span class="op">))</span> <span class="op">{</span></span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Store authenticated user info</span></span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a>        session<span class="op">.</span><span class="fu">getAttributes</span><span class="op">().</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;authenticated&quot;</span><span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb190-7"><a href="#cb190-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb190-8"><a href="#cb190-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Authentication failed - connection will be closed</span></span>
<span id="cb190-9"><a href="#cb190-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sendMessage</span><span class="op">(</span>session<span class="op">,</span> <span class="bu">Map</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span><span class="st">&quot;type&quot;</span><span class="op">,</span> <span class="st">&quot;authentication-error&quot;</span><span class="op">,</span> <span class="st">&quot;message&quot;</span><span class="op">,</span> <span class="st">&quot;Invalid token&quot;</span><span class="op">));</span></span>
<span id="cb190-10"><a href="#cb190-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb190-11"><a href="#cb190-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Connection Cleanup Issues</strong></p>
<div class="sourceCode" id="cb191"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="co">// WebSocket transport errors may not properly clean up sessions</span></span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Scheduled</span><span class="op">(</span>fixedRate <span class="op">=</span> <span class="dv">300000</span><span class="op">)</span> <span class="co">// Every 5 minutes</span></span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">cleanupExpiredConnections</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>WebSocketConnection<span class="op">&gt;</span> expired <span class="op">=</span> repository<span class="op">.</span><span class="fu">findExpiredConnections</span><span class="op">(</span>LocalDateTime<span class="op">.</span><span class="fu">now</span><span class="op">());</span></span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a>    expired<span class="op">.</span><span class="fu">forEach</span><span class="op">(</span>conn <span class="op">-&gt;</span> conn<span class="op">.</span><span class="fu">setIsActive</span><span class="op">(</span><span class="kw">false</span><span class="op">));</span></span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Client-Side Connection Issues</strong></p>
<div class="sourceCode" id="cb192"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Flutter WebSocket reconnection logic</span></span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a><span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> _handleDisconnection() <span class="at">async</span> {</span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Implement exponential backoff</span></span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> retryCount <span class="op">=</span> <span class="dv">0</span>;</span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> (retryCount <span class="op">&lt;</span> <span class="dv">5</span>) {</span>
<span id="cb192-6"><a href="#cb192-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">await</span> <span class="dt">Future</span><span class="op">.</span>delayed(Duration(seconds<span class="op">:</span> math<span class="op">.</span>pow(<span class="dv">2</span><span class="op">,</span> retryCount)<span class="op">.</span>toInt()));</span>
<span id="cb192-7"><a href="#cb192-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb192-8"><a href="#cb192-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">await</span> connect();</span>
<span id="cb192-9"><a href="#cb192-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span>;</span>
<span id="cb192-10"><a href="#cb192-10" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (e) {</span>
<span id="cb192-11"><a href="#cb192-11" aria-hidden="true" tabindex="-1"></a>      retryCount<span class="op">++</span>;</span>
<span id="cb192-12"><a href="#cb192-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb192-13"><a href="#cb192-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb192-14"><a href="#cb192-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="ai-service-integration-issues">AI Service Integration
Issues</h3>
<h4 id="deepseek-api-problems">DeepSeek API Problems</h4>
<p><strong>API Key Configuration</strong></p>
<div class="sourceCode" id="cb193"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="co">// DeepSeekService initialization</span></span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>apiKey <span class="op">==</span> <span class="kw">null</span> <span class="op">||</span> apiKey<span class="op">.</span><span class="fu">trim</span><span class="op">().</span><span class="fu">isEmpty</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">IllegalStateException</span><span class="op">(</span><span class="st">&quot;DeepSeek API key is not configured&quot;</span><span class="op">);</span></span>
<span id="cb193-4"><a href="#cb193-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Network Timeout Issues</strong></p>
<pre class="properties"><code># Increase timeout for AI API calls
careconnect.ai.timeout.connection=30000
careconnect.ai.timeout.read=60000</code></pre>
<p><strong>JSON Parsing Failures</strong></p>
<div class="sourceCode" id="cb195"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="co">// AI response parsing errors</span></span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span> <span class="op">{</span></span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a>    TaskDtoV2 aiTask <span class="op">=</span> objectMapper<span class="op">.</span><span class="fu">readValue</span><span class="op">(</span>aiContent<span class="op">,</span> TaskDtoV2<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>aiTask <span class="op">==</span> <span class="kw">null</span> <span class="op">||</span> aiTask<span class="op">.</span><span class="fu">getName</span><span class="op">()</span> <span class="op">==</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb195-5"><a href="#cb195-5" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">error</span><span class="op">(</span><span class="st">&quot;Invalid AI Task generated: {}&quot;</span><span class="op">,</span> aiTask<span class="op">);</span></span>
<span id="cb195-6"><a href="#cb195-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span> <span class="co">// Skip invalid AI responses</span></span>
<span id="cb195-7"><a href="#cb195-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb195-8"><a href="#cb195-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span>JsonProcessingException e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb195-9"><a href="#cb195-9" aria-hidden="true" tabindex="-1"></a>    log<span class="op">.</span><span class="fu">error</span><span class="op">(</span><span class="st">&quot;Error parsing AI response: {}&quot;</span><span class="op">,</span> e<span class="op">.</span><span class="fu">getMessage</span><span class="op">());</span></span>
<span id="cb195-10"><a href="#cb195-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="langchain4j-integration-issues">LangChain4j Integration
Issues</h4>
<p><strong>Memory Management Problems</strong></p>
<pre class="properties"><code># Chat memory configuration issues
careconnect.chat.memory.default-max-messages=20
careconnect.chat.memory.premium-max-messages=50
careconnect.chat.memory.auto-cleanup=true</code></pre>
<p><strong>Model Configuration Errors</strong></p>
<div class="sourceCode" id="cb197"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Model initialization</span></span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Bean</span></span>
<span id="cb197-3"><a href="#cb197-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> ChatLanguageModel <span class="fu">deepSeekChatModel</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb197-4"><a href="#cb197-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> OpenAiChatModel<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb197-5"><a href="#cb197-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">baseUrl</span><span class="op">(</span><span class="st">&quot;https://api.deepseek.com/v1&quot;</span><span class="op">)</span></span>
<span id="cb197-6"><a href="#cb197-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">apiKey</span><span class="op">(</span>deepSeekApiKey<span class="op">)</span></span>
<span id="cb197-7"><a href="#cb197-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">modelName</span><span class="op">(</span><span class="st">&quot;deepseek-chat&quot;</span><span class="op">)</span></span>
<span id="cb197-8"><a href="#cb197-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">temperature</span><span class="op">(</span><span class="fl">0.7</span><span class="op">)</span></span>
<span id="cb197-9"><a href="#cb197-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">timeout</span><span class="op">(</span><span class="bu">Duration</span><span class="op">.</span><span class="fu">ofSeconds</span><span class="op">(</span><span class="dv">60</span><span class="op">))</span></span>
<span id="cb197-10"><a href="#cb197-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">maxRetries</span><span class="op">(</span><span class="dv">3</span><span class="op">)</span>  <span class="co">// Add retry logic</span></span>
<span id="cb197-11"><a href="#cb197-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb197-12"><a href="#cb197-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="third-party-integration-issues">Third-Party Integration
Issues</h3>
<h4 id="stripe-integration-problems">Stripe Integration Problems</h4>
<p><strong>Price ID Conversion Issues</strong></p>
<div class="sourceCode" id="cb198"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Common Stripe issues in StripeService</span></span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="bu">String</span> <span class="fu">convertPlanIdToPriceId</span><span class="op">(</span><span class="bu">String</span> planId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb198-3"><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Complex price ID mapping - ensure all plans are configured</span></span>
<span id="cb198-4"><a href="#cb198-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>planId<span class="op">.</span><span class="fu">toLowerCase</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb198-5"><a href="#cb198-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="st">&quot;basic&quot;</span><span class="op">:</span> <span class="cf">return</span> <span class="st">&quot;price_basic_monthly&quot;</span><span class="op">;</span></span>
<span id="cb198-6"><a href="#cb198-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="st">&quot;premium&quot;</span><span class="op">:</span> <span class="cf">return</span> <span class="st">&quot;price_premium_monthly&quot;</span><span class="op">;</span></span>
<span id="cb198-7"><a href="#cb198-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">default</span><span class="op">:</span></span>
<span id="cb198-8"><a href="#cb198-8" aria-hidden="true" tabindex="-1"></a>            log<span class="op">.</span><span class="fu">error</span><span class="op">(</span><span class="st">&quot;Unknown plan ID: {}&quot;</span><span class="op">,</span> planId<span class="op">);</span></span>
<span id="cb198-9"><a href="#cb198-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">AppException</span><span class="op">(</span>HttpStatus<span class="op">.</span><span class="fu">BAD_REQUEST</span><span class="op">,</span> <span class="st">&quot;Invalid plan ID&quot;</span><span class="op">);</span></span>
<span id="cb198-10"><a href="#cb198-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb198-11"><a href="#cb198-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Webhook Validation</strong></p>
<div class="sourceCode" id="cb199"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Stripe webhook signature validation</span></span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span> <span class="op">{</span></span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a>    Webhook<span class="op">.</span><span class="fu">constructEvent</span><span class="op">(</span>payload<span class="op">,</span> sigHeader<span class="op">,</span> endpointSecret<span class="op">);</span></span>
<span id="cb199-4"><a href="#cb199-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span>SignatureVerificationException e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb199-5"><a href="#cb199-5" aria-hidden="true" tabindex="-1"></a>    log<span class="op">.</span><span class="fu">error</span><span class="op">(</span><span class="st">&quot;Invalid Stripe webhook signature&quot;</span><span class="op">);</span></span>
<span id="cb199-6"><a href="#cb199-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">AppException</span><span class="op">(</span>HttpStatus<span class="op">.</span><span class="fu">BAD_REQUEST</span><span class="op">,</span> <span class="st">&quot;Invalid signature&quot;</span><span class="op">);</span></span>
<span id="cb199-7"><a href="#cb199-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="aws-integration-issues">AWS Integration Issues</h4>
<p><strong>S3 Configuration Problems</strong></p>
<pre class="properties"><code># Environment-specific S3 configuration
cloud.aws.s3.bucket=${AWS_S3_BUCKET_NAME:careconnect-dev}
cloud.aws.credentials.access-key=${AWS_ACCESS_KEY_ID}
cloud.aws.credentials.secret-key=${AWS_SECRET_ACCESS_KEY}</code></pre>
<p><strong>WebSocket API Gateway Issues</strong></p>
<div class="sourceCode" id="cb201"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="co">// AWS WebSocket connection management</span></span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">sendMessageToConnection</span><span class="op">(</span><span class="bu">String</span> connectionId<span class="op">,</span> <span class="bu">Object</span> message<span class="op">)</span> <span class="op">{</span></span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb201-4"><a href="#cb201-4" aria-hidden="true" tabindex="-1"></a>        AmazonApiGatewayManagementApi client <span class="op">=</span> clientBuilder</span>
<span id="cb201-5"><a href="#cb201-5" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">withEndpointConfiguration</span><span class="op">(</span><span class="kw">new</span> <span class="fu">EndpointConfiguration</span><span class="op">(</span>apiGatewayEndpoint<span class="op">,</span> <span class="st">&quot;us-east-1&quot;</span><span class="op">))</span></span>
<span id="cb201-6"><a href="#cb201-6" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb201-7"><a href="#cb201-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Handle ConnectionGoneException for disconnected clients</span></span>
<span id="cb201-8"><a href="#cb201-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span>GoneException e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb201-9"><a href="#cb201-9" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;Connection {} is no longer available&quot;</span><span class="op">,</span> connectionId<span class="op">);</span></span>
<span id="cb201-10"><a href="#cb201-10" aria-hidden="true" tabindex="-1"></a>        connectionService<span class="op">.</span><span class="fu">markConnectionInactive</span><span class="op">(</span>connectionId<span class="op">);</span></span>
<span id="cb201-11"><a href="#cb201-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb201-12"><a href="#cb201-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="performance-issues">Performance Issues</h3>
<h4 id="database-performance-problems">Database Performance
Problems</h4>
<p><strong>Slow Queries</strong></p>
<div class="sourceCode" id="cb202"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Enable PostgreSQL query logging</span></span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">SYSTEM</span> <span class="kw">SET</span> log_statement <span class="op">=</span> <span class="st">&#39;all&#39;</span>;</span>
<span id="cb202-3"><a href="#cb202-3" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">SYSTEM</span> <span class="kw">SET</span> log_min_duration_statement <span class="op">=</span> <span class="dv">1000</span>; <span class="co">-- Log queries &gt; 1 second</span></span>
<span id="cb202-4"><a href="#cb202-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-5"><a href="#cb202-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- Check slow queries</span></span>
<span id="cb202-6"><a href="#cb202-6" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">query</span>, mean_exec_time, total_exec_time, calls</span>
<span id="cb202-7"><a href="#cb202-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> pg_stat_statements</span>
<span id="cb202-8"><a href="#cb202-8" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> mean_exec_time <span class="kw">DESC</span> <span class="kw">LIMIT</span> <span class="dv">10</span>;</span></code></pre></div>
<p><strong>Connection Pool Exhaustion</strong></p>
<pre class="properties"><code># Monitor and tune HikariCP settings
spring.datasource.hikari.maximum-pool-size=20
spring.datasource.hikari.leak-detection-threshold=60000
logging.level.com.zaxxer.hikari=DEBUG</code></pre>
<h4 id="memory-issues">Memory Issues</h4>
<p><strong>JVM Memory Tuning</strong></p>
<div class="sourceCode" id="cb204"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Production JVM settings</span></span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a><span class="ex">java</span> <span class="at">-Xms2g</span> <span class="at">-Xmx4g</span> <span class="at">-XX:+UseG1GC</span> <span class="at">-XX:MaxGCPauseMillis</span><span class="op">=</span>200 <span class="dt">\</span></span>
<span id="cb204-3"><a href="#cb204-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">-XX:+HeapDumpOnOutOfMemoryError</span> <span class="at">-XX:HeapDumpPath</span><span class="op">=</span>/var/log/app/ <span class="dt">\</span></span>
<span id="cb204-4"><a href="#cb204-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">-jar</span> careconnect-backend.jar</span></code></pre></div>
<p><strong>Flutter Memory Optimization</strong></p>
<div class="sourceCode" id="cb205"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Optimize image loading and caching</span></span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OptimizedImageWidget <span class="kw">extends</span> StatelessWidget {</span>
<span id="cb205-3"><a href="#cb205-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">String</span> imageUrl;</span>
<span id="cb205-4"><a href="#cb205-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-5"><a href="#cb205-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb205-6"><a href="#cb205-6" aria-hidden="true" tabindex="-1"></a>  Widget build(BuildContext context) {</span>
<span id="cb205-7"><a href="#cb205-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> CachedNetworkImage(</span>
<span id="cb205-8"><a href="#cb205-8" aria-hidden="true" tabindex="-1"></a>      imageUrl<span class="op">:</span> imageUrl<span class="op">,</span></span>
<span id="cb205-9"><a href="#cb205-9" aria-hidden="true" tabindex="-1"></a>      memCacheWidth<span class="op">:</span> <span class="dv">300</span><span class="op">,</span></span>
<span id="cb205-10"><a href="#cb205-10" aria-hidden="true" tabindex="-1"></a>      memCacheHeight<span class="op">:</span> <span class="dv">300</span><span class="op">,</span></span>
<span id="cb205-11"><a href="#cb205-11" aria-hidden="true" tabindex="-1"></a>      placeholder<span class="op">:</span> (context<span class="op">,</span> url) <span class="op">=&gt;</span> CircularProgressIndicator()<span class="op">,</span></span>
<span id="cb205-12"><a href="#cb205-12" aria-hidden="true" tabindex="-1"></a>      errorWidget<span class="op">:</span> (context<span class="op">,</span> url<span class="op">,</span> error) <span class="op">=&gt;</span> Icon(Icons<span class="op">.</span>error)<span class="op">,</span></span>
<span id="cb205-13"><a href="#cb205-13" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Implement image compression</span></span>
<span id="cb205-14"><a href="#cb205-14" aria-hidden="true" tabindex="-1"></a>      imageBuilder<span class="op">:</span> (context<span class="op">,</span> imageProvider) <span class="op">=&gt;</span> Container(</span>
<span id="cb205-15"><a href="#cb205-15" aria-hidden="true" tabindex="-1"></a>        decoration<span class="op">:</span> BoxDecoration(</span>
<span id="cb205-16"><a href="#cb205-16" aria-hidden="true" tabindex="-1"></a>          image<span class="op">:</span> DecorationImage(</span>
<span id="cb205-17"><a href="#cb205-17" aria-hidden="true" tabindex="-1"></a>            image<span class="op">:</span> imageProvider<span class="op">,</span></span>
<span id="cb205-18"><a href="#cb205-18" aria-hidden="true" tabindex="-1"></a>            fit<span class="op">:</span> BoxFit<span class="op">.</span>cover<span class="op">,</span></span>
<span id="cb205-19"><a href="#cb205-19" aria-hidden="true" tabindex="-1"></a>          )<span class="op">,</span></span>
<span id="cb205-20"><a href="#cb205-20" aria-hidden="true" tabindex="-1"></a>        )<span class="op">,</span></span>
<span id="cb205-21"><a href="#cb205-21" aria-hidden="true" tabindex="-1"></a>      )<span class="op">,</span></span>
<span id="cb205-22"><a href="#cb205-22" aria-hidden="true" tabindex="-1"></a>    );</span>
<span id="cb205-23"><a href="#cb205-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb205-24"><a href="#cb205-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="development-environment-issues">Development Environment
Issues</h3>
<h4 id="docker-and-containerization">Docker and Containerization</h4>
<p><strong>Database Container Issues</strong></p>
<div class="sourceCode" id="cb206"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="co"># PostgreSQL container troubleshooting</span></span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> logs careconnect-postgres</span>
<span id="cb206-3"><a href="#cb206-3" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> exec <span class="at">-it</span> careconnect-postgres psql <span class="at">-U</span> careconnect <span class="at">-d</span> careconnect</span>
<span id="cb206-4"><a href="#cb206-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-5"><a href="#cb206-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Reset database container</span></span>
<span id="cb206-6"><a href="#cb206-6" aria-hidden="true" tabindex="-1"></a><span class="ex">docker-compose</span> down <span class="at">-v</span></span>
<span id="cb206-7"><a href="#cb206-7" aria-hidden="true" tabindex="-1"></a><span class="ex">docker-compose</span> up <span class="at">-d</span> postgres</span></code></pre></div>
<p><strong>Port Conflicts</strong></p>
<div class="sourceCode" id="cb207"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for port conflicts</span></span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a><span class="ex">lsof</span> <span class="at">-i</span> :8080  <span class="co"># Backend port</span></span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a><span class="ex">lsof</span> <span class="at">-i</span> :3000  <span class="co"># Frontend port</span></span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a><span class="ex">lsof</span> <span class="at">-i</span> :5432  <span class="co"># PostgreSQL port</span></span>
<span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-6"><a href="#cb207-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Kill conflicting processes</span></span>
<span id="cb207-7"><a href="#cb207-7" aria-hidden="true" tabindex="-1"></a><span class="bu">kill</span> <span class="at">-9</span> <span class="op">&lt;</span>PID<span class="op">&gt;</span></span></code></pre></div>
<h4 id="ide-and-tooling-issues">IDE and Tooling Issues</h4>
<p><strong>IntelliJ IDEA Configuration</strong></p>
<div class="sourceCode" id="cb208"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Clear IntelliJ caches</span></span>
<span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> <span class="at">-rf</span> ~/.IntelliJIdea<span class="pp">*</span>/system/caches</span>
<span id="cb208-3"><a href="#cb208-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> <span class="at">-rf</span> ~/.IntelliJIdea<span class="pp">*</span>/system/index</span>
<span id="cb208-4"><a href="#cb208-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-5"><a href="#cb208-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Reimport Maven project</span></span>
<span id="cb208-6"><a href="#cb208-6" aria-hidden="true" tabindex="-1"></a><span class="ex">mvn</span> idea:idea</span></code></pre></div>
<p><strong>VS Code Flutter Issues</strong></p>
<div class="sourceCode" id="cb209"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="er">//</span> <span class="er">.vscode/settings.json</span></span>
<span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb209-3"><a href="#cb209-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;dart.flutterSdkPath&quot;</span><span class="fu">:</span> <span class="st">&quot;/path/to/flutter&quot;</span><span class="fu">,</span></span>
<span id="cb209-4"><a href="#cb209-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;dart.debugExternalPackageLibraries&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb209-5"><a href="#cb209-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;dart.debugSdkLibraries&quot;</span><span class="fu">:</span> <span class="kw">true</span></span>
<span id="cb209-6"><a href="#cb209-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h3 id="deployment-issues">Deployment Issues</h3>
<h4 id="production-deployment-problems">Production Deployment
Problems</h4>
<p><strong>Environment Configuration</strong></p>
<div class="sourceCode" id="cb210"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check all required environment variables for production</span></span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a><span class="va">required_vars</span><span class="op">=</span><span class="va">(</span></span>
<span id="cb210-3"><a href="#cb210-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;SECURITY_JWT_SECRET&quot;</span></span>
<span id="cb210-4"><a href="#cb210-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;DEEPSEEK_API_KEY&quot;</span></span>
<span id="cb210-5"><a href="#cb210-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;STRIPE_SECRET_KEY&quot;</span></span>
<span id="cb210-6"><a href="#cb210-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;AWS_ACCESS_KEY_ID&quot;</span></span>
<span id="cb210-7"><a href="#cb210-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;AWS_SECRET_ACCESS_KEY&quot;</span></span>
<span id="cb210-8"><a href="#cb210-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;DATABASE_URL&quot;</span></span>
<span id="cb210-9"><a href="#cb210-9" aria-hidden="true" tabindex="-1"></a><span class="va">)</span></span>
<span id="cb210-10"><a href="#cb210-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-11"><a href="#cb210-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> var <span class="kw">in</span> <span class="st">&quot;</span><span class="va">${required_vars</span><span class="op">[@]</span><span class="va">}</span><span class="st">&quot;</span><span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb210-12"><a href="#cb210-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="kw">[[</span> <span class="ot">-z</span> <span class="st">&quot;</span><span class="va">${</span><span class="op">!</span><span class="va">var}</span><span class="st">&quot;</span> <span class="kw">]];</span> <span class="cf">then</span></span>
<span id="cb210-13"><a href="#cb210-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;Missing required environment variable: </span><span class="va">$var</span><span class="st">&quot;</span></span>
<span id="cb210-14"><a href="#cb210-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">fi</span></span>
<span id="cb210-15"><a href="#cb210-15" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span></code></pre></div>
<p><strong>Health Check Failures</strong></p>
<div class="sourceCode" id="cb211"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test application health endpoints</span></span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-f</span> http://localhost:8080/actuator/health <span class="kw">||</span> <span class="bu">exit</span> 1</span>
<span id="cb211-3"><a href="#cb211-3" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-f</span> http://localhost:8080/actuator/db <span class="kw">||</span> <span class="bu">exit</span> 1</span></code></pre></div>
<h4 id="monitoring-and-debugging">Monitoring and Debugging</h4>
<p><strong>Application Metrics</strong></p>
<pre class="properties"><code># Enable actuator endpoints for monitoring
management.endpoints.web.exposure.include=health,info,metrics,prometheus
management.endpoint.health.show-details=always</code></pre>
<p><strong>Logging Configuration</strong></p>
<pre class="properties"><code># Production logging configuration
logging.level.org.springframework.security=INFO
logging.level.com.careconnect=INFO
logging.level.org.hibernate.SQL=WARN
logging.pattern.file=%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n</code></pre>
<p><strong>Error Tracking</strong></p>
<div class="sourceCode" id="cb214"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Structured error logging</span></span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a><span class="at">@RestControllerAdvice</span></span>
<span id="cb214-3"><a href="#cb214-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> GlobalExceptionHandler <span class="op">{</span></span>
<span id="cb214-4"><a href="#cb214-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-5"><a href="#cb214-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@ExceptionHandler</span><span class="op">(</span><span class="bu">Exception</span><span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb214-6"><a href="#cb214-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ResponseEntity<span class="op">&lt;</span>ErrorResponse<span class="op">&gt;</span> <span class="fu">handleGenericException</span><span class="op">(</span><span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb214-7"><a href="#cb214-7" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">error</span><span class="op">(</span><span class="st">&quot;Unhandled exception occurred&quot;</span><span class="op">,</span> e<span class="op">);</span></span>
<span id="cb214-8"><a href="#cb214-8" aria-hidden="true" tabindex="-1"></a>        ErrorResponse error <span class="op">=</span> <span class="kw">new</span> <span class="fu">ErrorResponse</span><span class="op">(</span></span>
<span id="cb214-9"><a href="#cb214-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;INTERNAL_ERROR&quot;</span><span class="op">,</span></span>
<span id="cb214-10"><a href="#cb214-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;An unexpected error occurred&quot;</span><span class="op">,</span></span>
<span id="cb214-11"><a href="#cb214-11" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">currentTimeMillis</span><span class="op">()</span></span>
<span id="cb214-12"><a href="#cb214-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb214-13"><a href="#cb214-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ResponseEntity<span class="op">.</span><span class="fu">status</span><span class="op">(</span><span class="dv">500</span><span class="op">).</span><span class="fu">body</span><span class="op">(</span>error<span class="op">);</span></span>
<span id="cb214-14"><a href="#cb214-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb214-15"><a href="#cb214-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This comprehensive troubleshooting guide covers the most common
issues encountered in the CareConnect platform, providing practical
solutions and debugging strategies for developers.</p>
<hr />
<p><em>This guide covers the essential aspects of developing with the
CareConnect platform. For specific implementation details, refer to the
code comments and additional documentation in the respective
modules.</em></p>
<p><em>Last Updated: October 2025</em> <em>Version: 2025.1.0</em></p>
</body>
</html>
